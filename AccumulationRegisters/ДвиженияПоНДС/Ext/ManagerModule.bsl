#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Собирает структуру из текстов запросов для дальнейшей проверки даты запрета.
// 
// Параметры:
// 	Запрос - Запрос - Запрос по проверке даты запрета, можно установить параметры
// Возвращаемое значение:
// 	Структура - см. ЗакрытиеМесяцаСервер.ИнициализироватьСтруктуруТекстовЗапросов
Функция ТекстЗапросаКонтрольДатыЗапрета(Запрос) Экспорт
	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияПоНДС.Имя;
	ИмяТаблицыИзменений = "ТаблицаИзмененийДвиженияПоНДС"; 
	СтруктураТекстовЗапросов = ПроведениеДокументов.ШаблонТекстЗапросаКонтрольДатыЗапрета(Запрос, 
		ИмяРегистра, 
		ИмяТаблицыИзменений, 
		"ФинансовыйКонтур");
	Возврат СтруктураТекстовЗапросов

КонецФункции

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.УправлениеДоступом

// См. УправлениеДоступомПереопределяемый.ПриЗаполненииСписковСОграничениемДоступа.
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	ЗначениеРазрешено(Организация)";

КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ОбновлениеИнформационнойБазы

// См. ОбновлениеИнформационнойБазыБСП.ПриДобавленииОбработчиковОбновления
//
Процедура ПриДобавленииОбработчиковОбновления(Обработчики) Экспорт

	Обработчик = Обработчики.Добавить();
	Обработчик.Процедура = "РегистрыНакопления.ДвиженияПоНДС.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	Обработчик.Версия = "11.5.8.38";
	Обработчик.РежимВыполнения = "Отложенно";
	Обработчик.Идентификатор = Новый УникальныйИдентификатор("a1c356a6-e58d-4c0d-a8fe-62bc650082ee");
	Обработчик.Многопоточный = Истина;
	Обработчик.ПроцедураЗаполненияДанныхОбновления = "РегистрыНакопления.ДвиженияПоНДС.ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию";
	Обработчик.ПроцедураПроверки = "ОбновлениеИнформационнойБазы.ДанныеОбновленыНаНовуюВерсиюПрограммы";
	Обработчик.Комментарий = НСтр("ru = 'Заполняет регистр по данным документов регистраторов и регистров накопления ""НДС записи книги продаж"" и ""НДС записи книги покупок""'");
	
	Читаемые = Новый Массив;
	Читаемые.Добавить(Метаданные.Документы.АктВыполненныхРабот.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ВозвратТоваровМеждуОрганизациями.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ВозвратТоваровОтКлиента.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ВозвратТоваровПоставщику.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ВыкупВозвратнойТарыКлиентом.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ВыкупТоваровХранителем.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.КорректировкаРеализации.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ОтчетКомитенту.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ОтчетКомитентуОЗакупках.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ОтчетОРозничныхПродажах.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ОтчетПоКомиссииМеждуОрганизациями.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ПередачаТоваровМеждуОрганизациями.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.РеализацияТоваровУслуг.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.РеализацияУслугПрочихАктивов.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.СчетФактураВыданныйАванс.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.СчетФактураПолученныйАванс.ПолноеИмя());
	//++ Локализация
	Читаемые.Добавить(Метаданные.Документы.ЗаписьКнигиПокупок.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ЗаписьКнигиПродаж.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.ЗаявлениеОВвозеТоваров.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.СчетФактураНалоговыйАгент.ПолноеИмя());
	Читаемые.Добавить(Метаданные.Документы.СчетФактураПолученныйНалоговыйАгент.ПолноеИмя());
	Читаемые.Добавить(Метаданные.РегистрыНакопления.НДСЗаписиКнигиПокупок.ПолноеИмя());
	Читаемые.Добавить(Метаданные.РегистрыНакопления.НДСЗаписиКнигиПродаж.ПолноеИмя());
	//-- Локализация
	Обработчик.ЧитаемыеОбъекты = СтрСоединить(Читаемые, ",");
	
	Изменяемые = Новый Массив;
	Изменяемые.Добавить(Метаданные.РегистрыНакопления.ДвиженияПоНДС.ПолноеИмя());
	Обработчик.ИзменяемыеОбъекты = СтрСоединить(Изменяемые, ",");

КонецПроцедуры

// Описание
// 
// Параметры:
// 	Параметры - см. ОбновлениеИнформационнойБазы.ОсновныеПараметрыОтметкиКОбработке
Процедура ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию(Параметры = Неопределено) Экспорт

	МетаданныеРегистра = СоздатьНаборЗаписей().Метаданные();
	ПолноеИмяРегистра = МетаданныеРегистра.ПолноеИмя();
	
	ПараметрыВыборки = Параметры.ПараметрыВыборки;
	ПараметрыВыборки.ПолныеИменаРегистров = ПолноеИмяРегистра;
	ПараметрыВыборки.ПоляУпорядочиванияПриРаботеПользователей.Добавить("Период УБЫВ");
	ПараметрыВыборки.ПоляУпорядочиванияПриОбработкеДанных.Добавить("Период УБЫВ");
	ПараметрыВыборки.СпособВыборки = ОбновлениеИнформационнойБазы.СпособВыборкиРегистраторыРегистра();
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ВозвратТоваровМеждуОрганизациями КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0
	|			ОБЪЕДИНИТЬ ВСЕ
	|			
	|			ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПокупок КАК НДСЗаписиКнигиПокупок
	|			ГДЕ
	|				НДСЗаписиКнигиПокупок.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПокупок.РегламентнаяОперация
	|				И НДСЗаписиКнигиПокупок.НДС <> 0)
	//-- Локализация
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ВозвратТоваровОтКлиента КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0
	|			
	|			ОБЪЕДИНИТЬ ВСЕ
	|			
	|			ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПокупок КАК НДСЗаписиКнигиПокупок
	|			ГДЕ
	|				НДСЗаписиКнигиПокупок.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПокупок.РегламентнаяОперация
	|				И НДСЗаписиКнигиПокупок.НДС <> 0)
	//-- Локализация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ВозвратТоваровПоставщику КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0
	|				
	|			ОБЪЕДИНИТЬ ВСЕ
	|			
	|			ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПокупок КАК НДСЗаписиКнигиПокупок
	|			ГДЕ
	|				НДСЗаписиКнигиПокупок.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПокупок.РегламентнаяОперация
	|				И НДСЗаписиКнигиПокупок.НДС <> 0)
	//-- Локализация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.КорректировкаРеализации КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|			ГДЕ
	|				НДСПредъявленный.Регистратор = Документ.Ссылка)
	|
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.АктВыполненныхРабот КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0)
	//-- Локализация
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ВыкупВозвратнойТарыКлиентом КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0)
	//-- Локализация
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ВыкупТоваровХранителем КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0)
	//-- Локализация
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ОтчетКомитенту КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0)
	//-- Локализация
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ОтчетКомитентуОЗакупках КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0)
	//-- Локализация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ОтчетКомиссионера КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0)
	//-- Локализация
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ОтчетОРозничныхПродажах КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0)
	//-- Локализация
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ОтчетПоКомиссииМеждуОрганизациями КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0)
	//-- Локализация
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ПередачаТоваровМеждуОрганизациями КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0)
	//-- Локализация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.РеализацияТоваровУслуг КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0)
	//-- Локализация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.РеализацияУслугПрочихАктивов КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	//++ Локализация
	|		И ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|			ГДЕ
	|				НДСЗаписиКнигиПродаж.Регистратор = Документ.Ссылка
	|				И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|				И НДСЗаписиКнигиПродаж.НДС <> 0)
	//-- Локализация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.СчетФактураВыданныйАванс КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.СчетФактураПолученныйАванс КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	|
	//++ Локализация
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ЗаявлениеОВвозеТоваров КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ЗаписьКнигиПродаж КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.ЗаписьКнигиПокупок КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.СчетФактураНалоговыйАгент КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	|				
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		Документ.Ссылка КАК Регистратор
	|	ИЗ
	|		Документ.СчетФактураПолученныйНалоговыйАгент КАК Документ
	|	ГДЕ
	|		Документ.Проведен
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = Документ.Ссылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		НДСЗаписиКнигиПокупок.Регистратор КАК Регистратор
	|	ИЗ
	|		РегистрНакопления.НДСЗаписиКнигиПокупок КАК НДСЗаписиКнигиПокупок
	|	ГДЕ
	|		НДСЗаписиКнигиПокупок.РегламентнаяОперация
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = НДСЗаписиКнигиПокупок.Регистратор)
	|				
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|		НДСЗаписиКнигиПродаж.Регистратор КАК Регистратор
	|	ИЗ
	|		РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|	ГДЕ
	|		НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|		И НЕ ИСТИНА В
	|			(ВЫБРАТЬ ПЕРВЫЕ 1
	|				ИСТИНА
	|			ИЗ
	|				РегистрНакопления.ДвиженияПоНДС КАК ДвиженияПоНДС
	|			ГДЕ
	|				ДвиженияПоНДС.Регистратор = НДСЗаписиКнигиПродаж.Регистратор)
	//-- Локализация
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	
	Регистраторы = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Регистратор");
	
	ОбновлениеИнформационнойБазы.ОтметитьРегистраторыКОбработке(
		Параметры,
		Регистраторы,
		ПолноеИмяРегистра);
		
КонецПроцедуры

Процедура ОбработатьДанныеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	МетаданныеРегистра = СоздатьНаборЗаписей().Метаданные();
	ПолноеИмяРегистра = МетаданныеРегистра.ПолноеИмя();
	ОбновляемыеДанные = ОбновлениеИнформационнойБазы.ДанныеДляОбновленияВМногопоточномОбработчике(Параметры);
	
	//++ Локализация
	АвансыПолученные = Новый Массив();
	АвансыПолученные.Добавить(Перечисления.ВидыЦенностей.ВозвратАвансовПолученных);
	АвансыПолученные.Добавить(Перечисления.ВидыЦенностей.АвансыПолученные);
	АвансыПолученные.Добавить(Перечисления.ВидыЦенностей.АвансыПолученныеНалоговыйАгент);
	
	ТекстЗапросаПолученияОфлайнДвижений = "ВЫБРАТЬ
	|	Источник.Период                             КАК Период,
	|	Источник.Регистратор                        КАК Регистратор,
	|	Источник.Организация                        КАК Организация,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейДвиженийПоНДС.Исходящий) КАК ТипЗаписи,
	|	Источник.Поставщик                          КАК Контрагент,
	|	Источник.СчетФактура                        КАК СчетФактура,
	|	Источник.СтавкаНДС                          КАК СтавкаНДСПеречисление,
	|	Источник.ВидЦенности                        КАК ВидЦенности,
	|	-Источник.СуммаБезНДС                       КАК СуммаБезНДС,
	|	-Источник.НДС                               КАК НДС,
	|	-Источник.НДСУпр                            КАК НДСУпр,
	|	Источник.РегламентнаяОперация               КАК РегламентнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                КАК ИдентификаторФинЗаписи,
	|	НЕОПРЕДЕЛЕНО                                КАК НастройкаХозяйственнойОперации,
	|	НЕОПРЕДЕЛЕНО                                КАК Сторно
	|ИЗ
	|	РегистрНакопления.НДСЗаписиКнигиПокупок КАК Источник
	|ГДЕ
	|	Источник.Регистратор = &Регистратор
	|	И Источник.ВидЦенности В (&АвансыПолученные)
	|	И Источник.РегламентнаяОперация
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Источник.Период                             КАК Период,
	|	Источник.Регистратор                        КАК Регистратор,
	|	Источник.Организация                        КАК Организация,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейДвиженийПоНДС.Входящий) КАК ТипЗаписи,
	|	Источник.Поставщик                          КАК Контрагент,
	|	Источник.СчетФактура                        КАК СчетФактура,
	|	Источник.СтавкаНДС                          КАК СтавкаНДСПеречисление,
	|	Источник.ВидЦенности                        КАК ВидЦенности,
	|	Источник.СуммаБезНДС                        КАК СуммаБезНДС,
	|	Источник.НДС                                КАК НДС,
	|	Источник.НДСУпр                             КАК НДСУпр,
	|	Источник.РегламентнаяОперация               КАК РегламентнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                КАК ИдентификаторФинЗаписи,
	|	НЕОПРЕДЕЛЕНО                                КАК НастройкаХозяйственнойОперации,
	|	НЕОПРЕДЕЛЕНО                                КАК Сторно
	|ИЗ
	|	РегистрНакопления.НДСЗаписиКнигиПокупок КАК Источник
	|ГДЕ
	|	Источник.Регистратор = &Регистратор
	|	И НЕ Источник.ВидЦенности В (&АвансыПолученные)
	|	И Источник.РегламентнаяОперация
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Источник.Период                             КАК Период,
	|	Источник.Регистратор                        КАК Регистратор,
	|	Источник.Организация                        КАК Организация,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейДвиженийПоНДС.Входящий) КАК ТипЗаписи,
	|	Источник.Покупатель                         КАК Контрагент,
	|	Источник.СчетФактура                        КАК СчетФактура,
	|	Источник.СтавкаНДС                          КАК СтавкаНДСПеречисление,
	|	Источник.ВидЦенности                        КАК ВидЦенности,
	|	-Источник.СуммаБезНДС                       КАК СуммаБезНДС,
	|	-Источник.НДС                               КАК НДС,
	|	-Источник.НДСУпр                            КАК НДСУпр,
	|	Источник.РегламентнаяОперация               КАК РегламентнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                КАК ИдентификаторФинЗаписи,
	|	НЕОПРЕДЕЛЕНО                                КАК НастройкаХозяйственнойОперации,
	|	НЕОПРЕДЕЛЕНО                                КАК Сторно
	|ИЗ
	|	РегистрНакопления.НДСЗаписиКнигиПродаж КАК Источник
	|ГДЕ
	|	Источник.Регистратор = &Регистратор
	|	И Источник.РегламентнаяОперация";
	
	Запрос = Новый Запрос(ТекстЗапросаПолученияОфлайнДвижений);
	Запрос.УстановитьПараметр("АвансыПолученные", АвансыПолученные);
	
	ТипыРегистраторовНДСЗаписиКнигиПродаж = Метаданные.РегистрыНакопления.НДСЗаписиКнигиПродаж.СтандартныеРеквизиты.Регистратор.Тип.Типы();
	ТипыРегистраторовНДСЗаписиКнигиПокупок = Метаданные.РегистрыНакопления.НДСЗаписиКнигиПокупок.СтандартныеРеквизиты.Регистратор.Тип.Типы();
	//-- Локализация
	
	Для Каждого Выборка Из ОбновляемыеДанные Цикл
		
		НачатьТранзакцию();
		
		Попытка
			
			Регистратор = Выборка.Регистратор;// ДокументСсылка - 
			ДокументСОнлайнДвижениями = ДокументСОнлайнДвижениями(Регистратор);
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить(ПолноеИмяРегистра + ".НаборЗаписей");
			ЭлементБлокировки.УстановитьЗначение("Регистратор", Регистратор);
			
			Если ДокументСОнлайнДвижениями Тогда
				ЭлементБлокировки = Блокировка.Добавить("Документ." + Регистратор.Метаданные().Имя);
				ЭлементБлокировки.Режим = РежимБлокировкиДанных.Разделяемый;
				ЭлементБлокировки.УстановитьЗначение("Ссылка", Регистратор);
			КонецЕсли;
			
			//++ Локализация
			Если ТипыРегистраторовНДСЗаписиКнигиПокупок.Найти(ТипЗнч(Регистратор)) <> Неопределено Тогда
				ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.НДСЗаписиКнигиПокупок.НаборЗаписей");
				ЭлементБлокировки.Режим = РежимБлокировкиДанных.Разделяемый;
				ЭлементБлокировки.УстановитьЗначение("Регистратор", Регистратор);
			КонецЕсли;
			
			Если ТипыРегистраторовНДСЗаписиКнигиПродаж.Найти(ТипЗнч(Регистратор)) <> Неопределено Тогда
				ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.НДСЗаписиКнигиПродаж.НаборЗаписей");
				ЭлементБлокировки.Режим = РежимБлокировкиДанных.Разделяемый;
				ЭлементБлокировки.УстановитьЗначение("Регистратор", Регистратор);
			КонецЕсли;
			//-- Локализация
			Блокировка.Заблокировать();
			
			НаборЗаписей = СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Регистратор.Установить(Регистратор);
			
			//++ Локализация
			Запрос.УстановитьПараметр("Регистратор", Регистратор);
			РезультатЗапросаДвиженияПоНДСОфлайн = Запрос.Выполнить();
			//-- Локализация
			
			ДвиженияПоНДС = Неопределено;
			Если ДокументСОнлайнДвижениями Тогда
				МенеджерДокумента = ОбщегоНазначения.МенеджерОбъектаПоСсылке(Регистратор);
				ДанныеДляПроведения = МенеджерДокумента.ДанныеДокументаДляПроведения(Регистратор, МетаданныеРегистра.Имя);
				ДанныеДляПроведения.Свойство("ТаблицаДвиженияПоНДС", ДвиженияПоНДС); // ТаблицаЗначений -
			КонецЕсли;
			
			//++ Локализация
			Если Не РезультатЗапросаДвиженияПоНДСОфлайн.Пустой() Тогда
				ДвиженияПоНДСОфлайн = РезультатЗапросаДвиженияПоНДСОфлайн.Выгрузить();
				ДвиженияПоНДСОфлайн.Колонки.Добавить("СтавкаНДС", Новый ОписаниеТипов("СправочникСсылка.СтавкиНДС"));
				
				Для Каждого СтрокаТЗ Из ДвиженияПоНДСОфлайн Цикл
						СтрокаТЗ.СтавкаНДС = УчетНДСЛокализация.СтавкаНДСПоПеречислению(СтрокаТЗ.СтавкаНДСПеречисление);
				КонецЦикла;

				Если ДвиженияПоНДС <> Неопределено Тогда
					ОбщегоНазначенияУТКлиентСервер.ДополнитьТаблицу(ДвиженияПоНДСОфлайн, ДвиженияПоНДС);
				Иначе
					ДвиженияПоНДС = ДвиженияПоНДСОфлайн.Скопировать();
				КонецЕсли;
			КонецЕсли;
			//-- Локализация
			
			Если ДвиженияПоНДС <> Неопределено Тогда
				НаборЗаписей.Загрузить(ДвиженияПоНДС);
			КонецЕсли;

			Если НаборЗаписей.Модифицированность() Тогда
				ОбновлениеИнформационнойБазы.ЗаписатьНаборЗаписей(НаборЗаписей);
			Иначе
				ОбновлениеИнформационнойБазы.ОтметитьВыполнениеОбработки(НаборЗаписей);
			КонецЕсли;
			
			ЗафиксироватьТранзакцию();
			
		Исключение
			
			ОтменитьТранзакцию();
			
			Шаблон = НСтр("ru = 'Не удалось записать данные в регистр %1 по регистратору ""%2"", по причине: %3'");
			ТекстСообщения = 
				СтрШаблон(Шаблон,
					ПолноеИмяРегистра,
					Регистратор,
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			
			ЗаписьЖурналаРегистрации(
				ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Предупреждение,
				МетаданныеРегистра,
				,
				ТекстСообщения);
			
		КонецПопытки;
		
	КонецЦикла;
		
	Параметры.ОбработкаЗавершена = Не ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки(Параметры.Очередь, ПолноеИмяРегистра);
	
КонецПроцедуры

Функция ДокументСОнлайнДвижениями(Документ)
	
	ТипыДокументов = Новый Соответствие();
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ВозвратТоваровМеждуОрганизациями"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ВозвратТоваровОтКлиента"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ВозвратТоваровПоставщику"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.КорректировкаРеализации"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.АктВыполненныхРабот"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ВыкупВозвратнойТарыКлиентом"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ВыкупТоваровХранителем"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ОтчетКомитенту"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ОтчетКомиссионера"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ОтчетКомитентуОЗакупках"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ОтчетОРозничныхПродажах"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ОтчетПоКомиссииМеждуОрганизациями"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ПередачаТоваровМеждуОрганизациями"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.РеализацияТоваровУслуг"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.РеализацияУслугПрочихАктивов"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.СчетФактураВыданныйАванс"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.СчетФактураПолученныйАванс"), Истина);
	//++ Локализация
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ЗаписьКнигиПродаж"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ЗаписьКнигиПокупок"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.ЗаявлениеОВвозеТоваров"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.СчетФактураНалоговыйАгент"), Истина);
	ТипыДокументов.Вставить(Тип("ДокументСсылка.СчетФактураПолученныйНалоговыйАгент"), Истина);
	//-- Локализация
	
	Возврат ТипыДокументов.Получить(ТипЗнч(Документ)) <> Неопределено;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#КонецЕсли
