#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Заполняет реквизит "Партия" в табличной части.
// При необходимости создаются новые элементы справочника партий.
//
// Параметры:
//	Объект - ДокументОбъект.ВнутреннееПотреблениеТоваров, ДокументОбъект.ВводОстатков, ДокументОбъект.ВводОстатковТМЦВЭксплуатации - Документ, в котором заполняется партия.
//  РежимЗаписи - РежимЗаписиДокумента - Текущий режим записи документа.
//
Процедура ЗаполнитьПартии(Объект, РежимЗаписи) Экспорт
	
	Если РежимЗаписи <> РежимЗаписиДокумента.Проведение
		И РежимЗаписи <> РежимЗаписиДокумента.ОтменаПроведения Тогда
		Возврат;
	КонецЕсли;
	
	НачалоПримененияФСБУ5 = '000101010000';
	
	Если ТипЗнч(Объект) = Тип("ДокументОбъект.ВнутреннееПотреблениеТоваров") Тогда
		
		ТабличнаяЧасть = Объект.Товары; // Документ.ВнутреннееПотреблениеТоваров.Товары
		ДанныеДокумента = ТабличнаяЧасть.Выгрузить();

		ДанныеДокумента.Колонки.Добавить("ДатаНачалаЭксплуатации", Новый ОписаниеТипов("Дата"));
		ДанныеДокумента.ЗаполнитьЗначения(НачалоМесяца(Объект.Дата), "ДатаНачалаЭксплуатации");
		
	ИначеЕсли ТипЗнч(Объект) = Тип("ДокументОбъект.ВводОстатков") Тогда
		
		ТабличнаяЧасть = Объект.ТМЦВЭксплуатации;
		ДанныеДокумента = ТабличнаяЧасть.Выгрузить();

		
	ИначеЕсли ТипЗнч(Объект) = Тип("ДокументОбъект.ВводОстатковТМЦВЭксплуатации") Тогда
		
		ТабличнаяЧасть = Объект.ТМЦВЭксплуатации;
		ДанныеДокумента = ТабличнаяЧасть.Выгрузить();
		
	Иначе
		
		ТекстОшибки = СтрШаблон(НСтр("ru = 'Для документа ""%1"" не предусмотрено заполнение партий'"), ТипЗнч(Объект));

		ВызватьИсключение ТекстОшибки;
		
	КонецЕсли;
	
	
	Блокировка = Новый БлокировкаДанных;
	
	ЭлементБлокировки = Блокировка.Добавить("Справочник.ПартииТМЦВЭксплуатации");
	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("КатегорияЭксплуатации", "КатегорияЭксплуатации");
	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("ДатаНачалаЭксплуатации", "ДатаНачалаЭксплуатации");
	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("ИнвентарныйНомер", "ИнвентарныйНомер");
	ЭлементБлокировки.ИсточникДанных = ДанныеДокумента;
	
	ЭлементБлокировки = Блокировка.Добавить("Справочник.ПартииТМЦВЭксплуатации");
	ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Ссылка", "Партия");
	ЭлементБлокировки.ИсточникДанных = ДанныеДокумента;
	

	Блокировка.Заблокировать();
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ВЫРАЗИТЬ(Таблица.НомерСтроки КАК ЧИСЛО) КАК НомерСтроки,
	|	ВЫРАЗИТЬ(Таблица.ДатаНачалаЭксплуатации КАК ДАТА) КАК ДатаНачалаЭксплуатации,
	|	ВЫРАЗИТЬ(Таблица.КатегорияЭксплуатации КАК Справочник.КатегорииЭксплуатации) КАК КатегорияЭксплуатации,
	|	Таблица.ИнвентарныйНомер КАК ИнвентарныйНомер,
	|	ВЫРАЗИТЬ(Таблица.Партия КАК Справочник.ПартииТМЦВЭксплуатации) КАК Партия
	|
	|ПОМЕСТИТЬ ДанныеДокумента
	|
	|ИЗ
	|	&ДанныеДокумента КАК Таблица
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Таблица.НомерСтроки КАК НомерСтроки,
	|	НАЧАЛОПЕРИОДА(Таблица.ДатаНачалаЭксплуатации, МЕСЯЦ) КАК ДатаНачалаЭксплуатации,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(Таблица.КатегорияЭксплуатации.СрокЭксплуатации, 0) <> 0
	|			ТОГДА НАЧАЛОПЕРИОДА(КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(Таблица.ДатаНачалаЭксплуатации, МЕСЯЦ, Таблица.КатегорияЭксплуатации.СрокЭксплуатации), МЕСЯЦ), ДЕНЬ)
	|		ИНАЧЕ ДАТАВРЕМЯ(1,1,1)
	|	КОНЕЦ КАК ДатаЗавершенияЭксплуатации,
	|	Таблица.КатегорияЭксплуатации.СрокЭксплуатации КАК СрокЭксплуатации,
	|	Таблица.КатегорияЭксплуатации КАК КатегорияЭксплуатации,
	|	Таблица.Партия КАК Партия
	|
	|ПОМЕСТИТЬ СтрокиНеТребующиеОбновления
	|
	|ИЗ
	|	ДанныеДокумента КАК Таблица
	|
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПартииТМЦВЭксплуатации КАК СправочникПартий
	|		ПО СправочникПартий.Ссылка = Таблица.Партия
	|
	|ГДЕ
	|	&ЗаполнитьПартии
	|
	|	И НЕ СправочникПартий.ПометкаУдаления
	|	И СправочникПартий.Партия258
	|	И СправочникПартий.КатегорияЭксплуатации = Таблица.КатегорияЭксплуатации
	|	И СправочникПартий.СрокЭксплуатации = Таблица.КатегорияЭксплуатации.СрокЭксплуатации
	|	И СправочникПартий.ДатаНачалаЭксплуатации = Таблица.ДатаНачалаЭксплуатации
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Таблица.НомерСтроки КАК НомерСтроки,
	|	НАЧАЛОПЕРИОДА(Таблица.ДатаНачалаЭксплуатации, МЕСЯЦ) КАК ДатаНачалаЭксплуатации,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(Таблица.КатегорияЭксплуатации.СрокЭксплуатации, 0) <> 0
	|			ТОГДА НАЧАЛОПЕРИОДА(КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(Таблица.ДатаНачалаЭксплуатации, МЕСЯЦ, Таблица.КатегорияЭксплуатации.СрокЭксплуатации), МЕСЯЦ), ДЕНЬ)
	|		ИНАЧЕ ДАТАВРЕМЯ(1,1,1)
	|	КОНЕЦ КАК ДатаЗавершенияЭксплуатации,
	|	Таблица.КатегорияЭксплуатации.СрокЭксплуатации КАК СрокЭксплуатации,
	|	ВЫБОР
	|		КОГДА ИСТИНА
	|			ТОГДА """"
	|	КОНЕЦ КАК ИнвентарныйНомер,
	|	Таблица.КатегорияЭксплуатации КАК КатегорияЭксплуатации,
	|	Таблица.Партия КАК Партия
	|
	|ПОМЕСТИТЬ СтрокиТребующиеОбновления
	|
	|ИЗ
	|	ДанныеДокумента КАК Таблица
	|
	|ГДЕ
	|	&ЗаполнитьПартии
	|	И НЕ Таблица.НомерСтроки В (
	|		ВЫБРАТЬ
	|			СтрокиНеТребующиеОбновления.НомерСтроки
	|		ИЗ
	|			СтрокиНеТребующиеОбновления)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СправочникПартий.Ссылка КАК Ссылка,
	|	СправочникПартий.ПометкаУдаления КАК ПометкаУдаления,
	|	СправочникПартий.КатегорияЭксплуатации КАК КатегорияЭксплуатации,
	|	СправочникПартий.СрокЭксплуатации КАК СрокЭксплуатации,
	|	СправочникПартий.ИнвентарныйНомер КАК ИнвентарныйНомер,
	|	СправочникПартий.ДатаНачалаЭксплуатации КАК ДатаНачалаЭксплуатации,
	|	СправочникПартий.ДатаЗавершенияЭксплуатации КАК ДатаЗавершенияЭксплуатации
	|
	|ПОМЕСТИТЬ ВсеПодходящиеПартииБезУчетаОС
	|
	|ИЗ
	|	Справочник.ПартииТМЦВЭксплуатации КАК СправочникПартий
	|ГДЕ
	|	СправочникПартий.Партия258
	|
	|	И (СправочникПартий.КатегорияЭксплуатации, 
	|		СправочникПартий.СрокЭксплуатации, 
	|		СправочникПартий.ИнвентарныйНомер, 
	|		СправочникПартий.ДатаНачалаЭксплуатации, 
	|		СправочникПартий.ДатаЗавершенияЭксплуатации) В (
	|
	|		ВЫБРАТЬ
	|			СтрокиТребующиеОбновления.КатегорияЭксплуатации КАК КатегорияЭксплуатации,
	|			СтрокиТребующиеОбновления.СрокЭксплуатации КАК СрокЭксплуатации,
	|			СтрокиТребующиеОбновления.ИнвентарныйНомер КАК ИнвентарныйНомер,
	|			СтрокиТребующиеОбновления.ДатаНачалаЭксплуатации КАК ДатаНачалаЭксплуатации,
	|			СтрокиТребующиеОбновления.ДатаЗавершенияЭксплуатации КАК ДатаЗавершенияЭксплуатации
	|		ИЗ
	|			СтрокиТребующиеОбновления КАК СтрокиТребующиеОбновления)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ВсеПодходящиеПартии.Ссылка) КАК Ссылка,
	|	ВсеПодходящиеПартии.ПометкаУдаления КАК ПометкаУдаления,
	|	ВсеПодходящиеПартии.КатегорияЭксплуатации КАК КатегорияЭксплуатации,
	|	ВсеПодходящиеПартии.СрокЭксплуатации КАК СрокЭксплуатации,
	|	ВсеПодходящиеПартии.ИнвентарныйНомер КАК ИнвентарныйНомер,
	|	ВсеПодходящиеПартии.ДатаНачалаЭксплуатации КАК ДатаНачалаЭксплуатации,
	|	ВсеПодходящиеПартии.ДатаЗавершенияЭксплуатации КАК ДатаЗавершенияЭксплуатации
	|
	|ПОМЕСТИТЬ ПодходящиеПартииБезУчетаОС
	|	
	|ИЗ
	|	ВсеПодходящиеПартииБезУчетаОС КАК ВсеПодходящиеПартии
	|	
	|ГДЕ
	|	НЕ ВсеПодходящиеПартии.ПометкаУдаления
	|
	|СГРУППИРОВАТЬ ПО
	|	ВсеПодходящиеПартии.ПометкаУдаления,
	|	ВсеПодходящиеПартии.КатегорияЭксплуатации,
	|	ВсеПодходящиеПартии.СрокЭксплуатации,
	|	ВсеПодходящиеПартии.ИнвентарныйНомер,
	|	ВсеПодходящиеПартии.ДатаНачалаЭксплуатации,
	|	ВсеПодходящиеПартии.ДатаЗавершенияЭксплуатации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	МАКСИМУМ(ВсеПодходящиеПартии.Ссылка) КАК Ссылка,
	|	ВсеПодходящиеПартии.ПометкаУдаления КАК ПометкаУдаления,
	|	ВсеПодходящиеПартии.КатегорияЭксплуатации КАК КатегорияЭксплуатации,
	|	ВсеПодходящиеПартии.СрокЭксплуатации КАК СрокЭксплуатации,
	|	ВсеПодходящиеПартии.ИнвентарныйНомер КАК ИнвентарныйНомер,
	|	ВсеПодходящиеПартии.ДатаНачалаЭксплуатации КАК ДатаНачалаЭксплуатации,
	|	ВсеПодходящиеПартии.ДатаЗавершенияЭксплуатации КАК ДатаЗавершенияЭксплуатации
	|
	|ИЗ
	|	ВсеПодходящиеПартииБезУчетаОС КАК ВсеПодходящиеПартии
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВсеПодходящиеПартииБезУчетаОС КАК ВсеПодходящиеПартии2
	|		ПО ВсеПодходящиеПартии2.Ссылка <> ВсеПодходящиеПартии.Ссылка
	|			И НЕ ВсеПодходящиеПартии2.ПометкаУдаления
	|			И ВсеПодходящиеПартии2.КатегорияЭксплуатации = ВсеПодходящиеПартии.КатегорияЭксплуатации
	|			И ВсеПодходящиеПартии2.СрокЭксплуатации = ВсеПодходящиеПартии.СрокЭксплуатации
	|			И ВсеПодходящиеПартии2.ИнвентарныйНомер = ВсеПодходящиеПартии.ИнвентарныйНомер
	|			И ВсеПодходящиеПартии2.ДатаНачалаЭксплуатации = ВсеПодходящиеПартии.ДатаНачалаЭксплуатации
	|			И ВсеПодходящиеПартии2.ДатаЗавершенияЭксплуатации = ВсеПодходящиеПартии.ДатаЗавершенияЭксплуатации
	|
	|ГДЕ
	|	ВсеПодходящиеПартии.ПометкаУдаления
	|	И ВсеПодходящиеПартии2.Ссылка ЕСТЬ NULL
	|
	|СГРУППИРОВАТЬ ПО
	|	ВсеПодходящиеПартии.ПометкаУдаления,
	|	ВсеПодходящиеПартии.КатегорияЭксплуатации,
	|	ВсеПодходящиеПартии.СрокЭксплуатации,
	|	ВсеПодходящиеПартии.ИнвентарныйНомер,
	|	ВсеПодходящиеПартии.ДатаНачалаЭксплуатации,
	|	ВсеПодходящиеПартии.ДатаЗавершенияЭксплуатации
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПодходящиеПартии.Ссылка КАК Ссылка,
	|	ПодходящиеПартии.ПометкаУдаления КАК ПометкаУдаления,
	|	ПодходящиеПартии.КатегорияЭксплуатации КАК КатегорияЭксплуатации,
	|	ПодходящиеПартии.СрокЭксплуатации КАК СрокЭксплуатации,
	|	ПодходящиеПартии.ИнвентарныйНомер КАК ИнвентарныйНомер,
	|	ПодходящиеПартии.ДатаНачалаЭксплуатации КАК ДатаНачалаЭксплуатации,
	|	ПодходящиеПартии.ДатаЗавершенияЭксплуатации КАК ДатаЗавершенияЭксплуатации
	|ИЗ
	|	ПодходящиеПартииБезУчетаОС КАК ПодходящиеПартии
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СтрокиТребующиеОбновления.НомерСтроки КАК НомерСтроки,
	|	СтрокиТребующиеОбновления.КатегорияЭксплуатации КАК КатегорияЭксплуатации,
	|	СтрокиТребующиеОбновления.КатегорияЭксплуатации.УчитыватьВВидеГрупповогоОС КАК УчитыватьВВидеГрупповогоОС,
	|	СтрокиТребующиеОбновления.КатегорияЭксплуатации.ГруппаОС КАК ГруппаОС,
	|	СтрокиТребующиеОбновления.СрокЭксплуатации КАК СрокЭксплуатации,
	|	СтрокиТребующиеОбновления.ИнвентарныйНомер КАК ИнвентарныйНомер,
	|	СтрокиТребующиеОбновления.ДатаНачалаЭксплуатации КАК ДатаНачалаЭксплуатации,
	|	СтрокиТребующиеОбновления.ДатаЗавершенияЭксплуатации КАК ДатаЗавершенияЭксплуатации
	|ИЗ
	|	СтрокиТребующиеОбновления КАК СтрокиТребующиеОбновления";
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	Запрос.УстановитьПараметр("ДанныеДокумента", ДанныеДокумента);
	Запрос.УстановитьПараметр("ЗаполнитьПартии", РежимЗаписи = РежимЗаписиДокумента.Проведение);
	Запрос.УстановитьПараметр("НачалоПримененияФСБУ5", НачалоПримененияФСБУ5);
	
	Результат = Запрос.ВыполнитьПакет();
	
	ТаблицаПартийБезУчетаОС = Результат[Результат.ВГраница()-1].Выгрузить();

	
	ИспользуемыеРеквизитыПартии = "КатегорияЭксплуатации,СрокЭксплуатации,ДатаНачалаЭксплуатации,ДатаЗавершенияЭксплуатации,ИнвентарныйНомер";
	СтруктураПоискаБезУчетаОС = Новый Структура(ИспользуемыеРеквизитыПартии);
	ТаблицаПартийБезУчетаОС.Индексы.Добавить(ИспользуемыеРеквизитыПартии);

	ПараметрыНаименования = Новый Структура("ДатаНачалаЭксплуатации,ДатаЗавершенияЭксплуатации,СрокЭксплуатации,КатегорияЭксплуатации");
	
	Выборка = Результат[Результат.ВГраница()].Выбрать();
	Пока Выборка.Следующий() Цикл
		
		СтрокаТЧ = ТабличнаяЧасть[Выборка.НомерСтроки - 1];
		
		ТаблицаПартий = ТаблицаПартийБезУчетаОС;
		СтруктураПоиска = СтруктураПоискаБезУчетаОС;

		
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, Выборка);
		СписокСтрок = ТаблицаПартий.НайтиСтроки(СтруктураПоиска);
		
		Если СписокСтрок.Количество() = 0 Тогда
			
			// Нужной партии нет.
			// Сначала берется неиспользуемая партия, если ее нет, то создается новая партия.
			ОбъектПартии = Неопределено;

			
			Если ОбъектПартии = Неопределено Тогда
				ОбъектПартии = Справочники.ПартииТМЦВЭксплуатации.СоздатьЭлемент();
			КонецЕсли;
			
			ЗаполнитьЗначенияСвойств(ОбъектПартии, СтруктураПоиска);
			ОбъектПартии.Наименование = СформироватьНаименование(ОбъектПартии);
			
			
			ОбъектПартии.Партия258 = Истина;
			ОбъектПартии.Записать();
			
			ДанныеПартии = ТаблицаПартий.Добавить();
			ЗаполнитьЗначенияСвойств(ДанныеПартии, СтруктураПоиска);
			ДанныеПартии.Ссылка = ОбъектПартии.Ссылка;
			ДанныеПартии.ПометкаУдаления = ОбъектПартии.ПометкаУдаления;
			
			
		Иначе
			
			// Есть нужная партия.
			ДанныеПартии = СписокСтрок[0];
			
		КонецЕсли;
		
		Если ДанныеПартии.ПометкаУдаления Тогда
			ОбъектПартии = ДанныеПартии.Ссылка.ПолучитьОбъект(); // СправочникОбъект.ПартииТМЦВЭксплуатации
			ОбъектПартии.Наименование = СформироватьНаименование(ОбъектПартии);
			ОбъектПартии.ПометкаУдаления = Ложь;
			ОбъектПартии.Записать();
		КонецЕсли;
		
		СтрокаТЧ.Партия = ДанныеПартии.Ссылка;
			
	КонецЦикла;
	
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли

#Область ОбработчикиСобытий

Процедура ОбработкаПолученияДанныхВыбора(ДанныеВыбора, Параметры, СтандартнаяОбработка)
	
	
	Возврат; // в УТ пустой обработчик
	
КонецПроцедуры

#КонецОбласти

#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область СлужебныеПроцедурыИФункции

#Область Прочее

// Формирует наименование партии.
// 
// Параметры:
//  Объект - СправочникОбъект.ПартииТМЦВЭксплуатации - Объект
// 
// Возвращаемое значение:
//  Строка - Наименование
//
Функция СформироватьНаименование(Объект) Экспорт
	
	НаименованиеКатегории = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.КатегорияЭксплуатации, "Наименование");
	
	Если Объект.СрокЭксплуатации <> 0 Тогда
		
		Наименование = СтрШаблон(
					НСтр("ru='%1 (с %2 по %3)'"),
					СокрЛП(НаименованиеКатегории),
					Формат(Объект.ДатаНачалаЭксплуатации, НСтр("ru = 'ДФ=''МММ гггг ""г.""'''")),
					Формат(Объект.ДатаЗавершенияЭксплуатации, НСтр("ru = 'ДФ=''МММ гггг ""г.""'''")));
					
	Иначе
		
		Наименование = СтрШаблон(
					НСтр("ru='%1 (с %2)'"),
					СокрЛП(НаименованиеКатегории),
					Формат(Объект.ДатаНачалаЭксплуатации, НСтр("ru = 'ДФ=''МММ гггг ""г.""'''")));
					
	КонецЕсли;
	
	Возврат Наименование;
	
КонецФункции

// Формирует наименование группового ОС.
// 
// Параметры:
//  Параметры - Структура - Содержит:
//  	* ДатаНачалаЭксплуатации - Дата -
//  	* ДатаЗавершенияЭксплуатации - Дата -
//  	* СрокЭксплуатации - Число -
//  	* КатегорияЭксплуатации - СправочникСсылка.КатегорииЭксплуатации -
// 
// Возвращаемое значение:
//  Строка - Наименование группового ОС.
Функция СформироватьНаименованиеГрупповогоОС(Параметры) Экспорт

	НаименованиеКатегории = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Параметры.КатегорияЭксплуатации, "Наименование");
	
	Если Параметры.СрокЭксплуатации <> 0 Тогда
		
		Наименование = СтрШаблон(
					НСтр("ru='%1 (с %2 по %3)'"),
					СокрЛП(НаименованиеКатегории),
					Формат(Параметры.ДатаНачалаЭксплуатации, НСтр("ru = 'ДФ=''МММ гггг ""г.""'''")),
					Формат(Параметры.ДатаЗавершенияЭксплуатации, НСтр("ru = 'ДФ=''МММ гггг ""г.""'''")));
					
	Иначе
		
		Наименование = СтрШаблон(
					НСтр("ru='%1 (с %2)'"),
					СокрЛП(НаименованиеКатегории),
					Формат(Параметры.ДатаНачалаЭксплуатации, НСтр("ru = 'ДФ=''МММ гггг ""г.""'''")));
					
	КонецЕсли;
	
	Возврат Наименование;
	
КонецФункции


#КонецОбласти

#Область ОбновлениеИнформационнойБазы

// см. ОбновлениеИнформационнойБазыБСП.ПриДобавленииОбработчиковОбновления
Процедура ПриДобавленииОбработчиковОбновления(Обработчики) Экспорт

	Обработчик = Обработчики.Добавить();
	Обработчик.Процедура = "Справочники.ПартииТМЦВЭксплуатации.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	Обработчик.Версия = "11.5.8.73";
	Обработчик.РежимВыполнения = "Отложенно";
	Обработчик.Идентификатор = Новый УникальныйИдентификатор("b8c1f46c-a1eb-4ccc-a58f-dbba7fffd9dc");
	Обработчик.Многопоточный = Истина;
	Обработчик.ПроцедураЗаполненияДанныхОбновления = "Справочники.ПартииТМЦВЭксплуатации.ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию";
	Обработчик.ПроцедураПроверки = "ОбновлениеИнформационнойБазы.ДанныеОбновленыНаНовуюВерсиюПрограммы";
	Обработчик.ЗапускатьТолькоВГлавномУзле = Истина;
	Обработчик.Комментарий = НСтр("ru = 'Обновляет справочник ""Партии ТМЦ в эксплуатации"":
	|- объединяются партии у которых совпадают реквизиты ""Категория эксплуатации"", ""Месяц передачи в эксплуатацию""'");
	
	Читаемые = Новый Массив;
	Читаемые.Добавить(Метаданные.Справочники.ПартииТМЦВЭксплуатации.ПолноеИмя());
	Обработчик.ЧитаемыеОбъекты = СтрСоединить(Читаемые, ",");
	
	Изменяемые = Новый Массив;
	Изменяемые.Добавить(Метаданные.Справочники.ПартииТМЦВЭксплуатации.ПолноеИмя());
	Обработчик.ИзменяемыеОбъекты = СтрСоединить(Изменяемые, ",");
	
	Блокируемые = Новый Массив;
	Блокируемые.Добавить(Метаданные.Справочники.ПартииТМЦВЭксплуатации.ПолноеИмя());
	Обработчик.БлокируемыеОбъекты = СтрСоединить(Блокируемые, ",");

КонецПроцедуры

// Регистрирует данные к обработке при переходе на новую версию.
// 
// Параметры:
// 	Параметры - см. ОбновлениеИнформационнойБазы.ОсновныеПараметрыОтметкиКОбработке
Процедура ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	ПараметрыВыборки = Параметры.ПараметрыВыборки;
	ПараметрыВыборки.ПолныеИменаОбъектов = "Справочник.ПартииТМЦВЭксплуатации";
	ПараметрыВыборки.ПоляУпорядочиванияПриОбработкеДанных.Добавить("Ссылка");
	ПараметрыВыборки.СпособВыборки = ОбновлениеИнформационнойБазы.СпособВыборкиСсылки();
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	ПартииТМЦВЭксплуатации.Ссылка
	|ИЗ
	|	Справочник.ПартииТМЦВЭксплуатации КАК ПартииТМЦВЭксплуатации
	|ГДЕ
	|	НЕ ПартииТМЦВЭксплуатации.Партия258
	|	И ПартииТМЦВЭксплуатации.НоваяПартия = ЗНАЧЕНИЕ(Справочник.ПартииТМЦВЭксплуатации.ПустаяСсылка)";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	ОбновлениеИнформационнойБазы.ОтметитьКОбработке(Параметры, Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка"));
	
КонецПроцедуры

Процедура ОбработатьДанныеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	ПолноеИмяОбъекта = "Справочник.ПартииТМЦВЭксплуатации";
	
	ОбновляемыеДанные = ОбновлениеИнформационнойБазы.ДанныеДляОбновленияВМногопоточномОбработчике(Параметры);
	
	Если ОбновляемыеДанные.Количество() = 0 Тогда
		Параметры.ОбработкаЗавершена = ОбновлениеИнформационнойБазы.ОбработкаДанныхЗавершена(Параметры.Очередь, ПолноеИмяОбъекта);
		Возврат;
	КонецЕсли;
	
	ПараметрыНаименования = Новый Структура("КатегорияЭксплуатации,ДатаНачалаЭксплуатации,ДатаЗавершенияЭксплуатации,СрокЭксплуатации");
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ТаблицаДанных.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ВТДляОбработки
	|ИЗ
	|	&ТаблицаОбновляемыхДанных КАК ТаблицаДанных
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТДляОбработки.Ссылка КАК Ссылка,
	|
	|	ПартииТМЦ.КатегорияЭксплуатации.СпособПогашенияСтоимостиБУ КАК СпособПогашенияСтоимостиБУ,
	|	ЕСТЬNULL(ПартииТМЦ.КатегорияЭксплуатации.ИнвентарныйУчет, ЛОЖЬ) КАК ИнвентарныйУчет
	|
	|ИЗ
	|	ВТДляОбработки КАК ВТДляОбработки
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииТМЦВЭксплуатации КАК ПартииТМЦ
	|		ПО ПартииТМЦ.Ссылка = ВТДляОбработки.Ссылка";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("ТаблицаОбновляемыхДанных", ОбновляемыеДанные);
	Результат = Запрос.Выполнить();
	
	
	Выборка = Результат.Выбрать();
 	Пока Выборка.Следующий() Цикл
		
		НачатьТранзакцию();
		
		Попытка
			
			Блокировка = Новый БлокировкаДанных;
			
			ЭлементБлокировки = Блокировка.Добавить(ПолноеИмяОбъекта);
			ЭлементБлокировки.УстановитьЗначение("Ссылка", Выборка.Ссылка);
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
			
			Блокировка.Заблокировать();
			
			СправочникОбъект = Выборка.Ссылка.ПолучитьОбъект(); // СправочникОбъект.ПартииТМЦВЭксплуатации - 
			
			Если НЕ СправочникОбъект.Партия258
				И НЕ ЗначениеЗаполнено(СправочникОбъект.НоваяПартия)
				И ЗначениеЗаполнено(СправочникОбъект.КатегорияЭксплуатации)
				И ЗначениеЗаполнено(СправочникОбъект.ДатаНачалаЭксплуатации) Тогда
				
				БлокировкаНовыхПартий = Новый БлокировкаДанных;
				ЭлементБлокировки = БлокировкаНовыхПартий.Добавить(ПолноеИмяОбъекта);
				ЭлементБлокировки.УстановитьЗначение("КатегорияЭксплуатации", СправочникОбъект.КатегорияЭксплуатации);
				ЭлементБлокировки.УстановитьЗначение("ДатаНачалаЭксплуатации", СправочникОбъект.ДатаНачалаЭксплуатации);
				
				
				БлокировкаНовыхПартий.Заблокировать();
				
				ТекстЗапроса = 
				"ВЫБРАТЬ ПЕРВЫЕ 1
				|	НовыеПартииТМЦ.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник.ПартииТМЦВЭксплуатации КАК НовыеПартииТМЦ
				|ГДЕ
				|	НовыеПартииТМЦ.КатегорияЭксплуатации = &КатегорияЭксплуатации
				|	И НовыеПартииТМЦ.СрокЭксплуатации = &СрокЭксплуатации
				|	И НовыеПартииТМЦ.ДатаНачалаЭксплуатации = &ДатаНачалаЭксплуатации
				|	И НовыеПартииТМЦ.ИнвентарныйНомер = &ИнвентарныйНомер
				|	И НовыеПартииТМЦ.Партия258
				|	И НЕ НовыеПартииТМЦ.ПометкаУдаления";
				
				ЗапросНовыхПартий = Новый Запрос(ТекстЗапроса);
				ЗапросНовыхПартий.УстановитьПараметр("КатегорияЭксплуатации", СправочникОбъект.КатегорияЭксплуатации);
				ЗапросНовыхПартий.УстановитьПараметр("СрокЭксплуатации", СправочникОбъект.СрокЭксплуатации);
				ЗапросНовыхПартий.УстановитьПараметр("ДатаНачалаЭксплуатации", НачалоМесяца(СправочникОбъект.ДатаНачалаЭксплуатации));
				ЗапросНовыхПартий.УстановитьПараметр("ИнвентарныйНомер", "");
				
				
				РезультатНовыхПартий = ЗапросНовыхПартий.Выполнить();
				ВыборкаНовыхПартий = РезультатНовыхПартий.Выбрать();
				
				Если НЕ ВыборкаНовыхПартий.Следующий() Тогда
					
					// Текущая партия конвертируется в новую партию, чтобы не увеличивать количество записей
					СправочникОбъект.Партия258 = Истина;
					СправочникОбъект.ПометкаУдаления = Ложь;
					СправочникОбъект.ДатаНачалаЭксплуатации = НачалоМесяца(СправочникОбъект.ДатаНачалаЭксплуатации);
					
					
					Если СправочникОбъект.СрокЭксплуатации <> 0 Тогда
						СправочникОбъект.ДатаЗавершенияЭксплуатации = 
							НачалоДня(КонецМесяца(ДобавитьМесяц(СправочникОбъект.ДатаНачалаЭксплуатации, СправочникОбъект.СрокЭксплуатации)));
					КонецЕсли;
					
					ЗаполнитьЗначенияСвойств(ПараметрыНаименования, СправочникОбъект);
					СправочникОбъект.Наименование = СформироватьНаименование(ПараметрыНаименования);
					
				Иначе
					
					СправочникОбъект.НоваяПартия = ВыборкаНовыхПартий.Ссылка;
				
				КонецЕсли;
				
			КонецЕсли;
			
			Если СправочникОбъект.Модифицированность() Тогда
				ОбновлениеИнформационнойБазы.ЗаписатьДанные(СправочникОбъект);
			Иначе
				ОбновлениеИнформационнойБазы.ОтметитьВыполнениеОбработки(Выборка.Ссылка);
			КонецЕсли;
			
			ЗафиксироватьТранзакцию();
			
		Исключение
			
			ОтменитьТранзакцию();
			
			ОбновлениеИнформационнойБазыУТ.СообщитьОНеудачнойОбработке(ИнформацияОбОшибке(), Выборка.Ссылка);
			
		КонецПопытки;
		
	КонецЦикла;
	
	Параметры.ОбработкаЗавершена = ОбновлениеИнформационнойБазы.ОбработкаДанныхЗавершена(Параметры.Очередь, ПолноеИмяОбъекта);
	
КонецПроцедуры
 
#КонецОбласти

#КонецОбласти	
	
#КонецЕсли
