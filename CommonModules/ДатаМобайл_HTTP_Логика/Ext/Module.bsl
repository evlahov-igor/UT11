
#Область System

// Проверка соединения с сервером.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция DMServerInfo() Экспорт
	
	СтруктураДанных = Новый Структура;
	
	СтруктураДанных.Вставить("data", "Соединение с сервером установлено! ");  
	
	Возврат ПодготовитьОтветJSON(СтруктураДанных);
	
КонецФункции

// Пинг соединения.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция Ping() Экспорт
	
	СтруктураДанных = Новый Структура;
	
	СтруктураДанных.Вставить("is_success", Истина);  
	
	Возврат ПодготовитьОтветJSON(СтруктураДанных);
	
КонецФункции

// Получение версии ПО.
// 
// Параметры:
//   ВерсияПО - Строка - Версия ПО.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция GetVersion(ВерсияПО) Экспорт
	
	СтруктураДанных = Новый Структура;
	
	Если Лев(ВерсияПО,1) = "3" Тогда	
		Если Сред(ВерсияПО, 4, 1) = "2" Тогда
			СтруктураДанных.Вставить("data", "3.2");
		Иначе	 
			СтруктураДанных.Вставить("data", "3.0");	
		КонецЕсли;	
	Иначе	
		СтруктураДанных.Вставить("data", "2.9");  
	КонецЕсли; 
	
	Возврат ПодготовитьОтветJSON(СтруктураДанных);
	
КонецФункции

#КонецОбласти

#Область Devices

// Получение новых данных.
//
// Параметры:
//   SN - Строка - Идентификатор устройства.
//   UserName - Строка - Имя пользователя.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция IsNewData(SN, UserName) Экспорт
	
	ОбъектОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
	|	ИСТИНА КАК new_templates,
	|	ЛОЖЬ КАК new_cells,
	|	ЛОЖЬ КАК new_docs,
	|	ЛОЖЬ КАК new_users,
	|	ЛОЖЬ КАК new_arts,
	|	ЛОЖЬ КАК new_clients,
	|	ЛОЖЬ КАК new_units,
	|	ЛОЖЬ КАК new_egais_arts,
	|	ЛОЖЬ КАК new_warehouses,
	|	ЛОЖЬ КАК new_egais_marks,
	|	ЛОЖЬ КАК new_steps,
	|	ЛОЖЬ КАК need_check_ftp,
	|	ЛОЖЬ КАК new_roles
	|ПОМЕСТИТЬ ИзмененияДанных
	|
	|ИЗ
	|	Справочник.ДатаМобайл_ШаблоныДокументов.Изменения КАК ДатаМобайл_ШаблоныДокументовИзменения
	|ГДЕ
	|	НЕ ДатаМобайл_ШаблоныДокументовИзменения.Ссылка.ПометкаУдаления
	|	И ДатаМобайл_ШаблоныДокументовИзменения.Узел = &Узел
	|		
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ИСТИНА,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.Изменения КАК ДатаМобайл_ДокументыТСДИзменения
	|ГДЕ
	|	НЕ ДатаМобайл_ДокументыТСДИзменения.Ссылка.ПометкаУдаления
	|	И ДатаМобайл_ДокументыТСДИзменения.Узел = &Узел
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ИСТИНА,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Справочник.Номенклатура.Изменения КАК НоменклатураИзменения
	|ГДЕ
	|	НЕ НоменклатураИзменения.Ссылка.ПометкаУдаления
	|	И НоменклатураИзменения.Узел = &Узел
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ИСТИНА,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Справочник.ХарактеристикиНоменклатуры.Изменения КАК ХарактеристикиНоменклатурыИзменения
	|ГДЕ
	|	НЕ ХарактеристикиНоменклатурыИзменения.Ссылка.ПометкаУдаления
	|	И ХарактеристикиНоменклатурыИзменения.Узел = &Узел
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ИСТИНА,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры.Изменения КАК ШтрихкодыНоменклатурыИзменения
	|ГДЕ
	|	ШтрихкодыНоменклатурыИзменения.Узел = &Узел
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ИСТИНА,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Справочник.ДатаМобайл_НовыеТовары.Изменения КАК ДатаМобайл_НовыеТоварыИзменения
	|ГДЕ
	|	ДатаМобайл_НовыеТоварыИзменения.Узел = &Узел
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ИСТИНА,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	РегистрСведений.ДатаМобайл_НовыеШтрихкоды.Изменения КАК ДатаМобайл_НовыеШтрихкодыИзменения
	|ГДЕ
	|	ДатаМобайл_НовыеШтрихкодыИзменения.Узел = &Узел
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ИСТИНА,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Справочник.Партнеры.Изменения КАК ПартнерыИзменения
	|ГДЕ
	|	НЕ ПартнерыИзменения.Ссылка.ПометкаУдаления
	|	И ПартнерыИзменения.Узел = &Узел
	|		
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ИСТИНА,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ
	|ИЗ
	|	Справочник.Склады.Изменения КАК СкладыИзменения
	|ГДЕ
	|	НЕ СкладыИзменения.Ссылка.ПометкаУдаления
	|	И СкладыИзменения.Узел = &Узел
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ЛОЖЬ,
	|	ДатаМобайл_СписокТСД.выгружатьТоварыНаFTP,
	|	ЛОЖЬ
	|ИЗ
	|	ПланОбмена.ДатаМобайл_СписокТСД КАК ДатаМобайл_СписокТСД
	|ГДЕ
	|	ДатаМобайл_СписокТСД.Ссылка = &Узел"; 
	
	Если УзелПО.ИспользоватьПорционнуюВыгрузку Тогда
		
		НаборЗаписей = РегистрыСведений.ДатаМобайл_ПорционнаяВыгрузка.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ТСД.Установить(УзелПО);
		НаборЗаписей.Отбор.ТипОбъекта.Установить(1);
		НаборЗаписей.Прочитать();
		
		Если НаборЗаписей.Количество() Тогда
		
			Запрос.Текст = Запрос.Текст + Символы.ПС +
			
			"
			|ОБЪЕДИНИТЬ ВСЕ
			|	
			|ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
			|	ЛОЖЬ,
			|	ЛОЖЬ,
			|	ЛОЖЬ,
			|	ЛОЖЬ,
			|	ИСТИНА,
			|	ЛОЖЬ,
			|	ЛОЖЬ,
			|	ЛОЖЬ,
			|	ЛОЖЬ,
			|	ЛОЖЬ,
			|	ЛОЖЬ,
			|	ЛОЖЬ,
			|	ЛОЖЬ
			|ИЗ
			|	РегистрСведений.ДатаМобайл_ПорционнаяВыгрузка КАК ДатаМобайл_ПорционнаяВыгрузка
			|ГДЕ
			|	ДатаМобайл_ПорционнаяВыгрузка.ТСД = &Узел";     
			
		КонецЕсли;	
		
	КонецЕсли;  
	
	Запрос.Текст = Запрос.Текст + Символы.ПС + "
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ИзмененияДанных.new_templates) КАК new_templates,
	|	МАКСИМУМ(ИзмененияДанных.new_cells) КАК new_cells,
	|	МАКСИМУМ(ИзмененияДанных.new_docs) КАК new_docs,
	|	МАКСИМУМ(ИзмененияДанных.new_users) КАК new_users,
	|	МАКСИМУМ(ИзмененияДанных.new_arts) КАК new_arts,
	|	МАКСИМУМ(ИзмененияДанных.new_clients) КАК new_clients,
	|	МАКСИМУМ(ИзмененияДанных.new_units) КАК new_units,
	|	МАКСИМУМ(ИзмененияДанных.new_egais_arts) КАК new_egais_arts,
	|	МАКСИМУМ(ИзмененияДанных.new_warehouses) КАК new_warehouses,
	|	МАКСИМУМ(ИзмененияДанных.new_egais_marks) КАК new_egais_marks,
	|	МАКСИМУМ(ИзмененияДанных.new_steps) КАК new_steps,
	|	МАКСИМУМ(ИзмененияДанных.need_check_ftp) КАК need_check_ftp,
	|	МАКСИМУМ(ИзмененияДанных.new_roles) КАК new_roles
	|ИЗ
	|	ИзмененияДанных КАК ИзмененияДанных";
	
	Запрос.УстановитьПараметр("Узел", УзелПО.Ссылка);
	Рез = Запрос.Выполнить().Выбрать();
	
	Если Рез.Следующий() Тогда		
		
		ОбъектОтвета.Вставить("is_need_clear_templates",  		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьШаблоны"));
		ОбъектОтвета.Вставить("is_need_load_templates",   		 ?(Рез.new_templates, Рез.new_templates, ОбъектОтвета.is_need_clear_templates));
		
		ОбъектОтвета.Вставить("is_need_clear_cells",     		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьЯчейки"));
		ОбъектОтвета.Вставить("is_need_load_cells",       		 ?(Рез.new_cells, Рез.new_cells, ОбъектОтвета.is_need_clear_cells));
		
		ОбъектОтвета.Вставить("is_need_clear_docs",       		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьДокументы"));
		ОбъектОтвета.Вставить("is_need_load_docs",         		 ?(Рез.new_docs, Рез.new_docs, ОбъектОтвета.is_need_clear_docs));
		
		ОбъектОтвета.Вставить("is_need_clear_users",      		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьПользователей"));
		ОбъектОтвета.Вставить("is_need_load_users",        		 ?(Рез.new_users, Рез.new_users, ОбъектОтвета.is_need_clear_users));
		
		ОбъектОтвета.Вставить("is_need_clear_arts",       	 	 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьТовары"));
		ОбъектОтвета.Вставить("is_need_load_arts",         		 ?(Рез.new_arts, Рез.new_arts, ОбъектОтвета.is_need_clear_arts));
		
		ОбъектОтвета.Вставить("is_need_clear_clients",    		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьКлиентов"));
		ОбъектОтвета.Вставить("is_need_load_clients",      		 ?(Рез.new_clients, Рез.new_clients, ОбъектОтвета.is_need_clear_clients));
		
		ОбъектОтвета.Вставить("is_need_clear_units",      		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьЕдиницыИзмерения"));
		ОбъектОтвета.Вставить("is_need_load_units",        		 ?(Рез.new_units, Рез.new_units, ОбъектОтвета.is_need_clear_units));
		
		ОбъектОтвета.Вставить("is_need_clear_egais_arts",  		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьТоварыЕГАИС"));
		ОбъектОтвета.Вставить("is_need_load_egais_arts",    	 ?(Рез.new_egais_arts, Рез.new_egais_arts, ОбъектОтвета.is_need_clear_egais_arts));
		
		ОбъектОтвета.Вставить("is_need_clear_warehouses", 		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьСклады"));
		ОбъектОтвета.Вставить("is_need_load_warehouses",   		 ?(Рез.new_warehouses, Рез.new_warehouses, ОбъектОтвета.is_need_clear_warehouses));
		
		ОбъектОтвета.Вставить("is_need_clear_egais_marks", 		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьМаркиЕГАИС"));
		ОбъектОтвета.Вставить("is_need_load_egais_marks",   	 ?(Рез.new_egais_marks, Рез.new_egais_marks, ОбъектОтвета.is_need_clear_egais_marks));
		
		ОбъектОтвета.Вставить("is_need_clear_art_marks", 		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьКодыМаркировки"));
		ОбъектОтвета.Вставить("is_need_load_art_marks",   		 ОбъектОтвета.is_need_clear_art_marks);
		
		ОбъектОтвета.Вставить("is_need_clear_steps",             ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьДополнительныеФормы"));
		ОбъектОтвета.Вставить("is_need_load_steps",    	     	 ?(Рез.new_steps, Рез.new_steps, ОбъектОтвета.is_need_clear_steps));
		
		ОбъектОтвета.Вставить("is_need_clear_barcode_templates", ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьШаблоныШтрихкодов"));
		ОбъектОтвета.Вставить("is_need_load_barcode_templates",  ОбъектОтвета.is_need_clear_barcode_templates);
		
		ОбъектОтвета.Вставить("is_need_clear_sn_types", 		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьТипыСерий"));
		ОбъектОтвета.Вставить("is_need_load_sn_types",  		 ОбъектОтвета.is_need_clear_sn_types);
		
		ОбъектОтвета.Вставить("is_need_clear_roles",      		 ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьРоли"));
		ОбъектОтвета.Вставить("is_need_load_roles",        		 ?(Рез.new_roles, Рез.new_roles, ОбъектОтвета.is_need_clear_roles));
		
		ОбъектОтвета.Вставить("is_need_load_from_ftp",      	 Рез.need_check_ftp);
		
	КонецЕсли;
	
	ДатаМобайл_ОбщийМодуль.ЗаписьЗначенийУзлаОбменаТСД(УзелПО, "ДатаПоследнейЗагрузкиСправочников", ТекущаяДата());
	
	Возврат ПодготовитьОтветJSON(ОбъектОтвета);
	
КонецФункции

// Авторизация в ПО.
//
// Параметры:
//   SN - Строка - Идентификатор устройства.
//   UserName - Строка - Имя пользователя.
//   name - Строка - Наименование ТСД.
//   AppVersion - Строка - Версия ПО.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция Login(SN, UserName, name, AppVersion) Экспорт
	
	УзелПО = НайтиУзел(SN);
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, Username);
	КонецЕсли;	
	
	ДатаМобайл_ОбщийМодуль.ЗаписьЗначенийУзлаОбменаТСД(УзелПО, "ТекущийПользователь", UserName);
	ДатаМобайл_ОбщийМодуль.ЗаписьЗначенийУзлаОбменаТСД(УзелПО, "ДатаПоследнейАвторизацииПользователя", ТекущаяДата());
	
	НаименованиеТСД = СокрЛП(name);
	Узел = УзелПО.ПолучитьОбъект();
	Если НаименованиеТСД <> "" И СокрЛП(УзелПО.Наименование) = "" Тогда
		Узел.Наименование = НаименованиеТСД;	
	КонецЕсли;	
	
	ВерсияПО = СокрЛП(AppVersion);
	Если СокрЛП(УзелПО.ВерсияПО) <> ВерсияПО Тогда
		Узел.ВерсияПО = ВерсияПО;
	КонецЕсли;
	
	Попытка Узел.Записать(); Исключение КонецПопытки;	 
	
	СтруктураДанных = Новый Структура;
	СтруктураДанных.Вставить("is_success", Истина);  
	СтруктураДанных.Вставить("device_name", УзелПО.Наименование);
	
	ВерсияАРМ = ДатаМобайл_ОбщийМодуль.ПолучитьВерсиюАРМ("Login");
	
	УчетныеДанныеСистемы = Новый Структура;
	УчетныеДанныеСистемы.Вставить("module_number", 1); 
	УчетныеДанныеСистемы.Вставить("arm_version", ВерсияАРМ);
	
	СтруктураДанных.Вставить("accounting_system", УчетныеДанныеСистемы);
	
	Возврат ПодготовитьОтветJSON(СтруктураДанных);
	
КонецФункции

// Завершение работы в ПО.
//
// Параметры:
//   SN - Строка - Идентификатор устройства.
//   UserName - Строка - Имя пользователя.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция Logout(SN, UserName) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	
	
	ДатаМобайл_ОбщийМодуль.ЗаписьЗначенийУзлаОбменаТСД(УзелПО, "ТекущийПользователь", ""); 
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

#КонецОбласти

#Область Users

// Получение списка пользователей и ролей.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
//
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetUsers(SN, UserName) Экспорт
	
	Модуль_СтроковыеФункцииКлиентСервер = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("СтроковыеФункцииКлиентСервер");
	
	ОбъектСписка = Новый Массив;	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьПользователей") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьПользователей", Ложь);	 
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьРоли") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьРоли", Ложь);	 
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ДатаМобайл_Пользователи.Ссылка КАК Пользователь,
	|	ЕСТЬNULL(ДатаМобайл_РолиПользователи.Ссылка, ЗНАЧЕНИЕ(Справочник.ДатаМобайл_Роли.ПустаяСсылка)) КАК Роль,
	|	ЕСТЬNULL(ДатаМобайл_РолиПользователи.Ссылка.Наименование, """") КАК НаименованиеРоли,
	|	ДатаМобайл_Пользователи.Логин КАК login,
	|	ДатаМобайл_Пользователи.Наименование КАК name,
	|	ДатаМобайл_Пользователи.Пароль КАК pass
	|ИЗ
	|	Справочник.ДатаМобайл_Пользователи КАК ДатаМобайл_Пользователи
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_Роли.Пользователи КАК ДатаМобайл_РолиПользователи
	|		ПО (ДатаМобайл_Пользователи.Ссылка = ДатаМобайл_РолиПользователи.Пользователь)
	|			И (НЕ ДатаМобайл_РолиПользователи.Ссылка.ПометкаУдаления)
	|ГДЕ
	|	(НЕ ДатаМобайл_РолиПользователи.Ссылка = ЗНАЧЕНИЕ(Справочник.ДатаМобайл_Роли.ПустаяСсылка)
	|				И ДатаМобайл_РолиПользователи.Ссылка В (&СписокРолей)
	|			ИЛИ &ВсеРоли)
	|	И НЕ ДатаМобайл_Пользователи.Ссылка.ПометкаУдаления
	|	И НЕ ДатаМобайл_Пользователи.Пользователь1С.ПометкаУдаления
	|ИТОГИ ПО
	|	Пользователь");
	
	Попытка
		СписокРолей = УзелПО.Роли.ВыгрузитьКолонку("Роль");
	Исключение 
		СписокРолей = Новый СписокЗначений;
	КонецПопытки;
	
	Запрос.УстановитьПараметр("Узел", УзелПО.Ссылка);
	Запрос.УстановитьПараметр("СписокРолей", СписокРолей);
	Запрос.УстановитьПараметр("ВсеРоли", СписокРолей.Количество() = 0);
	
	ПользователиДляВыгрузки = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ПользователиДляВыгрузки.Следующий() Цикл
		ОбъектПользователь = ПолучитьСтруктуруОбъектаДляHttp("user");
		ОбъектПользователь.id                = XMLСтрока(ПользователиДляВыгрузки.Пользователь);
		ОбъектПользователь.login            = ПользователиДляВыгрузки.login; 
		ОбъектПользователь.username 		= ПользователиДляВыгрузки.name; 
		ОбъектПользователь.password 		= ПользователиДляВыгрузки.pass;  
		ОбъектПользователь.is_admin 		= Истина; 
		ОбъектПользователь.is_can_edit_arts = Истина;
		
		Роли = ПользователиДляВыгрузки.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
		СтрокаРолей = "";
		Пока Роли.Следующий() Цикл
			Если Не ЗначениеЗаполнено(Роли.Роль) Тогда Продолжить; КонецЕсли;
			
			СтрокаРолей = СтрокаРолей + XMLСтрока(Роли.Роль) + ",";		
		КонецЦикла; 
		
		СтрокаРолей = ?(Прав(СтрокаРолей, 1) = ",", Лев(СтрокаРолей, СтрДлина(СтрокаРолей) - 1), СтрокаРолей);
		
		МассивРолей = Новый Массив;
		Если СтрокаРолей <> "" Тогда
			МассивРолей = Модуль_СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(СтрокаРолей, ",");;
		КонецЕсли;
		ОбъектПользователь.Вставить("roles", МассивРолей);	
		
		ОбъектСписка.Добавить(ОбъектПользователь);
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение списка ролей.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetRoles(SN, UserName) Экспорт
	
	ОбъектСписка = Новый Массив;	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
		
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьРоли") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьРоли", Ложь);	 
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ДатаМобайл_РолиПрава.Ссылка КАК Роль,
	|	ДатаМобайл_РолиПрава.Ссылка.Наименование КАК Наименование,
	|	ДатаМобайл_РолиПрава.ДляТСД КАК ДляТСД,
	|	ВЫБОР
	|		КОГДА ДатаМобайл_РолиПрава.Пометка
	|			ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Пометка
	|ИЗ
	|	Справочник.ДатаМобайл_Роли.Права КАК ДатаМобайл_РолиПрава
	|ГДЕ	
	|	НЕ ДатаМобайл_РолиПрава.Ссылка.ПометкаУдаления
	|	И (ДатаМобайл_РолиПрава.Ссылка В(&СписокРолей) ИЛИ &ВсеРоли)
	|ИТОГИ ПО
	|	Роль");
	
	Попытка
		СписокРолей = УзелПО.Роли.ВыгрузитьКолонку("Роль");
	Исключение 
		СписокРолей = Новый СписокЗначений;
	КонецПопытки;
	
	Запрос.УстановитьПараметр("Узел", УзелПО.Ссылка);
	Запрос.УстановитьПараметр("СписокРолей", СписокРолей);
	Запрос.УстановитьПараметр("ВсеРоли", СписокРолей.Количество() = 0);
	
	РолиДляВыгрузки = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока РолиДляВыгрузки.Следующий() Цикл
		ОбъектРоль = ПолучитьСтруктуруОбъектаДляHttp("user", "role");
		ОбъектРоль.id                	= XMLСтрока(РолиДляВыгрузки.Роль);
		ОбъектРоль.name            		= РолиДляВыгрузки.Наименование; 
		
		Права = РолиДляВыгрузки.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
		СтруктураПрав = Новый Структура;
		Пока Права.Следующий() Цикл
			СтруктураПрав.Вставить(Права.ДляТСД, Права.Пометка);
		КонецЦикла; 
		
		ОбъектРоль.permissions = СтруктураПрав;
		
		ОбъектСписка.Добавить(ОбъектРоль);
	КонецЦикла;	
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

#КонецОбласти

#Область Arts

// Идентификация и получение объекта товара при сканировании в подборе.
//
// Параметры:    
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя. 
// ШК - Строка - Штрихкод.
// DocOutID - Строка - Id документа ТСД. 
// Ячейка - Строка - Код ячейки.
// Params - Структура - Структура (не обязательных) доп. параметров.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция OnArtScanSelect(SN, UserName, ШК, DocOutID, Ячейка, Params) Экспорт 
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не нашли документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	
	ЗначенияРеквизитовСсылкаНаДок = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок, "ТСД,ДатаНачалаСбора,ДатаЗавершенияСбора,Шаблон,ИсходныйДокумент,Склад,Помещение");
	
	ДокТСД 				   	= ЗначенияРеквизитовСсылкаНаДок.ТСД;
	ДокДатаНачалаСбора 	   	= ЗначенияРеквизитовСсылкаНаДок.ДатаНачалаСбора;
	ДокДатаЗавершенияСбора 	= ЗначенияРеквизитовСсылкаНаДок.ДатаЗавершенияСбора;
	Шаблон 				   	= ЗначенияРеквизитовСсылкаНаДок.Шаблон;
	ИсходныйДокумент 	   	= ЗначенияРеквизитовСсылкаНаДок.ИсходныйДокумент;
	ТекущийСклад  			= ЗначенияРеквизитовСсылкаНаДок.Склад;
	ТекущееПомещение  		= ЗначенияРеквизитовСсылкаНаДок.Помещение;
	
	Если Шаблон = Неопределено Тогда		
		СтруктураОтвета.Вставить("Описание", "Не нашли запись документа. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
	КонецЕсли;
	
	РеквизитыШаблона = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ВидДокумента,ИмяТабличнойЧастиПодбор,ИмяТабличнойЧастиПриемка,
	|РаспределениеТоваров,ИспользоватьПодбор,ИспользоватьПриемку,ЕГАИС,ИспользоватьМаркировку,
	|ИспользованиеЯчеекПодбор,ИспользованиеЯчеекПриемка,ВыгрузкаЯчеекПодбор,ГрупповаяРабота,ПроверкаОСГ,ДобавлятьКоличествоПоЗаданиюКОстатку,РежимКомплектации");
	
	ВидДокумента 									= РеквизитыШаблона.ВидДокумента;
	ИмяТабличнойЧастиПодбор 						= РеквизитыШаблона.ИмяТабличнойЧастиПодбор;
	ИмяТабличнойЧастиПриемка 						= РеквизитыШаблона.ИмяТабличнойЧастиПриемка;
	МножествоДокументовКакЗадание 					= РеквизитыШаблона.РаспределениеТоваров = 1;
	ИспользоватьПодбор								= РеквизитыШаблона.ИспользоватьПодбор;
	ИспользоватьПриемку								= РеквизитыШаблона.ИспользоватьПриемку;
	ГрупповойДокумент								= РеквизитыШаблона.РаспределениеТоваров = 2;
	ЕГАИС											= РеквизитыШаблона.ЕГАИС;
	ИспользоватьМаркировку							= РеквизитыШаблона.ИспользоватьМаркировку;
	ИспользованиеЯчеекПодбор                      	= РеквизитыШаблона.ИспользованиеЯчеекПодбор;
	ИспользованиеЯчеекПриемка                      	= РеквизитыШаблона.ИспользованиеЯчеекПриемка;
	ВыгрузкаЯчеекПодбор                            	= РеквизитыШаблона.ВыгрузкаЯчеекПодбор;
	ГрупповаяРабота                                	= РеквизитыШаблона.ГрупповаяРабота;
	ПроверкаОСГ                                    	= РеквизитыШаблона.ПроверкаОСГ;
	ДобавлятьКоличествоПоЗаданиюКОстатку           	= РеквизитыШаблона.ДобавлятьКоличествоПоЗаданиюКОстатку;
	РежимКомплектации 								= РеквизитыШаблона.РежимКомплектации;
	
	Тип_Набор  = Перечисления.ТипыНоменклатуры.Набор;
	
	Если ВидДокумента = "ЗаданиеНаПеревозку" Тогда	
		ВидДокумента = "ЗаказКлиента";
		ИмяТабличнойЧастиПодбор = "Товары";
		ИмяТабличнойЧастиПриемка = "Товары";	
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ДокТСД) Тогда
		Если ДокТСД <> УзелПО Тогда			
			СтруктураОтвета.Вставить("Описание", "Чужой документ. ");			
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;
	
	Если ДокДатаЗавершенияСбора <> Дата(1, 1, 1) Тогда		
		СтруктураОтвета.Вставить("Описание", "Закрытый документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;			
	
	ЗначенияРеквизитовУзелПО = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(УзелПО, "ТипЦен, ДобавлятьАртикулВНаименование, ПростойФорматВесовыхШтрихкодов");
	ТипЦен = ЗначенияРеквизитовУзелПО.ТипЦен;
	ВключатьАртикул = ЗначенияРеквизитовУзелПО.ДобавлятьАртикулВНаименование;
	ПростойФорматВесовыхШтрихкодов = ЗначенияРеквизитовУзелПО.ПростойФорматВесовыхШтрихкодов;
	
	Если СтрДлина(ШК) = 5 И Не ПростойФорматВесовыхШтрихкодов Тогда
		ВесовойШК = "2_" + ШК + "00000_";
	Иначе
		ВесовойШК = ШК;
	КонецЕсли;  
	
	Если СтрДлина(ШК) = 20 И Лев(ШК,2) = "00" Тогда					 
		ШК2 = "(00)" + Сред(ШК, 3, 18);		
	ИначеЕсли СтрДлина(ШК) = 22 И Лев(ШК,2) = "(00)" Тогда					 
		ШК2 = "00" + Сред(ШК, 5, 18);
	Иначе
		ШК2 = ШК;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Ячейка) Тогда
		ТекущаяЯчейкаСсылка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(Ячейка, СсылкаНаДок);
	Иначе
		ТекущаяЯчейкаСсылка = Неопределено;
	КонецЕсли; 
	
	
	Запрос = Новый Запрос;
	
	МетаданныеДокумента = Метаданные.Документы[ВидДокумента];
	
	Если ЕГАИС Тогда
		OnArtScan_Select_EGAIS(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, Запрос, "Select");	
	Иначе
		Попытка
			лЕстьЯчейка = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Ячейка") <> Неопределено;
		Исключение
			лЕстьЯчейка = Ложь;
		КонецПопытки;
		
		Если ИспользованиеЯчеекПодбор = 0 Или ВыгрузкаЯчеекПодбор = 1 Или Не лЕстьЯчейка Тогда
			OnArtScan_Select_Insert_Casual(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, Запрос, "Select");
			Запрос.УстановитьПараметр("Артикул", ?(УзелПО.ИспользоватьАртикулКакШтрихкодТовара, ШК, Неопределено));
		Иначе
			OnArtScan_Select_Insert_Cells(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, Запрос, "Select", Ячейка)
		КонецЕсли;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ТипЦен", ТипЦен);
	Запрос.УстановитьПараметр("ИсходныйДокумент", ИсходныйДокумент);
	Запрос.УстановитьПараметр("ИсходноеЗадание", СсылкаНаДок);          	
	Запрос.УстановитьПараметр("ШтрихКод", ШК); 
	Запрос.УстановитьПараметр("ШтрихКод2", ШК2);
	Запрос.УстановитьПараметр("НесколькоДокументов", МножествоДокументовКакЗадание);
	Запрос.УстановитьПараметр("Документы", СсылкаНаДок.Задания.ВыгрузитьКолонку("Задание"));
	Запрос.УстановитьПараметр("ВесовойШтрихКод", ВесовойШК);
	Запрос.УстановитьПараметр("ВсеУпаковки", Истина);
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");	
	Если ЗначениеЗаполнено(ТекущийСклад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(ТекущийСклад);			
	КонецЕсли;		
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(ТекущееПомещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(ТекущееПомещение);			
	КонецЕсли;	
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	Запрос.УстановитьПараметр("ВключатьАртикул", ВключатьАртикул);
	
	Тип_Услуга = Перечисления.ТипыНоменклатуры.Услуга;
	
	Рез = Запрос.Выполнить().Выгрузить();
	Для каждого СтрокаДока Из Рез Цикл 
				
		СтрокаДока.Коэффициент = ?(СтрокаДока.Коэффициент = 0, 1, СтрокаДока.Коэффициент);
		СтрокаДока.НаименованиеУпаковки = ?(ЗначениеЗаполнено(СтрокаДока.НаименованиеУпаковки), СтрокаДока.НаименованиеУпаковки, "шт.");
		
		// Табачные изделия, штрихкод товара на все характеристики
		ЕстьХарактеристикиБезШтрихкодов = Ложь;
		ТипПродукции = ДатаМобайл_Маркировка.ПолучитьТипМаркированнойПродукции(СтрокаДока.Номенклатура);
		Если Не СтрокаДока.ЭтоНовыйТовар И УзелПО.ВыводитьВсеХарактеристикиПоШтрихкоду Тогда
			
			ЗапросВсехХарактеристик = Новый Запрос();				
			ЗапросВсехХарактеристик.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
			|	ХарактеристикиНоменклатуры.Ссылка,
			|	ХарактеристикиНоменклатуры.Наименование,
			|	ХарактеристикиНоменклатуры.Владелец,
			|	ХарактеристикиНоменклатуры.Владелец КАК Номенклатура,
			|	ХарактеристикиНоменклатуры.Ссылка КАК Характеристика,
			|	ХарактеристикиНоменклатуры.Владелец.ВесМожноУказыватьВДокументах КАК Весовой,
			|	ХарактеристикиНоменклатуры.Владелец.АлкогольнаяПродукция КАК АлкогольнаяПродукция,  
			|	ХарактеристикиНоменклатуры.Владелец.ВидНоменклатуры КАК ВидНоменклатуры,        
			|	ХарактеристикиНоменклатуры.Владелец.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
			|	ХарактеристикиНоменклатуры.Владелец.ВладелецХарактеристик КАК ВладелецХарактеристик,
			|	ХарактеристикиНоменклатуры.Владелец.Наименование КАК НаименованиеНоменклатуры,
			|	ХарактеристикиНоменклатуры.Владелец.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,
			|	ХарактеристикиНоменклатуры.Наименование КАК НаименованиеХарактеристики			
			|ИЗ
			|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
			|ГДЕ
			|	ХарактеристикиНоменклатуры.Владелец = &Владелец
			|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления";
			
			Если СтрокаДока.ИспользованиеХарактеристик = Перечисления.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры Тогда 
				ЗапросВсехХарактеристик.УстановитьПараметр("Владелец", СтрокаДока.Номенклатура); 
			ИначеЕсли СтрокаДока.ИспользованиеХарактеристик = Перечисления.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры Тогда  
				ЗапросВсехХарактеристик.УстановитьПараметр("Владелец", СтрокаДока.ВидНоменклатуры);  
			ИначеЕсли СтрокаДока.ИспользованиеХарактеристик = Перечисления.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры Тогда 
				ЗапросВсехХарактеристик.УстановитьПараметр("Владелец", СтрокаДока.ВладелецХарактеристик); 
			Иначе
				ЗапросВсехХарактеристик.УстановитьПараметр("Владелец", Неопределено);
			КонецЕсли;
			ЗапросВсехХарактеристик.УстановитьПараметр("ИсходноеЗадание", СсылкаНаДок);
			ЗапросВсехХарактеристик.УстановитьПараметр("Номенклатура", СсылкаНаДок); 
			ЗапросВсехХарактеристик.УстановитьПараметр("Склады", СписокСкладов);
			ЗапросВсехХарактеристик.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
			
			ВыборкаХарактеристик = ЗапросВсехХарактеристик.Выполнить().Выбрать();
			Пока ВыборкаХарактеристик.Следующий() Цикл	
				ЕстьХарактеристикиБезШтрихкодов = Истина;
				
				СтруктураТекущейСтроки = Новый Структура;
				
				ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan"); 
				ОбъектТовара.name = ЧистаяСтрока(СокрП(СтрокаДока.НаименованиеНоменклатуры) + " " + СокрП(ВыборкаХарактеристик.Наименование)); 			 			
				ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(ВыборкаХарактеристик.Ссылка);
				ОбъектТовара.price = СтрокаДока.Цена;
				
				// Выгрузка дополнительных видов цен
				ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрокаДока.Номенклатура, ВыборкаХарактеристик.Ссылка);
				
				Попытка	
					DMUseSN = ПолучитьПризнакУчетаСерий(СтрокаДока.ВидНоменклатуры, ТекущийСклад);   			 
				Исключение
					DMUseSN = Ложь;
				КонецПопытки;
				
				СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, СтрокаДока, DMUseSN, Шаблон);
				
				СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
				
				Попытка
					ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");
					ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура, СтрокаДока.Коэффициент);
					СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
				Исключение
				КонецПопытки;
				
				Попытка
					ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
				Исключение
					ДопускВесовогоТовара = Неопределено;
				КонецПопытки;
				
				Если ДопускВесовогоТовара <> Неопределено Тогда
					СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
				КонецЕсли;
				
				Попытка
					ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
				Исключение
					ДопускОСГ = Неопределено;
				КонецПопытки;
				
				Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
					СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
				КонецЕсли;
				
				ЭтоУслуга = Ложь;
				Попытка     
					Если СтрокаДока.ВидНоменклатурыТипНоменклатуры = Тип_Услуга Тогда
						ЭтоУслуга = Истина;
					КонецЕсли;
				Исключение
				КонецПопытки;
				
				ЭтоНабор = Ложь;
				Попытка 
					Если СтрокаДока.ВидНоменклатурыТипНоменклатуры = Тип_Набор Тогда
						ЭтоНабор = Истина;
					КонецЕсли;
				Исключение
				КонецПопытки;
				
				Если ЭтоНабор И РежимКомплектации = 1 Тогда
					ОбъектТовара.type = 1;
					ЗаполнитьОбъектНабора(ОбъектТовара, СтрокаДока, ВыборкаХарактеристик.Ссылка);
				Иначе
					ОбъектТовара.type = 0;
				КонецЕсли;
				
				limit_qty = 0;
				Если УзелПО.НеОтображатьОстатки Тогда
					limit_qty = 0;
				ИначеЕсли ЭтоУслуга Тогда
					limit_qty = 999;	
				Иначе	 
					limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, ВыборкаХарактеристик.Ссылка, ТекущаяЯчейкаСсылка, СтрокаДока.Упаковка);
					
					Если ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
						limit_qty = limit_qty + ПолучитьЗадание(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, ВыборкаХарактеристик.Ссылка, ТекущаяЯчейкаСсылка, СтрокаДока.Упаковка, "Select");		 
					КонецЕсли;
				КонецЕсли;
				
				СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
				
				Если СокрЛП(ЧистаяСтрока(ОбъектТовара.name)) = "" Или СокрЛП(ЧистаяСтрока(ОбъектТовара.id)) = "" Тогда
					Продолжить;
				КонецЕсли;
				
				ОбъектСписка.Добавить(СтруктураТекущейСтроки);
				
			КонецЦикла;		
		КонецЕсли;
		
		// Остальные товары 
		Если Не ЕстьХарактеристикиБезШтрихкодов Тогда
			
			СтруктураТекущейСтроки = Новый Структура;
			
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan");	
			ОбъектТовара.name = ЧистаяСтрока(СокрП(СтрокаДока.НаименованиеТовара));
			ОбъектТовара.id = ?(СтрокаДока.ЭтоНовыйТовар, "8n-" + XMLСтрока(СтрокаДока.Номенклатура), "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика));
			ОбъектТовара.price = СтрокаДока.Цена;
			
			// Выгрузка дополнительных видов цен
			ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Характеристика);
				
			Попытка	                                                    
				DMUseSN = ПолучитьПризнакУчетаСерий(СтрокаДока.ВидНоменклатуры, ТекущийСклад);
			Исключение
				DMUseSN = Ложь;
			КонецПопытки;
			
			СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, СтрокаДока, DMUseSN,Шаблон);  		 
			СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
			
			Попытка
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");
				ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура, СтрокаДока.Коэффициент);
				СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
			Исключение
			Конецпопытки;
			
			Попытка
				ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
			Исключение
				ДопускВесовогоТовара = Неопределено;
			КонецПопытки;
			
			Если ДопускВесовогоТовара <> Неопределено Тогда
				СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
			КонецЕсли;
			
			Попытка
				ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
			Исключение
				ДопускОСГ = Неопределено;
			КонецПопытки;
			
			Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
				СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
			КонецЕсли;
			
			ЭтоУслуга = Ложь;
			Попытка                       
				Если СтрокаДока.ВидНоменклатурыТипНоменклатуры = Тип_Услуга Тогда
					ЭтоУслуга = Истина;
				КонецЕсли;
			Исключение
			КонецПопытки;	
			
			ЭтоНабор = Ложь;
			Попытка 
				Если СтрокаДока.ВидНоменклатурыТипНоменклатуры = Тип_Набор Тогда
					ЭтоНабор = Истина;
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			Если ЭтоНабор И РежимКомплектации = 1 Тогда
				ОбъектТовара.type = 1;
				ЗаполнитьОбъектНабора(ОбъектТовара, СтрокаДока);
			Иначе
				ОбъектТовара.type = 0;
			КонецЕсли;
			
			Если УзелПО.НеОтображатьОстатки Тогда
				limit_qty = 0;
			ИначеЕсли ЭтоУслуга Тогда
				limit_qty = 999;
			Иначе		 
				limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, СтрокаДока.Характеристика, ТекущаяЯчейкаСсылка, СтрокаДока.Упаковка);
				
				Если ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
					limit_qty = limit_qty + ПолучитьЗадание(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, СтрокаДока.Характеристика, ТекущаяЯчейкаСсылка, СтрокаДока.Упаковка, "Select");		 
				КонецЕсли;		 			 
			КонецЕсли;
			
			СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
			
			Если СокрЛП(ЧистаяСтрока(ОбъектТовара.name)) = "" Или СокрЛП(ЧистаяСтрока(ОбъектТовара.id)) = "" Тогда
				Продолжить;
			КонецЕсли;
			
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		КонецЕсли;
	КонецЦикла;
	
	
	//ЗАПИСЬ	
	Если Не ГрупповаяРабота Тогда
		//ОБЫЧНАЯ ЛОГИКА
		Если Не ЗначениеЗаполнено(ДокДатаНачалаСбора) Или Не ЗначениеЗаполнено(ДокТСД) Тогда
			
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора = ТекущаяДата();
				Объект.ТСД = УзелПО;
				
				Объект.Записать();
				
				//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
				ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
			Исключение
			КонецПопытки;
		КонецЕсли;
		
	Иначе
		//ГРУППОВОЙ ДОКУМЕНТ
		
		ДатаСбораПоТСД = ДатаМобайл_ОбщийМодуль.ПолучитьДатуГрупповогоДокумента(SN, СсылкаНаДок, "ДатаНачалаСбора");	
		Если Не ЗначениеЗаполнено(ДатаСбораПоТСД) Тогда	
			ДатаМобайл_ОбщийМодуль.СоздатьНачальнуюЗаписьТСДГрупповыхДокументов(SN, СсылкаНаДок, UserName);		
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(ДокДатаНачалаСбора) Тогда
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора = ТекущаяДата();
				
				Объект.Записать();
			Исключение
			КонецПопытки;	
		КонецЕсли;
	КонецЕсли;	
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Идентификация и получение объекта товара при сканировании в приемке.
//
// Параметры:    
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя. 
// ШК - Строка - Штрихкод.
// DocOutID - Строка - Id документа ТСД. 
// Ячейка - Строка - Код ячейки.
// Params - Структура - Структура (не обязательных) доп. параметров.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция OnArtScanInsert(SN, UserName, ШК, DocOutID, Ячейка, Params) Экспорт 
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не нашли запись документа. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	
	ЗначенияРеквизитовСсылкаНаДок = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок, "ТСД,ДатаНачалаСбора,ДатаЗавершенияСбора,Шаблон,ИсходныйДокумент,Склад,Помещение");
	
	ДокТСД 					= ЗначенияРеквизитовСсылкаНаДок.ТСД;
	ДокДатаНачалаСбора 		= ЗначенияРеквизитовСсылкаНаДок.ДатаНачалаСбора;
	ДокДатаЗавершенияСбора 	= ЗначенияРеквизитовСсылкаНаДок.ДатаЗавершенияСбора;
	ИсходныйДокумент 		= ЗначенияРеквизитовСсылкаНаДок.ИсходныйДокумент;
	Шаблон 					= ЗначенияРеквизитовСсылкаНаДок.Шаблон;
	ТекущийСклад 			= ЗначенияРеквизитовСсылкаНаДок.Склад;
	ТекущееПомещение 		= ЗначенияРеквизитовСсылкаНаДок.Помещение;
	
	Если Шаблон = Неопределено Тогда		
		СтруктураОтвета.Вставить("Описание", "Не нашли запись документа. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	РеквизитыШаблона = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ВидДокумента,ИмяТабличнойЧастиПодбор,ИмяТабличнойЧастиПриемка,
	|РаспределениеТоваров,ИспользоватьПодбор,ИспользоватьПриемку,ЕГАИС,ИспользоватьМаркировку,
	|ИспользованиеЯчеекПодбор,ИспользованиеЯчеекПриемка,ВыгрузкаЯчеекПриемка,ГрупповаяРабота,ПроверкаОСГ,ДобавлятьКоличествоПоЗаданиюКОстатку");
	
	ВидДокумента 									= РеквизитыШаблона.ВидДокумента;
	ИмяТабличнойЧастиПодбор 						= РеквизитыШаблона.ИмяТабличнойЧастиПодбор;
	ИмяТабличнойЧастиПриемка 						= РеквизитыШаблона.ИмяТабличнойЧастиПриемка;
	МножествоДокументовКакЗадание 					= РеквизитыШаблона.РаспределениеТоваров = 1;
	ИспользоватьПодбор								= РеквизитыШаблона.ИспользоватьПодбор;
	ИспользоватьПриемку								= РеквизитыШаблона.ИспользоватьПриемку;
	ГрупповойДокумент								= РеквизитыШаблона.РаспределениеТоваров = 2;
	ЕГАИС											= РеквизитыШаблона.ЕГАИС;
	ИспользоватьМаркировку							= РеквизитыШаблона.ИспользоватьМаркировку;
	ИспользованиеЯчеекПодбор                      	= РеквизитыШаблона.ИспользованиеЯчеекПодбор;
	ИспользованиеЯчеекПриемка                      	= РеквизитыШаблона.ИспользованиеЯчеекПриемка;
	ВыгрузкаЯчеекПриемка              				= РеквизитыШаблона.ВыгрузкаЯчеекПриемка;
	ГрупповаяРабота                               	= РеквизитыШаблона.ГрупповаяРабота;
	ПроверкаОСГ                                    	= РеквизитыШаблона.ПроверкаОСГ;
	ДобавлятьКоличествоПоЗаданиюКОстатку           	= РеквизитыШаблона.ДобавлятьКоличествоПоЗаданиюКОстатку;
	
	Если ВидДокумента = "ЗаданиеНаПеревозку" Тогда	
		ВидДокумента = "ЗаказКлиента";
		ИмяТабличнойЧастиПодбор = "Товары";
		ИмяТабличнойЧастиПриемка = "Товары";	
	КонецЕсли;	
	
	Если ЗначениеЗаполнено(ДокТСД) Тогда
		Если ДокТСД <> УзелПО Тогда		
			СтруктураОтвета.Вставить("Описание", "Чужой документ.");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;
	
	Попытка
		ДокДатаЗавершенияСбора = СсылкаНаДок.ДатаЗавершенияСбора;
	Исключение	
		ДокДатаЗавершенияСбора = Дата(1, 1, 1);
	КонецПопытки;
	
	Если ДокДатаЗавершенияСбора <> Дата(1, 1, 1) Тогда		
		СтруктураОтвета.Вставить("Описание", "Закрытый документ.");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;					
	
	ЗначенияРеквизитовУзелПО = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(УзелПО, "ТипЦен, ДобавлятьАртикулВНаименование, ПростойФорматВесовыхШтрихкодов");
	ТипЦен = ЗначенияРеквизитовУзелПО.ТипЦен;
	ВключатьАртикул = ЗначенияРеквизитовУзелПО.ДобавлятьАртикулВНаименование;
	ПростойФорматВесовыхШтрихкодов = ЗначенияРеквизитовУзелПО.ПростойФорматВесовыхШтрихкодов;
 	
	Если СтрДлина(ШК) = 5 И Не ПростойФорматВесовыхШтрихкодов Тогда
		ВесовойШК = "2_" + ШК + "00000_";
	Иначе
		ВесовойШК = ШК;
	КонецЕсли;  
	
	Если СтрДлина(ШК) = 20 И Лев(ШК,2) = "00" Тогда					 
		ШК2 = "(00)" + Сред(ШК, 3, 18);		
	ИначеЕсли СтрДлина(ШК) = 22 И Лев(ШК,2) = "(00)" Тогда					 
		ШК2 = "00" + Сред(ШК, 5, 18);
	Иначе
		ШК2 = ШК;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Ячейка) Тогда
		ТекущаяЯчейкаСсылка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(Ячейка, СсылкаНаДок);
	Иначе
		ТекущаяЯчейкаСсылка = Неопределено;
	КонецЕсли; 
	
	Запрос = Новый Запрос;

	МетаданныеДокумента = Метаданные.Документы[ВидДокумента];
	
	Попытка
		лЕстьЯчейка = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПриемка].Реквизиты.Найти("Ячейка") <> Неопределено;
	Исключение
		лЕстьЯчейка = Ложь;
	КонецПопытки;
	
	Если ИспользованиеЯчеекПриемка = 0 Или ВыгрузкаЯчеекПриемка = 1 Или Не лЕстьЯчейка Тогда
		OnArtScan_Select_Insert_Casual(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, Запрос, "Insert");
		Запрос.УстановитьПараметр("Артикул", ?(УзелПО.ИспользоватьАртикулКакШтрихкодТовара, ШК, Неопределено));
	Иначе
		OnArtScan_Select_Insert_Cells(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, Запрос, "Insert", Ячейка);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ТипЦен", 				ТипЦен);
	Запрос.УстановитьПараметр("ИсходныйДокумент", 	 	ИсходныйДокумент);
	Запрос.УстановитьПараметр("ИсходноеЗадание", 	 	СсылкаНаДок);
	Запрос.УстановитьПараметр("ШтрихКод", 			 	ШК);
	Запрос.УстановитьПараметр("ШтрихКод2", 			 	ШК2);
	Запрос.УстановитьПараметр("НесколькоДокументов", 	МножествоДокументовКакЗадание);
	Запрос.УстановитьПараметр("Документы", 		 		СсылкаНаДок.Задания.ВыгрузитьКолонку("Задание"));
	Запрос.УстановитьПараметр("ВесовойШтрихКод", 	 	ВесовойШК);
	Запрос.УстановитьПараметр("ВсеУпаковки", 		 	Истина);
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");		
	Если ЗначениеЗаполнено(ТекущийСклад) Тогда		
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(ТекущийСклад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады",			СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады",		СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(ТекущееПомещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(ТекущееПомещение);			
	КонецЕсли;	
	Запрос.УстановитьПараметр("Помещения",			 СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", 		 СписокПомещений.Количество() = 0);
	
	Запрос.УстановитьПараметр("ВключатьАртикул",     ВключатьАртикул);
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());   
	
	Тип_Услуга = Перечисления.ТипыНоменклатуры.Услуга;
	
	Рез = Запрос.Выполнить().Выгрузить();
	Для каждого СтрокаДока Из Рез Цикл
		
		СтрокаДока.Коэффициент = ?(СтрокаДока.Коэффициент = 0, 1, СтрокаДока.Коэффициент);
		СтрокаДока.НаименованиеУпаковки = ?(ЗначениеЗаполнено(СтрокаДока.НаименованиеУпаковки), СтрокаДока.НаименованиеУпаковки, "шт.");
		
		// Табачные изделия, штрихкод товара на все характеристики
		ЕстьХарактеристикиБезШтрихкодов = Ложь;
		ТипПродукции = ДатаМобайл_Маркировка.ПолучитьТипМаркированнойПродукции(СтрокаДока.Номенклатура);
		Если Не СтрокаДока.ЭтоНовыйТовар И УзелПО.ВыводитьВсеХарактеристикиПоШтрихкоду Тогда
			
			ЗапросВсехХарактеристик = Новый Запрос();				
			ЗапросВсехХарактеристик.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
			|	ХарактеристикиНоменклатуры.Ссылка,
			|	ХарактеристикиНоменклатуры.Наименование,
			|	ХарактеристикиНоменклатуры.Владелец,
			|	ХарактеристикиНоменклатуры.Владелец КАК Номенклатура, 
			|	ХарактеристикиНоменклатуры.Наименование КАК НаименованиеНоменклатуры,
			|	ХарактеристикиНоменклатуры.Ссылка КАК Характеристика,
			|	ХарактеристикиНоменклатуры.Владелец.ВесМожноУказыватьВДокументах КАК Весовой,
			|	ХарактеристикиНоменклатуры.Владелец.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,   
			|	ХарактеристикиНоменклатуры.Владелец.ВладелецХарактеристик КАК ВладелецХарактеристик,
			|	ХарактеристикиНоменклатуры.Владелец.АлкогольнаяПродукция КАК АлкогольнаяПродукция,  
			|	ХарактеристикиНоменклатуры.Владелец.ВидНоменклатуры КАК ВидНоменклатуры, 
			|	ХарактеристикиНоменклатуры.Владелец.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
			|	ХарактеристикиНоменклатуры.Наименование КАК НаименованиеХарактеристики	
			|ИЗ
			|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
			|ГДЕ
			|	ХарактеристикиНоменклатуры.Владелец = &Владелец
			|	И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления";
			
			Если СтрокаДока.ИспользованиеХарактеристик = Перечисления.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры Тогда
				ЗапросВсехХарактеристик.УстановитьПараметр("Владелец", СтрокаДока.Номенклатура);
			ИначеЕсли СтрокаДока.ИспользованиеХарактеристик = Перечисления.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры Тогда
				ЗапросВсехХарактеристик.УстановитьПараметр("Владелец", СтрокаДока.ВидНоменклатуры);
			ИначеЕсли СтрокаДока.ИспользованиеХарактеристик = Перечисления.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры Тогда
				ЗапросВсехХарактеристик.УстановитьПараметр("Владелец", СтрокаДока.ВладелецХарактеристик);
			Иначе
				ЗапросВсехХарактеристик.УстановитьПараметр("Владелец", Неопределено);
			КонецЕсли;
			ЗапросВсехХарактеристик.УстановитьПараметр("ИсходноеЗадание", СсылкаНаДок);
			ЗапросВсехХарактеристик.УстановитьПараметр("Номенклатура", СсылкаНаДок); 
			ЗапросВсехХарактеристик.УстановитьПараметр("Склады", СписокСкладов);
			ЗапросВсехХарактеристик.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
			
			ВыборкаХарактеристик = ЗапросВсехХарактеристик.Выполнить().Выбрать();
			Пока ВыборкаХарактеристик.Следующий() Цикл	
				ЕстьХарактеристикиБезШтрихкодов = Истина;
								
				СтруктураТекущейСтроки = Новый Структура;
				
				ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan");
				ОбъектТовара.name = ЧистаяСтрока(СокрП(СтрокаДока.НаименованиеНоменклатуры) + " " + СокрП(ВыборкаХарактеристик.Наименование));			
				ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(ВыборкаХарактеристик.Ссылка);
				ОбъектТовара.price = СтрокаДока.Цена;
				
				// Выгрузка дополнительных видов цен
				ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрокаДока.Номенклатура, ВыборкаХарактеристик.Ссылка);
				
				Попытка	             
					DMUseSN = ПолучитьПризнакУчетаСерий(СтрокаДока.ВидНоменклатуры, ТекущийСклад);
				Исключение
					DMUseSN = Ложь;
				КонецПопытки;	   
				
				СформироватьЗаголовкиJSONParamsТовара(УзелПО,ОбъектТовара, СтрокаДока,DMUseSN,Шаблон); 
				
				СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
				
				Попытка
					ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");
					ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура);
					СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
				Исключение
				Конецпопытки;
				
				Попытка
					ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
				Исключение
					ДопускВесовогоТовара = Неопределено;
				КонецПопытки;
				
				Если ДопускВесовогоТовара <> Неопределено Тогда
					СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
				КонецЕсли;
				
				Попытка
					ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
				Исключение
					ДопускОСГ = Неопределено;
				КонецПопытки;
				
				Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
					СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
				КонецЕсли;
				
				ЭтоУслуга = Ложь;
				Попытка       
					Если СтрокаДока.ВидНоменклатурыТипНоменклатуры = Тип_Услуга Тогда
						ЭтоУслуга = Истина;
					КонецЕсли;
				Исключение
				КонецПопытки;
				
				limit_qty = 0;
				Если УзелПО.НеОтображатьОстатки Тогда
					limit_qty = 0;
				ИначеЕсли ЭтоУслуга Тогда
					limit_qty = 999;	
				Иначе					 				 
					limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, ВыборкаХарактеристик.Ссылка, ТекущаяЯчейкаСсылка, СтрокаДока.Упаковка);
					
					Если ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
						limit_qty = limit_qty + ПолучитьЗадание(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, ВыборкаХарактеристик.Ссылка, ТекущаяЯчейкаСсылка, СтрокаДока.Упаковка, "Insert");		 
					КонецЕсли;	
				КонецЕсли;
				СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
				
				Если СокрЛП(ЧистаяСтрока(ОбъектТовара.name)) = "" Или СокрЛП(ЧистаяСтрока(ОбъектТовара.id)) = "" Тогда
					Продолжить;
				КонецЕсли;
				
				ОбъектСписка.Добавить(СтруктураТекущейСтроки);
				
			КонецЦикла;		
		КонецЕсли;
		
		// Остальные товары 
		Если Не ЕстьХарактеристикиБезШтрихкодов Тогда
			
			СтруктураТекущейСтроки = Новый Структура;
			
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan");
			ОбъектТовара.name = ЧистаяСтрока(СокрП(СтрокаДока.НаименованиеТовара));	
			ОбъектТовара.id = ?(СтрокаДока.ЭтоНовыйТовар, "8n-" + XMLСтрока(СтрокаДока.Номенклатура), "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика));
			ОбъектТовара.price = СтрокаДока.Цена;
			
			// Выгрузка дополнительных видов цен
			ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Характеристика);
			
			Попытка	                                          
				DMUseSN = ПолучитьПризнакУчетаСерий(СтрокаДока.ВидНоменклатуры, ТекущийСклад);
			Исключение
				DMUseSN = Ложь;
			КонецПопытки;
			
			СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, СтрокаДока, DMUseSN,Шаблон);
			
			СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
			
			Попытка
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");
				ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура);
				СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
			Исключение
			Конецпопытки;
			
			Попытка
				ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
			Исключение
				ДопускВесовогоТовара = Неопределено;
			КонецПопытки;
			
			Если ДопускВесовогоТовара <> Неопределено Тогда
				СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
			КонецЕсли;
			
			Попытка
				ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
			Исключение
				ДопускОСГ = Неопределено;
			КонецПопытки;
			
			Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
				СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
			КонецЕсли;
			
			ЭтоУслуга = Ложь;
			Попытка  
				Если СтрокаДока.ВидНоменклатурыТипНоменклатуры = Тип_Услуга Тогда
					ЭтоУслуга = Истина;
				КонецЕсли;
			Исключение
			КонецПопытки;	
			
			limit_qty = 0;
			Если УзелПО.НеОтображатьОстатки Тогда
				limit_qty = 0;
			ИначеЕсли ЭтоУслуга Тогда
				limit_qty = 999;
			Иначе					 
				limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, СтрокаДока.Характеристика, ТекущаяЯчейкаСсылка, СтрокаДока.Упаковка);
				
				Если ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
					limit_qty = limit_qty + ПолучитьЗадание(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, СтрокаДока.Характеристика, ТекущаяЯчейкаСсылка, СтрокаДока.Упаковка, "Insert");		 
				КонецЕсли;	
			КонецЕсли;
			
			СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
			
			Если СокрЛП(ЧистаяСтрока(ОбъектТовара.name)) = "" Или СокрЛП(ЧистаяСтрока(ОбъектТовара.id)) = "" Тогда
				Продолжить;
			КонецЕсли;			
			
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);
			
		КонецЕсли;
	КонецЦикла;
		
	//ЗАПИСЬ	
	Если Не ГрупповаяРабота Тогда
		//ОБЫЧНАЯ ЛОГИКА
		Если Не ЗначениеЗаполнено(ДокДатаНачалаСбора) Или Не ЗначениеЗаполнено(ДокТСД) Тогда
			
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора = ТекущаяДата();
				Объект.ТСД = УзелПО;
				
				Объект.Записать();
				
				//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
				ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
			Исключение
			КонецПопытки;
		КонецЕсли;
		
	Иначе
		//ГРУППОВОЙ ДОКУМЕНТ
		
		ДатаСбораПоТСД = ДатаМобайл_ОбщийМодуль.ПолучитьДатуГрупповогоДокумента(SN, СсылкаНаДок, "ДатаНачалаСбора");	
		Если Не ЗначениеЗаполнено(ДатаСбораПоТСД) Тогда	
			ДатаМобайл_ОбщийМодуль.СоздатьНачальнуюЗаписьТСДГрупповыхДокументов(SN, СсылкаНаДок, UserName);		
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(ДокДатаНачалаСбора) Тогда
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора = ТекущаяДата();
				
				Объект.Записать();
			Исключение
			КонецПопытки;	
		КонецЕсли;
	КонецЕсли;	
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Идентификация и получение объекта марки при сканировании в подборе.
//
// Параметры:    
// Params - Структура - Структура данных из ПО.
// kiz - Структура - Структура данных КИЗов.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция OnArtMarkScanSelect(Params, kiz) Экспорт
	
	Возврат OnArtMarkScan(Params, kiz, "Select");
	
КонецФункции

// Идентификация и получение объекта марки при сканировании в приемке.
//
// Параметры:    
// Params - Структура - Структура данных из ПО.
// kiz - Структура - Структура данных КИЗов.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция OnArtMarkScanInsert(Params, kiz) Экспорт
	
	Возврат OnArtMarkScan(Params, kiz, "Insert");
	
КонецФункции

// Получение списка товаров документа.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа ТСД.
// НомерПакета - Строка - номер пакета обмена.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetDocArts(SN, UserName, DocOutID, НомерПакета = "") Экспорт 
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
		Возврат GetDocArts_КТ2000(SN, UserName, DocOutID, НомерПакета);
	КонецЕсли;  
	
	ОбъектСписка = Новый Массив();		
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;  
	
	ВыгружатьТоварыДокументаБезШтрихкодов = УзелПО.ВыгружатьТоварыДокументаБезШтрихкодов; 
	
	Если Не НомерПакета = "" Тогда
		ПакетнаяВыгрузка = Истина; 
		НомерПакета = Число(НомерПакета);
		КоличествоТоваровВПорции = УзелПО.КоличествоТоваровВПорции;
		Если Не ЗначениеЗаполнено(КоличествоТоваровВПорции) Тогда
			КоличествоТоваровВПорции = 1000;
		КонецЕсли;	
	Иначе
		ПакетнаяВыгрузка = Ложь;
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));                                                                                          
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда		
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	  
	
	Шаблон = СсылкаНаДок.Шаблон;
	ИсходныйДокумент = СсылкаНаДок.ИсходныйДокумент;
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	РеквизитыШаблона = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ВидДокумента,ИмяТабличнойЧастиПодбор,ИмяТабличнойЧастиПриемка,
	|РаспределениеТоваров,ИспользоватьПодбор,ИспользоватьПриемку,ЕГАИС,ИспользоватьМаркировку,
	|ИспользованиеЯчеекПодбор,ИспользованиеЯчеекПриемка,УчитыватьСерийниковВЗаданииПодбор,СерииВОтдельнойТЧ");
	
	ВидДокумента 									= РеквизитыШаблона.ВидДокумента;
	ИмяТабличнойЧастиПодбор 						= РеквизитыШаблона.ИмяТабличнойЧастиПодбор;
	ИмяТабличнойЧастиПриемка 						= РеквизитыШаблона.ИмяТабличнойЧастиПриемка;
	МножествоДокументовКакЗадание 					= РеквизитыШаблона.РаспределениеТоваров = 1;
	ИспользоватьПодбор								= РеквизитыШаблона.ИспользоватьПодбор;
	ИспользоватьПриемку								= РеквизитыШаблона.ИспользоватьПриемку;
	ГрупповойДокумент								= РеквизитыШаблона.РаспределениеТоваров = 2;
	ЕГАИС											= РеквизитыШаблона.ЕГАИС;
	ИспользоватьМаркировку							= РеквизитыШаблона.ИспользоватьМаркировку;
	ИспользованиеЯчеекПодбор                      	= РеквизитыШаблона.ИспользованиеЯчеекПодбор;
	ИспользованиеЯчеекПриемка                      	= РеквизитыШаблона.ИспользованиеЯчеекПриемка;
	УчитыватьСерийниковВЗаданииПодбор              	= РеквизитыШаблона.УчитыватьСерийниковВЗаданииПодбор;
	СерииВОтдельнойТЧ                      			= РеквизитыШаблона.СерииВОтдельнойТЧ;
	
	Если ВидДокумента = "ЗаданиеНаПеревозку" Тогда	
		ВидДокумента = "ЗаказКлиента";
		ИмяТабличнойЧастиПодбор = "Товары";
		ИмяТабличнойЧастиПриемка = "Товары";	
	КонецЕсли;
	
	Если Не ПакетнаяВыгрузка Или (ПакетнаяВыгрузка И НомерПакета = 1) Тогда	
				
		Если ЕГАИС Тогда
			
			Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	СоответствиеНоменклатурыЕГАИС.Номенклатура КАК Ссылка
			|ИЗ
			|	Документ.ТТНВходящаяЕГАИС.Товары КАК Документ1С
			|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеНоменклатурыЕГАИС КАК СоответствиеНоменклатурыЕГАИС
			| 		ПО СоответствиеНоменклатурыЕГАИС.АлкогольнаяПродукция = Документ1С.АлкогольнаяПродукция 						
			|ГДЕ
			|	Документ1С.Ссылка = &Ссылка");
			
			Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТТНВходящаяЕГАИС.","." + ВидДокумента + ".");
			Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК ","." + ИмяТабличнойЧастиПодбор + " КАК ");
			
			Если ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда
				ДатаМобайл_ОбщийМодуль.астЗаменитьРегистрНоменклатурыЕГАИС(Запрос.Текст);
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "Документ1С.АлкогольнаяПродукция", "Документ1С.НоменклатураЕГАИС");
			КонецЕсли;
			
		Иначе
			
			Если ВидДокумента = "СборкаТоваров" Или ВидДокумента = "ЗаказНаСборку" Тогда
				Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	Документ1С.Номенклатура КАК Ссылка,
				|	Документ1С.Характеристика КАК СсылкаХарактеристика
				|ИЗ
				|	Документ.СборкаТоваров.Товары КАК Документ1С
				|ГДЕ
				|	Документ1С.Ссылка = &Ссылка
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	Документ1С.Номенклатура,
				|	Документ1С.Характеристика
				|ИЗ
				|	Документ.СборкаТоваров.Товары КАК Документ1С
				|ГДЕ
				|	Документ1С.Ссылка = &Ссылка
				|
				|ОБЪЕДИНИТЬ ВСЕ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	Документ1С.Номенклатура,
				|	Документ1С.Характеристика
				|ИЗ
				|	Документ.СборкаТоваров КАК Документ1С
				|ГДЕ
				|	Документ1С.Ссылка = &Ссылка");
				
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "СборкаТоваров", ВидДокумента);			 
			Иначе
				
				Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
				 |	Документ1С.Номенклатура КАК Ссылка,
				 |	Документ1С.Характеристика КАК СсылкаХарактеристика 
				 |ПОМЕСТИТЬ ВТ_Товары
				 |ИЗ
				 |	Документ.ОтборРазмещениеТоваров.ТоварыОтбор КАК Документ1С					
				 |ГДЕ
				 |	Документ1С.Ссылка = &Ссылка
				 |
				 |ОБЪЕДИНИТЬ ВСЕ
				 |
				 |ВЫБРАТЬ РАЗЛИЧНЫЕ
				 |	Документ1С.Номенклатура,
				 |	Документ1С.Характеристика
				 |ИЗ
				 |	Документ.ОтборРазмещениеТоваров.ТоварыРазмещение КАК Документ1С
				 |ГДЕ
				 |	Документ1С.Ссылка = &Ссылка
				 |;
				 |
				 |////////////////////////////////////////////////////////////////////////////////
				 |ВЫБРАТЬ
				 |	ВариантыКомплектацииНоменклатурыТовары.Номенклатура КАК Номенклатура,
				 |	ВариантыКомплектацииНоменклатурыТовары.Характеристика КАК СсылкаХарактеристика
				 |ПОМЕСТИТЬ ВТ_ТоварыИКомплекты
				 |ИЗ
				 |	Справочник.ВариантыКомплектацииНоменклатуры.Товары КАК ВариантыКомплектацииНоменклатурыТовары
				 |ГДЕ
				 |	ВариантыКомплектацииНоменклатурыТовары.Ссылка.Владелец В
				 |			(ВЫБРАТЬ
				 |				ВТ_Товары.Ссылка КАК Ссылка
				 |			ИЗ
				 |				ВТ_Товары КАК ВТ_Товары)
				 |	И ВариантыКомплектацииНоменклатурыТовары.Ссылка.Характеристика В
				 |			(ВЫБРАТЬ
				 |				ВТ_Товары.СсылкаХарактеристика КАК СсылкаХарактеристика
				 |			ИЗ
				 |				ВТ_Товары КАК ВТ_Товары)
				 |
				 |ОБЪЕДИНИТЬ ВСЕ
				 |
				 |ВЫБРАТЬ
				 |	ВТ_Товары.Ссылка,
				 |	ВТ_Товары.СсылкаХарактеристика
				 |ИЗ
				 |	ВТ_Товары КАК ВТ_Товары
				 |;
				 |
				 |////////////////////////////////////////////////////////////////////////////////
				 |ВЫБРАТЬ
				 |	ВТ_ТоварыИКомплекты.Номенклатура КАК Ссылка,
				 |	ВТ_ТоварыИКомплекты.СсылкаХарактеристика КАК СсылкаХарактеристика
				 |ИЗ
				 |	ВТ_ТоварыИКомплекты КАК ВТ_ТоварыИКомплекты
				 |
				 |СГРУППИРОВАТЬ ПО
				 |	ВТ_ТоварыИКомплекты.Номенклатура,
				 |	ВТ_ТоварыИКомплекты.СсылкаХарактеристика");
				
			КонецЕсли;
			
			Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ОтборРазмещениеТоваров.", "." + ВидДокумента + ".");
			Если ИспользоватьПодбор Тогда
				Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыОтбор КАК ", "." + ИмяТабличнойЧастиПодбор + " КАК ");
			Иначе
				Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыОтбор КАК ", "." + ИмяТабличнойЧастиПриемка + " КАК ");
			КонецЕсли;	
			
			Если ВидДокумента = "УведомлениеОПриемкеМДЛП" Или ВидДокумента = "УведомлениеОПриемкеМДЛП" Тогда
				Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыРазмещение КАК ", "." + "СоставТранспортныхУпаковок" + " КАК ");	
			КонецЕсли;
			
			Если ИспользоватьПриемку Тогда
				Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыРазмещение КАК ", "." + ИмяТабличнойЧастиПриемка + " КАК ");
			Иначе
				Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыРазмещение КАК ", "." + ИмяТабличнойЧастиПодбор + " КАК ");
			КонецЕсли;
			
			Если МножествоДокументовКакЗадание Тогда
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "Документ1С.Ссылка = &Ссылка", "Документ1С.Ссылка В(&Документы)");
			КонецЕсли;
			
			Если ВидДокумента = "УстановкаЦенНоменклатуры" Тогда
				СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "GetDocArts");	
			КонецЕсли;
			
		КонецЕсли;
		
		Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок.ИсходныйДокумент);	
		Запрос.УстановитьПараметр("Документы", СсылкаНаДок.Задания.ВыгрузитьКолонку("Задание"));	
		
		Если ЕГАИС Тогда
			МассивХарактеристик = Неопределено;
		Иначе 
			Если ВидДокумента = "УстановкаЦенНоменклатуры" Тогда
				МассивХарактеристикЦО = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("СсылкаХарактеристика");
				МассивХарактеристик = ПолучитьХарактеристикиИзХарактеристикаНоменклатурыДляЦенообразования(МассивХарактеристикЦО);
			Иначе	 
				МассивХарактеристик = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("СсылкаХарактеристика");
			КонецЕсли; 
		КонецЕсли;
		
		МассивКВыгрузке = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");    
		
		Если ПакетнаяВыгрузка Тогда
			
			МассивКВыгрузкеУникальные = Новый Массив;
			Для каждого Строка Из МассивКВыгрузке Цикл
				Если МассивКВыгрузкеУникальные.Найти(Строка) = Неопределено Тогда
					МассивКВыгрузкеУникальные.Добавить(Строка); 					
				КонецЕсли; 
			КонецЦикла; 
			
			МассивКВыгрузке_Пакет = Новый Массив;
			МассивХарактеристик_Пакет = Новый Массив;
			МассивДанныхКВыгрузке_Пакет = Новый Массив;
			
			Счетчик = 1;
			
			//зарегистрируем для выгрузки номенклатуру и характеристики:
			Для каждого ЭлементМассива Из МассивКВыгрузкеУникальные Цикл
				
				Если Не ЗначениеЗаполнено(ЭлементМассива) Тогда
					Продолжить;
				КонецЕсли;	 
				
				Если Счетчик <= КоличествоТоваровВПорции Тогда
					МассивКВыгрузке_Пакет.Добавить(ЭлементМассива);
					МассивДанныхКВыгрузке_Пакет.Добавить(ЭлементМассива);
					ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, ЭлементМассива);
				Иначе
					ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, ЭлементМассива);
				КонецЕсли;			
				
				Счетчик = Счетчик + 1;
			КонецЦикла; 
						
			Если Не МассивХарактеристик = Неопределено Тогда 			
								
				Для каждого ЭлементМассива Из МассивХарактеристик Цикл
					
					Если ЗначениеЗаполнено(ЭлементМассива) Тогда
						
						МассивХарактеристик_Пакет.Добавить(ЭлементМассива);
						МассивДанныхКВыгрузке_Пакет.Добавить(ЭлементМассива);
						ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, ЭлементМассива);
						
						Счетчик = Счетчик + 1;
						
					КонецЕсли;
					
				КонецЦикла;  			 
				
			Иначе	
				
				МассивХарактеристик_Пакет = Неопределено;
				
			КонецЕсли;	
			
			ПланыОбмена.ВыбратьИзменения(УзелПО, НомерПакета, МассивДанныхКВыгрузке_Пакет);			
			
			Если МассивКВыгрузке_Пакет.Количество() > 0 Тогда
				ОбъектСписка = СобратьТовары(МассивКВыгрузке_Пакет, УзелПО, МассивХарактеристик_Пакет, Шаблон, Истина, ВыгружатьТоварыДокументаБезШтрихкодов, ИсходныйДокумент);	
			Иначе
				СтруктураОтвета = Новый Структура;
				СтруктураОтвета.Вставить("is_finished", Истина);		
				СтруктураОтвета.Вставить("data", ОбъектСписка);  				
				Возврат ПодготовитьОтветJSON(СтруктураОтвета); 		
			КонецЕсли;	
		Иначе	
			Если МассивКВыгрузке.Количество() > 0 Тогда
				ОбъектСписка = СобратьТовары(МассивКВыгрузке, УзелПО, МассивХарактеристик, Шаблон,, ВыгружатьТоварыДокументаБезШтрихкодов, ИсходныйДокумент);
			КонецЕсли;
		КонецЕсли;
	Иначе
		
		//1. удаляем данные предыдущего пакета:  	
		Попытка ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, НомерПакета - 1); Исключение КонецПопытки;	
		//2. регистрируем данные нового пакета:
		
		МассивКВыгрузке = ПолучитьПорциюТоваров(УзелПО, КоличествоТоваровВПорции);
		
		Если МассивКВыгрузке.Количество() Тогда      					
			
			ПланыОбмена.ВыбратьИзменения(УзелПО, НомерПакета, МассивКВыгрузке);	
			
			Если МассивКВыгрузке.Количество() Тогда	
				Запрос = Новый Запрос;
				Запрос.Текст = 
				"ВЫБРАТЬ
				|	ХарактеристикиНоменклатурыИзменения.Ссылка КАК ХарактеристикаНоменклатуры
				|ИЗ
				|	Справочник.ХарактеристикиНоменклатуры.Изменения КАК ХарактеристикиНоменклатурыИзменения
				|ГДЕ
				|	ХарактеристикиНоменклатурыИзменения.Узел = &Узел
				|	И ЕСТЬNULL(ХарактеристикиНоменклатурыИзменения.НомерСообщения, ИСТИНА) = ИСТИНА
				|	И ХарактеристикиНоменклатурыИзменения.Ссылка.Владелец В(&МассивКВыгрузке)";
				Запрос.УстановитьПараметр("Узел", УзелПО);
				Запрос.УстановитьПараметр("НомерСообщения", 0);
				Запрос.УстановитьПараметр("МассивКВыгрузке", МассивКВыгрузке);
				РезультатЗапроса = Запрос.Выполнить();
				Если Не РезультатЗапроса.Пустой() Тогда      					
					МассивХарактеристик = РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("ХарактеристикаНоменклатуры");	
					ПланыОбмена.ВыбратьИзменения(УзелПО, НомерПакета, МассивХарактеристик);					
				КонецЕсли; 			
			Иначе
				МассивХарактеристик = Неопределено;
			КонецЕсли;
			
			ОбъектСписка = СобратьТовары(МассивКВыгрузке, УзелПО, МассивХарактеристик, Шаблон, Истина, ВыгружатьТоварыДокументаБезШтрихкодов, ИсходныйДокумент);
			
		КонецЕсли;	
		
	КонецЕсли;	
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение списка товаров.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// НомерПакета - Строка - номер пакета обмена.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetNewArts(SN, UserName, НомерПакета = "") Экспорт
	
	ОбъектСписка = Новый Массив();  
	
	УзелПО = НайтиУзел(SN); 
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;   
	
	Если Не НомерПакета = "" Тогда
		
		ПакетнаяВыгрузка = Истина; 
		НомерПакета = Число(НомерПакета);
		КоличествоТоваровВПорции = УзелПО.КоличествоТоваровВПорции;
		
		Если Не ЗначениеЗаполнено(КоличествоТоваровВПорции) Тогда
			КоличествоТоваровВПорции = 1000;
		КонецЕсли;	
		
	Иначе
		ПакетнаяВыгрузка = Ложь;
	КонецЕсли;    
	
	Если ПакетнаяВыгрузка <> УзелПО.ИспользоватьПорционнуюВыгрузку Тогда
		
		СтруктураОтвета = Новый Структура;
		СтруктураОтвета.Вставить("Описание", 
		
		"Невозможно загрузить товары." + Символы.ПС + 
		"Проверьте, что в настройках приложения включен параметр ""Порционная загрузка""." + Символы.ПС + 
		"Проверьте, что в ""АРМ Диспетчера"" в настройках устройства во вкладке ""Товары"" включена порционная выгрузка.)");	
		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		
	КонецЕсли;	
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьТовары") Тогда
		
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьТовары", Ложь);		
		
		Если ПакетнаяВыгрузка Тогда     
			
			МассивКВыгрузке = ПолучитьПорциюТоваров(УзелПО, КоличествоТоваровВПорции, НомерПакета);
			
			Если МассивКВыгрузке.Количество() Тогда				
				
				ОбъектСписка = СобратьТовары(МассивКВыгрузке, УзелПО,,, ПакетнаяВыгрузка); 			
				Возврат ПодготовитьОтветJSON(ОбъектСписка); 	
				
			Иначе				
				
				СтруктураОтвета = Новый Структура;
				СтруктураОтвета.Вставить("is_finished", Истина);
				СтруктураОтвета.Вставить("data", ОбъектСписка);
				
				Возврат ПодготовитьОтветJSON(СтруктураОтвета); 	
				
			КонецЕсли;	
			
		Иначе	
			
			ОбъектСписка = СобратьТовары(ОбъектСписка, УзелПО); 
			
		КонецЕсли; 
		
	Иначе
		
		Если Не ПакетнаяВыгрузка Тогда
			
			Попытка
				ПланыОбмена.ВыбратьИзменения(УзелПО, 1, Метаданные.Справочники.Номенклатура);
				ПланыОбмена.ВыбратьИзменения(УзелПО, 1, Метаданные.Справочники.ХарактеристикиНоменклатуры);
				ПланыОбмена.ВыбратьИзменения(УзелПО, 1, Метаданные.РегистрыСведений.ШтрихкодыНоменклатуры);
				ПланыОбмена.ВыбратьИзменения(УзелПО, 1, Метаданные.Справочники.ДатаМобайл_НовыеТовары);
				ПланыОбмена.ВыбратьИзменения(УзелПО, 1, Метаданные.РегистрыСведений.ДатаМобайл_НовыеШтрихкоды);
				ПланыОбмена.ВыбратьИзменения(УзелПО, 1, Метаданные.Справочники.Скидки);
			Исключение
			КонецПопытки;
			
			Запрос = Новый Запрос("
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	НоменклатураИзменения.Ссылка КАК Ссылка
			|ПОМЕСТИТЬ ИзменившиесяТовары
			|ИЗ
			|	Справочник.Номенклатура.Изменения КАК НоменклатураИзменения
			|ГДЕ
			|	НоменклатураИзменения.Узел = &Узел
			|	И НЕ НоменклатураИзменения.НомерСообщения ЕСТЬ NULL
			|	И НЕ ЕСТЬNULL(НоменклатураИзменения.Ссылка.ЭтоГруппа, ИСТИНА)
			|	
			|ОБЪЕДИНИТЬ
			|	
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	Номенклатура.Ссылка
			|ИЗ
			|	Справочник.ХарактеристикиНоменклатуры.Изменения КАК ХарактеристикиНоменклатурыИзменения
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Номенклатура
			|		ПО (ВЫБОР
			|				КОГДА Номенклатура.ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры)
			|					ТОГДА ХарактеристикиНоменклатурыИзменения.Ссылка.Владелец = Номенклатура.Ссылка
			|				КОГДА Номенклатура.ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры)
			|					ТОГДА ХарактеристикиНоменклатурыИзменения.Ссылка.Владелец = Номенклатура.ВидНоменклатуры
			|				КОГДА Номенклатура.ВидНоменклатуры.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры)
			|					ТОГДА ХарактеристикиНоменклатурыИзменения.Ссылка.Владелец = Номенклатура.ВладелецХарактеристик
			|				ИНАЧЕ ЛОЖЬ
			|			КОНЕЦ)
			|ГДЕ
			|	ХарактеристикиНоменклатурыИзменения.Узел = &Узел
			|	И НЕ ХарактеристикиНоменклатурыИзменения.НомерСообщения ЕСТЬ NULL
			|	
			|ОБЪЕДИНИТЬ
			|
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	Номенклатура.Ссылка
			|ИЗ
			|	Справочник.УпаковкиЕдиницыИзмерения.Изменения КАК УпаковкиНоменклатурыИзменения
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК Номенклатура
			|		ПО (УпаковкиНоменклатурыИзменения.Ссылка.Владелец = Номенклатура.Ссылка
			|				ИЛИ УпаковкиНоменклатурыИзменения.Ссылка.Владелец = Номенклатура.ВидНоменклатуры)
			|ГДЕ
			|	УпаковкиНоменклатурыИзменения.Узел = &Узел
			|	И НЕ УпаковкиНоменклатурыИзменения.НомерСообщения ЕСТЬ NULL
			|
			|ОБЪЕДИНИТЬ
			|
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ШтрихкодыНоменклатуры.Номенклатура
			|ИЗ
			|	РегистрСведений.ШтрихкодыНоменклатуры.Изменения КАК ШтрихкодыНоменклатурыИзменения
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
			|		ПО ШтрихкодыНоменклатурыИзменения.Штрихкод = ШтрихкодыНоменклатуры.Штрихкод
			|ГДЕ
			|	ШтрихкодыНоменклатурыИзменения.Узел = &Узел
			|	И НЕ ШтрихкодыНоменклатурыИзменения.НомерСообщения ЕСТЬ NULL
			|	
			|ОБЪЕДИНИТЬ
			|	
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ДатаМобайл_НовыеШтрихкоды.Номенклатура
			|ИЗ
			|	РегистрСведений.ДатаМобайл_НовыеШтрихкоды.Изменения КАК ДатаМобайл_НовыеШтрихкодыИзменения
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДатаМобайл_НовыеШтрихкоды КАК ДатаМобайл_НовыеШтрихкоды
			|		ПО ДатаМобайл_НовыеШтрихкодыИзменения.ШтрихКод = ДатаМобайл_НовыеШтрихкоды.ШтрихКод
			|ГДЕ
			|	ДатаМобайл_НовыеШтрихкодыИзменения.Узел = &Узел
			|	И НЕ ДатаМобайл_НовыеШтрихкодыИзменения.НомерСообщения ЕСТЬ NULL
			|	
			|ОБЪЕДИНИТЬ
			|	
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ДатаМобайл_НовыеТоварыИзменения.Ссылка
			|ИЗ
			|	Справочник.ДатаМобайл_НовыеТовары.Изменения КАК ДатаМобайл_НовыеТоварыИзменения
			|ГДЕ
			|	ДатаМобайл_НовыеТоварыИзменения.Узел = &Узел
			|	И НЕ ДатаМобайл_НовыеТоварыИзменения.НомерСообщения ЕСТЬ NULL 
			|;
            |
			|////////////////////////////////////////////////////////////////////////////////			
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ИзменившиесяТовары.Ссылка КАК Ссылка
			|
			|ИЗ
			|	ИзменившиесяТовары КАК ИзменившиесяТовары
			|ГДЕ
			|	(НЕ ИзменившиесяТовары.Ссылка ССЫЛКА Справочник.Номенклатура
			|			ИЛИ ИзменившиесяТовары.Ссылка В ИЕРАРХИИ (&СписокТоваров)
			|			ИЛИ &ВсеТовары)");
			
			Запрос.УстановитьПараметр("Узел", УзелПО);
			Запрос.УстановитьПараметр("СписокТоваров", УзелПО.ДоступныеГруппыТоваров.ВыгрузитьКолонку("Номенклатура"));
			Запрос.УстановитьПараметр("ВсеТовары", УзелПО.ДоступныеГруппыТоваров.Количество() = 0);
			
			МассивКВыгрузке = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
			
			Если МассивКВыгрузке.Количество() Тогда
				ОбъектСписка = СобратьТовары(МассивКВыгрузке, УзелПО,,, ПакетнаяВыгрузка);
			КонецЕсли;	
			
			Попытка	
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.Номенклатура);
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.ХарактеристикиНоменклатуры);
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.УпаковкиЕдиницыИзмерения);
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.РегистрыСведений.ШтрихкодыНоменклатуры);
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.РегистрыСведений.ДатаМобайл_НовыеШтрихкоды);
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.ДатаМобайл_НовыеТовары);
			Исключение
			КонецПопытки;
			
		Иначе
			
			// регистрируем данные нового пакета:
			МассивКВыгрузке = ПолучитьПорциюТоваров(УзелПО, КоличествоТоваровВПорции, НомерПакета);
			
			Если МассивКВыгрузке.Количество() = 0 И НомерПакета = 1 Тогда
				
				НаборЗаписейПодвисшихПакетов = РегистрыСведений.ДатаМобайл_ПорционнаяВыгрузка.СоздатьНаборЗаписей();
				НаборЗаписейПодвисшихПакетов.Отбор.ТСД.Установить(УзелПО);
				НаборЗаписейПодвисшихПакетов.Прочитать();
				
				Если НаборЗаписейПодвисшихПакетов.Количество() Тогда
					
					РегистрыСведений.ДатаМобайл_ПорционнаяВыгрузка.ПеререгистрацияПодвисшихПакетовПодВыгрузку(УзелПО);	
					МассивКВыгрузке = ПолучитьПорциюТоваров(УзелПО, КоличествоТоваровВПорции, НомерПакета);
					
				Иначе
					
					Запрос = Новый Запрос;
					Запрос.Текст = 
					"ВЫБРАТЬ
					|	ШтрихкодыНоменклатурыИзменения.Узел КАК Узел,
					|	ШтрихкодыНоменклатурыИзменения.Штрихкод КАК Штрихкод
					|ПОМЕСТИТЬ ИзмененияШтрихкоды
					|ИЗ
					|	РегистрСведений.ШтрихкодыНоменклатуры.Изменения КАК ШтрихкодыНоменклатурыИзменения
					|ГДЕ
					|	ШтрихкодыНоменклатурыИзменения.Узел = &Узел
					|;
					|
					|////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура
					|ПОМЕСТИТЬ НоменклатураПоШтрихкодам
					|ИЗ
					|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
					|ГДЕ
					|	ШтрихкодыНоменклатуры.Штрихкод В(ВЫБРАТЬ ИзмененияШтрихкоды.Штрихкод ИЗ ИзмененияШтрихкоды КАК ИзмененияШтрихкоды)
					|;
					|
					|////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ
					|	НоменклатураИзменения.Ссылка КАК Ссылка
					|ПОМЕСТИТЬ ИзмененияНоменклатуры
					|ИЗ
					|	Справочник.Номенклатура.Изменения КАК НоменклатураИзменения
					|ГДЕ
					|	НоменклатураИзменения.Узел = &Узел
					|; 
					|
					|////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ 
					|	НоменклатураПоШтрихкодам.Номенклатура КАК Номенклатура
					|ПОМЕСТИТЬ ТекущиеИзмененияНоменклатуры
					|ИЗ
					|	НоменклатураПоШтрихкодам КАК НоменклатураПоШтрихкодам
					|
					|ОБЪЕДИНИТЬ ВСЕ
					|
					|ВЫБРАТЬ
					|	ИзмененияНоменклатуры.Ссылка
					|ИЗ
					|	ИзмененияНоменклатуры КАК ИзмененияНоменклатуры
					| 
					| ;
					|////////////////////////////////////////////////////////////////////////////////
					|ВЫБРАТЬ РАЗЛИЧНЫЕ
					|	ТекущиеИзмененияНоменклатуры.Номенклатура КАК ОбъектВыгрузки
					|ИЗ
					|	ТекущиеИзмененияНоменклатуры КАК ТекущиеИзмененияНоменклатуры
					|ГДЕ 
					| ТекущиеИзмененияНоменклатуры.Номенклатура.ТипНоменклатуры = &ТипНоменклатуры
					| И НЕ ТекущиеИзмененияНоменклатуры.Номенклатура.ЭтоГруппа
					|	И (ТекущиеИзмененияНоменклатуры.Номенклатура В ИЕРАРХИИ (&ВыбраннаяГруппаТоваров)
					|			ИЛИ &ВсеТоварыВыбраннойГруппы)";
					
					Запрос.УстановитьПараметр("ВыбраннаяГруппаТоваров", УзелПО.ДоступныеГруппыТоваров.ВыгрузитьКолонку("Номенклатура"));
					Запрос.УстановитьПараметр("ВсеТоварыВыбраннойГруппы", УзелПО.ДоступныеГруппыТоваров.Количество() = 0);
					Запрос.УстановитьПараметр("ТипНоменклатуры", Перечисления.ТипыНоменклатуры.Товар);
					Запрос.УстановитьПараметр("Узел", УзелПО);
					
					Результат = Запрос.Выполнить();   		
					
					//Регистрируем под выгрузку:
					НомерПакетаДляРегистрации = 1;
					
					ВыборкаДанныхДляРегистрации = Результат.Выбрать();
					КоличествоТоваровВТекущейПорции = 0;
					
					МассивТоваровВПорции = Новый Массив;
					
					//создаем набор записей:
					НаборЗаписей = РегистрыСведений.ДатаМобайл_ПорционнаяВыгрузка.СоздатьНаборЗаписей();
					
					Пока ВыборкаДанныхДляРегистрации.Следующий() Цикл 
						
						//сравниваем настройку с  количеством товаров в текущей порции:	
						Если (КоличествоТоваровВТекущейПорции + 1) = КоличествоТоваровВПорции Тогда
							
							МассивТоваровВПорции.Добавить(ВыборкаДанныхДляРегистрации.ОбъектВыгрузки);
							
							НаборЗаписей.Отбор.ТСД.Установить(УзелПО); 
							НаборЗаписей.Отбор.НомерПакета.Установить(НомерПакетаДляРегистрации);
							//1-товары
							НаборЗаписей.Отбор.ТипОбъекта.Установить(1);
							НаборЗаписей.Прочитать();
							
							Для каждого ЭлементМассива Из МассивТоваровВПорции Цикл
								
								НоваяЗапись = НаборЗаписей.Добавить();
								НоваяЗапись.ТСД = УзелПО;
								НоваяЗапись.ОбъектВыгрузки = ЭлементМассива;
								НоваяЗапись.НомерПакета = НомерПакетаДляРегистрации;
								НоваяЗапись.ТипОбъекта = 1;   
								
							КонецЦикла;
							
							//сбрасываем счетчик товаров в порции:	
							КоличествоТоваровВТекущейПорции = 0;
							//берем номер следующего пакета:
							НомерПакетаДляРегистрации = НомерПакетаДляРегистрации + 1;
							//очищаем массив товаров в порции:
							МассивТоваровВПорции.Очистить();
							
							//записываем данные текущей порции:
							НаборЗаписей.Записать(Истина);  
							
						Иначе
							
							МассивТоваровВПорции.Добавить(ВыборкаДанныхДляРегистрации.ОбъектВыгрузки);
							КоличествоТоваровВТекущейПорции = КоличествоТоваровВТекущейПорции + 1;
							
						КонецЕсли;   					
						
					КонецЦикла;	
					
					//записываем остатки последней порции:
					Если МассивТоваровВПорции.Количество() Тогда
						
						НаборЗаписей.Отбор.ТСД.Установить(УзелПО); 
						НаборЗаписей.Отбор.НомерПакета.Установить(НомерПакетаДляРегистрации);
						//1-товары
						НаборЗаписей.Отбор.ТипОбъекта.Установить(1);
						НаборЗаписей.Прочитать();
						
						Для Каждого ЭлементМассива Из МассивТоваровВПорции Цикл
							
							НоваяЗапись = НаборЗаписей.Добавить();
							НоваяЗапись.ТСД = УзелПО;
							НоваяЗапись.ОбъектВыгрузки = ЭлементМассива;
							НоваяЗапись.НомерПакета = НомерПакетаДляРегистрации;
							НоваяЗапись.ТипОбъекта = 1;   
							
						КонецЦикла;
						
						НаборЗаписей.Записать(Истина);
						
						МассивТоваровВПорции.Очистить();
						
					КонецЕсли;	  	
					
					
					МассивКВыгрузке = ПолучитьПорциюТоваров(УзелПО, КоличествоТоваровВПорции, НомерПакета);
					
					Попытка	
						ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.Номенклатура);
						ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.РегистрыСведений.ШтрихкодыНоменклатуры);
					Исключение
					КонецПопытки;  
					
				КонецЕсли;	
								
			КонецЕсли;	 
			
			//удаляем данные предыдущего пакета:
				
			Если НомерПакета > 1 Тогда
					
				//записываем данные уже без учета порции к выгрузке:
				НаборЗаписей = РегистрыСведений.ДатаМобайл_ПорционнаяВыгрузка.СоздатьНаборЗаписей();
				НаборЗаписей.Отбор.ТСД.Установить(УзелПО); 
				НаборЗаписей.Отбор.НомерПакета.Установить(НомерПакета - 1);
				//1-товары
				НаборЗаписей.Отбор.ТипОбъекта.Установить(1);
				НаборЗаписей.Прочитать();
				НаборЗаписей.Очистить(); 			
				НаборЗаписей.Записать(Истина);
					
			КонецЕсли;	
			
			Если МассивКВыгрузке.Количество() Тогда				
				ОбъектСписка = СобратьТовары(МассивКВыгрузке, УзелПО,,, ПакетнаяВыгрузка); 			
			Иначе				
				Если НомерПакета = "" Тогда
					СтруктураОтвета = Новый Массив; 	 
				Иначе
					СтруктураОтвета = Новый Структура;
					СтруктураОтвета.Вставить("is_finished", Истина);			 
					СтруктураОтвета.Вставить("data", ОбъектСписка);
				КонецЕсли;	
				Возврат ПодготовитьОтветJSON(СтруктураОтвета); 
			КонецЕсли;
			
		КонецЕсли;    	
				
	КонецЕсли;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение остатков товаров.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// ArtID - Строка - Id товара.
// Params - Структура - Структура данных из ПО.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция GetArtRest(SN, UserName, ArtID, Params) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
			
	Если Лев(ArtID,3) = "8U-" Тогда
		
		Попытка
			Товар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));		
		Исключение
			
			СтруктураОтвета.Вставить("data", 0);
			Возврат ПодготовитьОтветJSON(СтруктураОтвета);
			
		КонецПопытки;	
		
		ИДХК = Сред(ArtID, 40, 36);
		
		Если ИДХК = "00000000-0000-0000-0000-000000000000" Тогда
			ХК = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
		Иначе	
			ХК = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);		    
		КонецЕсли;
		
	ИначеЕсли Лев(ArtID,3) = "8n-" Тогда
		
		СтруктураОтвета.Вставить("data", 0);
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		
	КонецЕсли;	
	
	ЭтоУслуга = Ложь;
	
	Попытка 
		Если Товар.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
			ЭтоУслуга = Истина;
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	Если УзелПО.НеОтображатьОстатки Тогда
		
		СтруктураОтвета.Вставить("data", 0);
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		
	ИначеЕсли ЭтоУслуга Тогда
		
		СтруктураОтвета.Вставить("data", 999);
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		
	Иначе
		
		Запрос = Новый Запрос("ВЫБРАТЬ
		|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
		|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
		|	СУММА(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество) КАК Количество
		|ПОМЕСТИТЬ РезервТСД
		|ИЗ
		|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
		|ГДЕ
		|	ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)
		|		И ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура = &Номенклатура
		|		И ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры = &ХК
		|		И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.Шаблон.РезервироватьТовар
		|	
		|СГРУППИРОВАТЬ ПО
		|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
		|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////		
		|ВЫБРАТЬ
		|	СУММА(РезервТСД.Количество) КАК РезервТСД,
		|	0 КАК Резерв,
		|	0 КАК Остаток
		|ПОМЕСТИТЬ РазныеДанные
		|ИЗ
		|	РезервТСД КАК РезервТСД
		|ГДЕ
		|	РезервТСД.Номенклатура = &Номенклатура
		|	И РезервТСД.ХарактеристикаНоменклатуры = &ХК
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	0,
		|	СУММА(ТоварыВРезервеНаСкладахОстатки.КОтгрузкеОстаток),
		|	СУММА(ТоварыВРезервеНаСкладахОстатки.ВНаличииОстаток)
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Остатки(
		|			,
		|			Номенклатура = &Номенклатура
		|				И (&ВсеСклады
		|					ИЛИ Склад В (&Склады))
		|				И 1=1) КАК ТоварыВРезервеНаСкладахОстатки
		|ГДЕ
		|	ТоварыВРезервеНаСкладахОстатки.Номенклатура = &Номенклатура
		|	И ТоварыВРезервеНаСкладахОстатки.Характеристика = &ХК
		|
		|&ТекстЗапросаРаспределениеЗапасов
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СУММА(ЕСТЬNULL(РазныеДанные.РезервТСД, 0)) КАК РезервТСД,
		|	СУММА(ЕСТЬNULL(РазныеДанные.Резерв, 0)) КАК Резерв,
		|	СУММА(ЕСТЬNULL(РазныеДанные.Остаток, 0)) КАК Остаток
		|ИЗ
		|	РазныеДанные КАК РазныеДанные");
		
		СкорректироватьЗапросЕслиЕстьРегистрСведенийРаспределениеЗапасов(Запрос.Текст, "GetArtRest", УзелПО.УчитыватьОстаткиПоРегиструРаспределениеЗапасов);  
		СкорректироватьЗапросЕслиЕстьРегистрНакопленияСвободныеОстатки(Запрос.Текст, "GetArtRest", УзелПО.УчитыватьОстаткиПоРегиструСвободныеОстатки);
		
		Запрос.УстановитьПараметр("Номенклатура", Товар);
		Запрос.УстановитьПараметр("ХК", ХК);
		
		СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
		Запрос.УстановитьПараметр("Склады", СписокСкладов);
		Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
		
		СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
		Запрос.УстановитьПараметр("Помещения", СписокПомещений);
		Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
				
		Рез = Запрос.Выполнить().Выгрузить();
		
		Итог = Рез.Итог("Остаток") - Рез.Итог("Резерв") - Рез.Итог("РезервТСД");
		
		СтруктураОтвета.Вставить("data", Итог);
		
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		
	КонецЕсли;
	
КонецФункции

// Получение списка типов серийных номеров.
//
// Параметры: 
// Params - Структура - Структура данных из ПО.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция GetSNTypes(СтруктураHttpПараметров) Экспорт 
	
	SN = СтруктураHttpПараметров.device_id;
	UserName = СтруктураHttpПараметров.username;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьТипыСерий") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьТипыСерий", Ложь);	 
	КонецЕсли;
	
	СтруктураОтвета = Новый Структура;
	
	// По умолчанию добавим три типа серийных номеров		
	МассивСтрок = Новый Массив;
	
	// 1. Серийный номер	 
	СтруктураЗапроса = Новый Структура;
	СтруктураЗапроса.Вставить("id", "10");
	СтруктураЗапроса.Вставить("name", "Серийный номер");
	СтруктураЗапроса.Вставить("ai", "10"); //для разбора GS1
	СтруктураЗапроса.Вставить("data_type", 2);
	СтруктураЗапроса.Вставить("is_need_check_task", Истина); //если параметр не передавать, то ПО проверяет задание по каждому тэгу (если также включена проверка задания в шаблоне is_check_sn_by_task)
	СтруктураЗапроса.Вставить("is_need_check_unique", Истина); //если параметр не передавать, то ПО проверяет уникальность по всей серии вцелом (если также включена проверка уникальности в шаблоне is_use_unique_sn)
	СтруктураЗапроса.Вставить("is_check_unique_by_pack", Истина); //если параметр не передавать, то ПО проверяет уникальность по всей серии вцелом (если также включена проверка уникальности в шаблоне is_use_unique_sn)
		
	МассивСтрок.Добавить(СтруктураЗапроса);	
	
	// 2. Дата производства	 
	СтруктураЗапроса = Новый Структура;
	СтруктураЗапроса.Вставить("id", "11");
	СтруктураЗапроса.Вставить("name", "Дата производства");
	СтруктураЗапроса.Вставить("ai", "11"); //для разбора GS1
	СтруктураЗапроса.Вставить("data_type", 1);
	СтруктураЗапроса.Вставить("mask", "dd.mm.yy");
	СтруктураЗапроса.Вставить("is_need_check_task", Истина); //если параметр не передавать, то ПО проверяет задание по каждому тэгу (если также включена проверка задания в шаблоне is_check_sn_by_task)
	СтруктураЗапроса.Вставить("is_need_check_unique", Ложь); //если параметр не передавать, то ПО проверяет уникальность по всей серии вцелом (если также включена проверка уникальности в шаблоне is_use_unique_sn)
	СтруктураЗапроса.Вставить("is_check_unique_by_pack", Ложь); //если параметр не передавать, то ПО проверяет уникальность по всей серии вцелом (если также включена проверка уникальности в шаблоне is_use_unique_sn)
	
	МассивСтрок.Добавить(СтруктураЗапроса);	
	
	// 3. Дата окончания срока годности 
	СтруктураЗапроса = Новый Структура;
	СтруктураЗапроса.Вставить("id", "17");
	СтруктураЗапроса.Вставить("name", "Дата срока годности");
	СтруктураЗапроса.Вставить("ai", "17"); //для разбора GS1
	СтруктураЗапроса.Вставить("data_type", 1);
	СтруктураЗапроса.Вставить("mask", "dd.mm.yy");
	СтруктураЗапроса.Вставить("is_need_check_task", Истина); //если параметр не передавать, то ПО проверяет задание по каждому тэгу (если также включена проверка задания в шаблоне is_check_sn_by_task)
	СтруктураЗапроса.Вставить("is_need_check_unique", Ложь); //если параметр не передавать, то ПО проверяет уникальность по всей серии вцелом (если также включена проверка уникальности в шаблоне is_use_unique_sn)
	СтруктураЗапроса.Вставить("is_check_unique_by_pack", Ложь); //если параметр не передавать, то ПО проверяет уникальность по всей серии вцелом (если также включена проверка уникальности в шаблоне is_use_unique_sn)
	
	МассивСтрок.Добавить(СтруктураЗапроса);
		
	// 4. ИдентификаторПартииВЕТИС	 
	СтруктураЗапроса = Новый Структура;
	СтруктураЗапроса.Вставить("id", "99");
	СтруктураЗапроса.Вставить("name", "Идентификатор партии (ВетИС)");
	СтруктураЗапроса.Вставить("ai", "99"); //для разбора GS1
	СтруктураЗапроса.Вставить("data_type", 2);
	СтруктураЗапроса.Вставить("is_need_check_task", Истина); //если параметр не передавать, то ПО проверяет задание по каждому тэгу (если также включена проверка задания в шаблоне is_check_sn_by_task)
	СтруктураЗапроса.Вставить("is_need_check_unique", Ложь); //если параметр не передавать, то ПО проверяет уникальность по всей серии вцелом (если также включена проверка уникальности в шаблоне is_use_unique_sn)
	СтруктураЗапроса.Вставить("is_check_unique_by_pack", Ложь); //если параметр не передавать, то ПО проверяет уникальность по всей серии вцелом (если также включена проверка уникальности в шаблоне is_use_unique_sn)
		
	МассивСтрок.Добавить(СтруктураЗапроса);
	
	// 5. Производитель (ВетИС)	 
	СтруктураЗапроса = Новый Структура;
	СтруктураЗапроса.Вставить("id", "100");
	СтруктураЗапроса.Вставить("name", "Производитель (ВетИС)");
	СтруктураЗапроса.Вставить("ai", "100"); //для разбора GS1
	СтруктураЗапроса.Вставить("data_type", 2);
	СтруктураЗапроса.Вставить("is_need_check_task", Истина); //если параметр не передавать, то ПО проверяет задание по каждому тэгу (если также включена проверка задания в шаблоне is_check_sn_by_task)
	СтруктураЗапроса.Вставить("is_need_check_unique", Ложь); //если параметр не передавать, то ПО проверяет уникальность по всей серии вцелом (если также включена проверка уникальности в шаблоне is_use_unique_sn)
	СтруктураЗапроса.Вставить("is_check_unique_by_pack", Ложь); //если параметр не передавать, то ПО проверяет уникальность по всей серии вцелом (если также включена проверка уникальности в шаблоне is_use_unique_sn)
		
	МассивСтрок.Добавить(СтруктураЗапроса);
	
	СтруктураОтвета.Вставить("sn_types", МассивСтрок);
	
	Возврат ПодготовитьОтветJSON(МассивСтрок);	
	
КонецФункции

// Получение списка серийных номеров.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// art_id - Строка - Id товара.
// cell_barcode - Строка - Штрихкод ячейки.
// DocOutID - Строка - Id документа ТСД.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция GetSNList(SN, UserName, art_id, cell_barcode, doc_id) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	DocOutID = doc_id;
	ArtID 	 = art_id;
	Cell 	 = cell_barcode;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не нашли документ.");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Шаблон = СсылкаНаДок.Шаблон;
	РассчитатьГоденДо = ?(УзелПО = Неопределено, Истина, УзелПО.СерииРассчитыватьГоденДо);
	
	ТекущаяЯчейка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(Cell,СсылкаНаДок);
	
	Если Лев(ArtID,3) = "8U-" Тогда
		лТовар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));
		ИДХК = Сред(ArtID, 40, 36);
		Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
			лХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПолучитьСсылку(Новый УникальныйИдентификатор(ИДХК));
		Иначе
			лХарактеристикаНоменклатуры = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);
		КонецЕсли;
	Иначе   	
		СтруктураОтвета.Вставить("Описание", "Не найдена номенклатура. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(лТовар) Тогда		
		СтруктураОтвета.Вставить("Описание", "Не найдена номенклатура. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
	КонецЕсли;
	
	МассивСерий = ПолучитьМассивСерий(УзелПО, СсылкаНаДок, лТовар, лХарактеристикаНоменклатуры, ТекущаяЯчейка, Шаблон);
	
	СтрокаJSON = "";
	
	НастройкиСериализации = Новый НастройкиСериализацииJSON;
	НастройкиСериализации.ФорматСериализацииДаты = ФорматДатыJSON.JavaScript;
	ПараметрыJSON = Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет, " ", Истина);
	
	Запись = Новый ЗаписьJSON;
	Запись.ПроверятьСтруктуру = Истина;
	Запись.УстановитьСтроку(ПараметрыJSON);
	
	МассивЗначенийСерий = Новый Массив;
	Для каждого лСерия Из МассивСерий Цикл		
		
		МассивТекущейСерии = Новый Массив;
		
		Если ЗначениеЗаполнено(лТовар.ВидНоменклатуры.ВладелецСерий) Тогда
			ТекущийВладелецСерий = лТовар.ВидНоменклатуры.ВладелецСерий;
		Иначе
			ТекущийВладелецСерий = лТовар.ВидНоменклатуры;
		КонецЕсли;						
		
		Попытка
			Если ТекущийВладелецСерий.ИспользоватьНомерСерии Тогда // (10)
				МассивТекущейСерии.Добавить(СокрЛП(лСерия.Номер));
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			Если ТекущийВладелецСерий.ИспользоватьДатуПроизводстваСерии Тогда  //(11)
				МассивТекущейСерии.Добавить(Формат(лСерия.ДатаПроизводства, "ДФ=dd.MM.yy"));
			КонецЕсли; 	
		Исключение
		КонецПопытки;
		
		Попытка
			Если ТекущийВладелецСерий.ИспользоватьСрокГодностиСерии Тогда	//(17)
				Если РассчитатьГоденДо Тогда
					// не выгружаем тип серийного номера для даты срока годности
				Иначе
					МассивТекущейСерии.Добавить(Формат(лСерия.ГоденДо, "ДФ=dd.MM.yy"));
				КонецЕсли;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			Если ТекущийВладелецСерий.ИспользоватьИдентификаторПартииВЕТИССерии Тогда // (99)
				МассивТекущейСерии.Добавить(СокрЛП(лСерия.ИдентификаторПартииВЕТИС));
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			Если ТекущийВладелецСерий.ИспользоватьПроизводителяВЕТИССерии Тогда // (100)
				МассивТекущейСерии.Добавить(СокрЛП(лСерия.ПроизводительВЕТИС.Наименование));
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		МассивЗначенийСерий.Добавить(МассивТекущейСерии);
	КонецЦикла;	
	
	
	Возврат ПодготовитьОтветJSON(МассивЗначенийСерий);
	
КонецФункции

// Получение списка атрибутов товара.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция GetArtAttributesName(SN = Неопределено, UserName = Неопределено) Экспорт
	
	ОбъектАтрибутов = Новый Структура;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	
	
	Если УзелПО.ИмяАтрибута1 <> "" Тогда
		ОбъектАтрибутов.Вставить("attr_1", УзелПО.ИмяАтрибута1);
	Иначе
		ОбъектАтрибутов.Вставить("attr_1", "Атрибут 1");
	КонецЕсли;
	
	Если УзелПО.ИмяАтрибута2 <> "" Тогда
		ОбъектАтрибутов.Вставить("attr_2", УзелПО.ИмяАтрибута2);
	Иначе
		ОбъектАтрибутов.Вставить("attr_2", "Атрибут 2");
	КонецЕсли;
	
	Если УзелПО.ИмяАтрибута3 <> "" Тогда
		ОбъектАтрибутов.Вставить("attr_3", УзелПО.ИмяАтрибута3);
	Иначе
		ОбъектАтрибутов.Вставить("attr_3", "Атрибут 3");
	КонецЕсли;
	
	Если УзелПО.ИмяАтрибута4 <> "" Тогда
		ОбъектАтрибутов.Вставить("attr_4", УзелПО.ИмяАтрибута4);
	Иначе
		ОбъектАтрибутов.Вставить("attr_4", "Атрибут 4");
	КонецЕсли;
	
	Если УзелПО.ИмяАтрибута5 <> "" Тогда
		ОбъектАтрибутов.Вставить("attr_5", УзелПО.ИмяАтрибута5);
	Иначе
		ОбъектАтрибутов.Вставить("attr_5", "Атрибут 5");
	КонецЕсли;
	
	Если УзелПО.ИмяАтрибута6 <> "" Тогда
		ОбъектАтрибутов.Вставить("attr_6", УзелПО.ИмяАтрибута6);
	Иначе
		ОбъектАтрибутов.Вставить("attr_6", "Атрибут 6");
	КонецЕсли;
	
	Если УзелПО.ИмяАтрибута7 <> "" Тогда
		ОбъектАтрибутов.Вставить("attr_7", УзелПО.ИмяАтрибута7);
	Иначе
		ОбъектАтрибутов.Вставить("attr_7", "Атрибут 7");
	КонецЕсли;
	
	Если УзелПО.ИмяАтрибута8 <> "" Тогда
		ОбъектАтрибутов.Вставить("attr_8", УзелПО.ИмяАтрибута8);
	Иначе
		ОбъектАтрибутов.Вставить("attr_8", "Атрибут 8");
	КонецЕсли;
	
	Если УзелПО.ИмяАтрибута9 <> "" Тогда
		ОбъектАтрибутов.Вставить("attr_9", УзелПО.ИмяАтрибута9);
	Иначе
		ОбъектАтрибутов.Вставить("attr_9", "Атрибут 9");
	КонецЕсли;
	
	Если УзелПО.ИмяАтрибута10 <> "" Тогда
		ОбъектАтрибутов.Вставить("attr_10", УзелПО.ИмяАтрибута10);
	Иначе
		ОбъектАтрибутов.Вставить("attr_10", "Атрибут 10");
	КонецЕсли;
	
	СтруктураОтвета.Вставить("attrs_names", ОбъектАтрибутов);
	
	Возврат ПодготовитьОтветJSON(ОбъектАтрибутов); 
	
КонецФункции

// Получение списка марок.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetArtMarks(SN, UserName) Экспорт 
	
	ОбъектСписка = Новый Массив;	
	СтруктураОтвета = Новый Структура;
	
	Если Не ДатаМобайл_ОбщийМодуль.ЕстьМаркировка() И Не ДатаМобайл_ОбщийМодуль.ЕстьМДЛП() Тогда		
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
	КонецЕсли;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьКодыМаркировки") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьКодыМаркировки", Ложь);	 
	КонецЕсли;
	
	ЗапросМарок = Новый Запрос ("ВЫБРАТЬ
	|	ШтрихкодыУпаковокТоваров.Ссылка КАК Ссылка,
	|	ШтрихкодыУпаковокТоваров.Номенклатура КАК Номенклатура,
	|	ШтрихкодыУпаковокТоваров.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА ШтрихкодыУпаковокТоваров.Количество = 0 
	|		ТОГДА
	|			ВЫБОР
	|				КОГДА ЕСТЬNULL(ШтрихкодыУпаковокТоваров.Упаковка.Числитель,0) = 0
	|				ТОГДА 1
	|				ИНАЧЕ ШтрихкодыУпаковокТоваров.Упаковка.Числитель
	|			КОНЕЦ
	|		ИНАЧЕ ШтрихкодыУпаковокТоваров.Количество 
	|	КОНЕЦ КАК Коэффициент,
	|	ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода КАК ЗначениеШтрихкода,
	|	ШтрихкодыУпаковокТоваров.Номенклатура.ПометкаУдаления КАК ПометкаУдаления
	|ПОМЕСТИТЬ КодыМаркировки
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
	|ГДЕ
	|	ШтрихкодыУпаковокТоваров.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|	И ШтрихкодыУпаковокТоваров.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.АлкогольнаяПродукция)
	|	И ШтрихкодыУпаковокТоваров.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.АлкогольнаяПродукция)
	|	И (ШтрихкодыУпаковокТоваров.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПустаяСсылка) ИЛИ ШтрихкодыУпаковокТоваров.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПустаяСсылка))
	|	И НЕ ШтрихкодыУпаковокТоваров.ПометкаУдаления
	|	И ШтрихкодыУпаковокТоваров.ТипШтрихкода <> ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.PDF417) 
	|	И ((ШтрихкодыУпаковокТоваров.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|		И ШтрихкодыУпаковокТоваров.ТипШтрихкода <> ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.DataMatrix))
	|			ИЛИ (ШтрихкодыУпаковокТоваров.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|				И ШтрихкодыУпаковокТоваров.ТипШтрихкода = ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)))
	|;
	|
	|ВЫБРАТЬ
	|	ШтрихкодыУпаковокТоваров.Ссылка КАК Ссылка,
	|	ШтрихкодыУпаковокТоваров.Номенклатура КАК Номенклатура,
	|	ШтрихкодыУпаковокТоваров.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА ШтрихкодыУпаковокТоваров.Количество = 0 
	|		ТОГДА
	|			ВЫБОР
	|				КОГДА ЕСТЬNULL(ШтрихкодыУпаковокТоваров.Упаковка.Числитель,0) = 0
	|				ТОГДА 1
	|				ИНАЧЕ ШтрихкодыУпаковокТоваров.Упаковка.Числитель
	|			КОНЕЦ
	|		ИНАЧЕ ШтрихкодыУпаковокТоваров.Количество 
	|	КОНЕЦ КАК Коэффициент,
	|	ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода КАК ЗначениеШтрихкода,
	|	ШтрихкодыУпаковокТоваров.Номенклатура.ПометкаУдаления КАК ПометкаУдаления
	|ПОМЕСТИТЬ ПачкиСигарет
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
	|ГДЕ
	|	ШтрихкодыУпаковокТоваров.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|	И ШтрихкодыУпаковокТоваров.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.АлкогольнаяПродукция)
	|	И ШтрихкодыУпаковокТоваров.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.АлкогольнаяПродукция)
	|	И (ШтрихкодыУпаковокТоваров.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПустаяСсылка) ИЛИ ШтрихкодыУпаковокТоваров.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПустаяСсылка))						   						
	|	И НЕ ШтрихкодыУпаковокТоваров.ПометкаУдаления						   
	|	И ШтрихкодыУпаковокТоваров.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|	И ШтрихкодыУпаковокТоваров.ТипШтрихкода = ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.DataMatrix)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	КодыМаркировки.Номенклатура КАК Номенклатура,
	|	КодыМаркировки.Характеристика КАК Характеристика,
	|	КодыМаркировки.Коэффициент КАК Коэффициент,
	|	КодыМаркировки.ПометкаУдаления КАК ПометкаУдаления,
	|	КодыМаркировки.ЗначениеШтрихкода КАК Марка,
	|	ЕСТЬNULL(ДанныеУпаковкиУровень1.Ссылка.ЗначениеШтрихкода, """") КАК Короб,
	|	ЕСТЬNULL(ДанныеУпаковкиУровень2.Ссылка.ЗначениеШтрихкода, """") КАК Палета
	|ИЗ
	|	КодыМаркировки КАК КодыМаркировки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ДанныеУпаковкиУровень1
	|		ПО (ДанныеУпаковкиУровень1.Штрихкод = КодыМаркировки.Ссылка)
	|			И (ДанныеУпаковкиУровень1.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|				ИЛИ ДанныеУпаковкиУровень1.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ДанныеУпаковкиУровень2
	|		ПО (ДанныеУпаковкиУровень2.Штрихкод = ДанныеУпаковкиУровень1.Ссылка)
	|			И (ДанныеУпаковкиУровень2.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|				ИЛИ ДанныеУпаковкиУровень2.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|
	//пачки сигарет, которые не вошли в блоки
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ПачкиСигарет.Номенклатура КАК Номенклатура,
	|	ПачкиСигарет.Характеристика КАК Характеристика,
	|	ПачкиСигарет.Коэффициент КАК Коэффициент,
	|	ПачкиСигарет.ПометкаУдаления КАК ПометкаУдаления,
	|	ПачкиСигарет.ЗначениеШтрихкода КАК Марка,
	|	ЕСТЬNULL(ДанныеУпаковкиУровень1.Ссылка.ЗначениеШтрихкода, """") КАК Короб,
	|	ЕСТЬNULL(ДанныеУпаковкиУровень2.Ссылка.ЗначениеШтрихкода, """") КАК Палета
	|ИЗ
	|	ПачкиСигарет КАК ПачкиСигарет
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ДанныеУпаковкиУровень1
	|		ПО (ДанныеУпаковкиУровень1.Штрихкод = ПачкиСигарет.Ссылка)
	|			И (ДанныеУпаковкиУровень1.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|				ИЛИ ДанныеУпаковкиУровень1.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ДанныеУпаковкиУровень2
	|		ПО (ДанныеУпаковкиУровень2.Штрихкод = ДанныеУпаковкиУровень1.Ссылка)
	|			И (ДанныеУпаковкиУровень2.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|				ИЛИ ДанныеУпаковкиУровень2.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|ГДЕ
	|	ЕСТЬNULL(ДанныеУпаковкиУровень1.Ссылка.ТипШтрихкода,"""") <> ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ КодыМаркировки
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ПачкиСигарет");
	
	ВыборкаМарок = ЗапросМарок.Выполнить().Выбрать();
	
	Пока ВыборкаМарок.Следующий() Цикл
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art_mark"); 
		
		ОбъектТовара.art_id = "8U-" + XMLСтрока(ВыборкаМарок.Номенклатура) + XMLСтрока(ВыборкаМарок.Характеристика);// ID номенклатуры марки 		
		
		ТипПродукции = ДатаМобайл_Маркировка.ПолучитьТипМаркированнойПродукции(ВыборкаМарок.Номенклатура);
		ЧистаяМарка = ДатаМобайл_Маркировка.УбратьСкобкиТеговМарка(Строка(ВыборкаМарок.Марка), ТипПродукции);
		
		ОбъектТовара.mark = ЧистаяМарка; // марка
		ОбъектТовара.box =  ДатаМобайл_Маркировка.УбратьСкобкиТеговУпаковка(Строка(ВыборкаМарок.Короб));  // короб 
		ОбъектТовара.pallet =  ДатаМобайл_Маркировка.УбратьСкобкиТеговУпаковка(Строка(ВыборкаМарок.Палета)); // палета
		ОбъектТовара.coef =  ВыборкаМарок.Коэффициент;  // коэффициент
		
		ОбъектСписка.Добавить(ОбъектТовара);
		
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Генерация нового штрихкода.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// ArtID - Строка - Id товара.
// UnitID - Строка - Id ед. измерения.
// P1 - Строка - Параметр 1.
// P2 - Строка - Параметр 2.
// BarcodeQuant - Число - Коэффициент штрихкода.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция GenerateNewBC(SN, UserName, ArtID, UnitID, P1, P2, BarcodeQuant = 1) Экспорт 
	
	ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","unit_value");
	
	СтруктураОтвета = Новый Структура;
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		NewTSD(SN, UserName); 
	КонецЕсли;
	
	СХарактеристикой = Ложь;	
	Если Лев(ArtID, 3) = "8U-" Тогда
		Если УзелПО.ЗаписьВРегистр Тогда
			лТовар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36)); 			
			ИДХК = Сред(ArtID, 40, 36);
			Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
				лХарактеристикаНоменклатуры = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);   
				СХарактеристикой = Истина;
			КонецЕсли;	
		Иначе 		
			СтруктураОтвета.Вставить("Описание", "Не включена автоматическая привязка новых ШК в настройках устройства в АРМ 1С.");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	Иначе 	
		СтруктураОтвета.Вставить("Описание", "Генерация возможна только на товары из справочника 1С, новые товары необходимо сначала записать в 1С.");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	
	
	Коэффициент = BarcodeQuant;
	
	Если лТовар.ИспользоватьУпаковки Тогда
		
		ЗапросУпаковок = Новый Запрос;
		ЗапросУпаковок.УстановитьПараметр("Номенклатура", лТовар);
		ЗапросУпаковок.УстановитьПараметр("НаборыУпаковокНоменклатура", лТовар.НаборУпаковок);
		ЗапросУпаковок.УстановитьПараметр("НаборыУпаковокВидНоменклатуры", лТовар.ВидНоменклатуры.НаборУпаковок);
		ЗапросУпаковок.УстановитьПараметр("Коэффициент", Коэффициент);	
		ЗапросУпаковок.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
		|	УпаковкиНоменклатуры.Ссылка
		|ИЗ
		|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиНоменклатуры
		|ГДЕ
		|	УпаковкиНоменклатуры.Владелец = &Номенклатура
		|	И УпаковкиНоменклатуры.Числитель = &Коэффициент
		|	И НЕ УпаковкиНоменклатуры.ПометкаУдаления
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	УпаковкиНоменклатуры.Ссылка
		|ИЗ
		|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиНоменклатуры
		|ГДЕ
		|	УпаковкиНоменклатуры.Владелец = &НаборыУпаковокНоменклатура
		|	И УпаковкиНоменклатуры.Числитель = &Коэффициент
		|	И НЕ УпаковкиНоменклатуры.ПометкаУдаления
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	УпаковкиНоменклатуры.Ссылка
		|ИЗ
		|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиНоменклатуры
		|ГДЕ
		|	УпаковкиНоменклатуры.Владелец = &НаборыУпаковокВидНоменклатуры
		|	И УпаковкиНоменклатуры.Числитель = &Коэффициент
		|	И НЕ УпаковкиНоменклатуры.ПометкаУдаления
		|";
		
		ВыборкаУпаковок = ЗапросУпаковок.Выполнить().Выбрать();                            
		лУпак = Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка();
		
		Пока ВыборкаУпаковок.Следующий() Цикл
			лУпак = ВыборкаУпаковок.ССылка;
			Прервать;
		КонецЦикла;
		
		Если лУпак.Пустая() И Коэффициент <> 1 Тогда			
			СтруктураОтвета.Вставить("Описание", "Не удалось добавить штрихкод. В 1С для товара не найдена упаковка с коэффициентом " + Коэффициент);		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);			
		КонецЕсли;			
		
	Иначе
		лУпак = Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка();
	КонецЕсли;	
	
	Если лУпак.Пустая() Тогда
		unit_id = ""; 
	Иначе
		unit_id = XMLСтрока(лУпак);
	КонецЕсли;						   
	
	ЗаписьШК = РегистрыСведений.ШтрихкодыНоменклатуры.СоздатьМенеджерЗаписи();
	ЗаписьШК.Номенклатура = лТовар;
	Если Константы.ИспользоватьУпаковкиНоменклатуры.Получить() Тогда
		ЗаписьШК.Упаковка = лУпак;
	КонецЕсли;	
	ЗаписьШК.Штрихкод = РегистрыСведений.ШтрихкодыНоменклатуры.СформироватьШтрихкодEAN13();	
	Если СХарактеристикой Тогда
		ЗаписьШК.Характеристика = лХарактеристикаНоменклатуры; 
	КонецЕсли;
	
	Попытка	
		ЗаписьШК.Записать(Истина);
		ОбъектШтрихкода.value = ЧистаяСтрока(ЗаписьШК.Штрихкод); 
		Если лУпак.Пустая() Тогда
			ОбъектШтрихкода.unit_name = ЧистаяСтрока(лТовар.ЕдиницаИзмерения); 	 
		Иначе
			ОбъектШтрихкода.unit_name = ЧистаяСтрока(лУпак.Наименование); 
		КонецЕсли;
		ОбъектШтрихкода.unit_id = unit_id;
		ОбъектШтрихкода.unit_coef = Коэффициент;	
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Ошибка записи штрихкода " + ОписаниеОшибки());		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецПопытки;
	
	Возврат ПодготовитьОтветJSON(ОбъектШтрихкода);
	
КонецФункции

// Получение товара по штрихкоду.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// Barcode - Строка - Штрихкод.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetArtOnBC(SN, UserName, Barcode) Экспорт 
	
	ОбъектСписка = Новый Массив();
	
	УзелПО = НайтиУзел(SN);	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;  
	
	ШК = Barcode;
	
	МассивТоваров = Новый Массив;
	
	Если УзелПО.ИспользоватьАртикулКакШтрихкодТовара Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Артикул = &Артикул
		|	И НЕ Номенклатура.ЭтоГруппа
		|	И НЕ Номенклатура.ПометкаУдаления";  
		Запрос.УстановитьПараметр("Артикул", ШК);
		Результат = Запрос.Выполнить();
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			МассивТоваров.Добавить(Выборка.Ссылка);		
		КонецЦикла;			
		
	КонецЕсли;	
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РегистрШтрихкодов.Номенклатура КАК Ссылка,
	|	РегистрШтрихкодов.Характеристика КАК СсылкаХарактеристика
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК РегистрШтрихкодов
	|ГДЕ
	|	РегистрШтрихкодов.Штрихкод = &ШК";
	
	ПростойФорматВесовыхШтрихкодов = УзелПО.ПростойФорматВесовыхШтрихкодов;	 
	Если СтрДлина(ШК) = 5 И Не ПростойФорматВесовыхШтрихкодов Тогда
		ВесовойШК = "2_" + ШК + "00000_";
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "РегистрШтрихкодов.Штрихкод = &ШК", "РегистрШтрихкодов.Штрихкод = &ШК ИЛИ РегистрШтрихкодов.Штрихкод = &ВесовойШК");
		Запрос.УстановитьПараметр("ВесовойШК", ВесовойШК);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ШК", ШК);
	
	МассивТоваров_Запрос = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	МассивХарактеристик = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("СсылкаХарактеристика");
	
	Для каждого ЭлементМассива Из МассивТоваров_Запрос Цикл
		Если МассивТоваров.Найти(ЭлементМассива) = Неопределено Тогда
			МассивТоваров.Добавить(ЭлементМассива);	
		КонецЕсли;	
	КонецЦикла;	
	
	Если МассивТоваров.Количество() > 0 Тогда
		ОбъектСписка = СобратьТовары(МассивТоваров, УзелПО, МассивХарактеристик);
	КонецЕсли;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение товара по штрихкоду.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// Art - Структура - Товар.
// EgaisArt - Структура - Товар ЕГАИС.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция UpdateArt(SN, UserName, Art, EgaisArt = "") Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;		
	
	ArtID = Art.id;
	
	Если Лев(ArtID, 3) = "8U-" Тогда
		
		Если Не РазрешеноРедактированиеТовара(УзелПО,UserName) Тогда		
			
			СтруктураОтвета.Вставить("Описание", "Пользователю ТСД в настройках роли в АРМ не разрешено редактирование товаров.");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
			
		КонецЕсли;
		
		ИДХК = Сред(ArtID, 40, 36);
		
		Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда		
			
			СтруктураОтвета.Вставить("Описание", "Нельзя изменять наименование товара с характеристикой. ");			
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);			
			
		КонецЕсли;
		
		Попытка
			
			лТоварСсылка = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4));
			
			Если Не ЗначениеЗаполнено(лТоварСсылка) Тогда
				лТоварСсылка = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));
			КонецЕсли;	
			
			Попытка
				
				лТовар = лТоварСсылка.ПолучитьОбъект();
				лТовар.Заблокировать();
				
			Исключение
				
				СтруктураОтвета.Вставить("Описание", "Не удалось обновить товар. " + ОписаниеОшибки());			
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
				
			КонецПопытки;	
				
			лТовар.Наименование = Лев(Art.name, Метаданные.Справочники.Номенклатура.ДлинаНаименования);
			
		Исключение			
			
			СтруктураОтвета.Вставить("Описание", "Не удалось обновить товар. " + ОписаниеОшибки());			
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);			
			
		КонецПопытки;
		
		ТекстОшибки = "";	
		
		Если СсылкаСуществует(лТоварСсылка) Тогда
			
			ЕстьДопРеквизит = Ложь;
			
			ТЗ = Новый ТаблицаЗначений;
			ТЗ.Колонки.Добавить("Свойство", Новый ОписаниеТипов("ПланВидовХарактеристикСсылка.ДополнительныеРеквизитыИСведения"));
			ТЗ.Колонки.Добавить("Значение");
			
			Атрибуты = ПолучитьАтрибуты(УзелПО);
			
			Для сч = 1 По 10 Цикл
				
				ИмяАтрибута = Атрибуты["ИмяАтрибута" + сч];
				
				НовоеЗначениеРеквизитаСтрокой = СокрЛП(Art.attributes["attr_" + сч]); 
				
				Если ИмяАтрибута = "!!! Ячейки !!!" Или ИмяАтрибута = "!!! Основная ячейка !!!" Или ИмяАтрибута = "!!! Дополнительные ячейки !!!" Или ИмяАтрибута = "!!! Характеристики !!!" Тогда
					Продолжить;
				ИначеЕсли Лев(ИмяАтрибута, 3) = "ДР_" Тогда
					
					ЕстьДопРеквизит = Истина;
					
					ДопСвойство = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоНаименованию(СтрЗаменить(ИмяАтрибута, "ДР_", ""));
					Значение = лТоварСсылка.ДополнительныеРеквизиты.Найти(ДопСвойство);
					
					НовСтр = ТЗ.Добавить();
					НовСтр.Свойство = ДопСвойство;
					ЗначениеПоСвойству = Справочники.ЗначенияСвойствОбъектов.НайтиПоНаименованию(НовоеЗначениеРеквизитаСтрокой,,, НовСтр.Свойство);	
					
					Если ЗначениеЗаполнено(ЗначениеПоСвойству) Тогда
						НовСтр.Значение = ЗначениеПоСвойству;
					Иначе
						НовСтр.Значение = НовоеЗначениеРеквизитаСтрокой;	
					КонецЕсли;
					
				ИначеЕсли ИмяАтрибута <> "" И ЧистаяСтрока(Строка(лТовар[ИмяАтрибута])) <> НовоеЗначениеРеквизитаСтрокой Тогда
					
					Если НовоеЗначениеРеквизитаСтрокой = "" Тогда
						лТовар[ИмяАтрибута] = "";
					Иначе
						УстановитьЗначениеИЗСтроки(лТовар, ИмяАтрибута, НовоеЗначениеРеквизитаСтрокой, ТекстОшибки);
					КонецЕсли;
					
				КонецЕсли;
				
			КонецЦикла;
			
			Попытка
				
				Если ЕстьДопРеквизит Тогда
					Модуль_УправлениеСвойствами = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("УправлениеСвойствами");
					Модуль_УправлениеСвойствами.ЗаписатьСвойстваУОбъекта(лТоварСсылка, ТЗ);					 	 
				КонецЕсли;
				
			Исключение
			КонецПопытки; 
			
		Иначе
			ТекстОшибки = ТекстОшибки + "Не удалось найти товар по УИД." + Символы.ПС;
		КонецЕсли; 
		
		Если ЗначениеЗаполнено(ТекстОшибки) Тогда		
			
			СтруктураОтвета.Вставить("Описание", ТекстОшибки);		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);			
			
		КонецЕсли;	
				
	ИначеЕсли Лев(ArtID,3) = "8n-" Тогда
		
		лТоварСсылка = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_НовыеТовары"), Сред(ArtID, 4));
		лТовар = лТоварСсылка.ПолучитьОбъект();
		лТовар.Пользователь = UserName;
		
		Если лТовар = Неопределено Тогда
			
			СтруктураОтвета.Вставить("Описание", "Не удалось определить новый товар.");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
			
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(лТовар, Art.attributes);
		лТовар.ТСД = УзелПО;
		
	Иначе	
		лТовар = Справочники.ДатаМобайл_НовыеТовары.СоздатьЭлемент();
	КонецЕсли;	             
			
	Если ЗначениеЗаполнено(EgaisArt) Тогда	
		
		лТовар.Наименование = Лев(EgaisArt.name, Метаданные.Справочники.ДатаМобайл_НовыеТовары.ДлинаНаименования);
		AlcoArtID = EgaisArt.id;
		
		Попытка 
			лТовар.ИдентификаторАлкоголя = AlcoArtID; 
		Исключение 
		КонецПопытки;
		
	Иначе
		лТовар.Наименование = Лев(Art.name, Метаданные.Справочники.ДатаМобайл_НовыеТовары.ДлинаНаименования);
	КонецЕсли;	
	
	Попытка
		
		лТовар.ОбменДанными.Получатели.АвтоЗаполнение = Ложь;
		лТовар.ОбменДанными.Получатели.Заполнить();
		лТовар.ОбменДанными.Получатели.Удалить(УзелПО);
		лТовар.Записать();
		лТовар.Разблокировать();
		
	Исключение	
		
		СтруктураОтвета.Вставить("Описание", "Не удалось обновить товар. " + ОписаниеОшибки());		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
		
	КонецПопытки;
	
	Art.id = "8n-" + XMLСтрока(лТовар.Ссылка);
	
	Возврат ПодготовитьОтветJSON(Art);
	
КонецФункции

// Создание товара ЕГАИС.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// Art - Структура - Товар.
// EgaisArt - Структура - Товар ЕГАИС.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция CreateEgaisArt(SN, UserName, Art, EgaisArt) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	ArtID = Art.id;
	AlcoArtID = EgaisArt.id;
	
	Если Лев(ArtID, 3) = "8U-" Тогда
		Возврат ПодготовитьОтветJSON(Art);
	ИначеЕсли Лев(ArtID, 3) = "8n-" Тогда
		лТоварСсылка = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_НовыеТовары"), Сред(ArtID, 4));
		лТовар = лТоварСсылка.ПолучитьОбъект();
	Иначе	
		лТовар = Справочники.ДатаМобайл_НовыеТовары.СоздатьЭлемент();
	КонецЕсли;	
	
	лТовар.Пользователь = UserName;
	лТовар.Наименование = Лев(EgaisArt.name, Метаданные.Справочники.Номенклатура.ДлинаНаименования);
	лТовар.ИдентификаторАлкоголя = AlcoArtID;
	
	Попытка
		лТовар.ОбменДанными.Получатели.АвтоЗаполнение = Ложь;
		лТовар.ОбменДанными.Получатели.Заполнить();
		лТовар.ОбменДанными.Получатели.Удалить(УзелПО);
		лТовар.Записать();
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Не удалось создать товар. " + ОписаниеОшибки());		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	Конецпопытки;
	
	Art.id = "8n-" + XMLСтрока(лТовар.Ссылка);
	
	Возврат ПодготовитьОтветJSON(Art);
	
КонецФункции

// Удаление товара.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// ArtID - Строка - Id товара. 
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция DeleteArt(SN, UserName, ArtID) Экспорт
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если Лев(ArtID, 3) = "8U-" Тогда		
		СтруктураОтвета.Вставить("Описание", "Нельзя удалять существующие товары. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	ИначеЕсли Лев(ArtID, 3) = "8n-" Тогда
		лТоварСсылка = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_НовыеТовары"), Сред(ArtID, 4));
		лТовар = лТоварСсылка.ПолучитьОбъект();
	Иначе	
		СтруктураОтвета.Вставить("is_success", Истина);	
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	КонецЕсли;	
	
	Попытка
		лТовар.ОбменДанными.Получатели.АвтоЗаполнение = Ложь;
		лТовар.ОбменДанными.Получатели.Заполнить();
		лТовар.ОбменДанными.Получатели.Удалить(УзелПО);
		лТовар.ПометкаУдаления = Истина;
		лТовар.Записать();
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Не удалось удалить товар. " + ОписаниеОшибки());		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	Конецпопытки;	
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Обновление штрихкода товара.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// ArtID - Строка - Id товара.
// Barcode - Строка - Штрихкод.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция UpdateBarcode(SN, UserName, ArtID, Barcode) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		NewTSD(SN, UserName);  
	КонецЕсли;	
	
	СХарактеристикой = Ложь;
	ЭтоНовыйТовар = Ложь;
	Если Лев(ArtID, 3)= "8U-" Тогда
		
		лТовар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));
		ИДХК = Сред(ArtID, 40, 36);
		
		Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
			лХарактеристикаНоменклатуры = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);
			СХарактеристикой = Истина;
		Иначе
			лХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
		КонецЕсли;
		
	ИначеЕсли Лев(ArtID, 3)= "8n-" Тогда
		лТовар = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_НовыеТовары"), Сред(ArtID, 4));
		ЭтоНовыйТовар = Истина;
		лХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
	Иначе
		Возврат ПодготовитьОтветJSON(Barcode); 
	КонецЕсли;	
	
	ШК = Barcode.Получить("value");
	Коэффициент = Barcode.Получить("unit_coef");
	
	Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
	|	ШтрихкодыНоменклатуры.Штрихкод,
	|	ШтрихкодыНоменклатуры.Номенклатура,
	|	ШтрихкодыНоменклатуры.Упаковка,
	|	ШтрихкодыНоменклатуры.Характеристика,
	|	ШтрихкодыНоменклатуры.Упаковка.Наименование КАК УпаковкаНаименование
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|ГДЕ
	|	ШтрихкодыНоменклатуры.Штрихкод = &Штрихкод");
	Запрос.УстановитьПараметр("ШтрихКод", ШК);
	
	Рез = Запрос.Выполнить().Выбрать();
	Если Рез.Следующий() Тогда // уже есть в списке шк
		Если Рез.Номенклатура = лТовар И Рез.Характеристика = лХарактеристикаНоменклатуры Тогда  
			Если ЗначениеЗаполнено(Рез.Упаковка) Тогда
				Попытка
					ТекущийКоэффициент = ?(Рез.Упаковка.Числитель = 0, 1, Рез.Упаковка.Числитель) / ?(Рез.Упаковка.Знаменатель = 0, 1, Рез.Упаковка.Знаменатель);
				Исключение
				КонецПопытки;	
			Иначе
				ТекущийКоэффициент = 1;
			КонецЕсли;	
			
			Если Коэффициент <> ТекущийКоэффициент Тогда
				СтруктураОтвета.Вставить("Описание", "Не удалось обновить штрихкод. В 1С он принадлежит упаковке с коэффициентом : " + ТекущийКоэффициент + ", а введен коэффициент " + Коэффициент + ". Изменение коэффициентов упаковок из ТСД невозможно. ");
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
			
			Если Рез.УпаковкаНаименование <> Barcode.Получить("unit_name") Тогда
				ЗаписьШК = РегистрыСведений.ШтрихкодыНоменклатуры.СоздатьМенеджерЗаписи();
				ЗаписьШК.Номенклатура = лТовар;
				ЗаписьШК.Упаковка = ПолучитьУпаковкуДляШтрихкода(лТовар, Barcode.Получить("unit_name"), Рез.Упаковка);				
				ЗаписьШК.Штрихкод = ШК;	
				
				Если СХарактеристикой Тогда
					ЗаписьШК.Характеристика = лХарактеристикаНоменклатуры; 
				КонецЕсли;
				
				Попытка	
					ЗаписьШК.Записать(Истина);
					Если ЗначениеЗаполнено(ЗаписьШК.Упаковка) Тогда
						Попытка
							Barcode.Вставить("unit_coef", ?(ЗаписьШК.Упаковка.Числитель = 0, 1, ЗаписьШК.Упаковка.Числитель) / ?(ЗаписьШК.Упаковка.Знаменатель = 0, 1, ЗаписьШК.Упаковка.Знаменатель));
						Исключение
						КонецПопытки;
					КонецЕсли;
				Исключение
					СтруктураОтвета.Вставить("Описание", "Не удалось обновить единицу измерения штрихкода. " + ОписаниеОшибки());		
					Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
				КонецПопытки;
			КонецЕсли;
			
			Возврат ПодготовитьОтветJSON(Barcode); 
		Иначе		
			СтруктураОтвета.Вставить("Описание", "Не удалось добавить штрихкод. В 1С он принадлежит другому товару: " + Рез.Номенклатура + " " + Рез.Характеристика);		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;	
		
	Если УзелПО.ЗаписьВРегистр И Не ЭтоНовыйТовар Тогда
		Если лТовар.ИспользоватьУпаковки Тогда
			
			ЗапросУпаковок = Новый Запрос;
			ЗапросУпаковок.УстановитьПараметр("Номенклатура", лТовар);
			ЗапросУпаковок.УстановитьПараметр("НаборыУпаковокНоменклатура", лТовар.НаборУпаковок);
			ЗапросУпаковок.УстановитьПараметр("НаборыУпаковокВидНоменклатуры", лТовар.ВидНоменклатуры.НаборУпаковок);
			ЗапросУпаковок.УстановитьПараметр("Коэффициент", Коэффициент);	
			ЗапросУпаковок.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
			|	УпаковкиНоменклатуры.Ссылка
			|ИЗ
			|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиНоменклатуры
			|ГДЕ
			|	УпаковкиНоменклатуры.Владелец = &Номенклатура
			|	И УпаковкиНоменклатуры.Числитель = &Коэффициент
			|ОБЪЕДИНИТЬ
			|ВЫБРАТЬ
			|	УпаковкиНоменклатуры.Ссылка
			|ИЗ
			|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиНоменклатуры
			|ГДЕ
			|	УпаковкиНоменклатуры.Владелец = &НаборыУпаковокНоменклатура
			|	И УпаковкиНоменклатуры.Числитель = &Коэффициент
			|ОБЪЕДИНИТЬ
			|ВЫБРАТЬ
			|	УпаковкиНоменклатуры.Ссылка
			|ИЗ
			|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиНоменклатуры
			|ГДЕ
			|	УпаковкиНоменклатуры.Владелец = &НаборыУпаковокВидНоменклатуры
			|	И УпаковкиНоменклатуры.Числитель = &Коэффициент";
			
			ВыборкаУпаковок = ЗапросУпаковок.Выполнить().Выбрать();                            
			лУпак = Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка();
			
			Пока ВыборкаУпаковок.Следующий() Цикл
				лУпак = ВыборкаУпаковок.ССылка;
				Прервать;
			КонецЦикла;
			
			Если лУпак.Пустая() И Коэффициент <> 1 Тогда			
				СтруктураОтвета.Вставить("Описание", "Не удалось добавить штрихкод. В 1С для товара не найдена упаковка с коэффициентом " + Коэффициент);		
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);			
			КонецЕсли;			
			
		Иначе
			лУпак = Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка();
		КонецЕсли;						   
		
		ЗаписьШК = РегистрыСведений.ШтрихкодыНоменклатуры.СоздатьМенеджерЗаписи();
		ЗаписьШК.Номенклатура = лТовар;
		
		Если Константы.ИспользоватьУпаковкиНоменклатуры.Получить() Тогда
			Если СокрЛП(лУпак.код) = "" Тогда
				ЗаписьШК.Упаковка = лУпак;
			КонецЕсли;
		КонецЕсли;
		
		ЗаписьШК.Штрихкод = ШК;	
		
		Если СХарактеристикой Тогда
			ЗаписьШК.Характеристика = лХарактеристикаНоменклатуры; 
		КонецЕсли;
		
		Попытка	
			ЗаписьШК.Записать(Истина);	
		Исключение
			СтруктураОтвета.Вставить("Описание", "Не удалось добавить штрихкод. " + ОписаниеОшибки());		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецПопытки;
		
	Иначе
		Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
		Если Не Модуль_ОбщегоНазначения.СсылкаСуществует(лТовар) Тогда
			СтруктураОтвета.Вставить("Описание", "Не удалось найти товар, возможно он был уже создан, обновите справочник товаров на устройстве и повторите попытку. ");	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
		КонецЕсли;
				
		лНЗ = РегистрыСведений.ДатаМобайл_НовыеШтрихкоды.СоздатьНаборЗаписей();
		лНЗ.Отбор.ШтрихКод.Установить(ШК);
		лНЗ.Прочитать();
		лНЗ.Очистить();
		лШК = лНЗ.Добавить();
		
		лШК.Номенклатура   = лТовар;
		лШК.Характеристика = лХарактеристикаНоменклатуры;
		лШК.ШтрихКод       = ШК;
		лШК.Пользователь   = UserName;
		лШК.Наименование   = Barcode.Получить("unit_name");
		лШК.Коэффициент    = Barcode.Получить("unit_coef");
		Попытка
			лНЗ.ОбменДанными.Получатели.АвтоЗаполнение = Ложь;
			лНЗ.ОбменДанными.Получатели.Заполнить();
			лНЗ.ОбменДанными.Получатели.Удалить(УзелПО);
			лНЗ.Записать(Истина);
		Исключение		
			СтруктураОтвета.Вставить("Описание", "Не удалось добавить штрихкод. " + ОписаниеОшибки());	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
		Конецпопытки;	
	КонецЕсли;
	
	Возврат ПодготовитьОтветJSON(Barcode); 
	
КонецФункции

// Удаление штрихкода товара.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// ArtID - Строка - Id товара.
// Barcode - Строка - Штрихкод.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция DeleteBarcode(SN, UserName, ArtID, Barcode) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если Лев(ArtID, 3) = "8U-" Тогда
		Если Не РазрешеноРедактированиеШтрихкода(УзелПО, UserName) Тогда		
			СтруктураОтвета.Вставить("Описание", "Пользователю ТСД в настройках роли в АРМ не разрешено редактирование штрихкодов.");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
		
		Если Не УзелПО.ЗаписьВРегистр Тогда		
			СтруктураОтвета.Вставить("Описание", "Не включена автоматическая привязка новых ШК в настройках устройства в АРМ 1С.");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
		КонецЕсли;
		
		лТовар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));
		ИДХК = Сред(ArtID, 40, 36);
		
		Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
			лХарактеристикаНоменклатуры = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);
		Иначе
			лХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка(); 
		КонецЕсли;
		
	ИначеЕсли Лев(ArtID, 3) = "8n-" Тогда
		лТовар = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_НовыеТовары"), Сред(ArtID, 4));
		лХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка(); 
	Иначе			
		СтруктураОтвета.Вставить("Описание", "Не найдена номенклатура. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	Если Не Модуль_ОбщегоНазначения.СсылкаСуществует(лТовар) Тогда
		СтруктураОтвета.Вставить("Описание", "Не удалось найти товар, возможно он был уже создан, обновите справочник товаров на устройстве и повторите попытку. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
	КонецЕсли;
	
	ШК = Barcode;
	
	Если УзелПО.ЗаписьВРегистр Тогда
		лНЗ = РегистрыСведений.ШтрихкодыНоменклатуры.СоздатьНаборЗаписей();	
	Иначе
		лНЗ = РегистрыСведений.ДатаМобайл_НовыеШтрихкоды.СоздатьНаборЗаписей();		
	КонецЕсли;
	
	лНЗ.Отбор.ШтрихКод.Установить(ШК);
	лНЗ.Прочитать();
	лНЗ.Очистить();
	
	Попытка
		лНЗ.ОбменДанными.Получатели.АвтоЗаполнение = Ложь;
		лНЗ.ОбменДанными.Получатели.Заполнить();
		лНЗ.ОбменДанными.Получатели.Удалить(УзелПО);
		лНЗ.Записать(Истина);
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Не удалось удалить штрихкод. " + ОписаниеОшибки());	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	Конецпопытки;
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Получение списка наименований дополнительных типов цен.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetArtsPricesNames(SN, UserName) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли; 
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ВЫБОР КОГДА НЕ СписокТСД.ТипЦенДоп1 = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка) ТОГДА ПРЕДСТАВЛЕНИЕ(СписокТСД.ТипЦенДоп1) ИНАЧЕ """" КОНЕЦ КАК ТипЦенДоп1,
	|	ВЫБОР КОГДА НЕ СписокТСД.ТипЦенДоп2 = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка) ТОГДА ПРЕДСТАВЛЕНИЕ(СписокТСД.ТипЦенДоп2) ИНАЧЕ """" КОНЕЦ КАК ТипЦенДоп2,
	|	ВЫБОР КОГДА НЕ СписокТСД.ТипЦенДоп3 = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка) ТОГДА ПРЕДСТАВЛЕНИЕ(СписокТСД.ТипЦенДоп3) ИНАЧЕ """" КОНЕЦ КАК ТипЦенДоп3
	|ИЗ
	|	ПланОбмена.ДатаМобайл_СписокТСД КАК СписокТСД
	|ГДЕ
	|	СписокТСД.Ссылка = &ТСД");
	Запрос.УстановитьПараметр("ТСД", УзелПО);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ОбъектТипыЦен = ПолучитьСтруктуруОбъектаДляHttp("prices_names"); 
	
	Если Выборка.Следующий() Тогда
		ОбъектТипыЦен.price_1 = Выборка.ТипЦенДоп1;
		ОбъектТипыЦен.price_2 = Выборка.ТипЦенДоп2;
		ОбъектТипыЦен.price_3 = Выборка.ТипЦенДоп3;
	КонецЕсли;
	
	СтруктураОтвета.Вставить("prices_names", ОбъектТипыЦен);
	
	Возврат ПодготовитьОтветJSON(ОбъектТипыЦен);

КонецФункции

// Получение порции товаров для выгрузки в ПО.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// КоличествоТоваровВПорции - Число - Количество товаров в порции.
//
// Возвращаемое значение:
//   МассивКВыгрузке - Массив - Массив товаров для выгрузки.
// 	
Функция ПолучитьПорциюТоваров(УзелПО, КоличествоТоваровВПорции, НомерПакета = 0)
	
	Запрос = Новый Запрос;
	Запрос.Текст =           
	"ВЫБРАТЬ ПЕРВЫЕ &КоличествоТоваровВПорции
	|	ДатаМобайл_ПорционнаяВыгрузка.ОбъектВыгрузки КАК Номенклатура
	|ИЗ
	|	РегистрСведений.ДатаМобайл_ПорционнаяВыгрузка КАК ДатаМобайл_ПорционнаяВыгрузка
	|ГДЕ
	|	ДатаМобайл_ПорционнаяВыгрузка.ТСД = &ТСД
	|	И ТипОбъекта = 1
	|	&УсловиеПоНомеруПакета";
	Запрос.УстановитьПараметр("ТСД", УзелПО); 
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&КоличествоТоваровВПорции", Формат(КоличествоТоваровВПорции, "ЧГ="));
	
	Если НомерПакета = 0 Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеПоНомеруПакета", ""); 
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеПоНомеруПакета", "И НомерПакета = &НомерПакета");
		Запрос.УстановитьПараметр("НомерПакета", НомерПакета);
	КонецЕсли;
	РезультатЗапроса = Запрос.Выполнить();	
	
	Если Не РезультатЗапроса.Пустой() Тогда      					
		МассивКВыгрузке = РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("Номенклатура");
	Иначе
		МассивКВыгрузке = Новый Массив;	
	КонецЕсли;                         
	
	Возврат МассивКВыгрузке;
	
КонецФункции	

Функция ПолучитьУпаковкуДляШтрихкода(лТовар, ЕдИзмерения, УпаковкаНачальная)
	
	УпаковкаНовая = УпаковкаНачальная;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	УпаковкиЕдиницыИзмерения.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиЕдиницыИзмерения
	|ГДЕ
	|	УпаковкиЕдиницыИзмерения.Владелец = &Владелец
	|	И УпаковкиЕдиницыИзмерения.ЕдиницаИзмерения.Наименование = &Наименование
	|	И НЕ УпаковкиЕдиницыИзмерения.ПометкаУдаления";
	
	Запрос.УстановитьПараметр("Владелец", лТовар);
	Запрос.УстановитьПараметр("Наименование", ЕдИзмерения);
	
	Выборка = Запрос.Выполнить().Выбрать();
		
	Если Выборка.Следующий() Тогда
		УпаковкаНовая = Выборка.Ссылка;
	КонецЕсли;
	
	Возврат УпаковкаНовая; 
	
КонецФункции

#КонецОбласти

#Область Packs

// Создание упаковочного листа.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocID - Строка - Id документа ТСД.
//
// 
// Возвращаемое значение:
//   JSON со структурой данных.
// 
Функция OnNewPack(SN, UserName, DocID) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocID, 5));	
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не нашли документ.  ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;	
	Шаблон = СсылкаНаДок.Шаблон;

	// Zolla ++
	Если Шаблон.ДМ_ОтгрузкаИзМагазина Тогда	
		Возврат ДМ_OnNewPack(УзелПО, UserName, Шаблон, СсылкаНаДок);
	// Zolla --
		
	ИначеЕсли Шаблон.ИспользоватьМаркировку Тогда
		
		Если УзелПО.ПрефиксКомпанииGS1 = 0 Тогда		
			СтруктураОтвета.Вставить("Описание", "В настройках терминала не задан параметр: ПрефиксКомпанииGS1. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
		
		СледующийНомерSSCC = ДатаМобайл_Маркировка.ПолучитьСледующийНомерSSCC(УзелПО.ЦифраРасширения, УзелПО.ПрефиксКомпанииGS1);
		
		ДатаМобайл_Маркировка.СоздатьСправочникСсылкаУпаковка(СледующийНомерSSCC);
		
		Если Лев(СледующийНомерSSCC, 4) = "(00)" Тогда
			СледующийНомерSSCC = "[00]" + Сред(СледующийНомерSSCC, 5);
		КонецЕсли;
		СтруктураОтвета.Вставить("data", СледующийНомерSSCC);
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		
	Иначе
		ДокументУпаковочногоЛиста = Документы.ДатаМобайл_УпаковочныйЛист.СоздатьДокумент();
		ДокументУпаковочногоЛиста.Дата = ТекущаяДата();
		
		Если ЗначениеЗаполнено(СсылкаНаДок.ИсходныйДокумент) Тогда
			ДокументУпаковочногоЛиста.Основание = СсылкаНаДок.ИсходныйДокумент;
		Иначе
			ДокументУпаковочногоЛиста.Основание = СсылкаНаДок;
		КонецЕсли;
		
		ДокументУпаковочногоЛиста.Ответственный = Справочники.Пользователи.НайтиПоНаименованию(UserName, Ложь);
		ДокументУпаковочногоЛиста.ТСД = УзелПО;
		ДокументУпаковочногоЛиста.Записать();
		
		Если Шаблон.ИспользоватьТиповыеУпаковочныеЛисты Тогда
			ДокументУпаковочногоЛистаТиповой = Документы.УпаковочныйЛист.СоздатьДокумент();	
			ДокументУпаковочногоЛистаТиповой.Дата = ТекущаяДата();
			ДокументУпаковочногоЛистаТиповой.Вид = Перечисления.ВидыУпаковочныхЛистов.Исходящий;
			ДокументУпаковочногоЛистаТиповой.Код = ДокументУпаковочногоЛиста.Номер;
			Попытка ДокументУпаковочногоЛистаТиповой.Упаковал = ДокументУпаковочногоЛиста.Ответственный; Исключение КонецПопытки;			 
			Попытка ДокументУпаковочногоЛистаТиповой.СкладУпаковки = СсылкаНаДок.Склад; Исключение КонецПопытки;
			
			Если ЗначениеЗаполнено(СсылкаНаДок.ИсходныйДокумент) Тогда
				Если СсылкаНаДок.Шаблон.ВидДокумента = "РасходныйОрдерНаТовары" Тогда  
					Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
					Модуль_ПрефиксацияОбъектовКлиентСервер = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ПрефиксацияОбъектовКлиентСервер");
					РеквизитыОрдера = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок.ИсходныйДокумент, "Получатель, Номер");
					Основание = НСтр("ru = '%Получатель% / Ордер %Номер%'");
					Основание = СтрЗаменить(Основание,"%Получатель%",РеквизитыОрдера.Получатель);
					Основание = СтрЗаменить(Основание,"%Номер%",Модуль_ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(РеквизитыОрдера.Номер));	
					ДокументУпаковочногоЛистаТиповой.Основание =  Основание;
				Иначе
					ДокументУпаковочногоЛистаТиповой.Основание =  СсылкаНаДок.ИсходныйДокумент;
				КонецЕсли;
			КонецЕсли;	
			
			ДокументУпаковочногоЛистаТиповой.Записать();	
			
			Попытка
				ДокументУпаковочногоЛиста.ТиповойУпаковочныйЛист = ДокументУпаковочногоЛистаТиповой.Ссылка;
				ДокументУпаковочногоЛиста.Записать();
			Исключение 
			КонецПопытки;
		КонецЕсли;	
		
		Рез = "UPL" + ДокументУпаковочногоЛиста.Номер; 
		
		СтруктураОтвета.Вставить("data", Рез);
		
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);		
	КонецЕсли;
	
КонецФункции

// Получение данных упаковочного листа при сканировании.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// Barcode - Строка - Штрихкод упаковки.
// DocID - Строка - Id документа ТСД.
// Cell - Строка - Штрихкод ячейки.
// gs1 - Строка - Данные gs1.
//
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция OnPalletScan(SN, UserName, Barcode, DocOutID, Cell, gs1) Экспорт 
	
	ОбъектСписка = Новый Массив; 
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Не нашли документ.");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда		
		СтруктураОтвета.Вставить("Описание", "Не нашли документ.");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	
	
	Если Не СсылкаНаДок.ТСД.Пустая() Тогда
		Если СсылкаНаДок.ТСД <> УзелПО Тогда			
			СтруктураОтвета.Вставить("Описание", "Чужой документ.");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;	
	
	Если СсылкаНаДок.ДатаЗавершенияСбора <> Дата(1,1,1) Тогда	
		СтруктураОтвета.Вставить("Описание", "Закрытый документ.");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
	КонецЕсли;
	
	// проверка отсканирования упаковки
	БылоСканирование = БылоСканированиеУпаковкиВЭтомДокументе(Barcode, СсылкаНаДок);
	Если БылоСканирование Тогда
		СтруктураОтвета.Вставить("Описание", "Упаковка в документе ранее уже была отсканирована.");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
	КонецЕсли;
	
	Шаблон = СсылкаНаДок.Шаблон;	
	
	Если Шаблон.ИспользоватьМаркировку Тогда		
		Если ДатаМобайл_ОбщийМодуль.ЕстьМДЛП() Тогда
			ЭтоДокументМДЛП = ДатаМобайл_МДЛП.ЭтоДокументМДЛП(Шаблон.ВидДокумента);
		Иначе
			ЭтоДокументМДЛП = Ложь;
		КонецЕсли;	
		
		Если ЗначениеЗаполнено(GS1) Тогда
			ПолучитьСодержимоеУпаковки_Маркировка(УзелПО, СсылкаНаДок, ОбъектСписка, GS1, ЭтоДокументМДЛП);
		КонецЕсли;
		
		Если ОбъектСписка.Количество() = 0 Тогда
			ПолучитьСодержимоеУпаковки_Маркировка(УзелПО, СсылкаНаДок, ОбъектСписка, Barcode, ЭтоДокументМДЛП);
		КонецЕсли;		
	КонецЕсли;
	
	Если ЗначениеЗаполнено(GS1) И ОбъектСписка.Количество() = 0 Тогда
		ПолучитьСодержимоеУпаковки_НашУпаковочныйЛист(УзелПО, СсылкаНаДок, ОбъектСписка, GS1);
	КонецЕсли;
	
	Если ОбъектСписка.Количество() = 0 Тогда
		ПолучитьСодержимоеУпаковки_НашУпаковочныйЛист(УзелПО, СсылкаНаДок, ОбъектСписка, Barcode);
	КонецЕсли;
	
	Если ОбъектСписка.Количество() = 0 Тогда
		ПолучитьСодержимоеУпаковки_ТиповойУпаковочныйЛист(УзелПО, СсылкаНаДок, ОбъектСписка, Barcode)
	КонецЕсли;
	
	//Попробуем получить результат маркировки в обычных документах
	Если ОбъектСписка.Количество() = 0 И Не Шаблон.ИспользоватьМаркировку Тогда
		Если ДатаМобайл_ОбщийМодуль.ЕстьМаркировка() Тогда		 
			Если ДатаМобайл_ОбщийМодуль.ЕстьМДЛП() Тогда
				ЭтоДокументМДЛП = ДатаМобайл_МДЛП.ЭтоДокументМДЛП(Шаблон.ВидДокумента);
			Иначе
				ЭтоДокументМДЛП = Ложь;
			КонецЕсли;	
			
			ПолучитьСодержимоеУпаковки_Маркировка(УзелПО, СсылкаНаДок, ОбъектСписка, Barcode, ЭтоДокументМДЛП, Истина);
			
		КонецЕсли;	 
	КонецЕсли;
		
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

Функция OnPalletScan_Verify(docs_pacs) Экспорт  
	
	СтруктураОтвета = Новый Структура;
	
	Для Каждого Строка Из docs_pacs Цикл
		
		Попытка
			СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(Строка.doc_id, 5));	
		Исключение		
			СтруктураОтвета.Вставить("Описание", "Не нашли документ.");	
			Возврат ПодготовитьОтветJSON(,СтруктураОтвета);
		КонецПопытки;
		
		Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда		
			СтруктураОтвета.Вставить("Описание", "Не нашли документ.");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
		
		Если СсылкаНаДок.ДатаЗавершенияСбора <> Дата(1,1,1) Тогда	
			СтруктураОтвета.Вставить("Описание", "Закрытый документ.");	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
		КонецЕсли;	
		
		Шаблон = СсылкаНаДок.Шаблон;     
		
		Если Шаблон.ПроверкаВводаУпаковочногоЛистаПодбор Тогда
			
			Если ЗначениеЗаполнено(Строка.pack_barcode) Тогда
				//проверка	
			КонецЕсли;	
			
		КонецЕсли;
		
		Если Шаблон.ПроверкаВводаУпаковочногоЛистаПриемка Тогда
			
			Если ЗначениеЗаполнено(Строка.pack_barcode) Тогда
				//проверка	
			КонецЕсли;	 	 
			
		КонецЕсли;  
		
	КонецЦикла;  
	
	СтруктураОтвета.Вставить("is_success", Истина);
		
	Возврат ПодготовитьОтветJSON(СтруктураОтвета); 
	
КонецФункции	 

#КонецОбласти

#Область Cells

// Получение данных ячеек.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// CellBC - Строка - Штрихкод ячейки.
// doc_id - Строка - Id документа ТСД.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//   
Функция GetCellContent(SN, UserName, CellBC, doc_id = "") Экспорт
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	    
	
	Если ЗначениеЗаполнено(doc_id) Тогда
		Попытка
			СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(doc_id, 5));	
		Исключение		
			СтруктураОтвета.Вставить("Описание", "Не нашли документ.");	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецПопытки;
	КонецЕсли;	
	
	ТипЦен = УзелПО.ТипЦен;
	ВключатьАртикул = УзелПО.ДобавлятьАртикулВНаименование;    
	
	Если ЗначениеЗаполнено(doc_id) Тогда 
		ТекущаяЯчейка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(CellBC, СсылкаНаДок);
	Иначе	
		ТекущаяЯчейка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(CellBC);
	КонецЕсли;	
	
	Если ТекущаяЯчейка.Наименование = "" Тогда	
		СтруктураОтвета.Вставить("Описание", "Ячейка по штрихкоду " + CellBC + " не найдена в базе. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Запрос = Новый Запрос;
	
	Запрос.Текст = "ВЫБРАТЬ
	|	ТоварыВЯчейкахОстатки.Номенклатура,
	|	ТоварыВЯчейкахОстатки.Характеристика,
	|	ТоварыВЯчейкахОстатки.Упаковка,
	|	ТоварыВЯчейкахОстатки.Серия,
	|	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток)- СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) КАК Количество
	|ПОМЕСТИТЬ ДоступныеТовары
	|ИЗ
	|	РегистрНакопления.ТоварыВЯчейках.Остатки КАК ТоварыВЯчейкахОстатки
	|ГДЕ
	|	ТоварыВЯчейкахОстатки.Ячейка = &Ячейка
	|СГРУППИРОВАТЬ ПО
	|	ТоварыВЯчейкахОстатки.Номенклатура,
	|	ТоварыВЯчейкахОстатки.Характеристика,
	|	ТоварыВЯчейкахОстатки.Упаковка,
	|	ТоварыВЯчейкахОстатки.Серия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) КАК ЧИСЛО(19, 2))) КАК Цена
	|ПОМЕСТИТЬ ТоварыСЦенами
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ТекущаяДата, ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
	|		ПО ДоступныеТовары.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
	|			И ДоступныеТовары.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
	|
	|СГРУППИРОВАТЬ ПО
	|	ДоступныеТовары.Номенклатура,
	|	ДоступныеТовары.Характеристика,
	|	ДоступныеТовары.Упаковка
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура, 
	|	ДоступныеТовары.Номенклатура.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
	|	ДоступныеТовары.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
	|	ДоступныеТовары.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,
	|	ДоступныеТовары.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	|	ДоступныеТовары.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
	|	ДоступныеТовары.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ДоступныеТовары.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,  
	|	ДоступныеТовары.Характеристика КАК Характеристика,   
	|	ДоступныеТовары.Характеристика.Наименование КАК НаименованиеХарактеристики,	 
	|   ДоступныеТовары.Серия КАК Серия,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|   ДоступныеТовары.Количество КАК Количество,
	|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена,
	|	ЕСТЬNULL(ДоступныеТовары.Упаковка.Наименование, ДоступныеТовары.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
	|	ЕСТЬNULL(ДоступныеТовары.Упаковка.Числитель, 1) КАК Коэффициент,
	|	ВЫБОР
	|		КОГДА &ВключатьАртикул
	|				И ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(Справочник.Номенклатура)
	|			ТОГДА ВЫБОР
	|					КОГДА ДоступныеТовары.Номенклатура.Артикул = """"
	|						ТОГДА """"
	|					ИНАЧЕ ДоступныеТовары.Номенклатура.Артикул + "" ""
	|				КОНЕЦ
	|		ИНАЧЕ """"
	|	КОНЕЦ + ДоступныеТовары.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ДоступныеТовары.Характеристика.Наименование, """") КАК НаименованиеТовара,
	|	ЛОЖЬ КАК ЭтоНовыйТовар
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
	|		ПО ДоступныеТовары.Номенклатура = ТоварыСЦенами.Номенклатура
	|			И ДоступныеТовары.Характеристика = ТоварыСЦенами.Характеристика
	|			И ДоступныеТовары.Упаковка = ТоварыСЦенами.Упаковка
	|";
	
	СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "GetCellContent");
	
	Запрос.УстановитьПараметр("Ячейка", ТекущаяЯчейка);
	Запрос.УстановитьПараметр("ТипЦен", ТипЦен);         	
	Запрос.УстановитьПараметр("ВсеУпаковки", Истина);
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	Запрос.УстановитьПараметр("ВключатьАртикул", ВключатьАртикул);
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());
	
	Рез = Запрос.Выполнить().Выгрузить(); 
	
	Для каждого СтрокаДока Из Рез Цикл 
		
		СтрокаДока.Коэффициент = ?(СтрокаДока.Коэффициент = 0, 1, СтрокаДока.Коэффициент);
		Итог = СтрокаДока.Количество * СтрокаДока.Коэффициент;
		
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan");
		ОбъектТовара.name = ЧистаяСтрока(СокрП(СтрокаДока.НаименованиеТовара));
		ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
		ОбъектТовара.price = СтрокаДока.Цена; 
		
		// Выгрузка дополнительных видов цен
		ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Характеристика);
		
		Попытка 			 
			DMUseSN = ПолучитьПризнакУчетаСерий(СтрокаДока.ВидНоменклатуры, Справочники.Склады.ПустаяСсылка());
		Исключение
			DMUseSN = Ложь;
		КонецПопытки;	 
		
		СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, СтрокаДока, DMUseSN);
		
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		// Штрихкод
		Попытка
			ТекущийШтрихкод = ПолучитьШтрихкодУпаковки(СтрокаДока.Номенклатура, СтрокаДока.Характеристика, СтрокаДока.Упаковка);
			
			Если ЗначениеЗаполнено(ТекущийШтрихкод) Тогда					
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","unit_value");
				ОбъектШтрихкода.value = ЧистаяСтрока(ТекущийШтрихкод);
			Иначе
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");	
			КонецЕсли;	
			
			ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура);
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
		Исключение
		Конецпопытки;
		
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда
				Шаблон = Новый Структура();
				СтруктураТекущейСтроки.Вставить("СерииРассчитыватьГоденДо", Истина);
				
				sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		Иначе
			limit_qty = Итог;
		КонецЕсли;
		
		// Количество в базовых
		qty = СтрокаДока.Количество * СтрокаДока.Коэффициент; 
		
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		СтруктураТекущейСтроки.Вставить("qty", qty);
		Попытка
			СтруктураТекущейСтроки.Вставить("unit_qty", qty / ОбъектШтрихкода.unit_coef);
		Исключение
			СтруктураТекущейСтроки.Вставить("unit_qty", qty);
		КонецПопытки;
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки); 
		
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение остатков товара в ячейках (подбор).
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocID - Строка - Id документа ТСД.
// ArtID - Строка - Id товара. 
// art_sn - Строка - Серийных номер товара.
// pack - Строка - Упаковочный лист
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//  
Функция GetArtCellsSelect(SN, UserName, DocID, ArtID, art_sn, pack) Экспорт 
	
	ОбъектСписка = Новый Массив;	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);	
	Если УзелПО = Неопределено Тогда		
		УзелПО = NewTSD(SN, UserName);		
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocID, 5));	
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Не нашли документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	ЗначенияРеквизитовСсылкаНаДок = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок,"ТСД,ДатаНачалаСбора,ДатаЗавершенияСбора,Шаблон,ИсходныйДокумент,Склад,Помещение");
	ДокТСД 					= ЗначенияРеквизитовСсылкаНаДок.ТСД;
	ДокДатаНачалаСбора 		= ЗначенияРеквизитовСсылкаНаДок.ДатаНачалаСбора;
	ДокДатаЗавершенияСбора 	= ЗначенияРеквизитовСсылкаНаДок.ДатаЗавершенияСбора;
	Шаблон 					= ЗначенияРеквизитовСсылкаНаДок.Шаблон;
	ИсходныйДокумент 		= ЗначенияРеквизитовСсылкаНаДок.ИсходныйДокумент;
	ТекущийСклад  			= ЗначенияРеквизитовСсылкаНаДок.Склад;
	ТекущееПомещение 		= ЗначенияРеквизитовСсылкаНаДок.Помещение;
	
	Если Шаблон = Неопределено Тогда	
		СтруктураОтвета.Вставить("Описание", "Не нашли запись документа. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ArtID) и НЕ ЗначениеЗаполнено(pack) Тогда 
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ArtID) Тогда
		
		Если Лев(ArtID, 3) = "8U-" Тогда
			лТовар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));
			ИДХК = Сред(ArtID, 40, 36);
			Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
				лХарактеристикаНоменклатуры = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);
			Иначе
				лХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
			КонецЕсли;
		Иначе   
			Возврат ПодготовитьОтветJSON(ОбъектСписка);
		КонецЕсли;
		
		Если Шаблон.ИспользованиеСерийниковПодбор > 0 Тогда		
			snValues = art_sn;
			
			СтруктураСтроки = Новый Структура;
			СтруктураСтроки.Вставить("ДокументТСД", СсылкаНаДок);
			СтруктураСтроки.Вставить("ИмяТаблицы", "Select");	
			СтруктураСтроки.Вставить("СерийныйНомер",snValues);
			СтруктураСтроки.Вставить("Номенклатура", лТовар);
			СтруктураСтроки.Вставить("КМСсылка", Справочники.ШтрихкодыУпаковокТоваров.ПустаяСсылка());
			СтруктураСтроки.Вставить("KM_DecodedMrc", "");
			СтруктураСтроки.Вставить("СерияСсылка", Справочники.СерииНоменклатуры.ПустаяСсылка());
			
			Попытка ОпределитьСериюВСтрокеДокумента(Шаблон, СтруктураСтроки, Ложь, УзелПО); Исключение КонецПопытки;
			
			лСерия = СтруктураСтроки.СерияСсылка;
			ВсеСерии = Ложь;
		Иначе	
			лСерия = Справочники.СерииНоменклатуры.ПустаяСсылка();
			ВсеСерии = Истина;
		КонецЕсли;
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("лТовар", лТовар);  
		
		СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
		Если ЗначениеЗаполнено(ТекущийСклад) Тогда	
			СписокСкладов.Очистить();
			СписокСкладов.Добавить(ТекущийСклад);			
		КонецЕсли;	
		Запрос.УстановитьПараметр("Склады", СписокСкладов);
		Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
		
		СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
		Если ЗначениеЗаполнено(ТекущееПомещение) Тогда	
			СписокПомещений.Очистить();
			СписокПомещений.Добавить(ТекущееПомещение);			
		КонецЕсли;	
		Запрос.УстановитьПараметр("Помещения", СписокПомещений);
		Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
		
		Если Шаблон.ЯчейкиСправочноеРазмещениеПодбор Тогда
			ТекстЗапроса = "ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
			|	ТоварыВЯчейках.Ячейка КАК Ссылка
			|ИЗ
			|	РегистрСведений.РазмещениеНоменклатурыПоСкладскимЯчейкам КАК ТоварыВЯчейках
			|ГДЕ
			|	ТоварыВЯчейках.Номенклатура = &лТовар
			|   И (&ВсеПомещения ИЛИ ТоварыВЯчейках.Помещение В (&Помещения)) 
			|   И (&ВсеСклады ИЛИ ТоварыВЯчейках.Склад В (&Склады))
			|"; 		
		Иначе		
			ТекстЗапроса = "ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ТоварыВЯчейкахОстатки.Ячейка.Ссылка КАК Ссылка
			|ИЗ
			|	РегистрНакопления.ТоварыВЯчейках.Остатки КАК ТоварыВЯчейкахОстатки
			|ГДЕ
			|	ТоварыВЯчейкахОстатки.Номенклатура = &лТовар
			|	И ТоварыВЯчейкахОстатки.Характеристика = &лХарактеристикаНоменклатуры
			|	И (&ВсеСерии ИЛИ ТоварыВЯчейкахОстатки.Серия = &лСерия)
			|	И ТоварыВЯчейкахОстатки.Ячейка.ТипСкладскойЯчейки = &Хранение
			|   И (&ВсеПомещения ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Помещение В (&Помещения)) 
			|   И (&ВсеСклады ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Владелец В (&Склады))";
			
			Запрос.УстановитьПараметр("лХарактеристикаНоменклатуры", лХарактеристикаНоменклатуры);
			Запрос.УстановитьПараметр("ВсеСерии", ВсеСерии);
			Запрос.УстановитьПараметр("лСерия", лСерия);
			Запрос.УстановитьПараметр("Хранение", Перечисления.ТипыСкладскихЯчеек.Хранение);
		КонецЕсли;
		
		Запрос.Текст = ТекстЗапроса;	
		Рез = Запрос.Выполнить().Выбрать(); 
		
		Пока Рез.Следующий() Цикл	 
			СтруктураТекущейСтроки = Новый Структура;
			
			ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell");					 
			ОбъектЯчейки.name = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0, ЧистаяСтрока(Рез.Ссылка.Наименование), Рез.Ссылка.Код);
			Модуль_ШтрихкодированиеПечатныхФорм = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ШтрихкодированиеПечатныхФорм");
			ОбъектЯчейки.barcode = ?(УзелПО.ВыгружатьВКодЯчейки = 1, Строка(Рез.Ссылка.Код), Строка(Модуль_ШтрихкодированиеПечатныхФорм.ЧисловойКодПоСсылке(Рез.Ссылка)));		 
			СтруктураТекущейСтроки.Вставить("cell", ОбъектЯчейки);
			
			limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, лТовар, лХарактеристикаНоменклатуры, Рез.Ссылка, Неопределено);
			СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
			СтруктураТекущейСтроки.Вставить("task_qty",  limit_qty);
			
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);	 
		КонецЦикла;	
	Иначе  
		
		Запрос = Новый Запрос; 	 
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ  
		|     ДатаМобайл_УпаковочныйЛистТовары.Номенклатура,
		|	  ДатаМобайл_УпаковочныйЛистТовары.Характеристика,
		|     ДатаМобайл_УпаковочныйЛистТовары.Серия
		|ПОМЕСТИТЬ ДоступныеТовары
		|ИЗ 
		|     Документ.ДатаМобайл_УпаковочныйЛист.Товары КАК ДатаМобайл_УпаковочныйЛистТовары 
		|ГДЕ 
		|	(ДатаМобайл_УпаковочныйЛистТовары.Ссылка.Номер = &КодУпакЛиста
		|			ИЛИ ДатаМобайл_УпаковочныйЛистТовары.Ссылка.Код = &КодУпакЛиста) И НЕ ДатаМобайл_УпаковочныйЛистТовары.Ссылка.ПометкаУдаления 
		| 
		|СГРУППИРОВАТЬ ПО 
		|     ДатаМобайл_УпаковочныйЛистТовары.Номенклатура,
		|	  ДатаМобайл_УпаковочныйЛистТовары.Характеристика,
		|     ДатаМобайл_УпаковочныйЛистТовары.Штрихкод,
		|	  ДатаМобайл_УпаковочныйЛистТовары.Упаковка,
		|	  ДатаМобайл_УпаковочныйЛистТовары.Серия  
		|	  
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ 
		|     УпаковочныйЛистТовары.Номенклатура,
		|	  УпаковочныйЛистТовары.Характеристика,
		|     УпаковочныйЛистТовары.Серия
		|ИЗ 
		|     Документ.УпаковочныйЛист.Товары КАК УпаковочныйЛистТовары 
		|ГДЕ 
		|	(УпаковочныйЛистТовары.Ссылка.Код = &КодУпакЛиста)  И НЕ УпаковочныйЛистТовары.Ссылка.ПометкаУдаления 
		| 
		|СГРУППИРОВАТЬ ПО 
		|     УпаковочныйЛистТовары.Номенклатура,
		|	  УпаковочныйЛистТовары.Характеристика,
		|	  УпаковочныйЛистТовары.Упаковка,
		|	  УпаковочныйЛистТовары.Серия
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ 
		|	ДоступныеТовары.Номенклатура,
		|	ДоступныеТовары.Характеристика,
		|	ТоварыВЯчейках.Ячейка КАК Ссылка
		|ИЗ
		|	ДоступныеТовары КАК ДоступныеТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РазмещениеНоменклатурыПоСкладскимЯчейкам КАК ТоварыВЯчейках
		|		ПО ТоварыВЯчейках.Номенклатура = ДоступныеТовары.Номенклатура
		|   		И (&ВсеПомещения ИЛИ ТоварыВЯчейках.Помещение В (&Помещения)) 
		|   		И (&ВсеСклады ИЛИ ТоварыВЯчейках.Склад В (&Склады))
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ДоступныеТовары.Номенклатура,
		|	ДоступныеТовары.Характеристика,
		|   ТоварыВЯчейкахОстатки.Ячейка КАК Ссылка
		|ИЗ
		|	ДоступныеТовары КАК ДоступныеТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыВЯчейках.Остатки КАК ТоварыВЯчейкахОстатки
		|		ПО ТоварыВЯчейкахОстатки.Номенклатура = ДоступныеТовары.Номенклатура
		|			И ТоварыВЯчейкахОстатки.Характеристика = ДоступныеТовары.Характеристика
		|			И (&ВсеСерии ИЛИ ТоварыВЯчейкахОстатки.Серия = ДоступныеТовары.Серия)
		|			И ТоварыВЯчейкахОстатки.Ячейка.ТипСкладскойЯчейки = &Хранение
		|   		И (&ВсеПомещения ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Помещение В (&Помещения)) 
		|   		И (&ВсеСклады ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Владелец В (&Склады))
		|";
		
		Если Лев(pack,3) = "UPL" Тогда 
			КодУпакЛиста = Прав(pack, СтрДлина(pack) - 3); 
		Иначе     
			КодУпакЛиста = pack; 
		КонецЕсли; 
		
		Запрос.УстановитьПараметр("КодУпакЛиста", КодУпакЛиста);
		Запрос.УстановитьПараметр("Хранение", Перечисления.ТипыСкладскихЯчеек.Хранение);
		
		СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
		Если ЗначениеЗаполнено(ТекущийСклад) Тогда	
			СписокСкладов.Очистить();
			СписокСкладов.Добавить(ТекущийСклад);			
		КонецЕсли;	
		Запрос.УстановитьПараметр("Склады", СписокСкладов);
		Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
		
		СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
		Если ЗначениеЗаполнено(ТекущееПомещение) Тогда	
			СписокПомещений.Очистить();
			СписокПомещений.Добавить(ТекущееПомещение);			
		КонецЕсли;	
		Запрос.УстановитьПараметр("Помещения", СписокПомещений);
		Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
		
		Если Шаблон.ИспользованиеСерийниковПодбор > 0 Тогда
			ВсеСерии = Ложь;
		Иначе	
			ВсеСерии = Истина;
		КонецЕсли; 
		Запрос.УстановитьПараметр("ВсеСерии", ВсеСерии);
		
		Рез = Запрос.Выполнить().Выбрать(); 
		
		Пока Рез.Следующий() Цикл
			
			Если НЕ ЗначениеЗаполнено(Рез.Ссылка) тогда 
				Продолжить;
			КонецЕсли;	  
			
			СтруктураТекущейСтроки = Новый Структура;
			
			ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell");		 
			ОбъектЯчейки.name = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0, ЧистаяСтрока(Рез.Ссылка.Наименование), Рез.Ссылка.Код);
			Модуль_ШтрихкодированиеПечатныхФорм = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ШтрихкодированиеПечатныхФорм");
			ОбъектЯчейки.barcode = ?(УзелПО.ВыгружатьВКодЯчейки = 1, Строка(Рез.Ссылка.Код), Строка(Модуль_ШтрихкодированиеПечатныхФорм.ЧисловойКодПоСсылке(Рез.Ссылка)));	 
			СтруктураТекущейСтроки.Вставить("cell", ОбъектЯчейки);
			
			limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, Рез.Номенклатура, Рез.Характеристика, Рез.Ссылка, Неопределено);
			СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
			СтруктураТекущейСтроки.Вставить("task_qty",  limit_qty);
			
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		КонецЦикла;	

	КонецЕсли; 
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение остатков товара в ячейках (приемка).
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocID - Строка - Id документа ТСД.
// ArtID - Строка - Id товара.
// art_sn - Строка - Серийных номер товара.
// pack - Строка - Упаковочный лист
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//  
Функция GetArtCellsInsert(SN, UserName, DocID, ArtID, art_sn, pack) Экспорт 
	
	ОбъектСписка = Новый Массив;	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocID, 5));	
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не нашли документ. ");	
		Возврат ПодготовитьОтветJSON(,СтруктураОтвета);
	КонецПопытки;
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	ЗначенияРеквизитовСсылкаНаДок = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок,"ТСД,ДатаНачалаСбора,ДатаЗавершенияСбора,Шаблон,ИсходныйДокумент,Склад,Помещение");
	ДокТСД 					= ЗначенияРеквизитовСсылкаНаДок.ТСД;
	ДокДатаНачалаСбора 		= ЗначенияРеквизитовСсылкаНаДок.ДатаНачалаСбора;
	ДокДатаЗавершенияСбора 	= ЗначенияРеквизитовСсылкаНаДок.ДатаЗавершенияСбора;
	Шаблон 					= ЗначенияРеквизитовСсылкаНаДок.Шаблон;
	ИсходныйДокумент 		= ЗначенияРеквизитовСсылкаНаДок.ИсходныйДокумент;
	ТекущийСклад  			= ЗначенияРеквизитовСсылкаНаДок.Склад;
	ТекущееПомещение 		= ЗначенияРеквизитовСсылкаНаДок.Помещение;	
	
	Если Шаблон = Неопределено Тогда
		СтруктураОтвета.Вставить("Описание", "Не нашли запись документа. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ArtID) И Не ЗначениеЗаполнено(pack) Тогда 
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ArtID) Тогда
		Если Лев(ArtID, 3) = "8U-" Тогда
			лТовар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));
			ИДХК = Сред(ArtID, 40, 36);
			Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
				лХарактеристикаНоменклатуры = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);
			Иначе
				лХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
			КонецЕсли;
		Иначе   
			Возврат ПодготовитьОтветJSON(ОбъектСписка);
		КонецЕсли;
		
		Если Шаблон.ИспользованиеСерийниковПриемка > 0 и ЗначениеЗаполнено(art_sn) Тогда		
			snValues = art_sn;
			
			СтруктураСтроки = Новый Структура;
			СтруктураСтроки.Вставить("ДокументТСД", СсылкаНаДок);
			СтруктураСтроки.Вставить("ИмяТаблицы", "Insert");	
			СтруктураСтроки.Вставить("СерийныйНомер",snValues);
			СтруктураСтроки.Вставить("Номенклатура", лТовар);
			СтруктураСтроки.Вставить("КМСсылка", Справочники.ШтрихкодыУпаковокТоваров.ПустаяСсылка());
			СтруктураСтроки.Вставить("KM_DecodedMrc", "");
			СтруктураСтроки.Вставить("СерияСсылка", Справочники.СерииНоменклатуры.ПустаяСсылка());
			
			Попытка ОпределитьСериюВСтрокеДокумента(Шаблон, СтруктураСтроки, Ложь, УзелПО); Исключение КонецПопытки;
			
			лСерия = СтруктураСтроки.СерияСсылка;
			ВсеСерии = Ложь;
		Иначе	
			лСерия = Справочники.СерииНоменклатуры.ПустаяСсылка();
			ВсеСерии = Истина;
		КонецЕсли;
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("лТовар", лТовар);  
		
		СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
		Если ЗначениеЗаполнено(ТекущийСклад) Тогда	
			СписокСкладов.Очистить();
			СписокСкладов.Добавить(ТекущийСклад);			
		КонецЕсли;	
		Запрос.УстановитьПараметр("Склады", СписокСкладов);
		Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
		
		СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
		Если ЗначениеЗаполнено(ТекущееПомещение) Тогда	
			СписокПомещений.Очистить();
			СписокПомещений.Добавить(ТекущееПомещение);			
		КонецЕсли;	
		Запрос.УстановитьПараметр("Помещения", СписокПомещений);
		Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
		
		Если Шаблон.ЯчейкиСправочноеРазмещениеПриемка Тогда
			ТекстЗапроса = "ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
			|	ТоварыВЯчейках.Ячейка КАК Ссылка
			|ИЗ
			|	РегистрСведений.РазмещениеНоменклатурыПоСкладскимЯчейкам КАК ТоварыВЯчейках
			|ГДЕ
			|	ТоварыВЯчейках.Номенклатура = &лТовар
			|   И (&ВсеПомещения ИЛИ ТоварыВЯчейках.Помещение В (&Помещения)) 
			|   И (&ВсеСклады ИЛИ ТоварыВЯчейках.Склад В (&Склады))
			|";		
		Иначе
			ТекстЗапроса = "ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ТоварыВЯчейкахОстатки.Ячейка.Ссылка КАК Ссылка
			|ИЗ
			|	РегистрНакопления.ТоварыВЯчейках.Остатки КАК ТоварыВЯчейкахОстатки
			|ГДЕ
			|	ТоварыВЯчейкахОстатки.Номенклатура = &лТовар
			|	И ТоварыВЯчейкахОстатки.Характеристика = &лХарактеристикаНоменклатуры
			|	И (&ВсеСерии ИЛИ ТоварыВЯчейкахОстатки.Серия = &лСерия)
			|	И ТоварыВЯчейкахОстатки.Ячейка.ТипСкладскойЯчейки = &Хранение
			|   И (&ВсеПомещения ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Помещение В (&Помещения)) 
			|   И (&ВсеСклады ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Владелец В (&Склады))";
			
			Запрос.УстановитьПараметр("лХарактеристикаНоменклатуры", лХарактеристикаНоменклатуры);
			Запрос.УстановитьПараметр("ВсеСерии", ВсеСерии);
			Запрос.УстановитьПараметр("лСерия", лСерия);
			Запрос.УстановитьПараметр("Хранение", Перечисления.ТипыСкладскихЯчеек.Хранение);		
		КонецЕсли;  
		
		Запрос.Текст = ТекстЗапроса;	
		Рез = Запрос.Выполнить().Выбрать(); 
		
		Пока Рез.Следующий() Цикл		 
			СтруктураТекущейСтроки = Новый Структура;
			
			ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell");		 
			ОбъектЯчейки.name = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0, ЧистаяСтрока(Рез.Ссылка.Наименование), Рез.Ссылка.Код);
			Модуль_ШтрихкодированиеПечатныхФорм = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ШтрихкодированиеПечатныхФорм");
			ОбъектЯчейки.barcode = ?(УзелПО.ВыгружатьВКодЯчейки = 1, Строка(Рез.Ссылка.Код), Строка(Модуль_ШтрихкодированиеПечатныхФорм.ЧисловойКодПоСсылке(Рез.Ссылка)));	 
			СтруктураТекущейСтроки.Вставить("cell", ОбъектЯчейки);
			
			limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, лТовар, лХарактеристикаНоменклатуры, Рез.Ссылка, Неопределено);
			qty       = 0;
			СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
			СтруктураТекущейСтроки.Вставить("task_qty",  qty);
			
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		КонецЦикла;	
		
	Иначе		
		Запрос = Новый Запрос; 	 
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ  
		|     ДатаМобайл_УпаковочныйЛистТовары.Номенклатура,
		|	  ДатаМобайл_УпаковочныйЛистТовары.Характеристика,
		|     ДатаМобайл_УпаковочныйЛистТовары.Серия
		|ПОМЕСТИТЬ ДоступныеТовары
		|ИЗ 
		|     Документ.ДатаМобайл_УпаковочныйЛист.Товары КАК ДатаМобайл_УпаковочныйЛистТовары 
		|ГДЕ 
		|	(ДатаМобайл_УпаковочныйЛистТовары.Ссылка.Номер = &КодУпакЛиста
		|			ИЛИ ДатаМобайл_УпаковочныйЛистТовары.Ссылка.Код = &КодУпакЛиста) И НЕ ДатаМобайл_УпаковочныйЛистТовары.Ссылка.ПометкаУдаления 
		| 
		|СГРУППИРОВАТЬ ПО 
		|     ДатаМобайл_УпаковочныйЛистТовары.Номенклатура,
		|	  ДатаМобайл_УпаковочныйЛистТовары.Характеристика,
		|     ДатаМобайл_УпаковочныйЛистТовары.Штрихкод,
		|	  ДатаМобайл_УпаковочныйЛистТовары.Упаковка,
		|	  ДатаМобайл_УпаковочныйЛистТовары.Серия  
		|	  
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ 
		|     УпаковочныйЛистТовары.Номенклатура,
		|	  УпаковочныйЛистТовары.Характеристика,
		|     УпаковочныйЛистТовары.Серия
		|ИЗ 
		|     Документ.УпаковочныйЛист.Товары КАК УпаковочныйЛистТовары 
		|ГДЕ 
		|	(УпаковочныйЛистТовары.Ссылка.Код = &КодУпакЛиста)  И НЕ УпаковочныйЛистТовары.Ссылка.ПометкаУдаления 
		| 
		|СГРУППИРОВАТЬ ПО 
		|     УпаковочныйЛистТовары.Номенклатура,
		|	  УпаковочныйЛистТовары.Характеристика,
		|	  УпаковочныйЛистТовары.Упаковка,
		|	  УпаковочныйЛистТовары.Серия
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДоступныеТовары.Номенклатура,
		|	ДоступныеТовары.Характеристика,
		|	ТоварыВЯчейках.Ячейка КАК Ссылка
		|ИЗ
		|	ДоступныеТовары КАК ДоступныеТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РазмещениеНоменклатурыПоСкладскимЯчейкам КАК ТоварыВЯчейках
		|		ПО ТоварыВЯчейках.Номенклатура = ДоступныеТовары.Номенклатура
		|   		И (&ВсеПомещения ИЛИ ТоварыВЯчейках.Помещение В (&Помещения)) 
		|   		И (&ВсеСклады ИЛИ ТоварыВЯчейках.Склад В (&Склады))
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ  
		|	ДоступныеТовары.Номенклатура,
		|	ДоступныеТовары.Характеристика,
		|   ТоварыВЯчейкахОстатки.Ячейка КАК Ссылка
		|ИЗ
		|	ДоступныеТовары КАК ДоступныеТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыВЯчейках.Остатки КАК ТоварыВЯчейкахОстатки
		|		ПО ТоварыВЯчейкахОстатки.Номенклатура = ДоступныеТовары.Номенклатура
		|			И ТоварыВЯчейкахОстатки.Характеристика = ДоступныеТовары.Характеристика
		|			И (&ВсеСерии ИЛИ ТоварыВЯчейкахОстатки.Серия = ДоступныеТовары.Серия)
		|			И ТоварыВЯчейкахОстатки.Ячейка.ТипСкладскойЯчейки = &Хранение
		|   		И (&ВсеПомещения ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Помещение В (&Помещения)) 
		|   		И (&ВсеСклады ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Владелец В (&Склады))
		|";
		
		Если Лев(pack,3) = "UPL" Тогда 
			КодУпакЛиста = Прав(pack, СтрДлина(pack) - 3); 
		Иначе     
			КодУпакЛиста = pack; 
		КонецЕсли; 
		
		Запрос.УстановитьПараметр("КодУпакЛиста", КодУпакЛиста);
		Запрос.УстановитьПараметр("Хранение", Перечисления.ТипыСкладскихЯчеек.Хранение);
		
		СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
		Если ЗначениеЗаполнено(ТекущийСклад) Тогда	
			СписокСкладов.Очистить();
			СписокСкладов.Добавить(ТекущийСклад);			
		КонецЕсли;
		Запрос.УстановитьПараметр("Склады", СписокСкладов);
		Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
		
		СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
		Если ЗначениеЗаполнено(ТекущееПомещение) Тогда	
			СписокПомещений.Очистить();
			СписокПомещений.Добавить(ТекущееПомещение);			
		КонецЕсли;	
		Запрос.УстановитьПараметр("Помещения", СписокПомещений);
		Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
		
		Если Шаблон.ИспользованиеСерийниковПриемка > 0 Тогда
			ВсеСерии = Ложь;
		Иначе	
			ВсеСерии = Истина;
		КонецЕсли;		
		Запрос.УстановитьПараметр("ВсеСерии", ВсеСерии);
		
		Рез = Запрос.Выполнить().Выбрать(); 
		
		Пока Рез.Следующий() Цикл			
			Если Не ЗначениеЗаполнено(Рез.Ссылка) Тогда 
				Продолжить;
			КонецЕсли;
			
			СтруктураТекущейСтроки = Новый Структура;
			
			ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell");		 
			ОбъектЯчейки.name = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0, ЧистаяСтрока(Рез.Ссылка.Наименование), Рез.Ссылка.Код);
			Модуль_ШтрихкодированиеПечатныхФорм = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ШтрихкодированиеПечатныхФорм");
			ОбъектЯчейки.barcode = ?(УзелПО.ВыгружатьВКодЯчейки = 1, Строка(Рез.Ссылка.Код), Строка(Модуль_ШтрихкодированиеПечатныхФорм.ЧисловойКодПоСсылке(Рез.Ссылка)));	 
			СтруктураТекущейСтроки.Вставить("cell", ОбъектЯчейки);
			
			limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, Рез.Номенклатура, Рез.Характеристика, Рез.Ссылка, Неопределено);
			qty       = 0;
			СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
			СтруктураТекущейСтроки.Вставить("task_qty",  qty);
			
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		КонецЦикла;		
	КонецЕсли;	
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение данных ячеек.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetCells(SN, UserName) Экспорт
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьЯчейки") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьЯчейки", Ложь);	 
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	МестаХраненияИзменения.Ссылка КАК ССылка,
	|	МестаХраненияИзменения.Ссылка.Код КАК Код,
	|	0 КАК Task,
	|	МестаХраненияИзменения.Ссылка.Наименование КАК Описание
	|ИЗ
	|	Справочник.СкладскиеЯчейки КАК МестаХраненияИзменения
	|ГДЕ
	|	НЕ МестаХраненияИзменения.Ссылка.ПометкаУдаления
	|	И НЕ МестаХраненияИзменения.Ссылка.ЭтоГруппа
	|	И (&ВсеСклады ИЛИ МестаХраненияИзменения.Владелец В (&Склады))
	|	И (&ВсеПомещения ИЛИ МестаХраненияИзменения.Помещение В (&Помещения))
	|	И (МестаХраненияИзменения.Владелец.ИспользоватьАдресноеХранение
	|	ИЛИ МестаХраненияИзменения.Помещение.ИспользоватьАдресноеХранение)");
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	Рез = Запрос.Выполнить().Выбрать();
	
	Пока Рез.Следующий() Цикл
		ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell");	 
		ОбъектЯчейки.name	  = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0,ЧистаяСтрока(Рез.Описание), Рез.Код);
		Модуль_ШтрихкодированиеПечатныхФорм = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ШтрихкодированиеПечатныхФорм");	
		ОбъектЯчейки.barcode = ?(УзелПО.ВыгружатьВКодЯчейки = 1,Строка(Рез.Код), Строка(Модуль_ШтрихкодированиеПечатныхФорм.ЧисловойКодПоСсылке(Рез.Ссылка)));	 
		ОбъектСписка.Добавить(ОбъектЯчейки);
	КонецЦикла;	
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение данных о ячейке (подбор).
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа ТСД.
// CellBC - Строка - Штрихкод ячейки.
// ArtID - Строка - Id товара.
// Barcode - Строка - Штрихкод.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция OnCellScanSelect(SN, UserName, DocOutID, Ячейка, ArtID, Barcode) Экспорт
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не нашли документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецПопытки;
	
	Шаблон = СсылкаНаДок.Шаблон;	
	
	ТекущаяЯчейкаСсылка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(Ячейка,СсылкаНаДок);
	
	// обработка справочного размещения по товару
	Если Шаблон.ЯчейкиСправочноеРазмещениеПодбор Тогда
		ТекстОписания = "";
		Рез = ЯчейкиСправочноеРазмещениеПоТоваруОбработать(УзелПО, Ячейка, ArtID, Barcode, ТекущаяЯчейкаСсылка, ТекстОписания);
		
		Если Не Рез Тогда
			СтруктураОтвета.Вставить("Описание", ТекстОписания);		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(ТекущаяЯчейкаСсылка.Наименование) И Не ЗначениеЗаполнено(ТекущаяЯчейкаСсылка.Код) Тогда		
		СтруктураОтвета.Вставить("Описание", "Ячейка по штрихкоду " + Ячейка + " не найдена в базе. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецЕсли;
	
	ОписаниеОшибки = "";
	Если Не Шаблон.ВидДокумента = "ПересчетТоваров" Тогда //в инвентаризации даем сканировать любые ячейки
		Если ПроверитьБлокировкуЯчеек(ТекущаяЯчейкаСсылка, ОписаниеОшибки, Истина) Тогда
			СтруктураОтвета.Вставить("Описание", ОписаниеОшибки);		
			Возврат ПодготовитьОтветJSON(,СтруктураОтвета);		
		КонецЕсли; 
	КонецЕсли; 
	
	СтруктураТекущейСтроки = Новый Структура;
	
	ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell");	
	ОбъектЯчейки.name = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0,ЧистаяСтрока(ТекущаяЯчейкаСсылка.Наименование), ТекущаяЯчейкаСсылка.Код);	 
	Модуль_ШтрихкодированиеПечатныхФорм = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ШтрихкодированиеПечатныхФорм");	
	ОбъектЯчейки.barcode = ?(УзелПО.ВыгружатьВКодЯчейки = 1, Строка(ТекущаяЯчейкаСсылка.Код), Строка(Модуль_ШтрихкодированиеПечатныхФорм.ЧисловойКодПоСсылке(ТекущаяЯчейкаСсылка)));    	 
	СтруктураТекущейСтроки.Вставить("cell", ОбъектЯчейки);
	
	СтруктураТекущейСтроки.Вставить("task_qty", 0);
	СтруктураТекущейСтроки.Вставить("limit_qty", 0);
	
	Попытка
		ТекущийСклад = СсылкаНаДок.ИсходныйДокумент.Склад;
		НашлиЗадание = Истина;
	Исключение	
		ТекущийСклад = Справочники.Склады.ПустаяСсылка();
		НашлиЗадание = Ложь;
	КонецПопытки;
	
	ЭтоВводЯчеекДоТовара = ?((СсылкаНаДок.Шаблон.ВыгрузкаЯчеекПодбор = 0), Истина, Ложь);
		
	Попытка
		Если ЭтоВводЯчеекДоТовара Тогда  //ПО ЯЧЕЙКЕ НЕ НУЖНА ИНФО ПО ЗАДАНИЮ И ОСТАТКАМ
			
			Возврат ПодготовитьОтветJSON(СтруктураТекущейСтроки);
			
		Иначе
			
			Если Лев(ArtID, 3) = "8U-" Тогда
				лТовар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));
				ИДХК = Сред(ArtID, 40, 36);
				Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
					лХарактеристикаНоменклатуры = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);
				Иначе
					лХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
				КонецЕсли;	
			Иначе 
				
				Возврат ПодготовитьОтветJSON(СтруктураТекущейСтроки);
				
			КонецЕсли;
			
			//ОСТАТКИ	
			СтруктураТекущейСтроки.limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, лТовар, лХарактеристикаНоменклатуры, ТекущаяЯчейкаСсылка, Неопределено);
			
			Если Не НашлиЗадание Тогда  //ПО ЯЧЕЙКЕ НЕ НУЖНА ИНФО ПО ЗАДАНИЮ
				
				Возврат ПодготовитьОтветJSON(СтруктураТекущейСтроки);
				
			Иначе
				
				//ЗАДАНИЕ
				Попытка СтруктураТекущейСтроки.task_qty = ПолучитьЗадание(УзелПО, СсылкаНаДок, лТовар, лХарактеристикаНоменклатуры, ТекущаяЯчейкаСсылка, Неопределено, "Select"); Исключение КонецПопытки;		
			КонецЕсли;	
		КонецЕсли;	
		
	Исключение	
	КонецПопытки;	
	
	//ЗАПИСЬ	
	Если Не Шаблон.ГрупповаяРабота Тогда
		//ОБЫЧНАЯ ЛОГИКА
		Если Не ЗначениеЗаполнено(СсылкаНаДок.ДатаНачалаСбора) Или Не ЗначениеЗаполнено(СсылкаНаДок.ТСД) Тогда
			
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора = ТекущаяДата();
				Объект.ТСД = УзелПО;
				
				Объект.Записать();
				
				//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
				ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
			Исключение
			КонецПопытки;
		КонецЕсли;
		
	Иначе
		//ГРУППОВОЙ ДОКУМЕНТ
		
		ДатаСбораПоТСД = ДатаМобайл_ОбщийМодуль.ПолучитьДатуГрупповогоДокумента(SN, СсылкаНаДок, "ДатаНачалаСбора");	
		Если Не ЗначениеЗаполнено(ДатаСбораПоТСД) Тогда	
			ДатаМобайл_ОбщийМодуль.СоздатьНачальнуюЗаписьТСДГрупповыхДокументов(SN, СсылкаНаДок, UserName);		
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(СсылкаНаДок.ДатаНачалаСбора) Тогда
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора = ТекущаяДата();
				
				Объект.Записать();
			Исключение
			КонецПопытки;	
		КонецЕсли;
	КонецЕсли;	
	
	Возврат ПодготовитьОтветJSON(СтруктураТекущейСтроки);
	
КонецФункции

// Получение данных о ячейке (приемка).
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа ТСД.
// CellBC - Строка - Штрихкод ячейки.
// ArtID - Строка - Id товара.
// Barcode - Строка - Штрихкод.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция OnCellScanInsert(SN, UserName, DocOutID, Ячейка, ArtID, Barcode) Экспорт
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не нашли документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	Шаблон = СсылкаНаДок.Шаблон;
	
	ТекущаяЯчейкаСсылка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(Ячейка, СсылкаНаДок);
	
	// обработка справочного размещения по товару
	Если Шаблон.ЯчейкиСправочноеРазмещениеПриемка Тогда
		ТекстОписания = "";
		Рез = ЯчейкиСправочноеРазмещениеПоТоваруОбработать(УзелПО, Ячейка, ArtID, Barcode, ТекущаяЯчейкаСсылка, ТекстОписания);
		
		Если Не Рез Тогда
			СтруктураОтвета.Вставить("Описание", ТекстОписания);		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;		
	КонецЕсли;	
	
	Если Не ЗначениеЗаполнено(ТекущаяЯчейкаСсылка.Наименование) И Не ЗначениеЗаполнено(ТекущаяЯчейкаСсылка.Код) Тогда		
		СтруктураОтвета.Вставить("Описание", "Ячейка по штрихкоду " + Ячейка + " не найдена в базе.");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецЕсли;
	
	ОписаниеОшибки = "";
	Если Не Шаблон.ВидДокумента = "ПересчетТоваров" Тогда //в инвентаризации даем сканировать любые ячейки
		Если ПроверитьБлокировкуЯчеек(ТекущаяЯчейкаСсылка, ОписаниеОшибки) Тогда
			СтруктураОтвета.Вставить("Описание", ОписаниеОшибки);		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
		КонецЕсли;
	КонецЕсли;
	
	СтруктураТекущейСтроки = Новый Структура;
	
	ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell");	
	ОбъектЯчейки.name = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0, ЧистаяСтрока(ТекущаяЯчейкаСсылка.Наименование), ТекущаяЯчейкаСсылка.Код);
	Модуль_ШтрихкодированиеПечатныхФорм = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ШтрихкодированиеПечатныхФорм");	
	ОбъектЯчейки.barcode = ?(УзелПО.ВыгружатьВКодЯчейки = 1, Строка(ТекущаяЯчейкаСсылка.Код), Строка(Модуль_ШтрихкодированиеПечатныхФорм.ЧисловойКодПоСсылке(ТекущаяЯчейкаСсылка)));    		 
	СтруктураТекущейСтроки.Вставить("cell", ОбъектЯчейки);
	
	СтруктураТекущейСтроки.Вставить("task_qty", 0);
	СтруктураТекущейСтроки.Вставить("limit_qty", 0);
		
	Попытка
		ТекущийСклад = СсылкаНаДок.ИсходныйДокумент.Склад;
		НашлиЗадание = Истина;
	Исключение
		ТекущийСклад = Справочники.Склады.ПустаяСсылка();
		НашлиЗадание = Ложь;
	КонецПопытки;
	
	ЭтоВводЯчеекДоТовара = ?((СсылкаНаДок.Шаблон.ВыгрузкаЯчеекПриемка = 0), Истина, Ложь);
	ЭтоРазмещениеПоПодбору = СсылкаНаДок.Шаблон.ПриемкаПоПодбору;
		
	Попытка
		Если ЭтоВводЯчеекДоТовара Или ЭтоРазмещениеПоПодбору Тогда  //ПО ЯЧЕЙКЕ НЕ НУЖНА ИНФО ПО ЗАДАНИЮ И ОСТАТКАМ
			Возврат ПодготовитьОтветJSON(СтруктураТекущейСтроки);
		Иначе						
			Если Лев(ArtID, 3) = "8U-" Тогда
				лТовар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));
				ИДХК = Сред(ArtID,40,36);
				Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
					лХарактеристикаНоменклатуры = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);     
				Иначе
					лХарактеристикаНоменклатуры = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
				КонецЕсли;	
			Иначе 
				Возврат ПодготовитьОтветJSON(СтруктураТекущейСтроки);
			КонецЕсли;
					
			//ОСТАТКИ	
			СтруктураТекущейСтроки.limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, лТовар, лХарактеристикаНоменклатуры, ТекущаяЯчейкаСсылка, Неопределено);
			
			Если Не НашлиЗадание Тогда  //ПО ЯЧЕЙКЕ НЕ НУЖНА ИНФО ПО ЗАДАНИЮ
				
				Возврат ПодготовитьОтветJSON(СтруктураТекущейСтроки);	
				
			Иначе
				
				Попытка
					//ОСТАТКИ ПРИ РАЗМЕЩЕНИИ ИЗ ЗОНЫ ПРИЕМКИ
					ЯчейкаЗоныПриемки = СсылкаНаДок.ИсходныйДокумент.ЗонаПриемки;
					Если СсылкаНаДок.ИсходныйДокумент.ВидОперации = Перечисления.ВидыОперацийОтбораРазмещенияТоваров.Размещение И Не ЯчейкаЗоныПриемки.Пустая() Тогда
						СтруктураТекущейСтроки.limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, лТовар, лХарактеристикаНоменклатуры, ЯчейкаЗоныПриемки, Неопределено);
					КонецЕсли;
				Исключение
				КонецПопытки;
				
				//ЗАДАНИЕ
				Попытка СтруктураТекущейСтроки.task_qty = ПолучитьЗадание(УзелПО, СсылкаНаДок, лТовар, лХарактеристикаНоменклатуры, ТекущаяЯчейкаСсылка, Неопределено, "Insert"); Исключение КонецПопытки;
				
			КонецЕсли;	
		КонецЕсли;	
		
	Исключение	
	КонецПопытки;
		
	//ЗАПИСЬ	
	Если Не Шаблон.ГрупповаяРабота Тогда
		//ОБЫЧНАЯ ЛОГИКА
		Если Не ЗначениеЗаполнено(СсылкаНаДок.ДатаНачалаСбора) Или Не ЗначениеЗаполнено(СсылкаНаДок.ТСД) Тогда			
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора = ТекущаяДата();
				Объект.ТСД = УзелПО;
				
				Объект.Записать();
				
				//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
				ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
			Исключение
			КонецПопытки;
		КонецЕсли;		
	Иначе
		//ГРУППОВОЙ ДОКУМЕНТ
		
		ДатаСбораПоТСД = ДатаМобайл_ОбщийМодуль.ПолучитьДатуГрупповогоДокумента(SN, СсылкаНаДок, "ДатаНачалаСбора");	
		Если Не ЗначениеЗаполнено(ДатаСбораПоТСД) Тогда	
			ДатаМобайл_ОбщийМодуль.СоздатьНачальнуюЗаписьТСДГрупповыхДокументов(SN, СсылкаНаДок, UserName);		
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(СсылкаНаДок.ДатаНачалаСбора) Тогда
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора = ТекущаяДата();
				
				Объект.Записать();
			Исключение
			КонецПопытки;	
		КонецЕсли;
	КонецЕсли;	
	
	Возврат ПодготовитьОтветJSON(СтруктураТекущейСтроки);	
	
КонецФункции

#КонецОбласти

#Область Units

// Получение данных единиц измерения.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetUnits(SN, UserName) Экспорт 
	
	ОбъектСписка = Новый Массив;  
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьЕдиницыИзмерения") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьЕдиницыИзмерения", Ложь);	 
	КонецЕсли;	
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ	
	|	УпаковкиЕдиницыИзмеренияИзменения.Ссылка КАК Ссылка,
	|	ВЫРАЗИТЬ(УпаковкиЕдиницыИзмеренияИзменения.Наименование КАК СТРОКА(10)) КАК Наименование,
	|	ВЫБОР КОГДА ВЫРАЗИТЬ(УпаковкиЕдиницыИзмеренияИзменения.Наименование КАК СТРОКА(2)) = ""шт"" ТОГДА 1
	|	ИНАЧЕ ВЫБОР КОГДА ВЫРАЗИТЬ(УпаковкиЕдиницыИзмеренияИзменения.Наименование КАК СТРОКА(10)) ПОДОБНО (""%шт%"") ТОГДА 2
	|	ИНАЧЕ 3 КОНЕЦ
	|	КОНЕЦ КАК Приоритет
	|ПОМЕСТИТЬ тЕдиницы
	|ИЗ
	|	Справочник.УпаковкиЕдиницыИзмерения КАК УпаковкиЕдиницыИзмеренияИзменения
	|ГДЕ
	|	УпаковкиЕдиницыИзмеренияИзменения.Владелец = ЗНАЧЕНИЕ(Справочник.НаборыУпаковок.БазовыеЕдиницыИзмерения)
	//|	И УпаковкиЕдиницыИзмеренияИзменения.ТипИзмеряемойВеличины = ЗНАЧЕНИЕ(Перечисление.ТипыИзмеряемыхВеличин.КоличествоШтук)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	тЕдиницы.Ссылка,
	|	тЕдиницы.Наименование,
	|	тЕдиницы.Приоритет
	|ИЗ
	|	тЕдиницы КАК тЕдиницы
	|
	|СГРУППИРОВАТЬ ПО
	|	тЕдиницы.Ссылка,
	|	тЕдиницы.Наименование,
	|	тЕдиницы.Приоритет
	|УПОРЯДОЧИТЬ ПО
	|	тЕдиницы.Приоритет ВОЗР";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ОбъектЕдиницыИзмерения = ПолучитьСтруктуруОбъектаДляHttp("unit");
		
		ОбъектЕдиницыИзмерения.id = XMLСтрока(Выборка.Ссылка);
		ОбъектЕдиницыИзмерения.name = ЧистаяСтрока(Выборка.Наименование);
		
		ОбъектСписка.Добавить(ОбъектЕдиницыИзмерения);
		
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

#КонецОбласти

#Область Clients

// Получение данных клиентов.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetClients(SN, UserName) Экспорт
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьКлиентов") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьКлиентов", Ложь);	 
	КонецЕсли;
	
	Если УзелПО.ВыгружатьПодразделенияКакКонтрагентов <> 2 Тогда
		
		Попытка				
			Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ВЫРАЗИТЬ(ПартнерыИзменения.Наименование КАК Строка(100)) КАК Name,
			|	ПартнерыИзменения.Ссылка КАК Ссылка,
			|	МАКСИМУМ(ПартнерыИзменения.Ссылка.Код) КАК Barcode,
			|	МАКСИМУМ(ЕстьNULL(СправочникКонтрагенты.Ссылка,ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))) КАК СсылкаКонтрагент
			|ИЗ
			|	Справочник.Партнеры КАК ПартнерыИзменения
			|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Контрагенты КАК СправочникКонтрагенты
			|	ПО ПартнерыИзменения.Ссылка = СправочникКонтрагенты.Партнер	
			|ГДЕ
			|	НЕ ПартнерыИзменения.Ссылка.ПометкаУдаления
			|СГРУППИРОВАТЬ ПО 
			|	ВЫРАЗИТЬ(ПартнерыИзменения.Наименование КАК Строка(100)),
			|	ПартнерыИзменения.Ссылка
			|УПОРЯДОЧИТЬ ПО
			|	ПартнерыИзменения.Наименование");
					
			Рез = Запрос.Выполнить().Выбрать();
			Пока Рез.Следующий() Цикл
				ОбъектКлиента = ПолучитьСтруктуруОбъектаДляHttp("client");
				ОбъектКлиента.id = "8k-" + XMLСтрока(Рез.Ссылка);
				ОбъектКлиента.name = Рез.Name;
				Попытка ОбъектКлиента.barcode = Рез.СсылкаКонтрагент.ИНН; Исключение КонецПопытки;
				
				ОбъектСписка.Добавить(ОбъектКлиента);
			КонецЦикла;			
		Исключение
		КонецПопытки;
		
		Попытка
			Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ВЫРАЗИТЬ(ПартнерыИзменения.Наименование КАК Строка(100)) КАК Name,
			|	ПартнерыИзменения.Ссылка КАК Ссылка,
			|	"""" КАК Barcode
			|ИЗ
			|	Справочник.КлассификаторОрганизацийЕГАИС КАК ПартнерыИзменения
			|ГДЕ
			|	НЕ ПартнерыИзменения.Ссылка.ПометкаУдаления
			|УПОРЯДОЧИТЬ ПО
			|	ПартнерыИзменения.Наименование");
			
			Если ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "КлассификаторОрганизацийЕГАИС", "астКонтрагентыЕГАИС");
				
			ИначеЕсли ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "КлассификаторОрганизацийЕГАИС", "алкКлассификаторОрганизацийЕГАИС");
			КонецЕсли;
			
			Рез = Запрос.Выполнить().Выбрать();
			Пока Рез.Следующий() Цикл
				ОбъектКлиента = ПолучитьСтруктуруОбъектаДляHttp("client");
				ОбъектКлиента.id = "8k-" + XMLСтрока(Рез.Ссылка);
				ОбъектКлиента.name = Рез.Name;
				
				ОбъектСписка.Добавить(ОбъектКлиента);
			КонецЦикла;
		Исключение
		КонецПопытки;
		
	КонецЕсли;
		
	Попытка
		Если УзелПО.ВыгружатьПодразделенияКакКонтрагентов > 0 Тогда
			Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ВЫРАЗИТЬ(Подразделения.Наименование КАК СТРОКА(100)) КАК Name,
			|	Подразделения.Ссылка КАК Ссылка,
			|	"""" КАК Barcode
			|ИЗ
			|	Справочник.СтруктураПредприятия КАК Подразделения
			|ГДЕ
			|	НЕ Подразделения.Ссылка.ПометкаУдаления
			|
			|УПОРЯДОЧИТЬ ПО
			|	Подразделения.Наименование");
			
			Рез = Запрос.Выполнить().Выбрать();
			Пока Рез.Следующий() Цикл
				ОбъектКлиента = ПолучитьСтруктуруОбъектаДляHttp("client");
				ОбъектКлиента.id = "8k-" + XMLСтрока(Рез.Ссылка);
				ОбъектКлиента.name = Рез.Name;
				
				ОбъектСписка.Добавить(ОбъектКлиента);				
			КонецЦикла;		
		КонецЕсли;
	Исключение КонецПопытки;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

#КонецОбласти

#Область Warehouses

// Получение данных складов.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetWarehouses(SN, UserName) Экспорт 
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьСклады") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьСклады", Ложь);	 
	КонецЕсли;	
	
	Запрос = Новый Запрос;
	Запрос.Текст = 	
	"ВЫБРАТЬ
	|	Склады.Ссылка КАК Ссылка,
	|	ВЫРАЗИТЬ(Склады.Наименование КАК Строка(100)) КАК Наименование
	|ИЗ
	|	Справочник.Склады КАК Склады
	|ГДЕ
	|	НЕ Склады.Ссылка.ПометкаУдаления
	|	И НЕ Склады.Ссылка.ЭтоГруппа
	|	И (&ВсеСклады ИЛИ Склады.Ссылка В (&Склады))
	|УПОРЯДОЧИТЬ ПО
	|	Склады.Наименование";
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	
	Запрос.УстановитьПараметр("ВсеСклады",СписокСкладов.Количество() = 0);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ОбъектСклада = ПолучитьСтруктуруОбъектаДляHttp("warehouse"); 
		
		ОбъектСклада.ID = XMLСтрока(Выборка.Ссылка);
		ОбъектСклада.Name = ЧистаяСтрока(Выборка.Наименование);
		
		ОбъектСписка.Добавить(ОбъектСклада);
		
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

#КонецОбласти

#Область Templates

// Получение данных шаблонов.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// AppVersion - Строка - Версия ПО.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetTemplates(SN, UserName, AppVersion) Экспорт 
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли; 
	
	УдалитьРегистрацию = Ложь;    
	
	ЗапросШаблонов = Новый Запрос;
	ЗапросШаблонов.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДатаМобайл_СписокТСДШаблоны.Шаблон КАК Шаблон
	|ИЗ
	|	ПланОбмена.ДатаМобайл_СписокТСД.Шаблоны КАК ДатаМобайл_СписокТСДШаблоны
	|ГДЕ
	|	ДатаМобайл_СписокТСДШаблоны.Ссылка = &Ссылка";
	ЗапросШаблонов.УстановитьПараметр("Ссылка", УзелПО);
	Результат = ЗапросШаблонов.Выполнить();
	ТаблицаШаблонов = Результат.Выгрузить();
	МассивОграниченийШаблонов = ТаблицаШаблонов.ВыгрузитьКолонку("Шаблон");
		
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО,"ОчиститьШаблоны") Тогда
		
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО,"ОчиститьШаблоны", Ложь);
		
		Запрос = Новый Запрос;        		
		
		Если МассивОграниченийШаблонов.Количество() = 0 Тогда
			
			Запрос.Текст =
			"ВЫБРАТЬ
			|	ДатаМобайл_ШаблоныДокументов.Ссылка КАК ШаблонСсылка
			|ИЗ
			|	Справочник.ДатаМобайл_ШаблоныДокументов КАК ДатаМобайл_ШаблоныДокументов
			|ГДЕ
			|	НЕ ДатаМобайл_ШаблоныДокументов.Ссылка.ПометкаУдаления";  
			
		Иначе
			
			Запрос.Текст =
			"ВЫБРАТЬ
			|	ДатаМобайл_ШаблоныДокументов.Ссылка КАК ШаблонСсылка
			|ИЗ
			|	Справочник.ДатаМобайл_ШаблоныДокументов КАК ДатаМобайл_ШаблоныДокументов
			|ГДЕ
			|	НЕ ДатаМобайл_ШаблоныДокументов.Ссылка.ПометкаУдаления
			|	И ДатаМобайл_ШаблоныДокументов.Ссылка В(&СписокШаблонов)";
			
			Запрос.УстановитьПараметр("СписокШаблонов", МассивОграниченийШаблонов); 
						
		КонецЕсли;    
				
	Иначе          
		
		УдалитьРегистрацию = Истина;
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДатаМобайл_ШаблоныДокументовИзменения.Ссылка КАК ШаблонСсылка
		|ИЗ
		|	Справочник.ДатаМобайл_ШаблоныДокументов.Изменения КАК ДатаМобайл_ШаблоныДокументовИзменения
		|ГДЕ
		|	(ДатаМобайл_ШаблоныДокументовИзменения.Ссылка В (&СписокШаблонов) ИЛИ &ВсеШаблоны)
		|	И (ДатаМобайл_ШаблоныДокументовИзменения.Узел = &Узел И НЕ ДатаМобайл_ШаблоныДокументовИзменения.НомерСообщения ЕСТЬ NULL)
		|	И НЕ ЕСТЬNULL(ДатаМобайл_ШаблоныДокументовИзменения.Ссылка.ПометкаУдаления,ИСТИНА)";
		
		Запрос.УстановитьПараметр("СписокШаблонов", МассивОграниченийШаблонов);
		Запрос.УстановитьПараметр("ВсеШаблоны", МассивОграниченийШаблонов.Количество() = 0);
        Запрос.УстановитьПараметр("Узел", УзелПО);     		
		
	КонецЕсли; 
	
	Рез = Запрос.Выполнить().Выбрать(); 
	
	Пока Рез.Следующий() Цикл
		
		ОбъектШаблона = ПолучитьСтруктуруОбъектаДляHttp("template");
		ЗаполнитьОбъектШаблона(ОбъектШаблона, Рез.ШаблонСсылка, AppVersion);
		ОбъектСписка.Добавить(ОбъектШаблона);     
		
	КонецЦикла;
	
	Если УдалитьРегистрацию Тогда
		
		МетаданныеШаблоныДокументов = Метаданные.Справочники.ДатаМобайл_ШаблоныДокументов;
		Попытка 
			ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, МетаданныеШаблоныДокументов); 
		Исключение 
		КонецПопытки;	

		
	КонецЕсли;	
		
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

#КонецОбласти

#Область Barcode_Templates

// Получение данных шаблонов штрихкодов.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetBarcodeTemplates(SN, username) Экспорт 
	
	МассивОбъектов = Новый Массив;	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьШаблоныШтрихкодов") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьШаблоныШтрихкодов", Ложь);	 
	КонецЕсли;
	СтруктураЗапроса = Новый Структура;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.Тип КАК Тип,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.ОбщаяДлина КАК ОбщаяДлина,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.ТипШтрихкода КАК ТипШтрихкода,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.Префикс КАК Префикс,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.НачальныйСимволШтрихкода КАК НачальныйСимволШтрихкода,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.КонечныйСимволШтрихкода КАК КонечныйСимволШтрихкода,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.НачальныйСимволКилограмм КАК НачальныйСимволКилограмм,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.КонечныйСимволКилограмм КАК КонечныйСимволКилограмм,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.НачальныйСимволГрамм КАК НачальныйСимволГрамм,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.КонечныйСимволГрамм КАК КонечныйСимволГрамм,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.НачальныйСимволСерийныйНомер КАК НачальныйСимволСерийныйНомер,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.КонечныйСимволСерийныйНомер КАК КонечныйСимволСерийныйНомер,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.НачальныйСимволКоличество КАК НачальныйСимволКоличество,
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.КонечныйСимволКоличество КАК КонечныйСимволКоличество
	|ИЗ
	|	ПланОбмена.ДатаМобайл_СписокТСД.ШаблоныШтрихкодов КАК ДатаМобайл_СписокТСДШаблоныШтрихкодов
	|ГДЕ
	|	ДатаМобайл_СписокТСДШаблоныШтрихкодов.Ссылка = &Узел");
	
	Запрос.УстановитьПараметр("Узел", УзелПО.Ссылка);
	Рез = Запрос.Выполнить().Выбрать();
	
	МассивСтрок = Новый Массив;
	
	Пока Рез.Следующий() Цикл
		
		ОбъектШаблонаШК = ПолучитьСтруктуруОбъектаДляHttp("barcode_template");
		
		ОбъектШаблонаШК.type_id = Рез.Тип;
		ОбъектШаблонаШК.length = Рез.ОбщаяДлина;
		ОбъектШаблонаШК.barcode_type_id = Рез.ТипШтрихкода;
		ОбъектШаблонаШК.prefix = Рез.Префикс;
		
		Если ЗначениеЗаполнено(Рез.НачальныйСимволШтрихкода) Или ЗначениеЗаполнено(Рез.КонечныйСимволШтрихкода) Тогда
			ОбъектШаблонаШК.Вставить("bc_segment", Новый Структура);
			
			ОбъектШаблонаШК.bc_segment.Вставить("start", Рез.НачальныйСимволШтрихкода);
			ОбъектШаблонаШК.bc_segment.Вставить("end", Рез.КонечныйСимволШтрихкода);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.НачальныйСимволКилограмм) Или ЗначениеЗаполнено(Рез.КонечныйСимволКилограмм) Тогда
			ОбъектШаблонаШК.Вставить("kg_segment", Новый Структура);
			
			ОбъектШаблонаШК.kg_segment.Вставить("start", Рез.НачальныйСимволКилограмм);
			ОбъектШаблонаШК.kg_segment.Вставить("end", Рез.КонечныйСимволКилограмм);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.НачальныйСимволГрамм) Или ЗначениеЗаполнено(Рез.КонечныйСимволГрамм) Тогда
			ОбъектШаблонаШК.Вставить("gm_segment", Новый Структура);
			
			ОбъектШаблонаШК.gm_segment.Вставить("start", Рез.НачальныйСимволГрамм);
			ОбъектШаблонаШК.gm_segment.Вставить("end", Рез.КонечныйСимволГрамм);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.НачальныйСимволСерийныйНомер) Или ЗначениеЗаполнено(Рез.КонечныйСимволСерийныйНомер) Тогда
			ОбъектШаблонаШК.Вставить("sn_segment", Новый Структура);
			
			ОбъектШаблонаШК.sn_segment.Вставить("start", Рез.НачальныйСимволСерийныйНомер);
			ОбъектШаблонаШК.sn_segment.Вставить("end", Рез.КонечныйСимволСерийныйНомер);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.НачальныйСимволКоличество) Или ЗначениеЗаполнено(Рез.КонечныйСимволКоличество) Тогда
			ОбъектШаблонаШК.Вставить("qty_segment", Новый Структура);
			
			ОбъектШаблонаШК.qty_segment.Вставить("start", Рез.НачальныйСимволКоличество);
			ОбъектШаблонаШК.qty_segment.Вставить("end", Рез.КонечныйСимволКоличество);
		КонецЕсли;
		
		МассивОбъектов.Добавить(ОбъектШаблонаШК);
		
	КонецЦикла;	
	
	Возврат ПодготовитьОтветJSON(МассивОбъектов);	
	
КонецФункции

#КонецОбласти

#Область Forms

// Получение связи шаблонов документов и доп. форм.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetDocSteps(SN, UserName) Экспорт
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьДополнительныеФормы") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьДополнительныеФормы", Ложь);	 
	КонецЕсли;
	
	Попытка ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.РегистрыСведений.ДатаМобайл_СвязиДополнительныхФормИШаблонов); Исключение КонецПопытки;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.Порядок КАК DMSortNumber,
	|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.Шаблон.Код КАК DMTemplateId,
	|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ДополнительнаяФорма.Ссылка КАК ДополнительнаяФорма,
	|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПроверятьЗаполнение КАК DMCheckFill,
	|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.РеквизитИзШапки КАК DMIsDocArg,
	|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПроверкаПоЗаданию КАК DMIsCheckByTask,
	|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.РежимВвода КАК DMEnterMode,
	|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.Шаблон КАК Шаблон,
	|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПодборРазмещение КАК ПодборРазмещение
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СвязиДополнительныхФормИШаблонов КАК ДатаМобайл_СвязиДополнительныхФормИШаблонов
	|ГДЕ
	|	НЕ ДатаМобайл_СвязиДополнительныхФормИШаблонов.Шаблон.Ссылка ЕСТЬ NULL
	|	И НЕ ДатаМобайл_СвязиДополнительныхФормИШаблонов.ДополнительнаяФорма.Ссылка ЕСТЬ NULL
	|	И ДатаМобайл_СвязиДополнительныхФормИШаблонов.Шаблон.ИспользоватьДопФормы";
	
	РезультатЗапроса = Запрос.Выполнить();	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		НомерАтрибута = ПолучитьНомерАтрибутаДляДопФормы(Выборка.Шаблон, Выборка.ДополнительнаяФорма, Выборка.DMIsDocArg);
		Если НомерАтрибута = 0 Тогда Продолжить; КонецЕсли;
		
		ОбъектСвязьДополнительнойФормыИШаблона = ПолучитьСтруктуруОбъектаДляHttp("doc_form");
		ОбъектСвязьДополнительнойФормыИШаблона.id = XMLСтрока(Выборка.ДополнительнаяФорма);		
		
		ОбъектСвязьДополнительнойФормыИШаблона.id               = XMLСтрока(Выборка.ДополнительнаяФорма);	
		ОбъектСвязьДополнительнойФормыИШаблона.template_id      = Выборка.DMTemplateId;
		ОбъектСвязьДополнительнойФормыИШаблона.attribute_number = НомерАтрибута;
		ОбъектСвязьДополнительнойФормыИШаблона.is_check_by_task = Выборка.DMIsCheckByTask;
		ОбъектСвязьДополнительнойФормыИШаблона.enter_mode       = Выборка.DMEnterMode;		
		ОбъектСвязьДополнительнойФормыИШаблона.is_required      = Выборка.DMCheckFill;			
		ОбъектСвязьДополнительнойФормыИШаблона.form_type        = Выборка.DMIsDocArg;
		ОбъектСвязьДополнительнойФормыИШаблона.operation_type   = Выборка.ПодборРазмещение;
		
		ОбъектСписка.Добавить(ОбъектСвязьДополнительнойФормыИШаблона);		
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение доп. форм.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetSteps(SN, UserName) Экспорт
	
	ОбъектСписка = Новый Массив;
	
	УзелПО = НайтиУзел(SN);
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьДополнительныеФормы") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьДополнительныеФормы", Ложь);	 
	КонецЕсли;
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДатаМобайл_ДополнительныеФормы.Ссылка,
	|	ДатаМобайл_ДополнительныеФормы.Наименование,
	|	ДатаМобайл_ДополнительныеФормы.ТипДанных,
	|	ДатаМобайл_ДополнительныеФормы.ИДСправочника
	|ИЗ
	|	Справочник.ДатаМобайл_ДополнительныеФормы КАК ДатаМобайл_ДополнительныеФормы
	|ГДЕ
	|	ДатаМобайл_ДополнительныеФормы.ПометкаУдаления = ЛОЖЬ";
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ОбъектДополнительнаяФорма = ПолучитьСтруктуруОбъектаДляHttp("step");
		
		ОбъектДополнительнаяФорма.id = XMLСтрока(Выборка.Ссылка);
		ОбъектДополнительнаяФорма.name = ЧистаяСтрока(Выборка.Наименование);
		
		Если Выборка.ТипДанных = "Текст" Тогда
			ТекущийТип = 0;
		ИначеЕсли Выборка.ТипДанных = "Число" Тогда
			ТекущийТип = 1;
		ИначеЕсли Выборка.ТипДанных = "Дата" Тогда
			ТекущийТип = 2;
		ИначеЕсли Выборка.ТипДанных = "Булево" Тогда
			ТекущийТип = 4;
		Иначе
			ТекущийТип = 3;
		КонецЕсли;
		
		ОбъектДополнительнаяФорма.type = ТекущийТип;
		ОбъектДополнительнаяФорма.parent_id = ЧистаяСтрока(Выборка.ИДСправочника);
		ОбъектСписка.Добавить(ОбъектДополнительнаяФорма);		
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Загрузка справочника значений доп. форм.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DMStepId - Строка - Id доп. формы.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetUserBooks(SN, UserName, DMStepId = Неопределено) Экспорт
	
	ОбъектСписка = Новый Массив;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьДополнительныеФормы") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьДополнительныеФормы", Ложь);	 
	КонецЕсли;
	
	ЗапросСправочника = Новый Запрос;
	ЗапросСправочника.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДатаМобайл_ДополнительныеФормы.Ссылка КАК ДопФорма,
	|	ДатаМобайл_ДополнительныеФормы.ТипДанных КАК ТипДанных,
	|	ДатаМобайл_ДополнительныеФормы.ИДСправочника КАК ИДСправочника
	|ИЗ
	|	Справочник.ДатаМобайл_ДополнительныеФормы КАК ДатаМобайл_ДополнительныеФормы
	|ГДЕ
	|	ДатаМобайл_ДополнительныеФормы.ПометкаУдаления = ЛОЖЬ
	|
	|УПОРЯДОЧИТЬ ПО
	|	ДатаМобайл_ДополнительныеФормы.Наименование";
	
	Если Не DMStepId = Неопределено И ЗначениеЗаполнено(СокрЛП(DMStepId)) Тогда
		ЗапросСправочника.Текст = ЗапросСправочника.Текст +  "
		|	И ДатаМобайл_ДополнительныеФормы.ИДСправочника = &ИДСпр";
		
		ЗапросСправочника.УстановитьПараметр("ИДСпр", СокрЛП(DMStepId)); 
	КонецЕсли;
	
	РезультатЗапросаСправочника = ЗапросСправочника.Выполнить();
	
	ВыборкаСправочника = РезультатЗапросаСправочника.Выбрать();
	
	МетаданныеСправочники = Метаданные.Справочники;
	МетаданныеПланыВидовХарактеристик = Метаданные.ПланыВидовХарактеристик;
	МетаданныеПеречисления = Метаданные.Перечисления;
	
	Пока ВыборкаСправочника.Следующий() Цикл
		Если Не (ВыборкаСправочника.ТипДанных = "Текст" Или ВыборкаСправочника.ТипДанных = "Число" Или ВыборкаСправочника.ТипДанных = "Дата" Или ВыборкаСправочника.ТипДанных = "Булево") Тогда
			ТекущаяДопФорма= ВыборкаСправочника.ДопФорма;
			Попытка
				Если Не МетаданныеСправочники.Найти(ВыборкаСправочника.ТипДанных) = Неопределено Тогда
					Запрос = Новый Запрос;
					Запрос.Текст =
					"ВЫБРАТЬ
					|	Справочник.Ссылка,
					|	Справочник.Наименование
					|ИЗ
					|	Справочник." + СокрЛП(ВыборкаСправочника.ТипДанных) + " КАК Справочник
					|ГДЕ
					|	Справочник.ПометкаУдаления = ЛОЖЬ
					|	И 1=1
					|
					|УПОРЯДОЧИТЬ ПО
					|	Справочник.Наименование";
					
					Если ТекущаяДопФорма.Ограничения.Количество() Тогда
						Запрос.Текст = СтрЗаменить(Запрос.Текст, "1=1", "Справочник.Ссылка В ИЕРАРХИИ (&МассивЭлементовДопФормы)");
						МассивЭлементовДопФормы = ТекущаяДопФорма.Ограничения.ВыгрузитьКолонку("Значения");
						Запрос.УстановитьПараметр("МассивЭлементовДопФормы", МассивЭлементовДопФормы);
					КонецЕсли; 
					
					РезультатЗапроса = Запрос.Выполнить();
					
					Выборка = РезультатЗапроса.Выбрать();
					
					Пока Выборка.Следующий() Цикл
						ОбъектЭлементСправочника = ПолучитьСтруктуруОбъектаДляHttp("form_content");
						ОбъектЭлементСправочника.id = XMLСтрока(Выборка.Ссылка);
						ОбъектЭлементСправочника.form_id = Строка(ВыборкаСправочника.ИДСправочника);
						ОбъектЭлементСправочника.name = ЧистаяСтрока(Выборка.Наименование);
						ОбъектСписка.Добавить(ОбъектЭлементСправочника);
					КонецЦикла;
					
				ИначеЕсли Не МетаданныеПланыВидовХарактеристик.Найти(ВыборкаСправочника.ТипДанных) = Неопределено Тогда
					
					Запрос = Новый Запрос;
					Запрос.Текст =
					"ВЫБРАТЬ
					|	ПланВидовХарактеристик.Ссылка,
					|	ПланВидовХарактеристик.Наименование
					|ИЗ
					|	ПланВидовХарактеристик." + СокрЛП(ВыборкаСправочника.ТипДанных) + " КАК ПланВидовХарактеристик
					|ГДЕ
					|	ПланВидовХарактеристик.ПометкаУдаления = ЛОЖЬ
					|	И 1=1
					|
					|УПОРЯДОЧИТЬ ПО
					|	ПланВидовХарактеристик.Наименование";
					
					Если ТекущаяДопФорма.Ограничения.Количество() Тогда
						Запрос.Текст = СтрЗаменить(Запрос.Текст, "1=1", "ПланВидовХарактеристик.Ссылка В (&МассивЭлементовДопФормы)");
						МассивЭлементовДопФормы = ТекущаяДопФорма.Ограничения.ВыгрузитьКолонку("Значения");
						Запрос.УстановитьПараметр("МассивЭлементовДопФормы", МассивЭлементовДопФормы);
					КонецЕсли; 
					
					РезультатЗапроса = Запрос.Выполнить();
					
					Выборка = РезультатЗапроса.Выбрать();
					
					Пока Выборка.Следующий() Цикл
						ОбъектЭлементСправочника = ПолучитьСтруктуруОбъектаДляHttp("form_content");
						ОбъектЭлементСправочника.id = XMLСтрока(Выборка.Ссылка);
						ОбъектЭлементСправочника.form_id = Строка(ВыборкаСправочника.ИДСправочника);
						ОбъектЭлементСправочника.name = ЧистаяСтрока(Выборка.Наименование);
						ОбъектСписка.Добавить(ОбъектЭлементСправочника);
					КонецЦикла;
					
				ИначеЕсли Не МетаданныеПеречисления.Найти(ВыборкаСправочника.ТипДанных) = Неопределено Тогда
					
					Если ТекущаяДопФорма.Ограничения.Количество() Тогда
						МассивЭлементовДопФормы = ТекущаяДопФорма.Ограничения.ВыгрузитьКолонку("Значения");
					Иначе
						МассивЭлементовДопФормы = Неопределено;
					КонецЕсли; 
					
					Для Сч = 0 По Перечисления[ВыборкаСправочника.ТипДанных].Количество() - 1  Цикл
						ЗначПеречисления = Перечисления[ВыборкаСправочника.ТипДанных][Сч];
						
						Если МассивЭлементовДопФормы <> Неопределено Тогда
							Если МассивЭлементовДопФормы.Найти(ЗначПеречисления) = Неопределено Тогда
								Продолжить;	
							КонецЕсли; 	
						КонецЕсли; 
						
						ОбъектЭлементСправочника = ПолучитьСтруктуруОбъектаДляHttp("form_content");
						ОбъектЭлементСправочника.id = XMLСтрока(ЗначПеречисления);
						ОбъектЭлементСправочника.form_id = Строка(ВыборкаСправочника.ИДСправочника);
						ОбъектЭлементСправочника.name = ЧистаяСтрока(Строка(Перечисления[ВыборкаСправочника.ТипДанных][Сч]));
						ОбъектСписка.Добавить(ОбъектЭлементСправочника);
					КонецЦикла;
				КонецЕсли;
			Исключение
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Запись данных доп. форм.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DMStepValueList - Массив - список доп. форм.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция OnWriteRowStepValues(SN, UserName, DMStepValueList) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
		
	Для каждого ДополнительнаяФорма Из DMStepValueList Цикл   
		// Аргументы пакета: DMStepId  DMValue DMDocId DMArtId DMRowId
		Если Не ЗначениеЗаполнено(ДополнительнаяФорма.form_id) Тогда
			Продолжить;
		КонецЕсли;
		
		ДополнительнаяФормаСсылка = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДополнительныеФормы"), СокрЛП(ДополнительнаяФорма.form_id));
		
		Если ДополнительнаяФормаСсылка = Справочники.ДатаМобайл_ДополнительныеФормы.ПустаяСсылка() Тогда
			Продолжить;
		КонецЕсли;  
		
		Попытка
			РегЗначениеФормы = РегистрыСведений.ДатаМобайл_ЗначенияДополнительныхФорм.СоздатьМенеджерЗаписи();
			РегЗначениеФормы.Документ = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(ДополнительнаяФорма.doc_id,5));
			
			Если ЗначениеЗаполнено(СокрЛП(ДополнительнаяФорма.art_id)) Тогда
				РегЗначениеФормы.Номенклатура = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ДополнительнаяФорма.art_id,4,36));
				
				ИДХК = Сред(ДополнительнаяФорма.art_id,40,36);
				Попытка
					Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
						РегЗначениеФормы.Характеристика = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);
					КонецЕсли;	
				Исключение	
				КонецПопытки;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(СокрЛП(ДополнительнаяФорма.row_id)) Тогда
				РегЗначениеФормы.ИдентификаторСтроки = Число(ДополнительнаяФорма.row_id);
			КонецЕсли;   
			
			РегЗначениеФормы.ДополнительнаяФорма = ДополнительнаяФормаСсылка;
			РегЗначениеФормы.Значение = СокрЛП(ДополнительнаяФорма.value);	
			
			РегЗначениеФормы.Записать(Истина);
		Исключение
		КонецПопытки;
	КонецЦикла;
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

#КонецОбласти

#Область Docs

// Получение данных строк документа (подбор).
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа ТСД.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetDocRowsSelect(SN, UserName, DocOutID) Экспорт 
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");	
		Возврат ПодготовитьОтветJSON(,СтруктураОтвета);	
	КонецПопытки;	
	
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда		
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");	
		Возврат ПодготовитьОтветJSON(,СтруктураОтвета);
	КонецЕсли;
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	ЗначенияРеквизитовСсылкаНаДок = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок, "ПометкаУдаления, Шаблон");
	
	ПометкаУдаления = ЗначенияРеквизитовСсылкаНаДок.ПометкаУдаления;
	Если ПометкаУдаления Тогда		
		СтруктураОтвета.Вставить("Описание", "Документ задания помечен на удаление. ");	
		Возврат ПодготовитьОтветJSON(,СтруктураОтвета);		
	КонецЕсли;	
	
	Шаблон = ЗначенияРеквизитовСсылкаНаДок.Шаблон;
	РеквизитыШаблона = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ВидДокумента,ИмяТабличнойЧастиПодбор,ИмяТабличнойЧастиПриемка,
	|РаспределениеТоваров,ИспользоватьПодбор,ИспользоватьПриемку,ЕГАИС,ИспользоватьМаркировку,
	|ИспользованиеЯчеекПодбор,ИспользованиеЯчеекПриемка,УчитыватьСерийниковВЗаданииПодбор,СерииВОтдельнойТЧ");
	
	ВидДокумента 									= РеквизитыШаблона.ВидДокумента;
	ИмяТабличнойЧастиПодбор 						= РеквизитыШаблона.ИмяТабличнойЧастиПодбор;
	ИмяТабличнойЧастиПриемка 						= РеквизитыШаблона.ИмяТабличнойЧастиПриемка;
	МножествоДокументовКакЗадание 					= РеквизитыШаблона.РаспределениеТоваров = 1;
	ИспользоватьПодбор								= РеквизитыШаблона.ИспользоватьПодбор;
	ИспользоватьПриемку								= РеквизитыШаблона.ИспользоватьПриемку;
	ГрупповойДокумент								= РеквизитыШаблона.РаспределениеТоваров = 2;
	ЕГАИС											= РеквизитыШаблона.ЕГАИС;
	ИспользоватьМаркировку							= РеквизитыШаблона.ИспользоватьМаркировку;
	ИспользованиеЯчеекПодбор                      	= РеквизитыШаблона.ИспользованиеЯчеекПодбор;
	ИспользованиеЯчеекПриемка                      	= РеквизитыШаблона.ИспользованиеЯчеекПриемка;
	УчитыватьСерийниковВЗаданииПодбор              	= РеквизитыШаблона.УчитыватьСерийниковВЗаданииПодбор;
	СерииВОтдельнойТЧ                      			= РеквизитыШаблона.СерииВОтдельнойТЧ;
	
	Если ВидДокумента = "ЗаданиеНаПеревозку" Тогда	
		ВидДокумента = "ЗаказКлиента";
		ИмяТабличнойЧастиПодбор = "Товары";
		ИмяТабличнойЧастиПриемка = "Товары";	
	КонецЕсли; 
	
	Если Не ИспользоватьПодбор Тогда
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
	КонецЕсли; 
	
	Если Не ЗначениеЗаполнено(СсылкаНаДок.ИсходныйДокумент) тогда
		Возврат ПодготовитьОтветJSON(ОбъектСписка);	
	КонецЕсли;
	
	Если ЕГАИС Тогда
		
		Если ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
			GetDocRowsSelectEGAIS_КТ2000(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок);
		Иначе
			GetDocRowsSelectEGAIS(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок);
		КонецЕсли;
		
	ИначеЕсли ВидДокумента = "ЗаказНаПеремещение" Тогда
		
		GetDocRowsSelectOrderToReplace(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок);
		
	ИначеЕсли ВидДокумента = "СборкаТоваров" Или ВидДокумента = "ЗаказНаСборку" Тогда
		
		GetDocRowsSborka_Select(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок);	
		
	ИначеЕсли ИспользоватьМаркировку
		И ПроверитьТребуетсяВыгрузкаМарок(СсылкаНаДок) Тогда
		
		GetDocRowsSelectMarking(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, РеквизитыШаблона);
		
	Иначе
		МетаданныеДокумента = Метаданные.Документы[ВидДокумента];
		
		Попытка
			лЕстьЯчейка = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Ячейка") <> Неопределено;
		Исключение
			лЕстьЯчейка = Ложь;
		КонецПопытки;
		
		Если ИспользованиеЯчеекПодбор > 0 И лЕстьЯчейка Тогда
			GetDocRowsSelectCells(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок);	
		Иначе	
			ПроверкаСерииВОтдельнойТЧ = Ложь;
			Если УчитыватьСерийниковВЗаданииПодбор Тогда		
				Попытка
					Для каждого ТЧ Из МетаданныеДокумента.ТабличныеЧасти Цикл
						Если ТЧ.Имя = "Серии" Тогда
							ПроверкаСерииВОтдельнойТЧ = Истина;
							Прервать;	
						КонецЕсли;
					КонецЦикла;
				Исключение
				КонецПопытки;
			КонецЕсли;
			
			Если ПроверкаСерииВОтдельнойТЧ И СерииВОтдельнойТЧ Тогда
				GetDocRowsSelectSN(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок);
			Иначе
				GetDocRowsSelectCasual(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение данных строк документа (приемка).
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа ТСД.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
// 
Функция GetDocRowsInsert(SN, UserName, DocOutID) Экспорт
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;	
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	 
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не найден документ.");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
	КонецПопытки;
	
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда		
		СтруктураОтвета.Вставить("Описание", "Не найден документ.");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
	КонецЕсли;
	
	Если СсылкаНаДок.ПометкаУдаления Тогда			
		СтруктураОтвета.Вставить("Описание", "Документ задания помечен на удаление.");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
	КонецЕсли;
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	РеквизитыШаблона = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ВидДокумента,ИмяТабличнойЧастиПодбор,ИмяТабличнойЧастиПриемка,
	|РаспределениеТоваров,ИспользоватьПодбор,ИспользоватьПриемку,ЕГАИС,ИспользоватьМаркировку,
	|ИспользованиеЯчеекПодбор,ИспользованиеЯчеекПриемка,РежимКомплектации");
	
	ВидДокумента 									= РеквизитыШаблона.ВидДокумента;
	ИмяТабличнойЧастиПодбор 						= РеквизитыШаблона.ИмяТабличнойЧастиПодбор;
	ИмяТабличнойЧастиПриемка 						= РеквизитыШаблона.ИмяТабличнойЧастиПриемка;
	МножествоДокументовКакЗадание 					= РеквизитыШаблона.РаспределениеТоваров = 1;
	ИспользоватьПодбор								= РеквизитыШаблона.ИспользоватьПодбор;
	ИспользоватьПриемку								= РеквизитыШаблона.ИспользоватьПриемку;
	ГрупповойДокумент								= РеквизитыШаблона.РаспределениеТоваров = 2;
	ЕГАИС											= РеквизитыШаблона.ЕГАИС;
	ИспользоватьМаркировку							= РеквизитыШаблона.ИспользоватьМаркировку;
	ИспользованиеЯчеекПодбор                      	= РеквизитыШаблона.ИспользованиеЯчеекПодбор;
	ИспользованиеЯчеекПриемка                      	= РеквизитыШаблона.ИспользованиеЯчеекПриемка;
	РежимКомплектации                      			= РеквизитыШаблона.РежимКомплектации;
	
	Если ВидДокумента = "ЗаданиеНаПеревозку" Тогда	
		ВидДокумента = "ЗаказКлиента";
		ИмяТабличнойЧастиПодбор = "Товары";
		ИмяТабличнойЧастиПриемка = "Товары";	
	КонецЕсли;
	
	Если Не ИспользоватьПриемку Тогда
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
	КонецЕсли;	
	
	Если Не ЗначениеЗаполнено(СсылкаНаДок.ИсходныйДокумент) тогда
		Возврат ПодготовитьОтветJSON(ОбъектСписка);	
	КонецЕсли;
	
	МетаданныеДокумента = Метаданные.Документы[ВидДокумента];
	
	Попытка
		лЕстьЯчейка = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПриемка].Реквизиты.Найти("Ячейка") <> Неопределено;
	Исключение
		лЕстьЯчейка = Ложь;
	КонецПопытки;
	
	Если ВидДокумента = "СборкаТоваров" Или ВидДокумента = "ЗаказНаСборку" Тогда
		
		GetDocRowsSborka_Insert(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок);
		
	ИначеЕсли ИспользованиеЯчеекПриемка > 0 И лЕстьЯчейка Тогда
		
		Запрос = Новый Запрос("ВЫБРАТЬ
		|	ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,
		|	ТаблицаТоваровВДокументе.Характеристика КАК Характеристика,
		|	&УсловиеУпаковка КАК Упаковка,
		|	&УсловиеСерия КАК Серия,
		|	СУММА(ТаблицаТоваровВДокументе.Количество) КАК Количество,
		|	ТаблицаТоваровВДокументе.Ячейка КАК Ячейка,
		|	МИНИМУМ(ТаблицаТоваровВДокументе.НомерСтроки) КАК НомерСтроки
		|ПОМЕСТИТЬ ЗапросСЛимитами
		|ИЗ
		|	Документ.ОтборРазмещениеТоваров.ТоварыОтбор КАК ТаблицаТоваровВДокументе
		|ГДЕ
		|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент
		|
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаТоваровВДокументе.Номенклатура,
		|	ТаблицаТоваровВДокументе.Характеристика,
		|	&УсловиеУпаковка,
		|	&УсловиеСерия,
		|	ТаблицаТоваровВДокументе.Ячейка
		|;
		|////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ЗапросСЛимитами.Номенклатура,
		|	ЗапросСЛимитами.Характеристика,
		|	ЗапросСЛимитами.Упаковка КАК Упаковка,
		|	ЗапросСЛимитами.Серия,
		|	СУММА(ЗапросСЛимитами.Количество) КАК Количество,
		|	ЗапросСЛимитами.Ячейка КАК Ячейка,
		|	МИНИМУМ(ЗапросСЛимитами.НомерСтроки) КАК НомерСтроки
		|ИЗ
		|	ЗапросСЛимитами КАК ЗапросСЛимитами
		|
		|СГРУППИРОВАТЬ ПО
		|	ЗапросСЛимитами.Номенклатура,
		|	ЗапросСЛимитами.Характеристика,
		|	ЗапросСЛимитами.Упаковка,
		|	ЗапросСЛимитами.Серия,
		|	ЗапросСЛимитами.Ячейка
		|		
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки");
		
		Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок);
		Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ОтборРазмещениеТоваров.", "." + ВидДокумента + ".");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыОтбор КАК ", "." + ИмяТабличнойЧастиПриемка + " КАК ");
		
		Попытка
			ЕстьСерии = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПриемка].Реквизиты.Найти("Серия") <> Неопределено;
		Исключение
			ЕстьСерии = Ложь;
		КонецПопытки;
		
		Если ЕстьСерии Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "ТаблицаТоваровВДокументе.Серия");
		Иначе
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "Значение(Справочник.СерииНоменклатуры.ПустаяСсылка)");
		КонецЕсли;
		
		Попытка
			ЕстьУпаковка = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПриемка].Реквизиты.Найти("Упаковка") <> Неопределено;
		Исключение
			ЕстьУпаковка = Ложь;
		КонецПопытки;		
		
		Если ЕстьУпаковка Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпаковка", "ТаблицаТоваровВДокументе.Упаковка");
		Иначе
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпаковка", "Значение(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)");
		КонецЕсли;
		
		Попытка
			ЕстьКоличествоУпаковок = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПриемка].Реквизиты.Найти("КоличествоУпаковок") <> Неопределено;
		Исключение
			ЕстьКоличествоУпаковок = Ложь;
		КонецПопытки;
		
		Если ЕстьКоличествоУпаковок И УзелПО.НеИспользоватьПересчетУпаковок Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", "ТаблицаТоваровВДокументе.КоличествоУпаковок");
		КонецЕсли; 
		
		Если ВидДокумента = "КорректировкаРеализации" И ИмяТабличнойЧастиПриемка = "Расхождения" Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", "ТаблицаТоваровВДокументе.Количество * ВЫБОР КОГДА ТаблицаТоваровВДокументе.Количество < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ");
		КонецЕсли;
		
		Рез = Запрос.Выполнить().Выгрузить();
		Для каждого СтрокаДока Из Рез Цикл
			
			СтруктураТекущейСтроки = Новый Структура;
			
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
			ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
			Попытка ОбъектТовара.parent_id = ?(XMLСтрока(СтрокаДока.Характеристика) = "00000000-0000-0000-0000-000000000000", "", "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
			СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
			
			Попытка
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");	
				ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура);
				СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
			Исключение
			Конецпопытки;
			
			Если ЗначениеЗаполнено(СтрокаДока.Ячейка) Тогда
				ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell","barcode");			
				Модуль_ШтрихкодированиеПечатныхФорм = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ШтрихкодированиеПечатныхФорм");
				ОбъектЯчейки.barcode = ?(УзелПО.ВыгружатьВКодЯчейки = 1, СтрокаДока.Ячейка.Код, Строка(Модуль_ШтрихкодированиеПечатныхФорм.ЧисловойКодПоСсылке(СтрокаДока.Ячейка)));
				СтруктураТекущейСтроки.Вставить("cell", ОбъектЯчейки);
			КонецЕсли;
			
			Попытка
				Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда
					sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия, Истина);
					СтруктураТекущейСтроки.Вставить("sn", sn);
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			Попытка
				ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
			Исключение
				ДопускВесовогоТовара = Неопределено;
			КонецПопытки;
			
			Если ДопускВесовогоТовара <> Неопределено Тогда
				СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
			КонецЕсли;
			
			Попытка
				ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
			Исключение
				ДопускОСГ = Неопределено;
			КонецПопытки;
			
			Если ДопускОСГ <> Неопределено Тогда
				СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
			КонецЕсли;
			
			ЭтоУслуга = Ложь;
			Попытка 
				Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
					ЭтоУслуга = Истина;
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			ЭтоНабор = Ложь;
			Попытка 
				Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Набор Тогда
					ЭтоНабор = Истина;
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			Если ЭтоНабор И РежимКомплектации = 1 Тогда
				СтруктураТекущейСтроки.Вставить("is_kit", Истина);
			Иначе
				СтруктураТекущейСтроки.Вставить("is_kit", Ложь);	
			КонецЕсли;
			
			limit_qty = 0;
			Если УзелПО.НеОтображатьОстатки Тогда
				limit_qty = 0;
			ИначеЕсли ЭтоУслуга Тогда
				limit_qty = 999;	
			Иначе
				Попытка 
					ТекущийСклад = СсылкаНаДок.Склад;
				Исключение
					ТекущийСклад = Справочники.Склады.ПустаяСсылка();
				КонецПопытки;
				
				limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, СтрокаДока.Характеристика, СтрокаДока.Ячейка, СтрокаДока.Упаковка);
			КонецЕсли;
			
			qty = СтрокаДока.Количество;
			
			СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
			СтруктураТекущейСтроки.Вставить("qty", qty);			
			Попытка
				СтруктураТекущейСтроки.Вставить("unit_qty", qty / ОбъектШтрихкода.unit_coef);
			Исключение
				СтруктураТекущейСтроки.Вставить("unit_qty", qty);
			КонецПопытки; 
			
			// атрибуты строки
			СтруктураПоиска = Новый Структура("НомерСтроки");
			ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаДока);
			СписокАтрибутов = ПолучитьАтрибутыСтрокиДокумента(СсылкаНаДок, СтрокаДока, Ложь, СтруктураПоиска);
			СтруктураТекущейСтроки.Вставить("attributes", СписокАтрибутов);
			
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);
			
		КонецЦикла;
	Иначе	
		Запрос = Новый Запрос("ВЫБРАТЬ
		|	ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,
		|	ТаблицаТоваровВДокументе.Характеристика КАК Характеристика,
		|	&УсловиеУпаковка КАК Упаковка,
		|	&УсловиеСерия КАК Серия,
		|	СУММА(ТаблицаТоваровВДокументе.Количество) КАК Количество,
		|	МИНИМУМ(ТаблицаТоваровВДокументе.НомерСтроки) КАК НомерСтроки
		|ПОМЕСТИТЬ ЗапросСЛимитами
		|ИЗ
		|	Документ.ПриходныйОрдерНаТовары.Товары КАК ТаблицаТоваровВДокументе
		|ГДЕ
		|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент
		|
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаТоваровВДокументе.Номенклатура,
		|	ТаблицаТоваровВДокументе.Характеристика,
		|	&УсловиеУпаковка,
		|	&УсловиеСерия
		|;
		|////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ЗапросСЛимитами.Номенклатура,
		|	ЗапросСЛимитами.Характеристика,
		|	ЗапросСЛимитами.Упаковка КАК Упаковка,
		|	ЗапросСЛимитами.Серия,
		|	СУММА(ЗапросСЛимитами.Количество) КАК Количество,
		|	СУММА(ЕСТЬNULL(ТоварыВЯчейкахОстатки.ВНаличииОстаток, 0)) КАК Лимит,
		|	МИНИМУМ(ЗапросСЛимитами.НомерСтроки) КАК НомерСтроки
		|ИЗ
		|	ЗапросСЛимитами КАК ЗапросСЛимитами
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
		|				,
		|				(&ВсеСклады
		|					ИЛИ Склад В (&Склады))
		|				И (&ВсеПомещения
		|					ИЛИ Помещение В (&Помещения))) КАК ТоварыВЯчейкахОстатки
		|		ПО ЗапросСЛимитами.Номенклатура = ТоварыВЯчейкахОстатки.Номенклатура
		|			И ЗапросСЛимитами.Характеристика = ТоварыВЯчейкахОстатки.Характеристика
		|
		|СГРУППИРОВАТЬ ПО
		|	ЗапросСЛимитами.Номенклатура,
		|	ЗапросСЛимитами.Характеристика,
		|	ЗапросСЛимитами.Упаковка,
		|	ЗапросСЛимитами.Серия
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки");
		
		Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок);
		Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
		
		СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
		Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
			СписокСкладов.Очистить();
			СписокСкладов.Добавить(СсылкаНаДок.Склад);			
		КонецЕсли;
		Запрос.УстановитьПараметр("Склады", СписокСкладов);
		Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
		
		СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
		Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
			СписокПомещений.Очистить();
			СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
		КонецЕсли;
		Запрос.УстановитьПараметр("Помещения", СписокПомещений);
		Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ПриходныйОрдерНаТовары.", "." + ВидДокумента + ".");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК ", "." + ИмяТабличнойЧастиПриемка + " КАК ");
		
		Попытка
			ЕстьСерии = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПриемка].Реквизиты.Найти("Серия") <> Неопределено;
		Исключение
			ЕстьСерии = Ложь;
		КонецПопытки;
		
		Если ЕстьСерии Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "ТаблицаТоваровВДокументе.Серия");
		Иначе
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "Значение(Справочник.СерииНоменклатуры.ПустаяСсылка)");
		КонецЕсли;
		
		Попытка
			ЕстьУпаковка = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПриемка].Реквизиты.Найти("Упаковка") <> Неопределено;
		Исключение
			ЕстьУпаковка = Ложь;
		КонецПопытки;
		
		Если ЕстьУпаковка Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпаковка", "ТаблицаТоваровВДокументе.Упаковка");
		Иначе
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпаковка", "Значение(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)");
		КонецЕсли;
		
		Попытка
			ЕстьКоличествоУпаковок = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПриемка].Реквизиты.Найти("КоличествоУпаковок") <> Неопределено;
		Исключение
			ЕстьКоличествоУпаковок = Ложь;
		КонецПопытки;
		
		Если ЕстьКоличествоУпаковок И УзелПО.НеИспользоватьПересчетУпаковок Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", "ТаблицаТоваровВДокументе.КоличествоУпаковок");
		КонецЕсли;  
		
		Если ВидДокумента = "КорректировкаРеализации" И ИмяТабличнойЧастиПриемка = "Расхождения" Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", "ТаблицаТоваровВДокументе.Количество * ВЫБОР КОГДА ТаблицаТоваровВДокументе.Количество < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ");
		КонецЕсли;
		
		Рез = Запрос.Выполнить().Выгрузить();
		Для каждого СтрокаДока Из Рез Цикл
			
			СтруктураТекущейСтроки = Новый Структура;
			
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
			ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
			Попытка ОбъектТовара.parent_id = ?(XMLСтрока(СтрокаДока.Характеристика) = "00000000-0000-0000-0000-000000000000", "", "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
			СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
			
			Попытка
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");	
				ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура);
				СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
			Исключение
			Конецпопытки;
			
			Попытка
				Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда
					sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия, Истина);
					СтруктураТекущейСтроки.Вставить("sn", sn);
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			Попытка
				ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
			Исключение
				ДопускВесовогоТовара = Неопределено;
			КонецПопытки;
			
			Если ДопускВесовогоТовара<>Неопределено Тогда
				СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
			КонецЕсли;
			
			Попытка
				ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
			Исключение
				ДопускОСГ = Неопределено;
			КонецПопытки;
			
			Если ДопускОСГ<>Неопределено Тогда
				СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
			КонецЕсли;
			
			ЭтоУслуга = Ложь;
			Попытка 
				Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
					ЭтоУслуга = Истина;
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			ЭтоНабор = Ложь;
			Попытка 
				Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Набор Тогда
					ЭтоНабор = Истина;
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			Если ЭтоНабор И РежимКомплектации = 1 Тогда
				СтруктураТекущейСтроки.Вставить("is_kit", Истина);
			Иначе
				СтруктураТекущейСтроки.Вставить("is_kit", Ложь);	
			КонецЕсли;
			
			limit_qty = 0;
			Если УзелПО.НеОтображатьОстатки Тогда
				limit_qty = 0;
			ИначеЕсли ЭтоУслуга Тогда
				limit_qty = 999;	
			Иначе	
				Попытка
					Итог = СтрокаДока.Лимит;
					limit_qty = Итог;
				Исключение
					limit_qty = 0;
				КонецПопытки;
			КонецЕсли;
			
			qty = СтрокаДока.Количество;
			
			СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
			СтруктураТекущейСтроки.Вставить("qty", qty);			
			Попытка
				СтруктураТекущейСтроки.Вставить("unit_qty", qty / ОбъектШтрихкода.unit_coef);
			Исключение
				СтруктураТекущейСтроки.Вставить("unit_qty", qty);
			КонецПопытки; 
			
			// атрибуты строки 
			СтруктураПоиска = Новый Структура("НомерСтроки");
			ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаДока);
			СписокАтрибутов = ПолучитьАтрибутыСтрокиДокумента(СсылкаНаДок, СтрокаДока, Ложь, СтруктураПоиска);
			СтруктураТекущейСтроки.Вставить("attributes", СписокАтрибутов);
			
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		КонецЦикла;
	КонецЕсли;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение объекта документа при сканировании ШК.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// Barcode - Строка - ШК документа.  
// TemplateID - Строка - Id шаблона.
// AppVersion - Строка - Версия ПО.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
// 
Функция OnDocScan(SN, UserName, Barcode, TemplateID, AppVersion) Экспорт
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);  
	КонецЕсли;	
	
	Попытка 
		ГУИД = ПолучитьГУИДПоШтрихкоду(Barcode);
		УникальныйИдентификатор = Новый УникальныйИдентификатор(ГУИД);
	Исключение 
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
	КонецПопытки;
	
	НайденныйДокумет1С = Неопределено;
	
	Если Не ЗначениеЗаполнено(TemplateID) Тогда
		
		НайденныйВидДокумента1С = Неопределено;
		
		//Выберем доступные для ТСД шаблоны		
		СписокШаблонов = УзелПО.Шаблоны.ВыгрузитьКолонку("Шаблон");
		Если СписокШаблонов.Количество() > 0 Тогда		
		Иначе
			ВыборкаШаблонов = Справочники.ДатаМобайл_ШаблоныДокументов.Выбрать();
			Пока ВыборкаШаблонов.Следующий() Цикл 
				СписокШаблонов.Добавить(ВыборкаШаблонов.Ссылка);
			КонецЦикла;	
		КонецЕсли;
		
		//Попробуем найти документ 1С по доступным шаблонам 		
		Для каждого ТекущийШаблон Из СписокШаблонов Цикл
			Если ТекущийШаблон.ПометкаУдаления Тогда
				Продолжить;
			КонецЕсли;
			Если Не ЗначениеЗаполнено(ТекущийШаблон.ВидДокумента) Тогда
				Продолжить;
			КонецЕсли;
			
			Попытка
				СсылкаНаОбъектГуид = Документы[ТекущийШаблон.ВидДокумента].ПолучитьСсылку(УникальныйИдентификатор);	
				Если СсылкаНаОбъектГуид.ПолучитьОбъект() <> Неопределено Тогда
					НайденныйДокумет1С = СсылкаНаОбъектГуид;
					НайденныйВидДокумента1С = ТекущийШаблон.ВидДокумента;
					НайденныйШаблон = ТекущийШаблон;
					Прервать;
				КонецЕсли;		
			Исключение
				Продолжить;
			КонецПопытки;
		КонецЦикла;
		
		Если НайденныйВидДокумента1С = Неопределено Тогда
			Возврат ПодготовитьОтветJSON(ОбъектСписка);
		КонецЕсли;
		
		//Проверим что шаблон с этим видом документа только один (иначе надо на ТСД было зайти в нужный шаблон)
		Сч = 0;
		Для каждого ТекущийШаблон Из СписокШаблонов Цикл
			Если ТекущийШаблон.ПометкаУдаления Тогда
				Продолжить;
			КонецЕсли;
			Если Не ЗначениеЗаполнено(ТекущийШаблон.ВидДокумента) Тогда
				Продолжить;
			КонецЕсли;
			
			Если ТекущийШаблон.ВидДокумента = НайденныйВидДокумента1С Тогда
				Сч = Сч + 1;
			КонецЕсли;
		КонецЦикла;
		
		Если Сч <> 1 Тогда
			СтруктураОтвета.Вставить("Описание", "Для документа создано несколько шаблонов, перед сканированием штрихкода документа выберите сначала шаблон.");	
			Возврат ПодготовитьОтветJSON(,СтруктураОтвета);	
		КонецЕсли;
		
	Иначе
		
		НайденныйШаблон = Справочники.ДатаМобайл_ШаблоныДокументов.НайтиПоКоду(TemplateID);
		Если Не ЗначениеЗаполнено(НайденныйШаблон.ВидДокумента) Тогда
			Возврат ПодготовитьОтветJSON(ОбъектСписка);
		КонецЕсли;
		
		Попытка
			СсылкаНаОбъектГуид = Документы[НайденныйШаблон.ВидДокумента].ПолучитьСсылку(УникальныйИдентификатор);	
			
			Если СсылкаНаОбъектГуид.ПолучитьОбъект() <> Неопределено Тогда
				НайденныйДокумет1С = СсылкаНаОбъектГуид;
			КонецЕсли;
		Исключение
			Возврат ПодготовитьОтветJSON(ОбъектСписка);
		КонецПопытки;			
		
	КонецЕсли;
		
	Если НайденныйДокумет1С = Неопределено Тогда
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
	КонецЕсли;
	
	Если НайденныйШаблон = Неопределено Тогда
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
	КонецЕсли;
			
	Попытка 
		
		//Попробуем найти текущий документ в АРМ
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
		|	ДатаМобайл_ДокументыТСД.Ссылка
		|ИЗ
		|	Справочник.ДатаМобайл_ДокументыТСД КАК ДатаМобайл_ДокументыТСД
		|ГДЕ
		|	ДатаМобайл_ДокументыТСД.Шаблон = &Шаблон
		|	И ДатаМобайл_ДокументыТСД.ИсходныйДокумент = &НайденныйДокумет1С
		|	И НЕ ДатаМобайл_ДокументыТСД.ПометкаУдаления";
		
		ВидДокумента1С = НайденныйДокумет1С.Метаданные().Имя;
		Запрос.УстановитьПараметр("Шаблон", НайденныйШаблон);
		Запрос.УстановитьПараметр("НайденныйДокумет1С", НайденныйДокумет1С);
		Результат = Запрос.Выполнить().Выбрать();
		Если Результат.Следующий() Тогда
			
			ДокументДМСсылка = Результат.Ссылка;					
			
		Иначе
			
			//Попробуем создать новый док							
			НовыйДок = Справочники.ДатаМобайл_ДокументыТСД.СоздатьЭлемент();
			НовыйДок.ИсходныйДокумент = НайденныйДокумет1С;
			НовыйДок.Шаблон = НайденныйШаблон;
			Если НайденныйШаблон.ГрупповаяРабота Тогда 
			Иначе	 
				НовыйДок.ТСД = УзелПО;
			КонецЕсли;	

			НовыйДок.ОбменДанными.Загрузка = Истина;
			
			НовыйДок.ОбменДанными.Получатели.Очистить();
			НовыйДок.ОбменДанными.Получатели.АвтоЗаполнение = Ложь;
			НовыйДок.Записать();
			
			ДокументДМСсылка = НовыйДок.Ссылка;
			
		КонецЕсли;			
		
	Исключение 
		
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
		
	КонецПопытки;	
			
	Запрос = Новый Запрос(
	//1) Запрос на DMIsMarkDoc = Ложь	
	"ВЫБРАТЬ
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Номер, """") КАК DMNumber,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Дата, ДАТАВРЕМЯ(1, 1, 1)) КАК DMDate,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.ПометкаУдаления, ИСТИНА)
	|				ИЛИ ДатаМобайл_ДокументыТСДИзменения.Ссылка.ДатаЗавершения <> ДАТАВРЕМЯ(1, 1, 1)
	|			    ИЛИ НЕ(&ВсеСклады
	|						ИЛИ 
	|						(ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)
	|						ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) В (&Склады)
	|						ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.СкладПолучатель, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) В (&Склады)))
	|		    	ИЛИ НЕ(&ВсеПомещения	
	|						ИЛИ 
	|						(ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Помещение, ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)
	|						ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Помещение, ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)) В (&Помещения)))
	|				ИЛИ НЕ(&ВсеШаблоны
	|						ИЛИ ДатаМобайл_ДокументыТСДИзменения.Ссылка.Шаблон В (&Шаблон))
	|				ИЛИ ВЫБОР
	|					КОГДА ЕСТЬNULL(Количество(СписокТерминаловВсего.ТСД),0)=0 И НЕ (ДатаМобайл_ДокументыТСДИзменения.Ссылка.ТСД = &ТСД ИЛИ ДатаМобайл_ДокументыТСДИзменения.Ссылка.ТСД = ЗНАЧЕНИЕ(планобмена.датамобайл_списоктсд.ПустаяСсылка))
	|						ТОГДА ИСТИНА
	|					КОГДА ЕСТЬNULL(Количество(СписокТерминаловВсего.ТСД),0)<>0 И ЕСТЬNULL(Количество(СписокТерминаловКонкретный.ТСД),0)=0
	|						ТОГДА ИСТИНА
	|					ИНАЧЕ ЛОЖЬ
	|					КОНЕЦ
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК DMisMarkDoc,
	|	ДатаМобайл_ДокументыТСДИзменения.Ссылка КАК ДокСсылка,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Номер, """") КАК DMBarcode,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Комментарий, """") КАК DMComment,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Приоритет, 0) КАК Приоритет,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.ДатаЗавершенияСбора, ДАТАВРЕМЯ(1, 1, 1)) = ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК DMisLoaded,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Клиент, ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)) КАК КлиентСсылка,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад.Наименование, """") КАК DMWarehouseName,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад.Ссылка, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) КАК СкладСсылка,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.СкладПолучатель.Наименование, """") КАК DMWarehouseName2,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.СкладПолучатель.Ссылка, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) КАК СкладПолучательСсылка,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Шаблон.Ссылка, ЗНАЧЕНИЕ(Справочник.ДатаМобайл_ШаблоныДокументов.ПустаяСсылка)) КАК ШаблонСсылка
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД КАК ДатаМобайл_ДокументыТСДИзменения
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СписокТерминалов КАК СписокТерминаловВсего
	|		ПО ДатаМобайл_ДокументыТСДИзменения.Ссылка = СписокТерминаловВсего.Ссылка 
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СписокТерминалов КАК СписокТерминаловКонкретный
	|		ПО ДатаМобайл_ДокументыТСДИзменения.Ссылка = СписокТерминаловКонкретный.Ссылка
	|		И  (СписокТерминаловКонкретный.ТСД = &ТСД ИЛИ СписокТерминаловКонкретный.ТСД = ЗНАЧЕНИЕ(планобмена.датамобайл_списоктсд.ПустаяСсылка))
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДИзменения.Ссылка = &НовыйДокумент 
	|
	|СГРУППИРОВАТЬ ПО 
	|  	ДатаМобайл_ДокументыТСДИзменения.Ссылка");
		
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	ВсеСклады = ?(СписокСкладов.Количество() = 0, Истина, Ложь);
	
	СписокШаблонов = УзелПО.Шаблоны.ВыгрузитьКолонку("Шаблон");
	ВсеШаблоны = ?(СписокШаблонов.Количество() = 0, Истина, Ложь);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	ВсеПомещения = ?(СписокПомещений.Количество() = 0, Истина, Ложь);
	
	Запрос.УстановитьПараметр("ТСД", УзелПО.Ссылка);
	Запрос.УстановитьПараметр("НовыйДокумент", ДокументДМСсылка);
	
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", ВсеСклады);
	
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", ВсеПомещения);
	
	Запрос.УстановитьПараметр("Шаблон", СписокШаблонов);
	Запрос.УстановитьПараметр("ВсеШаблоны", ВсеШаблоны);
		
	Рез = Запрос.Выполнить().Выбрать();
	Пока Рез.Следующий() Цикл
		
		СсылкаДокумента = Рез.ДокСсылка;
		ИсходныйДокумент = СсылкаДокумента.ИсходныйДокумент;
		
		ОбъектДока = ПолучитьСтруктуруОбъектаДляHttp("doc");
		ЗаполнитьЗначенияСвойств(ОбъектДока,Рез);
		ОбъектДока.id = "d82-" + XMLСтрока(СсылкаДокумента);						
		ОбъектДока.is_deleted = Рез.DMisMarkDoc;
		ОбъектДока.comment = ЧистаяСтрока(Рез.DMComment);
		ОбъектДока.barcode = ЧистаяСтрока(Рез.DMBarcode);
		Попытка	ОбъектДока.date = ЧистаяСтрока(ИсходныйДокумент.Дата) Исключение ОбъектДока.date = ЧистаяСтрока(Рез.DMDate); КонецПопытки;
		Попытка ОбъектДока.date_timestamp = ДатуВTimestamp(ИсходныйДокумент.Дата) Исключение ОбъектДока.date_timestamp = ДатуВTimestamp(Рез.DMDate); КонецПопытки;
		ОбъектДока.number = ЧистаяСтрока(Рез.DMNumber);
		
		//Штрихкод от 1С	
		Попытка
			ОбъектДока.barcode = ЧисловойКодПоСсылке(ИсходныйДокумент);
		Исключение
			ОбъектДока.barcode = "";
		КонецПопытки;
		
		Если СсылкаДокумента.СписокДокументов.Количество() > 0 Тогда
			IsParent = Истина;
		Иначе
			IsParent = Ложь;
		КонецЕсли;	
		
		Если ЗначениеЗаполнено(СсылкаДокумента.РодительскийДокумент) Тогда
			ParentDocOutID = "d82-" + XMLСтрока(СсылкаДокумента.РодительскийДокумент);
		Иначе
			ParentDocOutID = "";
		КонецЕсли;
		
		Если ЗначениеЗаполнено(СсылкаДокумента.Организация) Тогда
			Попытка inn = СсылкаДокумента.Организация.ИНН; Исключение inn = ""; КонецПопытки;
		Иначе
			inn = "";
		КонецЕсли;
		
		ОбъектДока.parent_doc_id = ParentDocOutID;
		ОбъектДока.is_parent = IsParent;
		ОбъектДока.inn = inn;
		ОбъектДока.priority = Рез.Приоритет;
				
		ОбъектШаблона = ПолучитьСтруктуруОбъектаДляHttp("template");
		ЗаполнитьОбъектШаблона(ОбъектШаблона, Рез.ШаблонСсылка, AppVersion);
		ОбъектДока.Вставить("template", ОбъектШаблона);
		
		Если ЗначениеЗаполнено(Рез.КлиентСсылка) Тогда
			ОбъектКлиента = ПолучитьСтруктуруОбъектаДляHttp("client");
			ОбъектКлиента.id = "8k-" + XMLСтрока(Рез.КлиентСсылка);
			ОбъектКлиента.name = ЧистаяСтрока(Рез.КлиентСсылка.Наименование);
			Попытка ОбъектКлиента.barcode = Рез.КлиентСсылка.ИНН; Исключение КонецПопытки;
			ОбъектДока.Вставить("client", ОбъектКлиента);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.СкладСсылка) Тогда			
			ОбъектСклада = ПолучитьСтруктуруОбъектаДляHttp("warehouse");
			ОбъектСклада.id = XMLСтрока(Рез.СкладСсылка);
			ОбъектСклада.name = Рез.DMWarehouseName;		
			ОбъектДока.Вставить("warehouse_1", ОбъектСклада);	
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.СкладПолучательСсылка) Тогда
			ОбъектСклада2 = ПолучитьСтруктуруОбъектаДляHttp("warehouse");
			ОбъектСклада2.id = XMLСтрока(Рез.СкладПолучательСсылка);
			ОбъектСклада2.name = Рез.DMWarehouseName2;
			ОбъектДока.Вставить("warehouse_2", ОбъектСклада2);
		КонецЕсли;
		
		Если Рез.ШаблонСсылка.ИспользоватьДопФормы Тогда
			//Дополнительные формы
			ОбъектСпискаДополнительныхФорм = Новый Массив;
			ЗапросДополнительныхФорм = Новый Запрос;
			ЗапросДополнительныхФорм.Текст = 
			"ВЫБРАТЬ
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ДополнительнаяФорма.Ссылка КАК Ссылка,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.Порядок КАК Порядок,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.РеквизитИзШапки КАК РеквизитИзШапки,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПроверятьЗаполнение,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПроверкаПоЗаданию,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.РежимВвода,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПодборРазмещение КАК ПодборРазмещение
			|ИЗ
			|	РегистрСведений.ДатаМобайл_СвязиДополнительныхФормИШаблонов КАК ДатаМобайл_СвязиДополнительныхФормИШаблонов
			|ГДЕ
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.Шаблон = &Шаблон
			|	И ДатаМобайл_СвязиДополнительныхФормИШаблонов.ДополнительнаяФорма.ПометкаУдаления = ЛОЖЬ";
			
			ЗапросДополнительныхФорм.УстановитьПараметр("Шаблон", Рез.ШаблонСсылка);
			
			РезультатЗапросаДополнительныхФорм = ЗапросДополнительныхФорм.Выполнить();
			ВыборкаДополнительныхФорм = РезультатЗапросаДополнительныхФорм.Выбрать();
			Пока ВыборкаДополнительныхФорм.Следующий() Цикл
				Если Не ЗначениеЗаполнено(ВыборкаДополнительныхФорм.Ссылка) Тогда 
					Продолжить;
				КонецЕсли;
				
				НомерАтрибута = ПолучитьНомерАтрибутаДляДопФормы(Рез.ШаблонСсылка, ВыборкаДополнительныхФорм.Ссылка, ВыборкаДополнительныхФорм.РеквизитИзШапки);
				Если НомерАтрибута = 0 Тогда Продолжить; КонецЕсли;
				
				ОбъектДополнительныхФорм = ПолучитьСтруктуруОбъектаДляHttp("doc_form","doc");
				ОбъектДополнительныхФорм.id = XMLСтрока(ВыборкаДополнительныхФорм.Ссылка);
				ОбъектДополнительныхФорм.doc_id = "d82-" + XMLСтрока(Рез.ДокСсылка);
				ОбъектДополнительныхФорм.attribute_number = НомерАтрибута;
				ОбъектДополнительныхФорм.is_check_by_task = ВыборкаДополнительныхФорм.ПроверкаПоЗаданию;
				ОбъектДополнительныхФорм.enter_mode       = ВыборкаДополнительныхФорм.РежимВвода;		
				ОбъектДополнительныхФорм.is_required = ВыборкаДополнительныхФорм.ПроверятьЗаполнение; 
				ОбъектДополнительныхФорм.form_type = ВыборкаДополнительныхФорм.РеквизитИзШапки;
				ОбъектДополнительныхФорм.operation_type   = ВыборкаДополнительныхФорм.ПодборРазмещение;
				ОбъектСпискаДополнительныхФорм.Добавить(ОбъектДополнительныхФорм);
				
			КонецЦикла;
			ОбъектДока.Вставить("forms", ОбъектСпискаДополнительныхФорм);
		КонецЕсли;
		
		ОбъектСписка.Добавить(ОбъектДока);
		
	КонецЦикла;	
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение групповых строк документов с групповой работой.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа.  
// LastRequestDate - Строка - Дата и время последней синхронизации.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
// 
Функция GetSelectedQtyGroupDocRows(SN, UserName, DocOutID, LastRequestDate) Экспорт
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	Если LastRequestDate = "0" Тогда 
		ДатаПоследнегоЗапроса = Дата(1, 1, 1);
	Иначе
		ДатаПоследнегоЗапроса = TimestampВДату(LastRequestDate);	
	КонецЕсли;
	
	ТекущаяДатаЗапроса = ТекущаяДата();	
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	РаспределениеТоваров = СсылкаНаДок.Шаблон.РаспределениеТоваров;
	СписокДокументов = СсылкаНаДок.СписокДокументов.ВыгрузитьКолонку("ДокументТСД");
	created_at = ДатуВTimestamp(ТекущаяДатаЗапроса, Истина);
	Шаблон = СсылкаНаДок.Шаблон;
	DMUseSN = Ложь;
	
	Если РаспределениеТоваров = 2 Тогда
		Если СписокДокументов.Количество() = 0 И Не ЗначениеЗаполнено(СсылкаНаДок.РодительскийДокумент) Тогда		
			СтруктураОтвета.Вставить("Описание", "Настройка ""Групповой документ"" не поддерживает работу без задания! ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	Если LastRequestDate = "0" Тогда 
		ДатаПоследнегоЗапроса = Дата(1, 1, 1);
	Иначе
		ДатаПоследнегоЗапроса = TimestampВДату(LastRequestDate);	
	КонецЕсли;
	
	ТекущаяДатаЗапроса = ТекущаяДата();	
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	РаспределениеТоваров = СсылкаНаДок.Шаблон.РаспределениеТоваров;
	СписокДокументов = СсылкаНаДок.СписокДокументов.ВыгрузитьКолонку("ДокументТСД");
	created_at = ДатуВTimestamp(ТекущаяДатаЗапроса, Истина);
	Шаблон = СсылкаНаДок.Шаблон;
	DMUseSN = Ложь;
	
	Если РаспределениеТоваров = 2 Тогда
		Если СписокДокументов.Количество() = 0 И Не ЗначениеЗаполнено(СсылкаНаДок.РодительскийДокумент) Тогда		
			СтруктураОтвета.Вставить("Описание", "Настройка ""Групповой документ"" не поддерживает работу без задания! ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	
	"ВЫБРАТЬ
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД КАК ДокументТСД,
	|	ВЫБОР
	|		КОГДА ДатаМобайл_СтрокиГрупповыхДокументов.ИмяТаблицы = ""Select""
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК operation_type,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Штрихкод КАК barcode,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.СерийныйНомер КАК sn,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Ячейка КАК cell,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.НазваниеТовара КАК art_name,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.КодТовара КАК art_id,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Короб КАК box_pack,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист КАК pack,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ЕдиницаИзмерения КАК Упаковка,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы, 1) = 0
	|			ТОГДА 1
	|		ИНАЧЕ ЕСТЬNULL(ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы, 1)
	|	КОНЕЦ КАК Коэффициент,
	|	СУММА(ДатаМобайл_СтрокиГрупповыхДокументов.Количество * ВЫБОР
	|			КОГДА ЕСТЬNULL(ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы, 1) = 0
	|				ТОГДА 1
	|			ИНАЧЕ ЕСТЬNULL(ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы, 1)
	|		КОНЕЦ) КАК qty
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ДатаМобайл_СтрокиГрупповыхДокументов
	|ГДЕ
	|	НЕ ДатаМобайл_СтрокиГрупповыхДокументов.ТСД = &ТСД
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД = &ИндетификаторДокумента
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.ДатаЗаписи >= &ДатаНач
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.ДатаЗаписи < &ДатаКон
	|	И НЕ ДатаМобайл_СтрокиГрупповыхДокументов.ДатаЗаписи = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД,
	|	ВЫБОР
	|		КОГДА ДатаМобайл_СтрокиГрупповыхДокументов.ИмяТаблицы = ""Select""
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Штрихкод,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.СерийныйНомер,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Ячейка,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.КодТовара,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.НазваниеТовара,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ЕдиницаИзмерения,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Короб,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист
	|
	|ИМЕЮЩИЕ СУММА(ДатаМобайл_СтрокиГрупповыхДокументов.Количество * ВЫБОР
	|			КОГДА ЕСТЬNULL(ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы, 1) = 0
	|				ТОГДА 1
	|			ИНАЧЕ ЕСТЬNULL(ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы, 1)
	|		КОНЕЦ) <> 0";
	
	Запрос.УстановитьПараметр("ДатаНач", ДатаПоследнегоЗапроса);
	Запрос.УстановитьПараметр("ДатаКон", ТекущаяДатаЗапроса);
	Запрос.УстановитьПараметр("Тсд", УзелПО);
	
	Если РаспределениеТоваров = 2 Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД = &ИндетификаторДокумента", "ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД В(&ДокументыТСД)");
		Запрос.УстановитьПараметр("ДокументыТСД", СписокДокументов);
	Иначе	
		Запрос.УстановитьПараметр("ИндетификаторДокумента", СсылкаНаДок);
	КонецЕсли;
	
	Рез = Запрос.Выполнить().Выбрать();	
	
	Пока Рез.Следующий() Цикл
		
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan");
		ОбъектТовара.name = Рез.art_name;
		ОбъектТовара.id   = Рез.art_id;	
		
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		СтруктураТекущейСтроки.Вставить("operation_type", Рез.operation_type);
		СтруктураТекущейСтроки.Вставить("created_at", created_at);   
		
		Если ЗначениеЗаполнено(Рез.barcode) Тогда
			ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode", "value");
			ОбъектШтрихкода.value = ЧистаяСтрока(Рез.barcode);					
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
		КонецЕсли;
		
		
		Если ЗначениеЗаполнено(Рез.cell) Тогда
			ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell","barcode");
			ОбъектЯчейки.barcode  = Рез.cell;
			СтруктураТекущейСтроки.Вставить("cell", ОбъектЯчейки);
		КонецЕсли;	
		
		Если ЗначениеЗаполнено(Рез.sn) Тогда
			СтруктураТекущейСтроки.Вставить("sn", Рез.sn);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.box_pack) Тогда
			СтруктураТекущейСтроки.Вставить("box_pack", Рез.box_pack);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.pack) Тогда
			СтруктураТекущейСтроки.Вставить("pack", Рез.pack);
		КонецЕсли;
		
		СтруктураТекущейСтроки.Вставить("qty", Рез.qty);
		
		СтруктураТекущейСтроки.Вставить("unit_qty", Рез.qty);
		
		Если РаспределениеТоваров = 2 Тогда
			СтруктураТекущейСтроки.Вставить("child_doc_out_id","d82-" + XMLСтрока(Рез.ДокументТСД));			
		КонецЕсли; 
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);    
		
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

Функция GetPreviousDocRows(SN, UserName, DocOutID) Экспорт
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;	
		
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	СобранныеДанныеПодбор.Ссылка КАК ДокументТСД,
	|	0 КАК operation_type,
	|	СобранныеДанныеПодбор.Дата КАК date,
	|	СобранныеДанныеПодбор.ИдентификаторСтроки КАК row_id,
	|	СобранныеДанныеПодбор.Пользователь КАК username,
	|	СобранныеДанныеПодбор.ТСД.Код КАК device_id,
	|	СобранныеДанныеПодбор.КодТовара КАК art_id,
	|	СобранныеДанныеПодбор.НазваниеТовара КАК art_name,
	|	СобранныеДанныеПодбор.Номенклатура КАК Номенклатура,    
	|	СобранныеДанныеПодбор.Номенклатура.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
	|	СобранныеДанныеПодбор.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,
	|	СобранныеДанныеПодбор.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
	|	СобранныеДанныеПодбор.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	|	СобранныеДанныеПодбор.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
	|	СобранныеДанныеПодбор.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	СобранныеДанныеПодбор.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
	|	СобранныеДанныеПодбор.ХарактеристикаНоменклатуры.Наименование КАК НаименованиеХарактеристики,     
	|	СобранныеДанныеПодбор.ХарактеристикаНоменклатуры КАК Характеристика,
	|	СобранныеДанныеПодбор.ЕдиницаИзмерения КАК Упаковка,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(СобранныеДанныеПодбор.КоэффициентЕдиницы, 1) = 0
	|			ТОГДА 1
	|		ИНАЧЕ ЕСТЬNULL(СобранныеДанныеПодбор.КоэффициентЕдиницы, 1)
	|	КОНЕЦ КАК Коэффициент,
	|	СобранныеДанныеПодбор.Штрихкод КАК barcode,
	|	СобранныеДанныеПодбор.СерийныйНомер КАК sn,
	|	СобранныеДанныеПодбор.Ячейка КАК cell,
	|	СобранныеДанныеПодбор.Короб КАК box_pack,
	|	СобранныеДанныеПодбор.УпаковочныйЛист КАК pack,
	|	СобранныеДанныеПодбор.УпаковочныйЛистАтрибуты КАК pack_attributes,
	|	СобранныеДанныеПодбор.GS1 КАК gs1_barcode,
	|	СобранныеДанныеПодбор.Количество * 
	|		ВЫБОР
	|			КОГДА ЕСТЬNULL(СобранныеДанныеПодбор.КоэффициентЕдиницы, 1) = 0
	|				ТОГДА 1
	|			ИНАЧЕ ЕСТЬNULL(СобранныеДанныеПодбор.КоэффициентЕдиницы, 1)
	|		КОНЕЦ КАК qty,
	|	СобранныеДанныеПодбор.КоличествоВУпаковке КАК qty_in_pack,
	|	СобранныеДанныеПодбор.НоменклатураЕГАИС КАК НоменклатураЕГАИС,
	|	СобранныеДанныеПодбор.ЕгаисПолныйКод КАК egais_mark,
	|	СобранныеДанныеПодбор.PDF КАК egais_alcocode,
	|	СобранныеДанныеПодбор.ЦРПТМарка КАК marking_mark,
	|	СобранныеДанныеПодбор.KM_GTIN КАК marking_gtin,
	|	СобранныеДанныеПодбор.KM_RawMrc КАК marking_raw_mrc,
	|	СобранныеДанныеПодбор.KM_DecodedMrc КАК marking_decoded_mrc,
	|	СобранныеДанныеПодбор.KM_TNVED КАК marking_tnvd
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК СобранныеДанныеПодбор
	|ГДЕ
	|	СобранныеДанныеПодбор.Ссылка = &СсылкаНаДок
	|	И СобранныеДанныеПодбор.ПризнакПовторнойВыгрузки
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	СобранныеДанныеПриемка.Ссылка КАК ДокументТСД,
	|	1 КАК operation_type,
	|	СобранныеДанныеПриемка.Дата КАК date,
	|	СобранныеДанныеПриемка.ИдентификаторСтроки КАК row_id,
	|	СобранныеДанныеПриемка.Пользователь КАК username,
	|	СобранныеДанныеПриемка.ТСД.Код КАК device_id,
	|	СобранныеДанныеПриемка.КодТовара КАК art_id,
	|	СобранныеДанныеПриемка.НазваниеТовара КАК art_name,
	|	СобранныеДанныеПриемка.Номенклатура КАК Номенклатура,     
	|	СобранныеДанныеПриемка.Номенклатура.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
	|	СобранныеДанныеПриемка.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,
	|	СобранныеДанныеПриемка.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
	|	СобранныеДанныеПриемка.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	|	СобранныеДанныеПриемка.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
	|	СобранныеДанныеПриемка.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	СобранныеДанныеПриемка.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
	|	СобранныеДанныеПриемка.ХарактеристикаНоменклатуры.Наименование КАК НаименованиеХарактеристики,  	 
	|	СобранныеДанныеПриемка.ХарактеристикаНоменклатуры КАК Характеристика,
	|	СобранныеДанныеПриемка.ЕдиницаИзмерения КАК Упаковка,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(СобранныеДанныеПриемка.КоэффициентЕдиницы, 1) = 0
	|			ТОГДА 1
	|		ИНАЧЕ ЕСТЬNULL(СобранныеДанныеПриемка.КоэффициентЕдиницы, 1)
	|	КОНЕЦ КАК Коэффициент,
	|	СобранныеДанныеПриемка.Штрихкод КАК barcode,
	|	СобранныеДанныеПриемка.СерийныйНомер КАК sn,
	|	СобранныеДанныеПриемка.Ячейка КАК cell,
	|	СобранныеДанныеПриемка.Короб КАК box_pack,
	|	СобранныеДанныеПриемка.УпаковочныйЛист КАК pack,
	|	СобранныеДанныеПриемка.УпаковочныйЛистАтрибуты КАК pack_attributes,
	|	СобранныеДанныеПриемка.GS1 КАК gs1_barcode,
	|	СобранныеДанныеПриемка.Количество * 
	|		ВЫБОР
	|			КОГДА ЕСТЬNULL(СобранныеДанныеПриемка.КоэффициентЕдиницы, 1) = 0
	|				ТОГДА 1
	|			ИНАЧЕ ЕСТЬNULL(СобранныеДанныеПриемка.КоэффициентЕдиницы, 1)
	|		КОНЕЦ КАК qty,
	|	СобранныеДанныеПриемка.КоличествоВУпаковке КАК qty_in_pack,
	|	СобранныеДанныеПриемка.НоменклатураЕГАИС КАК НоменклатураЕГАИС,
	|	СобранныеДанныеПриемка.ЕгаисПолныйКод КАК egais_mark,
	|	СобранныеДанныеПриемка.PDF КАК egais_alcocode,
	|	СобранныеДанныеПриемка.ЦРПТМарка КАК marking_mark,
	|	СобранныеДанныеПриемка.KM_GTIN КАК marking_gtin,
	|	СобранныеДанныеПриемка.KM_RawMrc КАК marking_raw_mrc,
	|	СобранныеДанныеПриемка.KM_DecodedMrc КАК marking_decoded_mrc,
	|	СобранныеДанныеПриемка.KM_TNVED КАК marking_tnvd
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПриемка КАК СобранныеДанныеПриемка
	|ГДЕ
	|	СобранныеДанныеПриемка.Ссылка = &СсылкаНаДок
	|	И СобранныеДанныеПриемка.ПризнакПовторнойВыгрузки";
	
	Запрос.УстановитьПараметр("СсылкаНаДок", СсылкаНаДок);
	
	Рез = Запрос.Выполнить().Выбрать();	
	Пока Рез.Следующий() Цикл
		
		СтруктураТекущейСтроки = Новый Структура;
		СтруктураТекущейСтроки.Вставить("operation_type", 	Рез.operation_type);
		
		СтруктураТекущейСтроки.Вставить("date", 			ЧистаяСтрока(Рез.date));
		СтруктураТекущейСтроки.Вставить("date_timestamp", 	ДатуВTimestamp(Рез.date,Истина));
		
		СтруктураТекущейСтроки.Вставить("row_id", 			Рез.row_id);
		СтруктураТекущейСтроки.Вставить("username", 		Рез.username);
		СтруктураТекущейСтроки.Вставить("device_id", 		Рез.device_id);
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan");
		ОбъектТовара.name = Рез.art_name;
		ОбъектТовара.id   = Рез.art_id;		
		
		Если ЗначениеЗаполнено(Рез.Номенклатура) Тогда
			ТекущаяНоменклатура  = Рез.Номенклатура;
			ТекущаяХарактеристика  = Рез.Характеристика;
			ОбъектТовара.price = ПолучитьЦенуТовара(ТекущаяНоменклатура, ТекущаяХарактеристика, УзелПО.ТипЦен);	
			
			// Выгрузка дополнительных видов цен
			ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, ТекущаяНоменклатура, ТекущаяХарактеристика);
			
			Попытка	
				DMUseSN = ПолучитьПризнакУчетаСерий(ТекущаяНоменклатура.ВидНоменклатуры, СсылкаНаДок.Склад);
			Исключение
				DMUseSN = Ложь;
			КонецПопытки;
			
			СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, Рез, DMUseSN, СсылкаНаДок.Шаблон);
		КонецЕсли;
		
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		Попытка
			ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","unit_value");
			ОбъектШтрихкода.value = ЧистаяСтрока(Рез.barcode);			
			ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, Рез.Упаковка, ТекущаяНоменклатура);		
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
		Исключение
		Конецпопытки;
		
		Если ЗначениеЗаполнено(Рез.sn) Тогда
			СтруктураТекущейСтроки.Вставить("sn", Рез.sn);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.cell) Тогда
			ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell","barcode");
			ОбъектЯчейки.barcode  = Рез.cell;
			СтруктураТекущейСтроки.Вставить("cell", ОбъектЯчейки);
		КонецЕсли;
		
		СтруктураТекущейСтроки.Вставить("qty", Рез.qty);
		СтруктураТекущейСтроки.Вставить("qty_in_pack", Рез.qty_in_pack);
		Попытка
			СтруктураТекущейСтроки.Вставить("unit_qty", Рез.qty / ОбъектШтрихкода.unit_coef);
		Исключение
			СтруктураТекущейСтроки.Вставить("unit_qty", Рез.qty);
		КонецПопытки;
		
		ОбъектЕГАИС = ПолучитьСтруктуруОбъектаДляHttp("egais");
		ОбъектЕГАИС.mark = Рез.egais_mark;
		Если ЗначениеЗаполнено(ОбъектЕГАИС.mark) Тогда
			СтруктураТекущейСтроки.Вставить("egais", ОбъектЕГАИС);
		КонецЕсли;
		
		ОбъектМаркировка = ПолучитьСтруктуруОбъектаДляHttp("marking","logs");
		ОбъектМаркировка.mark = Рез.marking_mark;	
		ОбъектМаркировка.gtin = Рез.marking_gtin;
		ОбъектМаркировка.raw_mrc = Рез.marking_raw_mrc;
		ОбъектМаркировка.decoded_mrc = Рез.marking_decoded_mrc;
		ОбъектМаркировка.tnvd = Рез.marking_tnvd;
		Если ЗначениеЗаполнено(ОбъектМаркировка.mark) Тогда
			СтруктураТекущейСтроки.Вставить("marking", ОбъектМаркировка);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.box_pack) Тогда
			СтруктураТекущейСтроки.Вставить("box_pack", Рез.box_pack);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.pack) Тогда
			СтруктураТекущейСтроки.Вставить("pack", Рез.pack);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.pack_attributes) Тогда
			СтруктураТекущейСтроки.Вставить("pack_attributes", Рез.pack_attributes);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.gs1_barcode) Тогда
			СтруктураТекущейСтроки.Вставить("gs1_barcode", Рез.gs1_barcode);
		КонецЕсли;
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Получение данных реквизитов документа.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DMDocsIDs - Строка - Массив идентификаторов документов в ПО.  
// AppVersion - Строка - Версия ПО.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
// 
Функция GetDocHeads(SN, UserName, DMDocsIDs, AppVersion) Экспорт 
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьДокументы") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьДокументы", Ложь);	 
	КонецЕсли;	
	
	СтруктураНастроек = Новый Структура;
	
	СтруктураНастроек.Вставить("Склады", "");
	СтруктураНастроек.Вставить("Шаблоны", "");
	СтруктураНастроек.Вставить("Помещения", "");

	СтруктураНастроекТСД = ПланыОбмена.ДатаМобайл_СписокТСД.ПолучитьНастройкиТабличныхЧастейТСД(УзелПО, СтруктураНастроек);
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	
	//Дополнительная верификация документов
	МассивДокументов = Новый Массив;    
	
	Для каждого DocOutID Из DMDocsIDs.docs_ids Цикл	
		
		Попытка
			СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));       
			
			Если Не Модуль_ОбщегоНазначения.СсылкаСуществует(СсылкаНаДок) Тогда
				
				ОбъектДока = ПолучитьСтруктуруОбъектаДляHttp("doc");    
				ОбъектДока.id = DocOutID;
				ОбъектДока.is_deleted = Истина;     
				ОбъектСписка.Добавить(ОбъектДока);
				
			Иначе
				МассивДокументов.Добавить(СсылкаНаДок);
			КонецЕсли;
			
		Исключение
			
		КонецПопытки;
		
	КонецЦикла;	
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ДатаМобайл_ДокументыТСД.Ссылка,
	|	ЕСТЬNULL(КОЛИЧЕСТВО(СписокТерминаловВсего.ТСД), 0) > 0 КАК ЕстьОграничениеТСД,
	|	ЕСТЬNULL(КОЛИЧЕСТВО(СписокТерминаловКонкретный.ТСД), 0) > 0 КАК ЕстьЭтотТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД КАК ДатаМобайл_ДокументыТСД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СписокТерминалов КАК СписокТерминаловВсего
	|		ПО ДатаМобайл_ДокументыТСД.Ссылка = СписокТерминаловВсего.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СписокТерминалов КАК СписокТерминаловКонкретный
	|		ПО ДатаМобайл_ДокументыТСД.Ссылка = СписокТерминаловКонкретный.Ссылка
	|			И (СписокТерминаловКонкретный.ТСД = &ТСД
	|				ИЛИ СписокТерминаловКонкретный.ТСД = ЗНАЧЕНИЕ(ПланОбмена.ДатаМобайл_СписокТСД.ПустаяСсылка))
	|ГДЕ
	|	НЕ ДатаМобайл_ДокументыТСД.Ссылка В (&СписокДокументов)
	|	И НЕ(ЕСТЬNULL(ДатаМобайл_ДокументыТСД.Ссылка.ПометкаУдаления, ИСТИНА)
	|				ИЛИ ДатаМобайл_ДокументыТСД.Ссылка.ДатаЗавершения <> ДАТАВРЕМЯ(1, 1, 1)
	|				ИЛИ НЕ(&ВсеСклады
	|						ИЛИ (ЕСТЬNULL(ДатаМобайл_ДокументыТСД.Ссылка.Склад, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)
	|							ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСД.Ссылка.Склад, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) В (&Склады)
	|							ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСД.Ссылка.СкладПолучатель, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) В (&Склады)))
	|				ИЛИ НЕ(&ВсеПомещения
	|						ИЛИ (ЕСТЬNULL(ДатаМобайл_ДокументыТСД.Ссылка.Помещение, ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)
	|							ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСД.Ссылка.Помещение, ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)) В (&Помещения)))
	|				ИЛИ НЕ(&ВсеШаблоны
	|						ИЛИ ДатаМобайл_ДокументыТСД.Ссылка.Шаблон В (&Шаблон)))
	|
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСД.Ссылка
	|
	|ИМЕЮЩИЕ
	|	(ЕСТЬNULL(КОЛИЧЕСТВО(СписокТерминаловВсего.ТСД), 0) = 0
	|			И (ДатаМобайл_ДокументыТСД.Ссылка.ТСД = &ТСД
	|				ИЛИ ДатаМобайл_ДокументыТСД.Ссылка.ТСД = ЗНАЧЕНИЕ(ПланОбмена.ДатаМобайл_СписокТСД.ПустаяСсылка))
	|		ИЛИ ЕСТЬNULL(КОЛИЧЕСТВО(СписокТерминаловВсего.ТСД), 0) <> 0
	|			И ЕСТЬNULL(КОЛИЧЕСТВО(СписокТерминаловКонкретный.ТСД), 0) <> 0)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДатаМобайл_ДокументыТСД.Ссылка,
	|	ЕСТЬNULL(КОЛИЧЕСТВО(СписокТерминаловВсего.ТСД), 0) > 0,
	|	ЕСТЬNULL(КОЛИЧЕСТВО(СписокТерминаловКонкретный.ТСД), 0) > 0
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД КАК ДатаМобайл_ДокументыТСД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СписокТерминалов КАК СписокТерминаловВсего
	|		ПО ДатаМобайл_ДокументыТСД.Ссылка = СписокТерминаловВсего.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СписокТерминалов КАК СписокТерминаловКонкретный
	|		ПО ДатаМобайл_ДокументыТСД.Ссылка = СписокТерминаловКонкретный.Ссылка
	|			И (СписокТерминаловКонкретный.ТСД = &ТСД
	|				ИЛИ СписокТерминаловКонкретный.ТСД = ЗНАЧЕНИЕ(ПланОбмена.ДатаМобайл_СписокТСД.ПустаяСсылка))
	|ГДЕ
	|	ДатаМобайл_ДокументыТСД.Ссылка В(&СписокДокументов)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСД.Ссылка
	|
	|ИМЕЮЩИЕ
	|	(ЕСТЬNULL(КОЛИЧЕСТВО(СписокТерминаловВсего.ТСД), 0) = 0
	|			И НЕ(ДатаМобайл_ДокументыТСД.Ссылка.ТСД = &ТСД
	|					ИЛИ ДатаМобайл_ДокументыТСД.Ссылка.ТСД = ЗНАЧЕНИЕ(ПланОбмена.ДатаМобайл_СписокТСД.ПустаяСсылка))
	|		ИЛИ ЕСТЬNULL(КОЛИЧЕСТВО(СписокТерминаловВсего.ТСД), 0) <> 0
	|			И ЕСТЬNULL(КОЛИЧЕСТВО(СписокТерминаловКонкретный.ТСД), 0) = 0)");
	
	Запрос.УстановитьПараметр("СписокДокументов", МассивДокументов);
	Запрос.УстановитьПараметр("ТСД", УзелПО.Ссылка);
	
	Запрос.УстановитьПараметр("Склады", СтруктураНастроекТСД.СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СтруктураНастроекТСД.ВсеСклады);
	
	Запрос.УстановитьПараметр("Помещения", СтруктураНастроекТСД.СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СтруктураНастроекТСД.ВсеПомещения);
	
	Запрос.УстановитьПараметр("Шаблон", СтруктураНастроекТСД.СписокШаблонов);
	Запрос.УстановитьПараметр("ВсеШаблоны", СтруктураНастроекТСД.ВсеШаблоны);
	
	Рез = Запрос.Выполнить().Выбрать();
	
	Пока Рез.Следующий() Цикл
		//Зарегистрируем спорные документы для обновления ТСД
		Попытка
			ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, Рез.Ссылка);
		Исключение
		КонецПопытки;
	КонецЦикла;	       
	
	//Дополнительная верификация документов
	
	Попытка ПланыОбмена.ВыбратьИзменения(УзелПО, 1, Метаданные.Справочники.ДатаМобайл_ДокументыТСД); Исключение КонецПопытки;
	
	Запрос = Новый Запрос(
	//1) Запрос на DMIsMarkDoc = Ложь	
	"ВЫБРАТЬ
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Номер, """") КАК DMNumber,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Дата, ДАТАВРЕМЯ(1, 1, 1)) КАК DMDate,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.ПометкаУдаления, ИСТИНА)
	|				ИЛИ ДатаМобайл_ДокументыТСДИзменения.Ссылка.ДатаЗавершения <> ДАТАВРЕМЯ(1, 1, 1)
	|			    ИЛИ НЕ(&ВсеСклады
	|						ИЛИ 
	|						(ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)
	|						ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) В (&Склады)
	|						ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.СкладПолучатель, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) В (&Склады)))
	|		    	ИЛИ НЕ(&ВсеПомещения	
	|						ИЛИ 
	|						(ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Помещение, ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)
	|						ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Помещение, ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)) В (&Помещения)))
	|				ИЛИ НЕ(&ВсеШаблоны
	|						ИЛИ ДатаМобайл_ДокументыТСДИзменения.Ссылка.Шаблон В (&Шаблон))
	|				ИЛИ ВЫБОР
	|					КОГДА ЕСТЬNULL(Количество(СписокТерминаловВсего.ТСД),0)=0 И НЕ (ДатаМобайл_ДокументыТСДИзменения.Ссылка.ТСД = &ТСД ИЛИ ДатаМобайл_ДокументыТСДИзменения.Ссылка.ТСД = ЗНАЧЕНИЕ(планобмена.датамобайл_списоктсд.ПустаяСсылка))
	|						ТОГДА ИСТИНА
	|					КОГДА ЕСТЬNULL(Количество(СписокТерминаловВсего.ТСД),0)<>0 И ЕСТЬNULL(Количество(СписокТерминаловКонкретный.ТСД),0)=0
	|						ТОГДА ИСТИНА
	|					ИНАЧЕ ЛОЖЬ
	|					КОНЕЦ
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК DMisMarkDoc,
	|	ДатаМобайл_ДокументыТСДИзменения.Ссылка КАК ДокСсылка,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Номер, """") КАК DMBarcode,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Комментарий, """") КАК DMComment,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Приоритет, 0) КАК Приоритет,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Шаблон.ГрупповаяРабота , ИСТИНА) = ИСТИНА И НЕ ГрупповыеДокументыТСД.ДокументТСД ЕСТЬ NULL ТОГДА ИСТИНА
	|		КОГДА НЕ ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.ДатаЗавершенияСбора, ДАТАВРЕМЯ(1, 1, 1)) = ДАТАВРЕМЯ(1, 1, 1) ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК DMisLoaded,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Клиент, ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)) КАК КлиентСсылка,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад.Наименование, """") КАК DMWarehouseName,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад.Ссылка, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) КАК СкладСсылка,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.СкладПолучатель.Наименование, """") КАК DMWarehouseName2,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.СкладПолучатель.Ссылка, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) КАК СкладПолучательСсылка,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Шаблон.Ссылка, ЗНАЧЕНИЕ(Справочник.ДатаМобайл_ШаблоныДокументов.ПустаяСсылка)) КАК ШаблонСсылка
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.Изменения КАК ДатаМобайл_ДокументыТСДИзменения
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СписокТерминалов КАК СписокТерминаловВсего
	|		ПО ДатаМобайл_ДокументыТСДИзменения.Ссылка = СписокТерминаловВсего.Ссылка 
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СписокТерминалов КАК СписокТерминаловКонкретный
	|		ПО ДатаМобайл_ДокументыТСДИзменения.Ссылка = СписокТерминаловКонкретный.Ссылка
	|		И  (СписокТерминаловКонкретный.ТСД = &ТСД ИЛИ СписокТерминаловКонкретный.ТСД = ЗНАЧЕНИЕ(планобмена.датамобайл_списоктсд.ПустаяСсылка))
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДатаМобайл_ТСДГрупповыхДокументов КАК ГрупповыеДокументыТСД
	|		ПО (ДатаМобайл_ДокументыТСДИзменения.Ссылка = ГрупповыеДокументыТСД.ДокументТСД и ГрупповыеДокументыТСД.ТСД = &ТСД 
	|		И НЕ ГрупповыеДокументыТСД.ДатаЗавершенияСбора = ДАТАВРЕМЯ(1,1,1))
	|ГДЕ
	|   НЕ ДатаМобайл_ДокументыТСДИзменения.Ссылка.ДатаСоздания = ДАТАВРЕМЯ(1,1,1)
	|	И ВЫБОР КОГДА ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Шаблон.ГрупповаяРабота , ИСТИНА) = ИСТИНА ТОГДА ДатаМобайл_ДокументыТСДИзменения.Узел = &ТСД ИНАЧЕ ИСТИНА КОНЕЦ	
	|	И НЕ ДатаМобайл_ДокументыТСДИзменения.НомерСообщения ЕСТЬ NULL
	|
	|СГРУППИРОВАТЬ ПО 
	|  	ДатаМобайл_ДокументыТСДИзменения.Ссылка,
	|  	ГрупповыеДокументыТСД.ДокументТСД
	|
	//2) Запрос на DMIsMarkDoc = Истина
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Номер, """"),
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Дата, ДАТАВРЕМЯ(1, 1, 1)),
	|	ИСТИНА,
	|	ДатаМобайл_ДокументыТСДИзменения.Ссылка,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Номер, """"),
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Комментарий, """"),
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Приоритет, 0),
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Шаблон.ГрупповаяРабота , ИСТИНА) = ИСТИНА И НЕ ГрупповыеДокументыТСД.ДокументТСД ЕСТЬ NULL ТОГДА ИСТИНА
	|		КОГДА НЕ ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.ДатаЗавершенияСбора, ДАТАВРЕМЯ(1, 1, 1)) = ДАТАВРЕМЯ(1, 1, 1) ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Клиент, ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)),
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад.Наименование, """"),
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад.Ссылка, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)),
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.СкладПолучатель.Наименование, """"),
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.СкладПолучатель.Ссылка, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)),
	|	ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Шаблон.Ссылка, ЗНАЧЕНИЕ(Справочник.ДатаМобайл_ШаблоныДокументов.ПустаяСсылка))
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД КАК ДатаМобайл_ДокументыТСДИзменения
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СписокТерминалов КАК СписокТерминаловВсего
	|		ПО ДатаМобайл_ДокументыТСДИзменения.Ссылка = СписокТерминаловВсего.Ссылка 
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СписокТерминалов КАК СписокТерминаловКонкретный
	|		ПО ДатаМобайл_ДокументыТСДИзменения.Ссылка = СписокТерминаловКонкретный.Ссылка
	|		И  (СписокТерминаловКонкретный.ТСД = &ТСД ИЛИ СписокТерминаловКонкретный.ТСД = ЗНАЧЕНИЕ(планобмена.датамобайл_списоктсд.ПустаяСсылка))
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДатаМобайл_ТСДГрупповыхДокументов КАК ГрупповыеДокументыТСД
	|		ПО (ДатаМобайл_ДокументыТСДИзменения.Ссылка = ГрупповыеДокументыТСД.ДокументТСД и ГрупповыеДокументыТСД.ТСД = &ТСД 
	|		И НЕ ГрупповыеДокументыТСД.ДатаЗавершенияСбора = ДАТАВРЕМЯ(1,1,1))
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДИзменения.Ссылка В(&СписокДокументов)
	|	И (ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.ПометкаУдаления, ИСТИНА)
	|			ИЛИ ДатаМобайл_ДокументыТСДИзменения.Ссылка.ДатаЗавершения <> ДАТАВРЕМЯ(1, 1, 1)
	|		    ИЛИ НЕ(&ВсеСклады
	|						ИЛИ 
	|						(ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)
	|						ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Склад, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) В (&Склады)
	|						ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.СкладПолучатель, ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка)) В (&Склады)))
	|		    ИЛИ НЕ(&ВсеПомещения	
	|						ИЛИ 
	|						(ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Помещение, ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)) = ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)
	|						ИЛИ ЕСТЬNULL(ДатаМобайл_ДокументыТСДИзменения.Ссылка.Помещение, ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.ПустаяСсылка)) В (&Помещения)))
	|			ИЛИ НЕ(&ВсеШаблоны
	|					ИЛИ ДатаМобайл_ДокументыТСДИзменения.Ссылка.Шаблон В (&Шаблон)))");
		
	Запрос.УстановитьПараметр("ТСД", УзелПО.Ссылка);	
	
	Запрос.УстановитьПараметр("Склады", СтруктураНастроекТСД.СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СтруктураНастроекТСД.ВсеСклады);
	
	Запрос.УстановитьПараметр("Помещения", СтруктураНастроекТСД.СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СтруктураНастроекТСД.ВсеПомещения);
	
	Запрос.УстановитьПараметр("Шаблон", СтруктураНастроекТСД.СписокШаблонов);
	Запрос.УстановитьПараметр("ВсеШаблоны", СтруктураНастроекТСД.ВсеШаблоны);
	
	Запрос.УстановитьПараметр("СписокДокументов", МассивДокументов);
		
	Рез = Запрос.Выполнить().Выбрать(); 
	
	Пока Рез.Следующий() Цикл
		
		Попытка
			СсылкаДокумента = Рез.ДокСсылка;
			ИсходныйДокумент = СсылкаДокумента.ИсходныйДокумент; //Бывает ошибка доступа к данным из-за конфликта блокировок, пока попытка, можно переделать на зпрос реквизитов объекта
			
			ОбъектДока = ПолучитьСтруктуруОбъектаДляHttp("doc");
			
			ОбъектДока.id = "d82-" + XMLСтрока(Рез.ДокСсылка);
			ОбъектДока.is_deleted = Рез.DMisMarkDoc;
			ОбъектДока.comment = ЧистаяСтрока(Рез.DMComment);
			ОбъектДока.barcode = ЧистаяСтрока(Рез.DMBarcode);
			Попытка	ОбъектДока.date = ЧистаяСтрока(ИсходныйДокумент.Дата); Исключение ОбъектДока.date = ЧистаяСтрока(Рез.DMDate); КонецПопытки;
			Попытка ОбъектДока.date_timestamp = ДатуВTimestamp(ИсходныйДокумент.Дата); Исключение ОбъектДока.date_timestamp = ДатуВTimestamp(Рез.DMDate); КонецПопытки;
			ОбъектДока.number = ЧистаяСтрока(Рез.DMNumber);
			ОбъектДока.is_loaded = Рез.DMisLoaded;
			
			Попытка
				ОбъектДока.barcode = ЧисловойКодПоСсылке(Рез.ДокСсылка.ИсходныйДокумент);
			Исключение
				ОбъектДока.barcode = "";
			КонецПопытки;
			
			Если СсылкаДокумента.СписокДокументов.Количество() > 0 Тогда
				IsParent = Истина; 
				Попытка
					ОбъектДока.barcode = ЧисловойКодПоСсылке(СсылкаДокумента.СписокДокументов[0].ИсходныйДокумент);
				Исключение
					ОбъектДока.barcode = "";
				КонецПопытки;
			Иначе
				IsParent = Ложь;
			КонецЕсли;
			
			
			Если СсылкаДокумента.Задания.Количество() > 0 Тогда
				Попытка
					ОбъектДока.barcode = ЧисловойКодПоСсылке(СсылкаДокумента.Задания[0].Задание);
				Исключение
					ОбъектДока.barcode = "";
				КонецПопытки;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(СсылкаДокумента.РодительскийДокумент) Тогда
				ParentDocOutID = "d82-" + XMLСтрока(СсылкаДокумента.РодительскийДокумент);
				ОбъектДока.barcode = "";
			Иначе
				ParentDocOutID = "";
			КонецЕсли;
			
			// Zolla ++
			Если Рез.ШаблонСсылка.ВидДокумента = "ОтборРазмещениеТоваров" Тогда
				ОбъектДока.barcode = ДМ_ПолучитьКодКороба(Рез.ДокСсылка.ИсходныйДокумент, ОбъектДока.barcode);
			КонецЕсли;
			// Zolla --
			
			Если ЗначениеЗаполнено(СсылкаДокумента.Организация) Тогда
				Попытка inn = ЧистаяСтрока(СсылкаДокумента.Организация.ИНН); Исключение inn = ""; КонецПопытки;
			Иначе
				inn = "";
			КонецЕсли;
			
			ОбъектДока.parent_doc_id = ParentDocOutID;
			ОбъектДока.is_parent = IsParent;
			ОбъектДока.inn = inn;
			ОбъектДока.priority = Рез.Приоритет;
			
			ОбъектШаблона = ПолучитьСтруктуруОбъектаДляHttp("template"); 
			ЗаполнитьОбъектШаблона(ОбъектШаблона, Рез.ШаблонСсылка, AppVersion);
			ОбъектДока.Вставить("template", ОбъектШаблона);
			
			Если ЗначениеЗаполнено(Рез.КлиентСсылка) Тогда
				ОбъектКлиента = ПолучитьСтруктуруОбъектаДляHttp("client");
				ОбъектКлиента.id = "8k-" + XMLСтрока(Рез.КлиентСсылка);
				ОбъектКлиента.name = ЧистаяСтрока(Рез.КлиентСсылка.Наименование);
				Попытка ОбъектКлиента.barcode = ЧистаяСтрока(Рез.КлиентСсылка.ИНН); Исключение КонецПопытки;
				ОбъектДока.Вставить("client", ОбъектКлиента);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Рез.СкладСсылка) Тогда
				ОбъектСклада = ПолучитьСтруктуруОбъектаДляHttp("warehouse");
				ОбъектСклада.id = XMLСтрока(Рез.СкладСсылка);
				ОбъектСклада.name = ЧистаяСтрока(Рез.DMWarehouseName);
				ОбъектДока.Вставить("warehouse_1", ОбъектСклада);
			КонецЕсли;
			
			Если ЗначениеЗаполнено(Рез.СкладПолучательСсылка) Тогда
				ОбъектСклада2 = ПолучитьСтруктуруОбъектаДляHttp("warehouse");
				ОбъектСклада2.id = XMLСтрока(Рез.СкладПолучательСсылка);
				ОбъектСклада2.name = ЧистаяСтрока(Рез.DMWarehouseName2);
				ОбъектДока.Вставить("warehouse_2", ОбъектСклада2);
			КонецЕсли;
			
			Если Рез.ШаблонСсылка.ИспользоватьДопФормы Тогда
				//Дополнительные формы
				ОбъектСпискаДополнительныхФорм = Новый Массив;
				ЗапросДополнительныхФорм = Новый Запрос;
				ЗапросДополнительныхФорм.Текст = 
				"ВЫБРАТЬ
				|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ДополнительнаяФорма.Ссылка КАК Ссылка,
				|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.Порядок КАК Порядок,
				|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.РеквизитИзШапки КАК РеквизитИзШапки,
				|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПроверятьЗаполнение,
				|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПроверкаПоЗаданию,
				|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.РежимВвода,
				|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПодборРазмещение КАК ПодборРазмещение
				|ИЗ
				|	РегистрСведений.ДатаМобайл_СвязиДополнительныхФормИШаблонов КАК ДатаМобайл_СвязиДополнительныхФормИШаблонов
				|ГДЕ
				|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.Шаблон = &Шаблон
				|	И ДатаМобайл_СвязиДополнительныхФормИШаблонов.ДополнительнаяФорма.ПометкаУдаления = ЛОЖЬ";
				
				ЗапросДополнительныхФорм.УстановитьПараметр("Шаблон", Рез.ШаблонСсылка);
				
				РезультатЗапросаДополнительныхФорм = ЗапросДополнительныхФорм.Выполнить();
				ВыборкаДополнительныхФорм = РезультатЗапросаДополнительныхФорм.Выбрать();
				Пока ВыборкаДополнительныхФорм.Следующий() Цикл
					
					Если Не ЗначениеЗаполнено(ВыборкаДополнительныхФорм.Ссылка) Тогда 
						Продолжить;
					КонецЕсли; 
					
					НомерАтрибута = ПолучитьНомерАтрибутаДляДопФормы(Рез.ШаблонСсылка, ВыборкаДополнительныхФорм.Ссылка, ВыборкаДополнительныхФорм.РеквизитИзШапки);
					Если НомерАтрибута = 0 Тогда Продолжить; КонецЕсли;
					
					ОбъектДополнительныхФорм = ПолучитьСтруктуруОбъектаДляHttp("doc_form","doc");
					ОбъектДополнительныхФорм.id = XMLСтрока(ВыборкаДополнительныхФорм.Ссылка);
					ОбъектДополнительныхФорм.doc_id = "d82-" + XMLСтрока(Рез.ДокСсылка);
					ОбъектДополнительныхФорм.attribute_number = НомерАтрибута;
					ОбъектДополнительныхФорм.is_check_by_task = ВыборкаДополнительныхФорм.ПроверкаПоЗаданию;
					ОбъектДополнительныхФорм.enter_mode       = ВыборкаДополнительныхФорм.РежимВвода;
					ОбъектДополнительныхФорм.is_required = ВыборкаДополнительныхФорм.ПроверятьЗаполнение; 
					ОбъектДополнительныхФорм.form_type = ВыборкаДополнительныхФорм.РеквизитИзШапки; 
					ОбъектДополнительныхФорм.operation_type   = ВыборкаДополнительныхФорм.ПодборРазмещение;
					ОбъектСпискаДополнительныхФорм.Добавить(ОбъектДополнительныхФорм);
					
				КонецЦикла;
				ОбъектДока.Вставить("forms", ОбъектСпискаДополнительныхФорм);
			КонецЕсли;
			
			// атрибуты
			Атрибуты = ПолучитьАтрибутыШапкиДок(Рез.ШаблонСсылка); 				
			СписокАтрибутов = Новый Массив;	
			Для сч = 1 По 10 Цикл 
				ИмяАтрибута = Атрибуты["ИмяАтрибута" + сч];	
				ОбъектАтрибуты = ПолучитьСтруктуруОбъектаДляHttp("attribute");
				
				Если Не ИмяАтрибута = "" Тогда 
					ПараметрыАтрибута = ПолучитьАтрибутШапки(СсылкаДокумента, ИмяАтрибута);
					
					Если ЗначениеЗаполнено(ПараметрыАтрибута.form_id) Тогда
						ЗаполнитьЗначенияСвойств(ОбъектАтрибуты, ПараметрыАтрибута);
						ОбъектАтрибуты.Вставить("number", сч);
						
						СписокАтрибутов.Добавить(ОбъектАтрибуты);
					КонецЕсли;
				КонецЕсли;			
			КонецЦикла;		
			ОбъектДока.attributes = СписокАтрибутов;
			
			ОбъектСписка.Добавить(ОбъектДока);
		Исключение
		КонецПопытки;
		
	КонецЦикла;	
	
	Попытка ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.ДатаМобайл_ДокументыТСД); Исключение КонецПопытки;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка); 
	
КонецФункции

// Запись документа ТСД.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// СтруктураДокумента - Структура - Структура данных документа.  
// isFinished - Строка - Признак завершенного документа.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//  
Функция WriteDoc(SN, UserName, СтруктураДокумента, isFinished) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	//Переменные Params
	СтруктураParams = Новый Структура;
	СтруктураParams.Вставить("isFinished", isFinished);
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(СтруктураДокумента.id, 5));
	Исключение	
		Попытка
			СсылкаНаДок = СоздатьДокумент(SN, UserName,СтруктураДокумента.id, СтруктураДокумента.template.id);
		Исключение		
			СтруктураОтвета.Вставить("Описание", "Не найден документ. ");
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецПопытки;
		
		Если СсылкаНаДок = Неопределено Тогда
			СтруктураОтвета.Вставить("Описание", "Не найден документ. ");
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;			
	КонецПопытки;
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	Если (Шаблон.БыстраяПриемка Или Шаблон.БыстраяОтгрузка) И Не Шаблон.ВидДокументаНового = "ЗаказНаВнутреннееПотребление" Тогда
		Попытка
			Если СтруктураДокумента.client.id = "" Тогда		
				СтруктураОтвета.Вставить("Описание", "Не указан контрагент. ");		
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			Иначе
				Попытка 
					ТекущийКлиент = XMLЗначение(Тип("СправочникСсылка.Партнеры"), Сред(СтруктураДокумента.client.id, 4));
					Если ТекущийКлиент.ПолучитьОбъект() = Неопределено Тогда
						СтруктураОтвета.Вставить("Описание", "Не указан контрагент. ");			
						Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
					Иначе
						
						Если Шаблон.БыстраяОтгрузка И Не ТекущийКлиент.Клиент Тогда					
							СтруктураОтвета.Вставить("Описание", "Указанный контрагент не является клиентом, быстрая отгрузка не возможна! ");					
							Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
						КонецЕсли;
					КонецЕсли;	
				Исключение	
					СтруктураОтвета.Вставить("Описание", "Не указан контрагент. ");			
					Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
				КонецПопытки;	
			КонецЕсли;
		Исключение
			СтруктураОтвета.Вставить("Описание", "Не указан контрагент. ");			
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецПопытки;
	КонецЕсли;
	
	Если Шаблон.БыстроеПеремещение <> 0 Тогда
		
		Модуль_СкладыСервер = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("СкладыСервер");
		
		НаименованиеСклада = "Склад";
		НаименованиеВторогоСкладаНаТСД = "Склад получатель";
		
		//Получим склады для "Перемещение товаров" из автозагрузки
		ПараметрыОтбораОтправитель = Новый Структура;
		ПараметрыОтбораОтправитель.Вставить("ИмяРеквизита", "СкладОтправитель");
		НайденныеСтрокиОтправитель = Шаблон.НовыеЗначенияРеквизитов.НайтиСтроки(ПараметрыОтбораОтправитель);
		
		Попытка ТекущийСкладОтправитель = НайденныеСтрокиОтправитель[0].ЗначениеРеквизита; Исключение ТекущийСкладОтправитель = Неопределено; КонецПопытки; 
		
		ПараметрыОтбораПолучатель = Новый Структура;
		ПараметрыОтбораПолучатель.Вставить("ИмяРеквизита", "СкладПолучатель");
		НайденныеСтрокиОПолучатель = Шаблон.НовыеЗначенияРеквизитов.НайтиСтроки(ПараметрыОтбораПолучатель);
		
		Попытка ТекущийСкладПолучатель = НайденныеСтрокиОПолучатель[0].ЗначениеРеквизита;  Исключение ТекущийСкладПолучатель = Неопределено; КонецПопытки;
		
		Если ЗначениеЗаполнено(ТекущийСкладОтправитель) И ЗначениеЗаполнено(ТекущийСкладПолучатель) Тогда
			НаименованиеВторогоСкладаНаТСД 	= "Склад получатель автозагрузки";
			НаименованиеСклада 				= "Склад отправитель автозагрузки";
		Иначе
			Попытка				
				Если Шаблон.ИспользоватьВторойСклад Тогда
					ТекущийСкладПолучатель = XMLЗначение(Тип("СправочникСсылка.Склады"), СтруктураДокумента.warehouse_2.id);
				КонецЕсли;
				
				ТекущийСкладОтправитель = XMLЗначение(Тип("СправочникСсылка.Склады"), СтруктураДокумента.warehouse_1.id);			
			Исключение		
				//СтруктураОтвета.Вставить("Описание", "Некорректно указан склад. ");			
				//Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецПопытки;	
		КонецЕсли; 
		
		Попытка
			ИспользуетсяОрдернаяСхемаУСкладаПолучателя = Модуль_СкладыСервер.ИспользоватьОрдернуюСхемуПриОтгрузке(ТекущийСкладПолучатель, ТекущаяДата())
			Или Модуль_СкладыСервер.ИспользоватьОрдернуюСхемуПриПоступлении(ТекущийСкладПолучатель, ТекущаяДата());
			
			ИспользуетсяОрдернаяСхемаУСкладаОтправителя = Модуль_СкладыСервер.ИспользоватьОрдернуюСхемуПриОтгрузке(ТекущийСкладОтправитель, ТекущаяДата())
			Или Модуль_СкладыСервер.ИспользоватьОрдернуюСхемуПриПоступлении(ТекущийСкладОтправитель, ТекущаяДата());
		Исключение		
			СтруктураОтвета.Вставить("Описание", "Не удалось получить ордерную схему склада. ");			
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецПопытки;
		
		//1 = Перемещение «ордерный – не ордерный»
		//2 = Перемещение «не ордерный – ордерный»		
		ЭтоПеремещениеСОрдерныйНаНеОрдерный = Шаблон.БыстроеПеремещение = 1;												
		
		Если ЭтоПеремещениеСОрдерныйНаНеОрдерный Тогда 
			
			Если Не ИспользуетсяОрдернаяСхемаУСкладаОтправителя Тогда	
				СтруктураОтвета.Вставить("Описание", "В поле " + НаименованиеСклада + " указан не ордерный склад.");			
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли; 
			
			Если ИспользуетсяОрдернаяСхемаУСкладаПолучателя Тогда 						
				СтруктураОтвета.Вставить("Описание", "В поле " + НаименованиеВторогоСкладаНаТСД + " указан ордерный склад. ");			
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
			
		Иначе
			
			Если ИспользуетсяОрдернаяСхемаУСкладаОтправителя Тогда	
				СтруктураОтвета.Вставить("Описание", "В поле " + НаименованиеСклада + " указан ордерный склад. ");		
				Возврат ПодготовитьОтветJSON(,СтруктураОтвета);
			КонецЕсли; 
			
			Если Не ИспользуетсяОрдернаяСхемаУСкладаПолучателя Тогда	
				СтруктураОтвета.Вставить("Описание", "В поле " + НаименованиеВторогоСкладаНаТСД + " указан не ордерный склад. ");				
				Возврат ПодготовитьОтветJSON(,СтруктураОтвета);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
		
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда		
		СтруктураОтвета.Вставить("Описание", "Не найден документ " + СтруктураДокумента.id);		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	
	Если Не СсылкаНаДок.ТСД.Пустая() Тогда
		Если СсылкаНаДок.ТСД <> УзелПО Тогда
			СтруктураОтвета.Вставить("Описание", "Чужой документ.");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
		КонецЕсли;	
	КонецЕсли;	
	Если СсылкаНаДок.ДатаПриемкиОператором <> Дата(1,1,1) Тогда	
		СтруктураОтвета.Вставить("Описание", "Закрытый документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
	КонецЕсли;	
	
	Если Не Шаблон.ГрупповаяРабота Тогда
		Попытка
			Объект = СсылкаНаДок.ПолучитьОбъект();
			
			Если СсылкаНаДок.ДатаНачалаСбора = Дата(1,1,1) Тогда 		
				Для каждого СтрокаДокумента Из СтруктураДокумента.details.select Цикл  
					Объект.ДатаНачалаСбора = СтрокаДокумента.date;
					Прервать;
				КонецЦикла;
				Если Объект.ДатаНачалаСбора = Дата(1,1,1) Тогда 
					Объект.ДатаНачалаСбора = ТекущаяДата();
				КонецЕсли;
			КонецЕсли;			
		Исключение
		КонецПопытки;
		
		Если Объект = Неопределено Тогда	
			СтруктураОтвета.Вставить("Описание", "Не нашли документ. ");	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	Иначе
		Объект = Неопределено;
	КонецЕсли;	
	
	Для каждого СтрокаДокумента Из СтруктураДокумента.details.select Цикл   
		
		//ПРОВЕРКА ДУБЛЕЙ
		Если ПроверитьЗаписи("Select", УзелПО, СсылкаНаДок, СтрокаДокумента,Объект) Тогда
			Продолжить;
		КонецЕсли;
		
		//ПРОВЕРКА СЕРИЙ/СЕРИЙНЫХ НОМЕРОВ
		Если СтрокаДокумента.sn <> "" И СтрокаДокумента.sn <> "[]" Тогда
			ШаблонПроверкиСерии = "";
			Если СерияНеПодходит(УзелПО, СсылкаНаДок, СтрокаДокумента, ШаблонПроверкиСерии) Тогда
				СтруктураОтвета.Вставить("Описание", "Серийный номер " + СтрокаДокумента.sn + " не соответсвует шаблону " + ШаблонПроверкиСерии);
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
		КонецЕсли;
		
		//СТРУКТУРА СТРОКИ
		СтруктураСтроки = ПолучитьСтруктуруСтрокиДокумента("Select", УзелПО, СсылкаНаДок, СтрокаДокумента, UserName, Истина);
		
		//ПРОВЕРКА ПРИНАДЛЕЖНОСТИ ЯЧЕЙКИ К СКЛАДУ ДОКУМЕНТА
		Если ЗначениеЗаполнено(СтруктураСтроки.ЯчейкаСсылка) И Не СтруктураСтроки.Количество < 0 Тогда
			Если Шаблон.ГрупповаяРабота Тогда
				СкладЯчеек = ДатаМобайл_ОбщийМодуль.ПолучитьСкладВведенныхЯчеекГрупповаяРабота(СсылкаНаДок);			
			Иначе
				СкладЯчеек = ДатаМобайл_ОбщийМодуль.ПолучитьСкладВведенныхЯчеек(Объект.СобранныеДанныеПодбор.Выгрузить());
			КонецЕсли;
			
			Если ЗначениеЗаполнено(СкладЯчеек) И Не СтруктураСтроки.ЯчейкаСсылка.Владелец = СкладЯчеек Тогда
				СтруктураОтвета.Вставить("Описание","Введены ячейки разных складов в одном документе, строка не может быть записана!");		
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
		КонецЕсли;
		
		//ЗАПИСЬ В РЕГИСТР ЗНАЧЕНИЙ ДОП ФОРМ
		ЗаписьЗначенийДопФормВРегистр(СтруктураСтроки);
		
		//УдалениеЗначенийДополнительныхФорм
		Если СтруктураСтроки.Количество < 0 Тогда
			ДатаМобайл_ОбщийМодуль.УдалитьЗначениеФормыПоСтроке(СсылкаНаДок, СтруктураСтроки.ИдентификаторСтроки);
		КонецЕсли;
		
		//ПРЕВЫШЕНИЕ ПРИ ГРУППОВОЙ РАБОТЕ
		Если Шаблон.ГрупповаяРабота И Шаблон.ПриПревышенииЗаданияПодбор = 2 Тогда	
			Если ПроверитьПревышениеГрупповогоЗадания("Select", УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки) Тогда
				СтруктураОтвета.Вставить("Описание", "Превышено задание по данной номенклатуре.");
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;	
		КонецЕсли;
		
		//Уникальность ШК ПРИ ГРУППОВОЙ РАБОТЕ
		Если Шаблон.ГрупповаяРабота И Шаблон.УникальныеШтрихкодыНоменклатурыВДокументе Тогда	
			Если СтруктураСтроки.Количество > 0 И ПроверитьУникальностьШКГрупповогоЗадания("Select", УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки) Тогда
				СтруктураОтвета.Вставить("Описание", "Данный ШК был отсканирован на другом ТСД. ");
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;	
		КонецЕсли;
		
		//ЗАПИСЬ
		Если Не Шаблон.ГрупповаяРабота И Не Шаблон.БыстроеСканирование Тогда
			НоваяСтрока = Объект.СобранныеДанныеПодбор.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтруктураСтроки);
		Иначе 
			ДатаМобайл_ОбщийМодуль.СоздатьЗаписиГрупповогоДокумента(СтруктураСтроки);
		КонецЕсли;
				
	КонецЦикла;	
		
	Для каждого СтрокаДокумента Из СтруктураДокумента.details.insert Цикл
		
		//ПРОВЕРКА ДУБЛЕЙ
		Если ПроверитьЗаписи("Insert", УзелПО, СсылкаНаДок, СтрокаДокумента, Объект) Тогда
			Продолжить;
		КонецЕсли;
		
		//ПРОВЕРКА СЕРИЙ/СЕРИЙНЫХ НОМЕРОВ
		Если СтрокаДокумента.sn <> "" И СтрокаДокумента.sn <> "[]" Тогда
			ШаблонПроверкиСерии = "";
			Если СерияНеПодходит(УзелПО, СсылкаНаДок, СтрокаДокумента, ШаблонПроверкиСерии) Тогда	
				СтруктураОтвета.Вставить("Описание", "Серийный номер " + СтрокаДокумента.sn + " не соответсвует шаблону " + ШаблонПроверкиСерии);
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
		КонецЕсли;
		
		//СТРУКТУРА СТРОКИ
		СтруктураСтроки = ПолучитьСтруктуруСтрокиДокумента("Insert", УзелПО, СсылкаНаДок, СтрокаДокумента, UserName, Истина);
		
		//ПРОВЕРКА ПРИНАДЛЕЖНОСТИ ЯЧЕЙКИ К СКЛАДУ ДОКУМЕНТА
		Если ЗначениеЗаполнено(СтруктураСтроки.ЯчейкаСсылка) И Не СтруктураСтроки.Количество < 0 Тогда
			Если Шаблон.ГрупповаяРабота Тогда
				СкладЯчеек = ДатаМобайл_ОбщийМодуль.ПолучитьСкладВведенныхЯчеекГрупповаяРабота(СсылкаНаДок);			
			Иначе
				СкладЯчеек = ДатаМобайл_ОбщийМодуль.ПолучитьСкладВведенныхЯчеек(Объект.СобранныеДанныеПриемка.Выгрузить());
			КонецЕсли;
			
			Если ЗначениеЗаполнено(СкладЯчеек) И Не СтруктураСтроки.ЯчейкаСсылка.Владелец = СкладЯчеек Тогда
				СтруктураОтвета.Вставить("Описание", "Введены ячейки разных складов в одном документе, строка не может быть записана!");		
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
		КонецЕсли;
		
		//ЗАПИСЬ В РЕГИСТР ЗНАЧЕНИЙ ДОП ФОРМ
		ЗаписьЗначенийДопФормВРегистр(СтруктураСтроки);
		
		//УдалениеЗначенийДополнительныхФорм
		Если СтруктураСтроки.Количество < 0 Тогда
			ДатаМобайл_ОбщийМодуль.УдалитьЗначениеФормыПоСтроке(СсылкаНаДок, СтруктураСтроки.ИдентификаторСтроки);
		КонецЕсли;
		
		//ПРЕВЫШЕНИЕ ПРИ ГРУППОВОЙ РАБОТЕ
		Если Шаблон.ГрупповаяРабота И Шаблон.ПриПревышенииЗаданияПодбор = 2 Тогда	
			Если ПроверитьПревышениеГрупповогоЗадания("Insert", УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки) Тогда	
				СтруктураОтвета.Вставить("Описание", "Превышено задание по данной номенклатуре.");
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;	
		КонецЕсли;
		
		//Уникальность ШК ПРИ ГРУППОВОЙ РАБОТЕ
		Если Шаблон.ГрупповаяРабота И Шаблон.УникальныеШтрихкодыНоменклатурыВДокументе Тогда	
			Если СтруктураСтроки.Количество > 0 И ПроверитьУникальностьШКГрупповогоЗадания("Insert", УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки) Тогда
				СтруктураОтвета.Вставить("Описание", "Данный ШК был отсканирован на другом ТСД. ");
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;	
		КонецЕсли;
		
		//ЗАПИСЬ
		Если Не Шаблон.ГрупповаяРабота И Не Шаблон.БыстроеСканирование Тогда
			НоваяСтрока = Объект.СобранныеДанныеПриемка.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, СтруктураСтроки);
		Иначе 
			ДатаМобайл_ОбщийМодуль.СоздатьЗаписиГрупповогоДокумента(СтруктураСтроки);
		КонецЕсли;
		
	КонецЦикла;	
	
	// АТРИБУТЫ ШАПКИ ДОПФОРМ
	Если СтруктураДокумента.Свойство("attributes") Тогда 
		Для каждого ДополнительнаяФорма Из СтруктураДокумента.attributes Цикл
			Если Не ДополнительнаяФорма.Свойство("form_id") Или Не ЗначениеЗаполнено(ДополнительнаяФорма.form_id) Тогда
				Продолжить;
			КонецЕсли;
			
			ДополнительнаяФормаСсылка = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДополнительныеФормы"), СокрЛП(ДополнительнаяФорма.form_id));
			Если ДополнительнаяФормаСсылка = Справочники.ДатаМобайл_ДополнительныеФормы.ПустаяСсылка() Тогда
				Продолжить;
			КонецЕсли;
			
			Попытка
				РегЗначениеФормы = РегистрыСведений.ДатаМобайл_ЗначенияДополнительныхФорм.СоздатьМенеджерЗаписи();
				РегЗначениеФормы.Документ            = СсылкаНаДок;
				РегЗначениеФормы.ДополнительнаяФорма = ДополнительнаяФормаСсылка;
				РегЗначениеФормы.Значение            = СокрЛП(ДополнительнаяФорма.value);	
				
				РегЗначениеФормы.Записать(Истина);
			Исключение КонецПопытки;			
		КонецЦикла;
	КонецЕсли;
	
	Если Не Шаблон.ГрупповаяРабота Тогда
		
		Если isFinished Тогда
			Объект.ДатаЗавершенияСбора = ТекущаяДата();
		КонецЕсли;
		
		Объект.ТСД = УзелПО;
		Объект.Номер = СтруктураДокумента.number;
		Объект.Дата = СтруктураДокумента.date;
		Объект.Комментарий = СтруктураДокумента.comment;
		
		Если Объект.ДатаИзмененияКлиента <> Дата(1,1,1) Тогда
			Попытка
				
				ИДКлиента = Новый УникальныйИдентификатор(Сред(СтруктураДокумента.client.id, 4));
				
				Если Не Шаблон.РаспределениеТоваров = 1 Тогда
					
					Если Объект.Клиент.ПолучитьОбъект() = Неопределено Тогда
						Объект.Клиент = Справочники.Склады.ПолучитьСсылку(ИДКлиента);
					КонецЕсли;				
					
					Если Объект.Клиент.ПолучитьОбъект() = Неопределено И ДатаМобайл_ОбщийМодуль.ЕстьМДЛП() Тогда
						Объект.Клиент = Справочники.ОрганизацииМДЛП.ПолучитьСсылку(ИДКлиента);	
					КонецЕсли;
					
					Если Объект.Клиент.ПолучитьОбъект() = Неопределено Тогда
						Объект.Клиент = Справочники.СтруктураПредприятия.ПолучитьСсылку(ИДКлиента);
					КонецЕсли;
					
				КонецЕсли;
			Исключение
			Конецпопытки;
		КонецЕсли;
		
		Попытка 
			Если ЗначениеЗаполнено(СтруктураДокумента.warehouse_1.id) Тогда	
				Объект.Склад = XMLЗначение(Тип("СправочникСсылка.Склады"), СтруктураДокумента.warehouse_1.id);
			КонецЕсли;	
		Исключение
		КонецПопытки;
		
		Попытка
			Если ЗначениеЗаполнено(СтруктураДокумента.warehouse_2.id) Тогда
				Объект.СкладПолучатель = XMLЗначение(Тип("СправочникСсылка.Склады"), СтруктураДокумента.warehouse_2.id);
			КонецЕсли;	
		Исключение
		КонецПопытки;
		
		Объект.ДополнительныеСвойства.Вставить("ЗапросВСервисЧЗ", Истина);
		
		Попытка 							
			Объект.Записать();
		Исключение	
			СтруктураОтвета.Вставить("Описание", "Ошибка записи. " + ОписаниеОшибки());	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
		КонецПопытки;
		
		//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
		ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
	Иначе
		
		ДатаСбораПоТСД = ДатаМобайл_ОбщийМодуль.ПолучитьДатуГрупповогоДокумента(SN, СсылкаНаДок, "ДатаНачалаСбора");	
		Если Не ЗначениеЗаполнено(ДатаСбораПоТСД) Тогда	
			ДатаМобайл_ОбщийМодуль.СоздатьНачальнуюЗаписьТСДГрупповыхДокументов(SN, СсылкаНаДок, UserName);		
		КонецЕсли;
				
		Если isFinished Тогда
			ДатаЗавершенияПоТСД = ДатаМобайл_ОбщийМодуль.ПолучитьДатуГрупповогоДокумента(SN, СсылкаНаДок, "ДатаЗавершенияСбора");
			Если (ДатаЗавершенияПоТСД = Неопределено) Или (ДатаЗавершенияПоТСД = Дата(1,1,1)) Тогда
				ДатаМобайл_ОбщийМодуль.ОбновитьЗаписьТСДГрупповогоДокумента(SN,СсылкаНаДок,ТекущаяДата());	
			КонецЕсли;
			
			Если ДатаМобайл_ОбщийМодуль.ПроверитьЗавершенностьГрупповогоДокумента(СсылкаНаДок) Тогда
				Попытка
					Объект = СсылкаНаДок.ПолучитьОбъект();
					
					Если СсылкаНаДок.ДатаНачалаСбора = Дата(1,1,1) Тогда
						Объект.ДатаНачалаСбора = ТекущаяДата();
					КонецЕсли;

					Объект.ДатаЗавершенияСбора = ТекущаяДата();
					
					Попытка
						Если ЗначениеЗаполнено(СтруктураДокумента.warehouse_1.id) Тогда
							Объект.Склад = XMLЗначение(Тип("СправочникСсылка.Склады"), СтруктураДокумента.warehouse_1.id);
						КонецЕсли;
					Исключение 
					КонецПопытки;
					
					Попытка
						Если ЗначениеЗаполнено(СтруктураДокумента.warehouse_2.id) Тогда
							Объект.СкладПолучатель = XMLЗначение(Тип("СправочникСсылка.Склады"), СтруктураДокумента.warehouse_2.id);
						КонецЕсли;	
					Исключение 
					КонецПопытки;
					Объект.ДополнительныеСвойства.Вставить("ЗапросВСервисЧЗ", Истина);	 
					Объект.Записать();
				Исключение		
					//СтруктураОтвета.Вставить("Описание", "Ошибка записи. " + ОписаниеОшибки());
					//Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
				КонецПопытки;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;	
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Создание документа ТСД.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// TemplateID - Строка - Id шаблона.  
// AppVersion - Строка - Версия ПО.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
// 
Функция CreateDoc(SN, UserName,TemplateID, AppVersion, client_id, warehouse_1_id, warehouse_2_id, comment) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ДатаМобайл_ШаблоныДокументов.Ссылка КАК ШаблонСсылка
	|ИЗ
	|	Справочник.ДатаМобайл_ШаблоныДокументов КАК ДатаМобайл_ШаблоныДокументов
	|ГДЕ
	|	ДатаМобайл_ШаблоныДокументов.Код = &ИД");
	
	Запрос.УстановитьПараметр("ИД", Число(TemplateID));
	
	Рез = Запрос.Выполнить().Выбрать();
	Если Рез.Следующий() Тогда
		
		//Создаем док в справочнике
		Объект = Справочники.ДатаМобайл_ДокументыТСД.СоздатьЭлемент();
		Объект.УстановитьНовыйКод();
		Объект.Шаблон = Рез.ШаблонСсылка;
		Попытка 
			Объект.ИсходныйДокумент = Документы[Объект.Шаблон.ВидДокумента].ПустаяСсылка();	
			Если СокрЛП(Объект.Шаблон.ВидДокументаНового) <> "" Тогда
				Объект.НовыйДокумент = Документы[Объект.Шаблон.ВидДокументаНового].Пустаяссылка();
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Если Объект.Шаблон.РаспределениеТоваров = 2 Тогда
			Если Объект.СписокДокументов.ВыгрузитьКолонку("ДокументТСД").Количество() = 0 Тогда
				СтруктураОтвета.Вставить("Описание", "Настройка ""Групповой документ"" не поддерживает работу без задания! ");
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
		КонецЕсли;
		
		Объект.ДатаСоздания = ТекущаяДата();
		Объект.Источник = УзелПО;	
		Объект.ДатаНачалаСбора = ТекущаяДата();	
		Если Не (Объект.Шаблон.ГрупповаяРабота) Тогда
			Объект.ТСД = УзелПО;
		КонецЕсли;
		Объект.Дата = ТекущаяДата();
		Объект.Номер = "DMO-" + Формат(Объект.код, "ЧГ=0");
		Объект.Комментарий = comment;
		
		Попытка
			Если ЗначениеЗаполнено(client_id) Тогда
				Объект.Клиент = XMLЗначение(Тип("СправочникСсылка.Партнеры"), Сред(client_id, 4));
			КонецЕсли;
		Исключение
		КонецПопытки; 
		
		Попытка 
			Если ЗначениеЗаполнено(warehouse_1_id) Тогда	
				Объект.Склад = XMLЗначение(Тип("СправочникСсылка.Склады"), warehouse_1_id);
			КонецЕсли;	
		Исключение
		КонецПопытки;
		
		Попытка
			Если ЗначениеЗаполнено(warehouse_2_id) Тогда
				Объект.СкладПолучатель = XMLЗначение(Тип("СправочникСсылка.Склады"), warehouse_2_id);
			КонецЕсли;	
		Исключение
		КонецПопытки;
			
		Объект.Записать();
		
		//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
		ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
				
		//Готовим данные для ТСД по доку
		ОбъектДока = ПолучитьСтруктуруОбъектаДляHttp("doc");		
		ОбъектДока.id = "d82-" + XMLСтрока(Объект.Ссылка);
		ОбъектДока.is_deleted = Ложь;
		ОбъектДока.number = Объект.Номер;
		ОбъектДока.date = Строка(Объект.Дата);
		ОбъектДока.date_timestamp = ДатуВTimestamp(Объект.ДатаСоздания);
		ОбъектДока.barcode = Объект.Номер;
		ОбъектДока.comment = Строка(Объект.Комментарий);
		
		Если ЗначениеЗаполнено(Объект.Клиент) Тогда
			ОбъектКлиента = ПолучитьСтруктуруОбъектаДляHttp("client");
			ОбъектКлиента.id = "8k-" + XMLСтрока(Объект.Клиент);
			ОбъектКлиента.name = ЧистаяСтрока(Объект.Клиент.Наименование);
			Попытка ОбъектКлиента.barcode = Объект.Клиент.ИНН; Исключение КонецПопытки;
			ОбъектДока.Вставить("client", ОбъектКлиента);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Объект.Склад) Тогда			
			ОбъектСклада = ПолучитьСтруктуруОбъектаДляHttp("warehouse");
			ОбъектСклада.id = XMLСтрока(Объект.Склад);
			ОбъектСклада.name = Объект.Склад.Наименование;		
			ОбъектДока.Вставить("warehouse_1", ОбъектСклада);	
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Объект.СкладПолучатель) Тогда
			ОбъектСклада2 = ПолучитьСтруктуруОбъектаДляHttp("warehouse");
			ОбъектСклада2.id = XMLСтрока(Объект.СкладПолучатель);
			ОбъектСклада2.name = Объект.СкладПолучатель.Наименование;
			ОбъектДока.Вставить("warehouse_2", ОбъектСклада2);
		КонецЕсли;
		
		//Готовим данные для ТСД по шаблону
		ОбъектШаблона = ПолучитьСтруктуруОбъектаДляHttp("template");
		ЗаполнитьОбъектШаблона(ОбъектШаблона,Рез.ШаблонСсылка, AppVersion);
		ОбъектДока.Вставить("template", ОбъектШаблона);
		
		Если Рез.ШаблонСсылка.ИспользоватьДопФормы Тогда
			//Готовим данные для ТСД по дополнительным формам
			ОбъектСпискаДополнительныхФорм = Новый Массив;
			ЗапросДополнительныхФорм = Новый Запрос;
			ЗапросДополнительныхФорм.Текст = 
			"ВЫБРАТЬ
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ДополнительнаяФорма.Ссылка КАК Ссылка,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.Порядок КАК Порядок,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.РеквизитИзШапки КАК РеквизитИзШапки,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПроверятьЗаполнение,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПроверкаПоЗаданию,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.РежимВвода,
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.ПодборРазмещение КАК ПодборРазмещение
			|ИЗ
			|	РегистрСведений.ДатаМобайл_СвязиДополнительныхФормИШаблонов КАК ДатаМобайл_СвязиДополнительныхФормИШаблонов
			|ГДЕ
			|	ДатаМобайл_СвязиДополнительныхФормИШаблонов.Шаблон = &Шаблон
			|	И ДатаМобайл_СвязиДополнительныхФормИШаблонов.ДополнительнаяФорма.ПометкаУдаления = ЛОЖЬ";
			
			ЗапросДополнительныхФорм.УстановитьПараметр("Шаблон", Рез.ШаблонСсылка);
			
			РезультатЗапросаДополнительныхФорм = ЗапросДополнительныхФорм.Выполнить();
			ВыборкаДополнительныхФорм = РезультатЗапросаДополнительныхФорм.Выбрать();
			Пока ВыборкаДополнительныхФорм.Следующий() Цикл
				
				Если Не ЗначениеЗаполнено(ВыборкаДополнительныхФорм.Ссылка) Тогда 
					Продолжить;
				КонецЕсли;
				
				НомерАтрибута = ПолучитьНомерАтрибутаДляДопФормы(Рез.ШаблонСсылка, ВыборкаДополнительныхФорм.Ссылка, ВыборкаДополнительныхФорм.РеквизитИзШапки);
				Если НомерАтрибута = 0 Тогда Продолжить; КонецЕсли;
				
				ОбъектДополнительныхФорм = ПолучитьСтруктуруОбъектаДляHttp("doc_form","doc");
				ОбъектДополнительныхФорм.id = XMLСтрока(ВыборкаДополнительныхФорм.Ссылка);
				ОбъектДополнительныхФорм.doc_id = "d82-" + XMLСтрока(Объект.Ссылка); 
				ОбъектДополнительныхФорм.attribute_number = НомерАтрибута;
				ОбъектДополнительныхФорм.is_check_by_task = ВыборкаДополнительныхФорм.ПроверкаПоЗаданию;
				ОбъектДополнительныхФорм.enter_mode       = ВыборкаДополнительныхФорм.РежимВвода;
				ОбъектДополнительныхФорм.is_required = ВыборкаДополнительныхФорм.ПроверятьЗаполнение; 
				ОбъектДополнительныхФорм.form_type = ВыборкаДополнительныхФорм.РеквизитИзШапки;
				ОбъектДополнительныхФорм.operation_type = ВыборкаДополнительныхФорм.ПодборРазмещение;
				ОбъектСпискаДополнительныхФорм.Добавить(ОбъектДополнительныхФорм);
				
			КонецЦикла;	
			ОбъектДока.Вставить("forms", ОбъектСпискаДополнительныхФорм);
		КонецЕсли;
		
		Возврат ПодготовитьОтветJSON(ОбъектДока);
	Иначе			
		СтруктураОтвета.Вставить("Описание", "Не найден шаблон. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецЕсли;	
	
КонецФункции

// Возврат выгруженного документа в работу.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа.  
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция ReopenDoc(SN, UserName, DocOutID) Экспорт
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не найден документ. " );		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;	
	
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда		
		СтруктураОтвета.Вставить("Описание", "Не найден документ. " );	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Если Не СсылкаНаДок.ТСД.Пустая() Тогда
		Если СсылкаНаДок.ТСД <> УзелПО Тогда
			СтруктураОтвета.Вставить("Описание", "Групповой документ не поддерживает очистку. ");	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;	
	Если СсылкаНаДок.ДатаПриемкиОператором <> Дата(1, 1, 1) Тогда		
		СтруктураОтвета.Вставить("Описание", "Закрытый документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	
	
	Если СсылкаНаДок.ДатаЗавершенияСбора = Дата(1, 1, 1) И СсылкаНаДок.Шаблон.ГрупповаяРабота Тогда
		ДатаМобайл_ОбщийМодуль.ОбновитьЗаписьТСДГрупповогоДокумента(SN,СсылкаНаДок, Дата(1, 1, 1));
		
		СтруктураОтвета.Вставить("is_success", Истина);		
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	КонецЕсли;
	
	Попытка
		Объект = СсылкаНаДок.ПолучитьОбъект();
		
		Если Объект.ТСД.Пустая() И Не(СсылкаНаДок.Шаблон.ГрупповаяРабота) Тогда
			Объект.ТСД = УзелПО;
		КонецЕсли;
		
		Объект.ДатаЗавершенияСбора = "";
		Объект.Записать(); 
		
		//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
		ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
		
		ДатаМобайл_ОбщийМодуль.ОбновитьЗаписьТСДГрупповогоДокумента(SN,СсылкаНаДок, Дата(1, 1, 1));		
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не смогли записать документ. " );		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецПопытки;	
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Передача записанных в документе строк (подбор).
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа.
// СтрокаДокумента - Структура - Структура данных строки документа.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция OnWriteRecSelect(SN, UserName, DocOutID, СтрокаДокумента) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	ЗначенияРеквизитовСсылкаНаДок = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок,"ТСД,ДатаНачалаСбора,ДатаЗавершенияСбора,Шаблон,ИсходныйДокумент,Склад");
	ДокТСД 					= ЗначенияРеквизитовСсылкаНаДок.ТСД;
	ДокДатаНачалаСбора 		= ЗначенияРеквизитовСсылкаНаДок.ДатаНачалаСбора;
	ДокДатаЗавершенияСбора 	= ЗначенияРеквизитовСсылкаНаДок.ДатаЗавершенияСбора;
	Шаблон 					= ЗначенияРеквизитовСсылкаНаДок.Шаблон;
	ИсходныйДокумент 		= ЗначенияРеквизитовСсылкаНаДок.ИсходныйДокумент;
	Склад  					= ЗначенияРеквизитовСсылкаНаДок.Склад;
	
	Если Шаблон = Неопределено Тогда		
		СтруктураОтвета.Вставить("Описание", "Не нашли запись документа. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	ЗначенияРеквизитовШаблон = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ГрупповаяРабота,ПечатьЭтикеткиСерииПодбор,ЕГАИС,ИспользоватьМаркировку,МаркировкаОнлайнПроверкаВложенностиУпаковок,ОтсылатьГотовуюЗаписьНаСерверПодбор,ИспользованиеУпаковочныхЛистовПодбор,МаркировкаЗапретитьАгрегациюВЗаполненныеУпаковки,ПриПревышенииЗаданияПодбор,ВидДокумента,БыстроеСканирование,МаркировкаЗапретитьПовторнуюАгрегациюКМ,КонтролироватьОстатокПоСериям,УникальныеШтрихкодыНоменклатурыВДокументе");
	Шаблон_ГрупповаяРабота = ЗначенияРеквизитовШаблон.ГрупповаяРабота;
	Шаблон_ПечатьЭтикеткиСерииПодбор = ЗначенияРеквизитовШаблон.ПечатьЭтикеткиСерииПодбор;
	Шаблон_ЕГАИС = ЗначенияРеквизитовШаблон.ЕГАИС;
	Шаблон_ИспользоватьМаркировку = ЗначенияРеквизитовШаблон.ИспользоватьМаркировку;
	Шаблон_МаркировкаОнлайнПроверкаВложенностиУпаковок = ЗначенияРеквизитовШаблон.МаркировкаОнлайнПроверкаВложенностиУпаковок;
	Шаблон_ОтсылатьГотовуюЗаписьНаСерверПодбор = ЗначенияРеквизитовШаблон.ОтсылатьГотовуюЗаписьНаСерверПодбор;
	Шаблон_ИспользованиеУпаковочныхЛистовПодбор = ЗначенияРеквизитовШаблон.ИспользованиеУпаковочныхЛистовПодбор;
	Шаблон_МаркировкаЗапретитьАгрегациюВЗаполненныеУпаковки = ЗначенияРеквизитовШаблон.МаркировкаЗапретитьАгрегациюВЗаполненныеУпаковки;
	Шаблон_МаркировкаЗапретитьПовторнуюАгрегациюКМ = ЗначенияРеквизитовШаблон.МаркировкаЗапретитьПовторнуюАгрегациюКМ;
	Шаблон_ПриПревышенииЗаданияПодбор = ЗначенияРеквизитовШаблон.ПриПревышенииЗаданияПодбор;
	Шаблон_ВидДокумента = ЗначенияРеквизитовШаблон.ВидДокумента;
	Шаблон_БыстроеСканирование = ЗначенияРеквизитовШаблон.БыстроеСканирование;
	Шаблон_КонтролироватьОстатокПоСериям = ЗначенияРеквизитовШаблон.КонтролироватьОстатокПоСериям; 
	Шаблон_УникальныеШтрихкодыНоменклатурыВДокументе = ЗначенияРеквизитовШаблон.УникальныеШтрихкодыНоменклатурыВДокументе;		
	
	Если ЗначениеЗаполнено(ДокТСД) Тогда
		Если ДокТСД <> УзелПО Тогда		
			СтруктураОтвета.Вставить("Описание", "Чужой документ. ");	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;	
	
	Если ДокДатаЗавершенияСбора <> Дата(1,1,1) Тогда		
		СтруктураОтвета.Вставить("Описание", "Закрытый документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;		
	
	//ЗАПИСЬ	
	Если Не Шаблон_ГрупповаяРабота И Не Шаблон_БыстроеСканирование Тогда
		//ОБЫЧНАЯ ЛОГИКА
		Попытка
			Объект = СсылкаНаДок.ПолучитьОбъект();
		Исключение
		КонецПопытки;
		
		Если Объект = Неопределено Тогда	
			СтруктураОтвета.Вставить("Описание", "Не нашли документ. ");	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	Иначе
		Объект = Неопределено;	
	КонецЕсли;
	
	//ПРОВЕРКА ДУБЛЕЙ
	Если ПроверитьЗаписи("Select", УзелПО, СсылкаНаДок, СтрокаДокумента, Объект) Тогда
		СтруктураОтвета.Вставить("is_success", Истина);	
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	КонецЕсли;
	
	//ПРОВЕРКА СЕРИЙ/СЕРИЙНЫХ НОМЕРОВ
	Если СтрокаДокумента.sn <> "" И СтрокаДокумента.sn <> "[]" Тогда
		ШаблонПроверкиСерии = "";
		Если СерияНеПодходит(УзелПО, СсылкаНаДок, СтрокаДокумента, ШаблонПроверкиСерии) Тогда		
			СтруктураОтвета.Вставить("Описание", "Серийный номер " + СтрокаДокумента.sn + " не соответсвует шаблону " + ШаблонПроверкиСерии);	
			Возврат ПодготовитьОтветJSON(,СтруктураОтвета);
		КонецЕсли;
	КонецЕсли;
	
	//СТРУКТУРА СТРОКИ
	СтруктураСтроки = ПолучитьСтруктуруСтрокиДокумента("Select", УзелПО, СсылкаНаДок, СтрокаДокумента, UserName);
	
	//ПРОВЕРКА ПРИНАДЛЕЖНОСТИ ЯЧЕЙКИ К СКЛАДУ ДОКУМЕНТА
	Если ЗначениеЗаполнено(СтруктураСтроки.ЯчейкаСсылка) И Не СтруктураСтроки.Количество < 0 Тогда
		Если Шаблон_ГрупповаяРабота Тогда
			СкладЯчеек = ДатаМобайл_ОбщийМодуль.ПолучитьСкладВведенныхЯчеекГрупповаяРабота(СсылкаНаДок);			
		Иначе
			СкладЯчеек = ДатаМобайл_ОбщийМодуль.ПолучитьСкладВведенныхЯчеек(СсылкаНаДок.СобранныеДанныеПодбор.Выгрузить());
		КонецЕсли;
		
		Если ЗначениеЗаполнено(СкладЯчеек) И Не СтруктураСтроки.ЯчейкаСсылка.Владелец = СкладЯчеек Тогда
			СтруктураОтвета.Вставить("Описание","Введены ячейки разных складов в одном документе, строка не может быть записана!");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	КонецЕсли;
	
	//ЗАПИСЬ В РЕГИСТР ЗНАЧЕНИЙ ДОП ФОРМ
	ЗаписьЗначенийДопФормВРегистр(СтруктураСтроки);
	
	//УдалениеЗначенийДополнительныхФорм
	Если СтруктураСтроки.Количество < 0 Тогда
		ДатаМобайл_ОбщийМодуль.УдалитьЗначениеФормыПоСтроке(СсылкаНаДок, СтруктураСтроки.ИдентификаторСтроки);
	КонецЕсли;
	
	//ПРОВЕРКА ОСТАТКОВ ПО СЕРИЯМ
	Если Шаблон_КонтролироватьОстатокПоСериям И СтрокаДокумента.sn <> "" И СтрокаДокумента.sn <> "[]" И СтруктураСтроки.Количество > 0 Тогда 		
		СообщениеОПревышении = "";
		Если ПроверитьПревышениеОстатковПоСерии(УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки, СообщениеОПревышении) Тогда
			СтруктураОтвета.Вставить("Описание", СообщениеОПревышении);		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	КонецЕсли;	
	
	//ПЕЧАТЬ ЭТИКЕТОК СЕРИЙ/СЕРИЙНЫХ НОМЕРОВ
	Если Шаблон_ПечатьЭтикеткиСерииПодбор И СтрокаДокумента.sn <> "" И СтрокаДокумента.sn <> "[]" И СтруктураСтроки.Количество > 0 Тогда
		ОписаниеОшибки = "";
		ОтправитьСериюНаПечать(SN, UserName, DocOutID, СтруктураСтроки, ОписаниеОшибки);
		Если ОписаниеОшибки <> "" Тогда		
			СтруктураОтвета.Вставить("Описание", ОписаниеОшибки);		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;	
	
	//ПРОВЕРКА УНИКАЛЬНОСТИ МАРКИ ЕГАИС ПРИ ГРУППОВОЙ РАБОТЕ
	Если Шаблон_ГрупповаяРабота И Шаблон_ЕГАИС И Число(СтрокаДокумента.qty) > 0 И СтрокаДокумента.egais.mark <> "" Тогда	
		Если ПроверитьУникальностьМаркиЕгаисГрупповогоЗадания("Select", УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки) Тогда		
			СтруктураОтвета.Вставить("Описание", "Данная марка уже была отсканирована ранее." );		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли; 
	
	//ПРОВЕРКА УНИКАЛЬНОСТИ МАРКИ ЕГАИС ПРИ РАБОТЕ С УПАКОВКАМИ
	Если Шаблон_ЕГАИС И Шаблон_МаркировкаОнлайнПроверкаВложенностиУпаковок И Число(СтрокаДокумента.qty) > 0 Тогда
		Если БылоСканированиеУпаковкиВСоставеДругойВЭтомДокументе(СтруктураСтроки, СсылкаНаДок, Шаблон) Тогда	
			СтруктураОтвета.Вставить("Описание", "Нарушение состава упаковки при сканировании (вложение или агрегат уже были отсканированы в документе ранее).");
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
		КонецЕсли;	
	КонецЕсли;    
	
	//ПРОВЕРКА УНИКАЛЬНОСТИ КМ ПРИ ГРУППОВОЙ РАБОТЕ
	Если Шаблон_ГрупповаяРабота И Шаблон_ИспользоватьМаркировку И Число(СтрокаДокумента.qty) > 0 И СтрокаДокумента.marking.mark <> "" Тогда	
		Если ПроверитьУникальностьКодаМаркировкиГрупповогоЗадания("Select", УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки) Тогда	
			СтруктураОтвета.Вставить("Описание", "Данный КМ уже был отсканирован ранее. ");	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;
	
	//ПРОВЕРКА УНИКАЛЬНОСТИ КМ ПРИ РАБОТЕ С УПАКОВКАМИ
	Если Шаблон_ИспользоватьМаркировку И Шаблон_МаркировкаОнлайнПроверкаВложенностиУпаковок И Число(СтрокаДокумента.qty) > 0 Тогда
		Если БылоСканированиеУпаковкиВСоставеДругойВЭтомДокументе(СтруктураСтроки, СсылкаНаДок, Шаблон) Тогда	
			СтруктураОтвета.Вставить("Описание", "Нарушение состава упаковки при сканировании (вложение или агрегат уже были отсканированы в документе ранее).");
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
		КонецЕсли;	
	КонецЕсли;
	
	//ПРОВЕРКА УПАКОВКИ КМ ПРИ АГРЕГАЦИИ
	Если Шаблон_ИспользоватьМаркировку И Шаблон_ОтсылатьГотовуюЗаписьНаСерверПодбор И Шаблон_ИспользованиеУпаковочныхЛистовПодбор <> 0 И Шаблон_ИспользованиеУпаковочныхЛистовПодбор <> 2 И Число(СтрокаДокумента.qty) > 0 Тогда				
		Если Шаблон_МаркировкаЗапретитьПовторнуюАгрегациюКМ Тогда
			Если КодМаркировкиУжеАгрегирован(СтруктураСтроки, СсылкаНаДок, Шаблон) Тогда
				СтруктураОтвета.Вставить("Описание", "Код маркировки уже помещен в другую упаковку.");
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
		КонецЕсли;
		
		Если Шаблон_МаркировкаЗапретитьАгрегациюВЗаполненныеУпаковки Тогда
			Если УпаковочныйЛистУжеИмеетВложенность(СтруктураСтроки, СсылкаНаДок, Шаблон) Тогда
				СтруктураОтвета.Вставить("Описание", "Групповая упаковка не может быть использована, т.к. уже была заполнена ранее.");
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
		КонецЕсли;	
	КонецЕсли;
		
	//ПРЕВЫШЕНИЕ ПРИ ГРУППОВОЙ РАБОТЕ
	Если Шаблон_ГрупповаяРабота И Шаблон_ПриПревышенииЗаданияПодбор = 2 Тогда	
		Если ПроверитьПревышениеГрупповогоЗадания("Select",УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки) Тогда
			СтруктураОтвета.Вставить("Описание", "Превышено задание по данной номенклатуре. ");
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;
	
	//Уникальность ШК ПРИ ГРУППОВОЙ РАБОТЕ
	Если Шаблон_ГрупповаяРабота И Шаблон_УникальныеШтрихкодыНоменклатурыВДокументе Тогда	
		Если СтруктураСтроки.Количество > 0 И ПроверитьУникальностьШКГрупповогоЗадания("Select", УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки) Тогда
			СтруктураОтвета.Вставить("Описание", "Данный ШК был отсканирован на другом ТСД. ");
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;
	
	// аст ПРЕВЫШЕНИЕ ПО СПРАВКАМ ЕГАИС
	Если Шаблон_ЕГАИС И Шаблон_ВидДокумента = "астТоварноТранспортныеНакладныеИзЕГАИС" И Шаблон_ПриПревышенииЗаданияПодбор = 2 И Число(СтрокаДокумента.qty) > 0 Тогда		
		Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
		ТипДокумента = Модуль_ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ИсходныйДокумент, "ТипДокумента");
		
		Если ТипДокумента = ПредопределенноеЗначение("Перечисление.астТипыАктовТоварноТранспортныхНакладныхЕГАИС.Исходящий") Тогда		
			ЗначениеВозврата = ПроверитьПревышениеЗаданияПоСправкамЕГАИС("Select", УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки);
			Если ЗначениеВозврата = 1 Тогда
				СтруктураОтвета.Вставить("Описание", "Превышено задание по данной справке Б. ");
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			ИначеЕсли ЗначениеВозврата = 2 Тогда
				СтруктураОтвета.Вставить("Описание", "Не найдена справка Б в документе.");			
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			ИначеЕсли ЗначениеВозврата = 3 Тогда			
				СтруктураОтвета.Вставить("Описание", "Не найдена справка Б по новой марке.");				
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;			
		КонецЕсли;	
	КонецЕсли;
		
	//ЗАПИСЬ	
	Если Не Шаблон_ГрупповаяРабота И Не Шаблон_БыстроеСканирование Тогда
		
		Если Не ЗначениеЗаполнено(ДокДатаНачалаСбора) Тогда
			Объект.ДатаНачалаСбора = ТекущаяДата();
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(ДокТСД) Тогда
			Объект.ТСД = УзелПО;
		КонецЕсли;
		
		НоваяСтрока = Объект.СобранныеДанныеПодбор.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтруктураСтроки);
		
		Попытка
			Объект.ДополнительныеСвойства.Вставить("ЗапросВСервисЧЗ", Истина);
			Объект.Записать();
			
			//ЗафиксироватьТранзакцию();
			
			//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
			ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
		Исключение
			СтруктураОтвета.Вставить("Описание", "Не смогли записать документ. ");				
			Возврат ПодготовитьОтветJSON(,СтруктураОтвета);
		КонецПопытки;
		
	Иначе
		//ГРУППОВОЙ ДОКУМЕНТ
		ДатаМобайл_ОбщийМодуль.СоздатьЗаписиГрупповогоДокумента(СтруктураСтроки);
		
		Если Шаблон_ГрупповаяРабота Тогда			
			ДатаСбораПоТСД = ДатаМобайл_ОбщийМодуль.ПолучитьДатуГрупповогоДокумента(SN, СсылкаНаДок, "ДатаНачалаСбора");	
			Если Не ЗначениеЗаполнено(ДатаСбораПоТСД) Тогда	
				ДатаМобайл_ОбщийМодуль.СоздатьНачальнуюЗаписьТСДГрупповыхДокументов(SN, СсылкаНаДок, UserName);		
			КонецЕсли;
		КонецЕсли;	
		
		Если Не ЗначениеЗаполнено(ДокДатаНачалаСбора) Тогда
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора=ТекущаяДата();
				
				Объект.ДополнительныеСвойства.Вставить("ЗапросВСервисЧЗ", Истина);
				Объект.Записать();
			Исключение
			КонецПопытки;	
			
		КонецЕсли;
		
	КонецЕсли;	
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Передача записанных в документе строк (приемка).
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа.
// СтрокаДокумента - Структура - Структура данных строки документа.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
// 
Функция OnWriteRecInsert(SN, UserName, DocOutID, СтрокаДокумента) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	ЗначенияРеквизитовСсылкаНаДок = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок,"ТСД, ДатаНачалаСбора,ДатаЗавершенияСбора,Шаблон,ИсходныйДокумент,Склад");
	ДокТСД 						= ЗначенияРеквизитовСсылкаНаДок.ТСД;
	ДокДатаНачалаСбора 			= ЗначенияРеквизитовСсылкаНаДок.ДатаНачалаСбора;
	ДокДатаЗавершенияСбора 		= ЗначенияРеквизитовСсылкаНаДок.ДатаЗавершенияСбора;
	Шаблон 						= ЗначенияРеквизитовСсылкаНаДок.Шаблон;
	ИсходныйДокумент 			= ЗначенияРеквизитовСсылкаНаДок.ИсходныйДокумент;
	Склад  						= ЗначенияРеквизитовСсылкаНаДок.Склад;
	
	Если Шаблон = Неопределено Тогда	
		СтруктураОтвета.Вставить("Описание", "Не нашли запись документа. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	ЗначенияРеквизитовШаблон 				    	= Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ГрупповаяРабота,ОтсылатьГотовуюЗаписьНаСерверПриемка,ПриПревышенииЗаданияПриемка,ВидДокумента,БыстроеСканирование,УникальныеШтрихкодыНоменклатурыВДокументе");
	Шаблон_ГрупповаяРабота 					 			= ЗначенияРеквизитовШаблон.ГрупповаяРабота;
	Шаблон_ОтсылатьГотовуюЗаписьНаСерверПриемка 		= ЗначенияРеквизитовШаблон.ОтсылатьГотовуюЗаписьНаСерверПриемка;
	Шаблон_ПриПревышенииЗаданияПриемка 	  				= ЗначенияРеквизитовШаблон.ПриПревышенииЗаданияПриемка;
	Шаблон_ВидДокумента 					    		= ЗначенияРеквизитовШаблон.ВидДокумента;
	Шаблон_БыстроеСканирование 				    		= ЗначенияРеквизитовШаблон.БыстроеСканирование;
	Шаблон_УникальныеШтрихкодыНоменклатурыВДокументе 	= ЗначенияРеквизитовШаблон.УникальныеШтрихкодыНоменклатурыВДокументе;
	
	Если ЗначениеЗаполнено(ДокТСД) Тогда
		Если ДокТСД <> УзелПО Тогда		
			СтруктураОтвета.Вставить("Описание", "Чужой документ.");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;	
	
	Если ДокДатаЗавершенияСбора <> Дата(1,1,1) Тогда	
		СтруктураОтвета.Вставить("Описание", "Закрытый документ.");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	
	
	//ЗАПИСЬ	
	Если Не Шаблон_ГрупповаяРабота И Не Шаблон_БыстроеСканирование Тогда
		//ОБЫЧНАЯ ЛОГИКА
		Попытка
			Объект = СсылкаНаДок.ПолучитьОбъект();
		Исключение
		КонецПопытки;
		
		Если Объект = Неопределено Тогда			
			СтруктураОтвета.Вставить("Описание", "Не нашли документ. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	Иначе
		Объект = Неопределено;	
	КонецЕсли;
	
	//ПРОВЕРКА ДУБЛЕЙ
	Если ПроверитьЗаписи("Insert", УзелПО, СсылкаНаДок, СтрокаДокумента, Объект) Тогда		
		СтруктураОтвета.Вставить("is_success", Истина);		
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	КонецЕсли;
	
	//ПРОВЕРКА СЕРИЙ/СЕРИЙНЫХ НОМЕРОВ
	Если СтрокаДокумента.sn <> "" И СтрокаДокумента.sn <> "[]" Тогда
		ШаблонПроверкиСерии = "";
		Если СерияНеПодходит(УзелПО, СсылкаНаДок, СтрокаДокумента, ШаблонПроверкиСерии) Тогда			
			СтруктураОтвета.Вставить("Описание", "Серийный номер " + СтрокаДокумента.sn + " не соответсвует шаблону " + ШаблонПроверкиСерии);		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	КонецЕсли;
	
	//СТРУКТУРА СТРОКИ
	СтруктураСтроки = ПолучитьСтруктуруСтрокиДокумента("Insert", УзелПО, СсылкаНаДок, СтрокаДокумента, UserName);
	
	//ПРОВЕРКА ПРИНАДЛЕЖНОСТИ ЯЧЕЙКИ К СКЛАДУ ДОКУМЕНТА
	Если ЗначениеЗаполнено(СтруктураСтроки.ЯчейкаСсылка) И Не СтруктураСтроки.Количество < 0 Тогда
		Если Шаблон_ГрупповаяРабота Тогда
			СкладЯчеек = ДатаМобайл_ОбщийМодуль.ПолучитьСкладВведенныхЯчеекГрупповаяРабота(СсылкаНаДок);			
		Иначе
			СкладЯчеек = ДатаМобайл_ОбщийМодуль.ПолучитьСкладВведенныхЯчеек(СсылкаНаДок.СобранныеДанныеПриемка.Выгрузить());
		КонецЕсли;
		
		Если ЗначениеЗаполнено(СкладЯчеек) И Не СтруктураСтроки.ЯчейкаСсылка.Владелец = СкладЯчеек Тогда
			СтруктураОтвета.Вставить("Описание","Введены ячейки разных складов в одном документе, строка не может быть записана!");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	КонецЕсли;
	
	//ЗАПИСЬ В РЕГИСТР ЗНАЧЕНИЙ ДОП ФОРМ
	ЗаписьЗначенийДопФормВРегистр(СтруктураСтроки);
	
	//УдалениеЗначенийДополнительныхФорм
	Если СтруктураСтроки.Количество < 0 Тогда
		ДатаМобайл_ОбщийМодуль.УдалитьЗначениеФормыПоСтроке(СсылкаНаДок, СтруктураСтроки.ИдентификаторСтроки);
	КонецЕсли;
	
	//ПРЕВЫШЕНИЕ ПРИ ГРУППОВОЙ РАБОТЕ
	Если Шаблон_ГрупповаяРабота И Шаблон_ПриПревышенииЗаданияПриемка = 2 Тогда	
		Если ПроверитьПревышениеГрупповогоЗадания("Insert", УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки) Тогда		
			СтруктураОтвета.Вставить("Описание", "Превышено задание по данной номенклатуре.");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
		КонецЕсли;			
	КонецЕсли;
	
	//Уникальность ШК ПРИ ГРУППОВОЙ РАБОТЕ
	Если Шаблон_ГрупповаяРабота И Шаблон_УникальныеШтрихкодыНоменклатурыВДокументе Тогда	
		Если СтруктураСтроки.Количество > 0 И ПроверитьУникальностьШКГрупповогоЗадания("Insert", УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки) Тогда
			СтруктураОтвета.Вставить("Описание", "Данный ШК был отсканирован на другом ТСД. ");
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;
	
	//ЗАПИСЬ	
	Если Не Шаблон_ГрупповаяРабота И Не Шаблон_БыстроеСканирование Тогда
		
		Если Не ЗначениеЗаполнено(ДокДатаНачалаСбора) Тогда
			Объект.ДатаНачалаСбора = ТекущаяДата();
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(ДокТСД) Тогда
			Объект.ТСД = УзелПО;
		КонецЕсли;
		
		НоваяСтрока = Объект.СобранныеДанныеПриемка.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтруктураСтроки);
		
		Попытка			
			Объект.Записать();
			
			//ЗафиксироватьТранзакцию();
			
			//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
			ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);			
		Исключение			
			СтруктураОтвета.Вставить("Описание", "Не смогли записать документ. ");		
			Возврат ПодготовитьОтветJSON(,СтруктураОтвета);
		КонецПопытки;
		
	Иначе
		
		//ГРУППОВОЙ ДОКУМЕНТ
		ДатаМобайл_ОбщийМодуль.СоздатьЗаписиГрупповогоДокумента(СтруктураСтроки);
		
		Если Шаблон_ГрупповаяРабота Тогда
			
			ДатаСбораПоТСД = ДатаМобайл_ОбщийМодуль.ПолучитьДатуГрупповогоДокумента(SN, СсылкаНаДок, "ДатаНачалаСбора");	
			Если Не ЗначениеЗаполнено(ДатаСбораПоТСД) Тогда	
				ДатаМобайл_ОбщийМодуль.СоздатьНачальнуюЗаписьТСДГрупповыхДокументов(SN, СсылкаНаДок, UserName);		
			КонецЕсли;
			
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(ДокДатаНачалаСбора) Тогда
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора = ТекущаяДата();
				
				Объект.Записать();
			Исключение
			КонецПопытки;	
			
		КонецЕсли;
		
	КонецЕсли;	
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Изменение склада в документе.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа.
// WarehouseID - Строка - Id склада.
// Type - Строка - Тип склада.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция SetDocWarehouse(SN, UserName, DocOutID, WarehouseID, Type) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;	
	
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда		
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	
	
	Если Не СсылкаНаДок.ТСД.Пустая() Тогда
		Если СсылкаНаДок.ТСД <> УзелПО Тогда			
			СтруктураОтвета.Вставить("Описание", "Чужой документ. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;	
	
	Объект = СсылкаНаДок.ПолучитьОбъект();
	Если Объект.ДатаНачалаСбора = Дата(1,1,1) Тогда
		Объект.ДатаНачалаСбора = ТекущаяДата();
	КонецЕсли;
	
	Объект.ДатаИзмененияКлиента = ТекущаяДата();
	Попытка 
		Если Type = 1 Тогда
			Если WarehouseID = "" Тогда
				Объект.Склад = Справочники.Склады.ПустаяСсылка();	
			Иначе	
				Объект.Склад = XMLЗначение(Тип("СправочникСсылка.Склады"), WarehouseID);
			КонецЕсли;
		ИначеЕсли Type = 2 Тогда
			Если WarehouseID = "" Тогда
				Объект.СкладПолучатель = Справочники.Склады.ПустаяСсылка();	
			Иначе	
				Объект.СкладПолучатель = XMLЗначение(Тип("СправочникСсылка.Склады"), WarehouseID);    			
			КонецЕсли;	
		Конецесли;
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не найден склад. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;	
	
	Если Не (Объект.Шаблон.ГрупповаяРабота) Тогда
		Объект.ТСД = УзелПО;	
	КонецЕсли;
	
	Попытка		
		Объект.Записать();
		
		//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
		ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не смогли записать документ.  ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;	
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Изменение контрагента в документе.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа.
// ClientID - Строка - Id контрагента.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция SetDocClient(SN, UserName, DocOutID, ClientID) Экспорт
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не найден документ. " );		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;	
	
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда
		СтруктураОтвета.Вставить("Описание", "Не найден документ. " );	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Если Не СсылкаНаДок.ТСД.Пустая() Тогда
		Если СсылкаНаДок.ТСД <> УзелПО Тогда
			СтруктураОтвета.Вставить("Описание", "Чужой документ. " );	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;	
	
	Если СсылкаНаДок.ДатаЗавершенияСбора <> Дата(1, 1, 1) Тогда		
		СтруктураОтвета.Вставить("Описание", "Закрытый документ.");
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	
	
	Объект = СсылкаНаДок.ПолучитьОбъект();
	Если Объект.ДатаНачалаСбора = Дата(1, 1, 1) Тогда
		Объект.ДатаНачалаСбора = ТекущаяДата();
	КонецЕсли;	
	Объект.ДатаИзмененияКлиента = ТекущаяДата();
	Попытка
		Объект.Клиент = XMLЗначение(Тип("СправочникСсылка.Партнеры"), Сред(ClientID, 4));
		Если Объект.Клиент.ПолучитьОбъект() = Неопределено Тогда
			Объект.Клиент = XMLЗначение(Тип("СправочникСсылка.Склады"), Сред(ClientID, 4));
		КонецЕсли;
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не найден клиент. " );	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецПопытки;	
	
	Если Не (Объект.Шаблон.ГрупповаяРабота) Тогда
		Объект.ТСД = УзелПО;	
	КонецЕсли;
	
	Попытка		
		Объект.Записать(); 
		
		//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
		ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Не смогли записать документ. " );		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецПопытки;	
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Изменение комментария в документе.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа.
// Comment - Строка - комментарий.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
// 
Функция SetDocComment(SN, UserName, DocOutID, Comment) Экспорт
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не найден документ. " );		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда
		СтруктураОтвета.Вставить("Описание", "Не найден документ. " );		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Если Не СсылкаНаДок.ТСД.Пустая() Тогда
		Если СсылкаНаДок.ТСД <> УзелПО Тогда		
			СтруктураОтвета.Вставить("Описание", "Чужой документ. " );		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;
	
	Если ССылкаНаДок.Шаблон.ЗапретитьРучноеИзменениеКомментария Тогда		
		СтруктураОтвета.Вставить("Описание", "Изменение комментария запрещено шаблоном. " );		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Если СсылкаНаДок.ДатаЗавершенияСбора <> Дата(1, 1, 1) Тогда		
		СтруктураОтвета.Вставить("Описание", "Закрытый документ.");
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	
	
	Объект = СсылкаНаДок.ПолучитьОбъект();
	Если Объект.ДатаНачалаСбора = Дата(1, 1, 1) Тогда
		Объект.ДатаНачалаСбора = ТекущаяДата();
	КонецЕсли;	
	
	Объект.Комментарий = Comment;
	
	Если Объект.ТСД.Пустая() И Не(СсылкаНаДок.Шаблон.ГрупповаяРабота) Тогда
		Объект.ТСД = УзелПО;
	КонецЕсли;
	
	Попытка		
		Объект.Записать();
		
		//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
		ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Не смогли записать документ. " );		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;	
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Удаление документа.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция DeleteDoc(SN, UserName, DocOutID) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5)); 		
	Исключение	
		СтруктураОтвета.Вставить("is_success", Истина);
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	КонецПопытки;
	
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда
		СтруктураОтвета.Вставить("is_success", Истина);
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	КонецЕсли;	
	Если Не СсылкаНаДок.ТСД.Пустая() Тогда
		Если СсылкаНаДок.ТСД <> УзелПО Тогда
			СтруктураОтвета.Вставить("Описание", "Чужой документ. " );		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
		КонецЕсли;	
	КонецЕсли;	
	Если СсылкаНаДок.ДатаЗавершения = Дата(1,1,1) Тогда		
		СтруктураОтвета.Вставить("Описание", "Удалить можно только завершенный документ. " );		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецЕсли;	
	
	СтруктураОтвета.Вставить("is_success", Истина);
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Очистка документа.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция ClearDoc(SN, UserName, DocOutID) Экспорт
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;		
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение	
		СтруктураОтвета.Вставить("is_success", Истина);
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	КонецПопытки;
	
	Если СсылкаНаДок.Шаблон.РаспределениеТоваров > 0 Тогда		
		СтруктураОтвета.Вставить("Описание", "Групповой документ не поддерживает очистку. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Если СсылкаНаДок.Шаблон.ГрупповаяРабота Тогда		
		СтруктураОтвета.Вставить("Описание", "Документ с коллективной работой не поддерживает очистку. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда
		СтруктураОтвета.Вставить("is_success", Истина);
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		
	КонецЕсли;	
	
	Если Не СсылкаНаДок.ТСД.Пустая() Тогда
		Если СсылкаНаДок.ТСД <> УзелПО Тогда		
			СтруктураОтвета.Вставить("Описание", "Чужой документ. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	КонецЕсли;	
	
	Если СсылкаНаДок.ДатаЗавершенияСбора <> Дата(1,1,1) Тогда		
		СтруктураОтвета.Вставить("Описание", "Закрытый документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	
	
	Попытка
		Объект = СсылкаНаДок.ПолучитьОбъект();
		Объект.ДатаНачалаСбора = "";
		Объект.ДатаЗавершенияСбора = "";
		
		Объект.СобранныеДанныеПодбор.Очистить();
		Объект.СобранныеДанныеПриемка.Очистить();
				
		Объект.Записать();
		
		// очистка при быстром сканировании
		ДатаМобайл_ОбщийМодуль.ОчиститьЗаписиГрупповогоДокумента(СсылкаНаДок);

		// очистка значений доп.форм
		ДатаМобайл_ОбщийМодуль.ОчиститьЗаписиЗначенийДополнительныхФорм(СсылкаНаДок);
		
		//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
		ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
	Исключение			
		СтруктураОтвета.Вставить("Описание", "Ошибка очистки. " + ОписаниеОшибки());		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;	
	
	СтруктураОтвета.Вставить("is_success", Истина);
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Получение групповых строк документов с групповой работой.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа.  
// LastRequestDate - Строка - Дата и время последней синхронизации.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetSelectedQtyGroupDocRows_БезАтрибутовДопФорм(SN, UserName, DocOutID, LastRequestDate) Экспорт
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	Если LastRequestDate = "0" Тогда 
		ДатаПоследнегоЗапроса = Дата(1, 1, 1);
	Иначе
		ДатаПоследнегоЗапроса = TimestampВДату(LastRequestDate);	
	КонецЕсли;
	
	ТекущаяДатаЗапроса = ТекущаяДата();	
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;	
	
	Если СсылкаНаДок.Шаблон.РаспределениеТоваров = 2 Тогда
		Если СсылкаНаДок.СписокДокументов.ВыгрузитьКолонку("ДокументТСД").Количество() = 0 И Не ЗначениеЗаполнено(СсылкаНаДок.РодительскийДокумент) Тогда		
			СтруктураОтвета.Вставить("Описание", "Настройка ""Групповой документ"" не поддерживает работу без задания! ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД,
	|	ВЫБОР
	|		КОГДА ДатаМобайл_СтрокиГрупповыхДокументов.ИмяТаблицы = ""Select""
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК operation_type,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Штрихкод КАК barcode,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.СерийныйНомер КАК sn,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Ячейка КАК cell,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.НазваниеТовара КАК art_name,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура КАК Номенклатура,  
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ХарактеристикаНоменклатуры.Наименование КАК НаименованиеХарактеристики,   
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ХарактеристикаНоменклатуры КАК Характеристика,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.КодТовара КАК art_id,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Короб КАК box_pack,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист КАК pack,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ЕдиницаИзмерения КАК Упаковка,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы, 1) = 0
	|			ТОГДА 1
	|		ИНАЧЕ ЕСТЬNULL(ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы, 1)
	|	КОНЕЦ КАК Коэффициент,
	|	СУММА(ДатаМобайл_СтрокиГрупповыхДокументов.Количество * 
	|		ВЫБОР
	|			КОГДА ЕСТЬNULL(ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы, 1) = 0
	|				ТОГДА 1
	|			ИНАЧЕ ЕСТЬNULL(ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы, 1)
	|		КОНЕЦ) КАК qty
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ДатаМобайл_СтрокиГрупповыхДокументов
	|ГДЕ
	|	НЕ ДатаМобайл_СтрокиГрупповыхДокументов.ТСД = &ТСД
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД = &ИндетификаторДокумента
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.ДатаЗаписи >= &ДатаНач
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.ДатаЗаписи < &ДатаКон
	|	И НЕ ДатаМобайл_СтрокиГрупповыхДокументов.ДатаЗаписи = ДАТАВРЕМЯ(1,1,1,0,0,0)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД,
	|	ВЫБОР
	|		КОГДА ДатаМобайл_СтрокиГрупповыхДокументов.ИмяТаблицы = ""Select""
	|			ТОГДА 0
	|		ИНАЧЕ 1
	|	КОНЕЦ,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Штрихкод,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.СерийныйНомер,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Ячейка,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.КодТовара,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.НазваниеТовара,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура,      
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.АлкогольнаяПродукция,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.ИспользованиеХарактеристик,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.ВесМожноУказыватьВДокументах,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.ВидНоменклатуры,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.ВладелецХарактеристик,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.Наименование,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура.ВидНоменклатуры.ТипНоменклатуры,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ХарактеристикаНоменклатуры.Наименование,      
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ХарактеристикаНоменклатуры,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ЕдиницаИзмерения,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.КоэффициентЕдиницы,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Короб,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист";	
	
	Запрос.УстановитьПараметр("ДатаНач", ДатаПоследнегоЗапроса);
	Запрос.УстановитьПараметр("ДатаКон", ТекущаяДатаЗапроса);
	Запрос.УстановитьПараметр("Тсд", УзелПО);
	
	Если СсылкаНаДок.Шаблон.РаспределениеТоваров = 2 Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД = &ИндетификаторДокумента","ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД В(&ДокументыТСД)");
		Запрос.УстановитьПараметр("ДокументыТСД", СсылкаНаДок.СписокДокументов.ВыгрузитьКолонку("ДокументТСД"));
	Иначе	
		Запрос.УстановитьПараметр("ИндетификаторДокумента", СсылкаНаДок);
	КонецЕсли;
	
	Рез = Запрос.Выполнить().Выбрать();	
	Пока Рез.Следующий() Цикл
		
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan");
		ОбъектТовара.name = Рез.art_name;
		ОбъектТовара.id   = Рез.art_id;
		
		ТекущаяНоменклатура  = Рез.Номенклатура;
		ТекущаяХарактеристика  = Рез.Характеристика;
		ОбъектТовара.price = ПолучитьЦенуТовара(ТекущаяНоменклатура, ТекущаяХарактеристика, УзелПО.ТипЦен);
		
		// Выгрузка дополнительных видов цен
		ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, ТекущаяНоменклатура, ТекущаяХарактеристика);
		
		Попытка	
			DMUseSN = ПолучитьПризнакУчетаСерий(ТекущаяНоменклатура.ВидНоменклатуры, СсылкаНаДок.Склад);
		Исключение
			DMUseSN = Ложь;
		КонецПопытки;		
		
		СформироватьЗаголовкиJSONParamsТовара(УзелПО,ОбъектТовара,Рез, DMUseSN,СсылкаНаДок.Шаблон);
		
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		СтруктураТекущейСтроки.Вставить("operation_type", Рез.operation_type);
		СтруктураТекущейСтроки.Вставить("created_at", ДатуВTimestamp(ТекущаяДатаЗапроса, Истина));
		
		Попытка
			ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","unit_value");
			ОбъектШтрихкода.value = ЧистаяСтрока(Рез.barcode);			
			ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, Рез.Упаковка, ТекущаяНоменклатура);		
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
		Исключение
		Конецпопытки;
		
		Если ЗначениеЗаполнено(Рез.cell) Тогда
			ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell","barcode");
			ОбъектЯчейки.barcode  = Рез.cell;
			СтруктураТекущейСтроки.Вставить("cell", ОбъектЯчейки);
		КонецЕсли;	
		
		Если ЗначениеЗаполнено(Рез.sn) Тогда
			СтруктураТекущейСтроки.Вставить("sn", Рез.sn);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.box_pack) Тогда
			СтруктураТекущейСтроки.Вставить("box_pack", Рез.box_pack);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Рез.pack) Тогда
			СтруктураТекущейСтроки.Вставить("pack", Рез.pack);
		КонецЕсли;
		
		СтруктураТекущейСтроки.Вставить("qty", Рез.qty);
		Попытка
			СтруктураТекущейСтроки.Вставить("unit_qty", Рез.qty / ОбъектШтрихкода.unit_coef);
		Исключение
			СтруктураТекущейСтроки.Вставить("unit_qty", Рез.qty);
		КонецПопытки;
			
		Если СсылкаНаДок.Шаблон.РаспределениеТоваров = 2 Тогда
			СтруктураТекущейСтроки.Вставить("child_doc_out_id","d82-" + XMLСтрока(Рез.ДокументТСД));			
		КонецЕсли;
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Изменение статуса документа   
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа.
// StateID - Строка - Id статуса.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция SetDocState(SN, UserName, DocOutID, StateID) Экспорт 
	 
	 СтруктураОтвета = Новый Структура;
	 
	 УзелПО = НайтиУзел(SN);
	 Если УзелПО = Неопределено Тогда
		 УзелПО = NewTSD(SN, UserName);
	 КонецЕсли;	
	 
	 Попытка
		 СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	 Исключение	
		 СтруктураОтвета.Вставить("Описание", "Не найден документ. " );		
		 Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	 КонецПопытки;	
	 
	 Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда		
		 СтруктураОтвета.Вставить("Описание", "Не найден документ. " );	
		 Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	 КонецЕсли;
	 
	 // ЗАПИСЬ
	 Если Не СсылкаНаДок.Шаблон.ГрупповаяРабота Тогда
		 Попытка
			 //Если StateID = "0" Тогда
			 Объект = СсылкаНаДок.ПолучитьОбъект();  // пока всегда 0 будет
			 Объект.ТСД = УзелПО;
			 Объект.Записать();
			 // КонецЕсли;
			 
			 //УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
			 ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
			 
		 Исключение	
			 СтруктураОтвета.Вставить("Описание", "Не смогли записать документ. " );		
			 Возврат ПодготовитьОтветJSON(,СтруктураОтвета);		
		 КонецПопытки;		 
	 КонецЕсли;
	 
	 СтруктураОтвета.Вставить("is_success", Истина);
	 
	 Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	 
 КонецФункции
 
#КонецОбласти

#Область Print

// Печать этикеток товара.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// ArtID - Строка - Id товара.
// Barcode - Строка - ШК. 
// Count - Число - Количество.
// qty_int - Число - Количество до запятой.
// qty_frac - Число - Количество после запятой.
// sn_values - Строка - Серийный номер. 
// measure_name - Строка - Наименование ЕИ.
// is_km - Булево - Признак печати КМ.
// gs1 - Строка - Значение ШК GS1.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция SendArtToPrint(SN, UserName, ArtID, Barcode, Count, qty_int, qty_frac, sn_values, measure_name, is_km, gs1, barcode_full, is_need_print_copy) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	СтруктураParams = Новый Структура;
	
	СтруктураParams.Вставить("QtyInt",      			qty_int);
	СтруктураParams.Вставить("QtyFrac",     			qty_frac);
	СтруктураParams.Вставить("snValues",    			sn_values);
	СтруктураParams.Вставить("MeasureName", 			measure_name);
	СтруктураParams.Вставить("GS1", 	    			gs1);
	СтруктураParams.Вставить("barcode_full", 			barcode_full);
	СтруктураParams.Вставить("is_need_print_copy", 	    is_need_print_copy);
	
	Если УзелПО.ОнлайнСвязьСПринтсервером Тогда	
		АдресПринтсервера = УзелПО.АдресПринтсервера;
		ПортПринтсервера = УзелПО.ПортПринтсервера;
		Если АдресПринтсервера = "" Или ПортПринтсервера = 0 Тогда			
			СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указаны настройки онлайн связи с принтсервером. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);			
		КонецЕсли;	
	Иначе	
		КаталогСохранения = УзелПО.КаталогВыгрузкиФайлаПечати;
		Если КаталогСохранения = "" Тогда		
			СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указан каталог сохранения файлов печати. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);			
		КонецЕсли;
	КонецЕсли;
	
	Попытка
		
		Если ЗначениеЗаполнено(ArtID) Тогда
			Если Лев(ArtID, 3) = "8U-" Тогда
				лТовар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));
				ИДХК = Сред(ArtID, 40, 36);
				Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
					лХарактеристика = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);
				Иначе
					лХарактеристика = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
				КонецЕсли;
			ИначеЕсли Лев(ArtID, 3) = "8n-" Тогда
				лТовар = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_НовыеТовары"), Сред(ArtID, 4));
				лХарактеристика = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();			
			Иначе 	
				лТовар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4));
				лХарактеристика = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();	
			КонецЕсли;
		Иначе
			лТовар = Справочники.Номенклатура.ПустаяСсылка();
			лХарактеристика = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();	
		КонецЕсли;	
		
	Исключение
		
		лТовар = Справочники.Номенклатура.ПустаяСсылка();
		лХарактеристика = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();	
		
	КонецПопытки;
	
	Если is_km = Истина Тогда 			
		Если ДатаМобайл_Маркировка.ПолучитьТипМаркированнойПродукции(лТовар) = 2 Тогда	//Маркировка обувь
			
			ОписаниеОшибки = "";
			ВыполнитьПечатьКодовМаркировкиОбувь(УзелПО, лТовар, лХарактеристика, Barcode, Count, СтруктураParams, ОписаниеОшибки);
			Если ОписаниеОшибки <> "" Тогда
				СтруктураОтвета.Вставить("Описание", ОписаниеОшибки);			
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
			
		Иначе			
			СтруктураОтвета.Вставить("Описание", "Для данного типа маркированной продукции не предусмотрена печать. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
		КонецЕсли;			
	Иначе
		
		СтруктураПоиска = Новый Структура("ТипОперации", "Печать этикетки");
		СтрокиРеквизитов = УзелПО.Печать.НайтиСтроки(СтруктураПоиска);
		Если СтрокиРеквизитов.Количество() = 0 Тогда		
			СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указан шаблон печати этикеток. ");
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
		КонецЕсли;
		ОписаниеОшибки = "";		
		ВыполнитьПечатьОбычныхТоваров(УзелПО, лТовар, лХарактеристика, Barcode, Count, СтруктураParams, ОписаниеОшибки);
		Если ОписаниеОшибки <> "" Тогда
			СтруктураОтвета.Вставить("Описание", ОписаниеОшибки);			
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
		
	КонецЕсли;
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Печать упаковки.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocID - Строка - Id документа ТСД.
// Pack - Строка - Id упаковки.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция SendPackToPrint(SN, UserName, DocID, Pack) Экспорт
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	// Zolla ++
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocID, 5));
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	Если Шаблон.ДМ_ОтгрузкаИзМагазина Тогда
		Возврат ДМ_SendPackToPrint(УзелПО, UserName, СсылкаНаДок, Pack);
	// Zolla -- 
	
	Иначе
		Если УзелПО.ОнлайнСвязьСПринтсервером Тогда	
			АдресПринтсервера = УзелПО.АдресПринтсервера;
			ПортПринтсервера = УзелПО.ПортПринтсервера;
			Если АдресПринтсервера = "" Или ПортПринтсервера = 0 Тогда	
				СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указаны настройки онлайн связи с принтсервером. ");	
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;	
		Иначе	
			КаталогСохранения = УзелПО.КаталогВыгрузкиФайлаПечати;
			Если КаталогСохранения = "" Тогда		
				СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указан каталог сохранения файлов печати. ");		
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
		КонецЕсли;
		
		СтруктураПоиска = Новый Структура("ТипОперации", "Печать упаковочного листа");
		
		СтрокиРеквизитов = УзелПО.Печать.НайтиСтроки(СтруктураПоиска);
		Если СтрокиРеквизитов.Количество() = 0 Тогда		
			СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указан шаблон печати упаковочного листа. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
		КонецЕсли;	
		
		Попытка
			СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocID, 5));
		Исключение		
			СтруктураОтвета.Вставить("Описание", "Не найден документ. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецПопытки;
		
		ЗапросДанныхПодбор = Новый Запрос();
		ЗапросДанныхПодбор.Текст = "ВЫБРАТЬ
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ИдентификаторСтроки,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Номенклатура,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ХарактеристикаНоменклатуры,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.НазваниеТовара,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ЕдиницаИзмерения,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ЯчейкаСсылка,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.СерийныйНомер,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ШтрихКод,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Количество
		|ИЗ
		|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор
		|ГДЕ
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Ссылка = &СсылкаНаДок
		|	И ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист = &ТекущийУпакЛист	
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ИдентификаторСтроки,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ХарактеристикаНоменклатуры,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.НазваниеТовара,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ЕдиницаИзмерения,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ЯчейкаСсылка,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.СерийныйНомер,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Штрихкод,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Количество
		|ИЗ
		|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ДатаМобайл_СтрокиГрупповыхДокументов
		|ГДЕ
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД = &СсылкаНаДок
		|	И НЕ ДатаМобайл_СтрокиГрупповыхДокументов.ДляОбмена
		|	И ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист = &ТекущийУпакЛист
		|	И ДатаМобайл_СтрокиГрупповыхДокументов.ИмяТаблицы = &ИмяТаблицы";	
		
		ЗапросДанныхПодбор.УстановитьПараметр("СсылкаНаДок", СсылкаНаДок);		
		ЗапросДанныхПодбор.УстановитьПараметр("ИмяТаблицы", "Select");
		Если СсылкаНаДок.Шаблон.ИспользоватьМаркировку Тогда
			ТекущийУпаковочныйЛист = Pack;
			ТекущийУпаковочныйЛист = СтрЗаменить(ТекущийУпаковочныйЛист, "[", "(");
			ТекущийУпаковочныйЛист = СтрЗаменить(ТекущийУпаковочныйЛист, "]", ")");
			
			Если СтрДлина(ТекущийУпаковочныйЛист) = 20 И Лев(ТекущийУпаковочныйЛист,2) = "00" Тогда		
				ТекущийУпаковочныйЛист = "(00)" +  Сред(ТекущийУпаковочныйЛист, 3, 18);
			КонецЕсли;	
			
			ЗапросДанныхПодбор.УстановитьПараметр("ТекущийУпакЛист", ТекущийУпаковочныйЛист);
		Иначе   
			ТекущийУпаковочныйЛист = Pack; 
			ЗапросДанныхПодбор.УстановитьПараметр("ТекущийУпакЛист", ТекущийУпаковочныйЛист);		
		КонецЕсли;
		
		ТЗСобранныеДанныеПодбор = ЗапросДанныхПодбор.Выполнить().Выгрузить();
		ТЗСобранныеДанныеПодбор.Колонки.Добавить("КоличествоСтрок", Новый ОписаниеТипов("Число"));
		Для каждого строка Из ТЗСобранныеДанныеПодбор Цикл
			Если строка.Количество > 0 Тогда
				строка.КоличествоСтрок = 1;
			ИначеЕсли строка.Количество < 0 Тогда
				строка.КоличествоСтрок = -1;
			КонецЕсли;			
		КонецЦикла;	
		ТЗСобранныеДанныеПодбор.Свернуть("Номенклатура,ХарактеристикаНоменклатуры,НазваниеТовара,ЕдиницаИзмерения,ЯчейкаСсылка,СерийныйНомер,ШтрихКод,УпаковочныйЛист","Количество,КоличествоСтрок");
		
		ЗапросДанныхПриемка = Новый Запрос();
		ЗапросДанныхПриемка.Текст = "ВЫБРАТЬ
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.ИдентификаторСтроки,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.Номенклатура,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.ХарактеристикаНоменклатуры,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.НазваниеТовара,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.ЕдиницаИзмерения,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.ЯчейкаСсылка,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.СерийныйНомер,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.ШтрихКод,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.УпаковочныйЛист,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.Количество
		|ИЗ
		|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПриемка КАК ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка
		|ГДЕ
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.Ссылка = &СсылкаНаДок
		|	И ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.УпаковочныйЛист = &ТекущийУпакЛист
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ИдентификаторСтроки,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ХарактеристикаНоменклатуры,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.НазваниеТовара,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ЕдиницаИзмерения,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ЯчейкаСсылка,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.СерийныйНомер,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Штрихкод,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Количество
		|ИЗ
		|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ДатаМобайл_СтрокиГрупповыхДокументов
		|ГДЕ
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД = &СсылкаНаДок
		|	И НЕ ДатаМобайл_СтрокиГрупповыхДокументов.ДляОбмена
		|	И ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист = &ТекущийУпакЛист
		|	И ДатаМобайл_СтрокиГрупповыхДокументов.ИмяТаблицы = &ИмяТаблицы";
		
		ЗапросДанныхПриемка.УстановитьПараметр("СсылкаНаДок", СсылкаНаДок);
		ЗапросДанныхПриемка.УстановитьПараметр("ИмяТаблицы", "Insert");
		Если СсылкаНаДок.Шаблон.ИспользоватьМаркировку Тогда
			ТекущийУпаковочныйЛист = Pack;
			ТекущийУпаковочныйЛист = СтрЗаменить(ТекущийУпаковочныйЛист, "[", "(");
			ТекущийУпаковочныйЛист = СтрЗаменить(ТекущийУпаковочныйЛист, "]", ")");
			
			Если СтрДлина(ТекущийУпаковочныйЛист) = 20 И Лев(ТекущийУпаковочныйЛист,2) = "00" Тогда		
				ТекущийУпаковочныйЛист = "(00)" +  Сред(ТекущийУпаковочныйЛист, 3, 18);
			КонецЕсли;	
			
			ЗапросДанныхПриемка.УстановитьПараметр("ТекущийУпакЛист", ТекущийУпаковочныйЛист);
		Иначе
			ЗапросДанныхПриемка.УстановитьПараметр("ТекущийУпакЛист", Pack);		
		КонецЕсли;
		
		ТЗСобранныеДанныеПриемка  = ЗапросДанныхПриемка.Выполнить().Выгрузить();
		ТЗСобранныеДанныеПриемка.Колонки.Добавить("КоличествоСтрок", Новый ОписаниеТипов("Число"));
		Для каждого строка Из ТЗСобранныеДанныеПриемка Цикл
			Если строка.Количество > 0 Тогда
				строка.КоличествоСтрок = 1;
			ИначеЕсли строка.Количество < 0 Тогда
				строка.КоличествоСтрок = -1;
			КонецЕсли;			
		КонецЦикла;	
		ТЗСобранныеДанныеПриемка.Свернуть("Номенклатура,ХарактеристикаНоменклатуры,НазваниеТовара,ЕдиницаИзмерения,ЯчейкаСсылка,СерийныйНомер,ШтрихКод,УпаковочныйЛист","Количество,КоличествоСтрок");
		
		СтруктураПоиска = Новый Структура("ТипОперации", "Печать упаковочного листа");
		
		СтрокиРеквизитов = УзелПО.Печать.НайтиСтроки(СтруктураПоиска);
		Если СтрокиРеквизитов.Количество() = 0 Тогда		
			СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указан шаблон печати упак. листа. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;		
		
		ЗаписьXML = Новый ЗаписьXML;
		
		Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
			ИмяФайла = ПолучитьНовоеИмяФайла();	
			Попытка
				ЗаписьXML.ОткрытьФайл(КаталогСохранения + ИмяФайла + ".xml", "UTF-8");
			Исключение			
				СтруктураОтвета.Вставить("Описание", "Не удалось сохранить файл печати в каталоге: " + КаталогСохранения + " по причине: " + ОписаниеОшибки());			
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецПопытки;
		Иначе
			ЗаписьXML.УстановитьСтроку("UTF-8");
		КонецЕсли;
		
		Если СсылкаНаДок.Шаблон.ИспользоватьМаркировку Тогда		
			ТекущийУпаковочныйЛист = Pack;
			ТекущийУпаковочныйЛист = СтрЗаменить(ТекущийУпаковочныйЛист, "[", "(");
			ТекущийУпаковочныйЛист = СтрЗаменить(ТекущийУпаковочныйЛист, "]", ")");	
			
			ОписаниеОшибки = "";
			ВыполнитьПечатьШтрихкодаКороба(УзелПО, СтрокиРеквизитов, ЗаписьXML, ТекущийУпаковочныйЛист, ТЗСобранныеДанныеПодбор, ОписаниеОшибки);		
			
			Если ОписаниеОшибки <> "" Тогда
				СтруктураОтвета.Вставить("Описание", ОписаниеОшибки);			
				Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			КонецЕсли;
			
			СтруктураОтвета.Вставить("is_success", Истина);		
			Возврат ПодготовитьОтветJSON(СтруктураОтвета);	
		КонецЕсли;
		
		ЗаписьXML.ЗаписатьОбъявлениеXML();	
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("PrintData");
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("PrinterName");
		ЗаписьXML.ЗаписатьТекст(СтрокиРеквизитов[0].ИмяПринтера);
		ЗаписьXML.ЗаписатьКонецЭлемента();		
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("TemplateName");
		ЗаписьXML.ЗаписатьТекст(СтрокиРеквизитов[0].ИмяШаблона);
		ЗаписьXML.ЗаписатьКонецЭлемента();		
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Count");
		ЗаписьXML.ЗаписатьТекст(Строка(СтрокиРеквизитов[0].КоличествоКопий));
		ЗаписьXML.ЗаписатьКонецЭлемента();		
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Head");
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Client");
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СсылкаНаДок.Клиент));
		ЗаписьXML.ЗаписатьКонецЭлемента();//Client	
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Date");
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СсылкаНаДок.Дата));
		ЗаписьXML.ЗаписатьКонецЭлемента();//Date	
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Number");
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СсылкаНаДок.Номер));
		ЗаписьXML.ЗаписатьКонецЭлемента();//Number  
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Comment");
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СсылкаНаДок.Комментарий));
		ЗаписьXML.ЗаписатьКонецЭлемента();//Comment	
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Barcode");
		Если Лев(ТекущийУпаковочныйЛист,4) = "(00)" тогда
			ТекущийУпаковочныйЛистШтрихкод= "00"+Сред(ТекущийУпаковочныйЛист,5);
		Иначе	
			ТекущийУпаковочныйЛистШтрихкод = ТекущийУпаковочныйЛист;
		КонецЕсли;	 
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(ТекущийУпаковочныйЛистШтрихкод));
		ЗаписьXML.ЗаписатьКонецЭлемента();//Barcode
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Pack"); 
		Если Лев(ТекущийУпаковочныйЛист,3) = "UPL" тогда
			ТекущийУпаковочныйЛистНаименование= Сред(ТекущийУпаковочныйЛист,4);
		Иначе	
			ТекущийУпаковочныйЛистНаименование = ТекущийУпаковочныйЛист;
		КонецЕсли;	 
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(ТекущийУпаковочныйЛистНаименование));
		ЗаписьXML.ЗаписатьКонецЭлемента();//Barcode
		
		QRData = "";
		Для каждого СтрокаТЧ Из ТЗСобранныеДанныеПодбор Цикл	
			QRData = QRData + ЧистаяСтрока(СтрокаТЧ.Штрихкод) + "\r\n";
		КонецЦикла;
		
		Для каждого СтрокаТЧ Из ТЗСобранныеДанныеПриемка Цикл
			QRData = QRData + ЧистаяСтрока(СтрокаТЧ.Штрихкод) + "\r\n";
		КонецЦикла;
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("QRData");
		ЗаписьXML.ЗаписатьТекст(QRData);
		ЗаписьXML.ЗаписатьКонецЭлемента();//BC>	
		
		ЗаписьXML.ЗаписатьКонецЭлемента();//Head
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Detail");
		
		ИтогоТоваров = 0;
		ИтогоМест = 0;
		
		Для каждого СтрокаТЧ Из ТЗСобранныеДанныеПодбор Цикл
			Если СтрокаТЧ.Количество = 0 Тогда
				Продолжить;
			КонецЕсли;	
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Item");
			
			ИтогоТоваров = ИтогоТоваров + СтрокаТЧ.Количество * ?(СтрокаТЧ.ЕдиницаИзмерения.Числитель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Числитель);
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ArtName");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.НазваниеТовара));
			ЗаписьXML.ЗаписатьКонецЭлемента();//ArtName
			ЗаписьXML.ЗаписатьНачалоЭлемента("Barcode");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.ШтрихКод));
			ЗаписьXML.ЗаписатьКонецЭлемента();//Barcode 
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("QNT");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Количество * ?(СтрокаТЧ.ЕдиницаИзмерения.Числитель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Числитель)));
			ЗаписьXML.ЗаписатьКонецЭлемента();//QNT 
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("QNTPack");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Количество));
			ЗаписьXML.ЗаписатьКонецЭлемента();//QNTPack
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Unit");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.ЕдиницаИзмерения.Наименование));
			ЗаписьXML.ЗаписатьКонецЭлемента();//QNTPack 
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("SN");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.СерийныйНомер));
			ЗаписьXML.ЗаписатьКонецЭлемента();//SN
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("QNTRows");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.КоличествоСтрок));
			ЗаписьXML.ЗаписатьКонецЭлемента();//QNTPack
			
			ИтогоМест = ИтогоМест + СтрокаТЧ.КоличествоСтрок;
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//Item		
		КонецЦикла;
		
		Для каждого СтрокаТЧ Из ТЗСобранныеДанныеПриемка Цикл
			Если СтрокаТЧ.Количество = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Item");
			
			ИтогоТоваров = ИтогоТоваров + СтрокаТЧ.Количество * ?(СтрокаТЧ.ЕдиницаИзмерения.Числитель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Числитель);
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ArtName");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.НазваниеТовара));
			ЗаписьXML.ЗаписатьКонецЭлемента();//Param1
			ЗаписьXML.ЗаписатьНачалоЭлемента("Barcode");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.ШтрихКод));
			ЗаписьXML.ЗаписатьКонецЭлемента();//Param2              
			ЗаписьXML.ЗаписатьНачалоЭлемента("QNT");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Количество * ?(СтрокаТЧ.ЕдиницаИзмерения.Числитель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Числитель)));
			ЗаписьXML.ЗаписатьКонецЭлемента();//Param3  
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("QNTPack");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Количество));
			ЗаписьXML.ЗаписатьКонецЭлемента();//QNTPack
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Unit");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.ЕдиницаИзмерения.Наименование));
			ЗаписьXML.ЗаписатьКонецЭлемента();//Unit 
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("SN");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.СерийныйНомер));
			ЗаписьXML.ЗаписатьКонецЭлемента();//SN
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("QNTRows");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.КоличествоСтрок));
			ЗаписьXML.ЗаписатьКонецЭлемента();//QNTPack
			
			ИтогоМест = ИтогоМест + СтрокаТЧ.КоличествоСтрок;
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//Item		
		КонецЦикла;
		
		ЗаписьXML.ЗаписатьКонецЭлемента();//Detail
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Summary");
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Summ"); 
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(ИтогоТоваров));			
		ЗаписьXML.ЗаписатьКонецЭлемента();//Summ
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("SummRows"); 
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(ИтогоМест));			
		ЗаписьXML.ЗаписатьКонецЭлемента();//SummRows 
		
		ЗаписьXML.ЗаписатьКонецЭлемента();//Summary
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Footer");
		
		Год = Строка(Формат(Год(ТекущаяДата()),"ЧГ="));
		Месяц = Строка(Месяц(ТекущаяДата()));
		День = Строка(День(ТекущаяДата()));
		ДатаСтрока = Год + Строка(Месяц) + Строка(День);
		ЗаписьXML.ЗаписатьНачалоЭлемента("Date");	
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(Год + Месяц + День));
		ЗаписьXML.ЗаписатьКонецЭлемента();//Date
		ЗаписьXML.ЗаписатьНачалоЭлемента("User");	
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(UserName));
		ЗаписьXML.ЗаписатьКонецЭлемента();//User
		ЗаписьXML.ЗаписатьКонецЭлемента();//Footer
		
		ЗаписьXML.ЗаписатьКонецЭлемента();//PrintData
		
		ОписаниеОшибки = "";
		Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
			ЗаписьXML.Закрыть();
		Иначе
			СтрокаДляЗапроса = ЗаписьXML.Закрыть();
			ОтправитьДанныеНаПринтсервер(УзелПО, СтрокаДляЗапроса, ОписаниеОшибки);
		КонецЕсли;
		
		Если ОписаниеОшибки <> "" Тогда
			СтруктураОтвета.Вставить("Описание", ОписаниеОшибки);			
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
		
		СтруктураОтвета.Вставить("is_success", Истина);
		
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	КонецЕсли;
	
КонецФункции

// Печать документа.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocID - Строка - Id документа ТСД.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция SendDocToPrint(SN, UserName, DocID) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если УзелПО.ОнлайнСвязьСПринтсервером Тогда	
		АдресПринтсервера = УзелПО.АдресПринтсервера;
		ПортПринтсервера = УзелПО.ПортПринтсервера;
		Если АдресПринтсервера = "" Или ПортПринтсервера = 0 Тогда	
			СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указаны настройки онлайн связи с принтсервером. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	Иначе	
		КаталогСохранения = УзелПО.КаталогВыгрузкиФайлаПечати;
		Если КаталогСохранения = "" Тогда		
			СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указан каталог сохранения файлов печати. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocID, 5));
	Исключение
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;		
	
	СтруктураПоиска = Новый Структура("ТипОперации", "Печать документа");
	
	СтрокиРеквизитов = УзелПО.Печать.НайтиСтроки(СтруктураПоиска);
	Если СтрокиРеквизитов.Количество() = 0 Тогда
		СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указан шаблон печати документа. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	
	
	ЗаписьXML = Новый ЗаписьXML;
	
	Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
		ИмяФайла = ПолучитьНовоеИмяФайла();	
		Попытка
			ЗаписьXML.ОткрытьФайл(КаталогСохранения + ИмяФайла + ".xml", "UTF-8");
		Исключение			
			СтруктураОтвета.Вставить("Описание", "Не удалось сохранить файл печати в каталоге: " + КаталогСохранения + " по причине: " + ОписаниеОшибки());		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецПопытки;
	Иначе
		ЗаписьXML.УстановитьСтроку("UTF-8");
	КонецЕсли;
		
	ЗаписьXML.ЗаписатьОбъявлениеXML();	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("PrintData");
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("PrinterName");
	ЗаписьXML.ЗаписатьТекст(СтрокиРеквизитов[0].ИмяПринтера);
	ЗаписьXML.ЗаписатьКонецЭлемента();		
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("TemplateName");
	ЗаписьXML.ЗаписатьТекст(СтрокиРеквизитов[0].ИмяШаблона);
	ЗаписьXML.ЗаписатьКонецЭлемента();		
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Count");
	ЗаписьXML.ЗаписатьТекст(Строка(СтрокиРеквизитов[0].КоличествоКопий));
	ЗаписьXML.ЗаписатьКонецЭлемента();		
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Head");
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Client");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СсылкаНаДок.Клиент));
	ЗаписьXML.ЗаписатьКонецЭлемента();//Client	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Date");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СсылкаНаДок.Дата));
	ЗаписьXML.ЗаписатьКонецЭлемента();//Date
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Number");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СсылкаНаДок.Номер));
	ЗаписьXML.ЗаписатьКонецЭлемента();//Number

	ЗаписьXML.ЗаписатьНачалоЭлемента("Comment");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СсылкаНаДок.Комментарий));
	ЗаписьXML.ЗаписатьКонецЭлемента();//Comment	

	Попытка
		DocNumber = СсылкаНаДок.ИсходныйДокумент.Номер;
	Исключение
		DocNumber = "";
	КонецПопытки;
	ЗаписьXML.ЗаписатьНачалоЭлемента("DocNumber");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(DocNumber));
	ЗаписьXML.ЗаписатьКонецЭлемента();//DocNumber
	
	Попытка
		DocDate = СсылкаНаДок.ИсходныйДокумент.Дата;
	Исключение
		DocDate = "";
	КонецПопытки;
	ЗаписьXML.ЗаписатьНачалоЭлемента("DocDate");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(DocDate));
	ЗаписьXML.ЗаписатьКонецЭлемента();//DocDate
	
	Попытка
		DocBarcode = ЧисловойКодПоСсылке(СсылкаНаДок.ИсходныйДокумент);
	Исключение
		DocBarcode = "";
	КонецПопытки;
	ЗаписьXML.ЗаписатьНачалоЭлемента("DocBarcode");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(DocBarcode));
	ЗаписьXML.ЗаписатьКонецЭлемента();//DocBarcode
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("TSD");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(УзелПО));
	ЗаписьXML.ЗаписатьКонецЭлемента();//TSD
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("User");	
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(UserName));
	ЗаписьXML.ЗаписатьКонецЭлемента();//User
	
	ЗаписьXML.ЗаписатьКонецЭлемента();//Head
	
	Если СтрНайти(СтрокиРеквизитов[0].ИмяШаблона,"_difference") = 0 Тогда
		
		//ПЕЧАТЬ ТИПОВОЙ ДЕТАЛИЗАЦИИ ДАННЫХ ПОДБОРА
		
		ЗапросДанныхПодбор = Новый Запрос();
		ЗапросДанныхПодбор.Текст = "ВЫБРАТЬ
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ИдентификаторСтроки,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Номенклатура,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ХарактеристикаНоменклатуры,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.НазваниеТовара,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ЕдиницаИзмерения,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ЯчейкаСсылка,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.СерийныйНомер,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ШтрихКод,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Количество
		|ИЗ
		|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор
		|ГДЕ
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Ссылка = &СсылкаНаДок						 
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ИдентификаторСтроки,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ХарактеристикаНоменклатуры,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.НазваниеТовара,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ЕдиницаИзмерения,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ЯчейкаСсылка,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.СерийныйНомер,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Штрихкод,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Количество
		|ИЗ
		|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ДатаМобайл_СтрокиГрупповыхДокументов
		|ГДЕ
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД = &СсылкаНаДок
		|	И НЕ ДатаМобайл_СтрокиГрупповыхДокументов.ДляОбмена
		|	И ДатаМобайл_СтрокиГрупповыхДокументов.ИмяТаблицы = &ИмяТаблицы";
		
		ЗапросДанныхПодбор.УстановитьПараметр("СсылкаНаДок", СсылкаНаДок);		
		ЗапросДанныхПодбор.УстановитьПараметр("ИмяТаблицы", "Select");
		
		ТЗСобранныеДанныеПодбор = ЗапросДанныхПодбор.Выполнить().Выгрузить();
		ТЗСобранныеДанныеПодбор.Колонки.Добавить("КоличествоСтрок", Новый ОписаниеТипов("Число"));
		Для каждого строка Из ТЗСобранныеДанныеПодбор Цикл
			Если строка.Количество > 0 Тогда
				строка.КоличествоСтрок = 1;
			ИначеЕсли строка.Количество < 0 Тогда
				строка.КоличествоСтрок = -1;
			КонецЕсли;			
		КонецЦикла;	
		ТЗСобранныеДанныеПодбор.Свернуть("Номенклатура,ХарактеристикаНоменклатуры,НазваниеТовара,ЕдиницаИзмерения,ЯчейкаСсылка,СерийныйНомер,ШтрихКод,УпаковочныйЛист","Количество,КоличествоСтрок");
		
		ЗапросДанныхПриемка = Новый Запрос();
		ЗапросДанныхПриемка.Текст = "ВЫБРАТЬ
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.ИдентификаторСтроки,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.Номенклатура,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.ХарактеристикаНоменклатуры,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.НазваниеТовара,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.ЕдиницаИзмерения,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.ЯчейкаСсылка,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.СерийныйНомер,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.ШтрихКод,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.УпаковочныйЛист,
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.Количество
		|ИЗ
		|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПриемка КАК ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка
		|ГДЕ
		|	ДатаМобайл_ДокументыТСДСобранныеДанныеПриемка.Ссылка = &СсылкаНаДок
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ИдентификаторСтроки,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ХарактеристикаНоменклатуры,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.НазваниеТовара,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ЕдиницаИзмерения,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ЯчейкаСсылка,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.СерийныйНомер,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Штрихкод,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист,
		|	ДатаМобайл_СтрокиГрупповыхДокументов.Количество
		|ИЗ
		|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ДатаМобайл_СтрокиГрупповыхДокументов
		|ГДЕ
		|	ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД = &СсылкаНаДок
		|	И НЕ ДатаМобайл_СтрокиГрупповыхДокументов.ДляОбмена
		|	И ДатаМобайл_СтрокиГрупповыхДокументов.ИмяТаблицы = &ИмяТаблицы";
		
		ЗапросДанныхПриемка.УстановитьПараметр("СсылкаНаДок", СсылкаНаДок);
		ЗапросДанныхПриемка.УстановитьПараметр("ИмяТаблицы", "Insert");
		
		ТЗСобранныеДанныеПриемка = ЗапросДанныхПриемка.Выполнить().Выгрузить();
		ТЗСобранныеДанныеПриемка.Колонки.Добавить("КоличествоСтрок", Новый ОписаниеТипов("Число"));
		Для каждого строка Из ТЗСобранныеДанныеПриемка Цикл
			Если строка.Количество > 0 Тогда
				строка.КоличествоСтрок = 1;
			ИначеЕсли строка.Количество < 0 Тогда
				строка.КоличествоСтрок = -1;
			КонецЕсли;			
		КонецЦикла;	
		ТЗСобранныеДанныеПриемка.Свернуть("Номенклатура,ХарактеристикаНоменклатуры,НазваниеТовара,ЕдиницаИзмерения,ЯчейкаСсылка,СерийныйНомер,ШтрихКод,УпаковочныйЛист","Количество,КоличествоСтрок");
					
		ЗаписьXML.ЗаписатьНачалоЭлемента("Detail");
		
		ИтогоТоваров = 0;
		Для каждого СтрокаТЧ Из ТЗСобранныеДанныеПодбор Цикл
			ЗаписьXML.ЗаписатьНачалоЭлемента("Item");
			
			ИтогоТоваров = ИтогоТоваров + СтрокаТЧ.Количество * ?(СтрокаТЧ.ЕдиницаИзмерения.Числитель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Числитель);
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ArtName");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.НазваниеТовара));
			ЗаписьXML.ЗаписатьКонецЭлемента();//ArtName
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Barcode");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.ШтрихКод));
			ЗаписьXML.ЗаписатьКонецЭлемента();//Barcode  
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("QNT");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Количество * ?(СтрокаТЧ.ЕдиницаИзмерения.Числитель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Числитель)));
			ЗаписьXML.ЗаписатьКонецЭлемента();//QNT 
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("QNTPack");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Количество));
			ЗаписьXML.ЗаписатьКонецЭлемента();//QNTPack
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Unit");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.ЕдиницаИзмерения.Наименование));
			ЗаписьXML.ЗаписатьКонецЭлемента();//Unit 
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("SN");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.СерийныйНомер));
			ЗаписьXML.ЗаписатьКонецЭлемента();//SN
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Pack");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрЗаменить(СтрокаТЧ.УпаковочныйЛист, "/////", "")));
			ЗаписьXML.ЗаписатьКонецЭлемента();//Pack
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//Item
		КонецЦикла;
		
		Для каждого СтрокаТЧ Из ТЗСобранныеДанныеПриемка Цикл
			ЗаписьXML.ЗаписатьНачалоЭлемента("Item");
			
			ИтогоТоваров = ИтогоТоваров + СтрокаТЧ.Количество * ?(СтрокаТЧ.ЕдиницаИзмерения.Числитель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Числитель);
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("ArtName");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.НазваниеТовара));
			ЗаписьXML.ЗаписатьКонецЭлемента();//ArtName
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Barcode");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.ШтрихКод));
			ЗаписьXML.ЗаписатьКонецЭлемента();//Barcode  
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("QNT");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Количество * ?(СтрокаТЧ.ЕдиницаИзмерения.Числитель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Числитель)));
			ЗаписьXML.ЗаписатьКонецЭлемента();//QNT  
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("QNTPack");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Количество));
			ЗаписьXML.ЗаписатьКонецЭлемента();//QNTPack
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Unit");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.ЕдиницаИзмерения.Наименование));
			ЗаписьXML.ЗаписатьКонецЭлемента();//Unit 
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("SN");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.СерийныйНомер));
			ЗаписьXML.ЗаписатьКонецЭлемента();//SN
			
			ЗаписьXML.ЗаписатьНачалоЭлемента("Pack");
			ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрЗаменить(СтрокаТЧ.УпаковочныйЛист, "/////", "")));
			ЗаписьXML.ЗаписатьКонецЭлемента();//Pack
			
			ЗаписьXML.ЗаписатьКонецЭлемента();//Item
		КонецЦикла;
		
		ЗаписьXML.ЗаписатьКонецЭлемента();//Detail		
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Summary");
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Itog");
		ЗаписьXML.ЗаписатьТекст("Итого:");
		ЗаписьXML.ЗаписатьКонецЭлемента();//Itog
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Summ"); 
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(ИтогоТоваров));			
		ЗаписьXML.ЗаписатьКонецЭлемента();//Summ 
		
		ЗаписьXML.ЗаписатьКонецЭлемента();//Summary
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Footer");
		
		QRData = "";
		Для каждого СтрокаТЧ Из ТЗСобранныеДанныеПодбор Цикл
			Если ЗначениеЗаполнено(СтрокаТЧ.Штрихкод) Тогда
				QRData = QRData + ЧистаяСтрока(СтрокаТЧ.Штрихкод) + "\r\n";
			КонецЕсли;	
		КонецЦикла;
		
		Для каждого СтрокаТЧ Из ТЗСобранныеДанныеПриемка Цикл
			Если ЗначениеЗаполнено(СтрокаТЧ.Штрихкод) Тогда
				QRData = QRData + ЧистаяСтрока(СтрокаТЧ.Штрихкод) + "\r\n";
			КонецЕсли;	
		КонецЦикла;
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("QRData");
		ЗаписьXML.ЗаписатьТекст(QRData);
		ЗаписьXML.ЗаписатьКонецЭлемента();//QRData	
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Date");	
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(Формат(ТекущаяДата(), "ДФ='dd.MM.yyyy HH:mm:ss'")));
		ЗаписьXML.ЗаписатьКонецЭлемента();//Date
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("User");	
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(UserName));
		ЗаписьXML.ЗаписатьКонецЭлемента();//User
		
		ЗаписьXML.ЗаписатьКонецЭлемента();//Footer		
		
	Иначе
		
		//ПЕЧАТЬ ДЕТАЛИЗАЦИИ РАСХОЖДЕНИЙ ДАННЫХ ПОДБОРА С ДАННЫМИ ИСХОДНОГО ДОКУМЕНТА
		
		Если Не ЗначениеЗаполнено(СсылкаНаДок.ИсходныйДокумент) Тогда
			СтруктураОтвета.Вставить("Описание", "Не выбран исходный документ для документа ТСД, печать расхождений невозможна. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
		
		ТаблицаАнализа = Обработки.ДатаМобайл_АРМДиспетчера.ПолучитьТЧДокумента(СсылкаНаДок); 	
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Detail");
		
		Для каждого СтрокаТЧ Из ТаблицаАнализа Цикл
			Если СтрокаТЧ.План <> СтрокаТЧ.Факт Тогда
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("Item");
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ArtArticle");
				Попытка ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Номенклатура.Артикул)); Исключение ЗаписьXML.ЗаписатьТекст(""); КонецПопытки;
				ЗаписьXML.ЗаписатьКонецЭлемента();//ArtArticle
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("ArtName");
				ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(""+СтрокаТЧ.Номенклатура + " " + СтрокаТЧ.ХарактеристикаНоменклатуры));
				ЗаписьXML.ЗаписатьКонецЭлемента();//ArtName
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("QNTplan");
				ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.План));
				ЗаписьXML.ЗаписатьКонецЭлемента();//QNTplan
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("QNTfact");
				ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Факт));
				ЗаписьXML.ЗаписатьКонецЭлемента();//QNTfact
				
				ЗаписьXML.ЗаписатьНачалоЭлемента("QNTdifference");
				ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Расхождения));
				ЗаписьXML.ЗаписатьКонецЭлемента();//QNTdifference
				
				ЗаписьXML.ЗаписатьКонецЭлемента();//Item
			КонецЕсли;
		КонецЦикла;
		
		ЗаписьXML.ЗаписатьКонецЭлемента();//Detail
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Summary");
		ЗаписьXML.ЗаписатьКонецЭлемента();//Summary
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("Footer");
		ЗаписьXML.ЗаписатьКонецЭлемента();//Footer	
	КонецЕсли;
	
	ЗаписьXML.ЗаписатьКонецЭлемента();//PrintData
	
	ОписаниеОшибки = "";
	Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
		ЗаписьXML.Закрыть();
	Иначе
		СтрокаДляЗапроса = ЗаписьXML.Закрыть();
		ОтправитьДанныеНаПринтсервер(УзелПО, СтрокаДляЗапроса, ОписаниеОшибки);
	КонецЕсли;
	
	Если ОписаниеОшибки <> "" Тогда
		СтруктураОтвета.Вставить("Описание", ОписаниеОшибки);			
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

#КонецОбласти

#Область FastAccess

// Получение данных товара в операции "Быстрый доступ".
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// Barcode - Строка - ШК.
// Params - Структура - Структура данных.
// ИмяМетода - Строка - Имя метода.
// ВерсияПО - Строка - Версия ПО.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция FastAccess(SN, UserName, Barcode, Params = Неопределено, ИмяМетода = "", ВерсияПО = "") Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если УзелПО.НеОтображатьОстатки Тогда		
		СтруктураОтвета.Вставить("Описание", "Отображение информации для ТСД отключено в настройках АРМ");		
		Возврат ПодготовитьОтветJSON(,СтруктураОтвета);		
	КонецЕсли;
	
	Если Лев(ВерсияПО,1) = "3" Тогда	
		Если ИмяМетода = "/text" Тогда
			Возврат ПолучитьИнфоTEXT(УзелПО, Barcode);
		ИначеЕсли ИмяМетода = "/url" Тогда
			Возврат ПолучитьИнфоURL(УзелПО, Barcode);
		ИначеЕсли ИмяМетода = "/html" Тогда
			Возврат ПолучитьИнфоHTML(УзелПО, Barcode);
		Иначе
			Возврат ПолучитьИнфоJSON(УзелПО, Barcode);	
		КонецЕсли;
	Иначе	
		Возврат ПолучитьИнфо(УзелПО, Barcode);
	КонецЕсли;
	
КонецФункции

// Получение данных документа в операции "Быстрый доступ".
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocID - Строка - Id документа ТСД.
// Barcode - Строка - ШК.
// Params - Структура - Структура данных.
// ИмяМетода - Строка - Имя метода.
// ВерсияПО - Строка - Версия ПО.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция FastAccessDoc(SN, UserName, DocID, Barcode, Params = Неопределено, ИмяМетода = "", ВерсияПО = "") Экспорт
	
	СтруктураОтвета = Новый Структура;
	
	Если Barcode = "" Тогда		
		СтруктураОтвета.Вставить("Описание", "Отсканируйте штрихкод "); 
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	Иначе
		Возврат FastAccess(SN, UserName, Barcode, Params, ИмяМетода, ВерсияПО);
	КонецЕсли;
	
КонецФункции

// Получение данных товара по серийному номеру в операции "Быстрый доступ".
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// Barcode - Строка - ШК.
// Params - Структура - Структура данных.
// ИмяМетода - Строка - Имя метода.
// ВерсияПО - Строка - Версия ПО.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция FastAccessSerialNumber(SN, UserName, Barcode, Params = Неопределено, ИмяМетода = "", ВерсияПО = "") Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если УзелПО.НеОтображатьОстатки Тогда		
		СтруктураОтвета.Вставить("Описание", "Отображение информации для ТСД отключено в настройках АРМ");		
		Возврат ПодготовитьОтветJSON(,СтруктураОтвета);		
	КонецЕсли;
	
	МассивОтвета = Новый Массив;
	
	СтрокаВозврата = "";
	
	ВключатьАртикул = УзелПО.ДобавлятьАртикулВНаименование;
	
	//Сначала ищем серию...	
	ТекущаяСерия = ДатаМобайл_ОбщийМодуль.ПолучитьСерию(Barcode);
	
	Если Не ЗначениеЗаполнено(ТекущаяСерия) Тогда
		Возврат ПодготовитьОтветJSON("По серии данных не найдено...",, "text");	
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Серия", ТекущаяСерия);
	Запрос.УстановитьПараметр("ЕдиницыКоличества", 0);
	Запрос.УстановитьПараметр("ТипПолучателяПодразделение", "");
	Запрос.УстановитьПараметр("ТипПолучателяПокупатель", "");
	Запрос.УстановитьПараметр("ТипПолучателяСклад", "");
	Запрос.Текст = "ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Ссылка,
	|	ВидыНоменклатурыПолитикиУчетаСерий.Склад КАК Склад
	|ПОМЕСТИТЬ НоменклатураПоКоторойНеВедутсяОстатки
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыНоменклатуры.ПолитикиУчетаСерий КАК ВидыНоменклатурыПолитикиУчетаСерий
	|		ПО (ВидыНоменклатурыПолитикиУчетаСерий.Ссылка = Номенклатура.ВидНоменклатуры)
	|ГДЕ
	|	ВидыНоменклатурыПолитикиУчетаСерий.ПолитикаУчетаСерий.ТипПолитики В (ЗНАЧЕНИЕ(Перечисление.ТипыПолитикУказанияСерий.СправочноеУказаниеСерий), ЗНАЧЕНИЕ(Перечисление.ТипыПолитикУказанияСерий.АвторасчетПоFEFOОстатковСерий))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТоварыНаСкладах.Номенклатура КАК Номенклатура,
	|	ТоварыНаСкладах.Характеристика КАК Характеристика,
	|	ТоварыНаСкладах.Серия КАК Серия,
	|	ТоварыНаСкладах.Склад КАК Получатель,
	|	ТоварыНаСкладах.Помещение КАК Помещение,
	|	ВЫБОР
	|		КОГДА &ЕдиницыКоличества = 0
	|			ТОГДА ТоварыНаСкладах.ВНаличииНачальныйОстаток
	|		КОГДА &ЕдиницыКоличества = 1
	|			ТОГДА ВЫБОР
	|					КОГДА ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|						ТОГДА ТоварыНаСкладах.ВНаличииНачальныйОстаток / ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|	КОНЕЦ КАК ОстатокНачальный,
	|	ВЫБОР
	|		КОГДА &ЕдиницыКоличества = 0
	|			ТОГДА ТоварыНаСкладах.ВНаличииПриход
	|		КОГДА &ЕдиницыКоличества = 1
	|			ТОГДА ВЫБОР
	|					КОГДА ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|						ТОГДА ТоварыНаСкладах.ВНаличииПриход / ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|	КОНЕЦ КАК Приход,
	|	ВЫБОР
	|		КОГДА &ЕдиницыКоличества = 0
	|			ТОГДА ТоварыНаСкладах.ВНаличииРасход
	|		КОГДА &ЕдиницыКоличества = 1
	|			ТОГДА ВЫБОР
	|					КОГДА ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|						ТОГДА ТоварыНаСкладах.ВНаличииРасход / ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|	КОНЕЦ КАК Расход,
	|	ВЫБОР
	|		КОГДА &ЕдиницыКоличества = 0
	|			ТОГДА ТоварыНаСкладах.ВНаличииКонечныйОстаток
	|		КОГДА &ЕдиницыКоличества = 1
	|			ТОГДА ВЫБОР
	|					КОГДА ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|						ТОГДА ТоварыНаСкладах.ВНаличииКонечныйОстаток / ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|	КОНЕЦ КАК Остаток,
	|	&ТипПолучателяСклад КАК ТипПолучателя,
	|	ИСТИНА КАК ОстаткиДоступны
	|ПОМЕСТИТЬ ВТ_ТоварыССериями
	|{ВЫБРАТЬ
	|	Номенклатура.*,
	|	Характеристика.*,
	|	Серия.*,
	|	Получатель.*,
	|	Помещение.*,
	|	ОстатокНачальный,
	|	Приход,
	|	Расход,
	|	Остаток,
	|	ТипПолучателя,
	|	ОстаткиДоступны}
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.ОстаткиИОбороты(
	|			,
	|			,
	|			Авто,
	|			,
	|			Серия <> ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
	|				И (Серия = &Серия
	|					ИЛИ &Серия = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
	|					ИЛИ &Серия = НЕОПРЕДЕЛЕНО)) КАК ТоварыНаСкладах
	|{ГДЕ
	|	ТоварыНаСкладах.Номенклатура.* КАК Номенклатура,
	|	ТоварыНаСкладах.Характеристика.* КАК Характеристика,
	|	ТоварыНаСкладах.Серия.* КАК Серия,
	|	ТоварыНаСкладах.Склад.* КАК Получатель,
	|	ТоварыНаСкладах.Помещение.* КАК Помещение,
	|	(ВЫБОР
	|			КОГДА &ЕдиницыКоличества = 0
	|				ТОГДА ТоварыНаСкладах.ВНаличииНачальныйОстаток
	|			КОГДА &ЕдиницыКоличества = 1
	|				ТОГДА ВЫБОР
	|						КОГДА ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|							ТОГДА ТоварыНаСкладах.ВНаличииНачальныйОстаток / ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|						ИНАЧЕ 0
	|					КОНЕЦ
	|		КОНЕЦ) КАК ОстатокНачальный,
	|	(ВЫБОР
	|			КОГДА &ЕдиницыКоличества = 0
	|				ТОГДА ТоварыНаСкладах.ВНаличииПриход
	|			КОГДА &ЕдиницыКоличества = 1
	|				ТОГДА ВЫБОР
	|						КОГДА ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|							ТОГДА ТоварыНаСкладах.ВНаличииПриход / ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|						ИНАЧЕ 0
	|					КОНЕЦ
	|		КОНЕЦ) КАК Приход,
	|	(ВЫБОР
	|			КОГДА &ЕдиницыКоличества = 0
	|				ТОГДА ТоварыНаСкладах.ВНаличииРасход
	|			КОГДА &ЕдиницыКоличества = 1
	|				ТОГДА ВЫБОР
	|						КОГДА ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|							ТОГДА ТоварыНаСкладах.ВНаличииРасход / ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|						ИНАЧЕ 0
	|					КОНЕЦ
	|		КОНЕЦ) КАК Расход,
	|	(ВЫБОР
	|			КОГДА &ЕдиницыКоличества = 0
	|				ТОГДА ТоварыНаСкладах.ВНаличииКонечныйОстаток
	|			КОГДА &ЕдиницыКоличества = 1
	|				ТОГДА ВЫБОР
	|						КОГДА ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|							ТОГДА ТоварыНаСкладах.ВНаличииКонечныйОстаток / ТоварыНаСкладах.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|						ИНАЧЕ 0
	|					КОНЕЦ
	|		КОНЕЦ) КАК Остаток,
	|	(&ТипПолучателяСклад) КАК ТипПолучателя,
	|	(ИСТИНА) КАК ОстаткиДоступны}
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДвиженияСерийТоваров.Номенклатура,
	|	ДвиженияСерийТоваров.Характеристика,
	|	ДвиженияСерийТоваров.Серия,
	|	ДвиженияСерийТоваров.Получатель,
	|	ДвиженияСерийТоваров.ПомещениеПолучателя,
	|	0,
	|	ВЫБОР
	|		КОГДА &ЕдиницыКоличества = 0
	|			ТОГДА ДвиженияСерийТоваров.КоличествоОборот
	|		КОГДА &ЕдиницыКоличества = 1
	|			ТОГДА ВЫБОР
	|					КОГДА ДвиженияСерийТоваров.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|						ТОГДА ДвиженияСерийТоваров.КоличествоОборот / ДвиженияСерийТоваров.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|	КОНЕЦ,
	|	0,
	|	0,
	|	ВЫБОР
	|		КОГДА ДвиженияСерийТоваров.Получатель ССЫЛКА Справочник.СтруктураПредприятия
	|			ТОГДА &ТипПолучателяПодразделение
	|		КОГДА ДвиженияСерийТоваров.Получатель ССЫЛКА Справочник.Партнеры
	|			ТОГДА &ТипПолучателяПокупатель
	|		ИНАЧЕ &ТипПолучателяСклад
	|	КОНЕЦ,
	|	ЛОЖЬ
	|ИЗ
	|	РегистрНакопления.ДвиженияСерийТоваров.Обороты(
	|			,
	|			,
	|			Авто,
	|			ЭтоСкладскоеДвижение
	|				И Серия <> ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
	|				И (Серия = &Серия
	|					ИЛИ &Серия = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
	|					ИЛИ &Серия = НЕОПРЕДЕЛЕНО)
	|				И ((Номенклатура, Получатель) В
	|						(ВЫБРАТЬ
	|							НоменклатураПоКоторойНеВедутсяОстатки.Ссылка,
	|							НоменклатураПоКоторойНеВедутсяОстатки.Склад
	|						ИЗ
	|							НоменклатураПоКоторойНеВедутсяОстатки)
	|					ИЛИ Получатель ССЫЛКА Справочник.Партнеры
	|						И СкладскаяОперация В (ЗНАЧЕНИЕ(Перечисление.СкладскиеОперации.ОтгрузкаКлиенту), ЗНАЧЕНИЕ(Перечисление.СкладскиеОперации.ОтгрузкаВРозницу)))) КАК ДвиженияСерийТоваров
	|{ГДЕ
	|	ДвиженияСерийТоваров.Номенклатура.* КАК Номенклатура,
	|	ДвиженияСерийТоваров.Характеристика.* КАК Характеристика,
	|	ДвиженияСерийТоваров.Серия.* КАК Серия,
	|	ДвиженияСерийТоваров.Получатель.* КАК Получатель,
	|	ДвиженияСерийТоваров.ПомещениеПолучателя.* КАК Помещение,
	|	(0) КАК ОстатокНачальный,
	|	(ВЫБОР
	|			КОГДА &ЕдиницыКоличества = 0
	|				ТОГДА ДвиженияСерийТоваров.КоличествоОборот
	|			КОГДА &ЕдиницыКоличества = 1
	|				ТОГДА ВЫБОР
	|						КОГДА ДвиженияСерийТоваров.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|							ТОГДА ДвиженияСерийТоваров.КоличествоОборот / ДвиженияСерийТоваров.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|						ИНАЧЕ 0
	|					КОНЕЦ
	|		КОНЕЦ) КАК Приход,
	|	(0) КАК Расход,
	|	(0) КАК Остаток,
	|	(ВЫБОР
	|			КОГДА ДвиженияСерийТоваров.Получатель ССЫЛКА Справочник.СтруктураПредприятия
	|				ТОГДА &ТипПолучателяПодразделение
	|			КОГДА ДвиженияСерийТоваров.Получатель ССЫЛКА Справочник.Партнеры
	|				ТОГДА &ТипПолучателяПокупатель
	|			ИНАЧЕ &ТипПолучателяСклад
	|		КОНЕЦ) КАК ТипПолучателя,
	|	(ЛОЖЬ) КАК ОстаткиДоступны}
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДвиженияСерийТоваров.Номенклатура,
	|	ДвиженияСерийТоваров.Характеристика,
	|	ДвиженияСерийТоваров.Серия,
	|	ДвиженияСерийТоваров.Отправитель,
	|	ДвиженияСерийТоваров.ПомещениеОтправителя,
	|	0,
	|	0,
	|	ВЫБОР
	|		КОГДА &ЕдиницыКоличества = 0
	|			ТОГДА ДвиженияСерийТоваров.КоличествоОборот
	|		КОГДА &ЕдиницыКоличества = 1
	|			ТОГДА ВЫБОР
	|					КОГДА ДвиженияСерийТоваров.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|						ТОГДА ДвиженияСерийТоваров.КоличествоОборот / ДвиженияСерийТоваров.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|					ИНАЧЕ 0
	|				КОНЕЦ
	|	КОНЕЦ,
	|	0,
	|	ВЫБОР
	|		КОГДА ДвиженияСерийТоваров.Отправитель ССЫЛКА Справочник.СтруктураПредприятия
	|			ТОГДА &ТипПолучателяПодразделение
	|		КОГДА ДвиженияСерийТоваров.Отправитель ССЫЛКА Справочник.Партнеры
	|			ТОГДА &ТипПолучателяПокупатель
	|		ИНАЧЕ &ТипПолучателяСклад
	|	КОНЕЦ,
	|	ЛОЖЬ
	|ИЗ
	|	РегистрНакопления.ДвиженияСерийТоваров.Обороты(
	|			,
	|			,
	|			Авто,
	|			ЭтоСкладскоеДвижение
	|				И Серия <> ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
	|				И (Серия = &Серия
	|					ИЛИ &Серия = ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
	|					ИЛИ &Серия = НЕОПРЕДЕЛЕНО)
	|				И ((Номенклатура, Отправитель) В
	|						(ВЫБРАТЬ
	|							НоменклатураПоКоторойНеВедутсяОстатки.Ссылка,
	|							НоменклатураПоКоторойНеВедутсяОстатки.Склад
	|						ИЗ
	|							НоменклатураПоКоторойНеВедутсяОстатки)
	|					ИЛИ Отправитель ССЫЛКА Справочник.Партнеры
	|						И СкладскаяОперация В (ЗНАЧЕНИЕ(Перечисление.СкладскиеОперации.ПриемкаПоВозвратуОтКлиента)))) КАК ДвиженияСерийТоваров
	|{ГДЕ
	|	ДвиженияСерийТоваров.Номенклатура.* КАК Номенклатура,
	|	ДвиженияСерийТоваров.Характеристика.* КАК Характеристика,
	|	ДвиженияСерийТоваров.Серия.* КАК Серия,
	|	ДвиженияСерийТоваров.Отправитель.* КАК Отправитель,
	|	ДвиженияСерийТоваров.ПомещениеОтправителя.* КАК Помещение,
	|	(0) КАК ОстатокНачальный,
	|	(0) КАК Приход,
	|	(ВЫБОР
	|			КОГДА &ЕдиницыКоличества = 0
	|				ТОГДА ДвиженияСерийТоваров.КоличествоОборот
	|			КОГДА &ЕдиницыКоличества = 1
	|				ТОГДА ВЫБОР
	|						КОГДА ДвиженияСерийТоваров.Номенклатура.КоэффициентЕдиницыДляОтчетов <> 0
	|							ТОГДА ДвиженияСерийТоваров.КоличествоОборот / ДвиженияСерийТоваров.Номенклатура.КоэффициентЕдиницыДляОтчетов
	|						ИНАЧЕ 0
	|					КОНЕЦ
	|		КОНЕЦ) КАК Расход,
	|	(0) КАК Остаток,
	|	(ВЫБОР
	|			КОГДА ДвиженияСерийТоваров.Отправитель ССЫЛКА Справочник.СтруктураПредприятия
	|				ТОГДА &ТипПолучателяПодразделение
	|			КОГДА ДвиженияСерийТоваров.Отправитель ССЫЛКА Справочник.Партнеры
	|				ТОГДА &ТипПолучателяПокупатель
	|			ИНАЧЕ &ТипПолучателяСклад
	|		КОНЕЦ) КАК ТипПолучателя,
	|	(ЛОЖЬ) КАК ОстаткиДоступны}
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ТоварыССериями.Номенклатура КАК Номенклатура,
	|	ВТ_ТоварыССериями.Характеристика КАК Характеристика,
	|	ВТ_ТоварыССериями.Серия КАК Серия,
	|	ВТ_ТоварыССериями.Получатель КАК Получатель,
	|	ВТ_ТоварыССериями.Остаток КАК Остаток,
	|	ВТ_ТоварыССериями.ОстаткиДоступны КАК ОстаткиДоступны
	|ИЗ
	|	ВТ_ТоварыССериями КАК ВТ_ТоварыССериями
	|ГДЕ
	|	ВТ_ТоварыССериями.Остаток <> 0";
	
	ВыборкаРезультатЗапросаОстатков = Запрос.Выполнить().Выбрать();
	
	Если ВыборкаРезультатЗапросаОстатков.Количество() > 0 Тогда
		
		Пока ВыборкаРезультатЗапросаОстатков.Следующий() Цикл
			
			Если Не ВыборкаРезультатЗапросаОстатков.ОстаткиДоступны Тогда
				Продолжить;	
			КонецЕсли;
			
			НазваниеТовара = "Товар: " + ?(ВключатьАртикул, ВыборкаРезультатЗапросаОстатков.Номенклатура.Артикул + " ", "")
			+ ВыборкаРезультатЗапросаОстатков.Номенклатура + " " 
			+ ВыборкаРезультатЗапросаОстатков.Характеристика;
			
			ДополнительнаяИнформация = "";
			
			СтруктураТовары = Новый Структура;
			СтруктураТовары.Вставить("title", НазваниеТовара);
			СтруктураТовары.Вставить("value", ДополнительнаяИнформация);
			СтруктураТовары.Вставить("content", Новый Массив);	
			
			НазваниеСклада = "Склад: " + ЧистаяСтрока(ВыборкаРезультатЗапросаОстатков.Получатель.Наименование);
			
			СтруктураСклады = Новый Структура;
			СтруктураСклады.Вставить("title"  , НазваниеСклада);
			СтруктураСклады.Вставить("value"  , "");
			СтруктураСклады.Вставить("content", Новый Массив);
			
			НазваниеСерии = "Серия: " + ЧистаяСтрока(ВыборкаРезультатЗапросаОстатков.Серия.Наименование);
			СтрокаОстаток = "" + ВыборкаРезультатЗапросаОстатков.Остаток;
			
			СтруктураОстатки = Новый Структура;
			СтруктураОстатки.Вставить("title", НазваниеСерии);
			СтруктураОстатки.Вставить("value", СтрокаОстаток);
			
			СтруктураСклады.content.Добавить(СтруктураОстатки);
			
			//добавляем только если есть строки
			Если СтруктураСклады.content.Количество() > 0 Тогда
				//если одна строка и нет разбивки, то для красоты выводим данные на уровне выше
				Если СтруктураСклады.content.Количество() = 1 И СтруктураСклады.content[0].title = "" Тогда	
					СтруктураСклады.value = СтруктураСклады.content[0].value;
					СтруктураСклады.content = Новый Массив;
				КонецЕсли;
				СтруктураТовары.content.Добавить(СтруктураСклады);
			КонецЕсли;
			
			МассивОтвета.Добавить(СтруктураТовары);
			
		КонецЦикла;
		
		Если СтруктураТовары.content.Количество() = 0 Тогда 
			СтруктураСклады = Новый Структура;
			СтруктураСклады.Вставить("title", "Остатков не числится...");
			СтруктураСклады.Вставить("value", "");
			СтруктураСклады.Вставить("content", Новый Массив);
			
			СтруктураТовары.content.Добавить(СтруктураСклады);		
		КонецЕсли;
				
		Возврат ПодготовитьОтветJSON(МассивОтвета,, "application/json");
		
	Иначе 
		
		Возврат ПодготовитьОтветJSON(МассивОтвета,, "application/json");
		
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#Область Photos

// Передача изображения при фотофиксации в карточке товара.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// ArtID - Строка - Id товара.
//
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetArtPhotos(SN, UserName, ArtID) Экспорт
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN); 
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если Лев(ArtID, 3) = "8U-" Тогда
		Номенклатура = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4));    		
	ИначеЕсли Лев(ArtID, 3) = "8e-" Тогда
		
		НоменклатураЕГАИС = XMLЗначение(Тип("СправочникСсылка.КлассификаторАлкогольнойПродукцииЕГАИС"), Сред(ArtID, 4));    		
		
		Если ТоварСопоставленОдинКОдному(НоменклатураЕГАИС) Тогда
			Номенклатура = ДатаМобайл_ОбщийМодуль.ПолучитьНоменклатуруПоЕГАИС(НоменклатураЕГАИС);
		Иначе 				
			
			СтруктураОтвета.Вставить("Описание", "Номенклатура ЕГАИС сопоставлена с несколькими обычными. ");			
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			
		КонецЕсли;
	Иначе
		
		СтруктураОтвета.Вставить("Описание", "Не найдена номенклатура. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		
	КонецЕсли;
		
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Файлы.Ссылка КАК Файл
	|ИЗ
	|	Справочник.НоменклатураПрисоединенныеФайлы КАК Файлы
	|ГДЕ
	|	Файлы.ВладелецФайла = &Номенклатура
	|	И НЕ Файлы.ПометкаУдаления
	|УПОРЯДОЧИТЬ ПО
	|	ВладелецФайла"; 
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Выборка = Запрос.Выполнить().Выбрать();	
	
	Пока Выборка.Следующий() Цикл
		
		ОбъектКартинки = ПолучитьСтруктуруОбъектаДляHttp("image");
		ОбъектКартинки.Art_ID = ArtID;
		ОбъектКартинки.ID = "8i-" + XMLСтрока(Выборка.Файл);
		ДанныеФайла = ДатаМобайл_ОбщийМодуль.ДанныеФайла(Выборка.Файл, Новый УникальныйИдентификатор).СсылкаНаДвоичныеДанныеФайла;
		ДанныеИзХранилища = ПолучитьИзвременногоХранилища(ДанныеФайла) ;
		
		Попытка
			ОбъектКартинки.data = Base64Строка(ПолучитьИзвременногоХранилища(ДатаМобайл_ОбщийМодуль.ДанныеФайла(Выборка.Файл, Новый УникальныйИдентификатор).СсылкаНаДвоичныеДанныеФайла));
		Исключение
			Продолжить;
		КонецПопытки;
		
		ОбъектСписка.Добавить(ОбъектКартинки);
		
	КонецЦикла;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Передача изображений товаров.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetArtsPhotos(SN, UserName) Экспорт
	
	ОбъектСписка = Новый Массив;
	
	УзелПО = НайтиУзел(SN);  
	
	Если Не ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьИзображения") Тогда
		
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
		
	КонецЕсли;  
	
	РП = ДатаМобайл_ОбщийМодуль.DM_ПолучитьРазделительПути(); 	
	
	Если Не ЗначениеЗаполнено(УзелПО.КаталогСжатыхИзображений) Тогда
		ПутьХранения = "";
	Иначе
		ПутьХранения = УзелПО.КаталогСжатыхИзображений;
		Если Прав(ПутьХранения, 1) = РП Тогда
			ПутьХранения = Лев(ПутьХранения, СтрДлина(ПутьХранения) - 1);	
		КонецЕсли;	
	КонецЕсли;	 
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	Файлы.Ссылка КАК ОбъектВыгрузки,
	|	Файлы.ВладелецФайла КАК Номенклатура
	|ПОМЕСТИТЬ	СписокИзображений
	|ИЗ
	|	Справочник.НоменклатураПрисоединенныеФайлы КАК Файлы
	|ГДЕ
	|	НЕ Файлы.ПометкаУдаления
	|	И НЕ Файлы.ВладелецФайла.ЭтоГруппа
	|	И (Файлы.ВладелецФайла.Ссылка В ИЕРАРХИИ (&СписокТоваров) ИЛИ &ВсеТовары)
	|
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////		
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Номенклатура,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
	|ПОМЕСТИТЬ СписокТоваровОбщий
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка)
	|			И (Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры))
	|			И (НЕ ХарактеристикиНоменклатуры.ПометкаУдаления)
	|ГДЕ
	|	НЕ ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)
	|	И
	|	Номенклатура.Ссылка В
	|			(ВЫБРАТЬ
	|				СписокИзображений.Номенклатура
	|			ИЗ
	|				СписокИзображений КАК СписокИзображений)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Номенклатура.Ссылка,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка))
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВидНоменклатуры)
	|			И (Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры))
	|			И (НЕ ХарактеристикиНоменклатуры.ПометкаУдаления)
	|ГДЕ
	|	Номенклатура.Ссылка В
	|			(ВЫБРАТЬ
	|				СписокИзображений.Номенклатура
	|			ИЗ
	|				СписокИзображений КАК СписокИзображений)
	|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Номенклатура.Ссылка,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка))
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВладелецХарактеристик)
	|			И (Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры))
	|			И (НЕ ХарактеристикиНоменклатуры.ПометкаУдаления)
	|ГДЕ
	|	Номенклатура.Ссылка В
	|			(ВЫБРАТЬ
	|				СписокИзображений.Номенклатура
	|			ИЗ
	|				СписокИзображений КАК СписокИзображений)
	|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ           
	|	СписокИзображений.ОбъектВыгрузки КАК ОбъектВыгрузки,
	|	СписокИзображений.Номенклатура КАК Номенклатура,
	|	ЕСТЬNULL(СписокТоваровОбщий.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
	|ПОМЕСТИТЬ СписокИзображенийИтог
	|ИЗ
	|	СписокИзображений КАК СписокИзображений
	|		ЛЕВОЕ СОЕДИНЕНИЕ СписокТоваровОбщий КАК СписокТоваровОбщий
	|		ПО СписокИзображений.Номенклатура = СписокТоваровОбщий.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СписокИзображенийИтог.ОбъектВыгрузки КАК ОбъектВыгрузки,
	|	СписокИзображенийИтог.Номенклатура КАК Номенклатура,
	|	СписокИзображенийИтог.Характеристика КАК Характеристика
	|ИЗ
	|	СписокИзображенийИтог КАК СписокИзображенийИтог
	|
	|УПОРЯДОЧИТЬ ПО
	|	Номенклатура
	|ИТОГИ ПО
	|	Номенклатура";              
	
	Запрос.УстановитьПараметр("СписокТоваров", УзелПО.ДоступныеГруппыТоваров.ВыгрузитьКолонку("Номенклатура"));
	Запрос.УстановитьПараметр("ВсеТовары", УзелПО.ДоступныеГруппыТоваров.Количество() = 0);
	
	ВыборкаИтоги = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам); 
	
	Если ЗначениеЗаполнено(ПутьХранения) Тогда
		
		МассивРасширений = Новый Массив;
		МассивРасширений.Добавить(".jpg");
		МассивРасширений.Добавить(".jpeg");
		МассивРасширений.Добавить(".bmp");
		МассивРасширений.Добавить(".png");   
				
	КонецЕсли;
	
	Пока ВыборкаИтоги.Следующий() Цикл
		
		Выборка = ВыборкаИтоги.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			
			Если Не ЗначениеЗаполнено(ПутьХранения) Тогда
				
				ОбъектКартинки = ПолучитьСтруктуруОбъектаДляHttp("image");
				
				ОбъектКартинки.Art_ID = "8U-" + XMLСтрока(Выборка.Номенклатура) + XMLСтрока(Выборка.Характеристика);
				ОбъектКартинки.ID = "8i-" + XMLСтрока(Выборка.ОбъектВыгрузки);
				
				Попытка
					ОбъектКартинки.data = Base64Строка(ПолучитьИзвременногоХранилища(ДатаМобайл_ОбщийМодуль.ДанныеФайла(Выборка.ОбъектВыгрузки, Новый УникальныйИдентификатор).СсылкаНаДвоичныеДанныеФайла));
				Исключение
					Продолжить;
				КонецПопытки;
				
				ОбъектСписка.Добавить(ОбъектКартинки);   
				
			Иначе  
				
				ArtID_Номенклатура = "8U-" + XMLСтрока(Выборка.Номенклатура) + XMLСтрока(Выборка.Характеристика);	
				
				//images (previews получаем в GetArtsPhotosParts) 
					
				ПутьДоПапки = ПутьХранения + РП + "images" + РП +  ArtID_Номенклатура;					 
				
				МассивФайлов = НайтиФайлы(ПутьДоПапки,"*.*", Истина);   		
				ИмяФайлаИзображения = "";          			
				
				Для каждого НайденныйФайл Из МассивФайлов Цикл
					
					Расширение = НайденныйФайл.Расширение; 					
					
					Если МассивРасширений.Найти(НРег(Расширение)) = Неопределено Тогда
						Продолжить;
					КонецЕсли;
					
					ИмяФайлаИзображения = НайденныйФайл.ПолноеИмя;
					ОбъектКартинки = ПолучитьСтруктуруОбъектаДляHttp("image");
					ОбъектКартинки.Art_ID = ArtID_Номенклатура;
					ОбъектКартинки.ID = НайденныйФайл.ИмяБезРасширения;						
					
					Попытка                                                             
						ДвоичныеДанные = Новый ДвоичныеДанные(ИмяФайлаИзображения);
						ОбъектКартинки.data = Base64Строка(ДвоичныеДанные);
					Исключение
						Продолжить;
					КонецПопытки;
					
					ОбъектСписка.Добавить(ОбъектКартинки);
					
				КонецЦикла;   				
				
			КонецЕсли;	
			
		КонецЦикла;
		
	КонецЦикла; 
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьИзображения") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьИзображения", Ложь);
	КонецЕсли; 
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Передача изображения при фотофиксации в строке документа.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocID - Строка - Id документа ТСД.
// ArtID - Строка - Id товара.
// Barcode - Строка - Штрихкод.
// Byte - ДвоичныеДанные - Изображение.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция SetRowPhoto(SN, UserName, DocID, ArtID, Barcode, Byte) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN); 
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocID, 5));
	Исключение
		
		СтруктураОтвета.Вставить("is_success", Ложь);		
		
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		
	КонецПопытки;
	
	Шаблон = ССылкаНаДок.Шаблон;
	
	СтруктураПоиска = Новый Структура("КодТовара, Штрихкод", СокрЛП(ArtID), СокрЛП(Barcode));
	
	Объект = СсылкаНаДок.ПолучитьОбъект();
	
	Если Шаблон.ИспользоватьФотофиксацию И Шаблон.ИспользоватьПодбор Тогда
		
		СтрокиПодбор = Объект.СобранныеДанныеПодбор.НайтиСтроки(СтруктураПоиска);
		
		Если СтрокиПодбор.Количество() > 0 Тогда
			
			ИмяПапки = Объект.Номер + Лев(СтрЗаменить(Объект.Дата, ".", ""),8);
			ПутьСохранения = Шаблон.ПутьВыгрузкиИзображения + ИмяПапки + "\Photos of products in Selection\";
			
			Если НайтиФайлы(ПутьСохранения).Количество() = 0 Тогда
				СоздатьКаталог(ПутьСохранения);
			КонецЕсли;
						
			Изображение = Новый Картинка(Byte);		
			ПутьКФайлу = ПутьСохранения+Barcode + "_" + СтрЗаменить(Формат(ТекущаяДата(),"ДЛФ=T"),":","") + ".jpeg";				
			
			Попытка
				Изображение.Записать(ПутьКФайлу);
			Исключение
				
				СтруктураОтвета.Вставить("is_success", Ложь);		
				Возврат ПодготовитьОтветJSON(СтруктураОтвета);
				
			КонецПопытки;
			
			Для Н = 0 По СтрокиПодбор.Количество() - 1 Цикл
				СтрокиПодбор[Н].СсылкаНаИзображение = Строка(ПутьКФайлу);	
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если Шаблон.ИспользоватьФотофиксацию И Шаблон.ИспользоватьПриемку Тогда
		
		СтрокиПриемка = Объект.СобранныеДанныеПриемка.НайтиСтроки(СтруктураПоиска);
		
		Если СтрокиПриемка.Количество() > 0 Тогда
			
			ИмяПапки = Объект.Номер + Лев(СтрЗаменить(Объект.Дата, ".", ""),8);
			
			ПутьСохранения = Шаблон.ПутьВыгрузкиИзображения + ИмяПапки + "\Photos of products in Allocation\";
			
			Если НайтиФайлы(ПутьСохранения).Количество() = 0 Тогда
				СоздатьКаталог(ПутьСохранения);
			КонецЕсли; 
						
			Изображение = Новый Картинка(Byte);
			ПутьКФайлу = ПутьСохранения+Barcode + "_" + СтрЗаменить(Формат(ТекущаяДата(), "ДЛФ=T"), ":", "") + ".jpeg";				
			
			Попытка
				Изображение.Записать(ПутьКФайлу);
			Исключение
				
				СтруктураОтвета.Вставить("is_success", Ложь);		
				Возврат ПодготовитьОтветJSON(СтруктураОтвета);
				
			КонецПопытки;
			
			Для Н = 0 По СтрокиПриемка.Количество() - 1 Цикл
				СтрокиПриемка[Н].СсылкаНаИзображение = ПутьКФайлу;	
			КонецЦикла;		
			
		КонецЕсли; 
		
	КонецЕсли;
		
	Объект.Записать();
	
	ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
	
	СтруктураОтвета.Вставить("is_success", Истина);		
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Передача изображения при фотофиксации в документе.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocID - Строка - Id документа ТСД.
// Byte - ДвоичныеДанные - Изображение.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция SetDocPhoto(SN, UserName, DocID, Byte) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocID, 5));	
	Исключение                                       
		
		СтруктураОтвета.Вставить("is_success", Ложь);		
		Возврат ПодготовитьОтветJSON(СтруктураОтвета); 
		
	КонецПопытки;
	
	Объект = СсылкаНаДок.ПолучитьОбъект(); 
	Шаблон = СсылкаНаДок.Шаблон;
	
	Если Не ЗначениеЗаполнено(Шаблон.ПутьВыгрузкиИзображения) Тогда
		СтруктураОтвета.Вставить("is_success", Ложь);			 
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	КонецЕсли;
	
	ИмяПапки = Объект.Номер + Лев(СтрЗаменить(Объект.Дата,".",""), 8);
	
	ПутьСохранения = Шаблон.ПутьВыгрузкиИзображения + ИмяПапки + "\General photos of document\";
	
	КаталогНаДиске = Новый Файл(ПутьСохранения);
	
	Если Не КаталогНаДиске.Существует() Тогда
		
		Попытка
			СоздатьКаталог(ПутьСохранения);
		Исключение
			
			СтруктураОтвета.Вставить("is_success", Ложь);			 
			Возврат ПодготовитьОтветJSON(СтруктураОтвета);
			
		КонецПопытки;
		
	КонецЕсли;
		
	Изображение = Новый Картинка(Byte); 
	
	Файлы = НайтиФайлы(ПутьСохранения, DocID + "????.jpeg",);
	
	Если Файлы.Количество() > 0 Тогда
		ПутьКФайлу = ПутьСохранения + DocID + "_" + Формат(Файлы.Количество(), "ЧЦ=3; ЧВН=") + ".jpeg";				
	Иначе
		ПутьКФайлу = ПутьСохранения + DocID + ".jpeg";
	КонецЕсли;
	
	Попытка
		
		Изображение.Записать(ПутьКФайлу);
		
		Объект.СсылкаНаИзображение = Строка(ПутьКФайлу);	
		Объект.Записать();
		
		ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
		
		СтруктураОтвета.Вставить("is_success", Истина);
		
	Исключение	 
		СтруктураОтвета.Вставить("is_success", Ложь);	 
	КонецПопытки;
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);	
	
КонецФункции

// Передача изображения при фотофиксации в карточке товара.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DMImage - Структура - Структура данных изображения.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция SetArtPhoto(SN, UserName, DMImage) Экспорт
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);	
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если Не РазрешеноРедактированиеТовара(УзелПО,UserName) Тогда		
		
		СтруктураОтвета.Вставить("Описание", "Пользователю ТСД в настройках роли в АРМ не разрешено редактирование товаров.");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		
	КонецЕсли;		
	
	Если Лев(DMImage.art_id, 3) = "8U-" Тогда
		Номенклатура = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(DMImage.art_id, 4));  		
	ИначеЕсли Лев(DMImage.art_id, 3) = "8e-" Тогда 
		
		НоменклатураЕГАИС = XMLЗначение(Тип("СправочникСсылка.КлассификаторАлкогольнойПродукцииЕГАИС"), Сред(DMImage.art_id, 4));	
		
		Если ТоварСопоставленОдинКОдному(НоменклатураЕГАИС) Тогда
			Номенклатура = ДатаМобайл_ОбщийМодуль.ПолучитьНоменклатуруПоЕГАИС(НоменклатураЕГАИС);
		Иначе 			
			
			СтруктураОтвета.Вставить("Описание", "Номенклатура ЕГАИС сопоставлена с несколькими обычными. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
			
		КонецЕсли;
		
	Иначе 		
		
		СтруктураОтвета.Вставить("Описание", "Не найдена номенклатура. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		
	КонецЕсли;
	
	Попытка	
		
		АдресФайлаВХранилище = ПоместитьВоВременноеХранилище(DMImage.data);
		
		ПараметрыФайла = Новый Структура;
		ПараметрыФайла.Вставить("ВладелецФайлов", Номенклатура);
		Автор = Справочники.Пользователи.НайтиПоНаименованию(UserName);
		
		Если Автор.Пустая() Тогда
			
			ВыборкаПользователей = Справочники.Пользователи.Выбрать();
			
			Пока  ВыборкаПользователей.Следующий() Цикл
				
				Если ВыборкаПользователей.Наименование <> "<Не указан>" Тогда
					Автор = ВыборкаПользователей.Ссылка;
					Прервать;
					
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;	
		
		ПараметрыФайла.Вставить("Автор", Автор);
		ПараметрыФайла.Вставить("ИмяБезРасширения", НСтр("ru = 'Изображение из DataMobile'"));
		ПараметрыФайла.Вставить("РасширениеБезТочки", "jpeg");
		ПараметрыФайла.Вставить("ВремяИзменения", Неопределено);
		ПараметрыФайла.Вставить("ВремяИзмененияУниверсальное", Неопределено);
		
		ПрисоединенныйФайл = ДатаМобайл_ОбщийМодуль.ДобавитьФайл(ПараметрыФайла, АдресФайлаВХранилище);
		
		Если Номенклатура.ФайлКартинки.Пустая() Тогда
			
			НоменклатураОбъект = Номенклатура.ПолучитьОбъект();
			НоменклатураОбъект.ФайлКартинки = ПрисоединенныйФайл.Ссылка;
			НоменклатураОбъект.Записать();
			
		КонецЕсли;   		
		
		ПутьХранения = УзелПО.КаталогСжатыхИзображений;	  
		
		Если ЗначениеЗаполнено(ПутьХранения) Тогда
			
			ПараметрыВыполнения = Новый Структура;
			СтруктураПараметров = Новый Структура;  
			
			СтруктураПараметров.Вставить("ПолнаяВыгрузка", Ложь);
			СтруктураПараметров.Вставить("Номенклатура", Номенклатура);
			СтруктураПараметров.Вставить("ПутьХранения", ПутьХранения);
			СтруктураПараметров.Вставить("УзелПО", УзелПО); 
			
			ДатаМобайл_ОбщийМодуль.СжатьИзображения(СтруктураПараметров, ПараметрыВыполнения);
			
		КонецЕсли;	
		
		СтруктураОтвета.Вставить("data", "8i-" + XMLСтрока(ПрисоединенныйФайл)); 
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		
	Исключение	
		
		СтруктураОтвета.Вставить("Описание", "Ошибка добавления изображения. " + ОписаниеОшибки());		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		
	КонецПопытки;
	
КонецФункции

// Удаление изображения товара.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// ArtID - Строка - Id товара.
// DMImageID - Строка - Id изображения.
// 
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция DeleteArtPhoto(SN, UserName, ArtID, DMImageID) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;	
	
	Если Не РазрешеноРедактированиеТовара(УзелПО,UserName) Тогда		
		
		СтруктураОтвета.Вставить("Описание", "Пользователю ТСД в настройках роли в АРМ не разрешено редактирование товаров.");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		
	КонецЕсли;
	
	Если Лев(DMImageID, 3) = "8i-" Тогда
		Изображение = XMLЗначение(Тип("СправочникСсылка.НоменклатураПрисоединенныеФайлы"), Сред(DMImageID, 4));	
	Иначе		
		
		СтруктураОтвета.Вставить("Описание", "Не найдено изображение для удаления. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		
	КонецЕсли;
	
	Попытка
		
		ИзображениеОбъект = Изображение.ПолучитьОбъект();
		ИзображениеОбъект.ПометкаУдаления = Истина;
		ИзображениеОбъект.Записать(); 
		
	Исключение		
		
		СтруктураОтвета.Вставить("Описание", "Ошибка удаления изображения. " + ОписаниеОшибки());		
		
	КонецПопытки;	
	
	СтруктураОтвета.Вставить("is_success", Истина);
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

// Порционное получение изображений товара.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// ArtID - Строка - Id товара.
// НомерПакета - Строка - Номер пакета.
// ТипИзображения - Строка - Тип изображения (image/previews).
//
//
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetArtPhotosParts(SN, UserName, ArtID, НомерПакета, ТипИзображения) Экспорт
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
		
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	МассивРасширений = Новый Массив;
	МассивРасширений.Добавить(".jpg");
	МассивРасширений.Добавить(".jpeg");
	МассивРасширений.Добавить(".bmp");
	МассивРасширений.Добавить(".png"); 
	
	РП = ДатаМобайл_ОбщийМодуль.DM_ПолучитьРазделительПути(); 	
	
	Если Не ЗначениеЗаполнено(УзелПО.КаталогСжатыхИзображений) Тогда
		ПутьХранения = "";
	Иначе
		ПутьХранения = УзелПО.КаталогСжатыхИзображений;
		Если Прав(ПутьХранения, 1) = РП Тогда
			ПутьХранения = Лев(ПутьХранения, СтрДлина(ПутьХранения) - 1);	
		КонецЕсли;	
	КонецЕсли;		
	
	Если Лев(ArtID, 3) = "8U-" Тогда		
		
		Попытка
			Номенклатура = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));		
		Исключение 				
		КонецПопытки;
		
		ИДХК = Сред(ArtID, 40, 36);
		
		Если ИДХК = "00000000-0000-0000-0000-000000000000" Тогда
			ХК = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
		Иначе	
			ХК = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);
		КонецЕсли;
		
	КонецЕсли;	
		
	Запрос = Новый Запрос;     
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	НоменклатураПрисоединенныеФайлы.Ссылка КАК Файл,
	|	НоменклатураПрисоединенныеФайлы.ВладелецФайла КАК Номенклатура,
	|	НоменклатураПрисоединенныеФайлы.Расширение КАК Расширение
	|ПОМЕСТИТЬ СписокИзображений
	|ИЗ
	|	Справочник.НоменклатураПрисоединенныеФайлы КАК НоменклатураПрисоединенныеФайлы
	|ГДЕ
	|	НЕ НоменклатураПрисоединенныеФайлы.ПометкаУдаления
	|	И НоменклатураПрисоединенныеФайлы.ВладелецФайла = &ВладелецФайла
	|	И НЕ НоменклатураПрисоединенныеФайлы.ЭтоГруппа
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Номенклатура.Ссылка КАК Номенклатура,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
	|ПОМЕСТИТЬ СписокТоваровОбщий
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка)
	|			И (Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры))
	|			И (НЕ ХарактеристикиНоменклатуры.ПометкаУдаления)
	|ГДЕ
	|	НЕ ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)
	|	И
	|	Номенклатура.Ссылка В
	|			(ВЫБРАТЬ
	|				СписокИзображений.Номенклатура
	|			ИЗ
	|				СписокИзображений КАК СписокИзображений)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Номенклатура.Ссылка,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка))
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВидНоменклатуры)
	|			И (Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры))
	|			И (НЕ ХарактеристикиНоменклатуры.ПометкаУдаления)
	|ГДЕ
	|	Номенклатура.Ссылка В
	|			(ВЫБРАТЬ
	|				СписокИзображений.Номенклатура
	|			ИЗ
	|				СписокИзображений КАК СписокИзображений)
	|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Номенклатура.Ссылка,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка))
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВладелецХарактеристик)
	|			И (Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры))
	|			И (НЕ ХарактеристикиНоменклатуры.ПометкаУдаления)
	|ГДЕ
	|	Номенклатура.Ссылка В
	|			(ВЫБРАТЬ
	|				СписокИзображений.Номенклатура
	|			ИЗ
	|				СписокИзображений КАК СписокИзображений)
	|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СписокИзображений.Файл КАК ОбъектВыгрузки,
	|	СписокИзображений.Номенклатура КАК Номенклатура,	
	|	ISNULL(СписокТоваровОбщий.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
	|ИЗ
	|	СписокИзображений КАК СписокИзображений
	|		ЛЕВОЕ СОЕДИНЕНИЕ СписокТоваровОбщий КАК СписокТоваровОбщий
	|		ПО СписокИзображений.Номенклатура = СписокТоваровОбщий.Номенклатура
	|ГДЕ
	|&УсловиеФильтраПоХарактеристике
	|
	|УПОРЯДОЧИТЬ ПО
	|	Номенклатура";
	Запрос.УстановитьПараметр("ВладелецФайла", Номенклатура);
	
	Если ЗначениеЗаполнено(ХК) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеФильтраПоХарактеристике", "СписокТоваровОбщий.Характеристика = &ХК");
		Запрос.УстановитьПараметр("ХК", ХК);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеФильтраПоХарактеристике", "ИСТИНА");
	КонецЕсли;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	СтруктураПараметров = Новый Структура; 
	
	СтруктураПараметров.Вставить("ПолнаяВыгрузка", Ложь);
	СтруктураПараметров.Вставить("ПутьХранения", ПутьХранения);
	СтруктураПараметров.Вставить("УзелПО", УзелПО);
	СтруктураПараметров.Вставить("Номенклатура", Справочники.Номенклатура.ПустаяСсылка());
	
	ПараметрыВыполнения = Новый Структура;    
		
	Пока Выборка.Следующий() Цикл            
		
		ArtID_Номенклатура = "8U-" + XMLСтрока(Выборка.Номенклатура) + XMLСтрока(Выборка.Характеристика);
		ПутьДоПапки = ПутьХранения + РП + ТипИзображения + РП +  ArtID_Номенклатура;					 
		
		МассивФайлов = НайтиФайлы(ПутьДоПапки, "*.*", Истина);   		
		ИмяФайлаИзображения = "";          		
		
		Если Не ЗначениеЗаполнено(ПутьХранения) Тогда
			
			ОбъектКартинки = ПолучитьСтруктуруОбъектаДляHttp("image");
			
			ОбъектКартинки.Art_ID = ArtID_Номенклатура;
			ОбъектКартинки.ID = "8i-" + XMLСтрока(Выборка.ОбъектВыгрузки); 		
			
			Попытка
				ОбъектКартинки.data = Base64Строка(ПолучитьИзвременногоХранилища(ДатаМобайл_ОбщийМодуль.ДанныеФайла(Выборка.ОбъектВыгрузки, Новый УникальныйИдентификатор).СсылкаНаДвоичныеДанныеФайла));
			Исключение
				Продолжить; 
			КонецПопытки;
			
			ОбъектСписка.Добавить(ОбъектКартинки); 
			
		Иначе
			
			Если МассивФайлов.Количество() = 0 Тогда  
				
				Попытка
					
					СтруктураПараметров.Номенклатура = Выборка.Номенклатура;
					ДатаМобайл_ОбщийМодуль.СжатьИзображения(СтруктураПараметров, ПараметрыВыполнения);								
					МассивФайлов = НайтиФайлы(ПутьДоПапки, "*.*", Истина);  
					
				Исключение
					
					ОбъектКартинки = ПолучитьСтруктуруОбъектаДляHttp("image");
				
					ОбъектКартинки.Art_ID = ArtID_Номенклатура;
					ОбъектКартинки.ID = "8i-" + XMLСтрока(Выборка.ОбъектВыгрузки); 		
					
					Попытка
						ОбъектКартинки.data = Base64Строка(ПолучитьИзвременногоХранилища(ДатаМобайл_ОбщийМодуль.ДанныеФайла(Выборка.ОбъектВыгрузки, Новый УникальныйИдентификатор).СсылкаНаДвоичныеДанныеФайла));
					Исключение
						Продолжить; 
					КонецПопытки;
					
					ОбъектСписка.Добавить(ОбъектКартинки);
					
					Продолжить;
				
				КонецПопытки;	
				
			КонецЕсли;	
				
			Для Каждого НайденныйФайл Из МассивФайлов Цикл
				
				Расширение = НайденныйФайл.Расширение; 					
				
				Если МассивРасширений.Найти(НРег(Расширение)) = Неопределено Тогда
					Продолжить;
				КонецЕсли;	
				
				ИмяФайлаИзображения = НайденныйФайл.ПолноеИмя;
				ОбъектКартинки = ПолучитьСтруктуруОбъектаДляHttp("image");
				ОбъектКартинки.Art_ID = ArtID_Номенклатура;
				ОбъектКартинки.ID = НайденныйФайл.ИмяБезРасширения;						
				
				Попытка                                                             
					ДвоичныеДанные = Новый ДвоичныеДанные(ИмяФайлаИзображения);
					ОбъектКартинки.data = Base64Строка(ДвоичныеДанные);
				Исключение
					Продолжить;
				КонецПопытки;
				
				ОбъектСписка.Добавить(ОбъектКартинки);
				
			КонецЦикла; 
							
        КонецЕсли;	
		
	КонецЦикла;               
	
	СтруктураОтвета.Вставить("is_finished", Истина);			
	СтруктураОтвета.Вставить("data", ОбъектСписка);	 
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		
КонецФункции

// Порционное получение изображений товаров.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// НомерПакета - Строка - Номер пакета.
// ТипИзображения - Строка - Тип изображения (image/previews).
//
//
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetArtsPhotosParts(SN, UserName, НомерПакета, ТипИзображения) Экспорт
	
	ОбъектСписка = Новый Массив; 
	СтруктураОтвета = Новый Структура;
	УзелПО = НайтиУзел(SN);
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли; 
	
	Если Не ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьИзображения") Тогда
		
		СтруктураОтвета.Вставить("is_finished", Истина);
		СтруктураОтвета.Вставить("data", ОбъектСписка);
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		
	КонецЕсли;	
	
	МассивРасширений = Новый Массив;
	
	МассивРасширений.Добавить(".jpg");
	МассивРасширений.Добавить(".jpeg");
	МассивРасширений.Добавить(".bmp");
	МассивРасширений.Добавить(".png");   
	
	РП = ДатаМобайл_ОбщийМодуль.DM_ПолучитьРазделительПути(); 	
	
	Если Не ЗначениеЗаполнено(УзелПО.КаталогСжатыхИзображений) Тогда
		ПутьХранения = "";
	Иначе
		ПутьХранения = УзелПО.КаталогСжатыхИзображений;
		Если Прав(ПутьХранения, 1) = РП Тогда
			ПутьХранения = Лев(ПутьХранения, СтрДлина(ПутьХранения) - 1);	
		КонецЕсли;	
	КонецЕсли;	 
	
	СтруктураПараметров = Новый Структура;
	
	СтруктураПараметров.Вставить("ПолнаяВыгрузка", Ложь);
	СтруктураПараметров.Вставить("УзелПО", УзелПО);
	СтруктураПараметров.Вставить("ПутьХранения", ПутьХранения);
	СтруктураПараметров.Вставить("Номенклатура", Справочники.Номенклатура.ПустаяСсылка());
	
	ПараметрыВыполнения = Новый Структура;           
	
	Если Не НомерПакета = "" Тогда
		
		ПакетнаяВыгрузка = Истина; 
		НомерПакета = Число(НомерПакета); 		 	
		СтруктураПараметров = Новый Структура; 
		СтруктураПараметров.Вставить("ПолнаяВыгрузка", Ложь);
		СтруктураПараметров.Вставить("УзелПО", УзелПО);
		СтруктураПараметров.Вставить("ПутьХранения", ПутьХранения);
		СтруктураПараметров.Вставить("Номенклатура", Справочники.Номенклатура.ПустаяСсылка());
		
		ПараметрыВыполнения = Новый Структура; 
		
		КоличествоИзображенийВПорции = УзелПО.КоличествоИзображенийВПорции;
		
		Если Не ЗначениеЗаполнено(КоличествоИзображенийВПорции) Тогда
			КоличествоИзображенийВПорции = 10;
		КонецЕсли;
		
	Иначе
		
		ПакетнаяВыгрузка = Ложь;
		
	КонецЕсли;                           
	
	Если Не ПакетнаяВыгрузка Тогда  	
		
		Запрос = Новый Запрос;     		
		Запрос.Текст =
		
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ДатаМобайл_ПорционнаяВыгрузка.ОбъектВыгрузки КАК ОбъектВыгрузки,
		|	ДатаМобайл_ПорционнаяВыгрузка.ОбъектВыгрузки.ВладелецФайла КАК ВладелецФайла
		|ИЗ
		|	РегистрСведений.ДатаМобайл_ПорционнаяВыгрузка КАК ДатаМобайл_ПорционнаяВыгрузка
		|ГДЕ
		|	ДатаМобайл_ПорционнаяВыгрузка.ТипОбъекта = 2
		|	И ДатаМобайл_ПорционнаяВыгрузка.ТСД = &Узел"; 
		
		Запрос.УстановитьПараметр("Узел", УзелПО);
		
		Выборка = Запрос.Выполнить().Выбрать();	
		
		Пока Выборка.Следующий() Цикл
			
			ОбъектКартинки = ПолучитьСтруктуруОбъектаДляHttp("image");
			
			ТекущаяНоменклатура = Выборка.ВладелецФайла;
			
			ОбъектКартинки.Art_ID = "8U-" + XMLСтрока(ТекущаяНоменклатура) + XMLСтрока(Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
			ОбъектКартинки.ID = "8i-" + XMLСтрока(Выборка.ОбъектВыгрузки); 		
			
			Попытка
				ОбъектКартинки.data = Base64Строка(ПолучитьИзвременногоХранилища(ДатаМобайл_ОбщийМодуль.ДанныеФайла(Выборка.ОбъектВыгрузки, Новый УникальныйИдентификатор).СсылкаНаДвоичныеДанныеФайла));
			Исключение
				Продолжить; 
			КонецПопытки;
			
			ОбъектСписка.Добавить(ОбъектКартинки);
			
		КонецЦикла;	
		
	Иначе          	             	
		
		Если НомерПакета = 1 Тогда
			
			НаборЗаписейПодвисшихПакетов = РегистрыСведений.ДатаМобайл_ПорционнаяВыгрузка.СоздатьНаборЗаписей();
			НаборЗаписейПодвисшихПакетов.Отбор.ТСД.Установить(УзелПО);
			НаборЗаписейПодвисшихПакетов.Отбор.ТипОбъекта.Установить(2);
			НаборЗаписейПодвисшихПакетов.Отбор.НомерПакета.Установить(1);
			НаборЗаписейПодвисшихПакетов.Прочитать();
			
			Если НаборЗаписейПодвисшихПакетов.Количество() = 0 Тогда
				
				РегистрыСведений.ДатаМобайл_ПорционнаяВыгрузка.ПеререгистрацияПодвисшихПакетовПодВыгрузку(УзелПО);	
				
			КонецЕсли; 
			
		КонецЕсли; 	
		
		//выгрузка порции:
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ 
		|	ДатаМобайл_ПорционнаяВыгрузка.ОбъектВыгрузки КАК ОбъектВыгрузки,
		|	ДатаМобайл_ПорционнаяВыгрузка.ОбъектВыгрузки.ВладелецФайла КАК Номенклатура
		|ПОМЕСТИТЬ	СписокИзображений
		|ИЗ
		|	РегистрСведений.ДатаМобайл_ПорционнаяВыгрузка КАК ДатаМобайл_ПорционнаяВыгрузка
		|ГДЕ
		|	ДатаМобайл_ПорционнаяВыгрузка.ТСД = &ТСД
		|	И ДатаМобайл_ПорционнаяВыгрузка.ТипОбъекта = 2
		|	И ДатаМобайл_ПорционнаяВыгрузка.НомерПакета = &НомерПакета
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////		
		|ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
		|ПОМЕСТИТЬ СписокТоваровОбщий
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка)
		|			И (Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры))
		|			И (НЕ ХарактеристикиНоменклатуры.ПометкаУдаления)
		|ГДЕ
		|	НЕ ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)
		|	И
		|	Номенклатура.Ссылка В
		|			(ВЫБРАТЬ
		|				СписокИзображений.Номенклатура
		|			ИЗ
		|				СписокИзображений КАК СписокИзображений)
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Номенклатура.Ссылка,
		|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка))
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВидНоменклатуры)
		|			И (Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры))
		|			И (НЕ ХарактеристикиНоменклатуры.ПометкаУдаления)
		|ГДЕ
		|	Номенклатура.Ссылка В
		|			(ВЫБРАТЬ
		|				СписокИзображений.Номенклатура
		|			ИЗ
		|				СписокИзображений КАК СписокИзображений)
		|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Номенклатура.Ссылка,
		|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка))
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|		ПО (ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВладелецХарактеристик)
		|			И (Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры))
		|			И (НЕ ХарактеристикиНоменклатуры.ПометкаУдаления)
		|ГДЕ
		|	Номенклатура.Ссылка В
		|			(ВЫБРАТЬ
		|				СписокИзображений.Номенклатура
		|			ИЗ
		|				СписокИзображений КАК СписокИзображений)
		|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ           
		|	СписокИзображений.ОбъектВыгрузки КАК ОбъектВыгрузки,
		|	СписокИзображений.Номенклатура КАК Номенклатура,
		|	ЕСТЬNULL(СписокТоваровОбщий.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
		|ПОМЕСТИТЬ СписокИзображенийИтог
		|ИЗ
		|	СписокИзображений КАК СписокИзображений
		|		ЛЕВОЕ СОЕДИНЕНИЕ СписокТоваровОбщий КАК СписокТоваровОбщий
		|		ПО СписокИзображений.Номенклатура = СписокТоваровОбщий.Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	СписокИзображенийИтог.ОбъектВыгрузки КАК ОбъектВыгрузки,
		|	СписокИзображенийИтог.Номенклатура КАК Номенклатура,
		|	СписокИзображенийИтог.Характеристика КАК Характеристика
		|ИЗ
		|	СписокИзображенийИтог КАК СписокИзображенийИтог
		|
		|УПОРЯДОЧИТЬ ПО
		|	Номенклатура
		|ИТОГИ ПО
		|	Номенклатура";              
		
		Запрос.УстановитьПараметр("ТСД", УзелПО);
		Запрос.УстановитьПараметр("НомерПакета", НомерПакета);
		
		МассивКВыгрузке = Новый Массив;
		
		ВыборкаИтоги = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
		Пока ВыборкаИтоги.Следующий() Цикл
			
			Выборка = ВыборкаИтоги.Выбрать();
			
			Пока Выборка.Следующий() Цикл  
				
				МассивКВыгрузке.Добавить(Выборка.ОбъектВыгрузки);
				
				ArtID_Номенклатура = "8U-" + XMLСтрока(Выборка.Номенклатура) + XMLСтрока(Выборка.Характеристика);
				ПутьДоПапки = ПутьХранения + РП + ТипИзображения + РП +  ArtID_Номенклатура;					 
				
				МассивФайлов = НайтиФайлы(ПутьДоПапки, "*.*", Истина);   		
				ИмяФайлаИзображения = "";          		
				
				Если Не ЗначениеЗаполнено(ПутьХранения) Тогда
					
					ОбъектКартинки = ПолучитьСтруктуруОбъектаДляHttp("image");
					
					ОбъектКартинки.Art_ID = ArtID_Номенклатура;
					ОбъектКартинки.ID = "8i-" + XMLСтрока(Выборка.ОбъектВыгрузки); 		
					
					Попытка
						ОбъектКартинки.data = Base64Строка(ПолучитьИзвременногоХранилища(ДатаМобайл_ОбщийМодуль.ДанныеФайла(Выборка.ОбъектВыгрузки, Новый УникальныйИдентификатор).СсылкаНаДвоичныеДанныеФайла));
					Исключение
						Продолжить; 
					КонецПопытки;
					
					ОбъектСписка.Добавить(ОбъектКартинки); 
					
				Иначе
					
					Если МассивФайлов.Количество() = 0 Тогда
						
						Попытка
						
							СтруктураПараметров.Номенклатура = Выборка.Номенклатура;
							ДатаМобайл_ОбщийМодуль.СжатьИзображения(СтруктураПараметров, ПараметрыВыполнения);								
							МассивФайлов = НайтиФайлы(ПутьДоПапки, "*.*", Истина);
							
						Исключение
							
							ОбъектКартинки = ПолучитьСтруктуруОбъектаДляHttp("image");
					
							ОбъектКартинки.Art_ID = ArtID_Номенклатура;
							ОбъектКартинки.ID = "8i-" + XMLСтрока(Выборка.ОбъектВыгрузки); 		
							
							Попытка
								ОбъектКартинки.data = Base64Строка(ПолучитьИзвременногоХранилища(ДатаМобайл_ОбщийМодуль.ДанныеФайла(Выборка.ОбъектВыгрузки, Новый УникальныйИдентификатор).СсылкаНаДвоичныеДанныеФайла));
							Исключение
								Продолжить; 
							КонецПопытки;
							
							ОбъектСписка.Добавить(ОбъектКартинки);
							
							Продолжить;
							
						КонецПопытки;	
						
					КонецЕсли;		
						
					Для Каждого НайденныйФайл Из МассивФайлов Цикл
						
						Расширение = НайденныйФайл.Расширение; 					
						
						Если МассивРасширений.Найти(НРег(Расширение)) = Неопределено Тогда
							Продолжить;
						КонецЕсли;	
						
						ИмяФайлаИзображения = НайденныйФайл.ПолноеИмя;
						ОбъектКартинки = ПолучитьСтруктуруОбъектаДляHttp("image");
						ОбъектКартинки.Art_ID = ArtID_Номенклатура;
						ОбъектКартинки.ID = НайденныйФайл.ИмяБезРасширения;						
						
						Попытка                                                             
							ДвоичныеДанные = Новый ДвоичныеДанные(ИмяФайлаИзображения);
							ОбъектКартинки.data = Base64Строка(ДвоичныеДанные);
						Исключение
							Продолжить;
						КонецПопытки;
						
						ОбъектСписка.Добавить(ОбъектКартинки);
						
					КонецЦикла; 	
					
				КонецЕсли;	
				
			КонецЦикла;	
			
		КонецЦикла;   	
		
		//удаляем данные предыдущего пакета:
		
		Если НомерПакета > 1 Тогда
			
			//записываем данные уже без учета порции к выгрузке:
			НаборЗаписей = РегистрыСведений.ДатаМобайл_ПорционнаяВыгрузка.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.ТСД.Установить(УзелПО); 
			НаборЗаписей.Отбор.НомерПакета.Установить(НомерПакета - 1);
			//2 - изображения
			НаборЗаписей.Отбор.ТипОбъекта.Установить(2);
			НаборЗаписей.Прочитать();
			НаборЗаписей.Очистить(); 			
			НаборЗаписей.Записать(Истина);
			
		КонецЕсли;	
		
		НаборЗаписей = РегистрыСведений.ДатаМобайл_ПорционнаяВыгрузка.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ТСД.Установить(УзелПО);
		//2 - изображения
		НаборЗаписей.Отбор.ТипОбъекта.Установить(2);
		НаборЗаписей.Прочитать();
		
		Если НаборЗаписей.Количество() Тогда       
			СтруктураОтвета.Вставить("is_finished", Ложь);
		Иначе
			
			СтруктураОтвета.Вставить("is_finished", Истина);
			
			Если ТипИзображения = "images" Тогда
				Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьИзображения") Тогда
					ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьИзображения", Ложь);
				КонецЕсли; 
			КонецЕсли;
			
			Если ТипИзображения = "previews" Тогда
				РегистрыСведений.ДатаМобайл_ПорционнаяВыгрузка.ЗарегистрироватьИзображенияНоменклатурыПодПорционнуюВыгрузку(УзелПО, Истина);	
			КонецЕсли;			
			
		КонецЕсли;	   		   		
		
	КонецЕсли;
	
	СтруктураОтвета.Вставить("data", ОбъектСписка);
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);	
		
КонецФункции  
 
 #КонецОбласти

#Область Others

// Получение количества с весов.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа ТСД.
// Cell - Строка - ШК ячейки.
// ArtSN - Строка - Серийный номер товара.
// ScalesBarcode - Строка - Штрихкод.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция GetArtQtyByScales(SN, UserName, DocOutID, ArtID, Cell, ArtSN, ScalesBarcode) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	Ответ = 1.55;
	
	СтруктураОтвета.Вставить("data", Ответ); 
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);	
	
КонецФункции

// Получение криптоключа.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция CrptKey(SN, UserName) Экспорт 
	
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, Username);
	КонецЕсли;
	
	КлючСессии = "";
	
	Если Не ПустаяСтрока(УзелПО.КлючСессии) Тогда
		КлючСессии = УзелПО.КлючСессии;		
	КонецЕсли;
	
	СтруктураОтвета.Вставить("data", КлючСессии); 
	
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);	
	
КонецФункции

#КонецОбласти

#Область Egais

// Идентификация и получение объекта товара ЕГАИС при сканировании акцизной марки.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// ArtID - Строка - Id товара.
// Barcode - Строка - Штрихкод.
// Barcode - Строка - Штрихкод PDF.
// DocOutID - Строка - Id документа ТСД.
// Cell - Строка - Ячейка.
//
// Возвращаемое значение:
//   JSON со структурой данных.
//
Функция OnArtEgaisScan(SN, UserName, ArtID, Barcode, PDFBarcode, DocOutID, Cell) Экспорт 
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
		Возврат OnArtEgaisScan_КТ2000(SN, UserName, ArtID, Barcode, PDFBarcode, DocOutID, Cell);
	КонецЕсли;
	
	СтруктураОтвета = Новый Структура;
	
	ОбъектТовараЕГАИС = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);   
	КонецЕсли;
	
	Если Не (СтрДлина(PDFBarcode) = 68 Или СтрДлина(PDFBarcode) = 150) Тогда  // формат марки	
		СтруктураОтвета.Вставить("Описание", "Некорректный формат марки. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецЕсли;
	
	Попытка		
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));		
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Не удалось найти документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецПопытки;
	
	Шаблон = СсылкаНаДок.Шаблон;	
	
	Если Не ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда
		Если стрДлина(PDFBarcode) = 68 Тогда 
			Алкокод = КодНоменклатурыЕГАИСПоPDF417(PDFBarcode);
			
			ЗапросЕГАИС = Новый Запрос(
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	ЕГАИС_Номенклатура.Ссылка КАК Ссылка,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Наименование, """") КАК name,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Производитель.Наименование, """") КАК manufacturer,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Импортер.Наименование, """") КАК importer,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Объем, 0) КАК capacity,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Крепость, 0) КАК percent_alco,
			|	ВЫБОР
			|		КОГДА НЕ ЕГАИС_Номенклатура.ВидПродукции.Код ЕСТЬ NULL
			|			ТОГДА ЕГАИС_Номенклатура.ВидПродукции.Код + "" ""+ЕГАИС_Номенклатура.ВидПродукции.Наименование
			|		ИНАЧЕ ЕСТЬNULL(ЕГАИС_Номенклатура.Ссылка.ВидПродукции.Код + "" "", """") + ЕСТЬNULL(ЕГАИС_Номенклатура.Ссылка.ВидПродукции.Наименование + "" "", """")
			|	КОНЕЦ КАК type_alco
			|ИЗ
			|	Справочник.КлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_Номенклатура
			|ГДЕ
			|	ЕГАИС_Номенклатура.Код = &Код
			|	И НЕ ЕГАИС_Номенклатура.ПометкаУдаления");
			
			ЗапросЕГАИС.УстановитьПараметр("Код", Алкокод);
			
			ВыборкаЕГАИС = ЗапросЕГАИС.Выполнить().Выбрать();
			
			Пока ВыборкаЕГАИС.Следующий() Цикл			
				OnArtEgaisScan_ЗаполнитьОбъектТовара(ВыборкаЕГАИС, ОбъектТовараЕГАИС);			
			КонецЦикла;
			
			Возврат ПодготовитьОтветJSON(ОбъектТовараЕГАИС);			
		ИначеЕсли стрДлина(PDFBarcode) = 150 Тогда
			
			МаркаСсылка = Справочники.ШтрихкодыУпаковокТоваров.НайтиПоРеквизиту("ЗначениеШтрихкода", PDFBarcode);
			
			ЗапросЕГАИС = Новый Запрос(
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	ЕГАИС_РегистрМарок.АлкогольнаяПродукция.Ссылка КАК Ссылка,
			|	ЕСТЬNULL(ЕГАИС_РегистрМарок.АлкогольнаяПродукция.Наименование, """") КАК name,
			|	ЕСТЬNULL(ЕГАИС_РегистрМарок.АлкогольнаяПродукция.Производитель.Наименование, """") КАК manufacturer,
			|	ЕСТЬNULL(ЕГАИС_РегистрМарок.АлкогольнаяПродукция.Импортер.Наименование, """") КАК importer,
			|	ЕСТЬNULL(ЕГАИС_РегистрМарок.АлкогольнаяПродукция.Объем, 0) КАК capacity,
			|	ЕСТЬNULL(ЕГАИС_РегистрМарок.АлкогольнаяПродукция.Крепость, 0) КАК percent_alco,
			|	ВЫБОР
			|		КОГДА НЕ ЕГАИС_РегистрМарок.АлкогольнаяПродукция.ВидПродукции.Код ЕСТЬ NULL
			|			ТОГДА ЕГАИС_РегистрМарок.АлкогольнаяПродукция.ВидПродукции.Код + "" ""+ЕГАИС_РегистрМарок.АлкогольнаяПродукция.ВидПродукции.Наименование
			|		ИНАЧЕ ЕСТЬNULL(ЕГАИС_РегистрМарок.АлкогольнаяПродукция.Ссылка.ВидПродукции.Код + "" "", """") + ЕСТЬNULL(ЕГАИС_РегистрМарок.АлкогольнаяПродукция.Ссылка.ВидПродукции.Наименование + "" "", """")
			|	КОНЕЦ КАК type_alco
			|ИЗ
			|	РегистрСведений.АкцизныеМаркиЕГАИС КАК ЕГАИС_РегистрМарок
			|ГДЕ
			|	ЕГАИС_РегистрМарок.АкцизнаяМарка = &ЕГАИС_Код
			|	И НЕ ЕГАИС_РегистрМарок.АлкогольнаяПродукция.ПометкаУдаления");
			ЗапросЕГАИС.УстановитьПараметр("ЕГАИС_Код", МаркаСсылка);
			
			ВыборкаЕГАИС = ЗапросЕГАИС.Выполнить().Выбрать();
			
			Пока ВыборкаЕГАИС.Следующий() Цикл			
				OnArtEgaisScan_ЗаполнитьОбъектТовара(ВыборкаЕГАИС, ОбъектТовараЕГАИС);			
			КонецЦикла;
			
			Возврат ПодготовитьОтветJSON(ОбъектТовараЕГАИС);
			
		Иначе
			Возврат ПодготовитьОтветJSON(Новый Структура);	
		КонецЕсли;
		
	Иначе                  
		
		Если стрДлина(PDFBarcode) = 68 Тогда
			Алкокод = КодНоменклатурыЕГАИСПоPDF417(PDFBarcode);	
			ЗапросЕГАИС = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
			|	ЕГАИС_Номенклатура.Ссылка,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Наименование, """") КАК name,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.ПроизводительИмпортер.Наименование, """") КАК manufacturer,
			|	"""" КАК importer,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Объем, 0) КАК capacity,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Крепость, 0) КАК percent_alco,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.ВидПродукции.Наименование, """") КАК type_alco
			|ИЗ
			|	Справочник.астНоменклатураЕГАИС КАК ЕГАИС_Номенклатура
			|ГДЕ
			|	ЕГАИС_Номенклатура.Код = &Код
			|	И НЕ ЕГАИС_Номенклатура.ПометкаУдаления");
			
			ЗапросЕГАИС.УстановитьПараметр("Код", Алкокод);
			
		ИначеЕсли стрДлина(PDFBarcode) = 150 Тогда	
			
			//во входящей ттн упаковки смотрим в самом доке
			ЭтоВходящаяТТН = Ложь;
			Попытка
				Если Шаблон.ВидДокумента = "астТоварноТранспортныеНакладныеИзЕГАИС" Тогда
					Если СсылкаНаДок.ИсходныйДокумент.ТипДокумента = Перечисления.астТипыАктовТоварноТранспортныхНакладныхЕГАИС.Входящий Тогда
						ЭтоВходящаяТТН = Истина;
					КонецЕсли;
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			Если ЭтоВходящаяТТН Тогда			
				
				Возврат ПодготовитьОтветJSON(Новый Структура);
				
			Иначе		
				
				ЗапросЕГАИС = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
				|	астМаркиЕГАИС.НоменклатураЕГАИС.Ссылка КАК Ссылка,
				|	ЕСТЬNULL(астМаркиЕГАИС.НоменклатураЕГАИС.Наименование, """") КАК name,
				|	ЕСТЬNULL(астМаркиЕГАИС.НоменклатураЕГАИС.ПроизводительИмпортер.Наименование, """") КАК manufacturer,
				|	"""" КАК importer,
				|	ЕСТЬNULL(астМаркиЕГАИС.НоменклатураЕГАИС.Объем, 0) КАК capacity,
				|	ЕСТЬNULL(астМаркиЕГАИС.НоменклатураЕГАИС.Крепость, 0) КАК percent_alco,
				|	ЕСТЬNULL(астМаркиЕГАИС.НоменклатураЕГАИС.ВидПродукции.Наименование, """") КАК type_alco
				|ИЗ
				|	Справочник.астМаркиЕГАИС КАК астМаркиЕГАИС
				|ГДЕ
				|	астМаркиЕГАИС.Наименование = &Код
				|	И НЕ астМаркиЕГАИС.ПометкаУдаления");
				
				ЗапросЕГАИС.УстановитьПараметр("Код", PDFBarcode);
				
			КонецЕсли;	
			
		Иначе
			Возврат ПодготовитьОтветJSON(Новый Структура);
		КонецЕсли;
		
		ВыборкаЕГАИС = ЗапросЕГАИС.Выполнить().Выбрать();
		
		Пока ВыборкаЕГАИС.Следующий() Цикл
			
			OnArtEgaisScan_ЗаполнитьОбъектТовара(ВыборкаЕГАИС, ОбъектТовараЕГАИС);
			
		КонецЦикла;
		
		Возврат ПодготовитьОтветJSON(ОбъектТовараЕГАИС);
		
	КонецЕсли;
	
КонецФункции

// Загрузка справочника товаров ЕГАИС.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// НомерПакета - Строка - номер пакета.
//
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetEgaisArts(SN, UserName, НомерПакета = "") Экспорт 
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	Если Не ДатаМобайл_ОбщийМодуль.ЕстьЕГАИС() И Не ДатаМобайл_ОбщийМодуль.ЕстьАСТ() И Не ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
	КонецЕсли;       
	
	Если Не НомерПакета = "" Тогда
		ПакетнаяВыгрузка = Истина; 
		НомерПакета = Число(НомерПакета);
	Иначе
		ПакетнаяВыгрузка = Ложь;
	КонецЕсли;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьТоварыЕГАИС") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьТоварыЕГАИС", Ложь);	 
	КонецЕсли;
		
	Если ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда  // аст 
		
		Если Не ПакетнаяВыгрузка Тогда
			
			ЗапросТоваров = Новый Запрос;
			ЗапросТоваров.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ЕСТЬNULL(ЕГАИС_НоменклатураИзменения.Ссылка, ЗНАЧЕНИЕ(Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК Ссылка
			|ИЗ
			|	Справочник.КлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_НоменклатураИзменения
			|ГДЕ
			| НЕ ЕГАИС_НоменклатураИзменения.Ссылка.ПометкаУдаления";
			ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, "КлассификаторАлкогольнойПродукцииЕГАИС", "астНоменклатураЕГАИС");
			
			ВыборкаТоваров = ЗапросТоваров.Выполнить().Выбрать();
			Пока ВыборкаТоваров.Следующий() Цикл
				ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
				
				ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
				ОбъектТовара.name = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Наименование, 100));
				ОбъектТовара.alcocode = ЧистаяСтрока(ВыборкаТоваров.Ссылка.Код);
				ОбъектТовара.manufacturer = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.ПроизводительИмпортер.Наименование, 100));
				ОбъектТовара.importer = ""; // импортера не используем
				ОбъектТовара.capacity = ВыборкаТоваров.Ссылка.Объем;
				ОбъектТовара.percent_alco = ВыборкаТоваров.Ссылка.Крепость;
				ОбъектТовара.type_alco = ЧистаяСтрока(ВыборкаТоваров.Ссылка.ВидПродукции.Код + " " + ВыборкаТоваров.Ссылка.ВидПродукции.Наименование);
				ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.Ссылка);
				ОбъектТовара.box_coef = 0; // количество единиц в коробе
				
				ОбъектСписка.Добавить(ОбъектТовара);
			КонецЦикла;
			
		Иначе 
			
			СтруктураОтвета = Новый Структура;
			
			Если НомерПакета = 1 Тогда  
				
				ЗапросТоваров = Новый Запрос;
				ЗапросТоваров.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ЕСТЬNULL(ЕГАИС_НоменклатураИзменения.Ссылка, ЗНАЧЕНИЕ(Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК Ссылка
				|ИЗ
				|	Справочник.КлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_НоменклатураИзменения
				|ГДЕ
				| НЕ ЕГАИС_НоменклатураИзменения.Ссылка.ПометкаУдаления";
				ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, "КлассификаторАлкогольнойПродукцииЕГАИС", "астНоменклатураЕГАИС");
				
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.астНоменклатураЕГАИС); 
				
				ВыборкаТоваров = ЗапросТоваров.Выполнить().Выбрать(); 
				
				Счетчик = 1;
				
				Пока ВыборкаТоваров.Следующий() Цикл
					
					Если Счетчик <= 1000 Тогда
						ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
						
						ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
						ОбъектТовара.name = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Наименование, 100));
						ОбъектТовара.alcocode = ЧистаяСтрока(ВыборкаТоваров.Ссылка.Код);
						ОбъектТовара.manufacturer = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.ПроизводительИмпортер.Наименование, 100));
						ОбъектТовара.importer = ""; // импортера не используем
						ОбъектТовара.capacity = ВыборкаТоваров.Ссылка.Объем;
						ОбъектТовара.percent_alco = ВыборкаТоваров.Ссылка.Крепость;
						ОбъектТовара.type_alco = ЧистаяСтрока(ВыборкаТоваров.Ссылка.ВидПродукции.Код + " " + ВыборкаТоваров.Ссылка.ВидПродукции.Наименование);
						ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.Ссылка);
						ОбъектТовара.box_coef = 0; // количество единиц в коробе
						
						ОбъектСписка.Добавить(ОбъектТовара);
						Счетчик = Счетчик + 1;
					Иначе
						ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, ВыборкаТоваров.Ссылка);
					КонецЕсли;					
					
				КонецЦикла;   
				
			Иначе
				
				//берем первую 1000 и передаем массив:
				
				ЗапросТоваров = Новый Запрос;
				ЗапросТоваров.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1000
				|	ЕСТЬNULL(ЕГАИС_НоменклатураИзменения.Ссылка, ЗНАЧЕНИЕ(Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК Ссылка
				|ИЗ
				|	Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.Изменения КАК ЕГАИС_НоменклатураИзменения
				|ГДЕ
				| 	ЕГАИС_НоменклатураИзменения.Узел = &Узел И ISNULL(ЕГАИС_НоменклатураИзменения.НомерСообщения, ИСТИНА) = ИСТИНА";
				ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, "КлассификаторАлкогольнойПродукцииЕГАИС", "астНоменклатураЕГАИС");
				ЗапросТоваров.УстановитьПараметр("Узел", УзелПО);
				
				РезультатЗапроса = ЗапросТоваров.Выполнить();
				Если Не РезультатЗапроса.Пустой() Тогда  
					МассивКВыгрузке = РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("Ссылка"); 				
					ПланыОбмена.ВыбратьИзменения(УзелПО, НомерПакета, МассивКВыгрузке);
					Выборка = РезультатЗапроса.Выбрать();
					
					Пока ВыборкаТоваров.Следующий() Цикл
						ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
						
						ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
						ОбъектТовара.name = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Наименование, 100));
						ОбъектТовара.alcocode = ЧистаяСтрока(ВыборкаТоваров.Ссылка.Код);
						ОбъектТовара.manufacturer = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.ПроизводительИмпортер.Наименование, 100));
						ОбъектТовара.importer = ""; // импортера не используем
						ОбъектТовара.capacity = ВыборкаТоваров.Ссылка.Объем;
						ОбъектТовара.percent_alco = ВыборкаТоваров.Ссылка.Крепость;
						ОбъектТовара.type_alco = ЧистаяСтрока(ВыборкаТоваров.Ссылка.ВидПродукции.Код + " " + ВыборкаТоваров.Ссылка.ВидПродукции.Наименование);
						ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.Ссылка);
						ОбъектТовара.box_coef = 0; // количество единиц в коробе
						
						ОбъектСписка.Добавить(ОбъектТовара); 
					КонецЦикла;   
				КонецЕсли;
				
			КонецЕсли; 
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	НоменклатураИзменения.Ссылка КАК Номенклатура
			|ИЗ
			|	Справочник.астНоменклатураЕГАИС.Изменения КАК НоменклатураИзменения
			|ГДЕ
			|	НоменклатураИзменения.Узел = &Узел
			|	И ISNULL(НоменклатураИзменения.НомерСообщения, ИСТИНА) = ИСТИНА";
			Запрос.УстановитьПараметр("Узел", УзелПО);
			Запрос.УстановитьПараметр("НомерСообщения", 0);
			РезультатЗапроса = Запрос.Выполнить();
			Если Не РезультатЗапроса.Пустой() Тогда       
				СтруктураОтвета.Вставить("is_finished", Ложь);
			Иначе
				СтруктураОтвета.Вставить("is_finished", Истина);
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.астНоменклатураЕГАИС);
			КонецЕсли;	   		
			
			СтруктураОтвета.Вставить("data", ОбъектСписка);
			Возврат ПодготовитьОтветJSON(СтруктураОтвета);			
			
		КонецЕсли;	
				
	ИначеЕсли ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда // кт2000 
		
		Если Не ПакетнаяВыгрузка Тогда
			ЗапросТоваров = Новый Запрос;
			ЗапросТоваров.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ЕСТЬNULL(ЕГАИС_НоменклатураИзменения.Ссылка, ЗНАЧЕНИЕ(Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК ССылка
			|ИЗ
			|	Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_НоменклатураИзменения";
			ВыборкаТоваров = ЗапросТоваров.Выполнить().Выбрать(); 
			
			Пока ВыборкаТоваров.Следующий() Цикл
				ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
				
				ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
				ОбъектТовара.name = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Наименование, 100));
				ОбъектТовара.alcocode = ЧистаяСтрока(ВыборкаТоваров.Ссылка.Код);
				ОбъектТовара.manufacturer = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Производитель.Наименование, 100));
				ОбъектТовара.importer = ""; // импортера не используем
				ОбъектТовара.capacity = ВыборкаТоваров.Ссылка.Объем;
				ОбъектТовара.percent_alco = ВыборкаТоваров.Ссылка.Крепость;
				ОбъектТовара.type_alco = ЧистаяСтрока(ВыборкаТоваров.Ссылка.ВидПродукции.Код + " " + ВыборкаТоваров.Ссылка.ВидПродукции.Наименование);
				ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.Ссылка);
				ОбъектТовара.box_coef = 6; // количество единиц в коробе
				
				ОбъектСписка.Добавить(ОбъектТовара);
			КонецЦикла; 
		Иначе
			СтруктураОтвета = Новый Структура; 
			
			Если НомерПакета = 1 Тогда
				
				ЗапросТоваров = Новый Запрос;
				ЗапросТоваров.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ЕСТЬNULL(ЕГАИС_НоменклатураИзменения.Ссылка, ЗНАЧЕНИЕ(Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК ССылка
				|ИЗ
				|	Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_НоменклатураИзменения";
				
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.алкКлассификаторАлкогольнойПродукцииЕГАИС);
				
				ВыборкаТоваров = ЗапросТоваров.Выполнить().Выбрать(); 
				Счетчик = 1;
				
				Пока ВыборкаТоваров.Следующий() Цикл
					
					Если Счетчик <= 1000 Тогда 
						ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
						
						ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
						ОбъектТовара.name = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Наименование, 100));
						ОбъектТовара.alcocode = ЧистаяСтрока(ВыборкаТоваров.Ссылка.Код);
						ОбъектТовара.manufacturer = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Производитель.Наименование, 100));
						ОбъектТовара.importer = ""; // импортера не используем
						ОбъектТовара.capacity = ВыборкаТоваров.Ссылка.Объем;
						ОбъектТовара.percent_alco = ВыборкаТоваров.Ссылка.Крепость;
						ОбъектТовара.type_alco = ЧистаяСтрока(ВыборкаТоваров.Ссылка.ВидПродукции.Код + " " + ВыборкаТоваров.Ссылка.ВидПродукции.Наименование);
						ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.Ссылка);
						ОбъектТовара.box_coef = 6; // количество единиц в коробе
						
						ОбъектСписка.Добавить(ОбъектТовара); 
						Счетчик = Счетчик + 1;   
					Иначе
						ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, ВыборкаТоваров.Ссылка);
					КонецЕсли;	
				КонецЦикла; 
							
			Иначе    
				
				//берем первую 1000 и передаем массив:
				
				ЗапросТоваров = Новый Запрос;
				ЗапросТоваров.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1000 
				|	ЕСТЬNULL(ЕГАИС_НоменклатураИзменения.Ссылка, ЗНАЧЕНИЕ(Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК ССылка
				|ИЗ
				|	Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.Изменения КАК ЕГАИС_НоменклатураИзменения
				|ГДЕ
				| 	ЕГАИС_НоменклатураИзменения.Узел = &Узел И  ISNULL(ЕГАИС_НоменклатураИзменения.НомерСообщения, ИСТИНА) = ИСТИНА";
				
				ЗапросТоваров.УстановитьПараметр("Узел", УзелПО);
				
				РезультатЗапроса = ЗапросТоваров.Выполнить(); 
				
				Если Не РезультатЗапроса.Пустой() Тогда  
					МассивКВыгрузке = РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("Ссылка"); 				
					ПланыОбмена.ВыбратьИзменения(УзелПО, НомерПакета, МассивКВыгрузке);
					Выборка = РезультатЗапроса.Выбрать();
					
					Пока ВыборкаТоваров.Следующий() Цикл
						ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
						
						ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
						ОбъектТовара.name = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Наименование, 100));
						ОбъектТовара.alcocode = ЧистаяСтрока(ВыборкаТоваров.Ссылка.Код);
						ОбъектТовара.manufacturer = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Производитель.Наименование, 100));
						ОбъектТовара.importer = ""; // импортера не используем
						ОбъектТовара.capacity = ВыборкаТоваров.Ссылка.Объем;
						ОбъектТовара.percent_alco = ВыборкаТоваров.Ссылка.Крепость;
						ОбъектТовара.type_alco = ЧистаяСтрока(ВыборкаТоваров.Ссылка.ВидПродукции.Код + " " + ВыборкаТоваров.Ссылка.ВидПродукции.Наименование);
						ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.Ссылка);
						ОбъектТовара.box_coef = 6; // количество единиц в коробе
						
						ОбъектСписка.Добавить(ОбъектТовара); 
					КонецЦикла;   
				КонецЕсли;
				
			КонецЕсли;
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	НоменклатураИзменения.Ссылка КАК Номенклатура
			|ИЗ
			|	Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.Изменения КАК НоменклатураИзменения
			|ГДЕ
			|	НоменклатураИзменения.Узел = &Узел
			|	И ISNULL(НоменклатураИзменения.НомерСообщения, ИСТИНА) = ИСТИНА";
			Запрос.УстановитьПараметр("Узел", УзелПО);
			РезультатЗапроса = Запрос.Выполнить();
			Если Не РезультатЗапроса.Пустой() Тогда       
				СтруктураОтвета.Вставить("is_finished", Ложь);
			Иначе
				СтруктураОтвета.Вставить("is_finished", Истина);
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.алкКлассификаторАлкогольнойПродукцииЕГАИС);
			КонецЕсли;	   		
			
			СтруктураОтвета.Вставить("data", ОбъектСписка);
			Возврат ПодготовитьОтветJSON(СтруктураОтвета);	
			
		КонецЕсли;	   
		
	Иначе		      
		
		Если Не ПакетнаяВыгрузка Тогда
			ЗапросТоваров = Новый Запрос;
			ЗапросТоваров.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ЕСТЬNULL(ЕГАИС_НоменклатураИзменения.Ссылка, ЗНАЧЕНИЕ(Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК ССылка
			|ИЗ
			|	Справочник.КлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_НоменклатураИзменения
			|ГДЕ
			| НЕ ЕГАИС_НоменклатураИзменения.Ссылка.ПометкаУдаления";
			
			ВыборкаТоваров = ЗапросТоваров.Выполнить().Выбрать();
			Пока ВыборкаТоваров.Следующий() Цикл
				ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
				
				ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
				ОбъектТовара.name = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Наименование, 100));
				ОбъектТовара.alcocode = ЧистаяСтрока(ВыборкаТоваров.Ссылка.Код);
				ОбъектТовара.manufacturer = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Производитель.Наименование, 100));
				ОбъектТовара.importer = ""; // импортера не используем
				ОбъектТовара.capacity = ВыборкаТоваров.Ссылка.Объем;
				ОбъектТовара.percent_alco = ВыборкаТоваров.Ссылка.Крепость;
				ОбъектТовара.type_alco = ЧистаяСтрока(ВыборкаТоваров.Ссылка.ВидПродукции.Код + " " + ВыборкаТоваров.Ссылка.ВидПродукции.Наименование);
				ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.Ссылка);
				ОбъектТовара.box_coef = 0; // количество единиц в коробе
				
				ОбъектСписка.Добавить(ОбъектТовара);
			КонецЦикла;	   
			
		Иначе
			
			СтруктураОтвета = Новый Структура;
			Если НомерПакета = 1 Тогда    
				
				ЗапросТоваров = Новый Запрос;
				ЗапросТоваров.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	ЕСТЬNULL(ЕГАИС_НоменклатураИзменения.Ссылка, ЗНАЧЕНИЕ(Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК ССылка
				|ИЗ
				|	Справочник.КлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_НоменклатураИзменения
				|ГДЕ
				| НЕ ЕГАИС_НоменклатураИзменения.Ссылка.ПометкаУдаления"; 
				
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.КлассификаторАлкогольнойПродукцииЕГАИС);
				
				ВыборкаТоваров = ЗапросТоваров.Выполнить().Выбрать();  
				
				Счетчик = 1;
				
				Пока ВыборкаТоваров.Следующий() Цикл   
					
					Если Счетчик <= 1000 Тогда
						ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
						
						ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
						ОбъектТовара.name = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Наименование, 100));
						ОбъектТовара.alcocode = ЧистаяСтрока(ВыборкаТоваров.Ссылка.Код);
						ОбъектТовара.manufacturer = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Производитель.Наименование, 100));
						ОбъектТовара.importer = ""; // импортера не используем
						ОбъектТовара.capacity = ВыборкаТоваров.Ссылка.Объем;
						ОбъектТовара.percent_alco = ВыборкаТоваров.Ссылка.Крепость;
						ОбъектТовара.type_alco = ЧистаяСтрока(ВыборкаТоваров.Ссылка.ВидПродукции.Код + " " + ВыборкаТоваров.Ссылка.ВидПродукции.Наименование);
						ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.Ссылка);
						ОбъектТовара.box_coef = 0; // количество единиц в коробе
						
						ОбъектСписка.Добавить(ОбъектТовара);   
						Счетчик = Счетчик + 1;
					Иначе
						ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, ВыборкаТоваров.Ссылка);	
					КонецЕсли;	
					
				КонецЦикла;	    				
			Иначе    
				
				//берем первую 1000 и передаем массив:
				
				ЗапросТоваров = Новый Запрос;
				ЗапросТоваров.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1000
				|	ЕСТЬNULL(ЕГАИС_НоменклатураИзменения.Ссылка, ЗНАЧЕНИЕ(Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК ССылка
				|ИЗ
				|	Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.Изменения КАК ЕГАИС_НоменклатураИзменения				
				|ГДЕ
				| 	ЕГАИС_НоменклатураИзменения.Узел = &Узел И  ISNULL(ЕГАИС_НоменклатураИзменения.НомерСообщения, ИСТИНА) = ИСТИНА";
				
				ЗапросТоваров.УстановитьПараметр("Узел", УзелПО);
				
				РезультатЗапроса = ЗапросТоваров.Выполнить(); 
				
				Если Не РезультатЗапроса.Пустой() Тогда  
					МассивКВыгрузке = РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("Ссылка"); 				
					ПланыОбмена.ВыбратьИзменения(УзелПО, НомерПакета, МассивКВыгрузке);
					Выборка = РезультатЗапроса.Выбрать();
					
					Пока ВыборкаТоваров.Следующий() Цикл
						ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
						
						ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
						ОбъектТовара.name = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Наименование, 100));
						ОбъектТовара.alcocode = ЧистаяСтрока(ВыборкаТоваров.Ссылка.Код);
						ОбъектТовара.manufacturer = ЧистаяСтрока(Лев(ВыборкаТоваров.Ссылка.Производитель.Наименование, 100));
						ОбъектТовара.importer = ""; // импортера не используем
						ОбъектТовара.capacity = ВыборкаТоваров.Ссылка.Объем;
						ОбъектТовара.percent_alco = ВыборкаТоваров.Ссылка.Крепость;
						ОбъектТовара.type_alco = ЧистаяСтрока(ВыборкаТоваров.Ссылка.ВидПродукции.Код + " " + ВыборкаТоваров.Ссылка.ВидПродукции.Наименование);
						ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.Ссылка);
						ОбъектТовара.box_coef = 0; // количество единиц в коробе
						
						ОбъектСписка.Добавить(ОбъектТовара);   
					КонецЦикла;   
				КонецЕсли;    
				
			КонецЕсли; 
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	НоменклатураИзменения.Ссылка КАК Номенклатура
			|ИЗ
			|	Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.Изменения КАК НоменклатураИзменения
			|ГДЕ
			|	НоменклатураИзменения.Узел = &Узел
			|	И ISNULL(НоменклатураИзменения.НомерСообщения, ИСТИНА) = ИСТИНА";
			Запрос.УстановитьПараметр("Узел", УзелПО);
			РезультатЗапроса = Запрос.Выполнить();
			Если Не РезультатЗапроса.Пустой() Тогда       
				СтруктураОтвета.Вставить("is_finished", Ложь);
			Иначе
				СтруктураОтвета.Вставить("is_finished", Истина);
				ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, Метаданные.Справочники.КлассификаторАлкогольнойПродукцииЕГАИС);
			КонецЕсли;	   		
			
			СтруктураОтвета.Вставить("data", ОбъектСписка);
			Возврат ПодготовитьОтветJSON(СтруктураОтвета);			
			
		КонецЕсли;	
		
	КонецЕсли;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Загрузка справочника акцизных марок товаров ЕГАИС.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
//
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetEgaisMarks(SN, UserName) Экспорт 
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	Если Не ДатаМобайл_ОбщийМодуль.ЕстьЕГАИС() И Не ДатаМобайл_ОбщийМодуль.ЕстьАСТ() И Не ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда		
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
	КонецЕсли;	
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЧтениеФлаговОбменаТСД(УзелПО, "ОчиститьМаркиЕГАИС") Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьФлаговОбменаТСД(УзелПО, "ОчиститьМаркиЕГАИС", Ложь);	 
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда
		ЗапросМарок = Новый Запрос("ВЫБРАТЬ
		|	астМаркиЕГАИС.Наименование КАК АкцизнаяМарка,
		|	астМаркиЕГАИС.НоменклатураЕГАИС КАК АлкогольнаяПродукция
		|ИЗ
		|	Справочник.астМаркиЕГАИС КАК астМаркиЕГАИС
		|ГДЕ
		|	НЕ астМаркиЕГАИС.ПометкаУдаления");
		
		ВыборкаМарок = ЗапросМарок.Выполнить().Выбрать();
		
		Пока ВыборкаМарок.Следующий() Цикл
			
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art_mark");
			
			ОбъектТовара.art_id = "8e-" + XMLСтрока(ВыборкаМарок.АлкогольнаяПродукция); 
			ОбъектТовара.mark = ВыборкаМарок.АкцизнаяМарка;
			
			ОбъектСписка.Добавить(ОбъектТовара);
			
		КонецЦикла;
		
	ИначеЕсли ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
		ЗапросМарок = Новый Запрос(	"ВЫБРАТЬ
		|	АкцизныеМаркиЕГАИС.Марка КАК АкцизнаяМарка,
		|	АкцизныеМаркиЕГАИС.АлкогольнаяПродукция КАК АлкогольнаяПродукция
		|ИЗ
		|	РегистрСведений.алкХранилищеАкцизныхМарок.СрезПоследних КАК АкцизныеМаркиЕГАИС");
		
		ВыборкаМарок = ЗапросМарок.Выполнить().Выбрать();
		
		Пока ВыборкаМарок.Следующий() Цикл
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art_mark");
			
			ОбъектТовара.art_id = "8e-" + XMLСтрока(ВыборкаМарок.АлкогольнаяПродукция); 
			ОбъектТовара.mark = ВыборкаМарок.АкцизнаяМарка;
			
			ОбъектСписка.Добавить(ОбъектТовара);
		КонецЦикла;
		
	Иначе 		
		ЗапросМарок = Новый Запрос ("ВЫБРАТЬ
		|	ЕстьNull(ЕГАИС_ДанныеМарки.АкцизнаяМарка.ЗначениеШтрихкода,"""") КАК АкцизнаяМарка,
		|	ЕГАИС_ДанныеМарки.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
		|	ЕстьNull(ЕГАИС_ДанныеМарки.АлкогольнаяПродукция.ПометкаУдаления, ЛОЖЬ) КАК ПометкаУдаления,
		|	ЕСТЬNULL(ДанныеУпаковкиУровень1.Ссылка.ЗначениеШтрихкода,"""") КАК Короб,
		|	ЕСТЬNULL(ДанныеУпаковкиУровень2.Ссылка.ЗначениеШтрихкода,"""") КАК Палета 
		|ИЗ
		|	РегистрСведений.АкцизныеМаркиЕГАИС КАК ЕГАИС_ДанныеМарки
		|   ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ДанныеУпаковкиУровень1
		|   ПО ДанныеУпаковкиУровень1.Штрихкод.ЗначениеШтрихкода = ЕГАИС_ДанныеМарки.АкцизнаяМарка.ЗначениеШтрихкода
		|   И (ДанныеУпаковкиУровень1.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
		|			ИЛИ ДанныеУпаковкиУровень1.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
		|   ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ДанныеУпаковкиУровень2
		|   ПО ДанныеУпаковкиУровень2.Штрихкод.ЗначениеШтрихкода = ДанныеУпаковкиУровень1.Ссылка.ЗначениеШтрихкода
		|   И (ДанныеУпаковкиУровень2.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
		|			ИЛИ ДанныеУпаковкиУровень2.Ссылка.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))");
		
		ВыборкаМарок = ЗапросМарок.Выполнить().Выбрать();
		
		Пока ВыборкаМарок.Следующий() Цикл
			Попытка 
				Если Не ЗначениеЗаполнено(ВыборкаМарок.АкцизнаяМарка) Или Не ЗначениеЗаполнено(ВыборкаМарок.АлкогольнаяПродукция) Или ВыборкаМарок.ПометкаУдаления Тогда
					Продолжить;
				КонецЕсли;
				
				ОбъектТовара =  ПолучитьСтруктуруОбъектаДляHttp("egais_art_mark");
				
				ОбъектТовара.art_id = "8e-" + XMLСтрока(ВыборкаМарок.АлкогольнаяПродукция); 
				ОбъектТовара.mark = ВыборкаМарок.АкцизнаяМарка;
				ОбъектТовара.box = ВыборкаМарок.Короб;
				ОбъектТовара.pallet = ВыборкаМарок.Палета;
				
				ОбъектСписка.Добавить(ОбъектТовара);
			Исключение 
				Продолжить;
			КонецПопытки;	
		КонецЦикла;
	КонецЕсли;	
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Загрузка данных товаров ЕГАИС из документа.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocID - Строка - Id документа ТСД.
//
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetDocArtsEgais(SN, UserName, DocID) Экспорт 
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocID, 5));   		
	Исключение
		
		СтруктураОтвета.Вставить("is_success", Ложь);
		
		Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		
	КонецПопытки;
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	ИмяДокумента = Шаблон.ВидДокумента;
	ИмяТЧ = Шаблон.ИмяТабличнойЧастиПодбор;
		
	Если Не ЗначениеЗаполнено(СсылкаНаДок.ИсходныйДокумент) Или Не Шаблон.ЕГАИС Тогда
		Возврат ПодготовитьОтветJSON(ОбъектСписка);	
	КонецЕсли;
		
	Если ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда
		ЗапросТоваров = Новый Запрос;
		ЗапросТоваров.УстановитьПараметр("ТТН", СсылкаНаДок.ИсходныйДокумент);
		
		ЗапросТоваров.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ЕГАИС_ТТНТовары.НоменклатураЕГАИС КАК Номенклатура,
		|	СУММА(ЕГАИС_ТТНТовары.Количество) КАК Количество
		|ПОМЕСТИТЬ ТоварыВОсновании
		|ИЗ
		|	Документ.астТоварноТранспортныеНакладныеИзЕГАИС.Товары КАК ЕГАИС_ТТНТовары
		|ГДЕ
		|	ЕГАИС_ТТНТовары.Ссылка = &ТТН
		|   И ЕГАИС_ТТНТовары.Количество > 0
		|СГРУППИРОВАТЬ ПО
		|	ЕГАИС_ТТНТовары.НоменклатураЕГАИС
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЕСТЬNULL(ТоварыВОсновании.Номенклатура.Код, """") КАК alcocode,
		|	ЕСТЬNULL(ТоварыВОсновании.Номенклатура.ПроизводительИмпортер.Наименование, """") КАК manufacturer,
		|	"""" КАК importer,
		|	ЕСТЬNULL(ТоварыВОсновании.Номенклатура.Объем, 0) КАК capacity,
		|	ЕСТЬNULL(ТоварыВОсновании.Номенклатура.Крепость, 0) КАК percent_alco,
		|	ЕСТЬNULL(ТоварыВОсновании.Номенклатура.ВидПродукции.Наименование, """") КАК type_alco,
		|	ЕСТЬNULL(ТоварыВОсновании.Номенклатура.Наименование, """") КАК name,
		|	ЕСТЬNULL(ТоварыВОсновании.Номенклатура, ЗНАЧЕНИЕ(Справочник.астНоменклатураЕГАИС.ПустаяССылка)) КАК ССылка
		|ИЗ
		|	ТоварыВОсновании КАК ТоварыВОсновании";
		
		ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, "астТоварноТранспортныеНакладныеИзЕГАИС", Шаблон.ВидДокумента);
		ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, ".Товары КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
		
		Если Шаблон.ВидДокумента = "астАктФиксацииШтрихкодовНаБалансеОрганизации" Тогда
			ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, "ЕГАИС_ТТНТовары.Количество", "ЕГАИС_ТТНТовары.КоличествоМарок");				
		КонецЕсли;
				
		ВыборкаТоваров = ЗапросТоваров.Выполнить().Выбрать();
		Пока ВыборкаТоваров.Следующий() Цикл
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
			ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
			ЗаполнитьЗначенияСвойств(ОбъектТовара, ВыборкаТоваров);
			ОбъектТовара.name = ЧистаяСтрока(ОбъектТовара.name);
			ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.ССылка);
			ОбъектТовара.box_coef = 0; // количество единиц в коробе
			
			ОбъектСписка.Добавить(ОбъектТовара);
		КонецЦикла;
		
	ИначеЕсли ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
		ЗапросТоваров = Новый Запрос;
		ЗапросТоваров.УстановитьПараметр("ТТН", СсылкаНаДок.ИсходныйДокумент);
		
		ЗапросТоваров.Текст = "ВЫБРАТЬ
		|	ЕГАИС_ТТНТовары.АлкогольнаяПродукция КАК Номенклатура,
		|	СУММА(ЕГАИС_ТТНТовары.Количество) КАК Количество
		|ПОМЕСТИТЬ ТоварыВОсновании
		|ИЗ
		|	Документ.алкТоварноТранспортнаяНакладнаяЕГАИС.Товары КАК ЕГАИС_ТТНТовары
		|ГДЕ
		|	ЕГАИС_ТТНТовары.Ссылка = &ТТН
		|
		|СГРУППИРОВАТЬ ПО
		|	ЕГАИС_ТТНТовары.АлкогольнаяПродукция
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Код, """") КАК alcocode,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Производитель.Наименование, """") КАК manufacturer,
		|	"""" КАК importer,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Объем, 0) КАК capacity,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Крепость, 0) КАК percent_alco,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.ВидПродукции.Наименование, """") КАК type_alco,
		|	ЕСТЬNULL(ТоварыВОсновании.Количество, 0) КАК Quant,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Наименование, """") КАК name,
		|	ЕСТЬNULL(ТоварыВОсновании.Номенклатура.Ссылка, ЗНАЧЕНИЕ(Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК ССылка
		|ИЗ
		|	ТоварыВОсновании КАК ТоварыВОсновании
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_Номенклатура
		|		ПО ТоварыВОсновании.Номенклатура = ЕГАИС_Номенклатура.Ссылка";
		
		ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, ".ЕГАИС_ТТН.", "." + Шаблон.ВидДокумента + ".");
		ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, ".Товары КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
		
		ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, ".алкТоварноТранспортнаяНакладнаяЕГАИС.", "." + Шаблон.ВидДокумента + ".");
		ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, ".Товары КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
		
		Если Шаблон.ВидДокумента = "ДатаМобайл_УпаковочныйЛист" Или Шаблон.ВидДокумента = "ДатаМобайл_ЗаявкаНаСклад" Тогда 
			ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, "ТТНТовары.АлкогольнаяПродукция", "ТТНТовары.ЕГАИС_Номенклатура");
		ИначеЕсли Шаблон.ВидДокумента = "алкАктФиксацииШтрихкодовНаБалансеОрганизацииЕГАИС" Тогда 
			ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, "ЕГАИС_ТТНТовары.Количество", "0");
		ИначеЕсли Шаблон.ВидДокумента = "РеализацияТоваровУслуг" Тогда 				  		
			ЗапросТоваров.Текст = "ВЫБРАТЬ
			|ЕСТЬNULL(СоответствиеНоменклатурыЕГАИС.АлкогольнаяПродукция,ЗНАЧЕНИЕ(Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК Номенклатура,
			|ЕГАИС_ТТНТовары.Номенклатура КАК НоменклатураУчетная
			|ПОМЕСТИТЬ ТоварыВОсновании
			|ИЗ
			|	Документ.РеализацияТоваровУслуг.Товары КАК ЕГАИС_ТТНТовары
			|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.алкСоответствияАлкогольнойПродукцииЕГАИСИНоменклатуры КАК СоответствиеНоменклатурыЕГАИС
			|	ПО СоответствиеНоменклатурыЕГАИС.Номенклатура = ЕГАИС_ТТНТовары.Номенклатура И СоответствиеНоменклатурыЕГАИС.СерияНоменклатуры = ЕГАИС_ТТНТовары.Серия
			|ГДЕ
			|	ЕГАИС_ТТНТовары.Ссылка = &ТТН
			|
			|СГРУППИРОВАТЬ ПО
			|	ЕСТЬNULL(СоответствиеНоменклатурыЕГАИС.АлкогольнаяПродукция,ЗНАЧЕНИЕ(Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)),
			|	ЕГАИС_ТТНТовары.Номенклатура
			|	
			|ОБЪЕДИНИТЬ
			|	
			|	ВЫБРАТЬ
			|ЕСТЬNULL(СоответствиеНоменклатурыЕГАИС.АлкогольнаяПродукция,ЗНАЧЕНИЕ(Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК Номенклатура,
			|ЕГАИС_ТТНТовары.Номенклатура КАК НоменклатураУчетная
			|ИЗ
			|	Документ.РеализацияТоваровУслуг.Товары КАК ЕГАИС_ТТНТовары
			|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.алкСоответствияАлкогольнойПродукцииЕГАИСИНоменклатуры КАК СоответствиеНоменклатурыЕГАИС
			|	ПО СоответствиеНоменклатурыЕГАИС.Номенклатура = ЕГАИС_ТТНТовары.Номенклатура
			|ГДЕ
			|	ЕГАИС_ТТНТовары.Ссылка = &ТТН
			|
			|СГРУППИРОВАТЬ ПО
			|	ЕСТЬNULL(СоответствиеНоменклатурыЕГАИС.АлкогольнаяПродукция,ЗНАЧЕНИЕ(Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)),
			|	ЕГАИС_ТТНТовары.Номенклатура 
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Код, """") КАК alcocode,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Производитель.Наименование, """") КАК manufacturer,
			|	"""" КАК importer,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Объем, 0) КАК capacity,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Крепость, 0) КАК percent_alco,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.ВидПродукции.Наименование, """") КАК type_alco,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.Наименование, """") КАК name,
			|	ТоварыВОсновании.Номенклатура КАК Ссылка,
			|	ТоварыВОсновании.НоменклатураУчетная КАК НоменклатураУчетная
			|ИЗ
			|	ТоварыВОсновании КАК ТоварыВОсновании
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_Номенклатура
			|		ПО ТоварыВОсновании.Номенклатура = ЕГАИС_Номенклатура.Ссылка
			|ГДЕ НЕ ТоварыВОсновании.Номенклатура = ЗНАЧЕНИЕ(Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)";						  
		КонецЕсли;		
		
		ВыборкаТоваров = ЗапросТоваров.Выполнить().Выбрать();
		Пока ВыборкаТоваров.Следующий() Цикл
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
			ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
			ЗаполнитьЗначенияСвойств(ОбъектТовара, ВыборкаТоваров);
			ОбъектТовара.name = ЧистаяСтрока(ОбъектТовара.name);
			ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.Ссылка);
			ОбъектТовара.box_coef = 6; // количество единиц в коробе
			
			ОбъектСписка.Добавить(ОбъектТовара);
		КонецЦикла;
		
	Иначе
		ЗапросТоваров = Новый Запрос;
		ЗапросТоваров.УстановитьПараметр("ТТН", СсылкаНаДок.ИсходныйДокумент);
		ЗАпросТоваров.Текст = 
		"ВЫБРАТЬ
		|	ЕГАИС_ТТНТовары.АлкогольнаяПродукция КАК Номенклатура,
		|	СУММА(ЕГАИС_ТТНТовары.Количество) КАК Количество
		|ПОМЕСТИТЬ ТоварыВОсновании
		|ИЗ
		|	Документ.ТТНВходящаяЕГАИС.Товары КАК ЕГАИС_ТТНТовары
		|ГДЕ
		|	ЕГАИС_ТТНТовары.Ссылка = &ТТН
		|
		|СГРУППИРОВАТЬ ПО
		|	ЕГАИС_ТТНТовары.АлкогольнаяПродукция
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СоответствиеНоменклатурыЕГАИС.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
		|	МАКСИМУМ(СоответствиеНоменклатурыЕГАИС.Номенклатура) КАК Номенклатура
		|ПОМЕСТИТЬ втТовары
		|ИЗ
		|	РегистрСведений.СоответствиеНоменклатурыЕГАИС КАК СоответствиеНоменклатурыЕГАИС
		|		
		|СГРУППИРОВАТЬ ПО
		|	СоответствиеНоменклатурыЕГАИС.АлкогольнаяПродукция
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	АлкогольнаяПродукция,
		|	Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Код, """") КАК alcocode,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Производитель.Наименование, """") КАК manufacturer,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Импортер.Наименование, """") КАК importer,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Объем, 0) КАК capacity,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Крепость, 0) КАК percent_alco,
		|	ВЫБОР
		|		КОГДА ЕГАИС_Номенклатура.ВидПродукции.Код ЕСТЬ NULL
		|			ТОГДА ЕСТЬNULL(ЕГАИС_Номенклатура.ВидПродукции.Код + "" "", """") + ЕСТЬNULL(ЕГАИС_Номенклатура.ВидПродукции.Наименование, """")
		|		ИНАЧЕ ЕСТЬNULL(Товары.Номенклатура.ВидАлкогольнойПродукции.Код + "" "", """") + ЕСТЬNULL(Товары.Номенклатура.ВидАлкогольнойПродукции.Наименование + "" "", """")
		|	КОНЕЦ КАК type_alco,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Наименование, """") КАК name,
		|	ЕСТЬNULL(ТоварыВОсновании.Номенклатура.Ссылка, ЗНАЧЕНИЕ(Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка)) КАК Ссылка
		|ИЗ
		|	ТоварыВОсновании КАК ТоварыВОсновании
		|		ЛЕВОЕ СОЕДИНЕНИЕ втТовары КАК Товары
		|		ПО (Товары.АлкогольнаяПродукция = ТоварыВОсновании.Номенклатура)
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_Номенклатура
		|		ПО ТоварыВОсновании.Номенклатура = ЕГАИС_Номенклатура.Ссылка";
		
		ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, ".ТТНВходящаяЕГАИС.Товары", "." + Шаблон.ВидДокумента + "." + Шаблон.ИмяТабличнойЧастиПодбор);
		ТаблицаТоваров = ЗапросТоваров.Выполнить().Выгрузить();
		Для каждого ВыборкаТоваров Из ТаблицаТоваров Цикл
			
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
			ОбъектТовара.id = "8e-" + XMLСтрока(ВыборкаТоваров.Ссылка);	
			ЗаполнитьЗначенияСвойств(ОбъектТовара, ВыборкаТоваров);
			ОбъектТовара.is_compared = ТоварСопоставленОдинКОдному(ВыборкаТоваров.Ссылка); 
			ОбъектТовара.box_coef = 0; // количество единиц в коробе
			
			ОбъектСписка.Добавить(ОбъектТовара);
			
		КонецЦикла;		
	КонецЕсли;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

// Загрузка данных дат разлива товара ЕГАИС.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа ТСД.
// ArtID - Строка - Id товара.
// Barcode - Строка - Штрихкод.
// PDFBarcode - Строка - Штрихкод PDF.
//
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция GetArtEgaisDateBottling(SN, UserName, DocOutID, ArtID, Barcode, PDFBarcode) Экспорт 
	
	ОбъектСписка = Новый Массив;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
	
	ДатаРозлива = Строка(ТекущаяДата());
	ОбъектСписка.Добавить(ДатаРозлива);
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);		
	
КонецФункции

// Получение данных по коробу/паллете в документе ЕГАИС.
//
// Параметры:
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// Barcode - Строка - Штрихкод.
// DocOutID - Строка - Id документа ТСД.
// Cell - Строка - Ячейка.
//
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция OnEgaisPalletScan(SN, UserName, Barcode, DocOutID, Cell) Экспорт 
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
		Возврат OnEgaisPalletScan_КТ2000(SN, UserName, Barcode, DocOutID, Cell);
	КонецЕсли;
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);  
	КонецЕсли;	
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Не нашли документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецПопытки;
	
	Шаблон = СсылкаНаДок.Шаблон;	
	ШаблонЕГАИС = Шаблон.ЕГАИС;	
	
	Если Не ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда
		
		//во входящей ттн упаковки в самом доке	
		Если ШаблонЕГАИС И Шаблон.ВидДокумента = "ТТНВходящаяЕГАИС" Тогда
			
			//ТЗМарок = ДатаМобайл_ОбщийМодуль.ПолучитьМаркиВходящейТТН_ЕГАИС(СсылкаНаДок.ИсходныйДокумент);
			
		Иначе	  
			
			//Упаковки из 1С
			
			ТЗМарок = ПолучитьТаблицуУпакованныхМарок(Barcode, Шаблон);
			
			Если ТЗМарок.Количество() > 0 Тогда
				
				Для каждого СтрокаДока Из ТЗМарок Цикл 
					
					СтруктураТекущейСтроки = Новый Структура;
					
					Если Шаблон.МаркировкаОнлайнПроверкаВложенностиУпаковок Тогда
						
						СтруктураТекущейСтроки.Вставить("box", "");  
						
						ОбъектТовараЕГАИС = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
												
						ОбъектТовараЕГАИС.id = "8e-" + XMLСтрока(СтрокаДока.АлкогольнаяПродукция);
						ОбъектТовараЕГАИС.name = ЧистаяСтрока(Лев(СтрокаДока.АлкогольнаяПродукция, 100)); 
						ОбъектТовараЕГАИС.alcocode = СтрокаДока.АлкогольнаяПродукция.Код;
						ОбъектТовараЕГАИС.is_compared = ТоварСопоставленОдинКОдному(СтрокаДока.АлкогольнаяПродукция);
						СтруктураТекущейСтроки.Вставить("egais_art", ОбъектТовараЕГАИС);	
						
						СтруктураТекущейСтроки.Вставить("pallet", "");
						СтруктураТекущейСтроки.Вставить("qty", СтрокаДока.Количество);				 
						
					Иначе
						
						qty = 1; 
						СтруктураТекущейСтроки.Вставить("qty", qty);
						СтруктураТекущейСтроки.Вставить("unit_qty", qty);
						
						ОбъектЕГАИС = ПолучитьСтруктуруОбъектаДляHttp("egais");
						ОбъектЕГАИС.mark = СтрокаДока.Марка;	
						СтруктураТекущейСтроки.Вставить("egais", ОбъектЕГАИС);
						
					КонецЕсли; 				 
					
					ОбъектСписка.Добавить(СтруктураТекущейСтроки); 				 
					
				КонецЦикла;	
			КонецЕсли;	
		КонецЕсли;
		
	Иначе
		
		ТЗМарок = ДатаМобайл_ОбщийМодуль.ПолучитьТаблицуУпакованныхМарокАСТ(Barcode);
		Для каждого СтрокаДока Из ТЗМарок Цикл	
			
			СтруктураТекущейСтроки = Новый Структура;
			
			qty = 1; 
			СтруктураТекущейСтроки.Вставить("qty", qty);
			СтруктураТекущейСтроки.Вставить("unit_qty", qty);
			
			ОбъектЕГАИС = ПолучитьСтруктуруОбъектаДляHttp("egais");
			ОбъектЕГАИС.mark = СтрокаДока.Марка;	
			СтруктураТекущейСтроки.Вставить("egais", ОбъектЕГАИС);
			
			Если ЗначениеЗаполнено(ОбъектЕГАИС.mark) Тогда				
				ОбъектСписка.Добавить(СтруктураТекущейСтроки);
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

#КонецОбласти

#Область ВспомогательныеПродедурыИФункции

#Область OnArtScan_OnArtMarkScan

// Идентификация и получение ячейки по товару при сканировании в подборе/приемке.
 //
 // Параметры:
 // Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон.
 // СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
 // УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
 // ОбъектСписка - Массив - Массив списка данных.
 // Запрос - Строка - Запрос.
 // Тип - Строка - подбираемая строка Select или Insert.
 // Ячейка - СправочникСсылка.Ячейки - Ячейка.
 //
Процедура OnArtScan_Select_Insert_Cells(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, Запрос, Тип, Ячейка)
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	РеквизитыШаблона = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ВидДокумента,ИмяТабличнойЧастиПодбор,ИмяТабличнойЧастиПриемка");
	
	ВидДокумента 				= РеквизитыШаблона.ВидДокумента;
	ИмяТабличнойЧастиПодбор 	= РеквизитыШаблона.ИмяТабличнойЧастиПодбор;
	ИмяТабличнойЧастиПриемка 	= РеквизитыШаблона.ИмяТабличнойЧастиПриемка;
	
	Если ВидДокумента = "ЗаданиеНаПеревозку" Тогда	
		ВидДокумента = "ЗаказКлиента";
		ИмяТабличнойЧастиПодбор = "Товары";
		ИмяТабличнойЧастиПриемка = "Товары";	
	КонецЕсли;
	
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
	|	ШтрихкодыНоменклатуры.Характеристика КАК Характеристика,
	|	ШтрихкодыНоменклатуры.Упаковка КАК Упаковка,
	|	ШтрихкодыНоменклатуры.Штрихкод КАК Штрихкод,
	|	ШтрихкодыНоменклатуры.Упаковка.Наименование КАК Наименование,
	|	ВЫБОР
	|		КОГДА ШтрихкодыНоменклатуры.Упаковка.Числитель = 0
	|				ИЛИ ШтрихкодыНоменклатуры.Упаковка.Числитель ЕСТЬ NULL
	|			ТОГДА 1
	|		ИНАЧЕ ШтрихкодыНоменклатуры.Упаковка.Числитель
	|	КОНЕЦ / ВЫБОР
	|		КОГДА ШтрихкодыНоменклатуры.Упаковка.Знаменатель = 0
	|				ИЛИ ШтрихкодыНоменклатуры.Упаковка.Знаменатель ЕСТЬ NULL
	|			ТОГДА 1
	|		ИНАЧЕ ШтрихкодыНоменклатуры.Упаковка.Знаменатель
	|	КОНЕЦ КАК Коэффициент
	|ПОМЕСТИТЬ ДоступныеТовары
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|ГДЕ
	|	(ШтрихкодыНоменклатуры.Штрихкод = &Штрихкод
	|			ИЛИ ШтрихкодыНоменклатуры.Штрихкод = &Штрихкод2
	|			ИЛИ ШтрихкодыНоменклатуры.Штрихкод = &ВесовойШтрихкод)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДатаМобайл_НовыеШтрихкоды.Номенклатура,
	|	ДатаМобайл_НовыеШтрихкоды.Характеристика,
	|	ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка),
	|	ДатаМобайл_НовыеШтрихкоды.ШтрихКод,
	|	ДатаМобайл_НовыеШтрихкоды.Наименование,
	|	ДатаМобайл_НовыеШтрихкоды.Коэффициент
	|ИЗ
	|	РегистрСведений.ДатаМобайл_НовыеШтрихкоды КАК ДатаМобайл_НовыеШтрихкоды
	|ГДЕ
	|	ДатаМобайл_НовыеШтрихкоды.ШтрихКод = &Штрихкод
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСД.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ДокументыСРезервамиТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД КАК ДатаМобайл_ДокументыТСД
	|ГДЕ	
	|	(ДатаМобайл_ДокументыТСД.Ссылка <> &ИсходноеЗадание)
	|		И (ДатаМобайл_ДокументыТСД.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1))
	|			И (ДатаМобайл_ДокументыТСД.Шаблон.РезервироватьТовар)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество,0)) КАК Количество
	|ПОМЕСТИТЬ ДанныеДокументыСРезервамиТСД
	|ИЗ
	|	ДокументыСРезервамиТСД КАК ДокументыСРезервамиТСД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|		ПО ДокументыСРезервамиТСД.Ссылка = ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество * (ВЫБОР
	|							КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель = 0
	|									ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель ЕСТЬ NULL
	|								ТОГДА 1
	|							ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель
	|						КОНЕЦ / ВЫБОР
	|							КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель = 0
	|									ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель ЕСТЬ NULL
	|								ТОГДА 1
	|							ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель
	|						КОНЕЦ), 0)) КАК ВРезервеТСД
	|ПОМЕСТИТЬ ТоварыСРезервамиТСД
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДанныеДокументыСРезервамиТСД КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|		ПО ДоступныеТовары.Характеристика = ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры
	|			И ДоступныеТовары.Упаковка = ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения
	|				И ДоступныеТовары.Номенклатура = ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура							
	|
	|СГРУППИРОВАТЬ ПО
	|	ДоступныеТовары.Упаковка,
	|	ДоступныеТовары.Характеристика,
	|	ДоступныеТовары.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(ЕСТЬNULL(ТоварыВЯчейкахОстатки.ВНаличииОстаток * (ВЫБОР
	|				КОГДА ТоварыВЯчейкахОстатки.Упаковка.Числитель = 0
	|						ИЛИ ТоварыВЯчейкахОстатки.Упаковка.Числитель ЕСТЬ NULL
	|					ТОГДА 1
	|				ИНАЧЕ ТоварыВЯчейкахОстатки.Упаковка.Числитель
	|			КОНЕЦ / ВЫБОР
	|				КОГДА ТоварыВЯчейкахОстатки.Упаковка.Знаменатель = 0
	|						ИЛИ ТоварыВЯчейкахОстатки.Упаковка.Знаменатель ЕСТЬ NULL
	|					ТОГДА 1
	|				ИНАЧЕ ТоварыВЯчейкахОстатки.Упаковка.Знаменатель
	|			КОНЕЦ), 0)) КАК ВНаличии,
	|	СУММА(ЕСТЬNULL(ТоварыВЯчейкахОстатки.КОтборуОстаток * (ВЫБОР
	|				КОГДА ТоварыВЯчейкахОстатки.Упаковка.Числитель = 0
	|						ИЛИ ТоварыВЯчейкахОстатки.Упаковка.Числитель ЕСТЬ NULL
	|					ТОГДА 1
	|				ИНАЧЕ ТоварыВЯчейкахОстатки.Упаковка.Числитель
	|			КОНЕЦ / ВЫБОР
	|				КОГДА ТоварыВЯчейкахОстатки.Упаковка.Знаменатель = 0
	|						ИЛИ ТоварыВЯчейкахОстатки.Упаковка.Знаменатель ЕСТЬ NULL
	|					ТОГДА 1
	|				ИНАЧЕ ТоварыВЯчейкахОстатки.Упаковка.Знаменатель
	|			КОНЕЦ), 0)) КАК ВРезерве,
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка
	|ПОМЕСТИТЬ ТоварыСОстатками1С
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыВЯчейках.Остатки(
	|				,
	|				(&ВсеЯчейки
	|					ИЛИ Ячейка = &Ячейка)) КАК ТоварыВЯчейкахОстатки
	|		ПО ДоступныеТовары.Номенклатура = ТоварыВЯчейкахОстатки.Номенклатура
	|			И ДоступныеТовары.Характеристика = ТоварыВЯчейкахОстатки.Характеристика
	|
	|СГРУППИРОВАТЬ ПО
	|	ДоступныеТовары.Характеристика,
	|	ДоступныеТовары.Номенклатура,
	|	ДоступныеТовары.Упаковка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) / ВЫБОР
	|				КОГДА ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель, 0) = 0
	|					ТОГДА 1
	|				ИНАЧЕ ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель
	|			КОНЕЦ КАК ЧИСЛО(19, 2))) КАК Цена
	|ПОМЕСТИТЬ ТоварыСЦенами
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ТекущаяДата, ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
	|		ПО ДоступныеТовары.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
	|			И ДоступныеТовары.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
	|
	|СГРУППИРОВАТЬ ПО
	|	ДоступныеТовары.Номенклатура,
	|	ДоступныеТовары.Характеристика,
	|	ДоступныеТовары.Упаковка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,
	|	ДоступныеТовары.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
	|	ДоступныеТовары.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	|	ДоступныеТовары.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
	|	ДоступныеТовары.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ДоступныеТовары.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
	|	ДоступныеТовары.Характеристика.Наименование КАК НаименованиеХарактеристики,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	ТоварыСОстатками1С.ВНаличии КАК ВНаличии,
	|	ТоварыСОстатками1С.ВРезерве КАК ВРезерве,
	|	ТоварыСРезервамиТСД.ВРезервеТСД КАК ВРезервеТСД,
	|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена,
	|	ЕСТЬNULL(ДоступныеТовары.Наименование, ДоступныеТовары.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
	|	ЕСТЬNULL(ДоступныеТовары.Коэффициент, 1) КАК Коэффициент,
	|	ВЫБОР
	|		КОГДА &ВключатьАртикул
	|				И ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(Справочник.Номенклатура)
	|			ТОГДА ДоступныеТовары.Номенклатура.Артикул + ""-""
	|		ИНАЧЕ """"
	|	КОНЕЦ + ДоступныеТовары.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ДоступныеТовары.Характеристика.Наименование, """") КАК НаименованиеТовара,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(справочник.номенклатура)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЭтоНовыйТовар
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСРезервамиТСД КАК ТоварыСРезервамиТСД
	|		ПО ДоступныеТовары.Характеристика = ТоварыСРезервамиТСД.Характеристика
	|			И ДоступныеТовары.Номенклатура = ТоварыСРезервамиТСД.Номенклатура
	|			И ДоступныеТовары.Упаковка = ТоварыСРезервамиТСД.Упаковка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСОстатками1С КАК ТоварыСОстатками1С
	|		ПО ДоступныеТовары.Номенклатура = ТоварыСОстатками1С.Номенклатура
	|			И ДоступныеТовары.Характеристика = ТоварыСОстатками1С.Характеристика
	|			И ДоступныеТовары.Упаковка = ТоварыСОстатками1С.Упаковка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
	|		ПО ДоступныеТовары.Номенклатура = ТоварыСЦенами.Номенклатура
	|			И ДоступныеТовары.Характеристика = ТоварыСЦенами.Характеристика
	|			И ДоступныеТовары.Упаковка = ТоварыСЦенами.Упаковка
	|";
	
	СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "OnArtScan_Select_Insert_Cells");
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ОтборРазмещениеТоваров.", "." + ВидДокумента + ".");
	
	Если УзелПО.ИспользоватьАртикулКакШтрихкодТовара Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "	ДатаМобайл_НовыеШтрихкоды.ШтрихКод = &Штрихкод",
		"	ДатаМобайл_НовыеШтрихкоды.ШтрихКод = &Штрихкод
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	Номенклатура.Ссылка,  
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка),
		|	ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка),
		|	Номенклатура.Артикул,
		|	Номенклатура.Ссылка.ЕдиницаИзмерения.Наименование,
		|	1
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|	ГДЕ 
		|	 НЕ Номенклатура.ПометкаУдаления
		|	 И НЕ Номенклатура.ЭтоГруппа
		|	 И Номенклатура.Артикул = &Штрихкод");
		
	КонецЕсли;	
	
	ТекущаяЯчейкаСсылка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(Ячейка, СсылкаНаДок);
	
	Запрос.УстановитьПараметр("Ячейка", ТекущаяЯчейкаСсылка);
	Запрос.УстановитьПараметр("ВсеЯчейки", Ложь);
	
	Если Тип = "Select" Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыОтбор КАК", "." + ИмяТабличнойЧастиПодбор + " КАК");
	Иначе 
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыОтбор КАК", "." + ИмяТабличнойЧастиПриемка + " КАК");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор", "Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПриемка");	
	КонецЕсли;
		
КонецПроцедуры

 // Идентификация и получение обычного объекта товара при сканировании в подборе/приемке.
 //
 // Параметры:
 // Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон.
 // СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
 // УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
 // ОбъектСписка - Массив - Массив списка данных.
 // Запрос - Строка - Запрос.
 // Тип - Строка - подбираемая строка Select или Insert.
 //
Процедура OnArtScan_Select_Insert_Casual(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, Запрос, Тип)
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	РеквизитыШаблона = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ВидДокумента,ИмяТабличнойЧастиПодбор,ИмяТабличнойЧастиПриемка");
	
	ВидДокумента 				= РеквизитыШаблона.ВидДокумента;
	ИмяТабличнойЧастиПодбор 	= РеквизитыШаблона.ИмяТабличнойЧастиПодбор;
	ИмяТабличнойЧастиПриемка 	= РеквизитыШаблона.ИмяТабличнойЧастиПриемка;
	
	Если ВидДокумента = "ЗаданиеНаПеревозку" Тогда	
		ВидДокумента = "ЗаказКлиента";
		ИмяТабличнойЧастиПодбор = "Товары";
		ИмяТабличнойЧастиПриемка = "Товары";	
	КонецЕсли;
	
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
	|	ШтрихкодыНоменклатуры.Характеристика КАК Характеристика,
	|	ШтрихкодыНоменклатуры.Упаковка КАК Упаковка,
	|	ШтрихкодыНоменклатуры.Штрихкод КАК Штрихкод,
	|	ШтрихкодыНоменклатуры.Упаковка.Наименование КАК Наименование,
	|	ВЫБОР
	|		КОГДА ШтрихкодыНоменклатуры.Упаковка.Числитель = 0
	|				ИЛИ ШтрихкодыНоменклатуры.Упаковка.Числитель ЕСТЬ NULL
	|			ТОГДА 1
	|		ИНАЧЕ ШтрихкодыНоменклатуры.Упаковка.Числитель
	|	КОНЕЦ / ВЫБОР
	|		КОГДА ШтрихкодыНоменклатуры.Упаковка.Знаменатель = 0
	|				ИЛИ ШтрихкодыНоменклатуры.Упаковка.Знаменатель ЕСТЬ NULL
	|			ТОГДА 1
	|		ИНАЧЕ ШтрихкодыНоменклатуры.Упаковка.Знаменатель
	|	КОНЕЦ КАК Коэффициент
	|ПОМЕСТИТЬ ДоступныеТовары
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|ГДЕ
	|	(ШтрихкодыНоменклатуры.Штрихкод = &Штрихкод
	|			ИЛИ ШтрихкодыНоменклатуры.Штрихкод = &Штрихкод2
	|			ИЛИ ШтрихкодыНоменклатуры.Штрихкод = &ВесовойШтрихкод)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДатаМобайл_НовыеШтрихкоды.Номенклатура,
	|	ДатаМобайл_НовыеШтрихкоды.Характеристика,
	|	ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка),
	|	ДатаМобайл_НовыеШтрихкоды.ШтрихКод,
	|	ДатаМобайл_НовыеШтрихкоды.Наименование,
	|	ДатаМобайл_НовыеШтрихкоды.Коэффициент
	|ИЗ
	|	РегистрСведений.ДатаМобайл_НовыеШтрихкоды КАК ДатаМобайл_НовыеШтрихкоды
	|ГДЕ
	|	ДатаМобайл_НовыеШтрихкоды.ШтрихКод = &Штрихкод
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Номенклатура.Ссылка,
	|	ВЫБОР КОГДА ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL ТОГДА ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.) ИНАЧЕ ХарактеристикиНоменклатуры.Ссылка Конец,
	|	ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка),
	|	Номенклатура.Артикул,
	|	Номенклатура.ЕдиницаИзмерения.Наименование,
	|	1
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|		ПО (Номенклатура.ВидНоменклатуры = ХарактеристикиНоменклатуры.Владелец)
	|ГДЕ
	|	Номенклатура.Артикул = &Артикул
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) / ВЫБОР
	|				КОГДА ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель, 0) = 0
	|					ТОГДА 1
	|				ИНАЧЕ ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель
	|			КОНЕЦ КАК ЧИСЛО(19, 2))) КАК Цена
	|ПОМЕСТИТЬ ТоварыСЦенами
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ТекущаяДата, ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
	|		ПО ДоступныеТовары.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
	|			И ДоступныеТовары.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
	|
	|СГРУППИРОВАТЬ ПО
	|	ДоступныеТовары.Номенклатура,
	|	ДоступныеТовары.Характеристика,
	|	ДоступныеТовары.Упаковка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,
	|	ДоступныеТовары.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
	|	ДоступныеТовары.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	|	ДоступныеТовары.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
	|	ДоступныеТовары.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ДоступныеТовары.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
	|	ДоступныеТовары.Характеристика.Наименование КАК НаименованиеХарактеристики, 
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена,
	|	ЕСТЬNULL(ДоступныеТовары.Наименование, ДоступныеТовары.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
	|	ЕСТЬNULL(ДоступныеТовары.Коэффициент, 1) КАК Коэффициент,
	|	ВЫБОР
	|		КОГДА &ВключатьАртикул
	|				И ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(Справочник.Номенклатура)
	|			ТОГДА ВЫБОР
	|					КОГДА ДоступныеТовары.Номенклатура.Артикул = """"
	|						ТОГДА """"
	|					ИНАЧЕ ДоступныеТовары.Номенклатура.Артикул + "" ""
	|				КОНЕЦ
	|		ИНАЧЕ """"
	|	КОНЕЦ + ДоступныеТовары.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ДоступныеТовары.Характеристика.Наименование, """") КАК НаименованиеТовара,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(справочник.номенклатура)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЭтоНовыйТовар
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
	|		ПО ДоступныеТовары.Номенклатура = ТоварыСЦенами.Номенклатура
	|			И ДоступныеТовары.Характеристика = ТоварыСЦенами.Характеристика
	|			И ДоступныеТовары.Упаковка = ТоварыСЦенами.Упаковка
	|";
	
	СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "OnArtScan_Select_Insert_Casual");
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ПриобретениеТоваровУслуг.", "." + ВидДокумента + ".");
	
	Если ВидДокумента = "ОприходованиеИзлишковТоваров" Или ВидДокумента = "СписаниеНедостачТоваров" Или (ВидДокумента = "РасходныйОрдерНаТовары" И ИмяТабличнойЧастиПодбор = "ТоварыПоРаспоряжениям") Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ДоступныеТовары.Упаковка = Документ1С.Упаковка", "ИСТИНА");	
	КонецЕсли;
	
	Если ВидДокумента = "ПеремаркировкаТоваровИСМП" Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ДоступныеТовары.Упаковка = Документ1С.Упаковка", "ИСТИНА");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "Документ1С.Количество", 0);
	КонецЕсли; 
	
	Если Тип = "Select" Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК", "." + ИмяТабличнойЧастиПодбор + " КАК");
	Иначе 
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК", "." + ИмяТабличнойЧастиПриемка + " КАК");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор", "Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПриемка");	
	КонецЕсли;
		
КонецПроцедуры

// Идентификация и получение объекта товара ЕГАИС при сканировании в подборе.
//
// Параметры:
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// ОбъектСписка - Массив - Массив списка данных.
// Запрос - Строка - Запрос.
// Тип - Строка - подбираемая строка Select или Insert.
//
Процедура OnArtScan_Select_EGAIS(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, Запрос, Тип)
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
		|	ШтрихкодыНоменклатуры.Характеристика,
		|	ШтрихкодыНоменклатуры.Упаковка,
		|	ШтрихкодыНоменклатуры.Штрихкод,
		|	ШтрихкодыНоменклатуры.Упаковка.Наименование КАК Наименование,
		|	ВЫБОР
		|		КОГДА ШтрихкодыНоменклатуры.Упаковка.Числитель = 0
		|			ТОГДА 1
		|		ИНАЧЕ ШтрихкодыНоменклатуры.Упаковка.Числитель
		|	КОНЕЦ / ВЫБОР
		|		КОГДА ШтрихкодыНоменклатуры.Упаковка.Знаменатель = 0
		|			ТОГДА 1
		|		ИНАЧЕ ШтрихкодыНоменклатуры.Упаковка.Знаменатель
		|	КОНЕЦ КАК Коэффициент
		|ПОМЕСТИТЬ ДоступныеТовары
		|ИЗ
		|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
		|ГДЕ
		|	ШтрихкодыНоменклатуры.Штрихкод = &Штрихкод
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДатаМобайл_НовыеШтрихкоды.Номенклатура,
		|	ДатаМобайл_НовыеШтрихкоды.Характеристика,
		|	ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка),
		|	ДатаМобайл_НовыеШтрихкоды.ШтрихКод,
		|	ДатаМобайл_НовыеШтрихкоды.Наименование,
		|	ДатаМобайл_НовыеШтрихкоды.Коэффициент
		|ИЗ
		|	РегистрСведений.ДатаМобайл_НовыеШтрихкоды КАК ДатаМобайл_НовыеШтрихкоды
		|ГДЕ
		|	ДатаМобайл_НовыеШтрихкоды.ШтрихКод = &Штрихкод
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДоступныеТовары.Номенклатура,
		|	ДоступныеТовары.Характеристика,
		|	ДоступныеТовары.Упаковка,
		|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) / ВЫБОР
		|				КОГДА ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель, 0) = 0
		|					ТОГДА 1
		|				ИНАЧЕ ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель
		|			КОНЕЦ КАК ЧИСЛО(19, 2))) КАК Цена
		|ПОМЕСТИТЬ ТоварыСЦенами
		|ИЗ
		|	ДоступныеТовары КАК ДоступныеТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ТекущаяДата, ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
		|		ПО ДоступныеТовары.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
		|			И ДоступныеТовары.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
		|			И (ДоступныеТовары.Номенклатура.ИспользоватьУпаковки
		|				ИЛИ ДоступныеТовары.Упаковка = ЦеныНоменклатурыСрезПоследних.Упаковка)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДоступныеТовары.Номенклатура,
		|	ДоступныеТовары.Характеристика,
		|	ДоступныеТовары.Упаковка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДоступныеТовары.Номенклатура, 
		|	ДоступныеТовары.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,
		|	ДоступныеТовары.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
		|	ДоступныеТовары.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
		|	ДоступныеТовары.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
		|	ДоступныеТовары.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
		|	ДоступныеТовары.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
		|	ДоступныеТовары.Характеристика.Наименование КАК НаименованиеХарактеристики,
		|	ДоступныеТовары.Характеристика,
		|	ДоступныеТовары.Упаковка,
		|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена,
		|	ЕСТЬNULL(ДоступныеТовары.Наименование, ДоступныеТовары.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
		|	ЕСТЬNULL(ДоступныеТовары.Коэффициент, 1) КАК Коэффициент,
		|	ВЫБОР
		|		КОГДА &ВключатьАртикул
		|				И ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(Справочник.Номенклатура)
		|			ТОГДА ДоступныеТовары.Номенклатура.Артикул + ""-""
		|		ИНАЧЕ """"
		|	КОНЕЦ + ДоступныеТовары.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ДоступныеТовары.Характеристика.Наименование, """") КАК НаименованиеТовара,
		|	ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(справочник.номенклатура)
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК ЭтоНовыйТовар
		|ИЗ
		|	ДоступныеТовары КАК ДоступныеТовары
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
		|		ПО ДоступныеТовары.Номенклатура = ТоварыСЦенами.Номенклатура
		|			И ДоступныеТовары.Характеристика = ТоварыСЦенами.Характеристика
		|			И ДоступныеТовары.Упаковка = ТоварыСЦенами.Упаковка");
		
	ИначеЕсли ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
		|	ШтрихкодыНоменклатуры.Характеристика,
		|	ШтрихкодыНоменклатуры.Упаковка,
		|	ШтрихкодыНоменклатуры.Штрихкод,
		|	ШтрихкодыНоменклатуры.Упаковка.Наименование КАК Наименование,
		|	ВЫБОР
		|		КОГДА ШтрихкодыНоменклатуры.Упаковка.Числитель = 0
		|			ТОГДА 1
		|		ИНАЧЕ ШтрихкодыНоменклатуры.Упаковка.Числитель
		|	КОНЕЦ / ВЫБОР
		|		КОГДА ШтрихкодыНоменклатуры.Упаковка.Знаменатель = 0
		|			ТОГДА 1
		|		ИНАЧЕ ШтрихкодыНоменклатуры.Упаковка.Знаменатель
		|	КОНЕЦ КАК Коэффициент
		|ПОМЕСТИТЬ ДоступныеТовары
		|ИЗ
		|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
		|ГДЕ
		|	ШтрихкодыНоменклатуры.Штрихкод = &Штрихкод
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДатаМобайл_НовыеШтрихкоды.Номенклатура,
		|	ДатаМобайл_НовыеШтрихкоды.Характеристика,
		|	ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка),
		|	ДатаМобайл_НовыеШтрихкоды.ШтрихКод,
		|	ДатаМобайл_НовыеШтрихкоды.Наименование,
		|	ДатаМобайл_НовыеШтрихкоды.Коэффициент
		|ИЗ
		|	РегистрСведений.ДатаМобайл_НовыеШтрихкоды КАК ДатаМобайл_НовыеШтрихкоды
		|ГДЕ
		|	ДатаМобайл_НовыеШтрихкоды.ШтрихКод = &Штрихкод
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДоступныеТовары.Номенклатура,
		|	ДоступныеТовары.Характеристика,
		|	ДоступныеТовары.Упаковка,
		|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) / ВЫБОР
		|				КОГДА ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель, 0) = 0
		|					ТОГДА 1
		|				ИНАЧЕ ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель
		|			КОНЕЦ КАК ЧИСЛО(19, 2))) КАК Цена
		|ПОМЕСТИТЬ ТоварыСЦенами
		|ИЗ
		|	ДоступныеТовары КАК ДоступныеТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ТекущаяДата, ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
		|		ПО ДоступныеТовары.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
		|			И ДоступныеТовары.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
		|			И (ДоступныеТовары.Номенклатура.ИспользоватьУпаковки
		|				ИЛИ ДоступныеТовары.Упаковка = ЦеныНоменклатурыСрезПоследних.Упаковка)
		|
		|СГРУППИРОВАТЬ ПО
		|	ДоступныеТовары.Номенклатура,
		|	ДоступныеТовары.Характеристика,
		|	ДоступныеТовары.Упаковка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДоступныеТовары.Номенклатура,
		|	ДоступныеТовары.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,
		|	ДоступныеТовары.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
		|	ДоступныеТовары.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
		|	ДоступныеТовары.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
		|	ДоступныеТовары.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
		|	ДоступныеТовары.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
		|	ДоступныеТовары.Характеристика.Наименование КАК НаименованиеХарактеристики,
		|	ДоступныеТовары.Характеристика,
		|	ДоступныеТовары.Упаковка,
		|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена,
		|	ЕСТЬNULL(ДоступныеТовары.Наименование, ДоступныеТовары.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
		|	ЕСТЬNULL(ДоступныеТовары.Коэффициент, 1) КАК Коэффициент,
		|	ВЫБОР
		|		КОГДА &ВключатьАртикул
		|				И ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(Справочник.Номенклатура)
		|			ТОГДА ВЫБОР КОГДА ДоступныеТовары.Номенклатура.Артикул = """" ТОГДА """" ИНАЧЕ ДоступныеТовары.Номенклатура.Артикул + "" "" КОНЕЦ
		|		ИНАЧЕ """"
		|	КОНЕЦ + ДоступныеТовары.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ДоступныеТовары.Характеристика.Наименование, """") КАК НаименованиеТовара,
		|	ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(справочник.номенклатура)
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК ЭтоНовыйТовар
		|ИЗ
		|	ДоступныеТовары КАК ДоступныеТовары
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
		|		ПО ДоступныеТовары.Номенклатура = ТоварыСЦенами.Номенклатура
		|			И ДоступныеТовары.Характеристика = ТоварыСЦенами.Характеристика
		|			И ДоступныеТовары.Упаковка = ТоварыСЦенами.Упаковка");
		
	Иначе		
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
		|	ШтрихкодыНоменклатуры.Характеристика,
		|	ШтрихкодыНоменклатуры.Упаковка,
		|	ШтрихкодыНоменклатуры.Штрихкод,
		|	ШтрихкодыНоменклатуры.Упаковка.Наименование КАК Наименование,
		|	ВЫБОР
		|		КОГДА ШтрихкодыНоменклатуры.Упаковка.Числитель = 0
		|			ТОГДА 1
		|		ИНАЧЕ ШтрихкодыНоменклатуры.Упаковка.Числитель
		|	КОНЕЦ / ВЫБОР
		|		КОГДА ШтрихкодыНоменклатуры.Упаковка.Знаменатель = 0
		|			ТОГДА 1
		|		ИНАЧЕ ШтрихкодыНоменклатуры.Упаковка.Знаменатель
		|	КОНЕЦ КАК Коэффициент
		|ПОМЕСТИТЬ ДоступныеТовары
		|ИЗ
		|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
		|ГДЕ
		|	ШтрихкодыНоменклатуры.Штрихкод = &Штрихкод
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	ДатаМобайл_НовыеШтрихкоды.Номенклатура,
		|	ДатаМобайл_НовыеШтрихкоды.Характеристика,
		|	ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка),
		|	ДатаМобайл_НовыеШтрихкоды.ШтрихКод,
		|	ДатаМобайл_НовыеШтрихкоды.Наименование,
		|	ДатаМобайл_НовыеШтрихкоды.Коэффициент
		|ИЗ
		|	РегистрСведений.ДатаМобайл_НовыеШтрихкоды КАК ДатаМобайл_НовыеШтрихкоды
		|ГДЕ
		|	ДатаМобайл_НовыеШтрихкоды.ШтрихКод = &Штрихкод
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДоступныеТовары.Номенклатура,
		|	ДоступныеТовары.Характеристика,
		|	ДоступныеТовары.Упаковка,
		|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) / ВЫБОР
		|				КОГДА ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель, 0) = 0
		|					ТОГДА 1
		|				ИНАЧЕ ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель
		|			КОНЕЦ КАК ЧИСЛО(19, 2))) КАК Цена	
		|ПОМЕСТИТЬ ТоварыСЦенами
		|ИЗ
		|	ДоступныеТовары КАК ДоступныеТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ТекущаяДата, ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
		|		ПО ДоступныеТовары.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
		|			И ДоступныеТовары.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
		|
		|СГРУППИРОВАТЬ ПО
		|	ДоступныеТовары.Номенклатура,
		|	ДоступныеТовары.Характеристика,
		|	ДоступныеТовары.Упаковка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДоступныеТовары.Номенклатура, 
		|	ДоступныеТовары.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,
		|	ДоступныеТовары.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
		|	ДоступныеТовары.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
		|	ДоступныеТовары.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
		|	ДоступныеТовары.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
		|	ДоступныеТовары.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
		|	ДоступныеТовары.Характеристика.Наименование КАК НаименованиеХарактеристики,
		|	ДоступныеТовары.Характеристика,
		|	ДоступныеТовары.Упаковка,
		|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена,
		|	ЕСТЬNULL(ДоступныеТовары.Наименование, ДоступныеТовары.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
		|	ЕСТЬNULL(ДоступныеТовары.Коэффициент, 1) КАК Коэффициент,
		|	ВЫБОР
		|		КОГДА &ВключатьАртикул
		|				И ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(Справочник.Номенклатура)
		|			ТОГДА ВЫБОР КОГДА ДоступныеТовары.Номенклатура.Артикул = """" ТОГДА """" ИНАЧЕ ДоступныеТовары.Номенклатура.Артикул + "" "" КОНЕЦ
		|		ИНАЧЕ """"
		|	КОНЕЦ + ДоступныеТовары.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ДоступныеТовары.Характеристика.Наименование, """") КАК НаименованиеТовара,
		|	ВЫБОР
		|		КОГДА ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(справочник.номенклатура)
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА
		|	КОНЕЦ КАК ЭтоНовыйТовар
		|ИЗ
		|	ДоступныеТовары КАК ДоступныеТовары
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
		|		ПО ДоступныеТовары.Номенклатура = ТоварыСЦенами.Номенклатура
		|			И ДоступныеТовары.Характеристика = ТоварыСЦенами.Характеристика
		|			И ДоступныеТовары.Упаковка = ТоварыСЦенами.Упаковка";
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ПриобретениеТоваровУслуг.", "." + Шаблон.ВидДокумента + ".");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК");
		
	КонецЕсли;
	
	СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "OnArtScan_Select_EGAIS");
	
КонецПроцедуры

// Идентификация и получение марки товара при сканировании.
//
// Параметры:
// Params - Структура - Структура данных.
// kiz - Структура - Структура данных КИЗ.
// ТипОперации - Строка - Тип операции ("Select"/"Insert").
//
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция OnArtMarkScan(Params, kiz = Неопределено, ТипОперации)
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	deviceId 		=  Params.device_id;
	UserName 		=  Params.username;
	KM_Barcode 		=  kiz.mark;
	KM_GTIN 		=  kiz.gtin;
	DocOutID 		=  Params.doc_id;
	Ячейка 			=  Params.cell_barcode;
	KM_SN 			=  kiz.sn;
	EAN 			=  kiz.ean;
	KM_RawBarcode 	=  kiz.raw_barcode;
	GS1 			=  Params.gs1;
	
	KM_GTIN = УдалитьЛидирующиеНули(KM_GTIN);
	
	УзелПО = НайтиУзел(deviceId);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(deviceId, UserName);
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Не нашли документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	
	ЗначенияРеквизитовСсылкаНаДок = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок, "ТСД, ДатаНачалаСбора, ДатаЗавершенияСбора, Шаблон, ИсходныйДокумент, Склад");
	
	ДокТСД 						= ЗначенияРеквизитовСсылкаНаДок.ТСД;
	ДокДатаНачалаСбора 			= ЗначенияРеквизитовСсылкаНаДок.ДатаНачалаСбора;
	ДокДатаЗавершенияСбора 		= ЗначенияРеквизитовСсылкаНаДок.ДатаЗавершенияСбора;
	Шаблон 						= ЗначенияРеквизитовСсылкаНаДок.Шаблон;
	ИсходныйДокумент 			= ЗначенияРеквизитовСсылкаНаДок.ИсходныйДокумент;
	Склад  						= ЗначенияРеквизитовСсылкаНаДок.Склад;
		
	Если ЗначениеЗаполнено(Ячейка) Тогда
		ТекущаяЯчейкаСсылка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(Ячейка, СсылкаНаДок);
	Иначе
		ТекущаяЯчейкаСсылка = Неопределено;
	КонецЕсли; 	
	
	Если Шаблон = Неопределено Тогда	
		СтруктураОтвета.Вставить("Описание", "Не нашли запись документа. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ДокТСД) Тогда
		Если ДокТСД <> УзелПО Тогда		
			СтруктураОтвета.Вставить("Описание", "Чужой документ. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
		КонецЕсли;	
	КонецЕсли;
	
	Если ДокДатаЗавершенияСбора <> Дата(1,1,1) Тогда		
		СтруктураОтвета.Вставить("Описание", "Закрытый документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	ЗначениеШтрихкода = "";
	ТаблицаТоваров = ПолучитьТоварыБезЗадания(УзелПО, СсылкаНаДок, KM_Barcode, GS1, ЗначениеШтрихкода);	
	КодМаркировкиНеНайден = Истина;  
	ПроверкаОСГ = Шаблон.ПроверкаОСГ;
	ДобавлятьКоличествоПоЗаданиюКОстатку = Шаблон.ДобавлятьКоличествоПоЗаданиюКОстатку;
	
	Тип_Услуга = Перечисления.ТипыНоменклатуры.Услуга;
	
	ЗапросОписаниеGTINИС = Новый Запрос;
	ЗапросОписаниеGTINИС.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	| ОписаниеGTINИС.КоличествоПотребительскихУпаковок КАК КоличествоПотребительскихУпаковок
	|ИЗ
	| РегистрСведений.ОписаниеGTINИС КАК ОписаниеGTINИС
	|ГДЕ
	| ОписаниеGTINИС.GTIN ПОДОБНО ""%"" + &GTIN";
	
	СкорректироватьЗапросЕслиЕстьРегистрСведенийОписаниеGTINИС(ЗапросОписаниеGTINИС.Текст, "OnArtMarkScan");
	
	Для каждого СтрокаДока Из ТаблицаТоваров Цикл
		
		Если СтрНайти(СтрокаДока.ЗначениеШтрихкода, ЗначениеШтрихкода) = 0 Или ЗначениеШтрихкода = "" Тогда
			Продолжить;
		Иначе
			КодМаркировкиНеНайден = Ложь;	
		КонецЕсли;
		
		СтрокаДока.Коэффициент = ?(СтрокаДока.Коэффициент = 0, 1, СтрокаДока.Коэффициент);
		СтрокаДока.НаименованиеУпаковки = ?(ЗначениеЗаполнено(СтрокаДока.НаименованиеУпаковки), СтрокаДока.НаименованиеУпаковки, "шт.");
		
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan");
		
		ОбъектТовара.name 	   = ЧистаяСтрока(СокрП(СтрокаДока.НаименованиеТовара));
		ОбъектТовара.id 	   = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
		ОбъектТовара.price 	   = СтрокаДока.Цена;
		
		// Выгрузка дополнительных видов цен
		ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Характеристика);
		
		Попытка	 
			DMUseSN = ПолучитьПризнакУчетаСерий(СтрокаДока.ВидНоменклатуры, Склад);
		Исключение
			DMUseSN = Ложь;
		КонецПопытки;	
		
		СформироватьЗаголовкиJSONParamsТовара(УзелПО,ОбъектТовара,СтрокаДока, DMUseSN,Шаблон);
		
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		Попытка
			ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");
			
			//В маркировке не выбираем упаковки (единицы измерения), иначе получаем коэффициент вложенности тут, особенно для групповых упаковок КМ
			//ЗаполнитьОбъектУпаковки(УзелПО,ОбъектШтрихкода,СтрокаДока.Упаковка,СтрокаДока.Номенклатура);
			
			Попытка 
				ОбъектШтрихкода.unit_name = СтрокаДока.НаименованиеУпаковки; 
			Исключение 
				ОбъектШтрихкода.unit_name = "шт."; 
			КонецПопытки;
			
			Если УзелПО.НеИспользоватьПересчетУпаковок Тогда
				ОбъектШтрихкода.unit_coef = 1;
			Иначе
				ЗапросОписаниеGTINИС.УстановитьПараметр("GTIN", KM_GTIN);
				РезультатЗапроса = ЗапросОписаниеGTINИС.Выполнить();
				
				Если Не РезультатЗапроса.Пустой() Тогда
					
					Выборка = РезультатЗапроса.Выбрать();
					
					Пока Выборка.Следующий() Цикл							
						КоличествоПотребительскихУпаковок = Выборка.КоличествоПотребительскихУпаковок; 	
					КонецЦикла; 
					
					ОбъектШтрихкода.unit_coef = КоличествоПотребительскихУпаковок;
					
				Иначе
					ОбъектШтрихкода.unit_coef = СтрокаДока.Коэффициент;
				КонецЕсли;
			КонецЕсли;
			
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
		Исключение
		Конецпопытки;
		
		//Серия 
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда 
				sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;	
		Исключение
		КонецПопытки;
		
		Попытка
			ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускВесовогоТовара = Неопределено;
		КонецПопытки;
		
		Если ДопускВесовогоТовара <> Неопределено Тогда
			СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
		КонецЕсли;
		
		Попытка
			ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускОСГ = Неопределено;
		КонецПопытки;
		
		Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
			СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
		КонецЕсли;
		
		ЭтоУслуга = Ложь;
		Попытка               
			Если СтрокаДока.ВидНоменклатурыТипНоменклатуры = Тип_Услуга Тогда
				ЭтоУслуга = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		ИначеЕсли ЭтоУслуга Тогда
			limit_qty = 999;	
		Иначе			 
			limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, СтрокаДока.Характеристика, ТекущаяЯчейкаСсылка, Неопределено);
			
			Если ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
				limit_qty = limit_qty + ПолучитьЗадание(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, СтрокаДока.Характеристика, ТекущаяЯчейкаСсылка, Неопределено, ТипОперации);		 
			КонецЕсли;	
		КонецЕсли;
		
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		
		Если СокрЛП(ЧистаяСтрока(ОбъектТовара.name)) = "" Или СокрЛП(ЧистаяСтрока(ОбъектТовара.id)) = "" Тогда
			Продолжить;
		КонецЕсли;
				
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		
	КонецЦикла;
	
	Если КодМаркировкиНеНайден Тогда	
		Если Не Шаблон.МаркировкаДополнительныйПоискПоКМ Тогда
			Если Лев(KM_GTIN,2) = "29" Тогда
				Возврат ПодготовитьОтветJSON(ОбъектСписка)
			КонецЕсли;
					
			Если ТипОперации = "Select"	Тогда
				Возврат OnArtScanSelect(deviceId, UserName, KM_GTIN, DocOutID, Ячейка, Params);
			ИначеЕсли ТипОперации = "Insert" Тогда 
				Возврат OnArtScanInsert(deviceId, UserName, KM_GTIN, DocOutID, Ячейка, Params);
			Иначе
				Возврат ПодготовитьОтветJSON(ОбъектСписка)
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
		
	//ЗАПИСЬ	
	Если Не Шаблон.ГрупповаяРабота Тогда
		//ОБЫЧНАЯ ЛОГИКА
		Если Не ЗначениеЗаполнено(ДокДатаНачалаСбора) Или Не ЗначениеЗаполнено(ДокТСД) Тогда
			
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора = ТекущаяДата();
				Объект.ТСД = УзелПО;
				
				Объект.Записать();
				
				//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
				ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);
			Исключение
			КонецПопытки;
		КонецЕсли;
		
	Иначе
		//ГРУППОВОЙ ДОКУМЕНТ
		
		ДатаСбораПоТСД = ДатаМобайл_ОбщийМодуль.ПолучитьДатуГрупповогоДокумента(deviceId, СсылкаНаДок, "ДатаНачалаСбора");	
		Если Не ЗначениеЗаполнено(ДатаСбораПоТСД) Тогда	
			ДатаМобайл_ОбщийМодуль.СоздатьНачальнуюЗаписьТСДГрупповыхДокументов(deviceId, СсылкаНаДок, UserName);		
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(ДокДатаНачалаСбора) Тогда
			Попытка
				Объект = СсылкаНаДок.ПолучитьОбъект();
				Объект.ДатаНачалаСбора = ТекущаяДата();
				
				Объект.Записать();
			Исключение
			КонецПопытки;	
		КонецЕсли;
	КонецЕсли;	
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции

#КонецОбласти

#Область OnArtEgaisScan

//Заполнение объекта товара данными из выборки.
//
// Параметры:
// ВыборкаЕГАИС - ВыборкаИзРезультатаЗапроса - Строка выборки данных.
// ОбъектТовараЕГАИС - Структура - Структура данных объекта товара.
//
Процедура OnArtEgaisScan_ЗаполнитьОбъектТовара(ВыборкаЕГАИС, ОбъектТовараЕГАИС)
	
	ОбъектТовараЕГАИС.id = "8e-" + XMLСтрока(ВыборкаЕГАИС.Ссылка);
	ЗаполнитьЗначенияСвойств(ОбъектТовараЕГАИС, ВыборкаЕгаис);
	ОбъектТовараЕГАИС.alcocode = ВыборкаЕГАИС.Ссылка.Код;
	ОбъектТовараЕГАИС.name = ЧистаяСтрока(Лев(ВыборкаЕГАИС.name, 100));
	ОбъектТовараЕГАИС.manufacturer = ЧистаяСтрока(Лев(ВыборкаЕГАИС.manufacturer, 100)); 
	
	ОбъектТовараЕГАИС.is_compared = ТоварСопоставленОдинКОдному(ВыборкаЕГАИС.Ссылка); 
	ОбъектТовараЕГАИС.box_coef = 0; //количество единиц в коробе	
	
КонецПроцедуры

Функция НайтиНоменклатуруЕГАИСпоВходящемуДеревуУпаковок(КоллекцияСтрок, ДанныеДляПоиска)
	
	Для каждого Строка Из КоллекцияСтрок Цикл
		
		Если Строка.Строки.Количество() <> 0 Тогда
			Результат = НайтиНоменклатуруЕГАИСпоВходящемуДеревуУпаковок(Строка.Строки, ДанныеДляПоиска);
			Если Результат <> Неопределено Тогда
				Возврат Результат;
			КонецЕсли;
		Иначе
			Если Строка.ЗначениеШтрихкода = ДанныеДляПоиска Тогда
				Возврат Строка.АлкогольнаяПродукция;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции // ()

#КонецОбласти

#Область GetDocRowsSelect

//Получение данных строк документа (подбор) с ячейками.
//
// Параметры:
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон документа ТСД.
// ОбъектСписка - Массив - Массив данных.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
//
Процедура GetDocRowsSelectCells(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок)
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	РеквизитыШаблона = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ВидДокумента,ИмяТабличнойЧастиПодбор,ИмяТабличнойЧастиПриемка,
	|РаспределениеТоваров,ИспользоватьПодбор,ИспользоватьПриемку,ЕГАИС,ИспользоватьМаркировку,
	|МаркировкаЗапретитьПодборНемаркируемыхТоваров,НеВыгружатьУслуги,ПодборУпаковочнымиЛистами, ПроверкаОСГ, ДобавлятьКоличествоПоЗаданиюКОстатку,РежимКомплектации");
	
	ВидДокумента 									= РеквизитыШаблона.ВидДокумента;
	ИмяТабличнойЧастиПодбор 						= РеквизитыШаблона.ИмяТабличнойЧастиПодбор;
	ИмяТабличнойЧастиПриемка 						= РеквизитыШаблона.ИмяТабличнойЧастиПриемка;
	МножествоДокументовКакЗадание 					= РеквизитыШаблона.РаспределениеТоваров = 1;
	ИспользоватьПодбор								= РеквизитыШаблона.ИспользоватьПодбор;
	ИспользоватьПриемку								= РеквизитыШаблона.ИспользоватьПриемку;
	ГрупповойДокумент								= РеквизитыШаблона.РаспределениеТоваров = 2;
	ЕГАИС											= РеквизитыШаблона.ЕГАИС;
	ИспользоватьМаркировку							= РеквизитыШаблона.ИспользоватьМаркировку;
	МаркировкаЗапретитьПодборНемаркируемыхТоваров	= РеквизитыШаблона.МаркировкаЗапретитьПодборНемаркируемыхТоваров;
	НеВыгружатьУслуги								= РеквизитыШаблона.НеВыгружатьУслуги;
	ПодборУпаковочнымиЛистами                     	= РеквизитыШаблона.ПодборУпаковочнымиЛистами;
	ПроверкаОСГ                                    	= РеквизитыШаблона.ПроверкаОСГ;
	ДобавлятьКоличествоПоЗаданиюКОстатку           	= РеквизитыШаблона.ДобавлятьКоличествоПоЗаданиюКОстатку;
	РежимКомплектации           					= РеквизитыШаблона.РежимКомплектации;
	
	Если ВидДокумента = "ЗаданиеНаПеревозку" Тогда	
		ВидДокумента = "ЗаказКлиента";
		ИмяТабличнойЧастиПодбор = "Товары";
		ИмяТабличнойЧастиПриемка = "Товары";	
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика КАК Характеристика,
	|	&УсловиеУпаковка КАК Упаковка,
	|	&УсловиеСерия КАК Серия,
	|	СУММА(ТаблицаТоваровВДокументе.Количество) КАК Количество,
	|	ТаблицаТоваровВДокументе.Ячейка КАК Ячейка,
	|	МИНИМУМ(ТаблицаТоваровВДокументе.НомерСтроки) КАК НомерСтроки,
	|	&УсловиеАтрибуты1
	|ПОМЕСТИТЬ ЗапросСЛимитами
	|ИЗ
	|	Документ.ОтборРазмещениеТоваров.ТоварыОтбор КАК ТаблицаТоваровВДокументе
	|ГДЕ
	|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент
	|	
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваровВДокументе.Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика,
	|	&УсловиеУпаковка,
	|	&УсловиеСерия,
	|	ТаблицаТоваровВДокументе.Ячейка,
	|	&УсловиеАтрибуты2
	|
	|;
	|/////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапросСЛимитами.Номенклатура,
	|	ЗапросСЛимитами.Характеристика,
	|	ЗапросСЛимитами.Упаковка,
	|	ЗапросСЛимитами.Серия,
	|	СУММА(ЗапросСЛимитами.Количество) КАК Количество,
	|	ЗапросСЛимитами.Ячейка КАК Ячейка,
	|	МИНИМУМ(ЗапросСЛимитами.НомерСтроки) КАК НомерСтроки,
	|	&УсловиеАтрибуты3
	|ИЗ
	|	ЗапросСЛимитами КАК ЗапросСЛимитами
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапросСЛимитами.Номенклатура,
	|	ЗапросСЛимитами.Характеристика,
	|	ЗапросСЛимитами.Упаковка,
	|	ЗапросСЛимитами.Серия,
	|	ЗапросСЛимитами.Ячейка,
	|	&УсловиеАтрибуты4
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок);
	Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
	Запрос.УстановитьПараметр("Документы", СсылкаНаДок.Задания.ВыгрузитьКолонку("Задание"));
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ОтборРазмещениеТоваров.", "." + ВидДокумента + ".");  
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыОтбор КАК ", "." + ИмяТабличнойЧастиПодбор + " КАК ");
	
	Если МножествоДокументовКакЗадание Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка В(&Документы)");
	КонецЕсли;		
	
	МетаданныеДокумента = Метаданные.Документы[ВидДокумента];
	
	Попытка
		ЕстьУпаковка = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Упаковка") <> Неопределено;
	Исключение
		ЕстьУпаковка = Ложь;
	КонецПопытки;
	
	Если ЕстьУпаковка Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпаковка", "ТаблицаТоваровВДокументе.Упаковка");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпаковка", "Значение(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)");
	КонецЕсли;
	
	Попытка
		ЕстьКоличествоУпаковок = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("КоличествоУпаковок") <> Неопределено;
	Исключение
		ЕстьКоличествоУпаковок = Ложь;
	КонецПопытки;
	
	Если УзелПО.НеИспользоватьПересчетУпаковок И ЕстьКоличествоУпаковок Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", "ТаблицаТоваровВДокументе.КоличествоУпаковок");
	КонецЕсли;				
	
	Попытка
		ЕстьСерии = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Серия") <> Неопределено;
	Исключение
		ЕстьСерии = Ложь;
	КонецПопытки;
	
	Если ЕстьСерии Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "ТаблицаТоваровВДокументе.Серия");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "Значение(Справочник.СерииНоменклатуры.ПустаяСсылка)");
	КонецЕсли;
	
	Если ВидДокумента = "ПересчетТоваров" И УзелПО.НеОтображатьОстатки Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.КоличествоУпаковок", "0");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", "0");
	КонецЕсли;	
	
	// группировка по атрибутам -((
	ТабДопФорм = ПолучитьТаблицуДопФорм(Шаблон, 0);
	ТекстПоАтрибутамСтроки1 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ТаблицаТоваровВДокументе", Истина, Ложь, МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор]);	
	ТекстПоАтрибутамСтроки2 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ТаблицаТоваровВДокументе", Ложь, Ложь, МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор]);	
	ТекстПоАтрибутамСтроки3 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ЗапросСЛимитами", Истина, Истина, МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор]);	
	ТекстПоАтрибутамСтроки4 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ЗапросСЛимитами", Ложь, Истина, МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор]);
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты1", ТекстПоАтрибутамСтроки1);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты2", ТекстПоАтрибутамСтроки2);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты3", ТекстПоАтрибутамСтроки3);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты4", ТекстПоАтрибутамСтроки4);
	// группировка по атрибутам -))
	
	Рез = Запрос.Выполнить().Выгрузить();
	Для каждого СтрокаДока Из Рез Цикл
		
		Если Не ЗначениеЗаполнено(СтрокаДока.Номенклатура) Тогда
			Продолжить;
		КонецЕсли;
		
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
		ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
		Попытка ОбъектТовара.parent_id = ?(XMLСтрока(СтрокаДока.Характеристика) = "00000000-0000-0000-0000-000000000000", "", "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		Попытка
			ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");	
			ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура);
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
		Исключение
		Конецпопытки;
		
		Если ЗначениеЗаполнено(СтрокаДока.Ячейка) Тогда
			ОбъектЯчейки = ПолучитьСтруктуруОбъектаДляHttp("cell","barcode");
			Модуль_ШтрихкодированиеПечатныхФорм = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ШтрихкодированиеПечатныхФорм");
			ОбъектЯчейки.barcode = ?(УзелПО.ВыгружатьВКодЯчейки = 1, СтрокаДока.Ячейка.Код, Строка(Модуль_ШтрихкодированиеПечатныхФорм.ЧисловойКодПоСсылке(СтрокаДока.Ячейка)));
			СтруктураТекущейСтроки.Вставить("cell", ОбъектЯчейки);
		КонецЕсли;
		
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда
				sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;
		Исключение
		КонецПопытки;			
		
		Попытка
			ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускВесовогоТовара = Неопределено;
		КонецПопытки;
		
		Если ДопускВесовогоТовара <> Неопределено Тогда
			СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
		КонецЕсли;
		
		Попытка
			ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускОСГ = Неопределено;
		КонецПопытки;
		
		Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
			СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
		КонецЕсли;
		
		ЭтоУслуга = Ложь;
		Попытка 
			Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
				ЭтоУслуга = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		ЭтоНабор = Ложь;
		Попытка 
			Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Набор Тогда
				ЭтоНабор = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Если ЭтоНабор И РежимКомплектации = 1 Тогда
			СтруктураТекущейСтроки.Вставить("is_kit", Истина);
		Иначе
			СтруктураТекущейСтроки.Вставить("is_kit", Ложь);	
		КонецЕсли;
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		ИначеЕсли ЭтоУслуга Тогда
			limit_qty = 999;	
		Иначе				 
			limit_qty = ПолучитьОстатки(УзелПО, СсылкаНаДок, СтрокаДока.Номенклатура, СтрокаДока.Характеристика, СтрокаДока.Ячейка, СтрокаДока.Упаковка);
			Если ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
				limit_qty = limit_qty + СтрокаДока.Количество;		 
			КонецЕсли;
		КонецЕсли;
		
		qty = СтрокаДока.Количество;
		
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		СтруктураТекущейСтроки.Вставить("qty", qty);
		Попытка
			СтруктураТекущейСтроки.Вставить("unit_qty", qty / ОбъектШтрихкода.unit_coef);
		Исключение
			СтруктураТекущейСтроки.Вставить("unit_qty", qty);
		КонецПопытки; 
		
		// атрибуты строки 
		СтруктураПоиска = Новый Структура("НомерСтроки");
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаДока);				
		СписокАтрибутов = ПолучитьАтрибутыСтрокиДокумента(СсылкаНаДок, СтрокаДока, Ложь, СтруктураПоиска);
		СтруктураТекущейСтроки.Вставить("attributes", СписокАтрибутов);
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		
	КонецЦикла;
	
КонецПроцедуры

//Получение данных строк документа (подбор) с серийными номерами.
//
// Параметры:
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон документа ТСД.
// ОбъектСписка - Массив - Массив данных.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
//
Процедура GetDocRowsSelectSN(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок)
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	РеквизитыШаблона = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ВидДокумента,ИмяТабличнойЧастиПодбор,ИмяТабличнойЧастиПриемка,
	|РаспределениеТоваров,ИспользоватьПодбор,ИспользоватьПриемку,ЕГАИС,ИспользоватьМаркировку,
	|МаркировкаЗапретитьПодборНемаркируемыхТоваров,НеВыгружатьУслуги,ПодборУпаковочнымиЛистами,ПроверкаОСГ,ДобавлятьКоличествоПоЗаданиюКОстатку,РежимКомплектации");
	
	ВидДокумента 									= РеквизитыШаблона.ВидДокумента;
	ИмяТабличнойЧастиПодбор 						= РеквизитыШаблона.ИмяТабличнойЧастиПодбор;
	ИмяТабличнойЧастиПриемка 						= РеквизитыШаблона.ИмяТабличнойЧастиПриемка;
	МножествоДокументовКакЗадание 					= РеквизитыШаблона.РаспределениеТоваров = 1;
	ИспользоватьПодбор								= РеквизитыШаблона.ИспользоватьПодбор;
	ИспользоватьПриемку								= РеквизитыШаблона.ИспользоватьПриемку;
	ГрупповойДокумент								= РеквизитыШаблона.РаспределениеТоваров = 2;
	ЕГАИС											= РеквизитыШаблона.ЕГАИС;
	ИспользоватьМаркировку							= РеквизитыШаблона.ИспользоватьМаркировку;
	МаркировкаЗапретитьПодборНемаркируемыхТоваров	= РеквизитыШаблона.МаркировкаЗапретитьПодборНемаркируемыхТоваров;
	НеВыгружатьУслуги								= РеквизитыШаблона.НеВыгружатьУслуги;
	ПодборУпаковочнымиЛистами                      	= РеквизитыШаблона.ПодборУпаковочнымиЛистами;
	ПроверкаОСГ                                    	= РеквизитыШаблона.ПроверкаОСГ;
	ДобавлятьКоличествоПоЗаданиюКОстатку           	= РеквизитыШаблона.ДобавлятьКоличествоПоЗаданиюКОстатку;
	РежимКомплектации           					= РеквизитыШаблона.РежимКомплектации;
	
	Если ВидДокумента = "ЗаданиеНаПеревозку" Тогда	
		ВидДокумента = "ЗаказКлиента";
		ИмяТабличнойЧастиПодбор = "Товары";
		ИмяТабличнойЧастиПриемка = "Товары";	
	КонецЕсли; 
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика КАК Характеристика,
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
	|	ТаблицаТоваровВДокументе.Назначение КАК Назначение,
	|	ТаблицаТоваровВДокументе.Склад КАК Склад,
	|	&УсловиеУпаковка КАК Упаковка,
	|	&УсловиеЦена КАК Цена,
	|	СУММА(ТаблицаТоваровВДокументе.Количество) КАК Количество,
	|	МИНИМУМ(ТаблицаТоваровВДокументе.НомерСтроки) КАК НомерСтроки
	//|	&УсловиеАтрибуты1
	|ПОМЕСТИТЬ ВТ_ТаблицаТоваровВДокументе
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.Товары КАК ТаблицаТоваровВДокументе
	|ГДЕ
	|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваровВДокументе.Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика,
	|	ТаблицаТоваровВДокументе.Назначение,
	|	ТаблицаТоваровВДокументе.Склад,
	|	&УсловиеУпаковка,
	|	&УсловиеЦена1
	//|	&УсловиеАтрибуты2
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокСерии.Ссылка КАК Ссылка,
	|	ДокСерии.Номенклатура КАК Номенклатура,
	|	ДокСерии.Характеристика КАК Характеристика,
	|	ДокСерии.Назначение КАК Назначение,
	|	ДокСерии.Склад КАК Склад,
	|	ДокСерии.Серия КАК Серия,
	|	СУММА(ДокСерии.Количество) КАК Количество
	|ПОМЕСТИТЬ ВТ_ТаблицаСерии
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.Серии КАК ДокСерии
	|ГДЕ
	|	ДокСерии.Ссылка = &ИсходныйДокумент
	|
	|СГРУППИРОВАТЬ ПО 
	|	ДокСерии.Ссылка,
	|	ДокСерии.Номенклатура,
	|	ДокСерии.Характеристика,
	|	ДокСерии.Назначение,
	|	ДокСерии.Склад,
	|	ДокСерии.Серия
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	Назначение
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,
	|	ВТ_ТаблицаТоваровВДокументе.Характеристика КАК Характеристика,
	|	ЕСТЬNULL(ТаблицаСерийВДокументе.Серия, ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)) КАК Серия,
	|	ВТ_ТаблицаТоваровВДокументе.Упаковка КАК Упаковка,
	|	ВТ_ТаблицаТоваровВДокументе.Цена КАК Цена,
	|	СУММА(ЕСТЬNULL(ТаблицаСерийВДокументе.Количество, ВТ_ТаблицаТоваровВДокументе.Количество)) КАК Количество,
	|   ВТ_ТаблицаТоваровВДокументе.НомерСтроки КАК НомерСтроки
	//|	&УсловиеАтрибуты1
	|ПОМЕСТИТЬ ЗапросСЛимитами 
	|ИЗ
	|	ВТ_ТаблицаТоваровВДокументе КАК ВТ_ТаблицаТоваровВДокументе
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТаблицаСерии КАК ТаблицаСерийВДокументе
	|		ПО ВТ_ТаблицаТоваровВДокументе.Номенклатура = ТаблицаСерийВДокументе.Номенклатура
	|			И ВТ_ТаблицаТоваровВДокументе.Характеристика = ТаблицаСерийВДокументе.Характеристика
	|			И ВТ_ТаблицаТоваровВДокументе.Склад = ТаблицаСерийВДокументе.Склад 
	|			И ВТ_ТаблицаТоваровВДокументе.Назначение = ТаблицаСерийВДокументе.Назначение
	|	
	|СГРУППИРОВАТЬ ПО
	|	ВТ_ТаблицаТоваровВДокументе.Номенклатура,
	|	ВТ_ТаблицаТоваровВДокументе.Характеристика,
	|	ЕСТЬNULL(ТаблицаСерийВДокументе.Серия, ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)),
	|	ВТ_ТаблицаТоваровВДокументе.Упаковка,
	|	ВТ_ТаблицаТоваровВДокументе.Цена,
	| 	ВТ_ТаблицаТоваровВДокументе.НомерСтроки
	//|	 &УсловиеАтрибуты2
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.СерияСсылка КАК СерияСсылка,
	|	СУММА(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество) КАК Количество
	|ПОМЕСТИТЬ РезервыТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка <> &Ссылка
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.Шаблон.РезервироватьТовар
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.СерияСсылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ХарактеристикаНоменклатуры,
	|	СерияСсылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапросСЛимитами.Номенклатура,
	|	ЗапросСЛимитами.Характеристика,
	|	ЗапросСЛимитами.Серия,
	|	ЗапросСЛимитами.Упаковка,
	|	ЗапросСЛимитами.Цена,
	|	СУММА(ЗапросСЛимитами.Количество) КАК Количество,
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0) - ЕСТЬNULL(СвободныеОстаткиОстатки.КОтгрузкеОстаток, 0) - ЕСТЬNULL(РезервыТСД.Количество, 0)) КАК Лимит,
	|	МИНИМУМ(ЗапросСЛимитами.НомерСтроки) КАК НомерСтроки
	//|	&УсловиеАтрибуты3
	|ИЗ
	|	ЗапросСЛимитами КАК ЗапросСЛимитами
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	|				,
	|				(&ВсеСклады
	|					ИЛИ Склад В (&Склады))
	|				И (&ВсеПомещения
	|					ИЛИ Помещение В (&Помещения))) КАК СвободныеОстаткиОстатки
	|		ПО ЗапросСЛимитами.Номенклатура = СвободныеОстаткиОстатки.Номенклатура
	|			И ЗапросСЛимитами.Характеристика = СвободныеОстаткиОстатки.Характеристика
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервыТСД КАК РезервыТСД
	|		ПО ЗапросСЛимитами.Номенклатура = РезервыТСД.Номенклатура
	|			И ЗапросСЛимитами.Характеристика = РезервыТСД.ХарактеристикаНоменклатуры
	|			И ЗапросСЛимитами.Серия = РезервыТСД.СерияСсылка
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапросСЛимитами.Номенклатура,
	|	ЗапросСЛимитами.Характеристика,
	|	ЗапросСЛимитами.Упаковка,
	|	ЗапросСЛимитами.Серия,
	|	ЗапросСЛимитами.Цена
	//|	&УсловиеАтрибуты4
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");	
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок);
	Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ПриобретениеТоваровУслуг.", "." + ВидДокумента + ".");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК ", "." + ИмяТабличнойЧастиПодбор + " КАК ");
	
	//Если у документа есть склад берем остатки по складу документа иначе склады из настроек ТСД
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады" ,СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	МетаданныеДокумента = Метаданные.Документы[ВидДокумента];	
	
	Попытка
		ЕстьЦены = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Цена") <> Неопределено;
	Исключение
		ЕстьЦены = Ложь;
	КонецПопытки;
	
	//Если ЕстьЦены Тогда
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "ТаблицаТоваровВДокументе.Цена");
	//Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена1", "NULL");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "МАКСИМУМ(ТаблицаТоваровВДокументе.Цена)");
	//КонецЕсли;
	
	Попытка
		ЕстьУпаковка = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Упаковка") <> Неопределено;
	Исключение
		ЕстьУпаковка = Ложь;
	КонецПопытки;
	
	//Если ЕстьУпаковка Тогда
	//	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпаковка", "ТаблицаТоваровВДокументе.Упаковка");
	//Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпаковка", "Значение(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)");
	//КонецЕсли;
	
	Если ВидДокумента = "ЗаказПоставщику" Тогда
		Попытка
			ЕстьОтменено = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Отменено") <> Неопределено;
		Исключение
			ЕстьОтменено = Ложь;
		КонецПопытки;
		
		Если ЕстьОтменено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент И НЕ ТаблицаТоваровВДокументе.Отменено");
		КонецЕсли;	
	ИначеЕсли ВидДокумента = "ЗаказКлиента" Тогда
		Попытка
			ЕстьОтменено = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Отменено") <> Неопределено И МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("ВариантОбеспечения") <> Неопределено;
		Исключение
			ЕстьОтменено = Ложь;
		КонецПопытки;
		
		Если ЕстьОтменено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент И НЕ ТаблицаТоваровВДокументе.Отменено");
		КонецЕсли;		
	КонецЕсли;
	
	Попытка
		ЕстьКоличествоУпаковок = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("КоличествоУпаковок") <> Неопределено;
	Исключение
		ЕстьКоличествоУпаковок = Ложь;
	КонецПопытки;
	
	Если УзелПО.НеИспользоватьПересчетУпаковок И ЕстьКоличествоУпаковок Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", "ТаблицаТоваровВДокументе.КоличествоУпаковок");
	КонецЕсли;		 
	
	Если НеВыгружатьУслуги Тогда		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент 
		|   	И  ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)");			
	КонецЕсли; 
	
	//// группировка по атрибутам -((
	//ТабДопФорм = ПолучитьТаблицуДопФорм(Шаблон, 0);
	//ТекстПоАтрибутамСтроки1 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ТаблицаТоваровВДокументе", Истина, Ложь);	
	//ТекстПоАтрибутамСтроки2 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ТаблицаТоваровВДокументе", Ложь, Ложь);
	//ТекстПоАтрибутамСтроки3 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ЗапросСЛимитами", Истина, Истина);
	//ТекстПоАтрибутамСтроки4 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ЗапросСЛимитами", Ложь, Истина);
	//
	//Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты1", ТекстПоАтрибутамСтроки1);
	//Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты2", ТекстПоАтрибутамСтроки2);
	//Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты3", ТекстПоАтрибутамСтроки3);
	//Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты4", ТекстПоАтрибутамСтроки4);
	//// группировка по атрибутам -))
	
	Рез = Запрос.Выполнить().Выгрузить();
	Для каждого СтрокаДока Из Рез Цикл
		
		Если Не ЗначениеЗаполнено(СтрокаДока.Номенклатура) Тогда
			Продолжить;
		КонецЕсли;
		
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
		ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
		Попытка ОбъектТовара.parent_id = ?(XMLСтрока(СтрокаДока.Характеристика) = "00000000-0000-0000-0000-000000000000", "", "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		Попытка
			ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");	
			ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура);
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
		Исключение
		Конецпопытки;
		
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда
				sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускВесовогоТовара = Неопределено;
		КонецПопытки;
		
		Если ДопускВесовогоТовара <> Неопределено Тогда
			СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
		КонецЕсли;
		
		Попытка
			ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускОСГ = Неопределено;
		КонецПопытки;
		
		Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
			СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
		КонецЕсли;
		
		ЭтоУслуга = Ложь;
		Попытка 
			Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
				ЭтоУслуга = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		ЭтоНабор = Ложь;
		Попытка 
			Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Набор Тогда
				ЭтоНабор = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Если ЭтоНабор И РежимКомплектации = 1 Тогда
			СтруктураТекущейСтроки.Вставить("is_kit", Истина);
		Иначе
			СтруктураТекущейСтроки.Вставить("is_kit", Ложь);	
		КонецЕсли;
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		ИначеЕсли ЭтоУслуга Тогда
			limit_qty = 999;
		Иначе		
			Попытка
				Итог = СтрокаДока.Лимит;
				Если ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
					Итог = Итог + СтрокаДока.Количество;		 
				КонецЕсли;
				limit_qty = Итог;
			Исключение
				limit_qty = 0;
			КонецПопытки;
		КонецЕсли;
		
		qty = СтрокаДока.Количество;
		price = СтрокаДока.Цена;		
		
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		СтруктураТекущейСтроки.Вставить("qty", qty);
		СтруктураТекущейСтроки.Вставить("price", price);		
		Попытка
			СтруктураТекущейСтроки.Вставить("unit_qty", qty / ОбъектШтрихкода.unit_coef);
		Исключение
			СтруктураТекущейСтроки.Вставить("unit_qty", qty);
		КонецПопытки;
		
		// атрибуты строки 
		СтруктураПоиска = Новый Структура("НомерСтроки");
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаДока);
		СписокАтрибутов = ПолучитьАтрибутыСтрокиДокумента(СсылкаНаДок, СтрокаДока, Ложь, СтруктураПоиска);
		СтруктураТекущейСтроки.Вставить("attributes", СписокАтрибутов);
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);
	КонецЦикла;			
	
КонецПроцедуры

//Получение данных строк документа (приемка) с обычными товарами.
//
// Параметры:
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон документа ТСД.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// ОбъектСписка - Массив - Массив данных.
//
Процедура GetDocRowsSelectCasual(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок)
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	РеквизитыШаблона = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ВидДокумента,ИмяТабличнойЧастиПодбор,ИмяТабличнойЧастиПриемка,
	|РаспределениеТоваров,ИспользоватьПодбор,ИспользоватьПриемку,ЕГАИС,ИспользоватьМаркировку,
	|МаркировкаЗапретитьПодборНемаркируемыхТоваров,НеВыгружатьУслуги,ПодборУпаковочнымиЛистами,ПроверкаОСГ,ДобавлятьКоличествоПоЗаданиюКОстатку,РежимКомплектации");
	
	ВидДокумента 									= РеквизитыШаблона.ВидДокумента;
	ИмяТабличнойЧастиПодбор 						= РеквизитыШаблона.ИмяТабличнойЧастиПодбор;
	ИмяТабличнойЧастиПриемка 						= РеквизитыШаблона.ИмяТабличнойЧастиПриемка;
	МножествоДокументовКакЗадание 					= РеквизитыШаблона.РаспределениеТоваров = 1;
	ИспользоватьПодбор								= РеквизитыШаблона.ИспользоватьПодбор;
	ИспользоватьПриемку								= РеквизитыШаблона.ИспользоватьПриемку;
	ГрупповойДокумент								= РеквизитыШаблона.РаспределениеТоваров = 2;
	ЕГАИС											= РеквизитыШаблона.ЕГАИС;
	ИспользоватьМаркировку							= РеквизитыШаблона.ИспользоватьМаркировку;
	МаркировкаЗапретитьПодборНемаркируемыхТоваров	= РеквизитыШаблона.МаркировкаЗапретитьПодборНемаркируемыхТоваров;
	НеВыгружатьУслуги								= РеквизитыШаблона.НеВыгружатьУслуги;
	ПодборУпаковочнымиЛистами                      	= РеквизитыШаблона.ПодборУпаковочнымиЛистами;
	ПроверкаОСГ                                    	= РеквизитыШаблона.ПроверкаОСГ;
	ДобавлятьКоличествоПоЗаданиюКОстатку           	= РеквизитыШаблона.ДобавлятьКоличествоПоЗаданиюКОстатку;
	РежимКомплектации           					= РеквизитыШаблона.РежимКомплектации;
	
	Если ВидДокумента = "ЗаданиеНаПеревозку" Тогда	
		ВидДокумента = "ЗаказКлиента";
		ИмяТабличнойЧастиПодбор = "Товары";
		ИмяТабличнойЧастиПриемка = "Товары";	
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика КАК Характеристика,
	|	&УсловиеСерия КАК Серия,
	|	&УсловиеЦена КАК Цена,
	|	СУММА(ВЫБОР
	|			КОГДА ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0) = 0
	|				ТОГДА ТаблицаТоваровВДокументе.КоличествоУпаковок
	|			ИНАЧЕ ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0)
	|		КОНЕЦ) КАК Количество,
	|	СУММА(ТаблицаТоваровВДокументе.КоличествоШт) КАК КоличествоМест,
	|	МИНИМУМ(ТаблицаТоваровВДокументе.НомерСтроки) КАК НомерСтроки,
	|	&УсловиеУпаковка КАК Упаковка,
	|	&УсловиеУпакЛист КАК УпаковочныйЛист,
	|	&УсловиеАтрибуты1
	|ПОМЕСТИТЬ ТаблицаТоваровВДокументе1С
	|ИЗ
	|	Документ.ПриходныйОрдерНаТовары.Товары КАК ТаблицаТоваровВДокументе
	|ГДЕ
	|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваровВДокументе.Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика,
	|	&УсловиеСерия,
	|	&УсловиеЦена,
	|	&УсловиеУпаковка,
	|	&УсловиеУпакЛист,
	|	&УсловиеАтрибуты2
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК Характеристика,
	|	СУММА(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество) КАК Количество
	|ПОМЕСТИТЬ РезервыТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка <> &Ссылка
	|		И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.Шаблон.РезервироватьТовар
	|			И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СвободныеОстатки.Номенклатура КАК Номенклатура,
	|	СвободныеОстатки.Характеристика КАК Характеристика,
	|	СвободныеОстатки.Серия КАК Серия,
	|	СУММА(ЕСТЬNULL(СвободныеОстатки.ВНаличииОстаток, 0)) КАК ВНаличииОстатокСерии,
	|	СУММА(ЕСТЬNULL(СвободныеОстатки.КОтгрузкеОстаток, 0)) КАК ВРезерве
	|ПОМЕСТИТЬ ТоварыНаСкладахОстаткиСерии
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			,
	|			Номенклатура В
	|					(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|						ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура
	|					ИЗ
	|						ТаблицаТоваровВДокументе1С КАК ТаблицаТоваровВДокументе)
	|				И (&ВсеСклады
	|					ИЛИ Склад В (&Склады))
	|				И 1=1) КАК СвободныеОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	СвободныеОстатки.Номенклатура,
	|	СвободныеОстатки.Характеристика,
	|	СвободныеОстатки.Серия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
	|	ТоварыНаСкладахОстатки.Характеристика КАК Характеристика,
	|	СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстатокСерии, 0)) - СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВРезерве, 0)) КАК ВНаличииОстаток
	|ПОМЕСТИТЬ ТоварыНаСкладахОстатки
	|ИЗ
	|	ТоварыНаСкладахОстаткиСерии КАК ТоварыНаСкладахОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	ТоварыНаСкладахОстатки.Номенклатура,
	|	ТоварыНаСкладахОстатки.Характеристика
	|;
	|
	|&ТекстЗапросаРаспределениеЗапасов
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаТоваровВДокументе1С.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваровВДокументе1С.Характеристика КАК Характеристика,
	|	ТаблицаТоваровВДокументе1С.Цена КАК Цена,
	|	ТаблицаТоваровВДокументе1С.Количество КАК Количество,
	|	ТаблицаТоваровВДокументе1С.КоличествоМест КАК КоличествоМест,
	|	ТаблицаТоваровВДокументе1С.НомерСтроки КАК НомерСтроки,
	|	ТаблицаТоваровВДокументе1С.Серия КАК Серия,
	|	ТаблицаТоваровВДокументе1С.Упаковка КАК Упаковка,
	|	ТаблицаТоваровВДокументе1С.УпаковочныйЛист КАК УпаковочныйЛист,
	|	ТаблицаТоваровВДокументе1С.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ТипНоменклатуры,
	|	ТаблицаТоваровВДокументе1С.Номенклатура.ВидНоменклатуры.ИспользоватьСерии КАК ИспользоватьСерии,
	|	ТоварыНаСкладахОстаткиСерии.ВНаличииОстатокСерии КАК ОстатокПоСерии,
	|	СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0) - ЕСТЬNULL(РезервыТСД.Количество, 0)) КАК Лимит,
	|	&УсловиеАтрибуты3	 
	|ИЗ
	|	ТаблицаТоваровВДокументе1С КАК ТаблицаТоваровВДокументе1С
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервыТСД КАК РезервыТСД
	|		ПО ТаблицаТоваровВДокументе1С.Номенклатура = РезервыТСД.Номенклатура
	|			И ТаблицаТоваровВДокументе1С.Характеристика = РезервыТСД.Характеристика
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыНаСкладахОстаткиСерии КАК ТоварыНаСкладахОстаткиСерии
	|		ПО ТаблицаТоваровВДокументе1С.Номенклатура = ТоварыНаСкладахОстаткиСерии.Номенклатура
	|			И ТаблицаТоваровВДокументе1С.Характеристика = ТоварыНаСкладахОстаткиСерии.Характеристика
	|			И ТаблицаТоваровВДокументе1С.Серия = ТоварыНаСкладахОстаткиСерии.Серия
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыНаСкладахОстатки КАК ТоварыНаСкладахОстатки
	|		ПО ТаблицаТоваровВДокументе1С.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
	|			И ТаблицаТоваровВДокументе1С.Характеристика = ТоварыНаСкладахОстатки.Характеристика
	|		&РаспределениеЗапасов
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваровВДокументе1С.Номенклатура,
	|	ТаблицаТоваровВДокументе1С.Характеристика,
	|	ТаблицаТоваровВДокументе1С.Цена,
	|	ТаблицаТоваровВДокументе1С.Количество,
	|	ТаблицаТоваровВДокументе1С.КоличествоМест,
	|	ТаблицаТоваровВДокументе1С.НомерСтроки,
	|	ТаблицаТоваровВДокументе1С.Серия,
	|	ТаблицаТоваровВДокументе1С.Упаковка,
	|	ТаблицаТоваровВДокументе1С.УпаковочныйЛист,
	|	ТаблицаТоваровВДокументе1С.Номенклатура.ВидНоменклатуры.ТипНоменклатуры,
	|	ТаблицаТоваровВДокументе1С.Номенклатура.ВидНоменклатуры.ИспользоватьСерии,
	|	ТоварыНаСкладахОстаткиСерии.ВНаличииОстатокСерии,
	|	&УсловиеАтрибуты4
	|	
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
		
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок);
	Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ПриходныйОрдерНаТовары.", "." + ВидДокумента + ".");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК ", "." + ИмяТабличнойЧастиПодбор + " КАК ");
	
	//Если у документа есть склад берем остатки по складу документа иначе склады из настроек ТСД
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	Запрос.УстановитьПараметр("Документы", СсылкаНаДок.Задания.ВыгрузитьКолонку("Задание"));
	
	СкорректироватьЗапросЕслиЕстьРегистрНакопленияСвободныеОстатки(Запрос.Текст, "GetDocRowsSelectCasual", УзелПО.УчитыватьОстаткиПоРегиструСвободныеОстатки);
		
	МетаданныеДокумента = Метаданные.Документы[ВидДокумента];
	
	Попытка
		ЕстьЦены = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Цена") <> Неопределено;
	Исключение
		ЕстьЦены = Ложь;
	КонецПопытки;	
	
	Если ЕстьЦены Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "ТаблицаТоваровВДокументе.Цена");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "0");
	КонецЕсли;
	
	Попытка
		ЕстьСерии = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Серия") <> Неопределено;
	Исключение
		ЕстьСерии = Ложь;
	КонецПопытки;
	
	Если ЕстьСерии Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "ТаблицаТоваровВДокументе.Серия");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "Значение(Справочник.СерииНоменклатуры.ПустаяСсылка)");
	КонецЕсли;
	
	Попытка
		ЕстьКоличествоМест = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("КоличествоШт") <> Неопределено;
	Исключение
		ЕстьКоличествоМест = Ложь;
	КонецПопытки;
	
	Если Не ЕстьКоличествоМест Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.КоличествоШт", 0);		
	КонецЕсли;
	
	Попытка
		ЕстьУпаковка = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Упаковка") <> Неопределено;
	Исключение
		ЕстьУпаковка = Ложь;
	КонецПопытки;
	
	Если ЕстьУпаковка Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпаковка", "ТаблицаТоваровВДокументе.Упаковка");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпаковка", "Значение(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)");
	КонецЕсли;
	
	Попытка
		ЕстьКоличествоУпаковок = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("КоличествоУпаковок") <> Неопределено;
	Исключение
		ЕстьКоличествоУпаковок = Ложь;
	КонецПопытки;
	
	Если ЕстьКоличествоУпаковок Тогда
		Если УзелПО.НеИспользоватьПересчетУпаковок Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество,", "ТаблицаТоваровВДокументе.КоличествоУпаковок,");
		КонецЕсли;			
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.КоличествоУпаковок", "ТаблицаТоваровВДокументе.Количество");
	КонецЕсли;
	
	Попытка
		ЕстьКоличество = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Количество") <> Неопределено;
	Исключение
		ЕстьКоличество = Ложь;
	КонецПопытки;
	
	Если Не ЕстьКоличество Тогда
		Если ВидДокумента = "УстановкаЦенНоменклатуры" Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", 999); 
		Иначе 
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", 0);
		КонецЕсли;	 		
	КонецЕсли;
		
	Если ВидДокумента = "ЗаказПоставщику" Тогда
		Попытка
			ЕстьОтменено = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Отменено") <> Неопределено;
		Исключение
			ЕстьОтменено = Ложь;
		КонецПопытки;
		
		Если ЕстьОтменено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент И НЕ ТаблицаТоваровВДокументе.Отменено");
		КонецЕсли;
	ИначеЕсли ВидДокумента = "ЗаказКлиента" Тогда
		Попытка
			ЕстьОтменено = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Отменено") <> Неопределено И МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("ВариантОбеспечения") <> Неопределено;
		Исключение
			ЕстьОтменено = Ложь;
		КонецПопытки;
		
		Если ЕстьОтменено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент И НЕ ТаблицаТоваровВДокументе.Отменено");
		КонецЕсли;   
	КонецЕсли;
	
	Попытка
		ЕстьУпаковочныйЛист = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор].Реквизиты.Найти("УпаковочныйЛистРодитель") <> Неопределено;
	Исключение
		ЕстьУпаковочныйЛист = Ложь;
	КонецПопытки;
	
	Если ЕстьУпаковочныйЛист И ПодборУпаковочнымиЛистами Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпакЛист", "ТаблицаТоваровВДокументе.УпаковочныйЛистРодитель.Код");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеУпакЛист", """""");
	КонецЕсли;	
		
	Если ВидДокумента = "ПересчетТоваров" И УзелПО.НеОтображатьОстатки Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.КоличествоУпаковок", "0");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", "0");
	КонецЕсли;	
	
	Если МножествоДокументовКакЗадание Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка В(&Документы)");
	КонецЕсли;		
	
	Если ВидДокумента = "ПеремаркировкаТоваровИСМП" Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,"	,"ТаблицаТоваровВДокументе.НоваяНоменклатура КАК Номенклатура,");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Номенклатура,"					,"ТаблицаТоваровВДокументе.НоваяНоменклатура,"); 
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Характеристика"					,"ТаблицаТоваровВДокументе.НоваяХарактеристика");
	КонецЕсли; 
	
	Если ИспользоватьМаркировку И МаркировкаЗапретитьПодборНемаркируемыхТоваров Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент 
		|   	И
		|   	(
		|   	(ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПустаяСсылка) 
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.АлкогольнаяПродукция)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.СодержитДрагоценныеМатериалы)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.КиЗГИСМ)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПодконтрольнаяПродукцияВЕТИС)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПродавцом)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПоАгентскойСхеме)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.Партнером)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.БезОсобенностейУчета))
		|   	ИЛИ
		|   	(ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПустаяСсылка) 
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.АлкогольнаяПродукция)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.СодержитДрагоценныеМатериалы)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.КиЗГИСМ)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПодконтрольнаяПродукцияВЕТИС)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПродавцом)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПоАгентскойСхеме)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.Партнером)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.БезОсобенностейУчета))
		|   	)");		
	КонецЕсли;		
	
	Если НеВыгружатьУслуги Тогда		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент 
		|   	И  ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ТипНоменклатуры <> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)");			
	КонецЕсли;  
	
	Если ВидДокумента = "КорректировкаРеализации" И ИмяТабличнойЧастиПодбор = "Расхождения" Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0)", "ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество * ВЫБОР КОГДА ТаблицаТоваровВДокументе.Количество < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ, 0)");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.КоличествоУпаковок", "ТаблицаТоваровВДокументе.КоличествоУпаковок * ВЫБОР КОГДА ТаблицаТоваровВДокументе.КоличествоУпаковок < 0 ТОГДА -1 ИНАЧЕ 1 КОНЕЦ")
	КонецЕсли;
	
	// группировка по атрибутам -((
	ТабДопФорм = ПолучитьТаблицуДопФорм(Шаблон, 0);
	ТекстПоАтрибутамСтроки1 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ТаблицаТоваровВДокументе", Истина, Ложь, МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор]);	
	ТекстПоАтрибутамСтроки2 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ТаблицаТоваровВДокументе", Ложь, Ложь, МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор]);
	ТекстПоАтрибутамСтроки3 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ТаблицаТоваровВДокументе1С", Истина, Истина, МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор]);
	ТекстПоАтрибутамСтроки4 = СформироватьДополнениеЗапросаАтрибутыСтрок(ТабДопФорм, "ТаблицаТоваровВДокументе1С", Ложь, Истина, МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧастиПодбор]);
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты1", ТекстПоАтрибутамСтроки1);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты2", ТекстПоАтрибутамСтроки2);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты3", ТекстПоАтрибутамСтроки3);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеАтрибуты4", ТекстПоАтрибутамСтроки4);
	// группировка по атрибутам -))
	
	СкорректироватьЗапросЕслиЕстьРегистрСведенийРаспределениеЗапасов(Запрос.Текст, "GetDocRowsSelectCasual", УзелПО.УчитыватьОстаткиПоРегиструРаспределениеЗапасов);
	
	Если ВидДокумента = "УстановкаЦенНоменклатуры" Тогда
		СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "GetDocRowsSelectCasual");	
	КонецЕсли;
	
	Рез = Запрос.Выполнить().Выгрузить();
	Для каждого СтрокаДока Из Рез Цикл
		
		Если Не ЗначениеЗаполнено(СтрокаДока.Номенклатура) Тогда
			Продолжить;
		КонецЕсли;
		
		СтруктураТекущейСтроки = Новый Структура;
		
		Характеристика = СтрокаДока.Характеристика;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");	
		Если ЗначениеЗаполнено(Характеристика) Тогда
			Если ВидДокумента = "УстановкаЦенНоменклатуры" Тогда
				МассивЦО = Новый Массив();
				МассивЦО.Добавить(Характеристика);
				ХарактеристикаМассив = ПолучитьХарактеристикиИзХарактеристикаНоменклатурыДляЦенообразования(МассивЦО);
				Если ХарактеристикаМассив.Количество() > 0 Тогда
					Характеристика = ХарактеристикаМассив[0];	
				КонецЕсли;		 
			КонецЕсли;	
			ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(Характеристика);
			Попытка ОбъектТовара.parent_id = ?(XMLСтрока(Характеристика) = "00000000-0000-0000-0000-000000000000", "", "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
		Иначе
			ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000";
		КонецЕсли;
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		ТекущийШтрихкод = "";
		Если ПодборУпаковочнымиЛистами Тогда
			Попытка
				ТекущийШтрихкод = ПолучитьШтрихкодУпаковки(СтрокаДока.Номенклатура, Характеристика, СтрокаДока.Упаковка); 
			Исключение 
			КонецПопытки;
		КонецЕсли;
		
		Попытка
			Если ЗначениеЗаполнено(ТекущийШтрихкод) Тогда					
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","unit_value");
				ОбъектШтрихкода.value = ЧистаяСтрока(ТекущийШтрихкод);
			Иначе
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");	
			КонецЕсли;	
			ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура);		
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
		Исключение
		Конецпопытки;
		
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда
				sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускВесовогоТовара = Неопределено;
		КонецПопытки;
		
		Если ДопускВесовогоТовара <> Неопределено Тогда
			СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
		КонецЕсли;
		
		Попытка
			ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускОСГ = Неопределено;
		КонецПопытки;
		
		Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
			СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
		КонецЕсли;
		
		ЭтоУслуга = Ложь;
		Попытка 
			Если СтрокаДока.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
				ЭтоУслуга = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		ЭтоНабор = Ложь;
		Попытка 
			Если СтрокаДока.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Набор Тогда
				ЭтоНабор = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Если ЭтоНабор И РежимКомплектации = 1 Тогда
			СтруктураТекущейСтроки.Вставить("is_kit", Истина);
		Иначе
			СтруктураТекущейСтроки.Вставить("is_kit", Ложь);	
		КонецЕсли;
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		ИначеЕсли ЭтоУслуга Тогда
			limit_qty = 999;	
		Иначе			
			Попытка
				Итог = СтрокаДока.Лимит;
				Если ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
					Итог = Итог + СтрокаДока.Количество;		 
				КонецЕсли;
				limit_qty = Итог;
			Исключение
				limit_qty = 0;
			КонецПопытки;
		КонецЕсли;
				
		qty = СтрокаДока.Количество;
		
		price = СтрокаДока.Цена;
		СтруктураТекущейСтроки.Вставить("price", price);
		
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		СтруктураТекущейСтроки.Вставить("qty", qty);
		Попытка
			СтруктураТекущейСтроки.Вставить("unit_qty", qty / ОбъектШтрихкода.unit_coef);
		Исключение
			СтруктураТекущейСтроки.Вставить("unit_qty", qty);
		КонецПопытки;		
		
		Если ПодборУпаковочнымиЛистами Тогда	
			Попытка
				pack = СокрЛП(СтрокаДока.УпаковочныйЛист);
				СтруктураТекущейСтроки.Вставить("pack", pack);
			Исключение 
			КонецПопытки;
		КонецЕсли;
		
		// атрибуты строки
		СтруктураПоиска = Новый Структура("НомерСтроки");
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаДока);
		СписокАтрибутов = ПолучитьАтрибутыСтрокиДокумента(СсылкаНаДок, СтрокаДока,, СтруктураПоиска);
		СтруктураТекущейСтроки.Вставить("attributes", СписокАтрибутов);		
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		
	КонецЦикла;
	
КонецПроцедуры

//Получение данных строк документа (подбор) с маркируемыми товарами.
//
// Параметры:
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон документа ТСД.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// ОбъектСписка - Массив - Массив данных.
//  
Процедура GetDocRowsSelectMarking(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, РеквизитыШаблона)
	
	Если Шаблон.ВидДокумента = "УведомлениеОПриемкеМДЛП" Тогда
		ПолучитьСтрокиДокументаМДЛП(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок);
	Иначе
		
		ПолучитьСтрокиДокументаМаркировка(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, РеквизитыШаблона);		
	КонецЕсли;
	
КонецПроцедуры

Процедура ПолучитьСтрокиДокументаМаркировка(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок, РеквизитыШаблона)
	
	Запрос = Новый Запрос;
	
	//ВЫБЕРЕМ ДАННЫЕ ДОКУМЕНТА ПО ТОВАРАМ И ОСТАТКАМ
	Запрос.Текст = "ВЫБРАТЬ
	|	ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика КАК Характеристика,
	|	&УсловиеСерия КАК Серия,
	|	&УсловиеЦена КАК Цена,
	|	СУММА(ВЫБОР
	|			КОГДА ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0) = 0
	|				ТОГДА ТаблицаТоваровВДокументе.КоличествоУпаковок
	|			ИНАЧЕ ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0)
	|		КОНЕЦ) КАК Количество,
	|	МИНИМУМ(ТаблицаТоваровВДокументе.НомерСтроки) КАК НомерСтроки
	|ПОМЕСТИТЬ ЗапросСЛимитами
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.Товары КАК ТаблицаТоваровВДокументе
	|ГДЕ
	|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваровВДокументе.Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика,
	|	&УсловиеСерия,
	|	&УсловиеЦена
	|;
	|/////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапросСЛимитами.Номенклатура КАК Номенклатура,
	|	ЗапросСЛимитами.Характеристика КАК Характеристика,
	|	ЗапросСЛимитами.Серия КАК Серия,
	|	МАКСИМУМ(ЗапросСЛимитами.Цена) КАК Цена,
	|	СУММА(ЗапросСЛимитами.Количество) КАК Количество,
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0)) КАК Лимит,
	|	МИНИМУМ(ЗапросСЛимитами.НомерСтроки) КАК НомерСтроки
	|ПОМЕСТИТЬ ТоварыЗадания
	|ИЗ
	|	ЗапросСЛимитами КАК ЗапросСЛимитами
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	|				,
	|				(&ВсеСклады
	|					ИЛИ Склад В (&Склады))
	|				И (&ВсеПомещения
	|					ИЛИ Помещение В (&Помещения))) КАК СвободныеОстаткиОстатки
	|		ПО ЗапросСЛимитами.Номенклатура = СвободныеОстаткиОстатки.Номенклатура
	|			И ЗапросСЛимитами.Характеристика = СвободныеОстаткиОстатки.Характеристика
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапросСЛимитами.Номенклатура,
	|	ЗапросСЛимитами.Характеристика,
	|	ЗапросСЛимитами.Серия
	|;
	|";
	
	Если РеквизитыШаблона.ВидДокумента = "ПриобретениеТоваровУслуг" Тогда
		СкорректироватьЗапросПолучитьСтрокиДокументаМаркировка(Запрос, СсылкаНаДок.ИсходныйДокумент, РеквизитыШаблона);
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + "
	//ВЫБЕРЕМ ДАННЫЕ ДОКУМЕНТА ПО СПРАВОЧНИКУ ШТРИХКОДЫ УПАКОВОК, ЕСЛИ ОНИ ЗАГРУЖЕНЫ
	//ТОЛЬКО ПО ГРУППОВЫМ УПАКОВКАМ, БЛОКИ СИГАРЕТ НЕ УЧИТЫВАЕМ, ПЛЮС ПРЕДПОЛОГАЕМ ЧТО МОГУТ БЫТЬ КОРОБА И ПАЛЕТЫ	
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ 
	|	ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки КАК ШтрихкодУпаковки,
	|	ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки.ЗначениеШтрихкода КАК ЗначениеШтрихкода
	|ПОМЕСТИТЬ ШтрихкодыУпаковокТоваровКоробаПалеты
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.ШтрихкодыУпаковок КАК ПриобретениеТоваровУслугШтрихкодыУпаковок
	|ГДЕ
	|	ПриобретениеТоваровУслугШтрихкодыУпаковок.Ссылка = &ИсходныйДокумент
	|	И НЕ ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки = ЗНАЧЕНИЕ(Справочник.ШтрихкодыУпаковокТоваров.ПустаяСсылка)
	|	И (ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка)
	|		ИЛИ ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка))
	|			И ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки.ТипШтрихкода <> ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)
	|;
	|
	
	//ВЫБЕРЕМ ИЗ ГРУППОВЫХ УПАКОВОК НИЖЕСТОЯЩИЕ, ЕСЛИ ИСПОЛЬЗУЮТСЯ ЕЩЕ И ПАЛЕТЫ
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК ШтрихкодУпаковки,
	|	СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ЗначениеШтрихкода КАК ЗначениеШтрихкода
	|ПОМЕСТИТЬ ШтрихкодыУпаковокТоваровКороба
	|ИЗ
	|	ШтрихкодыУпаковокТоваровКоробаПалеты КАК ШтрихкодыУпаковокТоваровКоробаПалеты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|		ПО СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка = ШтрихкодыУпаковокТоваровКоробаПалеты.ШтрихкодУпаковки
	|ГДЕ
	|	НЕ СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод = ЗНАЧЕНИЕ(Справочник.ШтрихкодыУпаковокТоваров.ПустаяСсылка)
	|	И (СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка)
	|		ИЛИ СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка))
	|			И СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипШтрихкода <> ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)
	|;
		
	//ВЫБЕРЕМ ДАННЫЕ ДОКУМЕНТА ПО СПРАВОЧНИКУ ШТРИХКОДЫ УПАКОВОК, ЕСЛИ ОНИ ЗАГРУЖЕНЫ
	//ТОЛЬКО ПО ТОВАРАМ, БЕЗ ГРУППОВЫХ УПАКОВОК (БЛОКИ СИГАРЕТ, ТОЖЕ ТОВАРЫ)
	//ОБЪЕДИНИМ СО СПРАВОЧНИКОМ ШТРИХКОДОВ ИЗ ГРУППОВЫХ УПАКОВОК	
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки КАК ШтрихкодУпаковки,
	|	ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки.ЗначениеШтрихкода КАК ЗначениеШтрихкода
	|ПОМЕСТИТЬ ШтрихкодыУпаковокТоваров  
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.ШтрихкодыУпаковок КАК ПриобретениеТоваровУслугШтрихкодыУпаковок
	|ГДЕ
	|	ПриобретениеТоваровУслугШтрихкодыУпаковок.Ссылка = &ИсходныйДокумент
	|	И НЕ ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки = ЗНАЧЕНИЕ(Справочник.ШтрихкодыУпаковокТоваров.ПустаяСсылка)
	|	И (ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|			ИЛИ (ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|				И ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки.ТипШтрихкода = ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)))
	
	//КОРОБА
	|ОБЪЕДИНИТЬ  
	|
	|ВЫБРАТЬ
	|	СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК ШтрихкодУпаковки,
	|	СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ЗначениеШтрихкода КАК ЗначениеШтрихкода
	|ИЗ
	|	ШтрихкодыУпаковокТоваровКоробаПалеты КАК ШтрихкодыУпаковокТоваровКоробаПалеты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|		ПО СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка = ШтрихкодыУпаковокТоваровКоробаПалеты.ШтрихкодУпаковки
	|ГДЕ
	|	НЕ СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод = ЗНАЧЕНИЕ(Справочник.ШтрихкодыУпаковокТоваров.ПустаяСсылка)
	|		И (СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|			ИЛИ ((СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|					ИЛИ СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|				И СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипШтрихкода = ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)))
	
	//ПАЛЕТЫ
	|ОБЪЕДИНИТЬ  
	|
	|ВЫБРАТЬ
	|	СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК ШтрихкодУпаковки,
	|	СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ЗначениеШтрихкода КАК ЗначениеШтрихкода
	|ИЗ
	|	ШтрихкодыУпаковокТоваровКороба КАК ШтрихкодыУпаковокТоваровКороба
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|		ПО СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка = ШтрихкодыУпаковокТоваровКороба.ШтрихкодУпаковки
	|ГДЕ
	|	НЕ СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод = ЗНАЧЕНИЕ(Справочник.ШтрихкодыУпаковокТоваров.ПустаяСсылка)
	|		И (СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|			ИЛИ ((СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|					ИЛИ СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|				И СправочникШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипШтрихкода = ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)))
	|;
	|
		
	//ВЫБЕРЕМ ДАННЫЕ ДОКУМЕНТА ПО ЗНАЧЕНИЯМ ШТРИХКОДОВ, ГДЕ НЕ ЗАПОЛНЕН СПРАВОЧНИК ШТРИХКОДЫ УПАКОВОК 
	//ТОЛЬКО ПО ТОВАРАМ, БЕЗ ГРУППОВЫХ УПАКОВОК (БЛОКИ СИГАРЕТ, ТОЖЕ ТОВАРЫ)
	//ПОПРОБУЕМ ОПРЕДЕЛИТЬ GTIN	
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПриобретениеТоваровУслугШтрихкодыУпаковок.ЗначениеШтрихкода КАК ЗначениеШтрихкода,
	|	ВЫБОР
	|		КОГДА ПОДСТРОКА(ПриобретениеТоваровУслугШтрихкодыУпаковок.ЗначениеШтрихкода, 3, 1) <> ""0""
	|			ТОГДА ПОДСТРОКА(ПриобретениеТоваровУслугШтрихкодыУпаковок.ЗначениеШтрихкода, 3, 14)
	|		ИНАЧЕ ВЫБОР
	|				КОГДА ПОДСТРОКА(ПриобретениеТоваровУслугШтрихкодыУпаковок.ЗначениеШтрихкода, 4, 1) <> ""0""
	|					ТОГДА ПОДСТРОКА(ПриобретениеТоваровУслугШтрихкодыУпаковок.ЗначениеШтрихкода, 4, 13)
	|				ИНАЧЕ ВЫБОР
	|						КОГДА ПОДСТРОКА(ПриобретениеТоваровУслугШтрихкодыУпаковок.ЗначениеШтрихкода, 5, 1) <> ""0""
	|							ТОГДА ПОДСТРОКА(ПриобретениеТоваровУслугШтрихкодыУпаковок.ЗначениеШтрихкода, 5, 12)
	|						ИНАЧЕ ВЫБОР
	|							КОГДА ПОДСТРОКА(ПриобретениеТоваровУслугШтрихкодыУпаковок.ЗначениеШтрихкода, 6, 1) <> ""0""
	|								ТОГДА ПОДСТРОКА(ПриобретениеТоваровУслугШтрихкодыУпаковок.ЗначениеШтрихкода, 5, 12)				   
	|							ИНАЧЕ ПОДСТРОКА(ПриобретениеТоваровУслугШтрихкодыУпаковок.ЗначениеШтрихкода, 9, 8)
	|							КОНЕЦ	
	|					КОНЕЦ
	|			КОНЕЦ
	|	КОНЕЦ КАК GTIN
	|ПОМЕСТИТЬ ЗначенияШтрихкодовТоваров
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.ШтрихкодыУпаковок КАК ПриобретениеТоваровУслугШтрихкодыУпаковок
	|ГДЕ
	|	ПриобретениеТоваровУслугШтрихкодыУпаковок.Ссылка = &ИсходныйДокумент
	|	И ПриобретениеТоваровУслугШтрихкодыУпаковок.ШтрихкодУпаковки = ЗНАЧЕНИЕ(Справочник.ШтрихкодыУпаковокТоваров.ПустаяСсылка)
	|	И ПОДСТРОКА(ПриобретениеТоваровУслугШтрихкодыУпаковок.ЗначениеШтрихкода, 1, 2) = ""01""
	|;
	|	
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка КАК Ссылка,
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.НомерСтроки КАК НомерСтроки,
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Штрихкод
	|ПОМЕСТИТЬ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|ГДЕ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.Номенклатура В
	|			(ВЫБРАТЬ
	|				ТоварыЗадания.Номенклатура КАК Номенклатура
	|			ИЗ
	|				ТоварыЗадания КАК ТоварыЗадания)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка КАК Ссылка,
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.НомерСтроки КАК НомерСтроки,
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Штрихкод
	|ПОМЕСТИТЬ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды2
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|ГДЕ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.Номенклатура В
	|			(ВЫБРАТЬ
	|				ТоварыЗадания.Номенклатура КАК Номенклатура
	|			ИЗ
	|				ТоварыЗадания КАК ТоварыЗадания)
	|;
	|
	
	//СФОРМИРУЕМ СОПОСТАВЛЕНИЕ ДАННЫХ С НОМЕНКЛАТУРОЙ
	//ПО ШТРИХКОДАМ УПАКОВОК ДАННЫЕ БЕРЕМ ИЗ СПРАВОЧНИКА
	//ПО ЗНАЧЕНИЯМ ШТРИХКОДОВ ДАННЫЕ БЕРЕМ ИЗ РЕГИСТРА
	//ПЛЮС МОГУТ ОСТАТЬСЯ НЕСОПОСТАВЛЕННЫЕ СТРОКИ (НАПРИМЕР УПРОЩЕНКА)	
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Номенклатура КАК Номенклатура,
	|	ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Характеристика КАК Характеристика,
	|	ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Серия КАК Серия,
	|	ВЫБОР
	|		КОГДА ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Количество = 0
	|			ТОГДА ВЫБОР
	|					КОГДА ЕСТЬNULL(ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Упаковка.Числитель, 0) = 0
	|						ТОГДА 1
	|					ИНАЧЕ ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Упаковка.Числитель
	|				КОНЕЦ
	|		ИНАЧЕ ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Количество
	|	КОНЕЦ КАК Коэффициент,
	|	ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода КАК Марка,
	|	МАКСИМУМ(ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.ЗначениеШтрихкода, """")) КАК Короб,
	|	МАКСИМУМ(ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды2.Ссылка.ЗначениеШтрихкода, """")) КАК Палета
	|ПОМЕСТИТЬ МаркиЗадания
	|ИЗ
	|	ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|		ПО ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки = ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод
	|		ЛЕВОЕ СОЕДИНЕНИЕ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды2 КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды2
	|		ПО (ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.ЗначениеШтрихкода, """") = ШтрихкодыУпаковокТоваровВложенныеШтрихкоды2.Штрихкод.ЗначениеШтрихкода)
	|
	|СГРУППИРОВАТЬ ПО
	|	ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Номенклатура,
	|	ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Характеристика,
	|	ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Серия,
	|	ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Упаковка,
	|	ШтрихкодыУпаковокТоваров.ШтрихкодУпаковки.Количество,
	|	ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода	
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(РегистрСведенийШтрихкодыНоменклатуры.Номенклатура, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка))),
	|	МАКСИМУМ(ЕСТЬNULL(РегистрСведенийШтрихкодыНоменклатуры.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка))),
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка),
	|	ВЫБОР 
	|		КОГДА МАКСИМУМ(ЕСТЬNULL(РегистрСведенийШтрихкодыНоменклатуры.Упаковка.Числитель,1))=0 
	|		ТОГДА 1
	|		ИНАЧЕ МАКСИМУМ(ЕСТЬNULL(РегистрСведенийШтрихкодыНоменклатуры.Упаковка.Числитель,1)) 
	|	КОНЕЦ,
	|	ЗначенияШтрихкодовТоваров.ЗначениеШтрихкода,
	|	"""",
	|	""""
	|ИЗ
	|	ЗначенияШтрихкодовТоваров КАК ЗначенияШтрихкодовТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыНоменклатуры КАК РегистрСведенийШтрихкодыНоменклатуры
	|		ПО ЗначенияШтрихкодовТоваров.GTIN = РегистрСведенийШтрихкодыНоменклатуры.Штрихкод
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗначенияШтрихкодовТоваров.ЗначениеШтрихкода
	|;
	|
	
	//ПОДСЧИТАЕМ КОЛИЧЕСТВО МАРОК КОТОРЫЕ ОПРЕДЕЛЕНЫ (ВОЗМОЖНО ОНИ В ДОКУМЕНТЕ Т0ЛЬКО ЧАСТИЧНО УКАЗАНЫ)	
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	МаркиЗадания.Номенклатура КАК Номенклатура,
	|	МаркиЗадания.Характеристика КАК Характеристика,
	|	МаркиЗадания.Серия КАК Серия,
	|	СУММА(МаркиЗадания.Коэффициент) КАК Количество
	|ПОМЕСТИТЬ КоличествоМарокЗадания
	|ИЗ
	|	МаркиЗадания КАК МаркиЗадания
	|ГДЕ
	|	НЕ МаркиЗадания.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	МаркиЗадания.Номенклатура,
	|	МаркиЗадания.Характеристика,
	|	МаркиЗадания.Серия
	|;
	|
	
	//РАСПРЕДЕЛИМ МАРКИ ПО ЗАДАНИЮ
	//ТО ЧТО НЕ РАСПРЕДЕЛИЛОСЬ ДОБАВИМ ОТДЕЛЬНО
	//ПРИ ЭТОМ МОГУТ БЫТЬ КАК ЛИШНИЕ МАРКИ, ТАК И ЛИШНИЕ ТОВАРЫ	
	|////////////////////////////////////////////////////////////////////////////////
	//1) СОПОСТАВЛЕНО ПОЛНОСТЬЮ
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	МаркиЗадания.Номенклатура КАК Номенклатура,
	|	МаркиЗадания.Характеристика КАК Характеристика,
	|	МаркиЗадания.Серия КАК Серия,
	|	МаркиЗадания.Коэффициент КАК Количество,
	|	МаркиЗадания.Марка КАК Марка,
	|	МаркиЗадания.Короб КАК Короб,
	|	МаркиЗадания.Палета КАК Палета,
	|	ТоварыЗадания.Цена КАК Цена,
	|	ТоварыЗадания.Лимит КАК Лимит,
	|	ТоварыЗадания.НомерСтроки КАК НомерСтроки
	|ПОМЕСТИТЬ ИтоговыеДанные
	|ИЗ
	|	МаркиЗадания КАК МаркиЗадания
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыЗадания КАК ТоварыЗадания
	|		ПО МаркиЗадания.Номенклатура = ТоварыЗадания.Номенклатура
	|			И МаркиЗадания.Характеристика = ТоварыЗадания.Характеристика
	|				И  МаркиЗадания.Серия = ТоварыЗадания.Серия
	|ГДЕ
	|	НЕ ТоварыЗадания.Номенклатура ЕСТЬ NULL
	|	И НЕ МаркиЗадания.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ
	|
	//2) МАРКИ С НЕОПРЕДЕЛЕННОЙ НОМЕНКЛАТУРОЙ (НЕУНИКАЛЬНЫЕ ШТРИХКОДЫ)
	|ВЫБРАТЬ
	|	ЕСТЬNULL(МаркиЗадания.Номенклатура, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) КАК Номенклатура,
	|	ЕСТЬNULL(МаркиЗадания.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК Характеристика,
	|	ЕСТЬNULL(МаркиЗадания.Серия, ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)) КАК Серия,
	|	МаркиЗадания.Коэффициент КАК Количество,
	|	МаркиЗадания.Марка КАК Марка,
	|	МаркиЗадания.Короб КАК Короб,
	|	МаркиЗадания.Палета КАК Палета,
	|	0 КАК Цена,
	|	0 КАК Лимит,
	|	77777 КАК НомерСтроки
	|ИЗ
	|	МаркиЗадания КАК МаркиЗадания
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыЗадания КАК ТоварыЗадания
	|		ПО МаркиЗадания.Номенклатура = ТоварыЗадания.Номенклатура
	|			И МаркиЗадания.Характеристика = ТоварыЗадания.Характеристика
	|				И  МаркиЗадания.Серия = ТоварыЗадания.Серия
	|ГДЕ
	|	ТоварыЗадания.Номенклатура ЕСТЬ NULL
	|	И НЕ МаркиЗадания.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ
	|
	//3) МАРКИ С НЕОПРЕДЕЛЕННОЙ НОМЕНКЛАТУРОЙ (УПРОЩЕНКА)
	|ВЫБРАТЬ
	|	МаркиЗадания.Номенклатура,
	|	МаркиЗадания.Характеристика,
	|	МаркиЗадания.Серия,
	|	МаркиЗадания.Коэффициент,
	|	МаркиЗадания.Марка,
	|	МаркиЗадания.Короб,
	|	МаркиЗадания.Палета,
	|	0,
	|	0,
	|	99999
	|ИЗ
	|	МаркиЗадания КАК МаркиЗадания
	|ГДЕ
	|	МаркиЗадания.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ
	|				      
	//4) СТРОКИ ЗАДАНИЯ БЕЗ МАРОК (ВРЕМЕННО ВОЗМОЖНО ЧАСТИЧНОЕ УКАЗАНИЕ МАРОК)
	|ВЫБРАТЬ
	|	ТоварыЗадания.Номенклатура,
	|	ТоварыЗадания.Характеристика,
	|	ТоварыЗадания.Серия,
	|	ТоварыЗадания.Количество - ЕСТЬNULL(КоличествоМарокЗадания.Количество, 0),
	|	"""",
	|	"""",
	|	"""",
	|	ТоварыЗадания.Цена,
	|	ТоварыЗадания.Лимит,
	|	ТоварыЗадания.НомерСтроки
	|ИЗ
	|	ТоварыЗадания КАК ТоварыЗадания
	|		ЛЕВОЕ СОЕДИНЕНИЕ КоличествоМарокЗадания КАК КоличествоМарокЗадания
	|		ПО ТоварыЗадания.Номенклатура = КоличествоМарокЗадания.Номенклатура
	|			И ТоварыЗадания.Характеристика = КоличествоМарокЗадания.Характеристика
	|				И  ТоварыЗадания.Серия = КоличествоМарокЗадания.Серия
	|ГДЕ
	|	ТоварыЗадания.Количество - ЕСТЬNULL(КоличествоМарокЗадания.Количество, 0) > 0
	|;
	|
	
	//ИТОГ	
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ИтоговыеДанные.Номенклатура КАК Номенклатура,
	|	ИтоговыеДанные.Характеристика КАК Характеристика,
	|	ИтоговыеДанные.Серия КАК Серия,
	|	ИтоговыеДанные.Количество КАК Количество,
	|	ИтоговыеДанные.Марка КАК Марка,
	|	ИтоговыеДанные.Короб КАК Короб,
	|	ИтоговыеДанные.Палета КАК Палета,
	|	ИтоговыеДанные.Цена КАК Цена,
	|	ИтоговыеДанные.Лимит КАК Лимит,
	|	ИтоговыеДанные.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	ИтоговыеДанные КАК ИтоговыеДанные
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИтоговыеДанные.НомерСтроки УБЫВ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыЗадания
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ШтрихкодыУпаковокТоваровКоробаПалеты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ШтрихкодыУпаковокТоваровКороба
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ШтрихкодыУпаковокТоваров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ЗначенияШтрихкодовТоваров
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ МаркиЗадания
	|;
	|	 
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|;   
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды2
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ КоличествоМарокЗадания
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ИтоговыеДанные";	
	
	Если Шаблон.ВидДокумента = "ЗаказНаЭмиссиюКодовМаркировкиСУЗ" Тогда
		СкорректироватьЗапросПолучитьСтрокиДокументаМаркировка(Запрос, СсылкаНаДок.ИсходныйДокумент, РеквизитыШаблона);	
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок);
	Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ПриобретениеТоваровУслуг.", "." + Шаблон.ВидДокумента + ".");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
	
	//Если у документа есть склад берем остатки по складу документа иначе склады из настроек ТСД
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	МетаданныеДокумента = Метаданные.Документы[Шаблон.ВидДокумента];
	
	Попытка
		ЕстьЦены = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Цена") <> Неопределено;
	Исключение
		ЕстьЦены = Ложь;
	КонецПопытки;
		
	Если ЕстьЦены Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "ТаблицаТоваровВДокументе.Цена");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "0");
	КонецЕсли;	
	
	Попытка
		ЕстьСерии = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Серия") <> Неопределено;
	Исключение
		ЕстьСерии = Ложь;
	КонецПопытки;
	
	Если ЕстьСерии Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "ТаблицаТоваровВДокументе.Серия");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "Значение(Справочник.СерииНоменклатуры.ПустаяСсылка)");
	КонецЕсли;	
	
	Попытка
		ЕстьКоличествоУпаковок = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("КоличествоУпаковок") <> Неопределено;
	Исключение
		ЕстьКоличествоУпаковок = Ложь;
	КонецПопытки;
	
	Если ЕстьКоличествоУпаковок Тогда
		Если УзелПО.НеИспользоватьПересчетУпаковок Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество,", "ТаблицаТоваровВДокументе.КоличествоУпаковок,");
		КонецЕсли;
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.КоличествоУпаковок", "ТаблицаТоваровВДокументе.Количество");
	КонецЕсли;	
	
	Если Шаблон.ИспользоватьМаркировку И Шаблон.МаркировкаЗапретитьПодборНемаркируемыхТоваров Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент 
		|   	И
		|   	(
		|   	(ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПустаяСсылка) 
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.АлкогольнаяПродукция)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.СодержитДрагоценныеМатериалы)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.КиЗГИСМ)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПодконтрольнаяПродукцияВЕТИС)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПродавцом)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПоАгентскойСхеме)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.Партнером)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.БезОсобенностейУчета))
		|   	ИЛИ
		|   	(ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПустаяСсылка) 
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.АлкогольнаяПродукция)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.СодержитДрагоценныеМатериалы)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.КиЗГИСМ)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПодконтрольнаяПродукцияВЕТИС)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПродавцом)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПоАгентскойСхеме)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.Партнером)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.БезОсобенностейУчета))
		|   	)");		
	КонецЕсли;	
	
	//СОПОСТАВЛЕНИЕ ЭДО
	Если Шаблон.ВидДокумента = "ПриобретениеТоваровУслуг" Тогда	
		Модуь_ШтрихкодированиеИСМПСлужебный = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ШтрихкодированиеИСМПСлужебный");
		ДанныеНоменклатурыПоДаннымУПД = Модуь_ШтрихкодированиеИСМПСлужебный.ДанныеМаркируемойНоменклатурыПоДаннымУПД(СсылкаНаДок.ИсходныйДокумент);
	КонецЕсли;
	
	//СОПОСТАВЛЕНИЕ ФОРМЫ ПРОВЕРКИ И ПОДБОРА
	Попытка 
		ДанныеНоменклатурыПоДаннымСтатусовПроверкиИПодбора = ДатаМобайл_Маркировка.ДанныеНоменклатурыПоДаннымСтатусовПроверкиИПодбора(СсылкаНаДок.ИсходныйДокумент);
	Исключение
		ДанныеНоменклатурыПоДаннымСтатусовПроверкиИПодбора = Неопределено; 
	КонецПопытки;	
	СведенияПоEAN = Неопределено;
	
	ТЗКМРаспределить = Новый ТаблицаЗначений;
	ТЗКМРаспределить.Колонки.Добавить("Номенклатура");
	ТЗКМРаспределить.Колонки.Добавить("Характеристика");
	ТЗКМРаспределить.Колонки.Добавить("Количество");
	
	ПроверкаОСГ = Шаблон.ПроверкаОСГ;
	
	Рез = Запрос.Выполнить().Выгрузить();
	Для каждого СтрокаДока Из Рез Цикл
		
		СтруктураТекущейСтроки = Новый Структура;	
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
		
		Если ЗначениеЗаполнено(СтрокаДока.Номенклатура) Тогда
			Если ЗначениеЗаполнено(СтрокаДока.Характеристика) Тогда
				ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
				Попытка ОбъектТовара.parent_id = ?(XMLСтрока(СтрокаДока.Характеристика) = "00000000-0000-0000-0000-000000000000", "", "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
			Иначе
				ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000";
			КонецЕсли;
			
		Иначе
			
			Если Не ЗначениеЗаполнено(СтрокаДока.Марка) Тогда
				Продолжить;
			КонецЕсли;
			
			//Попробовать найти номенклатуру из сопоставления документа ЭДО
			Если Шаблон.ВидДокумента = "ПриобретениеТоваровУслуг" Тогда
				СведенияПоEAN = ДанныеНоменклатурыПоДаннымУПД.Получить(СтрокаДока.Марка);
			КонецЕсли;
			//Попробовать найти номенклатуру из сопоставления формы проверки и подбора
			Если СведенияПоEAN = Неопределено И ДанныеНоменклатурыПоДаннымСтатусовПроверкиИПодбора <> Неопределено Тогда
				СведенияПоEAN = ДанныеНоменклатурыПоДаннымСтатусовПроверкиИПодбора.Получить(СтрокаДока.Марка);
			КонецЕсли;
			
			Если СведенияПоEAN <> Неопределено Тогда
				Если ЗначениеЗаполнено(СведенияПоEAN.Номенклатура) Тогда
					
					Если ЗначениеЗаполнено(СведенияПоEAN.Характеристика) Тогда
						ОбъектТовара.id = "8U-" + СокрЛП(СведенияПоEAN.Номенклатура.УникальныйИдентификатор()) + СокрЛП(СведенияПоEAN.Характеристика.УникальныйИдентификатор());
						Попытка ОбъектТовара.parent_id = ?(СокрЛП(СведенияПоEAN.Характеристика.УникальныйИдентификатор()) = "00000000-0000-0000-0000-000000000000", "", "8U-" + СокрЛП(СведенияПоEAN.Номенклатура.УникальныйИдентификатор()) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
					Иначе
						ОбъектТовара.id = "8U-" + СокрЛП(СведенияПоEAN.Номенклатура.УникальныйИдентификатор()) + "00000000-0000-0000-0000-000000000000";
					КонецЕсли;
					
					СтрокаРаспределения = ТЗКМРаспределить.Добавить();
					СтрокаРаспределения.Номенклатура = СведенияПоEAN.Номенклатура;
					СтрокаРаспределения.Характеристика = СведенияПоEAN.Характеристика;
					СтрокаРаспределения.Количество = 1;
					
				Иначе			
					ОбъектТовара.id = "00000000-0000-0000-0000-000000000000";	
				КонецЕсли;	
			Иначе			
				ОбъектТовара.id = "00000000-0000-0000-0000-000000000000";	
			КонецЕсли;		
		КонецЕсли;
		
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		ТекущееКоличество = СтрокаДока.Количество;
		Если ТЗКМРаспределить.Количество() > 0 И Не ЗначениеЗаполнено(СтрокаДока.Марка) Тогда			
			Отбор = Новый Структура;
			Отбор.Вставить("Номенклатура", СтрокаДока.Номенклатура);
			Отбор.Вставить("Характеристика", СтрокаДока.Характеристика);
			
			ТЗКМРаспределить.Свернуть("Номенклатура,Характеристика","Количество");
			Строки = ТЗКМРаспределить.НайтиСтроки(Отбор);
			Для каждого Стр Из Строки Цикл
				Если ТекущееКоличество > 0 Тогда
					ТекущееКоличество = ТекущееКоличество - Стр.Количество;	
					ТЗКМРаспределить.Удалить(Стр);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
				
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда
				sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускВесовогоТовара = Неопределено;
		КонецПопытки;
		
		Если ДопускВесовогоТовара <> Неопределено Тогда
			СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
		КонецЕсли;
		
		Попытка
			ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускОСГ = Неопределено;
		КонецПопытки;
		
		Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
			СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
		КонецЕсли;
		
		ЭтоУслуга = Ложь;
		Попытка 
			Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
				ЭтоУслуга = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		ЭтоНабор = Ложь;
		Попытка 
			Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Набор Тогда
				ЭтоНабор = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Если ЭтоНабор И Шаблон.РежимКомплектации = 1 Тогда
			СтруктураТекущейСтроки.Вставить("is_kit", Истина);
		Иначе
			СтруктураТекущейСтроки.Вставить("is_kit", Ложь);	
		КонецЕсли;
		
		price = СтрокаДока.Цена;	
		СтруктураТекущейСтроки.Вставить("price", price);	
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		ИначеЕсли ЭтоУслуга Тогда
			limit_qty = 999;
		Иначе			
			Попытка
				Итог = СтрокаДока.Лимит;
				Если Шаблон.ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
					Итог = Итог + ТекущееКоличество;		 
				КонецЕсли;
				limit_qty = Итог;
			Исключение
				limit_qty = 0;
			КонецПопытки;
		КонецЕсли;
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		
		qty = ТекущееКоличество;
		СтруктураТекущейСтроки.Вставить("qty", qty);
		СтруктураТекущейСтроки.Вставить("unit_qty", qty);
		
		ОбъектМаркировка = ПолучитьСтруктуруОбъектаДляHttp("marking");
		ТипПродукции = ДатаМобайл_Маркировка.ПолучитьТипМаркированнойПродукции(СтрокаДока.Номенклатура); 
		ОбъектМаркировка.mark = ДатаМобайл_Маркировка.УбратьСкобкиТеговМарка(СтрокаДока.Марка, ТипПродукции);
		
		Если ЗначениеЗаполнено(ОбъектМаркировка.mark) Тогда
			СтруктураТекущейСтроки.Вставить("marking", ОбъектМаркировка);
		КонецЕсли;
		
		box_pack = ДатаМобайл_Маркировка.УбратьСкобкиТеговУпаковка(СтрокаДока.Короб);
		Если ЗначениеЗаполнено(box_pack) Тогда
			СтруктураТекущейСтроки.Вставить("box_pack", box_pack);
		КонецЕсли;
		
		pack = ДатаМобайл_Маркировка.УбратьСкобкиТеговУпаковка(СтрокаДока.Палета);
		Если ЗначениеЗаполнено(pack) Тогда
			СтруктураТекущейСтроки.Вставить("pack", pack);
		КонецЕсли;
		
		// атрибуты строки
		СтруктураПоиска = Новый Структура("НомерСтроки");
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаДока);
		СписокАтрибутов = ПолучитьАтрибутыСтрокиДокумента(СсылкаНаДок, СтрокаДока,,СтруктураПоиска);
		СтруктураТекущейСтроки.Вставить("attributes", СписокАтрибутов);
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);		
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПолучитьСтрокиДокументаМДЛП(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок)
	
	МаркировкаОнлайнПроверкаВложенностиУпаковок = Шаблон.МаркировкаОнлайнПроверкаВложенностиУпаковок;
	
	Если МаркировкаОнлайнПроверкаВложенностиУпаковок Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	СУММА(ТоварыНаСкладахОстатки.ВНаличииОстаток) КАК ВНаличииОстаток,
		|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
		|	ТоварыНаСкладахОстатки.Характеристика КАК Характеристика
		|ПОМЕСТИТЬ ТоварыНаСкладахОстатки
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Остатки КАК ТоварыНаСкладахОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	ТоварыНаСкладахОстатки.Номенклатура,
		|	ТоварыНаСкладахОстатки.Характеристика
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	УведомлениеОПриемкеМДЛПТовары.Номенклатура КАК Номенклатура,
		|	ЕСТЬNULL(УведомлениеОПриемкеМДЛПТовары.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК Характеристика,
		|	УведомлениеОПриемкеМДЛПТовары.Серия КАК Серия,
		|	УведомлениеОПриемкеМДЛПТовары.GTIN КАК GTIN,
		|	УведомлениеОПриемкеМДЛПТовары.НомерСерии КАК НомерСерии,
		|	УведомлениеОПриемкеМДЛПТовары.Цена КАК Цена,
		|	"""" КАК Короб,
		|	УведомлениеОПриемкеМДЛПТовары.КоличествоУпаковок КАК Количество,
		|	УведомлениеОПриемкеМДЛПТовары.ИдентификаторСтроки КАК ИдентификаторСтроки,
		|	ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0) КАК Остаток
		|ПОМЕСТИТЬ Товары
		|ИЗ
		|	Документ.УведомлениеОПриемкеМДЛП.Товары КАК УведомлениеОПриемкеМДЛПТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыНаСкладахОстатки КАК ТоварыНаСкладахОстатки
		|		ПО УведомлениеОПриемкеМДЛПТовары.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
		|			И (ЕСТЬNULL(УведомлениеОПриемкеМДЛПТовары.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) = ТоварыНаСкладахОстатки.Характеристика)
		|ГДЕ
		|	УведомлениеОПриемкеМДЛПТовары.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	УведомлениеОПриемкеМДЛПНомераУпаковок.ИдентификаторСтроки КАК ИдентификаторСтроки,
		|	УведомлениеОПриемкеМДЛПНомераУпаковок.НомерКИЗ КАК НомерКИЗ,
		|	УведомлениеОПриемкеМДЛПНомераУпаковок.НомерРодительскойУпаковки КАК НомерКороба
		|ПОМЕСТИТЬ Марки
		|ИЗ
		|	Документ.УведомлениеОПриемкеМДЛП.НомераУпаковок КАК УведомлениеОПриемкеМДЛПНомераУпаковок
		|ГДЕ
		|	УведомлениеОПриемкеМДЛПНомераУпаковок.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	УведомлениеОПриемкеМДЛПТранспортныеУпаковки.ИдентификаторСтроки КАК ИдентификаторСтроки,
		|	УведомлениеОПриемкеМДЛПТранспортныеУпаковки.НомерУпаковки КАК НомерУпаковки
		|ПОМЕСТИТЬ Упаковки
		|ИЗ
		|	Документ.УведомлениеОПриемкеМДЛП.ТранспортныеУпаковки КАК УведомлениеОПриемкеМДЛПТранспортныеУпаковки
		|ГДЕ
		|	УведомлениеОПриемкеМДЛПТранспортныеУпаковки.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	УведомлениеОПриемкеМДЛПТовары.Номенклатура КАК Номенклатура,
		|	ЕСТЬNULL(УведомлениеОПриемкеМДЛПТовары.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК Характеристика,
		|	УведомлениеОПриемкеМДЛПТовары.Серия КАК Серия,
		|	УведомлениеОПриемкеМДЛПТовары.GTIN КАК GTIN,
		|	УведомлениеОПриемкеМДЛПТовары.НомерСерии КАК НомерСерии,
		|	УведомлениеОПриемкеМДЛПТовары.Цена КАК Цена,
		|	УведомлениеОПриемкеМДЛПТовары.Количество КАК Количество,
		|	УведомлениеОПриемкеМДЛПТовары.ИдентификаторСтроки КАК ИдентификаторСтроки,
		|	УведомлениеОПриемкеМДЛПТовары.ИдентификаторСтрокиУпаковки КАК ИдентификаторСтрокиУпаковки,
		|	ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0) КАК Остаток
		|ПОМЕСТИТЬ ТоварыУпаковок
		|ИЗ
		|	Документ.УведомлениеОПриемкеМДЛП.СоставТранспортныхУпаковок КАК УведомлениеОПриемкеМДЛПТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыНаСкладахОстатки КАК ТоварыНаСкладахОстатки
		|		ПО УведомлениеОПриемкеМДЛПТовары.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
		|			И (ЕСТЬNULL(УведомлениеОПриемкеМДЛПТовары.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) = ТоварыНаСкладахОстатки.Характеристика)
		|ГДЕ
		|	УведомлениеОПриемкеМДЛПТовары.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Товары.Номенклатура КАК Номенклатура,
		|	Товары.Характеристика КАК Характеристика,
		|	Товары.Серия КАК Серия,
		|	ЕСТЬNULL(Товары.GTIN, """") КАК GTIN,
		|	ЕСТЬNULL(Товары.НомерСерии, """") КАК НомерСерии,
		|	Товары.Цена КАК Цена,
		|	1 КАК Количество,
		|	ЕСТЬNULL(Товары.Остаток, 0) КАК Остаток,
		|	ЕСТЬNULL(Марки.НомерКИЗ, """") КАК Марка,
		|	"""" КАК Короб,
		|	"""" КАК Палета
		|ПОМЕСТИТЬ ВременнаяТаблица
		|ИЗ
		|	Товары КАК Товары
		|		ЛЕВОЕ СОЕДИНЕНИЕ Марки КАК Марки
		|		ПО Товары.ИдентификаторСтроки = Марки.ИдентификаторСтроки
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Товары.Номенклатура,
		|	Товары.Характеристика,
		|	Товары.Серия,
		|	ЕСТЬNULL(Товары.GTIN, """"),
		|	ЕСТЬNULL(Товары.НомерСерии, """"),
		|	Товары.Цена,
		|	1,
		|	ЕСТЬNULL(Товары.Остаток, 0),
		|	ЕСТЬNULL(Марки.НомерКИЗ, """"),
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(Марки.НомерКороба, """") = """"
		|			ТОГДА ЕСТЬNULL(Упаковки.НомерУпаковки, """")
		|		ИНАЧЕ ЕСТЬNULL(Марки.НомерКороба, """")
		|	КОНЕЦ,
		|	ВЫБОР
		|		КОГДА ЕСТЬNULL(Марки.НомерКороба, """") = """"
		|			ТОГДА """"
		|		ИНАЧЕ ЕСТЬNULL(Упаковки.НомерУпаковки, """")
		|	КОНЕЦ
		|ИЗ
		|	ТоварыУпаковок КАК Товары
		|		ЛЕВОЕ СОЕДИНЕНИЕ Марки КАК Марки
		|		ПО Товары.ИдентификаторСтрокиУпаковки = Марки.ИдентификаторСтроки
		|		ЛЕВОЕ СОЕДИНЕНИЕ Упаковки КАК Упаковки
		|		ПО Товары.ИдентификаторСтроки = Упаковки.ИдентификаторСтроки
		|			И (Упаковки.НомерУпаковки <> ЕСТЬNULL(Марки.НомерКороба, """"))
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВременнаяТаблица.Номенклатура КАК Номенклатура,
		|	ВременнаяТаблица.Характеристика КАК Характеристика,
		|	ВременнаяТаблица.Серия КАК Серия,
		|	ВременнаяТаблица.GTIN КАК GTIN,
		|	ВременнаяТаблица.НомерСерии КАК НомерСерии,
		|	СРЕДНЕЕ(ВременнаяТаблица.Цена) КАК Цена,
		|	СУММА(ВременнаяТаблица.Количество) КАК Количество,
		|	СУММА(ВременнаяТаблица.Остаток) КАК Остаток,
		|	ВременнаяТаблица.Короб КАК Короб,
		|	ВременнаяТаблица.Палета КАК Палета,
		|	"""" КАК Марка
		|ИЗ
		|	ВременнаяТаблица КАК ВременнаяТаблица
		|
		|СГРУППИРОВАТЬ ПО
		|	ВременнаяТаблица.Номенклатура,
		|	ВременнаяТаблица.Характеристика,
		|	ВременнаяТаблица.Серия,
		|	ВременнаяТаблица.GTIN,
		|	ВременнаяТаблица.НомерСерии,
		|	ВременнаяТаблица.Короб,
		|	ВременнаяТаблица.Палета";
		
		Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок.ИсходныйДокумент);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл			
			ЗаполнитьСтрокуДокаМаркировкаМДЛП(Шаблон, ОбъектСписка, Выборка, Выборка.Количество, Истина);						
		КонецЦикла;
		
		//Возврат;
		
	Иначе
		
		//МАРКИ
		ЗапросТоваров = Новый Запрос;
		ЗапросТоваров.Текст =
		
		"ВЫБРАТЬ
		|	СУММА(ТоварыНаСкладахОстатки.ВНаличииОстаток) КАК ВНаличииОстаток,
		|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
		|	ТоварыНаСкладахОстатки.Характеристика КАК Характеристика
		|ПОМЕСТИТЬ ТоварыНаСкладахОстатки
		|ИЗ
		|  РегистрНакопления.ТоварыНаСкладах.Остатки КАК ТоварыНаСкладахОстатки
		|СГРУППИРОВАТЬ ПО
		|	ТоварыНаСкладахОстатки.Номенклатура,
		|	ТоварыНаСкладахОстатки.Характеристика	
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////	
		|ВЫБРАТЬ
		|	УведомлениеОПриемкеМДЛПТовары.Номенклатура КАК Номенклатура,
		|	ЕСТЬNULL(УведомлениеОПриемкеМДЛПТовары.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК Характеристика,
		|	УведомлениеОПриемкеМДЛПТовары.Серия КАК Серия,
		|	УведомлениеОПриемкеМДЛПТовары.GTIN КАК GTIN,
		|	УведомлениеОПриемкеМДЛПТовары.НомерСерии КАК НомерСерии,
		|	УведомлениеОПриемкеМДЛПТовары.Цена КАК Цена,
		|	"""" КАК Короб,
		|	УведомлениеОПриемкеМДЛПТовары.КоличествоУпаковок КАК Количество,
		|	УведомлениеОПриемкеМДЛПТовары.ИдентификаторСтроки КАК ИдентификаторСтроки,
		|	ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток,0) КАК Остаток
		|ПОМЕСТИТЬ Товары
		|ИЗ
		|	Документ.УведомлениеОПриемкеМДЛП.Товары КАК УведомлениеОПриемкеМДЛПТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыНаСкладахОстатки КАК ТоварыНаСкладахОстатки
		|		ПО УведомлениеОПриемкеМДЛПТовары.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
		|			И (ЕСТЬNULL(УведомлениеОПриемкеМДЛПТовары.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) = ТоварыНаСкладахОстатки.Характеристика)
		|ГДЕ
		|	УведомлениеОПриемкеМДЛПТовары.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	УведомлениеОПриемкеМДЛПНомераУпаковок.ИдентификаторСтроки КАК ИдентификаторСтроки,
		|	УведомлениеОПриемкеМДЛПНомераУпаковок.НомерКИЗ КАК НомерКИЗ,
		|	УведомлениеОПриемкеМДЛПНомераУпаковок.НомерРодительскойУпаковки КАК НомерКороба
		|ПОМЕСТИТЬ Марки
		|ИЗ
		|	Документ.УведомлениеОПриемкеМДЛП.НомераУпаковок КАК УведомлениеОПриемкеМДЛПНомераУпаковок
		|ГДЕ
		|	УведомлениеОПриемкеМДЛПНомераУпаковок.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	УведомлениеОПриемкеМДЛПТранспортныеУпаковки.ИдентификаторСтроки КАК ИдентификаторСтроки,
		|	УведомлениеОПриемкеМДЛПТранспортныеУпаковки.НомерУпаковки КАК НомерУпаковки
		|ПОМЕСТИТЬ Упаковки
		|ИЗ
		|	Документ.УведомлениеОПриемкеМДЛП.ТранспортныеУпаковки КАК УведомлениеОПриемкеМДЛПТранспортныеУпаковки
		|ГДЕ
		|	УведомлениеОПриемкеМДЛПТранспортныеУпаковки.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	УведомлениеОПриемкеМДЛПТовары.Номенклатура КАК Номенклатура,
		|	ЕСТЬNULL(УведомлениеОПриемкеМДЛПТовары.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК Характеристика,
		|	УведомлениеОПриемкеМДЛПТовары.Серия КАК Серия,
		|	УведомлениеОПриемкеМДЛПТовары.GTIN КАК GTIN,
		|	УведомлениеОПриемкеМДЛПТовары.НомерСерии КАК НомерСерии,
		|	УведомлениеОПриемкеМДЛПТовары.Цена КАК Цена,
		|	УведомлениеОПриемкеМДЛПТовары.Количество КАК Количество,
		|	УведомлениеОПриемкеМДЛПТовары.ИдентификаторСтроки КАК ИдентификаторСтроки,
		|	УведомлениеОПриемкеМДЛПТовары.ИдентификаторСтрокиУпаковки КАК ИдентификаторСтрокиУпаковки,
		|	ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток,0) КАК Остаток
		|ПОМЕСТИТЬ ТоварыУпаковок
		|ИЗ
		|	Документ.УведомлениеОПриемкеМДЛП.СоставТранспортныхУпаковок КАК УведомлениеОПриемкеМДЛПТовары
		|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыНаСкладахОстатки КАК ТоварыНаСкладахОстатки
		|		ПО УведомлениеОПриемкеМДЛПТовары.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
		|			И (ЕСТЬNULL(УведомлениеОПриемкеМДЛПТовары.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) = ТоварыНаСкладахОстатки.Характеристика)
		|ГДЕ
		|	УведомлениеОПриемкеМДЛПТовары.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Товары.Номенклатура КАК Номенклатура,
		|	Товары.Характеристика КАК Характеристика,
		|	Товары.Серия КАК Серия,
		|	ЕСТЬNULL(Товары.GTIN, """") КАК GTIN,
		|	ЕСТЬNULL(Товары.НомерСерии, """") КАК НомерСерии,
		|	Товары.Цена КАК Цена,
		|	Товары.Количество КАК Количество,
		|	ЕСТЬNULL(Товары.Остаток, 0) КАК Остаток,
		|	ЕСТЬNULL(Марки.НомерКИЗ, """") КАК Марка,
		|	"""" КАК Короб,
		|	"""" КАК Палета
		|ИЗ
		|	Товары КАК Товары
		|		ЛЕВОЕ СОЕДИНЕНИЕ Марки КАК Марки
		|		ПО Товары.ИдентификаторСтроки = Марки.ИдентификаторСтроки
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	Товары.Номенклатура,
		|	Товары.Характеристика,
		|	Товары.Серия,
		|	ЕСТЬNULL(Товары.GTIN, """"),
		|	ЕСТЬNULL(Товары.НомерСерии, """"),
		|	Товары.Цена,
		|	Товары.Количество,
		|	ЕСТЬNULL(Товары.Остаток, 0),
		|	ЕСТЬNULL(Марки.НомерКИЗ, """"),
		|	ВЫБОР КОГДА ЕСТЬNULL(Марки.НомерКороба, """") ="""" ТОГДА ЕСТЬNULL(Упаковки.НомерУпаковки, """") ИНАЧЕ ЕСТЬNULL(Марки.НомерКороба, """") КОНЕЦ,
		|	ВЫБОР КОГДА ЕСТЬNULL(Марки.НомерКороба, """") ="""" ТОГДА """" ИНАЧЕ ЕСТЬNULL(Упаковки.НомерУпаковки, """") КОНЕЦ
		|ИЗ
		|	ТоварыУпаковок КАК Товары
		|		ЛЕВОЕ СОЕДИНЕНИЕ Марки КАК Марки
		|		ПО Товары.ИдентификаторСтрокиУпаковки = Марки.ИдентификаторСтроки
		|		ЛЕВОЕ СОЕДИНЕНИЕ Упаковки КАК Упаковки
		|		ПО Товары.ИдентификаторСтроки = Упаковки.ИдентификаторСтроки
		|		И  Упаковки.НомерУпаковки<>ЕСТЬNULL(Марки.НомерКороба,"""")
		|ИТОГИ
		|	СРЕДНЕЕ(Цена),
		|	СРЕДНЕЕ(Количество),
		|	СРЕДНЕЕ(Остаток)
		|ПО
		|	Номенклатура,
		|	Характеристика";
		
		
		ЗапросТоваров.УстановитьПараметр("Ссылка", СсылкаНаДок.ИсходныйДокумент); 
		
		ВыборкаТоваров = ЗапросТоваров.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);	
		
		Пока ВыборкаТоваров.Следующий() Цикл
			
			ВыборкаХарактеристик = ВыборкаТоваров.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			
			Пока ВыборкаХарактеристик.Следующий() Цикл
				
				ВыборкаМарок = ВыборкаХарактеристик.Выбрать();
				
				Пока ВыборкаМарок.Следующий() Цикл
					ЗаполнитьСтрокуДокаМаркировкаМДЛП(Шаблон, ОбъектСписка, ВыборкаМарок, 1);			
				КонецЦикла;
				
			КонецЦикла;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьСтрокуДокаМаркировкаМДЛП(Шаблон, ОбъектСписка, ВыборкаТоваров, Количество, БезМарок = Ложь)
	
	СтруктураТекущейСтроки = Новый Структура;
	
	ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
	Если ЗначениеЗаполнено(ВыборкаТоваров.Характеристика) Тогда
		ОбъектТовара.id = "8U-" + XMLСтрока(ВыборкаТоваров.Номенклатура) + XMLСтрока(ВыборкаТоваров.Характеристика);
		Попытка ОбъектТовара.parent_id = ?(XMLСтрока(ВыборкаТоваров.Характеристика) = "00000000-0000-0000-0000-000000000000", "", "8U-" + XMLСтрока(ВыборкаТоваров.Номенклатура) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
	Иначе
		ОбъектТовара.id = "8U-" + XMLСтрока(ВыборкаТоваров.Номенклатура) + "00000000-0000-0000-0000-000000000000";
	КонецЕсли;
	
	СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
	Попытка
		Если БезМарок Тогда
			sn = "";
		Иначе
			sn = ВыборкаТоваров.НомерСерии;	
		КонецЕсли;
		
		Если ЗначениеЗаполнено(sn) Тогда
			СтруктураТекущейСтроки.Вставить("sn", sn);
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	price = ВыборкаТоваров.Цена;	
	СтруктураТекущейСтроки.Вставить("price", price);
	
	Если БезМарок Тогда
		qty = Количество;	
	Иначе
		qty = 1;
	КонецЕсли;	
	СтруктураТекущейСтроки.Вставить("qty", qty);
	СтруктураТекущейСтроки.Вставить("unit_qty", qty);
	
	limit_qty = ВыборкаТоваров.Остаток;	
	Если Шаблон.ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
		limit_qty = limit_qty + qty;		 
	КонецЕсли;
	СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
	
	//Если БезМарок Тогда
	//Иначе	
		
		ОбъектМаркировка = ПолучитьСтруктуруОбъектаДляHttp("marking");
		ЧистаяМарка = "";
		Если ВыборкаТоваров.Марка <> "" Тогда
			ЧистаяМарка = ДатаМобайл_МДЛП.ДобавитьВМаркуУпрСимволы(ВыборкаТоваров.Марка);
		Иначе
			ЧистаяМарка = ВыборкаТоваров.Марка;	
		КонецЕсли;
		ОбъектМаркировка.mark = ЧистаяМарка;
		
		Если ЗначениеЗаполнено(ОбъектМаркировка.mark) Тогда
			СтруктураТекущейСтроки.Вставить("marking", ОбъектМаркировка);
		КонецЕсли;
				
		Если СтрДлина(ВыборкаТоваров.Короб) = 18 Тогда
			box_pack = "00" + ВыборкаТоваров.Короб;
		Иначе
			box_pack = ВыборкаТоваров.Короб;
		КонецЕсли;
		Если ЗначениеЗаполнено(box_pack) Тогда
			СтруктураТекущейСтроки.Вставить("box_pack", box_pack);
		КонецЕсли;
				
		Если СтрДлина(ВыборкаТоваров.Палета) = 18 Тогда
			pack = "00" + ВыборкаТоваров.Палета;
		Иначе
			pack = ВыборкаТоваров.Палета;
		КонецЕсли;
		Если ЗначениеЗаполнено(pack) Тогда
			СтруктураТекущейСтроки.Вставить("pack", pack);
		КонецЕсли;
		
	//КонецЕсли;
			
	ОбъектСписка.Добавить(СтруктураТекущейСтроки);
	
КонецПроцедуры

Процедура GetDocRowsSelectOrderToReplace(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок)   //!!!
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика КАК Характеристика,
	|	&УсловиеСерия КАК Серия,
	|	&УсловиеЦена КАК Цена,
	|	СУММА(ВЫБОР
	|			КОГДА ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0) = 0
	|				ТОГДА ТаблицаТоваровВДокументе.КоличествоУпаковок
	|			ИНАЧЕ ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0)
	|		КОНЕЦ) КАК Количество,
	|	МИНИМУМ(ТаблицаТоваровВДокументе.НомерСтроки) КАК НомерСтроки
	|ПОМЕСТИТЬ ТаблицаТоваровВДокументе1С
	|ИЗ
	|	Документ.ПриходныйОрдерНаТовары.Товары КАК ТаблицаТоваровВДокументе
	|ГДЕ
	|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваровВДокументе.Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика,
	|	&УсловиеСерия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК Характеристика,
	|	СУММА(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество) КАК Количество
	|ПОМЕСТИТЬ РезервыТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка <> &Ссылка
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.Шаблон.РезервироватьТовар
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СвободныеОстатки.Номенклатура КАК Номенклатура,
	|	СвободныеОстатки.Характеристика КАК Характеристика,
	|	СвободныеОстатки.Серия КАК Серия,
	|	СУММА(ЕСТЬNULL(СвободныеОстатки.ВНаличииОстаток, 0)) КАК ВНаличииОстатокСерии
	|ПОМЕСТИТЬ ТоварыНаСкладахОстаткиСерии
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			,
	|			Номенклатура В
	|					(ВЫБРАТЬ
	|						ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура
	|					ИЗ
	|						ТаблицаТоваровВДокументе1С КАК ТаблицаТоваровВДокументе)
	|				И (&ВсеСклады
	|					ИЛИ Склад В (&Склады))
	|				И (&ВсеПомещения
	|					ИЛИ Помещение В (&Помещения))) КАК СвободныеОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	СвободныеОстатки.Номенклатура,
	|	СвободныеОстатки.Характеристика,
	|	СвободныеОстатки.Серия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
	|	ТоварыНаСкладахОстатки.Характеристика КАК Характеристика,
	|	СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстатокСерии, 0)) КАК ВНаличииОстаток
	|ПОМЕСТИТЬ ТоварыНаСкладахОстатки
	|ИЗ
	|	ТоварыНаСкладахОстаткиСерии КАК ТоварыНаСкладахОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	ТоварыНаСкладахОстатки.Номенклатура,
	|	ТоварыНаСкладахОстатки.Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗаказыНаПеремещениеОстатки.Номенклатура КАК Номенклатура,
	|	ЗаказыНаПеремещениеОстатки.Характеристика КАК Характеристика,
	|	ЗаказыНаПеремещениеОстатки.Серия КАК Серия,
	|	ЗаказыНаПеремещениеОстатки.ЗаказаноОстаток КАК ОстатокНаПеремещение
	|ПОМЕСТИТЬ ОстаткиЗаказовНаПеремещение
	|ИЗ
	|	РегистрНакопления.ЗаказыНаПеремещение.Остатки(&ДатаКонтроля, ЗаказНаПеремещение = &ИсходныйДокумент) КАК ЗаказыНаПеремещениеОстатки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаТоваровВДокументе1С.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваровВДокументе1С.Характеристика КАК Характеристика,
	|	ТаблицаТоваровВДокументе1С.Цена КАК Цена,
	|	СУММА(ЕСТЬNULL(ОстаткиЗаказовНаПеремещение.ОстатокНаПеремещение,0)) КАК Количество,
	|	ТаблицаТоваровВДокументе1С.НомерСтроки КАК НомерСтроки,
	|	ТаблицаТоваровВДокументе1С.Серия КАК Серия,
	|	СУММА(ТоварыНаСкладахОстаткиСерии.ВНаличииОстатокСерии) КАК ОстатокПоСерии,
	|	СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0) - ЕСТЬNULL(РезервыТСД.Количество, 0)) КАК Лимит
	|ИЗ
	|	ТаблицаТоваровВДокументе1С КАК ТаблицаТоваровВДокументе1С
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервыТСД КАК РезервыТСД
	|		ПО ТаблицаТоваровВДокументе1С.Номенклатура = РезервыТСД.Номенклатура
	|			И ТаблицаТоваровВДокументе1С.Характеристика = РезервыТСД.Характеристика
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыНаСкладахОстаткиСерии КАК ТоварыНаСкладахОстаткиСерии
	|		ПО ТаблицаТоваровВДокументе1С.Номенклатура = ТоварыНаСкладахОстаткиСерии.Номенклатура
	|			И ТаблицаТоваровВДокументе1С.Характеристика = ТоварыНаСкладахОстаткиСерии.Характеристика
	|			И ТаблицаТоваровВДокументе1С.Серия = ТоварыНаСкладахОстаткиСерии.Серия
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыНаСкладахОстатки КАК ТоварыНаСкладахОстатки
	|		ПО ТаблицаТоваровВДокументе1С.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
	|			И ТаблицаТоваровВДокументе1С.Характеристика = ТоварыНаСкладахОстатки.Характеристика
	|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиЗаказовНаПеремещение КАК ОстаткиЗаказовНаПеремещение
	|			ПО ТаблицаТоваровВДокументе1С.Номенклатура = ОстаткиЗаказовНаПеремещение.Номенклатура
	|			И ТаблицаТоваровВДокументе1С.Характеристика = ОстаткиЗаказовНаПеремещение.Характеристика
	|			И ТаблицаТоваровВДокументе1С.Серия = ОстаткиЗаказовНаПеремещение.Серия
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваровВДокументе1С.Номенклатура,
	|	ТаблицаТоваровВДокументе1С.Характеристика,
	|	ТаблицаТоваровВДокументе1С.Цена,
	|	ТаблицаТоваровВДокументе1С.Количество,
	|	ТаблицаТоваровВДокументе1С.НомерСтроки,
	|	ТаблицаТоваровВДокументе1С.Серия
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
			
	Запрос.УстановитьПараметр("ДатаКонтроля", СсылкаНаДок.ДатаСоздания);
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок);
	Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ПриходныйОрдерНаТовары.", "." + Шаблон.ВидДокумента + ".");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
	
	//Если у документа есть склад берем остатки по складу документа иначе склады из настроек ТСД
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	Запрос.УстановитьПараметр("Документы", СсылкаНаДок.Задания.ВыгрузитьКолонку("Задание"));
	
	МетаданныеДокумента = Метаданные.Документы[Шаблон.ВидДокумента];
	
	Попытка
		ЕстьЦены = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Цена") <> Неопределено;
	Исключение
		ЕстьЦены = Ложь;
	КонецПопытки;	
	
	Если ЕстьЦены Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "ТаблицаТоваровВДокументе.Цена");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "0");
	КонецЕсли;	
	
	Попытка
		ЕстьСерии = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Серия") <> Неопределено;
	Исключение
		ЕстьСерии = Ложь;
	КонецПопытки;
	
	Если ЕстьСерии Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "ТаблицаТоваровВДокументе.Серия");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "Значение(Справочник.СерииНоменклатуры.ПустаяСсылка)");
	КонецЕсли;
		
	Попытка
		ЕстьКоличествоУпаковок = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("КоличествоУпаковок") <> Неопределено;
	Исключение
		ЕстьКоличествоУпаковок = Ложь;
	КонецПопытки;
	
	Если ЕстьКоличествоУпаковок Тогда
		Если УзелПО.НеИспользоватьПересчетУпаковок Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество,", "ТаблицаТоваровВДокументе.КоличествоУпаковок,");
		КонецЕсли;			
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.КоличествоУпаковок", "ТаблицаТоваровВДокументе.Количество");
	КонецЕсли;	
	
	Если Шаблон.ВидДокумента = "ЗаказПоставщику" Тогда
		Попытка
			ЕстьОтменено = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Отменено") <> Неопределено;
		Исключение
			ЕстьОтменено = Ложь;
		КонецПопытки;
		
		Если ЕстьОтменено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент И НЕ ТаблицаТоваровВДокументе.Отменено");
		КонецЕсли;	
	ИначеЕсли Шаблон.ВидДокумента = "ЗаказКлиента" Тогда
		Попытка
			ЕстьОтменено = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Отменено") <> Неопределено И МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("ВариантОбеспечения") <> Неопределено;
		Исключение
			ЕстьОтменено = Ложь;
		КонецПопытки;
		
		Если ЕстьОтменено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент И НЕ ТаблицаТоваровВДокументе.Отменено");
		КонецЕсли;		
	КонецЕсли;
	
	Если Шаблон.ВидДокумента = "ПересчетТоваров" И УзелПО.НеОтображатьОстатки Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.КоличествоУпаковок", "0");
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", "0");
	КонецЕсли;	
	
	Если Шаблон.РаспределениеТоваров = 1 Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка В(&Документы)");
	КонецЕсли;		
	
	Если Шаблон.ИспользоватьМаркировку И Шаблон.МаркировкаЗапретитьПодборНемаркируемыхТоваров Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент 
		|   	И
		|   	(
		|   	(ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПустаяСсылка) 
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.АлкогольнаяПродукция)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.СодержитДрагоценныеМатериалы)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.КиЗГИСМ)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПодконтрольнаяПродукцияВЕТИС)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПродавцом)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПоАгентскойСхеме)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.Партнером)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.БезОсобенностейУчета))
		|   	ИЛИ
		|   	(ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПустаяСсылка) 
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.АлкогольнаяПродукция)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.СодержитДрагоценныеМатериалы)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.КиЗГИСМ)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ПодконтрольнаяПродукцияВЕТИС)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПродавцом)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПоАгентскойСхеме)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.Партнером)
		|   	И ТаблицаТоваровВДокументе.Номенклатура.ВидНоменклатуры.ОсобенностьУчета <> ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.БезОсобенностейУчета))
		|   	)");		
	КонецЕсли;	
	
	ПроверкаОСГ = Шаблон.ПроверкаОСГ;
	РежимКомплектации = Шаблон.РежимКомплектации; 
	
	Рез = Запрос.Выполнить().Выгрузить();
	
	Для каждого СтрокаДока Из Рез Цикл
		
		Если Не ЗначениеЗаполнено(СтрокаДока.Номенклатура) Тогда
			Продолжить;
		КонецЕсли;
		
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
		Если ЗначениеЗаполнено(СтрокаДока.Характеристика) Тогда
			ОбъектТовара.id  = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
			Попытка ОбъектТовара.parent_id = ?(XMLСтрока(СтрокаДока.Характеристика) = "00000000-0000-0000-0000-000000000000", "", "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
		Иначе
			ОбъектТовара.id  = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000";
		КонецЕсли;
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);	
		
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда
				sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускВесовогоТовара = Неопределено;
		КонецПопытки;
		
		Если ДопускВесовогоТовара <> Неопределено Тогда
			СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
		КонецЕсли;		
		
		Попытка
			ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускОСГ = Неопределено;
		КонецПопытки;
		
		Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
			СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
		КонецЕсли;
		
		ЭтоУслуга = Ложь;
		Попытка 
			Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
				ЭтоУслуга = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		ЭтоНабор = Ложь;
		Попытка 
			Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Набор Тогда
				ЭтоНабор = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Если ЭтоНабор И РежимКомплектации = 1 Тогда
			СтруктураТекущейСтроки.Вставить("is_kit", Истина);
		Иначе
			СтруктураТекущейСтроки.Вставить("is_kit", Ложь);	
		КонецЕсли;
		
		price = СтрокаДока.Цена;
		СтруктураТекущейСтроки.Вставить("price", price);
		
		limit_qty = 0;	
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		ИначеЕсли ЭтоУслуга Тогда
			limit_qty = 999;	
		Иначе	
			Попытка
				Итог = СтрокаДока.Лимит;
				Если Шаблон.ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
					Итог = Итог + СтрокаДока.Количество;		 
				КонецЕсли;		 
				limit_qty = Итог;
			Исключение
				limit_qty = 0;
			КонецПопытки;
		КонецЕсли;		
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		
		qty = СтрокаДока.Количество;
		СтруктураТекущейСтроки.Вставить("qty", qty);
		СтруктураТекущейСтроки.Вставить("unit_qty", qty);
		
		// атрибуты строки
		СтруктураПоиска = Новый Структура("НомерСтроки");
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаДока);
		СписокАтрибутов = ПолучитьАтрибутыСтрокиДокумента(СсылкаНаДок, СтрокаДока,, СтруктураПоиска);
		СтруктураТекущейСтроки.Вставить("attributes", СписокАтрибутов);
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);			
	КонецЦикла;
	
КонецПроцедуры

Процедура GetDocRowsSborka_Select(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика КАК Характеристика,
	|	&УсловиеСерия КАК Серия,
	|	&УсловиеЦена КАК Цена,
	|	СУММА(ВЫБОР
	|			КОГДА ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0) = 0
	|				ТОГДА ТаблицаТоваровВДокументе.КоличествоУпаковок
	|			ИНАЧЕ ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0)
	|		КОНЕЦ) КАК Количество,
	|	МИНИМУМ(ТаблицаТоваровВДокументе.НомерСтроки) КАК НомерСтроки
	|ПОМЕСТИТЬ ЗапросСЛимитами
	|ИЗ
	|	Документ.СборкаТоваров.Товары КАК ТаблицаТоваровВДокументе
	|ГДЕ
	|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваровВДокументе.Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика,
	|	&УсловиеСерия,
	|	&УсловиеЦена
	|
	|ИНДЕКСИРОВАТЬ ПО
	|   Номенклатура,
	|   Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	СУММА(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество) КАК Количество
	|ПОМЕСТИТЬ РезервыТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка <> &Ссылка
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.Шаблон.РезервироватьТовар
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)
	|		
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры
	|
	|ИНДЕКСИРОВАТЬ ПО
	|   Номенклатура,
	|   ХарактеристикаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапросСЛимитами.Номенклатура КАК Номенклатура,
	|	ЗапросСЛимитами.Характеристика КАК Характеристика,
	|	ЗапросСЛимитами.Серия КАК Серия,
	|	ЗапросСЛимитами.Цена КАК Цена,
	|	СУММА(ЗапросСЛимитами.Количество) КАК Количество,
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0) - ЕСТЬNULL(РезервыТСД.Количество, 0)) КАК Лимит,
	|	МИНИМУМ(ЗапросСЛимитами.НомерСтроки) КАК НомерСтроки
	|ПОМЕСТИТЬ ТоварыОстатки
	|ИЗ
	|	ЗапросСЛимитами КАК ЗапросСЛимитами
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	|				,
	|				&ВсеСклады
	|					ИЛИ Склад В (&Склады)
	|					ИЛИ Помещение В (&Склады)) КАК СвободныеОстаткиОстатки
	|		ПО ЗапросСЛимитами.Номенклатура = СвободныеОстаткиОстатки.Номенклатура
	|			И ЗапросСЛимитами.Характеристика = СвободныеОстаткиОстатки.Характеристика
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервыТСД КАК РезервыТСД
	|		ПО ЗапросСЛимитами.Номенклатура = РезервыТСД.Номенклатура
	|			И ЗапросСЛимитами.Характеристика = РезервыТСД.ХарактеристикаНоменклатуры
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапросСЛимитами.Номенклатура,
	|	ЗапросСЛимитами.Характеристика,
	|	ЗапросСЛимитами.Серия,
	|	ЗапросСЛимитами.Цена
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(ЕСТЬNULL(СвободныеОстатки.ВНаличииОстаток, 0)) КАК ВНаличииОстаток,
	|	СвободныеОстатки.Номенклатура КАК Номенклатура,
	|	СвободныеОстатки.Характеристика КАК Характеристика,
	|	СвободныеОстатки.Серия КАК Серия
	|ПОМЕСТИТЬ ТоварыНаСкладахОстатки
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			,
	|			Номенклатура В
	|					(ВЫБРАТЬ
	|						ТоварыОстатки.Номенклатура КАК Номенклатура
	|					ИЗ
	|						ТоварыОстатки КАК ТоварыОстатки)
	|				И (&ВсеСклады
	|					ИЛИ Склад В (&Склады)
	|					ИЛИ Помещение В (&Склады))) КАК СвободныеОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	СвободныеОстатки.Номенклатура,
	|	СвободныеОстатки.Характеристика,
	|	СвободныеОстатки.Серия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыОстатки.Номенклатура КАК Номенклатура,
	|	ТоварыОстатки.Характеристика КАК Характеристика,
	|	ТоварыОстатки.Серия КАК Серия,
	|	ТоварыОстатки.Цена КАК Цена,
	|	ТоварыОстатки.Количество КАК Количество,
	|	ТоварыОстатки.Лимит КАК Лимит,
	|	ТоварыОстатки.НомерСтроки КАК НомерСтроки,
	|	СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0)) КАК ОстатокПоСерии
	|ИЗ
	|	ТоварыОстатки КАК ТоварыОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыНаСкладахОстатки КАК ТоварыНаСкладахОстатки
	|		ПО ТоварыОстатки.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
	|			И ТоварыОстатки.Характеристика = ТоварыНаСкладахОстатки.Характеристика
	|			И ТоварыОстатки.Серия = ТоварыНаСкладахОстатки.Серия
	|
	|СГРУППИРОВАТЬ ПО
	|	ТоварыОстатки.Номенклатура,
	|	ТоварыОстатки.Характеристика,
	|	ТоварыОстатки.Серия,
	|	ТоварыОстатки.Цена,
	|	ТоварыОстатки.Количество,
	|	ТоварыОстатки.Лимит,
	|	ТоварыОстатки.НомерСтроки");
		
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок);
	Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".СборкаТоваров.", "." + Шаблон.ВидДокумента + ".");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТТНВходящаяЕГАИС.", "." + Шаблон.ВидДокумента + ".");
	
	//Если у документа есть склад берем остатки по складу документа иначе склады из настроек ТСД
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	МетаданныеДокумента = Метаданные.Документы[Шаблон.ВидДокумента];
	
	Попытка
		ЕстьЦены = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Цена") <> Неопределено;
	Исключение
		ЕстьЦены = Ложь;
	КонецПопытки;	
	
	Если ЕстьЦены Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "ТаблицаТоваровВДокументе.Цена");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "0");
	КонецЕсли;	
	
	Попытка
		ЕстьСерии = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Серия") <> Неопределено;
	Исключение
		ЕстьСерии = Ложь;
	КонецПопытки;
	
	Если ЕстьСерии Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "ТаблицаТоваровВДокументе.Серия");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "Значение(Справочник.СерииНоменклатуры.ПустаяСсылка)");
	КонецЕсли;	
	
	Попытка
		ЕстьКоличествоУпаковок = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("КоличествоУпаковок") <> Неопределено;
	Исключение
		ЕстьКоличествоУпаковок = Ложь;
	КонецПопытки;
	
	Если ЕстьКоличествоУпаковок Тогда
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.КоличествоУпаковок", "ТаблицаТоваровВДокументе.Количество");
	КонецЕсли;
		
	Если Шаблон.ВидДокумента = "ЗаказПоставщику" Тогда
		Попытка
			ЕстьОтменено = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Отменено") <> Неопределено;
		Исключение
			ЕстьОтменено = Ложь;
		КонецПопытки;
		
		Если ЕстьОтменено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент И НЕ ТаблицаТоваровВДокументе.Отменено");
		КонецЕсли;	
	ИначеЕсли Шаблон.ВидДокумента = "ЗаказКлиента" Тогда
		Попытка
			ЕстьОтменено = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Отменено") <> Неопределено И МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("ВариантОбеспечения") <> Неопределено;
		Исключение
			ЕстьОтменено = Ложь;
		КонецПопытки;
		
		Если ЕстьОтменено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент И НЕ ТаблицаТоваровВДокументе.Отменено И ТаблицаТоваровВДокументе.ВариантОбеспечения<>ЗНАЧЕНИЕ(Перечисление.ВариантыОбеспечения.НеТребуется)");
		КонецЕсли;		
	КонецЕсли;
	
	ПроверкаОСГ = Шаблон.ПроверкаОСГ; 
	
	СкорректироватьЗапросЕслиЕстьРегистрНакопленияСвободныеОстатки(Запрос.Текст, "GetDocRowsSborka_Select", УзелПО.УчитыватьОстаткиПоРегиструСвободныеОстатки);
		
	Рез = Запрос.Выполнить().Выгрузить();
	Для каждого СтрокаДока Из Рез Цикл
		
		Если Не ЗначениеЗаполнено(СтрокаДока.Номенклатура) Тогда
			Продолжить;
		КонецЕсли;
		
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
		Если ЗначениеЗаполнено(СтрокаДока.Характеристика) Тогда
			ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
			Попытка ОбъектТовара.parent_id = ?(XMLСтрока(СтрокаДока.Характеристика) = "00000000-0000-0000-0000-000000000000", "", "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
		Иначе
			ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000";
		КонецЕсли;
		
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда
				sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;
		Исключение
		КонецПопытки;	
		
		Попытка
			ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускВесовогоТовара = Неопределено;
		КонецПопытки;
		
		Если ДопускВесовогоТовара <> Неопределено Тогда
			СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
		КонецЕсли;
		
		Попытка
			ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускОСГ = Неопределено;
		КонецПопытки;
		
		Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
			СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
		КонецЕсли;
			
		price = СтрокаДока.Цена;
		СтруктураТекущейСтроки.Вставить("price", price);
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		Иначе	
			Попытка
				Итог = СтрокаДока.Лимит;
				Если Шаблон.ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
					Итог = Итог + СтрокаДока.Количество;		 
				КонецЕсли;	
				limit_qty = Итог;
			Исключение
				limit_qty = 0;
			КонецПопытки;
		КонецЕсли;
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		
		qty = СтрокаДока.Количество;
		СтруктураТекущейСтроки.Вставить("qty", qty);
		СтруктураТекущейСтроки.Вставить("unit_qty", qty);
		
		// атрибуты строки
		СтруктураПоиска = Новый Структура("НомерСтроки");
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаДока);
		СписокАтрибутов = ПолучитьАтрибутыСтрокиДокумента(СсылкаНаДок, СтрокаДока,, СтруктураПоиска);
		СтруктураТекущейСтроки.Вставить("attributes", СписокАтрибутов);
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);			
	КонецЦикла;
	
КонецПроцедуры

Процедура GetDocRowsSborka_Insert(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика КАК Характеристика,
	|	&УсловиеСерия КАК Серия,
	|	&УсловиеЦена КАК Цена,
	|	СУММА(ВЫБОР
	|			КОГДА ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0) = 0
	|				ТОГДА ТаблицаТоваровВДокументе.КоличествоУпаковок
	|			ИНАЧЕ ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0)
	|		КОНЕЦ) КАК Количество,
	|	1 КАК НомерСтроки
	|ПОМЕСТИТЬ ЗапросСЛимитами
	|ИЗ
	|	Документ.СборкаТоваров КАК ТаблицаТоваровВДокументе
	|ГДЕ
	|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваровВДокументе.Номенклатура,
	|	ТаблицаТоваровВДокументе.Характеристика,
	|	&УсловиеСерия
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	СУММА(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество) КАК Количество,
	|	1 КАК Поле1
	|ПОМЕСТИТЬ РезервыТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка <> &Ссылка
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.Шаблон.РезервироватьТовар
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)
	|	
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	ХарактеристикаНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапросСЛимитами.Номенклатура КАК Номенклатура,
	|	ЗапросСЛимитами.Характеристика КАК Характеристика,
	|	ЗапросСЛимитами.Серия КАК Серия,
	|	ЗапросСЛимитами.Цена КАК Цена,
	|	СУММА(ЗапросСЛимитами.Количество) КАК Количество,
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0) - ЕСТЬNULL(РезервыТСД.Количество, 0)) КАК Лимит,
	|	МИНИМУМ(ЗапросСЛимитами.НомерСтроки) КАК НомерСтроки
	|ПОМЕСТИТЬ ТоварыОстатки
	|ИЗ
	|	ЗапросСЛимитами КАК ЗапросСЛимитами
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	|				,
	|				&ВсеСклады
	|					ИЛИ Склад В (&Склады)
	|					ИЛИ Помещение В (&Склады)) КАК СвободныеОстаткиОстатки
	|		ПО ЗапросСЛимитами.Номенклатура = СвободныеОстаткиОстатки.Номенклатура
	|			И ЗапросСЛимитами.Характеристика = СвободныеОстаткиОстатки.Характеристика
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервыТСД КАК РезервыТСД
	|		ПО ЗапросСЛимитами.Номенклатура = РезервыТСД.Номенклатура
	|			И ЗапросСЛимитами.Характеристика = РезервыТСД.ХарактеристикаНоменклатуры
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапросСЛимитами.Номенклатура,
	|	ЗапросСЛимитами.Характеристика,
	|	ЗапросСЛимитами.Серия,
	|	ЗапросСЛимитами.Цена
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	Серия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(ЕСТЬNULL(СвободныеОстатки.ВНаличииОстаток, 0)) КАК ВНаличииОстаток,
	|	СвободныеОстатки.Номенклатура КАК Номенклатура,
	|	СвободныеОстатки.Характеристика КАК Характеристика,
	|	СвободныеОстатки.Серия КАК Серия
	|ПОМЕСТИТЬ ТоварыНаСкладахОстатки
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			,
	|			Номенклатура В
	|					(ВЫБРАТЬ
	|						ТоварыОстатки.Номенклатура КАК Номенклатура
	|					ИЗ
	|						ТоварыОстатки КАК ТоварыОстатки)
	|				И (&ВсеСклады
	|					ИЛИ Склад В (&Склады)
	|					ИЛИ Помещение В (&Склады))) КАК СвободныеОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	СвободныеОстатки.Номенклатура,
	|	СвободныеОстатки.Характеристика,
	|	СвободныеОстатки.Серия
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	Серия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыОстатки.Номенклатура КАК Номенклатура,
	|	ТоварыОстатки.Характеристика КАК Характеристика,
	|	ТоварыОстатки.Серия КАК Серия,
	|	ТоварыОстатки.Цена КАК Цена,
	|	ТоварыОстатки.Количество КАК Количество,
	|	ТоварыОстатки.Лимит КАК Лимит,
	|	ТоварыОстатки.НомерСтроки КАК НомерСтроки,
	|	СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0)) КАК ОстатокПоСерии
	|ИЗ
	|	ТоварыОстатки КАК ТоварыОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыНаСкладахОстатки КАК ТоварыНаСкладахОстатки
	|		ПО ТоварыОстатки.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
	|			И ТоварыОстатки.Характеристика = ТоварыНаСкладахОстатки.Характеристика
	|			И ТоварыОстатки.Серия = ТоварыНаСкладахОстатки.Серия
	|
	|СГРУППИРОВАТЬ ПО
	|	ТоварыОстатки.Номенклатура,
	|	ТоварыОстатки.Характеристика,
	|	ТоварыОстатки.Серия,
	|	ТоварыОстатки.Цена,
	|	ТоварыОстатки.Количество,
	|	ТоварыОстатки.Лимит,
	|	ТоварыОстатки.НомерСтроки");
		
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок);
	Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "СборкаТоваров", Шаблон.ВидДокумента);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТТНВходящаяЕГАИС.", "." + Шаблон.ВидДокумента + ".");
	
	//Если у документа есть склад берем остатки по складу документа иначе склады из настроек ТСД
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	МетаданныеДокумента = Метаданные.Документы[Шаблон.ВидДокумента];
	
	Попытка
		ЕстьЦены = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Цена") <> Неопределено;
	Исключение
		ЕстьЦены = Ложь;
	КонецПопытки;
		
	Если ЕстьЦены Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "ТаблицаТоваровВДокументе.Цена");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "0");
	КонецЕсли;
		
	Попытка
		ЕстьСерии = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Серия") <> Неопределено;
	Исключение
		ЕстьСерии = Ложь;
	КонецПопытки;
	
	Если ЕстьСерии Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "ТаблицаТоваровВДокументе.Серия");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеСерия", "Значение(Справочник.СерииНоменклатуры.ПустаяСсылка)");
	КонецЕсли;
		
	Попытка
		ЕстьКоличествоУпаковок = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("КоличествоУпаковок") <> Неопределено;
	Исключение
		ЕстьКоличествоУпаковок = Ложь;
	КонецПопытки;
	
	Если ЕстьКоличествоУпаковок Тогда
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.КоличествоУпаковок", "ТаблицаТоваровВДокументе.Количество");
	КонецЕсли;
		
	Если Шаблон.ВидДокумента = "ЗаказПоставщику" Тогда
		Попытка
			ЕстьОтменено = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Отменено") <> Неопределено;
		Исключение
			ЕстьОтменено = Ложь;
		КонецПопытки;
		
		Если ЕстьОтменено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент И НЕ ТаблицаТоваровВДокументе.Отменено");
		КонецЕсли;	
	ИначеЕсли Шаблон.ВидДокумента = "ЗаказКлиента" Тогда
		Попытка
			ЕстьОтменено = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Отменено") <> Неопределено И МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("ВариантОбеспечения") <> Неопределено;
		Исключение
			ЕстьОтменено = Ложь;
		КонецПопытки;
		
		Если ЕстьОтменено Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент И НЕ ТаблицаТоваровВДокументе.Отменено И ТаблицаТоваровВДокументе.ВариантОбеспечения<>ЗНАЧЕНИЕ(Перечисление.ВариантыОбеспечения.НеТребуется)");
		КонецЕсли;		
	КонецЕсли;
	
	СкорректироватьЗапросЕслиЕстьРегистрНакопленияСвободныеОстатки(Запрос.Текст, "GetDocRowsSborka_Insert", УзелПО.УчитыватьОстаткиПоРегиструСвободныеОстатки);
		
	Рез = Запрос.Выполнить().Выгрузить();
	Для каждого СтрокаДока Из Рез Цикл
		
		Если Не ЗначениеЗаполнено(СтрокаДока.Номенклатура) Тогда
			Продолжить;
		КонецЕсли;
		
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");	
		Если ЗначениеЗаполнено(СтрокаДока.Характеристика) Тогда
			ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + СокрЛП(СтрокаДока.Характеристика);
			Попытка ОбъектТовара.parent_id = ?(XMLСтрока(СтрокаДока.Характеристика) = "00000000-0000-0000-0000-000000000000", "", "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
		Иначе
			ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + "00000000-0000-0000-0000-000000000000";
		КонецЕсли;
		
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда
				sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия, Истина);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускВесовогоТовара = Неопределено;
		КонецПопытки;
		
		Если ДопускВесовогоТовара <> Неопределено Тогда
			СтруктураТекущейСтроки.Вставить("weight_task", ДопускВесовогоТовара);
		КонецЕсли;		
		
		Попытка
			ДопускОСГ = ПолучитьДопускОСГ(СтрокаДока.Номенклатура, СсылкаНаДок.Клиент);
		Исключение
			ДопускОСГ = Неопределено;
		КонецПопытки;
		
		Если ДопускОСГ <> Неопределено И Шаблон.ПроверкаОСГ Тогда
			СтруктураТекущейСтроки.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
		КонецЕсли;
		
		price = СтрокаДока.Цена;
		СтруктураТекущейСтроки.Вставить("price", price);
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		Иначе		
			Попытка
				Итог = СтрокаДока.Лимит;
				Если Шаблон.ДобавлятьКоличествоПоЗаданиюКОстатку Тогда
					Итог = Итог + СтрокаДока.Количество;		 
				КонецЕсли;
				limit_qty = Итог;
			Исключение
				limit_qty = 0;
			КонецПопытки;
		КонецЕсли;
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		
		qty = СтрокаДока.Количество;
		СтруктураТекущейСтроки.Вставить("qty", qty);
		СтруктураТекущейСтроки.Вставить("unit_qty", qty);
		
		// атрибуты строки
		СтруктураПоиска = Новый Структура("НомерСтроки");
		ЗаполнитьЗначенияСвойств(СтруктураПоиска, СтрокаДока);		
		СписокАтрибутов = ПолучитьАтрибутыСтрокиДокумента(СсылкаНаДок, СтрокаДока, Ложь, СтруктураПоиска);
		СтруктураТекущейСтроки.Вставить("attributes", СписокАтрибутов);
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);
	КонецЦикла;
	
КонецПроцедуры

//Получение данных строк документа (подбор) с товарами ЕГАИС.
//
// Параметры:
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон документа ТСД.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// ОбъектСписка - Массив - Массив данных.
//  
Процедура GetDocRowsSelectEGAIS(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок)
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ТаблицаТоваровВДокументе.АлкогольнаяПродукция КАК Номенклатура,
	|	&УсловиеЦена КАК Цена,
	|	СУММА(ТаблицаТоваровВДокументе.Количество) КАК Количество,
	|	МИНИМУМ(ТаблицаТоваровВДокументе.НомерСтроки) КАК НомерСтроки,
	|	ТаблицаТоваровВДокументе.Справка2 КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ЗапросСЛимитами
	|ИЗ
	|	Документ.ТТНВходящаяЕГАИС.Товары КАК ТаблицаТоваровВДокументе
	|ГДЕ
	|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент
	|	
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваровВДокументе.АлкогольнаяПродукция,
	|	ТаблицаТоваровВДокументе.Справка2,
	|	&УсловиеЦена
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	СУММА(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество) КАК Количество
	|ПОМЕСТИТЬ РезервыТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка <> &Ссылка
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.Шаблон.РезервироватьТовар
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)					
	|		
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СоответствиеНоменклатурыЕГАИС.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
	|	МАКСИМУМ(СоответствиеНоменклатурыЕГАИС.Номенклатура) КАК Номенклатура
	|ПОМЕСТИТЬ втТовары
	|ИЗ
	|	РегистрСведений.СоответствиеНоменклатурыЕГАИС КАК СоответствиеНоменклатурыЕГАИС
	|		
	|СГРУППИРОВАТЬ ПО
	|	СоответствиеНоменклатурыЕГАИС.АлкогольнаяПродукция
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АлкогольнаяПродукция,
	|	Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапросСЛимитами.Номенклатура,
	|	ЛОЖЬ КАК ЭтоХарактеристика,
	|	ЗапросСЛимитами.Цена,
	|	СУММА(ЗапросСЛимитами.Количество) КАК Количество,
	|   СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0) - ЕСТЬNULL(РезервыТСД.Количество, 0)) КАК Лимит, 
	|	ЗапросСЛимитами.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ЗапросСЛимитами.НомерСтроки КАК НомерСтроки
	|ИЗ
	|	ЗапросСЛимитами КАК ЗапросСЛимитами
	|		ЛЕВОЕ СОЕДИНЕНИЕ втТовары КАК Товары
	|		ПО (Товары.АлкогольнаяПродукция = ЗапросСЛимитами.Номенклатура)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	|				,
	|				(&ВсеСклады
	|					ИЛИ Склад В (&Склады))
	|				И (&ВсеПомещения
	|					ИЛИ Помещение В (&Помещения))) КАК ТоварыНаСкладахОстатки
	|		ПО ЗапросСЛимитами.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервыТСД КАК РезервыТСД
	|		ПО (Товары.Номенклатура = РезервыТСД.Номенклатура)
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапросСЛимитами.Номенклатура,
	|	ЗапросСЛимитами.Цена,
	|	ЗапросСЛимитами.НомерСтроки,
	|	ЗапросСЛимитами.ИдентификаторСтроки
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки");
		
	Если ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда
		
		ДатаМобайл_ОбщийМодуль.астЗаменитьРегистрНоменклатурыЕГАИС(Запрос.Текст);
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТТНВходящаяЕГАИС", Шаблон.ВидДокумента);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.АлкогольнаяПродукция", "ТаблицаТоваровВДокументе.НоменклатураЕГАИС");
		
		Если Шаблон.ВидДокумента = "астСписаниеТоваровЕГАИС" Или Шаблон.ВидДокумента = "астАктФиксацииШтрихкодовНаБалансеОрганизации" Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Справка2", "ТаблицаТоваровВДокументе.СправкаБ");	
		Иначе
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Справка2", "ТаблицаТоваровВДокументе.ИдСправкиБ");
		КонецЕсли;
		
		Если Шаблон.ВидДокумента = "астАктФиксацииШтрихкодовНаБалансеОрганизации" Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", "ТаблицаТоваровВДокументе.КоличествоМарок");				
		КонецЕсли;
	КонецЕсли;
	
	МетаданныеДокумента = Метаданные.Документы[Шаблон.ВидДокумента];
	
	Попытка
		ЕстьЦены = МетаданныеДокумента.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Цена") <> Неопределено;
	Исключение
		ЕстьЦены = Ложь;
	КонецПопытки;	
	
	Если ЕстьЦены Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "ТаблицаТоваровВДокументе.Цена");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&УсловиеЦена", "0");
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок);
	Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ПриходныйОрдерНаТовары.", "." + Шаблон.ВидДокумента + ".");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТТНВходящаяЕГАИС.", "." + Шаблон.ВидДокумента + ".");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
		
	//Если у документа есть склад берем остатки по складу документа иначе склады из настроек ТСД
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
		
	Если Шаблон.ВидДокумента = "УстановкаЦенНоменклатуры" Или Шаблон.ВидДокумента = "ПрименениеЦенНоменклатуры" Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", 999);
	КонецЕсли;	
	
	Если Шаблон.ВидДокумента = "ДатаМобайл_УпаковочныйЛист" Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.АлкогольнаяПродукция", "ТаблицаТоваровВДокументе.ЕГАИС_Номенклатура");
	КонецЕсли;
	
	МетаданныеИсходныйДокумент = СсылкаНаДок.ИсходныйДокумент.Метаданные();
	
	Попытка
		ЕстьТЧМарок = МетаданныеИсходныйДокумент.ТабличныеЧасти.Найти("АкцизныеМарки") <> Неопределено;
		ЕстьРеквизитИдентификаторСтроки = МетаданныеИсходныйДокумент.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("Справка2") <> Неопределено;
	Исключение
		ЕстьТЧМарок = Ложь;
		ЕстьРеквизитИдентификаторСтроки = Ложь;
	КонецПопытки;
	
	Если ЕстьРеквизитИдентификаторСтроки Тогда
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Справка2", "0");
	КонецЕсли;
		
	Рез = Запрос.Выполнить().Выгрузить();
	Для каждого СтрокаДока Из Рез Цикл
		
		ТекущийИдентификаторСтроки = СтрокаДока.ИдентификаторСтроки;
				
		СтруктураТекущейСтроки = Новый Структура;		
		ОбъектТовара = Неопределено;
		ОбъектТовараЕГАИС = Неопределено;
		
		СписокМарок = ДатаМобайл_ОбщийМодуль.СформироватьСписокНепроверяемыхМарокЕГАИС();  
		Если СписокМарок.НайтиПоЗначению(СтрокаДока.Номенклатура.ВидПродукции) <> Неопределено Тогда
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
			лТекущаяНоменклатура = ДатаМобайл_ОбщийМодуль.ПолучитьНоменклатуруПоЕГАИС(СтрокаДока.Номенклатура);
			ОбъектТовара.id = "8U-" + XMLСтрока(лТекущаяНоменклатура) + XMLСтрока(Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка()); 
			СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		Иначе	
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
			ОбъектТовара.id = "8e-" + XMLСтрока(СтрокаДока.Номенклатура);
			СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
			
			ОбъектТовараЕГАИС = ПолучитьСтруктуруОбъектаДляHttp("egais_art","id");
			ОбъектТовараЕГАИС.id = "8e-" + XMLСтрока(СтрокаДока.Номенклатура);
			СтруктураТекущейСтроки.Вставить("egais_art", ОбъектТовараЕГАИС);		
		КонецЕсли;		
		
		limit_qty = 0;		
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		Иначе		
			Попытка
				Итог = СтрокаДока.Лимит;
				limit_qty = Итог;
			Исключение
				limit_qty = 0;
			КонецПопытки;
		КонецЕсли;	
				
		price = СтрокаДока.Цена;
						
		//Марки формат 3.0
		Если Шаблон.ВидДокумента = "ТТНВходящаяЕГАИС" Или Шаблон.ВидДокумента = "астТоварноТранспортныеНакладныеИзЕГАИС" Тогда
			КоличествоБезМарок = СтрокаДока.Количество;
			
			ТЗМарок = ДатаМобайл_ОбщийМодуль.ПолучитьМаркиВходящейТТН_ЕГАИС(СсылкаНаДок.ИсходныйДокумент);
			СтруктураПоискаМарок = Новый Структура("АлкогольнаяПродукция,Справка2",СтрокаДока.Номенклатура,ТекущийИдентификаторСтроки);
			СтрокиПоискаМарок = ТЗМарок.НайтиСтроки(СтруктураПоискаМарок);		
			
			Для каждого СтрокаМарок Из СтрокиПоискаМарок Цикл				
				Если КоличествоБезМарок > 0 Тогда
					
					СтруктураТекущейСтрокиМарки = Новый Структура;
					
					Если ОбъектТовара <> Неопределено Тогда
						СтруктураТекущейСтрокиМарки.Вставить("art", ОбъектТовара);		
					КонецЕсли;
					
					Если ОбъектТовараЕГАИС <> Неопределено Тогда		
						СтруктураТекущейСтрокиМарки.Вставить("egais_art", ОбъектТовараЕГАИС);	
					КонецЕсли;
					
					qty = 1;
					
					СтруктураТекущейСтрокиМарки.Вставить("price", price);
					СтруктураТекущейСтрокиМарки.Вставить("limit_qty", limit_qty);
					СтруктураТекущейСтрокиМарки.Вставить("qty", qty);
					СтруктураТекущейСтрокиМарки.Вставить("unit_qty", qty);
					
					ОбъектЕГАИС = ПолучитьСтруктуруОбъектаДляHttp("egais");
					ОбъектЕГАИС.mark = СтрокаМарок.Марка;	
					
					Если ЗначениеЗаполнено(ОбъектЕГАИС.mark) Тогда				
						СтруктураТекущейСтрокиМарки.Вставить("egais", ОбъектЕГАИС);
					КонецЕсли;
					
					Если ЗначениеЗаполнено(СтрокаМарок.Короб) Тогда
						СтруктураТекущейСтрокиМарки.Вставить("box_pack", СтрокаМарок.Короб);
					КонецЕсли; 
					Если ЗначениеЗаполнено(СтрокаМарок.Палета) Тогда
						СтруктураТекущейСтрокиМарки.Вставить("pack", СтрокаМарок.Палета);
					КонецЕсли; 
					
					ОбъектСписка.Добавить(СтруктураТекущейСтрокиМарки); 
					
					КоличествоБезМарок = КоличествоБезМарок - 1;
				Иначе
					Продолжить;
				КонецЕсли; 
				
			КонецЦикла;
		КонецЕсли;
					
		Если Шаблон.ВидДокумента = "ТТНВходящаяЕГАИС" Или Шаблон.ВидДокумента = "астТоварноТранспортныеНакладныеИзЕГАИС" Тогда
			Если КоличествоБезМарок > 0 Тогда
				qty = КоличествоБезМарок;
				
				СтруктураТекущейСтроки.Вставить("price", price);
				СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
				СтруктураТекущейСтроки.Вставить("qty", qty);
				СтруктураТекущейСтроки.Вставить("unit_qty", qty);
				
				ОбъектСписка.Добавить(СтруктураТекущейСтроки);
			КонецЕсли;	
		Иначе
			qty = СтрокаДока.Количество;
			
			СтруктураТекущейСтроки.Вставить("price", price);
			СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
			СтруктураТекущейСтроки.Вставить("qty", qty);
			СтруктураТекущейСтроки.Вставить("unit_qty", qty);
			
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура СкорректироватьЗапросПолучитьСтрокиДокументаМаркировка(Запрос, ИсходныйДокумент, РеквизитыШаблона)
	
	Если РеквизитыШаблона.ВидДокумента = "ПриобретениеТоваровУслуг" Тогда
		МетаданныеДокумента = Метаданные.Документы[РеквизитыШаблона.ВидДокумента];
		
		ПроверкаСерииВОтдельнойТЧ = Ложь;
		Если РеквизитыШаблона.УчитыватьСерийниковВЗаданииПодбор Тогда		
			Попытка
				Для каждого ТЧ Из МетаданныеДокумента.ТабличныеЧасти Цикл
					Если ТЧ.Имя = "Серии" Тогда
						ПроверкаСерииВОтдельнойТЧ = Истина;
						Прервать;	
					КонецЕсли;
				КонецЦикла;
			Исключение
			КонецПопытки;
		КонецЕсли;
		
		Если ПроверкаСерииВОтдельнойТЧ И РеквизитыШаблона.СерииВОтдельнойТЧ Тогда
			ТекстЗапроса = "ВЫБРАТЬ
			|	ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура,
			|	ТаблицаТоваровВДокументе.Характеристика КАК Характеристика,
			|	ТаблицаТоваровВДокументе.Серия КАК Серия,
			|	ТаблицаТоваровВДокументе.Цена КАК Цена,
			|	СУММА(ВЫБОР
			|			КОГДА ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0) = 0
			|				ТОГДА ТаблицаТоваровВДокументе.КоличествоУпаковок
			|			ИНАЧЕ ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество, 0)
			|		КОНЕЦ) КАК Количество,
			|	МИНИМУМ(ТаблицаТоваровВДокументе.НомерСтроки) КАК НомерСтроки
			|ПОМЕСТИТЬ ЗапросСЛимитами
			|ИЗ
			|	Документ.ПриобретениеТоваровУслуг.Товары КАК ТаблицаТоваровВДокументе
			|ГДЕ
			|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент
			|	
			|СГРУППИРОВАТЬ ПО
			|	ТаблицаТоваровВДокументе.Номенклатура,
			|	ТаблицаТоваровВДокументе.Характеристика,
			|	ТаблицаТоваровВДокументе.Серия,
			|	ТаблицаТоваровВДокументе.Цена
			|
			|ИНДЕКСИРОВАТЬ ПО
			|   Номенклатура,
			|   Характеристика
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	ЗапросСЛимитами.Номенклатура КАК Номенклатура,
			|	ЗапросСЛимитами.Характеристика КАК Характеристика,
			|	ЗапросСЛимитами.Серия КАК Серия,
			|	МАКСИМУМ(ЗапросСЛимитами.Цена) КАК Цена,
			|	СУММА(ЗапросСЛимитами.Количество) КАК Количество,
			|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0)) КАК Лимит,
			|	МИНИМУМ(ЗапросСЛимитами.НомерСтроки) КАК НомерСтроки
			|ПОМЕСТИТЬ Товары
			|ИЗ
			|	ЗапросСЛимитами КАК ЗапросСЛимитами
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
			|				,
			|				(&ВсеСклады
			|					ИЛИ Склад В (&Склады))
			|					И (&ВсеПомещения
			|						ИЛИ Помещение В (&Помещения))) КАК СвободныеОстаткиОстатки
			|		ПО ЗапросСЛимитами.Номенклатура = СвободныеОстаткиОстатки.Номенклатура
			|			И ЗапросСЛимитами.Характеристика = СвободныеОстаткиОстатки.Характеристика
			|
			|СГРУППИРОВАТЬ ПО
			|	ЗапросСЛимитами.Номенклатура,
			|	ЗапросСЛимитами.Характеристика,
			|	ЗапросСЛимитами.Серия
			|
			|ИНДЕКСИРОВАТЬ ПО
			|   Номенклатура,
			|   Характеристика
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ДокСерии.Ссылка КАК Ссылка,
			|	ДокСерии.Номенклатура КАК Номенклатура,
			|	ДокСерии.Характеристика КАК Характеристика,
			|	ДокСерии.Назначение КАК Назначение,
			|	ДокСерии.Склад КАК Склад,
			|	ДокСерии.Серия КАК Серия,
			|	СУММА(ДокСерии.Количество) КАК Количество
			|ПОМЕСТИТЬ ВТ_ТаблицаСерии
			|ИЗ
			|	Документ.ПриобретениеТоваровУслуг.Серии КАК ДокСерии
			|ГДЕ
			|	ДокСерии.Ссылка = &ИсходныйДокумент
			|
			|СГРУППИРОВАТЬ ПО
			|	ДокСерии.Ссылка,
			|	ДокСерии.Номенклатура,
			|	ДокСерии.Характеристика,
			|	ДокСерии.Назначение,
			|	ДокСерии.Склад,
			|	ДокСерии.Серия
			|
			|ИНДЕКСИРОВАТЬ ПО
			|	Номенклатура,
			|	Характеристика,
			|	Назначение
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ТоварыЗадания.Номенклатура КАК Номенклатура,
			|	ТоварыЗадания.Характеристика КАК Характеристика,
			|	ЕСТЬNULL(ВТ_ТаблицаСерии.Серия, ТоварыЗадания.Серия) КАК Серия,
			|	ТоварыЗадания.Цена КАК Цена,
			|	ЕСТЬNULL(ВТ_ТаблицаСерии.Количество, ТоварыЗадания.Количество) КАК Количество,
			|	ТоварыЗадания.Лимит КАК Лимит,
			|	ТоварыЗадания.НомерСтроки КАК НомерСтроки
			|ПОМЕСТИТЬ ТоварыЗадания
			|ИЗ
			|	Товары КАК ТоварыЗадания
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ТаблицаСерии КАК ВТ_ТаблицаСерии
			|		ПО ТоварыЗадания.Номенклатура = ВТ_ТаблицаСерии.Номенклатура
			|			И ТоварыЗадания.Характеристика = ВТ_ТаблицаСерии.Характеристика
			|;
			|";
			Запрос.Текст = ТекстЗапроса;
		КонецЕсли;
	ИначеЕсли РеквизитыШаблона.ВидДокумента = "ЗаказНаЭмиссиюКодовМаркировкиСУЗ" Тогда
		ТекстЗапроса = "ВЫБРАТЬ
		|	ПулКодовМаркировкиСУЗ.ЗаказНаЭмиссию КАК Ссылка,
		|	ПулКодовМаркировкиСУЗ.КодМаркировки КАК КодМаркировки,
		|	ЗНАЧЕНИЕ(Справочник.ШтрихкодыУпаковокТоваров.) КАК ШтрихкодУпаковки,
		|	ВЫБОР
		|		КОГДА ПОДСТРОКА(ПулКодовМаркировкиСУЗ.КодМаркировки, 1, 4) = ""(01)""
		|			ТОГДА ""01"" + ПОДСТРОКА(ПулКодовМаркировкиСУЗ.КодМаркировки, 5, 14) + ""21"" + ПОДСТРОКА(ПулКодовМаркировкиСУЗ.КодМаркировки, 23, 100)
		|		ИНАЧЕ ПулКодовМаркировкиСУЗ.КодМаркировки
		|	КОНЕЦ КАК ЗначениеШтрихкода
		|ПОМЕСТИТЬ ВТ_Пул
		|ИЗ
		|	РегистрСведений.ПулКодовМаркировкиСУЗ КАК ПулКодовМаркировкиСУЗ
		|ГДЕ
		|	ПулКодовМаркировкиСУЗ.ЗаказНаЭмиссию = &ИсходныйДокумент
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|" + Запрос.Текст;
		
		Запрос.Текст = ТекстЗапроса;	
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "Документ.ПриобретениеТоваровУслуг.ШтрихкодыУпаковок", "ВТ_Пул");
	КонецЕсли;
		
КонецПроцедуры

#КонецОбласти

#Область OnPalletScan

Процедура ПолучитьСодержимоеУпаковки_НашУпаковочныйЛист(УзелПО, СсылкаНаДок, ОбъектСписка, Barcode)
	
	Шаблон = СсылкаНаДок.Шаблон;
	ТипЦен = УзелПО.ТипЦен;
	ВключатьАртикул = УзелПО.ДобавлятьАртикулВНаименование;
		
	Запрос = Новый Запрос; 	 
	Запрос.Текст = "ВЫБРАТЬ 
	|     ДатаМобайл_УпаковочныйЛистТовары.Штрихкод, 
	|     ДатаМобайл_УпаковочныйЛистТовары.Номенклатура,
	|	  ДатаМобайл_УпаковочныйЛистТовары.Характеристика,
	|     ДатаМобайл_УпаковочныйЛистТовары.Серия,
	|     СУММА(ДатаМобайл_УпаковочныйЛистТовары.КоличествоУпаковок) КАК Количество,
	|	  ДатаМобайл_УпаковочныйЛистТовары.Упаковка КАК Упаковка,
	|	  ДатаМобайл_УпаковочныйЛистТовары.Серия КАК Серия
	|ПОМЕСТИТЬ ДоступныеТовары
	|ИЗ 
	|     Документ.ДатаМобайл_УпаковочныйЛист.Товары КАК ДатаМобайл_УпаковочныйЛистТовары 
	|ГДЕ 
	|	(ДатаМобайл_УпаковочныйЛистТовары.Ссылка.Номер = &КодУпакЛиста
	|			ИЛИ ДатаМобайл_УпаковочныйЛистТовары.Ссылка.Код = &КодУпакЛиста) И НЕ ДатаМобайл_УпаковочныйЛистТовары.Ссылка.ПометкаУдаления 
	| 
	|СГРУППИРОВАТЬ ПО 
	|     ДатаМобайл_УпаковочныйЛистТовары.Номенклатура,
	|	  ДатаМобайл_УпаковочныйЛистТовары.Характеристика,
	|     ДатаМобайл_УпаковочныйЛистТовары.Штрихкод,
	|	  ДатаМобайл_УпаковочныйЛистТовары.Упаковка,
	|	  ДатаМобайл_УпаковочныйЛистТовары.Серия
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСД.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ДокументыСРезервамиТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД КАК ДатаМобайл_ДокументыТСД
	|ГДЕ	
	|	(ДатаМобайл_ДокументыТСД.Ссылка <> &ИсходноеЗадание)
	|		И (ДатаМобайл_ДокументыТСД.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1))
	|			И (ДатаМобайл_ДокументыТСД.Шаблон.РезервироватьТовар)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество,0)) КАК Количество
	|ПОМЕСТИТЬ ДанныеДокументыСРезервамиТСД
	|ИЗ
	|	ДокументыСРезервамиТСД КАК ДокументыСРезервамиТСД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|		ПО ДокументыСРезервамиТСД.Ссылка = ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество * (ВЫБОР
	|							КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель = 0
	|									ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель ЕСТЬ NULL
	|								ТОГДА 1
	|							ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель
	|						КОНЕЦ / ВЫБОР
	|							КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель = 0
	|									ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель ЕСТЬ NULL
	|								ТОГДА 1
	|							ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель
	|						КОНЕЦ), 0)) КАК ВРезервеТСД
	|ПОМЕСТИТЬ ТоварыСРезервамиТСД
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДанныеДокументыСРезервамиТСД КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|		ПО ДоступныеТовары.Характеристика = ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры
	|			И ДоступныеТовары.Упаковка = ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения
	|				И ДоступныеТовары.Номенклатура = ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура
	|
	|СГРУППИРОВАТЬ ПО
	|	ДоступныеТовары.Упаковка,
	|	ДоступныеТовары.Характеристика,
	|	ДоступныеТовары.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0)) КАК ВНаличии,
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.КОтгрузкеОстаток, 0)) КАК ВРезерве,
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка
	|ПОМЕСТИТЬ ТоварыСОстатками1С
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	|				,
	|				(&ВсеСклады
	|					ИЛИ Склад В (&Склады))
	|				И (&ВсеПомещения
	|					ИЛИ Помещение В (&Помещения))) КАК СвободныеОстаткиОстатки
	|		ПО ДоступныеТовары.Номенклатура = СвободныеОстаткиОстатки.Номенклатура
	|			И ДоступныеТовары.Характеристика = СвободныеОстаткиОстатки.Характеристика
	|
	|СГРУППИРОВАТЬ ПО
	|	ДоступныеТовары.Характеристика,
	|	ДоступныеТовары.Номенклатура,
	|	ДоступныеТовары.Упаковка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) / ВЫБОР
	|				КОГДА ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель, 0) = 0
	|					ТОГДА 1
	|				ИНАЧЕ ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель
	|			КОНЕЦ КАК ЧИСЛО(19, 2))) КАК Цена				   
	|ПОМЕСТИТЬ ТоварыСЦенами
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ТекущаяДата, ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
	|		ПО ДоступныеТовары.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
	|			И ДоступныеТовары.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
	|
	|СГРУППИРОВАТЬ ПО
	|	ДоступныеТовары.Номенклатура,
	|	ДоступныеТовары.Характеристика,
	|	ДоступныеТовары.Упаковка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой, 
	|	ДоступныеТовары.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,  
	|	ДоступныеТовары.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ДоступныеТовары.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
	|	ДоступныеТовары.Номенклатура.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
	|	ДоступныеТовары.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	|	ДоступныеТовары.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
	|	ДоступныеТовары.Характеристика.Наименование КАК НаименованиеХарактеристики, 	
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|    ДоступныеТовары.Серия КАК Серия,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	ДоступныеТовары.Штрихкод КАК Штрихкод,
	|    ДоступныеТовары.Количество КАК Количество,
	|	ТоварыСОстатками1С.ВНаличии КАК ВНаличии,
	|	ТоварыСОстатками1С.ВРезерве КАК ВРезерве,
	|	ТоварыСРезервамиТСД.ВРезервеТСД КАК ВРезервеТСД,
	|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена,
	|	ЕСТЬNULL(ДоступныеТовары.Упаковка.Наименование, ДоступныеТовары.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
	|	ЕСТЬNULL(ДоступныеТовары.Упаковка.Числитель, 1) КАК Коэффициент,
	|	ВЫБОР
	|		КОГДА &ВключатьАртикул
	|				И ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(Справочник.Номенклатура)
	|			ТОГДА ВЫБОР
	|					КОГДА ДоступныеТовары.Номенклатура.Артикул = """"
	|						ТОГДА """"
	|					ИНАЧЕ ДоступныеТовары.Номенклатура.Артикул + "" ""
	|				КОНЕЦ
	|		ИНАЧЕ """"
	|	КОНЕЦ + ДоступныеТовары.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ДоступныеТовары.Характеристика.Наименование, """") КАК НаименованиеТовара,
	|	ЛОЖЬ КАК ЭтоНовыйТовар
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСРезервамиТСД КАК ТоварыСРезервамиТСД
	|		ПО ДоступныеТовары.Характеристика = ТоварыСРезервамиТСД.Характеристика
	|			И ДоступныеТовары.Номенклатура = ТоварыСРезервамиТСД.Номенклатура
	|			И ДоступныеТовары.Упаковка = ТоварыСРезервамиТСД.Упаковка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСОстатками1С КАК ТоварыСОстатками1С
	|		ПО ДоступныеТовары.Номенклатура = ТоварыСОстатками1С.Номенклатура
	|			И ДоступныеТовары.Характеристика = ТоварыСОстатками1С.Характеристика
	|			И ДоступныеТовары.Упаковка = ТоварыСОстатками1С.Упаковка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
	|		ПО ДоступныеТовары.Номенклатура = ТоварыСЦенами.Номенклатура
	|			И ДоступныеТовары.Характеристика = ТоварыСЦенами.Характеристика
	|			И ДоступныеТовары.Упаковка = ТоварыСЦенами.Упаковка
	|";
	
	СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "ПолучитьСодержимоеУпаковки_НашУпаковочныйЛист");
	
	Если Лев(Barcode,3) = "UPL" Тогда 
		КодУпакЛиста = Прав(Barcode, СтрДлина(Barcode) - 3); 
	Иначе     
		КодУпакЛиста = Barcode; 
	КонецЕсли; 
	
	Запрос.УстановитьПараметр("КодУпакЛиста", КодУпакЛиста); 
	Запрос.УстановитьПараметр("ТипЦен", ТипЦен);
	Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
	Запрос.УстановитьПараметр("ИсходноеЗадание", СсылкаНаДок);          	
	Запрос.УстановитьПараметр("ВсеУпаковки", Истина);
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
		
	Запрос.УстановитьПараметр("ВключатьАртикул", ВключатьАртикул);
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());
	
	Тип_Услуга = Перечисления.ТипыНоменклатуры.Услуга;
	
	Рез = Запрос.Выполнить().Выгрузить(); 	
	Для каждого СтрокаДока Из Рез Цикл 
		
		Итог = (СтрокаДока.ВНаличии - СтрокаДока.ВРезерве - СтрокаДока.ВРезервеТСД);	
		СтрокаДока.Коэффициент = ?(СтрокаДока.Коэффициент = 0, 1, СтрокаДока.Коэффициент);
		СтрокаДока.НаименованиеУпаковки = ?(ЗначениеЗаполнено(СтрокаДока.НаименованиеУпаковки), СтрокаДока.НаименованиеУпаковки, "шт.");
			
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan"); 	
		ОбъектТовара.name = ЧистаяСтрока(СокрП(СтрокаДока.НаименованиеТовара));
		ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
		ОбъектТовара.price = СтрокаДока.Цена;
		
		// Выгрузка дополнительных видов цен
		ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Характеристика);
		
		Попытка	                        
			DMUseSN = ПолучитьПризнакУчетаСерий(СтрокаДока.ВидНоменклатуры, СсылкаНаДок.Склад);
		Исключение
			DMUseSN = Ложь;
		КонецПопытки; 
		
		СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, СтрокаДока, DMUseSN, Шаблон); 
		
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.Штрихкод) Тогда					
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","unit_value");
				ОбъектШтрихкода.value = ЧистаяСтрока(СтрокаДока.Штрихкод);
			Иначе
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");	
			КонецЕсли;
			ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура);
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);	
		Исключение
		Конецпопытки;
		
		//Серия 
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда 
				sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Серия);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;	
		Исключение
		КонецПопытки;
		
		ЭтоУслуга = Ложь;
		Попытка     
			Если СтрокаДока.ВидНоменклатурыТипНоменклатуры = Тип_Услуга Тогда
				ЭтоУслуга = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		ИначеЕсли ЭтоУслуга Тогда
			limit_qty = 999;	
		Иначе
			limit_qty = Итог;
		КонецЕсли;
		
		//Количество в базовых
		qty = СтрокаДока.Количество * СтрокаДока.Коэффициент;			
		
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		СтруктураТекущейСтроки.Вставить("qty", qty);
		СтруктураТекущейСтроки.Вставить("unit_qty", СтрокаДока.Количество);
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		
	КонецЦикла;
		
КонецПроцедуры

Процедура ПолучитьСодержимоеУпаковки_ТиповойУпаковочныйЛист(УзелПО, СсылкаНаДок, ОбъектСписка, Barcode)
	
	Шаблон = СсылкаНаДок.Шаблон;
	ТипЦен = УзелПО.ТипЦен;
	ВключатьАртикул = УзелПО.ДобавлятьАртикулВНаименование;
		
	Запрос = Новый Запрос; 	 
	Запрос.Текст = "ВЫБРАТЬ
	// Zolla ++
	|УпакЛист.Ссылка КАК УпакЛистСсылка
	|ПОМЕСТИТЬ втУпакЛисты
	|
	|ИЗ
	|	Документ.УпаковочныйЛист КАК УпакЛист
	|	
	|ГДЕ 
	|	(УпакЛист.Код = &КодУпакЛиста
	|		ИЛИ УпакЛист.КР_Штрихкод = &КодУпакЛиста)
	|		И НЕ УпакЛист.ПометкаУдаления
	|
	// так быстрее
	//|ИНДЕКСИРОВАТЬ ПО 
	//|	УпакЛистСсылка
	|
	|;
	|ВЫБРАТЬ 
	|	"""" КАК Штрихкод, 
	|	УпаковочныйЛистТовары.Номенклатура,
	|	УпаковочныйЛистТовары.Характеристика,
	|	УпаковочныйЛистТовары.Серия,
	|	СУММА(УпаковочныйЛистТовары.КоличествоУпаковок) КАК Количество,
	|	УпаковочныйЛистТовары.Упаковка КАК Упаковка,
	|	УпаковочныйЛистТовары.Серия КАК Серия
	|ПОМЕСТИТЬ ДоступныеТовары
	|ИЗ 
	|	втУпакЛисты КАК УпакЛист 
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.УпаковочныйЛист.Товары КАК УпаковочныйЛистТовары
	|	ПО УпакЛист.УпакЛистСсылка = УпаковочныйЛистТовары.Ссылка
	|	 
	|СГРУППИРОВАТЬ ПО 
	|	УпаковочныйЛистТовары.Номенклатура,
	|	УпаковочныйЛистТовары.Характеристика,
	|	УпаковочныйЛистТовары.Упаковка,
	|	УпаковочныйЛистТовары.Серия
	// Zolla --
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСД.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ДокументыСРезервамиТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД КАК ДатаМобайл_ДокументыТСД
	|ГДЕ	
	|	(ДатаМобайл_ДокументыТСД.Ссылка <> &ИсходноеЗадание)
	|		И (ДатаМобайл_ДокументыТСД.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1))
	|			И (ДатаМобайл_ДокументыТСД.Шаблон.РезервироватьТовар)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество,0)) КАК Количество
	|ПОМЕСТИТЬ ДанныеДокументыСРезервамиТСД
	|ИЗ
	|	ДокументыСРезервамиТСД КАК ДокументыСРезервамиТСД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|		ПО ДокументыСРезервамиТСД.Ссылка = ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество * (ВЫБОР
	|							КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель = 0
	|									ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель ЕСТЬ NULL
	|								ТОГДА 1
	|							ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель
	|						КОНЕЦ / ВЫБОР
	|							КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель = 0
	|									ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель ЕСТЬ NULL
	|								ТОГДА 1
	|							ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель
	|						КОНЕЦ), 0)) КАК ВРезервеТСД
	|ПОМЕСТИТЬ ТоварыСРезервамиТСД
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДанныеДокументыСРезервамиТСД КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|		ПО ДоступныеТовары.Характеристика = ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры
	|			И ДоступныеТовары.Упаковка = ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения
	|				И ДоступныеТовары.Номенклатура = ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура			
	|
	|СГРУППИРОВАТЬ ПО
	|	ДоступныеТовары.Упаковка,
	|	ДоступныеТовары.Характеристика,
	|	ДоступныеТовары.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0)) КАК ВНаличии,
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.КОтгрузкеОстаток, 0)) КАК ВРезерве,
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка
	|ПОМЕСТИТЬ ТоварыСОстатками1С
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	|				,
	|				(&ВсеСклады
	|					ИЛИ Склад В (&Склады))
	|				И (&ВсеПомещения
	|					ИЛИ Помещение В (&Помещения))) КАК СвободныеОстаткиОстатки
	|		ПО ДоступныеТовары.Номенклатура = СвободныеОстаткиОстатки.Номенклатура
	|			И ДоступныеТовары.Характеристика = СвободныеОстаткиОстатки.Характеристика
	|
	|СГРУППИРОВАТЬ ПО
	|	ДоступныеТовары.Характеристика,
	|	ДоступныеТовары.Номенклатура,
	|	ДоступныеТовары.Упаковка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) / ВЫБОР
	|				КОГДА ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель, 0) = 0
	|					ТОГДА 1
	|				ИНАЧЕ ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель
	|			КОНЕЦ КАК ЧИСЛО(19, 2))) КАК Цена				   
	|ПОМЕСТИТЬ ТоварыСЦенами
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ТекущаяДата, ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
	|		ПО ДоступныеТовары.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
	|			И ДоступныеТовары.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
	|
	|СГРУППИРОВАТЬ ПО
	|	ДоступныеТовары.Номенклатура,
	|	ДоступныеТовары.Характеристика,
	|	ДоступныеТовары.Упаковка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДоступныеТовары.Номенклатура КАК Номенклатура,
	|	ДоступныеТовары.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой, 
	|	ДоступныеТовары.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,  
	|	ДоступныеТовары.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ДоступныеТовары.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
	|	ДоступныеТовары.Номенклатура.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
	|	ДоступныеТовары.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	|	ДоступныеТовары.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
	|	ДоступныеТовары.Характеристика.Наименование КАК НаименованиеХарактеристики, 	
	|	ДоступныеТовары.Характеристика КАК Характеристика,
	|   ДоступныеТовары.Серия КАК Серия,
	|	ДоступныеТовары.Упаковка КАК Упаковка,
	|	ДоступныеТовары.Штрихкод КАК Штрихкод,
	|   ДоступныеТовары.Количество КАК Количество,
	|	ТоварыСОстатками1С.ВНаличии КАК ВНаличии,
	|	ТоварыСОстатками1С.ВРезерве КАК ВРезерве,
	|	ТоварыСРезервамиТСД.ВРезервеТСД КАК ВРезервеТСД,
	|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена,
	|	ЕСТЬNULL(ДоступныеТовары.Упаковка.Наименование, ДоступныеТовары.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
	|	ЕСТЬNULL(ДоступныеТовары.Упаковка.Числитель, 1) КАК Коэффициент,
	|	ВЫБОР
	|		КОГДА &ВключатьАртикул
	|				И ТИПЗНАЧЕНИЯ(ДоступныеТовары.Номенклатура) = ТИП(Справочник.Номенклатура)
	|			ТОГДА ВЫБОР
	|					КОГДА ДоступныеТовары.Номенклатура.Артикул = """"
	|						ТОГДА """"
	|					ИНАЧЕ ДоступныеТовары.Номенклатура.Артикул + "" ""
	|				КОНЕЦ
	|		ИНАЧЕ """"
	|	КОНЕЦ + ДоступныеТовары.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ДоступныеТовары.Характеристика.Наименование, """") КАК НаименованиеТовара,
	|	ЛОЖЬ КАК ЭтоНовыйТовар
	|ИЗ
	|	ДоступныеТовары КАК ДоступныеТовары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСРезервамиТСД КАК ТоварыСРезервамиТСД
	|		ПО ДоступныеТовары.Характеристика = ТоварыСРезервамиТСД.Характеристика
	|			И ДоступныеТовары.Номенклатура = ТоварыСРезервамиТСД.Номенклатура
	|			И ДоступныеТовары.Упаковка = ТоварыСРезервамиТСД.Упаковка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСОстатками1С КАК ТоварыСОстатками1С
	|		ПО ДоступныеТовары.Номенклатура = ТоварыСОстатками1С.Номенклатура
	|			И ДоступныеТовары.Характеристика = ТоварыСОстатками1С.Характеристика
	|			И ДоступныеТовары.Упаковка = ТоварыСОстатками1С.Упаковка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
	|		ПО ДоступныеТовары.Номенклатура = ТоварыСЦенами.Номенклатура
	|			И ДоступныеТовары.Характеристика = ТоварыСЦенами.Характеристика
	|			И ДоступныеТовары.Упаковка = ТоварыСЦенами.Упаковка
	|";
	
	СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "ПолучитьСодержимоеУпаковки_ТиповойУпаковочныйЛист");
	
	Если Лев(Barcode,3) = "UPL" Тогда 
		КодУпакЛиста = Прав(Barcode, СтрДлина(Barcode) - 3); 
	Иначе     
		КодУпакЛиста = Barcode; 
	КонецЕсли; 
	
	Запрос.УстановитьПараметр("КодУпакЛиста", КодУпакЛиста); 
	Запрос.УстановитьПараметр("ТипЦен", ТипЦен);
	Запрос.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
	Запрос.УстановитьПараметр("ИсходноеЗадание", СсылкаНаДок);          	
	Запрос.УстановитьПараметр("ВсеУпаковки", Истина);
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	Запрос.УстановитьПараметр("ВключатьАртикул", ВключатьАртикул);
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());
	
	Тип_Услуга = Перечисления.ТипыНоменклатуры.Услуга;
	
	Рез = Запрос.Выполнить().Выгрузить(); 	
	Для каждого СтрокаДока Из Рез Цикл 
		
		Итог = (СтрокаДока.ВНаличии - СтрокаДока.ВРезерве - СтрокаДока.ВРезервеТСД);
		СтрокаДока.Коэффициент = ?(СтрокаДока.Коэффициент = 0, 1, СтрокаДока.Коэффициент);
		СтрокаДока.НаименованиеУпаковки = ?(ЗначениеЗаполнено(СтрокаДока.НаименованиеУпаковки), СтрокаДока.НаименованиеУпаковки, "шт.");
		
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan");
		ОбъектТовара.name = ЧистаяСтрока(СокрП(СтрокаДока.НаименованиеТовара));
		ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
		ОбъектТовара.price = СтрокаДока.Цена;
		
		// Выгрузка дополнительных видов цен
		ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Характеристика);
		
		Попытка	 
			DMUseSN = ПолучитьПризнакУчетаСерий(СтрокаДока.ВидНоменклатуры, СсылкаНаДок.Склад);
		Исключение
			DMUseSN = Ложь;
		КонецПопытки; 
		
		СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, СтрокаДока, DMUseSN, Шаблон);
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		Попытка
			ТекущийШтрихкод = ПолучитьШтрихкодУпаковки(СтрокаДока.Номенклатура, СтрокаДока.Характеристика, СтрокаДока.Упаковка);
			Если ЗначениеЗаполнено(ТекущийШтрихкод) Тогда					
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","unit_value");
				ОбъектШтрихкода.value = ЧистаяСтрока(ТекущийШтрихкод);
			Иначе
				ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");	
			КонецЕсли;
			ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура);
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
		Исключение
		Конецпопытки;
		
		//Серия 
		Попытка 
			Если ЗначениеЗаполнено(СтрокаДока.Серия) Тогда 
				sn = ПолучитьЗначениеСерии(УзелПО,СтрокаДока.Номенклатура, СтрокаДока.Серия);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;
		Исключение		 
		КонецПопытки;
		
		ЭтоУслуга = Ложь;
		Попытка 
			Если СтрокаДока.ВидНоменклатурыТипНоменклатуры = Тип_Услуга Тогда
				ЭтоУслуга = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		ИначеЕсли ЭтоУслуга Тогда
			limit_qty = 999;	
		Иначе
			limit_qty = Итог;
		КонецЕсли;
		
		//Количество в базовых
		qty = СтрокаДока.Количество * СтрокаДока.Коэффициент; 		
		
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		СтруктураТекущейСтроки.Вставить("qty", qty);
		СтруктураТекущейСтроки.Вставить("unit_qty", СтрокаДока.Количество);
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки); 
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ПолучитьНоменклатуруУпаковкиМДЛП(УзелПО, СсылкаНаДок, ОбъектСписка, Barcode, ЭтоДокументМДЛП)
		
	Если Лев(Barcode, 2) = "00" И (СтрДлина(Barcode) = 20 Или Найти(Barcode, "/") = 21) Тогда
		Barcode1 = "(00)" + Сред(Barcode, 3, 18);
		Barcode2 = Сред(Barcode, 3, 18);
	ИначеЕсли Лев(Barcode, 4) = "(00)" И (СтрДлина(Barcode) = 22 Или Найти(Barcode, "/") = 23) Тогда
		Barcode1 = "(00)" + Сред(Barcode, 5, 18);
		Barcode2 = Сред(Barcode, 5, 18);
	Иначе 
		Barcode1 = Barcode;
		Barcode2 = Barcode;		
	КонецЕсли;
		
	Шаблон = СсылкаНаДок.Шаблон;
	
	//КОРОБА
	Запрос = Новый Запрос;	
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ШтрихкодыУпаковокТоваров.Ссылка КАК Марка
	|ПОМЕСТИТЬ Марки
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
	|ГДЕ
	|	(ШтрихкодыУпаковокТоваров.Ссылка.ЗначениеШтрихкода = &ЗначениеШтрихкода1
	|		ИЛИ ШтрихкодыУпаковокТоваров.Ссылка.ЗначениеШтрихкода = &ЗначениеШтрихкода2)
	|	И ШтрихкодыУпаковокТоваров.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|	И (ШтрихкодыУпаковокТоваров.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|		ИЛИ (ШтрихкодыУпаковокТоваров.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|			И ШтрихкодыУпаковокТоваров.ТипШтрихкода <> ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)))
	|;
	|////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода КАК Марка,
	|	ШтрихкодыУпаковокТоваров.Номенклатура КАК Номенклатура,
	|	ШтрихкодыУпаковокТоваров.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА &ВключатьАртикул
	|			ТОГДА ВЫБОР
	|					КОГДА ШтрихкодыУпаковокТоваров.Номенклатура.Артикул = """"
	|						ТОГДА """"
	|					ИНАЧЕ ШтрихкодыУпаковокТоваров.Номенклатура.Артикул + "" ""
	|				КОНЕЦ
	|		ИНАЧЕ """"
	|	КОНЕЦ + ШтрихкодыУпаковокТоваров.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ШтрихкодыУпаковокТоваров.Характеристика.Наименование, """") КАК НаименованиеТовара,
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваров.Упаковка.Наименование, ШтрихкодыУпаковокТоваров.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
	|	ШтрихкодыУпаковокТоваров.Номенклатура.ВидНоменклатуры.ИспользоватьСерии КАК ИспользоватьСерии,
	|	ВЫБОР
	|		КОГДА ШтрихкодыУпаковокТоваров.Количество = 0 
	|		ТОГДА
	|			ВЫБОР
	|				КОГДА ЕСТЬNULL(ШтрихкодыУпаковокТоваров.Упаковка.Числитель,0) = 0
	|				ТОГДА 1
	|				ИНАЧЕ ШтрихкодыУпаковокТоваров.Упаковка.Числитель
	|			КОНЕЦ
	|		ИНАЧЕ ШтрихкодыУпаковокТоваров.Количество 
	|	КОНЕЦ КАК Коэффициент
	|ПОМЕСТИТЬ ИтоговыеДанныеУпаковки
	|ИЗ
	|	Марки КАК Марки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
	|			ПО Марки.Марка = ШтрихкодыУпаковокТоваров.Ссылка	
	|;
	|////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ИтоговыеДанныеУпаковки.Номенклатура КАК Номенклатура,
	|	ИтоговыеДанныеУпаковки.Характеристика КАК Характеристика
	|ПОМЕСТИТЬ НайденныеТовары
	|ИЗ
	|	ИтоговыеДанныеУпаковки КАК ИтоговыеДанныеУпаковки
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0)) КАК ВНаличии,
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.КОтгрузкеОстаток, 0)) КАК ВРезерве,
	|	СвободныеОстаткиОстатки.Номенклатура КАК Номенклатура,
	|	СвободныеОстаткиОстатки.Характеристика КАК Характеристика
	|ПОМЕСТИТЬ ТоварыСОстатками1С
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			&ТекущаяДата,
	|			Номенклатура В (ВЫБРАТЬ
	|									НайденныеТовары.Номенклатура КАК Номенклатура
	|								ИЗ 
	|									НайденныеТовары КАК НайденныеТовары)						
	|			И (&ВсеСклады ИЛИ Склад В (&Склады))
	|			И (&ВсеПомещения ИЛИ Помещение В (&Помещения))) КАК СвободныеОстаткиОстатки
	|СГРУППИРОВАТЬ ПО
	|	СвободныеОстаткиОстатки.Номенклатура,
	|	СвободныеОстаткиОстатки.Характеристика
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСД.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ДокументыСРезервамиТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД КАК ДатаМобайл_ДокументыТСД
	|ГДЕ	
	|	(ДатаМобайл_ДокументыТСД.Ссылка <> &ИсходноеЗадание)
	|		И (ДатаМобайл_ДокументыТСД.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1))
	|			И (ДатаМобайл_ДокументыТСД.Шаблон.РезервироватьТовар)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество,0)) КАК Количество
	|ПОМЕСТИТЬ ДанныеДокументыСРезервамиТСД
	|ИЗ
	|	ДокументыСРезервамиТСД КАК ДокументыСРезервамиТСД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|		ПО ДокументыСРезервамиТСД.Ссылка = ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК Характеристика,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество * (ВЫБОР
	|				КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель = 0
	|						ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель ЕСТЬ NULL
	|					ТОГДА 1
	|				ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель
	|			КОНЕЦ / ВЫБОР
	|				КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель = 0
	|						ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель ЕСТЬ NULL
	|					ТОГДА 1
	|				ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель
	|			КОНЕЦ), 0)) КАК ВРезервеТСД
	|ПОМЕСТИТЬ ТоварыСРезервамиТСД
	|ИЗ
	|	НайденныеТовары КАК НайденныеТовары
	|	ЛЕВОЕ СОЕДИНЕНИЕ ДанныеДокументыСРезервамиТСД КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|	ПО НайденныеТовары.Номенклатура = ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура
	| 		И НайденныеТовары.Характеристика = ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры			
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЦеныНоменклатурыСрезПоследних.Номенклатура КАК Номенклатура,
	|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) КАК ЧИСЛО(19, 2))) КАК Цена
	|ПОМЕСТИТЬ ТоварыСЦенами
	|ИЗ
	|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
	|			&ТекущаяДата, 
	|			Номенклатура В (ВЫБРАТЬ
	|									НайденныеТовары.Номенклатура КАК Номенклатура
	|								ИЗ 
	|									НайденныеТовары КАК НайденныеТовары)			
	|			И ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
	|СГРУППИРОВАТЬ ПО
	|	ЦеныНоменклатурыСрезПоследних.Номенклатура
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ИтоговыеДанныеУпаковки.Марка КАК Марка,
	|	ИтоговыеДанныеУпаковки.Номенклатура КАК Номенклатура,
	|	ИтоговыеДанныеУпаковки.Характеристика КАК Характеристика,
	|	ИтоговыеДанныеУпаковки.НаименованиеТовара КАК НаименованиеТовара,
	|	ИтоговыеДанныеУпаковки.НаименованиеУпаковки КАК НаименованиеУпаковки,
	|	ИтоговыеДанныеУпаковки.ИспользоватьСерии КАК ИспользоватьСерии,
	|	ИтоговыеДанныеУпаковки.Коэффициент КАК Коэффициент,
	|	ЕСТЬNULL(ТоварыСОстатками1С.ВНаличии, 0) КАК ВНаличии,
	|	ЕСТЬNULL(ТоварыСОстатками1С.ВРезерве, 0) КАК ВРезерве,
	|	ЕСТЬNULL(ТоварыСРезервамиТСД.ВРезервеТСД, 0) КАК ВРезервеТСД,
	|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена
	|ПОМЕСТИТЬ ИтоговыеДанные
	|ИЗ
	|	ИтоговыеДанныеУпаковки КАК ИтоговыеДанныеУпаковки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыСОстатками1С КАК ТоварыСОстатками1С
	|		ПО (ИтоговыеДанныеУпаковки.Номенклатура = ТоварыСОстатками1С.Номенклатура)
	|			И (ИтоговыеДанныеУпаковки.Характеристика = ТоварыСОстатками1С.Характеристика)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыСРезервамиТСД КАК ТоварыСРезервамиТСД
	|		ПО (ИтоговыеДанныеУпаковки.Номенклатура = ТоварыСРезервамиТСД.Номенклатура)
	|			И (ИтоговыеДанныеУпаковки.Характеристика = ТоварыСРезервамиТСД.Характеристика)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
	|		ПО (ИтоговыеДанныеУпаковки.Номенклатура = ТоварыСЦенами.Номенклатура)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ИтоговыеДанные.Марка КАК Марка,
	|	ИтоговыеДанные.Номенклатура КАК Номенклатура, 
	|	ИтоговыеДанные.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой, 
	|	ИтоговыеДанные.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,  
	|	ИтоговыеДанные.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ИтоговыеДанные.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
	|	ИтоговыеДанные.Номенклатура.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
	|	ИтоговыеДанные.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	|	ИтоговыеДанные.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
	|	ИтоговыеДанные.Характеристика.Наименование КАК НаименованиеХарактеристики, 	     	 
	|	ИтоговыеДанные.Характеристика КАК Характеристика,
	|	ИтоговыеДанные.НаименованиеТовара КАК НаименованиеТовара,
	|	ИтоговыеДанные.НаименованиеУпаковки КАК НаименованиеУпаковки,
	|	ИтоговыеДанные.ИспользоватьСерии КАК ИспользоватьСерии,
	|	СУММА(ИтоговыеДанные.Коэффициент) КАК Коэффициент,
	|	ИтоговыеДанные.ВНаличии КАК ВНаличии,
	|	ИтоговыеДанные.ВРезерве КАК ВРезерве,
	|	ИтоговыеДанные.ВРезервеТСД КАК ВРезервеТСД,
	|	ИтоговыеДанные.Цена КАК Цена
	|ИЗ
	|	ИтоговыеДанные КАК ИтоговыеДанные
	|СГРУППИРОВАТЬ ПО
	|	ИтоговыеДанные.Марка,
	|	ИтоговыеДанные.Номенклатура,
	|	ИтоговыеДанные.Номенклатура.ВесМожноУказыватьВДокументах, 
	|	ИтоговыеДанные.Номенклатура.ИспользованиеХарактеристик,  
	|	ИтоговыеДанные.Номенклатура.Наименование,
	|	ИтоговыеДанные.Номенклатура.ВладелецХарактеристик,
	|	ИтоговыеДанные.Номенклатура.АлкогольнаяПродукция,
	|	ИтоговыеДанные.Номенклатура.ВидНоменклатуры,
	|	ИтоговыеДанные.Номенклатура.ВидНоменклатуры.ТипНоменклатуры,
	|	ИтоговыеДанные.Характеристика.Наименование, 	   
	|	ИтоговыеДанные.Характеристика,
	|	ИтоговыеДанные.НаименованиеТовара,
	|	ИтоговыеДанные.НаименованиеУпаковки,
	|	ИтоговыеДанные.ИспользоватьСерии,
	|	ИтоговыеДанные.ВНаличии,
	|	ИтоговыеДанные.ВРезерве,
	|	ИтоговыеДанные.ВРезервеТСД,
	|	ИтоговыеДанные.Цена
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыСОстатками1С
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыСРезервамиТСД
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДанныеДокументыСРезервамиТСД
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыСРезервамиТСД
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыСЦенами
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Марки
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ НайденныеТовары
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ИтоговыеДанныеУпаковки
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ИтоговыеДанные";
	
	СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "ПолучитьНоменклатуруУпаковкиМДЛП");
	
	Запрос.УстановитьПараметр("ЗначениеШтрихкода1", Barcode1);
	Запрос.УстановитьПараметр("ЗначениеШтрихкода2", Barcode2);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".РеализацияТоваровУслуг.", "." + Шаблон.ВидДокумента + ".");	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК");	
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИтоговыеДанныеУпаковки.Марка", """""");	
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок.ИсходныйДокумент);
	Запрос.УстановитьПараметр("ВключатьАртикул", УзелПО.ДобавлятьАртикулВНаименование);
		
	Запрос.УстановитьПараметр("ТипЦен", УзелПО.ТипЦен);
	Запрос.УстановитьПараметр("ИсходноеЗадание", СсылкаНаДок);
	
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());
	
	ТаблицаТоваров = Запрос.Выполнить().Выгрузить();		
	
	Для каждого СтрокаДока Из ТаблицаТоваров Цикл
		
		Итог = (СтрокаДока.ВНаличии - СтрокаДока.ВРезерве - СтрокаДока.ВРезервеТСД);
		СтрокаДока.Коэффициент = ?(СтрокаДока.Коэффициент = 0, 1, СтрокаДока.Коэффициент);
		СтрокаДока.НаименованиеУпаковки = ?(ЗначениеЗаполнено(СтрокаДока.НаименованиеУпаковки), СтрокаДока.НаименованиеУпаковки, "шт.");
		
		СтруктураТекущейСтроки = Новый Структура;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan");		
		ОбъектТовара.name = ЧистаяСтрока(СокрП(СтрокаДока.НаименованиеТовара));
		ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);	
		ОбъектТовара.price = СтрокаДока.Цена;
		
		// Выгрузка дополнительных видов цен
		ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Характеристика);
					
		Попытка
			DMUseSN = ПолучитьПризнакУчетаСерий(СтрокаДока.ВидНоменклатуры, СсылкаНаДок.Склад);
		Исключение
			DMUseSN = Ложь;
		КонецПопытки; 
		
		СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, СтрокаДока, DMUseSN, Шаблон);
		
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		Попытка
			ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");	
			ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.Упаковка, СтрокаДока.Номенклатура);
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
		Исключение
		КонецПопытки;
		
		ЭтоУслуга = Ложь;
		Попытка
			Если СтрокаДока.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
				ЭтоУслуга = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		ЭтоНабор = Ложь;
		Попытка 
			Если СтрокаДока.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Набор Тогда
				ЭтоНабор = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Если ЭтоНабор И Шаблон.РежимКомплектации = 1 Тогда
			СтруктураТекущейСтроки.Вставить("is_kit", Истина);
		Иначе
			СтруктураТекущейСтроки.Вставить("is_kit", Ложь);	
		КонецЕсли;
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		ИначеЕсли ЭтоУслуга Тогда
			limit_qty = 999;	
		Иначе
			limit_qty = Итог;
		КонецЕсли;
		
		//Количество в базовых
		qty = СтрокаДока.Коэффициент;					
		
		Если ЭтоДокументМДЛП Тогда 
			ЧистаяМарка = ДатаМобайл_МДЛП.ДобавитьВМаркуУпрСимволы(СтрокаДока.Марка);	
		Иначе
			ЧистаяМарка = ДатаМобайл_Маркировка.УбратьСкобкиТеговМарка(СтрокаДока.Марка, ОбъектТовара.mark_type);
		КонецЕсли;
		
		ОбъектМаркировка = ПолучитьСтруктуруОбъектаДляHttp("marking");	
		ОбъектМаркировка.mark = ЧистаяМарка;	
		
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		СтруктураТекущейСтроки.Вставить("qty", qty);
		СтруктураТекущейСтроки.Вставить("unit_qty", qty);
		
		СтруктураТекущейСтроки.Вставить("marking", ОбъектМаркировка);
		
		Если ЗначениеЗаполнено(ОбъектМаркировка.mark) Тогда 
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		КонецЕсли;   	
		
	КонецЦикла;
	
КонецПроцедуры

//Получение содержимого упаковки с маркированным товаром.
//
// Параметры:        
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// ОбъектСписка - Массив - Массив данных.
// Barcode - Строка - Штрихкод.
// ЭтоДокументМДЛП - Булево - Фильтр по документам МДЛП
// ТолькоТовары - Булево - Фильтр "ТолькоТовары" или нет.
//  
Процедура ПолучитьСодержимоеУпаковки_Маркировка(УзелПО, СсылкаНаДок, ОбъектСписка, Barcode, ЭтоДокументМДЛП, ТолькоТовары = Ложь)
	
	Barcode = СтрЗаменить(Barcode, "[", "(");
	Barcode = СтрЗаменить(Barcode, "]", ")");
		
	Если ЭтоДокументМДЛП Тогда
		Если Лев(Barcode, 2) = "00" И (СтрДлина(Barcode) = 20 Или Найти(Barcode, "/") = 21) Тогда
			Barcode1 = "(00)" + Сред(Barcode, 3, 18);
			Barcode2 = Сред(Barcode, 3, 18);
		ИначеЕсли Лев(Barcode, 4) = "(00)" И (СтрДлина(Barcode) = 22 Или Найти(Barcode, "/") = 23) Тогда
			Barcode1 = "(00)" + Сред(Barcode, 5, 18);
			Barcode2 = Сред(Barcode, 5, 18);
		Иначе 
			Barcode1 = Barcode;
			Barcode2 = Barcode;		
		КонецЕсли;
	Иначе
		Если Лев(Barcode, 2) = "00" И (СтрДлина(Barcode) = 20 Или Найти(Barcode, "/") = 21) Тогда
			Barcode1 = "(00)" + Сред(Barcode, 3, 18);
			Barcode2 = Сред(Barcode, 1, 20);
		ИначеЕсли Лев(Barcode, 4) = "(00)" И (СтрДлина(Barcode) = 22 Или Найти(Barcode, "/") = 23) Тогда
			Barcode1 = Сред(Barcode, 1, 22);
			Barcode2 = "00" + Сред(Barcode, 5, 18);
		ИначеЕсли СтрДлина(Barcode) = 18 Тогда
			Barcode1 = "(00)" + Barcode;
			Barcode2 = "00" + Barcode;
		Иначе 
			Barcode1 = Barcode;
			Barcode2 = Barcode;	
		КонецЕсли;	
	КонецЕсли;
	
	Barcode3 = ДатаМобайл_Маркировка.УбратьСкобкиТеговУпаковка(Barcode);
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Короб
	|ПОМЕСТИТЬ КоробаПалеты	
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|ГДЕ
	|	(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.ЗначениеШтрихкода = &ЗначениеШтрихкода1)
	|	И (ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|		ИЛИ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|	И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипШтрихкода <> ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Короб	
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|ГДЕ
	|	(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.ЗначениеШтрихкода = &ЗначениеШтрихкода2)
	|	И (ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|		ИЛИ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|	И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипШтрихкода <> ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Короб	
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|ГДЕ
	|	(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.ЗначениеШтрихкода = &ЗначениеШтрихкода3)
	|	И (ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|		ИЛИ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|	И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипШтрихкода <> ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)
	|;
	|////////////////////////////////////////////////////////////
	|
	//КОРОБА ИЗ ПАЛЕТЫ
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Марка,
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Номенклатура,ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) КАК НоменклатураКороба,
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Характеристика,ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК ХарактеристикаКороба,
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Серия,ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)) КАК СерияКороба,
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Упаковка,ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)) КАК УпаковкаКороба,
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Упаковка.Числитель,0) КАК КоэффициентУпаковкиКороба
	|ПОМЕСТИТЬ Марки
	|ИЗ
	|	КоробаПалеты КАК КоробаПалеты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|		ПО КоробаПалеты.Короб = ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка
	|ГДЕ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|	И (ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|		ИЛИ ((ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|			 ИЛИ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|			И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипШтрихкода = ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)))
	|
	|ОБЪЕДИНИТЬ
	|
	//КОРОБА БЕЗ ПАЛЕТ
	|ВЫБРАТЬ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод,
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Номенклатура,ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Характеристика,ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Серия,ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Упаковка,ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Упаковка.Числитель,0) КАК КоэффициентУпаковкиКороба
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|ГДЕ
	|	(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.ЗначениеШтрихкода = &ЗначениеШтрихкода1)
	|	И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)	
	|	И (ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|		ИЛИ ((ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|			 ИЛИ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|			И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипШтрихкода = ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)))
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод,
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Номенклатура,ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Характеристика,ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Серия,ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Упаковка,ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Упаковка.Числитель,0) КАК КоэффициентУпаковкиКороба
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|ГДЕ
	|	(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.ЗначениеШтрихкода = &ЗначениеШтрихкода2)
	|	И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)	
	|	И (ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|		ИЛИ ((ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|			 ИЛИ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|			И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипШтрихкода = ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)))
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод,
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Номенклатура,ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Характеристика,ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Серия,ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Упаковка,ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)),
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.Упаковка.Числитель,0) КАК КоэффициентУпаковкиКороба
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
	|ГДЕ
	|	(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.ЗначениеШтрихкода = &ЗначениеШтрихкода3)
	|	И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.Номенклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)	
	|	И (ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|		ИЛИ ((ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|			 ИЛИ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|			И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод.ТипШтрихкода = ЗНАЧЕНИЕ(Перечисление.ТипыШтрихкодов.GS1_DataMatrix)))
	|;
	|////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода КАК Марка,
	|	ШтрихкодыУпаковокТоваров.Номенклатура КАК Номенклатура,
	|	ШтрихкодыУпаковокТоваров.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА &ВключатьАртикул
	|			ТОГДА ВЫБОР
	|					КОГДА ШтрихкодыУпаковокТоваров.Номенклатура.Артикул = """"
	|						ТОГДА """"
	|					ИНАЧЕ ШтрихкодыУпаковокТоваров.Номенклатура.Артикул + "" ""
	|				КОНЕЦ
	|		ИНАЧЕ """"
	|	КОНЕЦ + ШтрихкодыУпаковокТоваров.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ШтрихкодыУпаковокТоваров.Характеристика.Наименование, """") КАК НаименованиеТовара,
	|	ЕСТЬNULL(ШтрихкодыУпаковокТоваров.Упаковка.Наименование, ШтрихкодыУпаковокТоваров.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
	|	ШтрихкодыУпаковокТоваров.Номенклатура.ВидНоменклатуры.ИспользоватьСерии КАК ИспользоватьСерии,
	|	ВЫБОР
	|		КОГДА ШтрихкодыУпаковокТоваров.Количество = 0 
	|		ТОГДА
	|			ВЫБОР
	|				КОГДА ЕСТЬNULL(ШтрихкодыУпаковокТоваров.Упаковка.Числитель,0) = 0
	|				ТОГДА 1
	|				ИНАЧЕ ШтрихкодыУпаковокТоваров.Упаковка.Числитель
	|			КОНЕЦ
	|		ИНАЧЕ ШтрихкодыУпаковокТоваров.Количество 
	|	КОНЕЦ КАК Коэффициент,
	|	Марки.НоменклатураКороба КАК НоменклатураКороба,
	|	Марки.ХарактеристикаКороба КАК ХарактеристикаКороба,
	|	Марки.СерияКороба КАК СерияКороба,
	|	Марки.УпаковкаКороба КАК УпаковкаКороба,
	|	Марки.КоэффициентУпаковкиКороба КАК КоэффициентУпаковкиКороба
	|ПОМЕСТИТЬ ИтоговыеДанныеУпаковки
	|ИЗ
	|	Марки КАК Марки
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
	|			ПО Марки.Марка = ШтрихкодыУпаковокТоваров.Ссылка	
	|;
	|////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ИтоговыеДанныеУпаковки.Номенклатура КАК Номенклатура,
	|	ИтоговыеДанныеУпаковки.Характеристика КАК Характеристика
	|ПОМЕСТИТЬ НайденныеТовары
	|ИЗ
	|	ИтоговыеДанныеУпаковки КАК ИтоговыеДанныеУпаковки
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0)) КАК ВНаличии,
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.КОтгрузкеОстаток, 0)) КАК ВРезерве,
	|	СвободныеОстаткиОстатки.Номенклатура КАК Номенклатура,
	|	СвободныеОстаткиОстатки.Характеристика КАК Характеристика
	|ПОМЕСТИТЬ ТоварыСОстатками1С
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|			&ТекущаяДата,
	|			Номенклатура В (ВЫБРАТЬ
	|									НайденныеТовары.Номенклатура КАК Номенклатура
	|								ИЗ 
	|									НайденныеТовары КАК НайденныеТовары)						
	|			И (&ВсеСклады ИЛИ Склад В (&Склады))
	|			И (&ВсеПомещения ИЛИ Помещение В (&Помещения))) КАК СвободныеОстаткиОстатки
	|СГРУППИРОВАТЬ ПО
	|	СвободныеОстаткиОстатки.Номенклатура,
	|	СвободныеОстаткиОстатки.Характеристика
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСД.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ДокументыСРезервамиТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД КАК ДатаМобайл_ДокументыТСД
	|ГДЕ	
	|	(ДатаМобайл_ДокументыТСД.Ссылка <> &ИсходноеЗадание)
	|		И (ДатаМобайл_ДокументыТСД.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1))
	|			И (ДатаМобайл_ДокументыТСД.Шаблон.РезервироватьТовар)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество,0)) КАК Количество
	|ПОМЕСТИТЬ ДанныеДокументыСРезервамиТСД
	|ИЗ
	|	ДокументыСРезервамиТСД КАК ДокументыСРезервамиТСД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|		ПО ДокументыСРезервамиТСД.Ссылка = ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК Характеристика,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество * (ВЫБОР
	|				КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель = 0
	|						ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель ЕСТЬ NULL
	|					ТОГДА 1
	|				ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель
	|			КОНЕЦ / ВЫБОР
	|				КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель = 0
	|						ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель ЕСТЬ NULL
	|					ТОГДА 1
	|				ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель
	|			КОНЕЦ), 0)) КАК ВРезервеТСД
	|ПОМЕСТИТЬ ТоварыСРезервамиТСД
	|ИЗ
	|	НайденныеТовары КАК НайденныеТовары
	|	ЛЕВОЕ СОЕДИНЕНИЕ ДанныеДокументыСРезервамиТСД КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|	ПО НайденныеТовары.Номенклатура = ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура
	| 		И НайденныеТовары.Характеристика = ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЦеныНоменклатурыСрезПоследних.Номенклатура КАК Номенклатура,
	|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) КАК ЧИСЛО(19, 2))) КАК Цена
	|ПОМЕСТИТЬ ТоварыСЦенами
	|ИЗ
	|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
	|			&ТекущаяДата, 
	|			Номенклатура В (ВЫБРАТЬ
	|									НайденныеТовары.Номенклатура КАК Номенклатура
	|								ИЗ 
	|									НайденныеТовары КАК НайденныеТовары)			
	|			И ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
	|СГРУППИРОВАТЬ ПО
	|	ЦеныНоменклатурыСрезПоследних.Номенклатура
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ИтоговыеДанныеУпаковки.Марка КАК Марка,
	|	ИтоговыеДанныеУпаковки.Номенклатура КАК Номенклатура,
	|	ИтоговыеДанныеУпаковки.Характеристика КАК Характеристика,
	|	ИтоговыеДанныеУпаковки.НаименованиеТовара КАК НаименованиеТовара,
	|	ИтоговыеДанныеУпаковки.НаименованиеУпаковки КАК НаименованиеУпаковки,
	|	ИтоговыеДанныеУпаковки.ИспользоватьСерии КАК ИспользоватьСерии,
	|	ИтоговыеДанныеУпаковки.Коэффициент КАК Коэффициент,
	|	ИтоговыеДанныеУпаковки.НоменклатураКороба КАК НоменклатураКороба,
	|	ИтоговыеДанныеУпаковки.ХарактеристикаКороба КАК ХарактеристикаКороба,
	|	ИтоговыеДанныеУпаковки.СерияКороба КАК СерияКороба,
	|	ИтоговыеДанныеУпаковки.УпаковкаКороба КАК УпаковкаКороба,
	|	ИтоговыеДанныеУпаковки.КоэффициентУпаковкиКороба КАК КоэффициентУпаковкиКороба,
	|	ЕСТЬNULL(ТоварыСОстатками1С.ВНаличии, 0) КАК ВНаличии,
	|	ЕСТЬNULL(ТоварыСОстатками1С.ВРезерве, 0) КАК ВРезерве,
	|	ЕСТЬNULL(ТоварыСРезервамиТСД.ВРезервеТСД, 0) КАК ВРезервеТСД,
	|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена
	|ПОМЕСТИТЬ ИтоговыеДанные
	|ИЗ
	|	ИтоговыеДанныеУпаковки КАК ИтоговыеДанныеУпаковки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыСОстатками1С КАК ТоварыСОстатками1С
	|		ПО (ИтоговыеДанныеУпаковки.Номенклатура = ТоварыСОстатками1С.Номенклатура)
	|			И (ИтоговыеДанныеУпаковки.Характеристика = ТоварыСОстатками1С.Характеристика)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыСРезервамиТСД КАК ТоварыСРезервамиТСД
	|		ПО (ИтоговыеДанныеУпаковки.Номенклатура = ТоварыСРезервамиТСД.Номенклатура)
	|			И (ИтоговыеДанныеУпаковки.Характеристика = ТоварыСРезервамиТСД.Характеристика)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
	|		ПО (ИтоговыеДанныеУпаковки.Номенклатура = ТоварыСЦенами.Номенклатура)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ИтоговыеДанные.Марка КАК Марка,
	|	ИтоговыеДанные.Номенклатура КАК Номенклатура, 
	|	ИтоговыеДанные.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой, 
	|	ИтоговыеДанные.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик,  
	|	ИтоговыеДанные.Номенклатура.Наименование КАК НаименованиеНоменклатуры,
	|	ИтоговыеДанные.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
	|	ИтоговыеДанные.Номенклатура.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
	|	ИтоговыеДанные.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
	|	ИтоговыеДанные.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
	|	ИтоговыеДанные.Характеристика.Наименование КАК НаименованиеХарактеристики, 	   
	|	ИтоговыеДанные.Характеристика КАК Характеристика,
	|	ИтоговыеДанные.НаименованиеТовара КАК НаименованиеТовара,
	|	ИтоговыеДанные.НаименованиеУпаковки КАК НаименованиеУпаковки,
	|	ИтоговыеДанные.ИспользоватьСерии КАК ИспользоватьСерии,
	|	СУММА(ИтоговыеДанные.Коэффициент) КАК Коэффициент,
	|	ИтоговыеДанные.НоменклатураКороба КАК НоменклатураКороба,
	|	ИтоговыеДанные.НоменклатураКороба.ВесМожноУказыватьВДокументах КАК ВесовойКороба,
	|	ИтоговыеДанные.НоменклатураКороба.АлкогольнаяПродукция КАК АлкогольнаяПродукцияКороба,
	|	ИтоговыеДанные.НоменклатураКороба.ВидНоменклатуры КАК ВидНоменклатурыКороба, 
	|	ИтоговыеДанные.ХарактеристикаКороба КАК ХарактеристикаКороба,
	|	ИтоговыеДанные.СерияКороба КАК СерияКороба,
	|	ИтоговыеДанные.УпаковкаКороба КАК УпаковкаКороба,
	|	ИтоговыеДанные.КоэффициентУпаковкиКороба КАК КоэффициентУпаковкиКороба,
	|	ИтоговыеДанные.ВНаличии КАК ВНаличии,
	|	ИтоговыеДанные.ВРезерве КАК ВРезерве,
	|	ИтоговыеДанные.ВРезервеТСД КАК ВРезервеТСД,
	|	ИтоговыеДанные.Цена КАК Цена
	|ИЗ
	|	ИтоговыеДанные КАК ИтоговыеДанные
	|СГРУППИРОВАТЬ ПО
	|	ИтоговыеДанные.Марка,
	|	ИтоговыеДанные.Номенклатура,
	|	ИтоговыеДанные.Номенклатура.ВесМожноУказыватьВДокументах, 
	|	ИтоговыеДанные.Номенклатура.ИспользованиеХарактеристик,  
	|	ИтоговыеДанные.Номенклатура.Наименование,
	|	ИтоговыеДанные.Номенклатура.ВладелецХарактеристик,
	|	ИтоговыеДанные.Номенклатура.АлкогольнаяПродукция,
	|	ИтоговыеДанные.Номенклатура.ВидНоменклатуры,
	|	ИтоговыеДанные.Номенклатура.ВидНоменклатуры.ТипНоменклатуры,
	|	ИтоговыеДанные.Характеристика.Наименование, 	      
	|	ИтоговыеДанные.НоменклатураКороба.ВесМожноУказыватьВДокументах,
	|	ИтоговыеДанные.НоменклатураКороба.АлкогольнаяПродукция,
	|	ИтоговыеДанные.НоменклатураКороба.ВидНоменклатуры, 
	|	ИтоговыеДанные.ХарактеристикаКороба.Наименование,   	
	|	ИтоговыеДанные.Характеристика,
	|	ИтоговыеДанные.НаименованиеТовара,
	|	ИтоговыеДанные.НаименованиеУпаковки,
	|	ИтоговыеДанные.ИспользоватьСерии,
	|	ИтоговыеДанные.НоменклатураКороба,
	|	ИтоговыеДанные.ХарактеристикаКороба,
	|	ИтоговыеДанные.СерияКороба,
	|	ИтоговыеДанные.УпаковкаКороба,
	|	ИтоговыеДанные.КоэффициентУпаковкиКороба,
	|	ИтоговыеДанные.ВНаличии,
	|	ИтоговыеДанные.ВРезерве,
	|	ИтоговыеДанные.ВРезервеТСД,
	|	ИтоговыеДанные.Цена
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыСОстатками1С
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДокументыСРезервамиТСД
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ДанныеДокументыСРезервамиТСД
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыСРезервамиТСД
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ТоварыСЦенами
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ Марки
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ НайденныеТовары
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ИтоговыеДанныеУпаковки
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ИтоговыеДанные";
	
	СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "ПолучитьСодержимоеУпаковки_Маркировка");
	
	Запрос.УстановитьПараметр("ЗначениеШтрихкода1", Barcode1);
	Запрос.УстановитьПараметр("ЗначениеШтрихкода2", Barcode2);
	Запрос.УстановитьПараметр("ЗначениеШтрихкода3", Barcode3);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".РеализацияТоваровУслуг.", "." + Шаблон.ВидДокумента + ".");	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК");	
	
	Если Шаблон.МаркировкаОнлайнПроверкаВложенностиУпаковок Или ТолькоТовары Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИтоговыеДанныеУпаковки.Марка", """""");	
	КонецЕсли;		
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок.ИсходныйДокумент);
	Запрос.УстановитьПараметр("ВключатьАртикул", УзелПО.ДобавлятьАртикулВНаименование);
	
	Запрос.УстановитьПараметр("ТипЦен", УзелПО.ТипЦен);
	Запрос.УстановитьПараметр("ИсходноеЗадание", СсылкаНаДок);
	
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());
	
	ТаблицаТоваров = Запрос.Выполнить().Выгрузить();	
	
	УпаковкиМДЛП = Ложь;
	МаркированныеТоварыВУпаковкиМДЛП = Ложь;
	Если ЭтоДокументМДЛП Тогда
		Если ТаблицаТоваров.Количество() = 0 Тогда
			ПолучитьНоменклатуруУпаковкиМДЛП(УзелПО, СсылкаНаДок, ОбъектСписка, Barcode, ЭтоДокументМДЛП);
		КонецЕсли;	
		
		Если ТаблицаТоваров.Количество() = 0 Тогда
			Если Метаданные.НайтиПоПолномуИмени("РегистрСведений.УпаковкиМДЛП") <> Неопределено Тогда
				УпаковкиМДЛП = Истина;
				ТаблицаТоваров = ПолучитьТоварыБезЗаданияПоУпаковкамМДЛП(Barcode, Запрос, УзелПО, СсылкаНаДок, МаркированныеТоварыВУпаковкиМДЛП);		
			КонецЕсли;
		КонецЕсли;		
	КонецЕсли;	
	
	ПолучениеШапкиУпаковки = Ложь;
	
	Для каждого СтрокаДока Из ТаблицаТоваров Цикл
		
		СтруктураТекущейСтроки = Новый Структура;
		
		Попытка Итог = (СтрокаДока.ВНаличии - СтрокаДока.ВРезерве - СтрокаДока.ВРезервеТСД); Исключение Итог = 0; КонецПопытки;
		СтрокаДока.Коэффициент = ?(СтрокаДока.Коэффициент = 0, 1, СтрокаДока.Коэффициент);
		СтрокаДока.НаименованиеУпаковки = ?(ЗначениеЗаполнено(СтрокаДока.НаименованиеУпаковки), СтрокаДока.НаименованиеУпаковки, "шт.");	
		
		Если МаркированныеТоварыВУпаковкиМДЛП Тогда
			СтрокаДока.НоменклатураКороба 	= СтрокаДока.Номенклатура;
			СтрокаДока.ХарактеристикаКороба = СтрокаДока.Характеристика;
			СтрокаДока.Марка 				= СтрокаДока.ЗначениеШтрихкода; 
			Попытка СтрокаДока.ВесовойКороба						= СтрокаДока.Весовой; Исключение КонецПопытки;
			Попытка СтрокаДока.АлкогольнаяПродукцияКороба 			= СтрокаДока.АлкогольнаяПродукция; Исключение КонецПопытки;
			Попытка СтрокаДока.ВидНоменклатурыКороба				= СтрокаДока.ВидНоменклатуры; Исключение КонецПопытки;
			Попытка СтрокаДока.НаименованиеХарактеристикиКороба	= СтрокаДока.НаименованиеХарактеристики; Исключение КонецПопытки;
		КонецЕсли;
		
		ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan");
		Если ((ЗначениеЗаполнено(СтрокаДока.НоменклатураКороба) И ЗначениеЗаполнено(СтрокаДока.Номенклатура) И СтрокаДока.НоменклатураКороба <> СтрокаДока.Номенклатура)
			Или (ЗначениеЗаполнено(СтрокаДока.ХарактеристикаКороба) И ЗначениеЗаполнено(СтрокаДока.Характеристика) И СтрокаДока.ХарактеристикаКороба <> СтрокаДока.Характеристика))
			И Шаблон.МаркировкаОнлайнПроверкаВложенностиУпаковок Тогда
			
			//ПОЛУЧЕНИЕ ДАННЫХ ИЗ УПАКОВКИ
			
			ПолучениеШапкиУпаковки = Истина;
			
			СтрокаДока.Коэффициент = ?(СтрокаДока.КоэффициентУпаковкиКороба = 0, ?(СтрокаДока.Коэффициент = 0,1,СтрокаДока.Коэффициент), СтрокаДока.КоэффициентУпаковкиКороба);
						
			НаименованиеТовара = "";
			НаименованиеТовара = ?(УзелПО.ДобавлятьАртикулВНаименование, ?(СтрокаДока.НоменклатураКороба.Артикул = "", "", СтрокаДока.НоменклатураКороба.Артикул + " "), НаименованиеТовара);
			НаименованиеТовара = НаименованиеТовара + СтрокаДока.НоменклатураКороба.Наименование + СтрокаДока.ХарактеристикаКороба.Наименование;
						
			ОбъектТовара.name = ЧистаяСтрока(СокрП(НаименованиеТовара));
			ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.НоменклатураКороба) + XMLСтрока(СтрокаДока.ХарактеристикаКороба);	
			ОбъектТовара.price = СтрокаДока.Цена;
			
			// Выгрузка дополнительных видов цен
			ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрокаДока.НоменклатураКороба, СтрокаДока.ХарактеристикаКороба);
			
			Попытка	
				DMUseSN = ПолучитьПризнакУчетаСерий(СтрокаДока.ВидНоменклатуры, СсылкаНаДок.Склад);
			Исключение
				DMUseSN = Ложь;
			КонецПопытки;		                                            
			
			СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, СтрокаДока, DMUseSN,Шаблон);
			
		Иначе
			
			//ОБЫЧНАЯ ЛОГИКА
			
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","scan"); 
			ОбъектТовара.name = ЧистаяСтрока(СокрП(СтрокаДока.НаименованиеТовара));				
			ОбъектТовара.id = "8U-" + XMLСтрока(СтрокаДока.Номенклатура) + XMLСтрока(СтрокаДока.Характеристика);
			ОбъектТовара.price = СтрокаДока.Цена;
			
			// Выгрузка дополнительных видов цен
			ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрокаДока.Номенклатура, СтрокаДока.Характеристика);
			
			Попытка
				DMUseSN = ПолучитьПризнакУчетаСерий(СтрокаДока.ВидНоменклатуры, СсылкаНаДок.Склад);   		 
			Исключение
				DMUseSN = Ложь;
			КонецПопытки;
			
			СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, СтрокаДока, DMUseSN, Шаблон);			
			
		КонецЕсли;	
		СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		
		Попытка
			ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode","scan");	
			ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрокаДока.УпаковкаКороба, СтрокаДока.Номенклатура);
			СтруктураТекущейСтроки.Вставить("barcode", ОбъектШтрихкода);
		Исключение
		КонецПопытки;
		
		//Серия 
		Попытка
			Если ЗначениеЗаполнено(СтрокаДока.СерияКороба) Тогда 
				sn = ПолучитьЗначениеСерии(УзелПО, СтрокаДока.Номенклатура, СтрокаДока.СерияКороба);
				СтруктураТекущейСтроки.Вставить("sn", sn);
			КонецЕсли;	
		Исключение
		КонецПопытки;
		
		ЭтоУслуга = Ложь;
		Попытка 
			Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Услуга Тогда
				ЭтоУслуга = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		ЭтоНабор = Ложь;
		Попытка 
			Если СтрокаДока.Номенклатура.ВидНоменклатуры.ТипНоменклатуры = Перечисления.ТипыНоменклатуры.Набор Тогда
				ЭтоНабор = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Если ЭтоНабор И Шаблон.РежимКомплектации = 1 Тогда
			СтруктураТекущейСтроки.Вставить("is_kit", Истина);
		Иначе
			СтруктураТекущейСтроки.Вставить("is_kit", Ложь);	
		КонецЕсли;
		
		limit_qty = 0;
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		ИначеЕсли ЭтоУслуга Тогда
			limit_qty = 999;	
		Иначе
			limit_qty = Итог;
		КонецЕсли;
		
		qty = СтрокаДока.Коэффициент;
		
		СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
		СтруктураТекущейСтроки.Вставить("qty", qty);	
		СтруктураТекущейСтроки.Вставить("unit_qty", qty);	
		
		Если ЭтоДокументМДЛП Или УпаковкиМДЛП Тогда 
			ЧистаяМарка = ДатаМобайл_МДЛП.ДобавитьВМаркуУпрСимволы(СтрокаДока.Марка);	
		Иначе
			ЧистаяМарка = ДатаМобайл_Маркировка.УбратьСкобкиТеговМарка(СтрокаДока.Марка, ОбъектТовара.mark_type);
		КонецЕсли;
		
		ОбъектМаркировка = ПолучитьСтруктуруОбъектаДляHttp("marking");
		ОбъектМаркировка.mark = ЧистаяМарка;	
		
		Если ЗначениеЗаполнено(ОбъектМаркировка.mark) Тогда
			СтруктураТекущейСтроки.Вставить("marking", ОбъектМаркировка);
		КонецЕсли;
		
		ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		
		Если ПолучениеШапкиУпаковки Тогда
			Прервать;
		КонецЕсли;	
		
	КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьТоварыБезЗаданияПоУпаковкамМДЛП(Barcode, ОсновнойЗапрос, УзелПО, СсылкаНаДок, МаркированныеТоварыВУпаковкиМДЛП)
	
	Если Лев(Barcode, 2) = "00" И (СтрДлина(Barcode) = 20 Или Найти(Barcode, "/") = 21) Тогда
		Barcode1 = "(00)" + Сред(Barcode, 3, 18);
		Barcode2 = Сред(Barcode, 3, 18);
	ИначеЕсли Лев(Barcode, 4) = "(00)" И (СтрДлина(Barcode) = 22 Или Найти(Barcode, "/") = 23) Тогда
		Barcode1 = "(00)" + Сред(Barcode, 5, 18);
		Barcode2 = Сред(Barcode, 5, 18);
	Иначе 
		Barcode1 = Barcode;
		Barcode2 = Barcode;		
	КонецЕсли;
	
	ЗапросПоУпаковкамМДЛП = Новый Запрос;
	ЗапросПоУпаковкамМДЛП.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	УпаковкиМДЛП.НомерУпаковки КАК НомерУпаковки,
	|	УпаковкиМДЛП.ГрупповаяУпаковка КАК ГрупповаяУпаковка
	|ИЗ
	|	РегистрСведений.УпаковкиМДЛП КАК УпаковкиМДЛП
	|ГДЕ
	|	(УпаковкиМДЛП.НомерГрупповойУпаковки ПОДОБНО &ЗначениеШтрихкода1 СПЕЦСИМВОЛ ""$""
	|			ИЛИ УпаковкиМДЛП.НомерГрупповойУпаковки ПОДОБНО &ЗначениеШтрихкода2 СПЕЦСИМВОЛ ""$"")
	|	И УпаковкиМДЛП.НомерУпаковки <> """"";
	
	ЗапросПоУпаковкамМДЛП.УстановитьПараметр("ЗначениеШтрихкода1", Barcode1);
	ЗапросПоУпаковкамМДЛП.УстановитьПараметр("ЗначениеШтрихкода2", Barcode2);
	
	ТЗ = ЗапросПоУпаковкамМДЛП.Выполнить().Выгрузить();
	МассивЗначенийШтрихкодов = ТЗ.ВыгрузитьКолонку("НомерУпаковки");
	
	Если МассивЗначенийШтрихкодов.Количество() > 0 Тогда
		
		Если ТЗ[0].ГрупповаяУпаковка Тогда
			Запрос = Новый Запрос;
			Запрос.Текст = ОсновнойЗапрос.Текст;
			
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "(ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.ЗначениеШтрихкода = &ЗначениеШтрихкода1", 
			"ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.ЗначениеШтрихкода В (&МассивЗначенийШтрихкодов)");
			
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИЛИ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка.ЗначениеШтрихкода = &ЗначениеШтрихкода2)", "");
			
			Запрос.УстановитьПараметр("МассивЗначенийШтрихкодов", МассивЗначенийШтрихкодов);
			
			Для каждого СтрокаПараметр Из ОсновнойЗапрос.Параметры Цикл
				Запрос.УстановитьПараметр(СтрокаПараметр.Ключ, СтрокаПараметр.Значение);
			КонецЦикла; 
			
			Возврат Запрос.Выполнить().Выгрузить();
		Иначе
			МаркированныеТоварыВУпаковкиМДЛП = Истина;
			ТаблицаТоваров = ПолучитьТоварыБезЗадания(УзелПО, СсылкаНаДок, МассивЗначенийШтрихкодов, "", "");
			
			ТаблицаТоваров.Колонки.Добавить("НоменклатураКороба"	, Новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
			ТаблицаТоваров.Колонки.Добавить("ХарактеристикаКороба"	, Новый ОписаниеТипов("СправочникСсылка.ХарактеристикиНоменклатуры"));
			ТаблицаТоваров.Колонки.Добавить("Марка"					, Новый ОписаниеТипов("Строка"));
			
			Возврат ТаблицаТоваров;			
		КонецЕсли;
		
	КонецЕсли; 
	
	Возврат Новый Массив;
	
КонецФункции

#КонецОбласти

#Область SendArtToPrint

Функция ОтправитьСериюНаПечать(SN, UserName, DocID, СтруктураСтроки, ОписаниеОшибки)
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;
		
	Если УзелПО.ОнлайнСвязьСПринтсервером Тогда	
		АдресПринтсервера = УзелПО.АдресПринтсервера;
		ПортПринтсервера = УзелПО.ПортПринтсервера;
		Если АдресПринтсервера = "" Или ПортПринтсервера = 0 Тогда
			ОписаниеОшибки = "В обработке АРМ для терминала не указаны настройки онлайн связи с принтсервером. ";
			Возврат Ложь;
		КонецЕсли;	
	Иначе	
		КаталогСохранения = УзелПО.КаталогВыгрузкиФайлаПечати;
		Если КаталогСохранения = "" Тогда
			ОписаниеОшибки = "В обработке АРМ для терминала не указан каталог сохранения файлов печати. ";
		КонецЕсли;		
	КонецЕсли;	
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocID, 5));
	Исключение
		ОписаниеОшибки = "Не найден документ. ";
		Возврат Ложь;
	КонецПопытки;
	
	СтруктураПоиска = Новый Структура("ТипОперации", "Печать серийного номера/серии");
	
	СтрокиРеквизитов = УзелПО.Печать.НайтиСтроки(СтруктураПоиска);
	Если СтрокиРеквизитов.Количество() = 0 Тогда
		ОписаниеОшибки = "В обработке АРМ для терминала не указан шаблон печати серийного номера/серии. ";
		Возврат Ложь;
	КонецЕсли;	
	
	ЗаписьXML = Новый ЗаписьXML;
	
	Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
		ИмяФайла = ПолучитьНовоеИмяФайла();	
		Попытка
			ЗаписьXML.ОткрытьФайл(КаталогСохранения + ИмяФайла + ".xml", "UTF-8");
		Исключение
			ОписаниеОшибки = "Не удалось сохранить файл печати в каталоге: " + КаталогСохранения + " по причине: " + ОписаниеОшибки();
			Возврат Ложь;
		КонецПопытки;
	Иначе
		ЗаписьXML.УстановитьСтроку("UTF-8");
	КонецЕсли;
	
	ЗаписьXML.ЗаписатьОбъявлениеXML();	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("PrintData");
		
	ЗаписьXML.ЗаписатьНачалоЭлемента("PrinterName");
	ЗаписьXML.ЗаписатьТекст(СтрокиРеквизитов[0].ИмяПринтера);
	ЗаписьXML.ЗаписатьКонецЭлемента();		
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("TemplateName");
	ЗаписьXML.ЗаписатьТекст(СтрокиРеквизитов[0].ИмяШаблона);
	ЗаписьXML.ЗаписатьКонецЭлемента();		
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Count");
	ЗаписьXML.ЗаписатьТекст(Строка(СтруктураСтроки.Количество));
	ЗаписьXML.ЗаписатьКонецЭлемента();		
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Head");
	
	/////////////////////////////////////////////////
	ПорядковыйНомер = 0;
	СтруктураПоискаНомера = Новый Структура("Номенклатура", СтруктураСтроки.Номенклатура);
	СтрокиПоискаНомера = СсылкаНаДок.СобранныеДанныеПодбор.НайтиСтроки(СтруктураПоискаНомера);
	Если СтрокиПоискаНомера.Количество() = 0 Тогда
		ПорядковыйНомер = ПорядковыйНомер + 1;
	Иначе
		Для каждого СтрокаПоискаНомера Из СтрокиПоискаНомера Цикл
			Если СтрокаПоискаНомера.Количество > 0 Тогда
				ПорядковыйНомер = ПорядковыйНомер + 1;
			ИначеЕсли СтрокаПоискаНомера.Количество < 0 Тогда
				ПорядковыйНомер = ПорядковыйНомер - 1;
			КонецЕсли;	
		КонецЦикла;
		ПорядковыйНомер = ПорядковыйНомер + 1;
	КонецЕсли;
	
	Если ПорядковыйНомер = 0 Тогда
		ПорядковыйНомер = ПорядковыйНомер + 1; 
	КонецЕсли;	
	
	ДатаСтрока = Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy");
	НомерДокумента = СсылкаНаДок.ИсходныйДокумент.Номер;
	СерийныйНомер = СтруктураСтроки.СерийныйНомер;
	НазваниеТовара = СтруктураСтроки.НазваниеТовара;
	
	Попытка 
		АдресДоставки = СсылкаНаДок.ИсходныйДокумент.АдресДоставки; 
	Исключение
		АдресДоставки = ""; 
	КонецПопытки;
	/////////////////////////////////////////////////
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("CountNumber");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(ПорядковыйНомер));
	ЗаписьXML.ЗаписатьКонецЭлемента();//CountNumber
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("DocNumber");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(НомерДокумента));
	ЗаписьXML.ЗаписатьКонецЭлемента();//DocNumber
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("SN");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СерийныйНомер));
	ЗаписьXML.ЗаписатьКонецЭлемента();//SN	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("ArtName");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(НазваниеТовара));
	ЗаписьXML.ЗаписатьКонецЭлемента();//ArtName	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Address");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(АдресДоставки));
	ЗаписьXML.ЗаписатьКонецЭлемента();//Address	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Date");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(ДатаСтрока));
	ЗаписьXML.ЗаписатьКонецЭлемента();//Date	
	
	ЗаписьXML.ЗаписатьКонецЭлемента();//Head
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Detail");	
	ЗаписьXML.ЗаписатьКонецЭлемента();//Detail
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Summary");
	ЗаписьXML.ЗаписатьКонецЭлемента();//Summary
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Footer");	
	ЗаписьXML.ЗаписатьКонецЭлемента();//Footer
	
	ЗаписьXML.ЗаписатьКонецЭлемента();//PrintData
	
	Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
		ЗаписьXML.Закрыть();
	Иначе
		СтрокаДляЗапроса = ЗаписьXML.Закрыть();
		ОтправитьДанныеНаПринтсервер(УзелПО, СтрокаДляЗапроса, ОписаниеОшибки);
	КонецЕсли;
	
	Возврат Истина;  
	
КонецФункции

//Печать штрихкода короба.
//
// Параметры:        
// СтрокиРеквизитов - Структура - Структура данных реквизитов.
// ЗаписьXML - ЗаписьXML - Запись XML.
// Pack - Строка - ШК короба.
// ОписаниеОшибки - Строка - Описание ошибки (по умолчанию - пустая строка).
//
Процедура ВыполнитьПечатьШтрихкодаКороба(УзелПО, СтрокиРеквизитов, ЗаписьXML, Pack, ТЗСобранныеДанныеПодбор, ОписаниеОшибки)
	
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	ЗаписьXML.ЗаписатьНачалоЭлемента("PrintData");
	
	ЗаписатьЭлементXML(ЗаписьXML, "PrinterName", СтрокиРеквизитов[0].ИмяПринтера);
	ЗаписатьЭлементXML(ЗаписьXML, "TemplateName", СтрокиРеквизитов[0].ИмяШаблона);
	ЗаписатьЭлементXML(ЗаписьXML, "Count", СтрокиРеквизитов[0].КоличествоКопий);
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Head");
	
	ТекущийУпаковочныйЛист = Pack;	
		
	ЗаписьXML.ЗаписатьНачалоЭлемента("Barcode");
	Если Лев(ТекущийУпаковочныйЛист,4) = "(00)" тогда
		ТекущийУпаковочныйЛистШтрихкод= "00"+Сред(ТекущийУпаковочныйЛист,5);
	Иначе	
		ТекущийУпаковочныйЛистШтрихкод = ТекущийУпаковочныйЛист;
	КонецЕсли;	 
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(ТекущийУпаковочныйЛистШтрихкод));
	ЗаписьXML.ЗаписатьКонецЭлемента();//Barcode
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Pack"); 
	Если Лев(ТекущийУпаковочныйЛист,3) = "UPL" тогда
		ТекущийУпаковочныйЛистНаименование= Сред(ТекущийУпаковочныйЛист,4);
	Иначе	
		ТекущийУпаковочныйЛистНаименование = ТекущийУпаковочныйЛист;
	КонецЕсли;	 
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(ТекущийУпаковочныйЛистНаименование));
	ЗаписьXML.ЗаписатьКонецЭлемента();//Barcode

	ЗаписатьЭлементXML(ЗаписьXML, "Date", Формат(ТекущаяДата(), "ДП="));
	
	ИтогоТоваров = 0;
	
	ТЗСобранныеДанныеПодбор.Свернуть("НазваниеТовара, ХарактеристикаНоменклатуры, ЕдиницаИзмерения", "Количество"); 
	
	
	Для каждого СтрокаТЧ Из ТЗСобранныеДанныеПодбор Цикл
		Если СтрокаТЧ.Количество = 0 Тогда
			Продолжить;
		КонецЕсли;	
				
		ИтогоТоваров = ИтогоТоваров + СтрокаТЧ.Количество * ?(СтрокаТЧ.ЕдиницаИзмерения.Числитель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Числитель);
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("ArtName");
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.НазваниеТовара));
		ЗаписьXML.ЗаписатьКонецЭлемента();//ArtName
		
		ЗаписьXML.ЗаписатьНачалоЭлемента("ArtChar");
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.ХарактеристикаНоменклатуры.НаименованиеПолное));
		ЗаписьXML.ЗаписатьКонецЭлемента();//ArtChar
				
		ЗаписьXML.ЗаписатьНачалоЭлемента("Qnt");
		ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтрокаТЧ.Количество * ?(СтрокаТЧ.ЕдиницаИзмерения.Числитель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Числитель)));
		ЗаписьXML.ЗаписатьКонецЭлемента();//QNT 				
	КонецЦикла;
	
	ЗаписьXML.ЗаписатьКонецЭлемента();//Head
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Footer");
	ЗаписьXML.ЗаписатьКонецЭлемента();//Footer
	
	ЗаписьXML.ЗаписатьКонецЭлемента();//PrintData
	
	Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
		ЗаписьXML.Закрыть();
	Иначе
		СтрокаДляЗапроса = ЗаписьXML.Закрыть();
		ОтправитьДанныеНаПринтсервер(УзелПО, СтрокаДляЗапроса, ОписаниеОшибки);
	КонецЕсли;
	
КонецПроцедуры

//Печать этикеток обычных товаров.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// лТовар - СправочникСсылка.Номенклатура - Товар.
// лХарактеристика - СправочникСсылка.ХарактеристикиНоменклатуры - Характеристика.
// Barcode - Строка - Штрихкод.
// Count - Число - Количество этикеток.
// СтруктураParams - Структура - Структура дополнительных данных.
// ОписаниеОшибки - Строка - Описание ошибки (по умолчанию - пустая строка).
// 
Процедура ВыполнитьПечатьОбычныхТоваров(УзелПО, лТовар, лХарактеристика, Barcode, Count, СтруктураParams, ОписаниеОшибки)
	
	СтруктураОтвета = Новый Структура;		
		
	СтруктураПоиска = Новый Структура("ТипОперации", "Печать этикетки");
	СтрокиРеквизитов = УзелПО.Печать.НайтиСтроки(СтруктураПоиска);
	Если СтрокиРеквизитов.Количество() = 0 Тогда
		ОписаниеОшибки = "В обработке АРМ для терминала не указан шаблон печати упак. листа. ";
		Возврат;
	КонецЕсли;	
	
	ЗаписьXML = Новый ЗаписьXML;
	
	Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
		КаталогСохранения = УзелПО.КаталогВыгрузкиФайлаПечати;
		ИмяФайла = ПолучитьНовоеИмяФайла();	
		Попытка
			ЗаписьXML.ОткрытьФайл(КаталогСохранения + ИмяФайла + ".xml", "UTF-8");
		Исключение
			ОписаниеОшибки = "Не удалось сохранить файл печати в каталоге: " + КаталогСохранения + " по причине: " + ОписаниеОшибки();
			Возврат;
		КонецПопытки;
	Иначе
		ЗаписьXML.УстановитьСтроку("UTF-8");
	КонецЕсли;
		
	ЗаписьXML.ЗаписатьОбъявлениеXML();	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("PrintData");
	
	ЗаписатьЭлементXML(ЗаписьXML, "PrinterName", СтрокиРеквизитов[0].ИмяПринтера);
	ЗаписатьЭлементXML(ЗаписьXML, "TemplateName", СтрокиРеквизитов[0].ИмяШаблона);
	ЗаписатьЭлементXML(ЗаписьXML, "Count", СтрокиРеквизитов[0].КоличествоКопий*Count);		
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Head");	
	
	ЗаписатьЭлементXML(ЗаписьXML, "ArtName", ЧистаяСтрока(лТовар.Наименование + " " + лХарактеристика.Наименование));
	
	Barcode = СтрЗаменить(Barcode, "[GS1_EAN]", "");
	Barcode = СтрЗаменить(Barcode, "[GS1_DMX]", "");
	
	Если ЗначениеЗаполнено(СтруктураParams.GS1) И (Лев(СтруктураParams.GS1,4) = "(01)" или Лев(СтруктураParams.GS1,4) = "[01]") Тогда
		лШтрихкод = Сред(СтруктураParams.GS1, 6, 13);	
	Иначе	
		лШтрихкод = Barcode;
	КонецЕсли;
	
	Если стрДлина(Barcode) = 5 Тогда
		лШтрихкодВесовой = "";
		Попытка
			ПрефиксВесовогоТовара = Константы.ПрефиксВесовогоШтрихкода.Получить(); 
			ВесовойШкБезКС = "2" + ПрефиксВесовогоТовара + Barcode + "00000";
			лШтрихкодВесовой = ВесовойШкБезКС + КонтрольныйСимволEAN(ВесовойШкБезКС, 13);
		Исключение 
		КонецПопытки;
	КонецЕсли;	
	ЗаписатьЭлементXML(ЗаписьXML, "Barcode", ЧистаяСтрока(лШтрихкод));
			

	Если ЗначениеЗаполнено(СтруктураParams.barcode_full) Тогда
		
		BarcodeGS1 = СтруктураParams.barcode_full; 
		BarcodeGS1 = СтрЗаменить(BarcodeGS1, "[GS1_EAN]", "");
		BarcodeGS1 = СтрЗаменить(BarcodeGS1, "[GS1_DMX]", "");

	Иначе	
		BarcodeGS1 = Barcode;
	КонецЕсли;	
	
	ЗаписатьЭлементXML(ЗаписьXML, "BarcodeGS1", BarcodeGS1);
		
	ЗапросШК = Новый Запрос;
	ЗапросШК.УстановитьПараметр("Номенклатура", лТовар);
	ЗапросШК.УстановитьПараметр("Штрихкод", лШтрихкод);
	
	ЗапросШК.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЕСТЬNULL(ВЫБОР КОГДА ЕСТЬNULL(Штрихкоды.Упаковка.Числитель,1) = 0 ТОГДА 1 ИНАЧЕ ЕСТЬNULL(Штрихкоды.Упаковка.Числитель,1) КОНЕЦ/ 
	|	         ВЫБОР КОГДА ЕСТЬNULL(Штрихкоды.Упаковка.Знаменатель,1) = 0 ТОГДА 1 ИНАЧЕ ЕСТЬNULL(Штрихкоды.Упаковка.Знаменатель,1) КОНЕЦ, 1) КАК КФ,
	|	Штрихкоды.Упаковка.Наименование КАК Наименование,
	|	Штрихкоды.Упаковка КАК УпаковкаСсылка
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК Штрихкоды
	|ГДЕ
	|	Штрихкоды.Номенклатура = &Номенклатура
	|	И Штрихкоды.Штрихкод = &Штрихкод";
	
	Выборка = ЗапросШк.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		лMeasure = Выборка.Наименование;
		лKf = Выборка.КФ;
		УпаковкаСсылка = Выборка.УпаковкаСсылка;
	Иначе
		лMeasure = лТовар.ЕдиницаИзмерения.Наименование;
		лKf = 1;
		УпаковкаСсылка = Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка();
	КонецЕсли;
	
	ЗаписатьЭлементXML(ЗаписьXML, "Measure", ЧистаяСтрока(лMeasure));
	ЗаписатьЭлементXML(ЗаписьXML, "Kf", ЧистаяСтрока(лKf));
		
	ТекущаяЦена = ПолучитьЦенуТовара(лТовар, лХарактеристика, УзелПО.ТипЦен, УпаковкаСсылка);	
	ЗаписатьЭлементXML(ЗаписьXML, "Price", ЧистаяСтрока(ТекущаяЦена));
	
	//Штрихкод для проверки ценников
	//b,2000000052663,price,0100250,50
	Если ТекущаяЦена < 0 Тогда
		ТекущаяЦена = 0;
	КонецЕсли;	
	ТекущаяЦенаРубли = Формат(Цел(ТекущаяЦена), "ЧЦ=7; ЧН=0000000; ЧВН=; ЧГ=");
	ТекущаяЦенаКопейки = Формат((ТекущаяЦена - ТекущаяЦенаРубли) * 100, "ЧЦ=2; ЧН=00; ЧВН=; ЧГ=");
	ТекущийBarcode = лШтрихкод;
	Если СтрДлина(ТекущийBarcode) > 13 Тогда
		ТекущийBarcode = Лев(ТекущийBarcode, 13);
	ИначеЕсли СтрДлина(ТекущийBarcode) < 13 Тогда
		ТекущийBarcode = ДобавитьЛидирующиеНули(ТекущийBarcode, 13);
	КонецЕсли;	
	ЗаписатьЭлементXML(ЗаписьXML, "CheckBarcode", ЧистаяСтрока("b," + ТекущийBarcode + ",price," + ТекущаяЦенаРубли + "," + ТекущаяЦенаКопейки)); 		
		
	Атрибуты = ПолучитьАтрибуты(УзелПО);
	
	Для сч = 1 По 10 Цикл
		
		ИмяАтрибута = Атрибуты["ИмяАтрибута" + сч];
		Попытка
			ЗначениеАтрибута = ПолучитьЗначениеАтрибута(УзелПО,лТовар,лХарактеристика,ИмяАтрибута);
		Исключение
			ЗначениеАтрибута = "";
		КонецПопытки;	
		
		ЗаписатьЭлементXML(ЗаписьXML, "Attr" + сч, ЧистаяСтрока(ЗначениеАтрибута));
		
	КонецЦикла;
		
	ЗаписатьЭлементXML(ЗаписьXML, "QtyInt", ЧистаяСтрока(СтруктураParams.QtyInt));
	ЗаписатьЭлементXML(ЗаписьXML, "QtyFrac", ЧистаяСтрока(СтруктураParams.QtyFrac));
	ЗаписатьЭлементXML(ЗаписьXML, "ArtSN", ЧистаяСтрока(СтруктураParams.snValues));
	ЗаписатьЭлементXML(ЗаписьXML, "MeasureName", ЧистаяСтрока(СтруктураParams.MeasureName));
			
	ЗаписьXML.ЗаписатьКонецЭлемента();//Head
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Detail");		
	ЗаписьXML.ЗаписатьКонецЭлемента();//Detail
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Footer");
	ЗаписьXML.ЗаписатьКонецЭлемента();//Footer
	
	ЗаписьXML.ЗаписатьКонецЭлемента();//PrintData
	
	Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
		ЗаписьXML.Закрыть();
	Иначе
		СтрокаДляЗапроса = ЗаписьXML.Закрыть();
		ОтправитьДанныеНаПринтсервер(УзелПО, СтрокаДляЗапроса, ОписаниеОшибки);
	КонецЕсли;
	
КонецПроцедуры

Функция ДобавитьЛидирующиеНули(Строка, НужнаяДлина)
	
	СтрокаБезНулей = Строка;
	Пока СтрДлина(СтрокаБезНулей) < НужнаяДлина Цикл
		СтрокаБезНулей = "0" + СтрокаБезНулей;	
	КонецЦикла;	
	
	Возврат СтрокаБезНулей;
	
КонецФункции	

//Печать этикеток маркируемых товаров (обувь).
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// лТовар - СправочникСсылка.Номенклатура - Товар.
// лХарактеристика - СправочникСсылка.ХарактеристикиНоменклатуры - Характеристика.
// Barcode - Строка - Штрихкод.
// Count - Число - Количество этикеток.
// СтруктураParams - Структура - Структура дополнительных данных.
// ОписаниеОшибки - Строка - Описание ошибки (по умолчанию - пустая строка).
// 
Процедура ВыполнитьПечатьКодовМаркировкиОбувь(УзелПО, лТовар, лХарактеристика, Barcode, Count, СтруктураParams, ОписаниеОшибки)
	
	Попытка КоличествоКМ = Число(СтруктураParams.QtyInt); Исключение КоличествоКМ = 1; КонецПопытки;
	
	КоличествоКопийКаждогоКМ = Count;
	МассивСвободныхКодовМаркировки = ДатаМобайл_Маркировка.ПолучитьСвободныеКодыМаркировки(КоличествоКМ, лТовар, лХарактеристика);
	
	Если МассивСвободныхКодовМаркировки.Количество() = 0 Тогда		
		ОписаниеОшибки = "Не найдены свободные коды маркировки для " + лТовар.Наименование;
		Возврат;
	ИначеЕсли МассивСвободныхКодовМаркировки.Количество() < КоличествоКМ Тогда		
		ОписаниеОшибки = "Не хватает " + Строка(КоличествоКМ - МассивСвободныхКодовМаркировки.Количество()) + " свободных кодов маркировки для " + лТовар.Наименование;
		Возврат;
	КонецЕсли;
	
	ПорядковыйНомер = 0;
	
	Для каждого СвободныйКодМаркировки Из МассивСвободныхКодовМаркировки Цикл
		
		ПорядковыйНомер = ПорядковыйНомер + 1;					
		ЗаполнитьИЗакрытьФайлПечатиСвободногоКодаМаркировки(УзелПО, лТовар, лХарактеристика, Barcode, СвободныйКодМаркировки, ПорядковыйНомер, КоличествоКопийКаждогоКМ, ОписаниеОшибки);
		ДатаМобайл_Маркировка.УстановитьДатуПечатиДляКМ(СвободныйКодМаркировки);
		
	КонецЦикла;
	
КонецПроцедуры

//Формирование файла печати свободного кода маркировки.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// лТовар - СправочникСсылка.Номенклатура - Товар.
// лХарактеристика - СправочникСсылка.ХарактеристикиНоменклатуры - Характеристика.
// Barcode - Строка - Штрихкод.    
// СвободныйКодМаркировки - Строка - Свободный код маркировки. 
// ПорядковыйНомер - Число - Порядковый номер. 
// КоличествоКопийКаждогоКМ - Число - Количество копий каждого КМ.
// ОписаниеОшибки - Строка - Описание ошибки (по умолчанию - пустая строка). 
// 
Процедура ЗаполнитьИЗакрытьФайлПечатиСвободногоКодаМаркировки(УзелПО, лТовар, лХарактеристика, Barcode, СвободныйКодМаркировки, ПорядковыйНомер, КоличествоКопийКаждогоКМ, ОписаниеОшибки)
	
	КаталогСохранения = УзелПО.КаталогВыгрузкиФайлаПечати;
	
	СтруктураПоиска = Новый Структура("ТипОперации", "Печать этикетки маркировка");
	СтрокиРеквизитов = УзелПО.Печать.НайтиСтроки(СтруктураПоиска);
	Если СтрокиРеквизитов.Количество() = 0 Тогда
		ОписаниеОшибки = "В обработке АРМ для терминала не указан шаблон печати этикеток маркированного товара. ";
		Возврат;
	КонецЕсли;
	
	ИзвлеченныйКодМаркировки = ДатаМобайл_Маркировка.Base64ВШтрихкод(СвободныйКодМаркировки.ПолныйКод);
	
	ЗаписьXML = Новый ЗаписьXML;	
	Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
		ИмяФайла = ПолучитьНовоеИмяФайла(ПорядковыйНомер);
		Попытка
			ЗаписьXML.ОткрытьФайл(КаталогСохранения + ИмяФайла + ".xml", "UTF-8");
		Исключение
			ОписаниеОшибки = "Не удалось сохранить файл печати в каталоге: " + КаталогСохранения + " по причине: " + ОписаниеОшибки();
			Возврат;
		КонецПопытки;
	Иначе
		ЗаписьXML.УстановитьСтроку("UTF-8");
	КонецЕсли;	
	
	ЗаписьXML.ЗаписатьОбъявлениеXML();
	ЗаписьXML.ЗаписатьНачалоЭлемента("PrintData");
	
	ЗаписатьЭлементXML(ЗаписьXML, "PrinterName", СтрокиРеквизитов[0].ИмяПринтера);
	ЗаписатьЭлементXML(ЗаписьXML, "TemplateName", СтрокиРеквизитов[0].ИмяШаблона);
	
	КоличествоКопийКаждогоКМ = ?(СтрокиРеквизитов[0].КоличествоКопий = 0, КоличествоКопийКаждогоКМ, СтрокиРеквизитов[0].КоличествоКопий * КоличествоКопийКаждогоКМ); 
	ЗаписатьЭлементXML(ЗаписьXML, "Count", КоличествоКопийКаждогоКМ);
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Head");
	
	КодМаркировкиДляПечати = СтрЗаменить(ИзвлеченныйКодМаркировки, Символ(29), "~d029");
	КодМаркировкиДляПечати = "~d029" + КодМаркировкиДляПечати;
	КодМаркировкиБезFNC = СтрЗаменить(ИзвлеченныйКодМаркировки, Символ(29), "");
	
	ЗаписатьЭлементXML(ЗаписьXML, "ArtName", ЧистаяСтрока(лТовар.Наименование));
	ЗаписатьЭлементXML(ЗаписьXML, "Barcode", ЧистаяСтрока(Barcode));
	ЗаписатьЭлементXML(ЗаписьXML, "DmxBarcodePrint", КодМаркировкиДляПечати);
	ЗаписатьЭлементXML(ЗаписьXML, "DmxBarcode", КодМаркировкиБезFNC);
	ЗаписатьЭлементXML(ЗаписьXML, "GTIN", Сред(ИзвлеченныйКодМаркировки, 3, 14));
	ЗаписатьЭлементXML(ЗаписьXML, "SN", Сред(ИзвлеченныйКодМаркировки, 19, 13));
	
	ТекущаяЦена = ПолучитьЦенуТовара(лТовар, лХарактеристика, УзелПО.ТипЦен);	
	ЗаписатьЭлементXML(ЗаписьXML, "Price", ЧистаяСтрока(ТекущаяЦена));					
	
	Атрибуты = ПолучитьАтрибуты(УзелПО);
	
	Для сч = 1 По 10 Цикл
				
		ИмяАтрибута = Атрибуты["ИмяАтрибута" + сч];
		Попытка	
			ЗначениеАтрибута = ПолучитьЗначениеАтрибута(УзелПО,лТовар,лХарактеристика,ИмяАтрибута);
		Исключение
			ЗначениеАтрибута = "";
		КонецПопытки;	
		ЗаписатьЭлементXML(ЗаписьXML, "Attr" + сч, ЧистаяСтрока(ЗначениеАтрибута));
		
	КонецЦикла;
	
	ЗаписьXML.ЗаписатьКонецЭлемента();//Head
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Detail");
	ЗаписьXML.ЗаписатьКонецЭлемента();//Detail
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Footer");
	ЗаписьXML.ЗаписатьКонецЭлемента();//Footer
	
	ЗаписьXML.ЗаписатьКонецЭлемента();//PrintData
	
	Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
		ЗаписьXML.Закрыть();
	Иначе
		СтрокаДляЗапроса = ЗаписьXML.Закрыть();
		ОтправитьДанныеНаПринтсервер(УзелПО, СтрокаДляЗапроса, ОписаниеОшибки);
	КонецЕсли;
		
	СтруктураТовара = Новый Структура("Номенклатура, Характеристика", лТовар, лХарактеристика);
	Шаблон = Справочники.ДатаМобайл_ШаблоныДокументов.ПустаяСсылка();
	ДатаМобайл_Маркировка.ПолучитьСправочникСсылкаМарка(Сред(ИзвлеченныйКодМаркировки, 1, 31), 31, "", "", Истина, СтруктураТовара,Шаблон);
	
КонецПроцедуры

//Получение значения атрибута.
//
// Параметры: 
// лТовар - СправочникСсылка.Номенклатура - Товар.
// ИмяАтрибута - Строка - Имя атрибута. 
//
// Возвращаемое значение:
//   Строка со значением атрибута.
//
Функция ПолучитьЗначениеАтрибута(УзелПО, лТовар, лХарактеристика, ИмяАтрибута)
	
	Если ИмяАтрибута <> "" тогда 
		
		Если ИмяАтрибута = "!!! Ячейки !!!" Или ИмяАтрибута = "!!! Основная ячейка !!!" Или ИмяАтрибута = "!!! Дополнительные ячейки !!!" Тогда
			ЗначениеАтрибута = ПолучитьСправочныеЯчейкиТовара(УзелПО, лТовар, ИмяАтрибута);	
		ИначеЕсли ИмяАтрибута = "!!! Характеристики !!!" Тогда
        	ЗначениеАтрибута = ЧистаяСтрока(лХарактеристика.Наименование);
		ИначеЕсли Лев(ИмяАтрибута, 3) = "ДР_" Тогда 
			Попытка ЗначениеАтрибута = ПолучитьДополнительныйРеквизитАтрибута(лТовар, ИмяАтрибута); Исключение КонецПопытки;
		Иначе 
			ЗначениеАтрибута = ЧистаяСтрока(лТовар[ИмяАтрибута]);
		КонецЕсли;	
		
	Иначе 
		ЗначениеАтрибута = "";
	КонецЕсли;
	
	Возврат ЗначениеАтрибута;
	
КонецФункции // ()

//Получение нового имени файла.
//
// Параметры: 
// ПорядковыйНомер - Число - Порядковый номер.
//
// Возвращаемое значение:
//   Строка с новыми именем файлом.
//
Функция ПолучитьНовоеИмяФайла(ПорядковыйНомер = 0)
	
	ИмяФайла = СтрЗаменить(ТекущаяДата(), ":", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, ".", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, " ", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, "/", "");
	ИмяФайла = СтрЗаменить(ИмяФайла, "\", "");
	
	Генератор = Новый ГенераторСлучайныхЧисел(1);
	ИдентификаторФайла = Генератор.СлучайноеЧисло(1, 1000);
	
	ИмяФайла = ИмяФайла + ИдентификаторФайла + ПорядковыйНомер;
	
	Возврат ИмяФайла;
	
КонецФункции // ()

//Запись элемента XML.
//
// Параметры: 
// ЗаписьXML - ЗаписьXML - Запись XML. 
// ИмяЭлемента - Строка - Имя элемента.
// ТекстЭлемента - Строка - Текст элемента.
//
Процедура ЗаписатьЭлементXML(ЗаписьXML, ИмяЭлемента, ТекстЭлемента) 
	
	Попытка 
		ТекстЭлементаНаПечть = Строка(ТекстЭлемента);
	Исключение
		ТекстЭлементаНаПечть = "";
	КонецПопытки;
	
	ЗаписьXML.ЗаписатьНачалоЭлемента(ИмяЭлемента);
	ЗаписьXML.ЗаписатьТекст(ТекстЭлементаНаПечть);
	ЗаписьXML.ЗаписатьКонецЭлемента();	
	
КонецПроцедуры

//Отправка данных на принтсервер.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД. 
// СтрокаДляЗапроса - Строка - Строка для запроса.
// ТекстОшибки - Строка - Описание ошибки (по умолчанию - пустая строка).
//
Процедура ОтправитьДанныеНаПринтсервер(УзелПО, СтрокаДляЗапроса, ТекстОшибки);
	
	АдресПринтсервера = УзелПО.АдресПринтсервера;
	ПортПринтсервера = УзелПО.ПортПринтсервера;
	
	Соединение = Новый HTTPСоединение(АдресПринтсервера, ПортПринтсервера,,,, 1,);
	
	РесурсНаСервере = "/printFile/";
	HTTPЗапрос = Новый HTTPЗапрос(РесурсНаСервере);
	HTTPЗапрос.Заголовки.Вставить("Content-type", "application/xml");
	HTTPЗапрос.УстановитьТелоИзСтроки(СтрокаДляЗапроса, КодировкаТекста.UTF8, ИспользованиеByteOrderMark.НеИспользовать);
	
	ЕстьОшибка = Ложь;
	
	Попытка 
		Результат = Соединение.ОтправитьДляОбработки(HTTPЗапрос);
	Исключение
		ЕстьОшибка = Истина;
		ТекстОшибки = "Ошибка онлайн соединения c сервером печати, проверьте настройки.";
	КонецПопытки;
	
	Соединение = Неопределено;
	
	Если ЕстьОшибка Тогда
	Иначе
		ТекстСообщения  = "" + Результат.КодСостояния +  " " + Результат.ПолучитьТелоКакСтроку();
		Если СтрНайти(Результат.ПолучитьТелоКакСтроку(), "File Uploaded") > 0 Тогда
			//Успешная отправка данных
		Иначе
			ЕстьОшибка = Истина;
			ТекстОшибки = "Ошибка отправки данных на печать: " + ТекстСообщения + ", проверьте настройки.";
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область FastAccess

//3.0

//Получение информации о товаре в формате JSON.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД. 
// Barcode - Строка - Штрихкод.
// 
// Возвращаемое значение:
//   JSON с массивом данных.
//
Функция ПолучитьИнфоJSON(УзелПО, Barcode) 
	
	ВесовойШК = "";
	
	МассивШК = Новый Массив;
	МассивШК.Добавить(Barcode);
	Если ЗначениеЗаполнено(Barcode) Тогда
		ПростойФорматВесовыхШтрихкодов = УзелПО.ПростойФорматВесовыхШтрихкодов;   
		Если СтрДлина(Barcode) = 5 И Не ПростойФорматВесовыхШтрихкодов Тогда
			ВесовойШК = "2_" + Barcode + "00000_";	
			МассивШК.Добавить(ВесовойШК);
		КонецЕсли;		 
	КонецЕсли;	
	
	Если СтрДлина(Barcode) = 20 И Лев(Barcode,2) = "00" Тогда					 
		Barcode2 = "(00)" + Сред(Barcode, 3, 18);
		МассивШК.Добавить(Barcode2);
	ИначеЕсли СтрДлина(Barcode) = 22 И Лев(Barcode,2) = "(00)" Тогда					 
		Barcode2 = "00" + Сред(Barcode, 5, 18);	
		МассивШК.Добавить(Barcode2);
	КонецЕсли; 
	
	МассивОтвета = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	///////////////	
	//МАРКИ ЕГАИС//
	///////////////
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьЕГАИС() И (СтрДлина(Barcode) = 68 Или СтрДлина(Barcode) = 150) Тогда 
		
		СтруктураМарка = Новый Структура;
		СтруктураМарка.Вставить("title","Акцизная марка "+ Символы.ПС + Barcode);
		
		ИнфоПоМарке = "";
		ДанныеПомарке = ПолучитьСостояниеАкцизнойМарки(Barcode);
		Если ДанныеПомарке <> Неопределено Тогда
			ИнфоПоМарке = ИнфоПоМарке + ДанныеПомарке.АлкогольнаяПродукция.Наименование;
			Если ЗначениеЗаполнено(ДанныеПомарке.СправкаБ) Тогда
				ИнфоПоМарке = ИнфоПоМарке + Символы.ПС + "СправкаБ: " + ДанныеПомарке.СправкаБ;
			КонецЕсли;
			Если ЗначениеЗаполнено(ДанныеПомарке.Статус) Тогда
				ИнфоПоМарке = ИнфоПоМарке + Символы.ПС + "Статус: " + ДанныеПомарке.Статус;
			КонецЕсли;
			
		Иначе
			ИнфоПоМарке = "НЕ ЧИСЛИТСЯ В СИСТЕМЕ!!!";
		КонецЕсли; 
		
		СтруктураИнфоПоМарке = Новый Структура;
		СтруктураИнфоПоМарке.Вставить("title", ИнфоПоМарке);
		СтруктураИнфоПоМарке.Вставить("value", "");
		СтруктураИнфоПоМарке.Вставить("content", Новый Массив);
		
		СтруктураМарка.content.Добавить(СтруктураИнфоПоМарке);		
				
		МассивОтвета.Добавить(СтруктураМарка);
		
		Возврат ПодготовитьОтветJSON(МассивОтвета,, "application/json");
		
	КонецЕсли;	
	
	//////////	
	//ЯЧЕЙКИ//
	//////////
	
	ТекущаяЯчейка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(Barcode);
	ВключатьАртикул = УзелПО.ДобавлятьАртикулВНаименование;
	ИспользоватьАртикулКакШтрихкодТовара = УзелПО.ИспользоватьАртикулКакШтрихкодТовара;
	ВыводитьВсеХарактеристикиПоШтрихкоду = УзелПО.ВыводитьВсеХарактеристикиПоШтрихкоду;
	
	ЗапросПоискЯчейки = Новый Запрос;
	ЗапросПоискЯчейки.УстановитьПараметр("ТекущаяЯчейка", ТекущаяЯчейка);	
	ЗапросПоискЯчейки.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
	|	СкладскиеЯчейки.Ссылка КАК Ячейка
	|ИЗ
	|	Справочник.СкладскиеЯчейки КАК СкладскиеЯчейки
	|ГДЕ
	|	СкладскиеЯчейки.Ссылка = &ТекущаяЯчейка";
	
	ВыборкаРезультатПоискаЯчейки = ЗапросПоискЯчейки.Выполнить().Выбрать();
	Если ЗначениеЗаполнено(ТекущаяЯчейка) И ВыборкаРезультатПоискаЯчейки.Следующий() Тогда
		
		НазваниеЯчейки = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0, ЧистаяСтрока(ТекущаяЯчейка.Наименование), ТекущаяЯчейка.Код);
		НазваниеЯчейки = "Ячейка: " + ЧистаяСтрока(НазваниеЯчейки);
		
		НазваниеСклада = "Склад: " + ЧистаяСтрока(ТекущаяЯчейка.Владелец.Наименование);	
		Если ЗначениеЗаполнено(ТекущаяЯчейка.Помещение) Тогда
			НазваниеПомещения = "Помещение: " + ЧистаяСтрока(ТекущаяЯчейка.Помещение.Наименование);
			НазваниеСклада = НазваниеСклада + Символы.ПС + НазваниеПомещения;
		КонецЕсли;
		
		СтруктураЯчейки = Новый Структура;
		СтруктураЯчейки.Вставить("title", НазваниеЯчейки);
		СтруктураЯчейки.Вставить("value", НазваниеСклада);
		СтруктураЯчейки.Вставить("content", Новый Массив);
		
		//Ищем остатки по ячейке
		ЗапросОстатков = Новый Запрос;
		ЗапросОстатков.УстановитьПараметр("ТекущаяЯчейка", ТекущаяЯчейка);
		ЗапросОстатков.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ТоварыВЯчейкахОстатки.Номенклатура КАК Номенклатура,
		|	ТоварыВЯчейкахОстатки.Характеристика КАК Характеристика,
		|	ТоварыВЯчейкахОстатки.Серия КАК Серия,
		|	ТоварыВЯчейкахОстатки.Упаковка КАК Упаковка,
		|	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток) - СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) КАК КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.ТоварыВЯчейках.Остатки(, Ячейка = &ТекущаяЯчейка) КАК ТоварыВЯчейкахОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	ТоварыВЯчейкахОстатки.Номенклатура,
		|	ТоварыВЯчейкахОстатки.Характеристика,
		|	ТоварыВЯчейкахОстатки.Серия,
		|	ТоварыВЯчейкахОстатки.Упаковка
		|
		|ИМЕЮЩИЕ
		|	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток) - СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) <> 0
		|
		|УПОРЯДОЧИТЬ ПО
		|	ТоварыВЯчейкахОстатки.Номенклатура,
		|	ТоварыВЯчейкахОстатки.Характеристика,
		|	ТоварыВЯчейкахОстатки.Серия,
		|	ТоварыВЯчейкахОстатки.Упаковка
		|ИТОГИ
		|	СУММА(КоличествоОстаток)
		|ПО
		|	Номенклатура,
		|	Характеристика,
		|	Серия,
		|	Упаковка";
		
		ВыборкаПоТоварам = ЗапросОстатков.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);		
		Пока ВыборкаПоТоварам.Следующий() Цикл
			ВыборкаПоХарактеристикам = ВыборкаПоТоварам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);		
			Пока ВыборкаПоХарактеристикам.Следующий() Цикл
				
				НазваниеТовара = "Товар: " + ?(ВключатьАртикул, ВыборкаПоТоварам.Номенклатура.Артикул + " ", "")
				+ ЧистаяСтрока(ВыборкаПоТоварам.Номенклатура.Наименование) + " "
				+ ЧистаяСтрока(ВыборкаПоХарактеристикам.Характеристика.Наименование);
				
				ДополнительнаяИнформация = ПолучитьДополнительнуюИнформациюПоТоваруДляБыстрогоДоступа(УзелПО,ВыборкаПоТоварам.Номенклатура,ВыборкаПоХарактеристикам.Характеристика);

				СтруктураТовары = Новый Структура;
				СтруктураТовары.Вставить("title"  , НазваниеТовара+Символы.ПС+ДополнительнаяИнформация);
				СтруктураТовары.Вставить("value"  , "");
				СтруктураТовары.Вставить("content", Новый Массив);
				
				ВыборкаПоСериям = ВыборкаПоХарактеристикам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);	
				Пока ВыборкаПоСериям.Следующий() Цикл
					
					ВыборкаПоУпаковкам = ВыборкаПоСериям.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);	
					Пока ВыборкаПоУпаковкам.Следующий() Цикл
						
						НазваниеСерии = "";
						Если ЗначениеЗаполнено(ВыборкаПоСериям.Серия) Тогда
							НазваниеСерии = "Серия: " + ЧистаяСтрока(ВыборкаПоСериям.Серия.Наименование);
						КонецЕсли;
						СтрокаОстаток = "" + ВыборкаПоУпаковкам.КоличествоОстаток + " " + ЧистаяСтрока(ВыборкаПоУпаковкам.Упаковка.Наименование);
						
						СтруктураОстатки = Новый Структура;
						СтруктураОстатки.Вставить("title", НазваниеСерии);
						СтруктураОстатки.Вставить("value", СтрокаОстаток);
						
						СтруктураТовары.content.Добавить(СтруктураОстатки);
					КонецЦикла;
				КонецЦикла;
				
				//добавляем только если есть строки
				Если СтруктураТовары.content.Количество() > 0 Тогда
					//если одна строка и нет разбивки, то для красоты выводим данные на уровне выше    
					Если СтруктураТовары.content.Количество() = 1 И СтруктураТовары.content[0].title = "" Тогда	
						СтруктураТовары.value = СтруктураТовары.content[0].value;
						СтруктураТовары.content = Новый Массив;
					КонецЕсли;
					СтруктураЯчейки.content.Добавить(СтруктураТовары);
				КонецЕсли;
				
			КонецЦикла;					
		КонецЦикла;	
		
		Если СтруктураЯчейки.content.Количество() = 0 Тогда 
			СтруктураТовары = Новый Структура;
			СтруктураТовары.Вставить("title", "Остатков не числится...");
			СтруктураТовары.Вставить("value", "");
			СтруктураТовары.Вставить("content", Новый Массив);
			
			СтруктураЯчейки.content.Добавить(СтруктураТовары);		
		КонецЕсли;
		
		МассивОтвета.Добавить(СтруктураЯчейки);
		
		Возврат ПодготовитьОтветJSON(МассивОтвета,, "application/json");
		
	КонецЕсли;
		
	//////////	
	//ТОВАРЫ//
	//////////
	
	ЗапросПоискТовара = Новый Запрос;
	ЗапросПоискТовара.УстановитьПараметр("Barcode", Barcode); 
	ЗапросПоискТовара.УстановитьПараметр("МассивШК", МассивШК);
	ЗапросПоискТовара.УстановитьПараметр("ИспользоватьАртикулКакШтрихкодТовара", ИспользоватьАртикулКакШтрихкодТовара); 
	
	Если ВыводитьВсеХарактеристикиПоШтрихкоду тогда
		НайденнаяНоменклатура = НайтиНоменклатуруПоШтрихкодуДляБыстрогоДоступа(МассивШК);
		ЗапросПоискТовара.УстановитьПараметр("НайденнаяНоменклатура", НайденнаяНоменклатура);
	Иначе		
		ЗапросПоискТовара.УстановитьПараметр("НайденнаяНоменклатура", Неопределено); 	
	КонецЕсли;
		
	
	ЗапросПоискТовара.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
	|	ШтрихкодыНоменклатуры.Характеристика КАК Характеристика
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|ГДЕ
	|	ШтрихкодыНоменклатуры.Штрихкод В (&МассивШК)
	|	И ШтрихкодыНоменклатуры.Номенклатура ССЫЛКА Справочник.Номенклатура
	|	И НЕ ШтрихкодыНоменклатуры.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|
	//ВЫБОРКА ССЫЛОК ТОВАРОВ И ХАРАКТЕРИСТИК ПО РАЗНЫМ УСЛОВИЯМ ВЕДЕНИЯ ХАРАКТЕРИСТИК ПРИ ИспользоватьАртикулКакШтрихкодТовара 
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	//БЕЗ ХАРАКТЕРИСТИК
	|	Номенклатура.Ссылка КАК Номенклатура,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка) КАК Характеристика
	|ИЗ
	| 	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	((&ИспользоватьАртикулКакШтрихкодТовара И Номенклатура.Артикул = &Barcode) ИЛИ Номенклатура.Ссылка = &НайденнаяНоменклатура)
	|	И НЕ Номенклатура.ЭтоГруппа
	|	И НЕ Номенклатура.ПометкаУдаления
	|
	|ОБЪЕДИНИТЬ
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	//ИНДИВИДУАЛЬНЫЕ ХАРАКТЕРИСТИКИ
	|	Номенклатура.Ссылка КАК Номенклатура,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
	|ИЗ
	| 	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка
	|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры)
	|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|ГДЕ
	|	((&ИспользоватьАртикулКакШтрихкодТовара И Номенклатура.Артикул = &Barcode) ИЛИ Номенклатура.Ссылка = &НайденнаяНоменклатура)
	|	И НЕ Номенклатура.ЭтоГруппа
	|	И НЕ Номенклатура.ПометкаУдаления
	|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	//ОБЩИЕ ХАРАКТЕРИСТИКИ
	|	Номенклатура.Ссылка КАК Номенклатура,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВидНоменклатуры
	|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры)
	|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|ГДЕ
	|	((&ИспользоватьАртикулКакШтрихкодТовара И Номенклатура.Артикул = &Barcode) ИЛИ Номенклатура.Ссылка = &НайденнаяНоменклатура)
	|	И НЕ Номенклатура.ЭтоГруппа
	|	И НЕ Номенклатура.ПометкаУдаления 
	|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	//ОБЩИЕ С ДРУГИМ ВИДОМ ХАРАКТЕРИСТИКИ
	|	Номенклатура.Ссылка КАК Номенклатура,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВладелецХарактеристик
	|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры)
	|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|ГДЕ
	|	((&ИспользоватьАртикулКакШтрихкодТовара И Номенклатура.Артикул = &Barcode) ИЛИ Номенклатура.Ссылка = &НайденнаяНоменклатура)
	|	И НЕ Номенклатура.ЭтоГруппа
	|	И НЕ Номенклатура.ПометкаУдаления
	|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL";
	
	ВыборкаРезультатПоискаТовара = ЗапросПоискТовара.Выполнить().Выбрать();
	
	//Попробуем найти товар по КМ или GTIN КМ
	Если ВыборкаРезультатПоискаТовара.Количество() = 0 И стрДлина(Barcode) > 30 Тогда		
		Если ДатаМобайл_ОбщийМодуль.ЕстьМаркировка() Тогда 
			
			КМ = Лев(Barcode, 31);
			ЗначениеШтрихкода = "(01)" + Сред(КМ, 3, 14) + "(21)" + Сред(КМ, 19, 13);
			ЗначениеШтрихкодаДляЗапроса = "" + ЗначениеШтрихкода;
			ЗначениеШтрихкодаДляЗапроса = СтрЗаменить(ЗначениеШтрихкодаДляЗапроса, "_", "$_");
			ЗначениеШтрихкодаДляЗапроса = СтрЗаменить(ЗначениеШтрихкодаДляЗапроса, "%", "$%");
			ЗначениеШтрихкодаДляЗапроса = ЗначениеШтрихкодаДляЗапроса + "%";
			
			ЗапросПоискТовара = Новый Запрос;
			ЗапросПоискТовара.УстановитьПараметр("ЗначениеШтрихкодаДляЗапроса", ЗначениеШтрихкодаДляЗапроса);
			ЗапросПоискТовара.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	ШтрихкодыУпаковокТоваров.Номенклатура КАК Номенклатура,
			|	ШтрихкодыУпаковокТоваров.Характеристика КАК Характеристика
			|ИЗ
			|	Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
			|ГДЕ
			|	ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода ПОДОБНО &ЗначениеШтрихкодаДляЗапроса СПЕЦСИМВОЛ ""$""
			|	И ШтрихкодыУпаковокТоваров.Номенклатура ССЫЛКА Справочник.Номенклатура
			|	И НЕ ШтрихкодыУпаковокТоваров.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)";
			
			ВыборкаРезультатПоискаТовара = ЗапросПоискТовара.Выполнить().Выбрать();
		КонецЕсли;	
		
		Если ВыборкаРезультатПоискаТовара.Количество() = 0 Тогда
			
			ТекущийШтрихкод = Сред(Barcode, 3, 14);
			ТекущийШтрихкод = УдалитьЛидирующиеНули(ТекущийШтрихкод);
			
			ЗапросПоискТовара = Новый Запрос;
			
			МассивШК.Очистить(); 
			МассивШК.Добавить(ТекущийШтрихкод);
			Если ЗначениеЗаполнено(ВесовойШК) Тогда
				МассивШК.Добавить(ВесовойШК);
			КонецЕсли;        	
			
			ЗапросПоискТовара.УстановитьПараметр("МассивШК", МассивШК);
			ЗапросПоискТовара.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
			|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
			|	ШтрихкодыНоменклатуры.Характеристика КАК Характеристика
			|ИЗ
			|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
			|ГДЕ
			|	ШтрихкодыНоменклатуры.Штрихкод В (&МассивШК)
			|	И ШтрихкодыНоменклатуры.Номенклатура ССЫЛКА Справочник.Номенклатура
			|	И НЕ ШтрихкодыНоменклатуры.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)";
			
			ВыборкаРезультатПоискаТовара = ЗапросПоискТовара.Выполнить().Выбрать();
			
		КонецЕсли;		
	КонецЕсли;		
	
	
	Если ВыборкаРезультатПоискаТовара.Количество() > 0 Тогда
		
		Пока ВыборкаРезультатПоискаТовара.Следующий() Цикл
			
			МассивАдресныхСкладов = Новый Массив;
			
			НазваниеТовара = "Товар: " + ?(ВключатьАртикул, ВыборкаРезультатПоискаТовара.Номенклатура.Артикул + " ", "")
			+ ВыборкаРезультатПоискаТовара.Номенклатура + " " 
			+ ВыборкаРезультатПоискаТовара.Характеристика;
									
			ДополнительнаяИнформация = ПолучитьДополнительнуюИнформациюПоТоваруДляБыстрогоДоступа(УзелПО,ВыборкаРезультатПоискаТовара.Номенклатура,ВыборкаРезультатПоискаТовара.Характеристика);
			
			СтруктураТовары = Новый Структура;
			СтруктураТовары.Вставить("title", НазваниеТовара);
			СтруктураТовары.Вставить("value", ДополнительнаяИнформация);
			СтруктураТовары.Вставить("content", Новый Массив);
			
			//Сначала ищем остатки по товару по адресному регистру...
			ЗапросОстатковАдресный = Новый Запрос;
			ЗапросОстатковАдресный.УстановитьПараметр("ТекущаяНоменклатура", ВыборкаРезультатПоискаТовара.Номенклатура);
			ЗапросОстатковАдресный.УстановитьПараметр("ТекущаяХарактеристика", ВыборкаРезультатПоискаТовара.Характеристика);
			
			СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
			ЗапросОстатковАдресный.УстановитьПараметр("Склады", СписокСкладов);
			ЗапросОстатковАдресный.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
			
			СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
			ЗапросОстатковАдресный.УстановитьПараметр("Помещения", СписокПомещений);
			ЗапросОстатковАдресный.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
			
			ЗапросОстатковАдресный.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	ТоварыВЯчейкахОстатки.Ячейка.Владелец КАК Склад,
			|	ТоварыВЯчейкахОстатки.Ячейка.Помещение КАК Помещение,
			|	ТоварыВЯчейкахОстатки.Ячейка КАК Ячейка,
			|	ТоварыВЯчейкахОстатки.Серия КАК Серия,
			|	ТоварыВЯчейкахОстатки.Упаковка КАК Упаковка,
			|	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток) - СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) КАК КоличествоОстаток
			|ИЗ
			| 	РегистрНакопления.ТоварыВЯчейках.Остатки(
			|   	,
			|   	Номенклатура = &ТекущаяНоменклатура
			|   	 И Характеристика = &ТекущаяХарактеристика) КАК ТоварыВЯчейкахОстатки
			|ГДЕ
			|   (&ВсеСклады ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Владелец В (&Склады))
			| 		И (&ВсеПомещения ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Помещение В (&Помещения))   
			|СГРУППИРОВАТЬ ПО
			|	ТоварыВЯчейкахОстатки.Ячейка.Владелец,
			|	ТоварыВЯчейкахОстатки.Ячейка.Помещение,
			|	ТоварыВЯчейкахОстатки.Ячейка,
			|	ТоварыВЯчейкахОстатки.Серия,
			|	ТоварыВЯчейкахОстатки.Упаковка
			|ИМЕЮЩИЕ
			| 	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток) - СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) <> 0 
			|УПОРЯДОЧИТЬ ПО
			|	ТоварыВЯчейкахОстатки.Ячейка.Владелец,
			|	ТоварыВЯчейкахОстатки.Ячейка.Помещение,
			|	ТоварыВЯчейкахОстатки.Ячейка,
			|	ТоварыВЯчейкахОстатки.Серия,
			|	ТоварыВЯчейкахОстатки.Упаковка
			|ИТОГИ
			|	СУММА(КоличествоОстаток)
			|ПО
			|	Склад,
			|	Помещение,
			|	Ячейка,
			|	Серия,
			|	Упаковка";
			
			ВыборкаПоСкладам = ЗапросОстатковАдресный.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаПоСкладам.Следующий() Цикл
				
				ВыборкаПоПомещениям = ВыборкаПоСкладам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
				Пока ВыборкаПоПомещениям.Следующий() Цикл
					
					НазваниеСклада = "Склад: " + ЧистаяСтрока(ВыборкаПоСкладам.Склад.Наименование);	
					Если ЗначениеЗаполнено(ВыборкаПоПомещениям.Помещение) Тогда
						НазваниеПомещения = "Помещение: " + ЧистаяСтрока(ВыборкаПоПомещениям.Помещение.Наименование);
						НазваниеСклада = НазваниеСклада + Символы.ПС + НазваниеПомещения;
					КонецЕсли;
					
					СтруктураСклады = Новый Структура;
					СтруктураСклады.Вставить("title"  , НазваниеСклада);
					СтруктураСклады.Вставить("value"  , "");
					СтруктураСклады.Вставить("content", Новый Массив);
					
					ВыборкаПоЯчейкам = ВыборкаПоПомещениям.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
					Пока ВыборкаПоЯчейкам.Следующий() Цикл
						
						НазваниеЯчейки = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0, ЧистаяСтрока(ВыборкаПоЯчейкам.Ячейка.Наименование), ВыборкаПоЯчейкам.Ячейка.Код);
						НазваниеЯчейки = "Ячейка: " + ЧистаяСтрока(НазваниеЯчейки);
						
						СтруктураЯчейки = Новый Структура;
						СтруктураЯчейки.Вставить("title"  , НазваниеЯчейки);
						СтруктураЯчейки.Вставить("value"  , "");
						СтруктураЯчейки.Вставить("content", Новый Массив);
						
						ВыборкаПоСериям = ВыборкаПоЯчейкам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
						Пока ВыборкаПоСериям.Следующий() Цикл
							
							ВыборкаПоУпаковкам = ВыборкаПоСериям.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
							Пока ВыборкаПоУпаковкам.Следующий() Цикл
								
								НазваниеСерии = "";
								Если ЗначениеЗаполнено(ВыборкаПоСериям.Серия) Тогда
									НазваниеСерии = "Серия: " + ЧистаяСтрока(ВыборкаПоСериям.Серия.Наименование);
								КонецЕсли;
								СтрокаОстаток = "" + ВыборкаПоУпаковкам.КоличествоОстаток + " " + ЧистаяСтрока(ВыборкаПоУпаковкам.Упаковка.Наименование); 
								
								СтруктураОстатки = Новый Структура;
								СтруктураОстатки.Вставить("title", НазваниеСерии);
								СтруктураОстатки.Вставить("value", СтрокаОстаток);
								
								СтруктураЯчейки.content.Добавить(СтруктураОстатки);									
								
							КонецЦикла;
						КонецЦикла;
						
						//добавляем только если есть строки
						Если СтруктураЯчейки.content.Количество() > 0 Тогда
							//если одна строка и нет разбивки, то для красоты выводим данные на уровне выше
							Если СтруктураЯчейки.content.Количество() = 1 И СтруктураЯчейки.content[0].title = "" Тогда	
								СтруктураЯчейки.value = СтруктураЯчейки.content[0].value;
								СтруктураЯчейки.content = Новый Массив;
							КонецЕсли;
							СтруктураСклады.content.Добавить(СтруктураЯчейки);
						КонецЕсли;
					КонецЦикла;			
					
					//добавляем только если есть строки
					Если СтруктураСклады.content.Количество() > 0 Тогда
						
						СтруктураТовары.content.Добавить(СтруктураСклады);
						Если МассивАдресныхСкладов.Найти(ВыборкаПоСкладам.Склад) = Неопределено Тогда
							МассивАдресныхСкладов.Добавить(ВыборкаПоСкладам.Склад);		
						КонецЕсли;
						
					КонецЕсли;
					
				КонецЦикла;					
			КонецЦикла;						
			
			//Затем ищем остатки по товару по обычному регистру на оставщихся складах, исключая адресные...
			ЗапросОстатков = Новый Запрос;
			ЗапросОстатков.УстановитьПараметр("ТекущаяНоменклатура", ВыборкаРезультатПоискаТовара.Номенклатура);
			ЗапросОстатков.УстановитьПараметр("ТекущаяХарактеристика", ВыборкаРезультатПоискаТовара.Характеристика);
			
			СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
			ЗапросОстатков.УстановитьПараметр("Склады", СписокСкладов);
			ЗапросОстатков.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
			
			СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
			ЗапросОстатков.УстановитьПараметр("Помещения", СписокПомещений);
			ЗапросОстатков.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
			
			ЗапросОстатков.УстановитьПараметр("МассивАдресныхСкладов", МассивАдресныхСкладов);
			
			ЗапросОстатков.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	ТоварыНаСкладахОстатки.Склад,
			|	ТоварыНаСкладахОстатки.Помещение КАК Помещение,
			|	ТоварыНаСкладахОстатки.Серия КАК Серия,
			|	СУММА(ТоварыНаСкладахОстатки.ВНаличииОстаток) - СУММА(ТоварыНаСкладахОстатки.КОтгрузкеОстаток) КАК КоличествоОстаток
			|ИЗ
			|	РегистрНакопления.ТоварыНаСкладах.Остатки(
			|			,
			|			Номенклатура = &ТекущаяНоменклатура
			|				И Характеристика = &ТекущаяХарактеристика) КАК ТоварыНаСкладахОстатки
			|ГДЕ
			|	(&ВсеСклады ИЛИ ТоварыНаСкладахОстатки.Склад В (&Склады))
			|		И (НЕ ТоварыНаСкладахОстатки.Склад В (&МассивАдресныхСкладов))
			|		И (&ВсеПомещения ИЛИ ТоварыНаСкладахОстатки.Помещение В (&Помещения)) 
			|СГРУППИРОВАТЬ ПО
			|	ТоварыНаСкладахОстатки.Склад,
			|	ТоварыНаСкладахОстатки.Помещение,
			|	ТоварыНаСкладахОстатки.Серия
			|ИМЕЮЩИЕ
			| 	СУММА(ТоварыНаСкладахОстатки.ВНаличииОстаток)  - СУММА(ТоварыНаСкладахОстатки.КОтгрузкеОстаток) <> 0
			|УПОРЯДОЧИТЬ ПО
			|	ТоварыНаСкладахОстатки.Склад,
			|	ТоварыНаСкладахОстатки.Помещение,
			|	ТоварыНаСкладахОстатки.Серия
			|ИТОГИ
			|	СУММА(КоличествоОстаток)
			|ПО
			|	Склад,
			|	Помещение,
			|	Серия";
			
			СкорректироватьЗапросЕслиЕстьРегистрСведенийРаспределениеЗапасов(ЗапросОстатков.Текст, "ПолучитьИнфоJSON", УзелПО.УчитыватьОстаткиПоРегиструРаспределениеЗапасов);
			СкорректироватьЗапросЕслиЕстьРегистрНакопленияСвободныеОстатки(ЗапросОстатков.Текст, "ПолучитьИнфоJSON", УзелПО.УчитыватьОстаткиПоРегиструСвободныеОстатки);
			
			ВыборкаПоСкладам = ЗапросОстатков.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаПоСкладам.Следующий() Цикл
				
				ВыборкаПоПомещениям = ВыборкаПоСкладам.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
				Пока ВыборкаПоПомещениям.Следующий() Цикл
					
					НазваниеСклада = "Склад: " + ЧистаяСтрока(ВыборкаПоСкладам.Склад.Наименование);	
					Если ЗначениеЗаполнено(ВыборкаПоПомещениям.Помещение) Тогда
						НазваниеПомещения = "Помещение: " + ЧистаяСтрока(ВыборкаПоПомещениям.Помещение.Наименование);
						НазваниеСклада = НазваниеСклада + Символы.ПС + НазваниеПомещения;
					КонецЕсли;
					
					СтруктураСклады = Новый Структура;
					СтруктураСклады.Вставить("title"  , НазваниеСклада);
					СтруктураСклады.Вставить("value"  , "");
					СтруктураСклады.Вставить("content", Новый Массив);
					
					ВыборкаПоСериям = ВыборкаПоПомещениям.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
					Пока ВыборкаПоСериям.Следующий() Цикл
						
						НазваниеСерии = "";
						Если ЗначениеЗаполнено(ВыборкаПоСериям.Серия) Тогда
							НазваниеСерии = "Серия: " + ЧистаяСтрока(ВыборкаПоСериям.Серия.Наименование);
						КонецЕсли;
						СтрокаОстаток = "" + ВыборкаПоСериям.КоличествоОстаток + " " + ЧистаяСтрока(ВыборкаРезультатПоискаТовара.Номенклатура.ЕдиницаИзмерения.Наименование);  
						
						СтруктураОстатки = Новый Структура;
						СтруктураОстатки.Вставить("title", НазваниеСерии);
						СтруктураОстатки.Вставить("value", СтрокаОстаток);
						
						СтруктураСклады.content.Добавить(СтруктураОстатки);									
						
					КонецЦикла;	
					
					//добавляем только если есть строки
					Если СтруктураСклады.content.Количество() > 0 Тогда
						//если одна строка и нет разбивки, то для красоты выводим данные на уровне выше
						Если СтруктураСклады.content.Количество() = 1 И СтруктураСклады.content[0].title = "" Тогда	
							СтруктураСклады.value = СтруктураСклады.content[0].value;
							СтруктураСклады.content = Новый Массив;
						КонецЕсли;
						СтруктураТовары.content.Добавить(СтруктураСклады);
					КонецЕсли;
					
				КонецЦикла;					
			КонецЦикла;		
			
			Если СтруктураТовары.content.Количество() = 0 Тогда 
				СтруктураСклады = Новый Структура;
				СтруктураСклады.Вставить("title", "Остатков не числится...");
				СтруктураСклады.Вставить("value", "");
				СтруктураСклады.Вставить("content", Новый Массив);
				
				СтруктураТовары.content.Добавить(СтруктураСклады);		
			КонецЕсли;
			
			МассивОтвета.Добавить(СтруктураТовары);
			
		КонецЦикла;	
		
		Возврат ПодготовитьОтветJSON(МассивОтвета,, "application/json");
		
	Иначе 
		
		Возврат ПодготовитьОтветJSON(МассивОтвета,, "application/json");
		
	КонецЕсли;
	
КонецФункции

Функция НайтиНоменклатуруПоШтрихкодуДляБыстрогоДоступа(МассивШК)
	
	
	ЗапросПоискТовара = Новый Запрос; 
	ЗапросПоискТовара.УстановитьПараметр("МассивШК", МассивШК);

	ЗапросПоискТовара.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
	|	ШтрихкодыНоменклатуры.Характеристика КАК Характеристика
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|ГДЕ
	|	ШтрихкодыНоменклатуры.Штрихкод В (&МассивШК)
	|	И ШтрихкодыНоменклатуры.Номенклатура ССЫЛКА Справочник.Номенклатура
	|	И НЕ ШтрихкодыНоменклатуры.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)";
		
	ВыборкаРезультатПоискаТовара = ЗапросПоискТовара.Выполнить().Выбрать();
	Если ВыборкаРезультатПоискаТовара.Следующий() Тогда
		
		Возврат ВыборкаРезультатПоискаТовара.Номенклатура; 
	Иначе
		
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции	
	
	
Функция ПолучитьДополнительнуюИнформациюПоТоваруДляБыстрогоДоступа(УзелПО,лНоменклатура,лХарактеристика) 
	
	ТекущаяЦена = ПолучитьЦенуТовара(лНоменклатура, лХарактеристика, УзелПО.ТипЦен); 
	Если ЗначениеЗаполнено(ТекущаяЦена) Тогда
		ТекущаяЦена = "Цена: " + ТекущаяЦена;
	Иначе
		ТекущаяЦена = "";
	КонецЕсли;
	
	//Заполним атрибуты 
	ТекстАтрибуты = "";
	Атрибуты = ПолучитьАтрибуты(УзелПО); 	
	Для сч = 1 По 10 Цикл
		Попытка 
			ИмяАтрибута =  Атрибуты["ИмяАтрибута" + сч];
			Если ИмяАтрибута = "!!! Ячейки !!!" Или ИмяАтрибута = "!!! Основная ячейка !!!" Или ИмяАтрибута = "!!! Дополнительные ячейки !!!" Тогда
				ЗначениеАтрибута = ПолучитьСправочныеЯчейкиТовара(УзелПО, лНоменклатура, ИмяАтрибута);
			ИначеЕсли ИмяАтрибута = "!!! Характеристики !!!" Тогда
				ЗначениеАтрибута = ЧистаяСтрока(лХарактеристика.Наименование);
			ИначеЕсли Лев(ИмяАтрибута, 3) = "ДР_" Тогда 
				ЗначениеАтрибута = ПолучитьДополнительныйРеквизитАтрибута(лНоменклатура, ИмяАтрибута);	
			ИначеЕсли ИмяАтрибута <> "" Тогда
				ЗначениеАтрибута = ЧистаяСтрока(лНоменклатура[ИмяАтрибута]);						
			КонецЕсли;     
			Если ЗначениеЗаполнено(ИмяАтрибута) и ЗначениеЗаполнено(ЗначениеАтрибута) тогда 
				Если ЗначениеЗаполнено(ТекстАтрибуты) тогда
					ТекстАтрибуты = ТекстАтрибуты + Символы.ПС;
				КонецЕсли;	
				ТекстАтрибуты = ТекстАтрибуты + ИмяАтрибута + ": " + ЗначениеАтрибута;
			КонецЕсли;	
		Исключение
		КонецПопытки;
	КонецЦикла;
	
	ДополнительнаяИнформация = "";
	Если ЗначениеЗаполнено(ТекущаяЦена) и ЗначениеЗаполнено(ТекстАтрибуты) тогда
		ДополнительнаяИнформация = ДополнительнаяИнформация + ТекущаяЦена + Символы.ПС + ТекстАтрибуты;
	ИначеЕсли ЗначениеЗаполнено(ТекущаяЦена)тогда
		ДополнительнаяИнформация = ТекущаяЦена;
	ИначеЕсли ЗначениеЗаполнено(ТекстАтрибуты) тогда
		ДополнительнаяИнформация = ТекстАтрибуты;
	КонецЕсли;
	
	
	Возврат ДополнительнаяИнформация;

КонецФункции

//Получение информации c текстом HTML.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД. 
// Barcode - Строка - Штрихкод.
// 
// Возвращаемое значение:
//   JSON с текстом HTML.
//
Функция ПолучитьИнфоHTML(УзелПО, Barcode)
	
	ТекстHTML = "<!DOCTYPE html>
	|<html lang=""ru"">
	|<head>
	|	<meta charset=""UTF-8"">
	|	<title>Пример HTML</title>
	|	<style type=""text/css"">
	|		
	|	div.aligncenter {
	|        text-align: center;
	|    }
	|		
	|	p.url {
	|		font-size: 22pt;
	|	}
	|	
	|	p.description {
	|		font-size: 16pt;
	|		color: #808080;
	|	}
	|	
	|	</style>
	|	
	|</head>
	|<body>
	|	<div class=""aligncenter""> 
	|	
	|        <img src=""data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QTg0ODQ3MEUwMDZEMTFFQUFDQkVBOENCMEJDRTZCRUYiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QTg0ODQ3MEYwMDZEMTFFQUFDQkVBOENCMEJDRTZCRUYiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDpBODQ4NDcwQzAwNkQxMUVBQUNCRUE4Q0IwQkNFNkJFRiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpBODQ4NDcwRDAwNkQxMUVBQUNCRUE4Q0IwQkNFNkJFRiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PiUzwRcAAAZQSURBVHjarFdriFRlGH6/y7nMzJmZdUd23dZVVzcvFKKVlqJkKF0EwaBCwiyRhAoEJaICoxv9KSTJQlL8YT/6ERSSZeyPFEHFC3mrtGzV1tuuzupe5pw5t+98vd+ZWZ3cdtfNOeywzMd3vu95n+d5L0OklKCepyYtA4cK0CnAq2N2QyPvAkoTUGeMh14vAl0DIAyARhHgH3ghAU0juAeg0WSwr8uBx/f8DZXPgzU6/DB/AnhAa3VGN+o6X844nGnd377k2XM3/lB7KFThkbd9NxmJ/2uUgGXw9dmE0cU5Wx6EAmRE7p0/c+zW/r28GgCuuAFMyRhwcFEzOIEAQgiESFODldgQMm1tIAREiFKte74ATaeTqgogwNOzqF2LlYSiRFmQAEWCpbNFdv/l5b2IAaIw6v9aHQkYlCLOuz4QPDFlUuCcgB0KXnl5hWSyqgzIcmgRgui2fTSmgZHFq5IM8+5dM1COMEkJmUMJrfWQ8kCEKAMZYM6qAohiHiUYnD6NLm9jTNufTekXRiW1VwpoyoIXYhYMevz/94CqGwI/ps4eyJr68YyhfcsoHRPhGqMkmU3qX1iGdgr3LUBJeoc7j49EZ4lhM0JHWSbfbOrac2o1jGQFKxIdLiGp8alSg58FLhBy1wBkv840ofEPTY29pfJZouEG01jIsi0JkBEzQKCkLQZys+wmDbYsbdIvNcbSQqo1CdV6eKW2MY0IIUU5mAoJNeuthN5KOJmu6Fe5Xu3npgkZo9MYBNAVaNAnWmCGVQf11rhNhNPpQkSxvoNampC7B5BKGocszTiQYrLh6+sT4RrkoDHl1AeD0K1WKdZcdD6IKDqOsr2HGPeq/FfrUt5Z+6IV+VVIaqlHxlvG5etRavvyIy3wY5v3+piMHbfoqKKmqYA1RsEPo54u23/R94MZePG7YRg+2lf0nggjaEffDFcC/g0AMaHBhGP73lf1vPBCj9VU/Oja3Gzr+XRTltrfjUm4cbQEi706wvGCT2/YXq7HDbfzst1VE3JF1Jrv9cZfyttb1OJAdeSglTCFWmpoxhVFEa2cnLTNbKKmdf3FWTvW/Xn/+wc6E4tyWmEPl8Vv8gV/guOFa9GSQtF9KyhSqn5+CF6fuxaNmx/OH/y2KkcMzVAYbV9ISEhnZwOnuUPFpqMH23Ibnsy3P/Z43VWoow52GQ6q2pOyCeO4KMMBhELa1NEHKRvT9Sp+Ro+oF6h0VEAoRuIE4V4R+HMnJuxL3Eis+zw/s2l39z1gsAB0hM6V2dCkBT9SRgSNU2BczW00Tuc76Ud88G4h1QVah5+A9l79xBS9e+ObU3+98HC2E67aGqTxMuWzgEoIlEExVXs8H+cACimcBRQ4T8a2GCmA2FBEIp3dwjJm6udgTq571cLRzktNGdfucsxO9OGaUMqdWOtBfRjEjQj6sAMygfrZIXQ7YUNLQ01zLM8QOclvvxrJVKKO+qvH7DB6T37yzpzzKxtrjU2Om0h22Cm8CJpHp9j3SP2RXuGvwLNP9Z+vWFO1UuN6LmVpO/Byc5iCcMsDpFRAiIgEnLbJ5gXm2YbNU0+vzmVqtl2z08lCSJFPWfIIRk0oeSiT0H+vtfSt+GoaFVAs0CTXPqjPmPmJtclZ8d5h6sBNBiIh2kNJtvZCEpbUXIS3x7dBOt2w9JrN4lGrMpvUoaohKYGtBF+V1Nkz2KSO1KXN+9RsECIaHI4HGyiAchYNAOB4fdMkG+3kDBeW8l/gt7MFyNSNPTEuZ80r+gNbLymdBULEqZjFixeqVTFEw1LvMI2D6xaPDayEEhzB0d2BAz0n89BxrAhXTlx6zRHBFiU8HcLPsgxmKLOp94lKTyJ3tR3tfH6gB6A0y2MdRwdjbqt5HyMv+MHqPsebHITRYXUIpSPrfGq7SkmU7Hx30ZvX43iLfT/q+c9CJMtIFBBN6aOMqX7liOiMXfRm246/GBvQxTiaYUps2dQ4HWF2+uGqguM2u0LsU+dpFUHc0VDaf5gfil1dBb+p4AVrkO6IxVMvGahzuR27fvhxt+tnvEBs6++itw9pI5iKS2yoHxwFP/wMZcngBVtVasaMxHSX2p8QYmef4zYi0DfUEo27JanO74L+totZiKr4LyOQSUVf/KTG30hEh/tcb3avFy7BWnGZ3sFU+o8AAwAmPPUznEB9uwAAAABJRU5ErkJggg=="" 
	|	    alt=""Лого DataMobile"">
	|		
	|		
	|		<p class=""url""> 
	|		    <a href=""https://data-mobile.ru/"">Подробнее о DataMobile и других продуктах</a>
	|		</p>
	|		
	|		<p class=""description""> Для отображения контента HTML в пользовательской или типовой функции api/fast_access/html требуется передать в header ответа параметр Content-Type – text/html, а также передать структуру данных в теле ответа </p>
	|		
	|	</div>
	|			
	|</body>
	|</html>";
	
	Возврат ПодготовитьОтветJSON(ТекстHTML,, "text/html");	
	
КонецФункции

//Получение информации c текстом URL.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД. 
// Barcode - Строка - Штрихкод.
// 
// Возвращаемое значение:
//   JSON с текстом URL.
//
Функция ПолучитьИнфоURL(УзелПО, Barcode)
	
	ТекстURL = "https://data-mobile.ru/";
	Возврат ПодготовитьОтветJSON(ТекстURL,, "text/url");	
	
КонецФункции

//Получение информации c текстом.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД. 
// Barcode - Строка - Штрихкод.
// 
// Возвращаемое значение:
//   JSON с текстом.
//
Функция ПолучитьИнфоTEXT(УзелПО, Barcode)  
	
	УчитыватьОстаткиПоРегиструСвободныеОстатки = УзелПО.УчитыватьОстаткиПоРегиструСвободныеОстатки;
	ЕстьРегистрНакопленияСвободныеОстатки = ДатаМобайл_ОбщийМодуль.ЕстьРегистрНакопления("СвободныеОстатки");
	
	ВесовойШК = "";
	
	МассивШК = Новый Массив;
	МассивШК.Добавить(Barcode);
	Если ЗначениеЗаполнено(Barcode) Тогда
		ПростойФорматВесовыхШтрихкодов = УзелПО.ПростойФорматВесовыхШтрихкодов;   
		Если СтрДлина(Barcode) = 5 И Не ПростойФорматВесовыхШтрихкодов Тогда
			ВесовойШК = "2_" + Barcode + "00000_";	
			МассивШК.Добавить(ВесовойШК);
		КонецЕсли;		 
	КонецЕсли;		
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьЕГАИС() И (СтрДлина(Barcode) = 68 Или СтрДлина(Barcode) = 150) Тогда // Инфо по марке ЕГАИС
		
		//есть\нет в системе
		//состояние товара - находится на основном складе или в карантине (брак)
		
		Марка = Barcode;
		ИнфоПоМарке = "";
		ДанныеПомарке = ПолучитьСостояниеАкцизнойМарки(Марка);
		Если ДанныеПомарке <> Неопределено Тогда
			ИнфоПоМарке = ИнфоПоМарке + ДанныеПомарке.АлкогольнаяПродукция.Наименование + Символы.ПС;
			Если ЗначениеЗаполнено(ДанныеПомарке.СправкаБ) Тогда
				ИнфоПоМарке = ИнфоПоМарке + "СправкаБ: " + ДанныеПомарке.СправкаБ + Символы.ПС;
			КонецЕсли;
			Если ЗначениеЗаполнено(ДанныеПомарке.Статус) Тогда
				ИнфоПоМарке = ИнфоПоМарке + "Статус: " + ДанныеПомарке.Статус + Символы.ПС;
			КонецЕсли;
			
		Иначе
			ИнфоПоМарке = "НЕ ЧИСЛИТСЯ В СИСТЕМЕ!!!";
		КонецЕсли;
		
		Возврат ПодготовитьОтветJSON("Акцизная марка" + Символы.ПС + Марка + Символы.ПС + Символы.ПС + ИнфоПоМарке,, "text");
		
	ИНАЧЕ //ОБЫЧНЫЕ ТОВАРЫ
		
		СтрокаВозврата = "";
		ВключатьАртикул = УзелПО.ДобавлятьАртикулВНаименование;
		ИспользоватьАртикулКакШтрихкодТовара = УзелПО.ИспользоватьАртикулКакШтрихкодТовара;
		
		//Сначала ищем ячейку...	
		ТекущаяЯчейка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(Barcode);
		ТекущаяЯчейкаНаименование = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0, ЧистаяСтрока(ТекущаяЯчейка.Наименование), ТекущаяЯчейка.Код);
		
		ЗапросПоискЯчейки = Новый Запрос;
		ЗапросПоискЯчейки.УстановитьПараметр("ТекущаяЯчейка", ТекущаяЯчейка);	
		ЗапросПоискЯчейки.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	СкладскиеЯчейки.Ссылка КАК Ячейка
		|ИЗ
		|	Справочник.СкладскиеЯчейки КАК СкладскиеЯчейки
		|ГДЕ
		|	СкладскиеЯчейки.Ссылка = &ТекущаяЯчейка";
		
		ВыборкаРезультатПоискаЯчейки = ЗапросПоискЯчейки.Выполнить().Выбрать();
		Если ВыборкаРезультатПоискаЯчейки.Следующий() Тогда
			ИмяЯчейки = "Ячейка: " + ТекущаяЯчейкаНаименование + Символы.ПС + Символы.ПС;
			
			ЗапросОстатков = Новый Запрос;
			ЗапросОстатков.УстановитьПараметр("ТекущаяЯчейка", ТекущаяЯчейка);
			ЗапросОстатков.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	ТоварыВЯчейкахОстатки.Номенклатура,
			|	ТоварыВЯчейкахОстатки.Характеристика,
			|	ТоварыВЯчейкахОстатки.Серия,
			|	ТоварыВЯчейкахОстатки.Упаковка,
			|	ТоварыВЯчейкахОстатки.Ячейка,
			|	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток)- СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) КАК КоличествоОстаток
			|ИЗ
			|	РегистрНакопления.ТоварыВЯчейках.Остатки(,Ячейка=&ТекущаяЯчейка) КАК ТоварыВЯчейкахОстатки
			|СГРУППИРОВАТЬ ПО
			|	ТоварыВЯчейкахОстатки.Номенклатура,
			|	ТоварыВЯчейкахОстатки.Характеристика,
			|	ТоварыВЯчейкахОстатки.Серия,
			|	ТоварыВЯчейкахОстатки.Упаковка,
			|	ТоварыВЯчейкахОстатки.Ячейка			
			|ИМЕЮЩИЕ
			| 	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток) - СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) <> 0 
			|УПОРЯДОЧИТЬ ПО
			|	ТоварыВЯчейкахОстатки.Ячейка ВОЗР,
			|	ТоварыВЯчейкахОстатки.Номенклатура ВОЗР,
			|	ТоварыВЯчейкахОстатки.Характеристика ВОЗР,
			|	ТоварыВЯчейкахОстатки.Серия ВОЗР,
			|	ТоварыВЯчейкахОстатки.Упаковка ВОЗР";
			
			ВыборкаРезультатЗапросаОстатков = ЗапросОстатков.Выполнить().Выбрать();
			Если ВыборкаРезультатЗапросаОстатков.Количество() > 0 Тогда				
				ТекущаяНоменклатура = Справочники.Номенклатура.ПустаяСсылка();
				ТекущаяХарактеристика = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
				
				Пока ВыборкаРезультатЗапросаОстатков.Следующий() Цикл
					
					Если ВыборкаРезультатЗапросаОстатков.Номенклатура <> ТекущаяНоменклатура Или ВыборкаРезультатЗапросаОстатков.Характеристика <> ТекущаяХарактеристика Тогда 
						
						ТекущаяНоменклатура = ВыборкаРезультатЗапросаОстатков.Номенклатура;
						ТекущаяХарактеристика = ВыборкаРезультатЗапросаОстатков.Характеристика;
						
						СтрокаВозврата = СтрокаВозврата + Символы.ПС + "Товар: " + ?(ВключатьАртикул, ВыборкаРезультатЗапросаОстатков.Номенклатура.Артикул + " ", "")
						+ ВыборкаРезультатЗапросаОстатков.Номенклатура + " "
						+ ВыборкаРезультатЗапросаОстатков.Характеристика + "; " + Символы.ПС;
					КонецЕсли;
										
					СтрокаВозврата = СтрокаВозврата + ВыборкаРезультатЗапросаОстатков.КоличествоОстаток + " "
					+ ВыборкаРезультатЗапросаОстатков.Упаковка + "; " 
					+ ВыборкаРезультатЗапросаОстатков.Серия + Символы.ПС;		
				КонецЦикла;
			Иначе 
				СтрокаВозврата =  "Товаров не числится...";
			КонецЕсли;
			
			Возврат ПодготовитьОтветJSON(ИмяЯчейки + СтрокаВозврата + Символы.ПС + Символы.ПС,, "text");
			
		КонецЕсли;
		
		//Если ячейки нет, то ищем товар...	
		ЗапросПоискТовара = Новый Запрос; 
		ЗапросПоискТовара.УстановитьПараметр("Barcode", Barcode);
		ЗапросПоискТовара.УстановитьПараметр("МассивШК", МассивШК);
		ЗапросПоискТовара.УстановитьПараметр("ИспользоватьАртикулКакШтрихкодТовара", ИспользоватьАртикулКакШтрихкодТовара);
		
		ЗапросПоискТовара.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
		|	ШтрихкодыНоменклатуры.Характеристика КАК Характеристика
		|ИЗ
		|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
		|ГДЕ
		|	ШтрихкодыНоменклатуры.Штрихкод В (&МассивШК)
		|	И ШтрихкодыНоменклатуры.Номенклатура Ссылка Справочник.Номенклатура
		|	И НЕ ШтрихкодыНоменклатуры.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|
		//ВЫБОРКА ССЫЛОК ТОВАРОВ И ХАРАКТЕРИСТИК ПО РАЗНЫМ УСЛОВИЯМ ВЕДЕНИЯ ХАРАКТЕРИСТИК ПРИ ИспользоватьАртикулКакШтрихкодТовара 
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		//БЕЗ ХАРАКТЕРИСТИК
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка) КАК Характеристика
		|ИЗ
		| 	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	&ИспользоватьАртикулКакШтрихкодТовара
		|	И Номенклатура.Артикул = &Barcode
		|	И НЕ Номенклатура.ЭтоГруппа
		|	И НЕ Номенклатура.ПометкаУдаления
		|
		|ОБЪЕДИНИТЬ
		|	
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		//ИНДИВИДУАЛЬНЫЕ ХАРАКТЕРИСТИКИ
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
		|ИЗ
		| 	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка
		|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры)
		|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
		|ГДЕ
		|	&ИспользоватьАртикулКакШтрихкодТовара
		|	И Номенклатура.Артикул = &Barcode
		|	И НЕ Номенклатура.ЭтоГруппа
		|	И НЕ Номенклатура.ПометкаУдаления
		|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
		|
		|ОБЪЕДИНИТЬ
		|	
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		//ОБЩИЕ ХАРАКТЕРИСТИКИ
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВидНоменклатуры
		|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры)
		|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
		|ГДЕ
		|	&ИспользоватьАртикулКакШтрихкодТовара
		|	И Номенклатура.Артикул = &Barcode
		|	И НЕ Номенклатура.ЭтоГруппа
		|	И НЕ Номенклатура.ПометкаУдаления 
		|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		//ОБЩИЕ С ДРУГИМ ВИДОМ ХАРАКТЕРИСТИКИ
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВладелецХарактеристик
		|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры)
		|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
		|ГДЕ
		|	&ИспользоватьАртикулКакШтрихкодТовара
		|	И Номенклатура.Артикул = &Barcode
		|	И НЕ Номенклатура.ЭтоГруппа
		|	И НЕ Номенклатура.ПометкаУдаления
		|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL";
		
		ВыборкаРезультатПоискаТовара = ЗапросПоискТовара.Выполнить().Выбрать();
		
		Если ВыборкаРезультатПоискаТовара.Количество() = 0 И ДатаМобайл_ОбщийМодуль.ЕстьМаркировка() И стрДлина(Barcode) > 30 Тогда
			//Попробуем найти товар по КМ	
			КМ = Лев(Barcode, 31);
			ЗначениеШтрихкода = "(01)" + Сред(КМ, 3, 14) + "(21)" + Сред(КМ, 19, 13);
			ЗначениеШтрихкодаДляЗапроса = "" + ЗначениеШтрихкода;
			ЗначениеШтрихкодаДляЗапроса = СтрЗаменить(ЗначениеШтрихкодаДляЗапроса, "_", "$_");
			ЗначениеШтрихкодаДляЗапроса = СтрЗаменить(ЗначениеШтрихкодаДляЗапроса, "%", "$%");
			ЗначениеШтрихкодаДляЗапроса = ЗначениеШтрихкодаДляЗапроса + "%";
			
			ЗапросПоискТовара = Новый Запрос;
			ЗапросПоискТовара.УстановитьПараметр("ЗначениеШтрихкодаДляЗапроса", ЗначениеШтрихкодаДляЗапроса);
			ЗапросПоискТовара.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	ШтрихкодыУпаковокТоваров.Номенклатура КАК Номенклатура,
			|	ШтрихкодыУпаковокТоваров.Характеристика КАК Характеристика
			|ИЗ
			|	Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
			|ГДЕ
			|	ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода ПОДОБНО &ЗначениеШтрихкодаДляЗапроса СПЕЦСИМВОЛ ""$""
			|	И ШтрихкодыУпаковокТоваров.Номенклатура Ссылка Справочник.Номенклатура
			|	И НЕ ШтрихкодыУпаковокТоваров.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)";
			
			ВыборкаРезультатПоискаТовара = ЗапросПоискТовара.Выполнить().Выбрать();
			
			Если ВыборкаРезультатПоискаТовара.Количество() = 0 Тогда
				
				ТекущийШтрихкод = Сред(Barcode, 3, 14);
				ТекущийШтрихкод = УдалитьЛидирующиеНули(ТекущийШтрихкод);
				
				ЗапросПоискТовара = Новый Запрос;                  
				
				МассивШК.Очистить(); 
				МассивШК.Добавить(ТекущийШтрихкод);
				Если ЗначениеЗаполнено(ВесовойШК) Тогда
					МассивШК.Добавить(ВесовойШК);
				КонецЕсли;        		 
				
				ЗапросПоискТовара.УстановитьПараметр("МассивШК", МассивШК);                 				 
				ЗапросПоискТовара.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
				|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
				|	ШтрихкодыНоменклатуры.Характеристика КАК Характеристика
				|ИЗ
				|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
				|ГДЕ
				|	ШтрихкодыНоменклатуры.Штрихкод В (&МассивШК)
				|	И ШтрихкодыНоменклатуры.Номенклатура Ссылка Справочник.Номенклатура";
				
				ВыборкаРезультатПоискаТовара = ЗапросПоискТовара.Выполнить().Выбрать();
				
			КонецЕсли;		
		КонецЕсли;		
		
		
		Если ВыборкаРезультатПоискаТовара.Количество() > 0 Тогда	
			Пока ВыборкаРезультатПоискаТовара.Следующий() Цикл
				
				НетНаОстатках = Истина;
				ИмяТовара = "Товар: "   +   ?(ВключатьАртикул, ВыборкаРезультатПоискаТовара.Номенклатура.Артикул + " ", "")
				+ ВыборкаРезультатПоискаТовара.Номенклатура + " " 
				+ ВыборкаРезультатПоискаТовара.Характеристика + Символы.ПС + Символы.ПС;
				ИнфоТовар = "";
				
				//Сначала ищем остатки по адресному регистру...
				ЗапросОстатковАдресный = Новый Запрос;
				ЗапросОстатковАдресный.УстановитьПараметр("ТекущаяНоменклатура", ВыборкаРезультатПоискаТовара.Номенклатура);
				ЗапросОстатковАдресный.УстановитьПараметр("ТекущаяХарактеристика", ВыборкаРезультатПоискаТовара.Характеристика);
				
				СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
				ЗапросОстатковАдресный.УстановитьПараметр("Склады", СписокСкладов);
				ЗапросОстатковАдресный.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
				
				СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
				ЗапросОстатковАдресный.УстановитьПараметр("Помещения", СписокПомещений);
				ЗапросОстатковАдресный.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
				
				ЗапросОстатковАдресный.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	ТоварыВЯчейкахОстатки.Ячейка.Владелец КАК Склад,
				|	ТоварыВЯчейкахОстатки.Ячейка.Помещение КАК Помещение,
				|	ТоварыВЯчейкахОстатки.Ячейка,
				|	ТоварыВЯчейкахОстатки.Номенклатура,
				|	ТоварыВЯчейкахОстатки.Характеристика,
				|	ТоварыВЯчейкахОстатки.Серия,
				|	ТоварыВЯчейкахОстатки.Упаковка,
				|	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток) - СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) КАК КоличествоОстаток
				|ИЗ
				| 	РегистрНакопления.ТоварыВЯчейках.Остатки(
				|   	,
				|   	Номенклатура = &ТекущаяНоменклатура
				|   	 И Характеристика = &ТекущаяХарактеристика) КАК ТоварыВЯчейкахОстатки
				|ГДЕ
				| (&ВсеСклады ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Владелец В (&Склады))
				| И (&ВсеПомещения ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Помещение В (&Помещения))   
				|СГРУППИРОВАТЬ ПО
				|	ТоварыВЯчейкахОстатки.Ячейка.Владелец,
				|	ТоварыВЯчейкахОстатки.Ячейка.Помещение,
				|	ТоварыВЯчейкахОстатки.Ячейка,
				|	ТоварыВЯчейкахОстатки.Номенклатура,
				|	ТоварыВЯчейкахОстатки.Характеристика,
				|	ТоварыВЯчейкахОстатки.Серия,
				|	ТоварыВЯчейкахОстатки.Упаковка
				|ИМЕЮЩИЕ
				| 	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток) - СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) <> 0 
				|УПОРЯДОЧИТЬ ПО
				|	ТоварыВЯчейкахОстатки.Ячейка.Владелец ВОЗР,
				|	ТоварыВЯчейкахОстатки.Ячейка ВОЗР,
				|	ТоварыВЯчейкахОстатки.Номенклатура ВОЗР,
				|	ТоварыВЯчейкахОстатки.Характеристика ВОЗР,
				|	ТоварыВЯчейкахОстатки.Серия ВОЗР,
				|	ТоварыВЯчейкахОстатки.Упаковка ВОЗР";
				
				ВыборкаРезультатЗапросаОстатковАдресный = ЗапросОстатковАдресный.Выполнить().Выбрать();
				Если ВыборкаРезультатЗапросаОстатковАдресный.Количество() > 0 Тогда
					
					ТекущийСклад = Справочники.Склады.ПустаяСсылка();
					ТекущееПомещение = Справочники.СкладскиеПомещения.ПустаяСсылка();
					ТекущаяЯчейка = Справочники.СкладскиеЯчейки.ПустаяСсылка();
					
					Пока ВыборкаРезультатЗапросаОстатковАдресный.Следующий() Цикл
						
						Если ВыборкаРезультатЗапросаОстатковАдресный.Склад <> ТекущийСклад Тогда 
							ТекущийСклад = ВыборкаРезультатЗапросаОстатковАдресный.Склад;
							
							ИнфоТовар = ИнфоТовар + Символы.ПС + ВыборкаРезультатЗапросаОстатковАдресный.Склад + Символы.ПС;
						КонецЕсли;
						
						Если ВыборкаРезультатЗапросаОстатковАдресный.Помещение <> ТекущееПомещение И ЗначениеЗаполнено(ВыборкаРезультатЗапросаОстатковАдресный.Помещение) Тогда 
							ТекущееПомещение = ВыборкаРезультатЗапросаОстатковАдресный.Помещение;
							
							ИнфоТовар = ИнфоТовар + Символы.ПС + ВыборкаРезультатЗапросаОстатковАдресный.Помещение + Символы.ПС;
						КонецЕсли;
						
						Если ВыборкаРезультатЗапросаОстатковАдресный.Ячейка <> ТекущаяЯчейка Тогда 
							ТекущаяЯчейка = ВыборкаРезультатЗапросаОстатковАдресный.Ячейка;
							ТекущаяЯчейкаНаименование = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0, ЧистаяСтрока(ВыборкаРезультатЗапросаОстатковАдресный.Ячейка.Наименование), ВыборкаРезультатЗапросаОстатковАдресный.Ячейка.Код);
							
							ИнфоТовар = ИнфоТовар + Символы.ПС + ТекущаяЯчейкаНаименование + Символы.ПС;
						КонецЕсли;						
						
						ИнфоТовар = ИнфоТовар + ВыборкаРезультатЗапросаОстатковАдресный.КоличествоОстаток + " "
						+ ВыборкаРезультатЗапросаОстатковАдресный.Упаковка + "; " 
						+ ВыборкаРезультатЗапросаОстатковАдресный.Серия + Символы.ПС;
						
						НетНаОстатках = Ложь;					  
					КонецЦикла;
					
					ИнфоТовар = ИнфоТовар + Символы.ПС + Символы.ПС + Символы.ПС;
				КонецЕсли;	
												
				//Затем по обычному регистру на оставщихся складах...
				ЗапросОстатков = Новый Запрос;
				ЗапросОстатков.УстановитьПараметр("ТекущаяНоменклатура", ВыборкаРезультатПоискаТовара.Номенклатура);
				ЗапросОстатков.УстановитьПараметр("ТекущаяХарактеристика", ВыборкаРезультатПоискаТовара.Характеристика);
				
				СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
				ЗапросОстатков.УстановитьПараметр("Склады", СписокСкладов);
				ЗапросОстатков.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
				
				СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
				ЗапросОстатков.УстановитьПараметр("Помещения", СписокПомещений);
				ЗапросОстатков.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
				
				ЗапросОстатков.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	ТоварыНаСкладахОстатки.Склад,
				|	ТоварыНаСкладахОстатки.Помещение КАК Помещение,
				|	ТоварыНаСкладахОстатки.Номенклатура,
				|	ТоварыНаСкладахОстатки.Характеристика,
				|	ТоварыНаСкладахОстатки.Серия КАК Серия,
				|	СУММА(ТоварыНаСкладахОстатки.ВНаличииОстаток) - СУММА(ТоварыНаСкладахОстатки.КОтгрузкеОстаток) КАК КоличествоОстаток
				|ИЗ
				|	РегистрНакопления.ТоварыНаСкладах.Остатки(
				|			,
				|			Номенклатура = &ТекущаяНоменклатура
				|				И Характеристика = &ТекущаяХарактеристика) КАК ТоварыНаСкладахОстатки
				|ГДЕ
				|	(&ВсеСклады ИЛИ ТоварыНаСкладахОстатки.Склад В (&Склады))
				|	И 1=1 
				|СГРУППИРОВАТЬ ПО
				|	ТоварыНаСкладахОстатки.Склад,
				|	ТоварыНаСкладахОстатки.Помещение,
				|	ТоварыНаСкладахОстатки.Номенклатура,
				|	ТоварыНаСкладахОстатки.Характеристика,
				|	ТоварыНаСкладахОстатки.Серия
				|ИМЕЮЩИЕ
				| 	СУММА(ТоварыНаСкладахОстатки.ВНаличииОстаток)  - СУММА(ТоварыНаСкладахОстатки.КОтгрузкеОстаток) <> 0
				|УПОРЯДОЧИТЬ ПО
				|	ТоварыНаСкладахОстатки.Склад ВОЗР,
				|	ТоварыНаСкладахОстатки.Номенклатура ВОЗР,
				|	ТоварыНаСкладахОстатки.Характеристика ВОЗР,
				|	ТоварыНаСкладахОстатки.Серия ВОЗР";
				
				СкорректироватьЗапросЕслиЕстьРегистрНакопленияСвободныеОстатки(ЗапросОстатков.Текст, "ПолучитьИнфоTEXT", УчитыватьОстаткиПоРегиструСвободныеОстатки, ЕстьРегистрНакопленияСвободныеОстатки);
								
				ВыборкаРезультатЗапросаОстатков = ЗапросОстатков.Выполнить().Выбрать();
				Если ВыборкаРезультатЗапросаОстатков.Количество() > 0 Тогда   
					
					ТекущийСклад = Справочники.Склады.ПустаяСсылка();
					ТекущееПомещение = Справочники.СкладскиеПомещения.ПустаяСсылка();
					
					Пока ВыборкаРезультатЗапросаОстатков.Следующий() Цикл
						
						Если ВыборкаРезультатЗапросаОстатков.Склад <> ТекущийСклад Тогда 
							ТекущийСклад = ВыборкаРезультатЗапросаОстатков.Склад;
							
							ИнфоТовар = ИнфоТовар + Символы.ПС + ВыборкаРезультатЗапросаОстатков.Склад + Символы.ПС;
						КонецЕсли;
						
						Если ВыборкаРезультатЗапросаОстатков.Помещение <> ТекущееПомещение И ЗначениеЗаполнено(ВыборкаРезультатЗапросаОстатков.Помещение) Тогда 
							ТекущееПомещение = ВыборкаРезультатЗапросаОстатков.Помещение;
							
							ИнфоТовар = ИнфоТовар + Символы.ПС + ВыборкаРезультатЗапросаОстатков.Помещение + Символы.ПС;
						КонецЕсли;
						
						ИнфоТовар = ИнфоТовар + ВыборкаРезультатЗапросаОстатков.КоличествоОстаток + " "
						+ ВыборкаРезультатЗапросаОстатков.Номенклатура.ЕдиницаИзмерения + "; "
						+ ВыборкаРезультатЗапросаОстатков.Серия + Символы.ПС;
						
						НетНаОстатках = Ложь;
					КонецЦикла;
				КонецЕсли;	
				
				//Нет остатков...
				Если НетНаОстатках Тогда
					ИнфоТовар =  "Остатков не числится...";
				КонецЕсли;				
				
				СтрокаВозврата = ИмяТовара + ИнфоТовар + Символы.ПС + Символы.ПС + Символы.ПС;
			КонецЦикла;
			
			Возврат ПодготовитьОтветJSON(СтрокаВозврата,, "text");
			
		Иначе 
			
			Возврат ПодготовитьОтветJSON("По штрихкоду данных не найдено...",, "text");
			
		КонецЕсли;
		
	КонецЕсли;	
	
КонецФункции	

//2.9

//Получение информации.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД. 
// Barcode - Строка - Штрихкод.
// 
// Возвращаемое значение:
//   JSON с текстом.
//
Функция ПолучитьИнфо(УзелПО, Barcode) 
	
	ВесовойШК = "";
	
	МассивШК = Новый Массив;
	МассивШК.Добавить(Barcode);
	Если ЗначениеЗаполнено(Barcode) Тогда
		ПростойФорматВесовыхШтрихкодов = УзелПО.ПростойФорматВесовыхШтрихкодов;   
		Если СтрДлина(Barcode) = 5 И Не ПростойФорматВесовыхШтрихкодов Тогда
			ВесовойШК = "2_" + Barcode + "00000_";	
			МассивШК.Добавить(ВесовойШК);
		КонецЕсли;		 
	КонецЕсли;	
	
	СтруктураОтвета = Новый Структура;
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьЕГАИС() И (СтрДлина(Barcode) = 68 Или СтрДлина(Barcode) = 150) Тогда // Инфо по марке ЕГАИС
		
		//есть\нет в системе
		//состояние товара - находится на основном складе или в карантине (брак)
		
		Марка = Barcode;
		ИнфоПоМарке = "";
		ДанныеПомарке = ПолучитьСостояниеАкцизнойМарки(Марка);
		Если ДанныеПомарке <> Неопределено Тогда
			ИнфоПоМарке = ИнфоПоМарке + ДанныеПомарке.АлкогольнаяПродукция.Наименование + Символы.ПС;
			Если ЗначениеЗаполнено(ДанныеПомарке.СправкаБ) Тогда
				ИнфоПоМарке = ИнфоПоМарке + "СправкаБ: " + ДанныеПомарке.СправкаБ + Символы.ПС;
			КонецЕсли;
			Если ЗначениеЗаполнено(ДанныеПомарке.Статус) Тогда
				ИнфоПоМарке = ИнфоПоМарке + "Статус: " + ДанныеПомарке.Статус + Символы.ПС;
			КонецЕсли;
			
		Иначе
			ИнфоПоМарке = "НЕ ЧИСЛИТСЯ В СИСТЕМЕ!!!";
		КонецЕсли;
		
		Возврат ПодготовитьОтветJSON(СтруктураОтвета.Вставить("data", "Акцизная марка" + Символы.ПС + Марка + Символы.ПС + Символы.ПС + ИнфоПоМарке));
				
	ИНАЧЕ //ОБЫЧНЫЕ ТОВАРЫ
		
		СтрокаВозврата = "";
		ВключатьАртикул = УзелПО.ДобавлятьАртикулВНаименование;
		ИспользоватьАртикулКакШтрихкодТовара = УзелПО.ИспользоватьАртикулКакШтрихкодТовара;
		//Сначала ищем ячейку...	
		ТекущаяЯчейка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(Barcode);
		ТекущаяЯчейкаНаименование = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0, ЧистаяСтрока(ТекущаяЯчейка.Наименование), ТекущаяЯчейка.Код);
		
		ЗапросПоискЯчейки = Новый Запрос;
		ЗапросПоискЯчейки.УстановитьПараметр("ТекущаяЯчейка", ТекущаяЯчейка);	
		ЗапросПоискЯчейки.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
		|	СкладскиеЯчейки.Ссылка КАК Ячейка
		|ИЗ
		|	Справочник.СкладскиеЯчейки КАК СкладскиеЯчейки
		|ГДЕ
		|	СкладскиеЯчейки.Ссылка = &ТекущаяЯчейка";
		
		ВыборкаРезультатПоискаЯчейки = ЗапросПоискЯчейки.Выполнить().Выбрать();
		Если ВыборкаРезультатПоискаЯчейки.Следующий() Тогда
			ИмяЯчейки = "Ячейка: " + ТекущаяЯчейкаНаименование + Символы.ПС + Символы.ПС;
			
			ЗапросОстатков = Новый Запрос;
			ЗапросОстатков.УстановитьПараметр("ТекущаяЯчейка", ТекущаяЯчейка);
			ЗапросОстатков.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	ТоварыВЯчейкахОстатки.Номенклатура,
			|	ТоварыВЯчейкахОстатки.Характеристика,
			|	ТоварыВЯчейкахОстатки.Серия,
			|	ТоварыВЯчейкахОстатки.Упаковка,
			|	ТоварыВЯчейкахОстатки.Ячейка,
			|	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток)- СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) КАК КоличествоОстаток
			|ИЗ
			|	РегистрНакопления.ТоварыВЯчейках.Остатки(,Ячейка=&ТекущаяЯчейка) КАК ТоварыВЯчейкахОстатки
			|СГРУППИРОВАТЬ ПО
			|	ТоварыВЯчейкахОстатки.Номенклатура,
			|	ТоварыВЯчейкахОстатки.Характеристика,
			|	ТоварыВЯчейкахОстатки.Серия,
			|	ТоварыВЯчейкахОстатки.Упаковка,
			|	ТоварыВЯчейкахОстатки.Ячейка			
			|ИМЕЮЩИЕ
			| 	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток) - СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) <> 0 
			|УПОРЯДОЧИТЬ ПО
			|	ТоварыВЯчейкахОстатки.Ячейка ВОЗР,
			|	ТоварыВЯчейкахОстатки.Номенклатура ВОЗР,
			|	ТоварыВЯчейкахОстатки.Характеристика ВОЗР,
			|	ТоварыВЯчейкахОстатки.Серия ВОЗР,
			|	ТоварыВЯчейкахОстатки.Упаковка ВОЗР";
			
			ВыборкаРезультатЗапросаОстатков = ЗапросОстатков.Выполнить().Выбрать();
			Если ВыборкаРезультатЗапросаОстатков.Количество() > 0 Тогда
				
				ТекущаяНоменклатура = Справочники.Номенклатура.ПустаяСсылка();
				ТекущаяХарактеристика = Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка();
				
				Пока ВыборкаРезультатЗапросаОстатков.Следующий() Цикл
					
					Если ВыборкаРезультатЗапросаОстатков.Номенклатура <> ТекущаяНоменклатура Или ВыборкаРезультатЗапросаОстатков.Характеристика <> ТекущаяХарактеристика Тогда 
						
						ТекущаяНоменклатура = ВыборкаРезультатЗапросаОстатков.Номенклатура;
						ТекущаяХарактеристика = ВыборкаРезультатЗапросаОстатков.Характеристика;
						
						СтрокаВозврата = СтрокаВозврата + Символы.ПС + "Товар: " + ?(ВключатьАртикул, ВыборкаРезультатЗапросаОстатков.Номенклатура.Артикул + " ", "")
						+ ВыборкаРезультатЗапросаОстатков.Номенклатура + " "
						+ ВыборкаРезультатЗапросаОстатков.Характеристика + "; " + Символы.ПС;
					КонецЕсли;
										
					СтрокаВозврата = СтрокаВозврата + ВыборкаРезультатЗапросаОстатков.КоличествоОстаток + " "
					+ ВыборкаРезультатЗапросаОстатков.Упаковка + "; " 
					+ ВыборкаРезультатЗапросаОстатков.Серия + Символы.ПС;		
				КонецЦикла;
			Иначе 
				СтрокаВозврата =  "Товаров не числится...";
			КонецЕсли;
			РезСтрока = ИмяЯчейки + СтрокаВозврата;
			
			СтруктураОтвета.Вставить("data", РезСтрока);
			Возврат ПодготовитьОтветJSON(СтруктураОтвета);
			
		КонецЕсли;
		
		//Если ячейки нет, то ищем товар...	
		
		ЗапросПоискТовара = Новый Запрос;
		ЗапросПоискТовара.УстановитьПараметр("Barcode", Barcode);
		ЗапросПоискТовара.УстановитьПараметр("МассивШК", МассивШК);
		ЗапросПоискТовара.УстановитьПараметр("ИспользоватьАртикулКакШтрихкодТовара", ИспользоватьАртикулКакШтрихкодТовара);
		ЗапросПоискТовара.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
		|	ШтрихкодыНоменклатуры.Характеристика КАК Характеристика
		|ИЗ
		|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
		|ГДЕ
		|	ШтрихкодыНоменклатуры.Штрихкод В (&МассивШК)
		|	И ШтрихкодыНоменклатуры.Номенклатура ССЫЛКА Справочник.Номенклатура
		|	И НЕ ШтрихкодыНоменклатуры.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
		|
		//ВЫБОРКА ССЫЛОК ТОВАРОВ И ХАРАКТЕРИСТИК ПО РАЗНЫМ УСЛОВИЯМ ВЕДЕНИЯ ХАРАКТЕРИСТИК ПРИ ИспользоватьАртикулКакШтрихкодТовара 
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		//БЕЗ ХАРАКТЕРИСТИК
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка) КАК Характеристика
		|ИЗ
		| 	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	&ИспользоватьАртикулКакШтрихкодТовара
		|	И Номенклатура.Артикул = &Barcode
		|	И НЕ Номенклатура.ЭтоГруппа
		|	И НЕ Номенклатура.ПометкаУдаления
		|
		|ОБЪЕДИНИТЬ
		|	
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		//ИНДИВИДУАЛЬНЫЕ ХАРАКТЕРИСТИКИ
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
		|ИЗ
		| 	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка
		|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры)
		|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
		|ГДЕ
		|	&ИспользоватьАртикулКакШтрихкодТовара
		|	И Номенклатура.Артикул = &Barcode
		|	И НЕ Номенклатура.ЭтоГруппа
		|	И НЕ Номенклатура.ПометкаУдаления
		|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
		|
		|ОБЪЕДИНИТЬ
		|	
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		//ОБЩИЕ ХАРАКТЕРИСТИКИ
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВидНоменклатуры
		|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры)
		|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
		|ГДЕ
		|	&ИспользоватьАртикулКакШтрихкодТовара
		|	И Номенклатура.Артикул = &Barcode
		|	И НЕ Номенклатура.ЭтоГруппа
		|	И НЕ Номенклатура.ПометкаУдаления 
		|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		//ОБЩИЕ С ДРУГИМ ВИДОМ ХАРАКТЕРИСТИКИ
		|	Номенклатура.Ссылка КАК Номенклатура,
		|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
		|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВладелецХарактеристик
		|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры)
		|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
		|ГДЕ
		|	&ИспользоватьАртикулКакШтрихкодТовара
		|	И Номенклатура.Артикул = &Barcode
		|	И НЕ Номенклатура.ЭтоГруппа
		|	И НЕ Номенклатура.ПометкаУдаления
		|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL";
		
		ВыборкаРезультатПоискаТовара = ЗапросПоискТовара.Выполнить().Выбрать();
		
		Если ВыборкаРезультатПоискаТовара.Количество() = 0 И ДатаМобайл_ОбщийМодуль.ЕстьМаркировка() И стрДлина(Barcode) > 30 Тогда
			//Попробуем найти товар по КМ	
			КМ = Лев(Barcode, 31);
			ЗначениеШтрихкода = "(01)" + Сред(КМ, 3, 14) + "(21)" + Сред(КМ, 19, 13);
			ЗначениеШтрихкодаДляЗапроса = "" + ЗначениеШтрихкода;
			ЗначениеШтрихкодаДляЗапроса = СтрЗаменить(ЗначениеШтрихкодаДляЗапроса, "_", "$_");
			ЗначениеШтрихкодаДляЗапроса = СтрЗаменить(ЗначениеШтрихкодаДляЗапроса, "%", "$%");
			ЗначениеШтрихкодаДляЗапроса = ЗначениеШтрихкодаДляЗапроса + "%";
			
			ЗапросПоискТовара = Новый Запрос;
			ЗапросПоискТовара.УстановитьПараметр("ЗначениеШтрихкодаДляЗапроса", ЗначениеШтрихкодаДляЗапроса);
			ЗапросПоискТовара.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 1
			|	ШтрихкодыУпаковокТоваров.Номенклатура КАК Номенклатура,
			|	ШтрихкодыУпаковокТоваров.Характеристика КАК Характеристика
			|ИЗ
			|	Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
			|ГДЕ
			|	ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода ПОДОБНО &ЗначениеШтрихкодаДляЗапроса СПЕЦСИМВОЛ ""$""
			|	И ШтрихкодыУпаковокТоваров.Номенклатура Ссылка Справочник.Номенклатура
			|	И НЕ ШтрихкодыУпаковокТоваров.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)";
			
			ВыборкаРезультатПоискаТовара = ЗапросПоискТовара.Выполнить().Выбрать();
			
			Если ВыборкаРезультатПоискаТовара.Количество() = 0 Тогда
				
				ТекущийШтрихкод = Сред(Barcode, 3, 14);
				ТекущийШтрихкод = УдалитьЛидирующиеНули(ТекущийШтрихкод);
				
				ЗапросПоискТовара = Новый Запрос;   
				
				МассивШК.Очистить(); 
				МассивШК.Добавить(ТекущийШтрихкод);
				Если ЗначениеЗаполнено(ВесовойШК) Тогда
					МассивШК.Добавить(ВесовойШК);
				КонецЕсли;
				
				ЗапросПоискТовара.УстановитьПараметр("МассивШК", МассивШК); 
				ЗапросПоискТовара.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
				|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
				|	ШтрихкодыНоменклатуры.Характеристика КАК Характеристика
				|ИЗ
				|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
				|ГДЕ
				|	ШтрихкодыНоменклатуры.Штрихкод В (&МассивШК)
				|	И ШтрихкодыНоменклатуры.Номенклатура Ссылка Справочник.Номенклатура";
				
				ВыборкаРезультатПоискаТовара = ЗапросПоискТовара.Выполнить().Выбрать();
				
			КонецЕсли;		
		КонецЕсли;		
				
		Если ВыборкаРезультатПоискаТовара.Количество() > 0 Тогда	
			Пока ВыборкаРезультатПоискаТовара.Следующий() Цикл
				
				НетНаОстатках = Истина;
				ИмяТовара = "Товар: " + ?(ВключатьАртикул, ВыборкаРезультатПоискаТовара.Номенклатура.Артикул + " ", "")
				+ ВыборкаРезультатПоискаТовара.Номенклатура + " " 
				+ ВыборкаРезультатПоискаТовара.Характеристика + Символы.ПС + Символы.ПС;
				ИнфоТовар = "";
				
				//Сначала ищем остатки по адресному регистру...
				ЗапросОстатковАдресный = Новый Запрос;
				ЗапросОстатковАдресный.УстановитьПараметр("ТекущаяНоменклатура", ВыборкаРезультатПоискаТовара.Номенклатура);
				ЗапросОстатковАдресный.УстановитьПараметр("ТекущаяХарактеристика", ВыборкаРезультатПоискаТовара.Характеристика);
				
				СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
				ЗапросОстатковАдресный.УстановитьПараметр("Склады", СписокСкладов);
				ЗапросОстатковАдресный.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
				
				СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
				ЗапросОстатковАдресный.УстановитьПараметр("Помещения", СписокПомещений);
				ЗапросОстатковАдресный.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
				
				ЗапросОстатковАдресный.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	ТоварыВЯчейкахОстатки.Ячейка.Владелец КАК Склад,
				|	ТоварыВЯчейкахОстатки.Ячейка.Помещение КАК Помещение,
				|	ТоварыВЯчейкахОстатки.Ячейка,
				|	ТоварыВЯчейкахОстатки.Номенклатура,
				|	ТоварыВЯчейкахОстатки.Характеристика,
				|	ТоварыВЯчейкахОстатки.Серия,
				|	ТоварыВЯчейкахОстатки.Упаковка,
				|	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток) - СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) КАК КоличествоОстаток
				|ИЗ
				| 	РегистрНакопления.ТоварыВЯчейках.Остатки(
				|   	,
				|   	Номенклатура = &ТекущаяНоменклатура
				|   	 И Характеристика = &ТекущаяХарактеристика) КАК ТоварыВЯчейкахОстатки
				|ГДЕ
				| (&ВсеСклады ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Владелец В (&Склады))
				| И (&ВсеПомещения ИЛИ ТоварыВЯчейкахОстатки.Ячейка.Помещение В (&Помещения))   
				|СГРУППИРОВАТЬ ПО
				|	ТоварыВЯчейкахОстатки.Ячейка.Владелец,
				|	ТоварыВЯчейкахОстатки.Ячейка.Помещение,
				|	ТоварыВЯчейкахОстатки.Ячейка,
				|	ТоварыВЯчейкахОстатки.Номенклатура,
				|	ТоварыВЯчейкахОстатки.Характеристика,
				|	ТоварыВЯчейкахОстатки.Серия,
				|	ТоварыВЯчейкахОстатки.Упаковка
				|ИМЕЮЩИЕ
				| 	СУММА(ТоварыВЯчейкахОстатки.ВНаличииОстаток) - СУММА(ТоварыВЯчейкахОстатки.КОтборуОстаток) <> 0 
				|УПОРЯДОЧИТЬ ПО
				|	ТоварыВЯчейкахОстатки.Ячейка.Владелец ВОЗР,
				|	ТоварыВЯчейкахОстатки.Ячейка ВОЗР,
				|	ТоварыВЯчейкахОстатки.Номенклатура ВОЗР,
				|	ТоварыВЯчейкахОстатки.Характеристика ВОЗР,
				|	ТоварыВЯчейкахОстатки.Серия ВОЗР,
				|	ТоварыВЯчейкахОстатки.Упаковка ВОЗР";
				
				ВыборкаРезультатЗапросаОстатковАдресный = ЗапросОстатковАдресный.Выполнить().Выбрать();
				Если ВыборкаРезультатЗапросаОстатковАдресный.Количество() > 0 Тогда
					
					ТекущийСклад = Справочники.Склады.ПустаяСсылка();
					ТекущееПомещение = Справочники.СкладскиеПомещения.ПустаяСсылка();
					ТекущаяЯчейка = Справочники.СкладскиеЯчейки.ПустаяСсылка();
					
					Пока ВыборкаРезультатЗапросаОстатковАдресный.Следующий() Цикл
						
						Если ВыборкаРезультатЗапросаОстатковАдресный.Склад <> ТекущийСклад Тогда 
							ТекущийСклад = ВыборкаРезультатЗапросаОстатковАдресный.Склад;
							
							ИнфоТовар = ИнфоТовар + Символы.ПС + ВыборкаРезультатЗапросаОстатковАдресный.Склад + Символы.ПС;
						КонецЕсли;
						
						Если ВыборкаРезультатЗапросаОстатковАдресный.Помещение <> ТекущееПомещение И ЗначениеЗаполнено(ВыборкаРезультатЗапросаОстатковАдресный.Помещение) Тогда 
							ТекущееПомещение = ВыборкаРезультатЗапросаОстатковАдресный.Помещение;
							
							ИнфоТовар = ИнфоТовар + Символы.ПС + ВыборкаРезультатЗапросаОстатковАдресный.Помещение + Символы.ПС;
						КонецЕсли;
						
						Если ВыборкаРезультатЗапросаОстатковАдресный.Ячейка <> ТекущаяЯчейка Тогда 
							ТекущаяЯчейка = ВыборкаРезультатЗапросаОстатковАдресный.Ячейка;
							ТекущаяЯчейкаНаименование = ?(УзелПО.ВыгружатьВНаименованиеЯчейки = 0, ЧистаяСтрока(ВыборкаРезультатЗапросаОстатковАдресный.Ячейка.Наименование), ВыборкаРезультатЗапросаОстатковАдресный.Ячейка.Код);
							
							ИнфоТовар = ИнфоТовар + Символы.ПС + ТекущаяЯчейкаНаименование + Символы.ПС;
						КонецЕсли;
												
						ИнфоТовар = ИнфоТовар + ВыборкаРезультатЗапросаОстатковАдресный.КоличествоОстаток + " "
						+ ВыборкаРезультатЗапросаОстатковАдресный.Упаковка + "; " 
						+ ВыборкаРезультатЗапросаОстатковАдресный.Серия + Символы.ПС;
						
						НетНаОстатках = Ложь;					  
					КонецЦикла;
					
					ИнфоТовар = ИнфоТовар + Символы.ПС + Символы.ПС + Символы.ПС;
				КонецЕсли;	
												
				//Затем по обычному регистру на оставщихся складах...
				ЗапросОстатков = Новый Запрос;
				ЗапросОстатков.УстановитьПараметр("ТекущаяНоменклатура", ВыборкаРезультатПоискаТовара.Номенклатура);
				ЗапросОстатков.УстановитьПараметр("ТекущаяХарактеристика", ВыборкаРезультатПоискаТовара.Характеристика);
				
				СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
				ЗапросОстатков.УстановитьПараметр("Склады", СписокСкладов);
				ЗапросОстатков.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
				
				СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
				ЗапросОстатков.УстановитьПараметр("Помещения", СписокПомещений);
				ЗапросОстатков.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
				
				ЗапросОстатков.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
				|	ТоварыНаСкладахОстатки.Склад,
				|	ТоварыНаСкладахОстатки.Помещение КАК Помещение,
				|	ТоварыНаСкладахОстатки.Номенклатура,
				|	ТоварыНаСкладахОстатки.Характеристика,
				|	ТоварыНаСкладахОстатки.Серия,
				|	СУММА(ТоварыНаСкладахОстатки.ВНаличииОстаток) - СУММА(ТоварыНаСкладахОстатки.КОтгрузкеОстаток) КАК КоличествоОстаток
				|ИЗ
				|	РегистрНакопления.ТоварыНаСкладах.Остатки(
				|			,
				|			Номенклатура = &ТекущаяНоменклатура
				|				И Характеристика = &ТекущаяХарактеристика) КАК ТоварыНаСкладахОстатки
				|ГДЕ
				|	(&ВсеСклады ИЛИ ТоварыНаСкладахОстатки.Склад В (&Склады))
				|	И (&ВсеПомещения ИЛИ ТоварыНаСкладахОстатки.Помещение В (&Помещения)) 
				|СГРУППИРОВАТЬ ПО
				|	ТоварыНаСкладахОстатки.Склад,
				|	ТоварыНаСкладахОстатки.Помещение,
				|	ТоварыНаСкладахОстатки.Номенклатура,
				|	ТоварыНаСкладахОстатки.Характеристика,
				|	ТоварыНаСкладахОстатки.Серия
				|ИМЕЮЩИЕ
				| 	СУММА(ТоварыНаСкладахОстатки.ВНаличииОстаток)  - СУММА(ТоварыНаСкладахОстатки.КОтгрузкеОстаток) <> 0
				|УПОРЯДОЧИТЬ ПО
				|	ТоварыНаСкладахОстатки.Склад ВОЗР,
				|	ТоварыНаСкладахОстатки.Номенклатура ВОЗР,
				|	ТоварыНаСкладахОстатки.Характеристика ВОЗР,
				|	ТоварыНаСкладахОстатки.Серия ВОЗР";
				
				ВыборкаРезультатЗапросаОстатков = ЗапросОстатков.Выполнить().Выбрать();
				Если ВыборкаРезультатЗапросаОстатков.Количество() > 0 Тогда   
					
					ТекущийСклад = Справочники.Склады.ПустаяСсылка();
					ТекущееПомещение = Справочники.СкладскиеПомещения.ПустаяСсылка();
					
					Пока ВыборкаРезультатЗапросаОстатков.Следующий() Цикл
						
						Если ВыборкаРезультатЗапросаОстатков.Склад <> ТекущийСклад Тогда 
							ТекущийСклад = ВыборкаРезультатЗапросаОстатков.Склад;
							
							ИнфоТовар = ИнфоТовар + Символы.ПС + ВыборкаРезультатЗапросаОстатков.Склад + Символы.ПС;
						КонецЕсли;
						
						Если ВыборкаРезультатЗапросаОстатков.Помещение <> ТекущееПомещение И ЗначениеЗаполнено(ВыборкаРезультатЗапросаОстатков.Помещение) Тогда 
							ТекущееПомещение = ВыборкаРезультатЗапросаОстатков.Помещение;
							
							ИнфоТовар = ИнфоТовар + Символы.ПС + ВыборкаРезультатЗапросаОстатков.Помещение + Символы.ПС;
						КонецЕсли;
						
						ИнфоТовар = ИнфоТовар + ВыборкаРезультатЗапросаОстатков.КоличествоОстаток + " "
						+ ВыборкаРезультатЗапросаОстатков.Номенклатура.ЕдиницаИзмерения + "; "
						+ ВыборкаРезультатЗапросаОстатков.Серия + Символы.ПС;
						
						НетНаОстатках = Ложь;
					КонецЦикла;
				КонецЕсли;	
				
				//Нет остатков...
				Если НетНаОстатках Тогда
					ИнфоТовар = "Остатков не числится...";
				КонецЕсли;				
				
				СтрокаВозврата = ИмяТовара + ИнфоТовар;
			КонецЦикла;
			
			СтруктураОтвета.Вставить("data", СтрокаВозврата);
			
			Возврат ПодготовитьОтветJSON(СтруктураОтвета);			
		Иначе 			
			СтруктураОтвета.Вставить("data", "По штрихкоду данных не найдено...");
			Возврат ПодготовитьОтветJSON(СтруктураОтвета);
		КонецЕсли;
		
	КонецЕсли;	
	
КонецФункции	

//Получение состояния акцизной марки.
//
// Параметры: 
// Марка - Строка - Акцизная марка. 
// 
// Возвращаемое значение:
//   Структура данных.
//
Функция ПолучитьСостояниеАкцизнойМарки(ИдентификаторМарки = "")
		
	PDFBarcode = ИдентификаторМарки;
	СтруктураДанных = Новый Структура("АлкогольнаяПродукция, СправкаБ, Статус");
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда
		ЗапросЕГАИС = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
		|	астМаркиЕГАИС.НоменклатураЕГАИС.Ссылка КАК АлкогольнаяПродукция,
		|	"""" КАК СправкаБ,
		|	"""" КАК Статус
		|ИЗ
		|	Справочник.астМаркиЕГАИС КАК астМаркиЕГАИС
		|ГДЕ
		|	астМаркиЕГАИС.Наименование = &Код
		|	И НЕ астМаркиЕГАИС.ПометкаУдаления");
		ЗапросЕГАИС.УстановитьПараметр("Код", PDFBarcode);
		Результат = ЗапросЕГАИС.Выполнить().Выбрать();
		Если Результат.Следующий() Тогда
			ЗаполнитьЗначенияСвойств(СтруктураДанных, Результат);
			Возврат СтруктураДанных;
		КонецЕсли;
		
		Если стрДлина(PDFBarcode) = 68 Тогда
			Алкокод = КодНоменклатурыЕГАИСПоPDF417(PDFBarcode);	
			ЗапросЕГАИС = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
			|	ЕГАИС_Номенклатура.Ссылка КАК АлкогольнаяПродукция,
			|	"""" КАК СправкаБ,
			|	"""" КАК Статус
			|ИЗ
			|	Справочник.астНоменклатураЕГАИС КАК ЕГАИС_Номенклатура
			|ГДЕ
			|	ЕГАИС_Номенклатура.Код = &Код
			|	И НЕ ЕГАИС_Номенклатура.ПометкаУдаления");
			
			ЗапросЕГАИС.УстановитьПараметр("Код", Алкокод);
			
			Результат = ЗапросЕГАИС.Выполнить().Выбрать();
			Если Результат.Следующий() Тогда
				ЗаполнитьЗначенияСвойств(СтруктураДанных, Результат);
				Возврат СтруктураДанных;
			КонецЕсли;
		КонецЕсли;
		
	ИначеЕсли ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
		ЗапросЕГАИС = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
		|	МаркиЕГАИС.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
		|	МаркиЕГАИС.СправкаБ КАК СправкаБ,
		|	"""" КАК Статус
		|ИЗ
		|	РегистрСведений.алкХранилищеАкцизныхМарок.СрезПоследних(, Марка = &Упаковка) КАК МаркиЕГАИС
		|");
		ЗапросЕГАИС.УстановитьПараметр("Код", PDFBarcode);
		
		Результат = ЗапросЕГАИС.Выполнить().Выбрать();
		Если Результат.Следующий() Тогда
			ЗаполнитьЗначенияСвойств(СтруктураДанных, Результат);
			Возврат СтруктураДанных;
		КонецЕсли;		
	Иначе
		ЗапросЕГАИС = Новый Запрос(
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ЕГАИС_РегистрМарок.АлкогольнаяПродукция.Ссылка КАК АлкогольнаяПродукция,
		|	ЕГАИС_РегистрМарок.Справка2 КАК СправкаБ,
		|	ЕГАИС_РегистрМарок.Статус КАК Статус
		|ИЗ
		|	РегистрСведений.АкцизныеМаркиЕГАИС КАК ЕГАИС_РегистрМарок
		|ГДЕ
		|	ЕГАИС_РегистрМарок.АкцизнаяМарка = &ЕГАИС_Код
		|	И НЕ ЕГАИС_РегистрМарок.АлкогольнаяПродукция.ПометкаУдаления");
		МаркаСсылка = Справочники.ШтрихкодыУпаковокТоваров.НайтиПоРеквизиту("ЗначениеШтрихкода", PDFBarcode);
		ЗапросЕГАИС.УстановитьПараметр("ЕГАИС_Код", МаркаСсылка);		
		
		Результат = ЗапросЕГАИС.Выполнить().Выбрать();
		Если Результат.Следующий() Тогда
			ЗаполнитьЗначенияСвойств(СтруктураДанных, Результат);
			Возврат СтруктураДанных;
		КонецЕсли;
				
		Если стрДлина(PDFBarcode) = 68 Тогда 
			
			ЗапросЕГАИС = Новый Запрос(
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	ЕГАИС_Номенклатура.Ссылка КАК АлкогольнаяПродукция,
			|	ЗНАЧЕНИЕ(Справочник.Справки2ЕГАИС.ПустаяСсылка) КАК СправкаБ,
			|	ЗНАЧЕНИЕ(Перечисление.СтатусыАкцизныхМарок.ПустаяСсылка) КАК Статус
			|ИЗ
			|	Справочник.КлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_Номенклатура
			|ГДЕ
			|	ЕГАИС_Номенклатура.Код = &Код
			|	И НЕ ЕГАИС_Номенклатура.ПометкаУдаления");
			Алкокод=КодНоменклатурыЕГАИСПоPDF417(PDFBarcode);
			ЗапросЕГАИС.УстановитьПараметр("Код", Алкокод);
			
			Результат = ЗапросЕГАИС.Выполнить().Выбрать();
			Если Результат.Следующий() Тогда
				ЗаполнитьЗначенияСвойств(СтруктураДанных, Результат);
				Возврат СтруктураДанных;
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти

#Область ПланОбмена

//Поиск ТСД.
//
// Параметры: 
// SN - Строка - Идентификатор устройства. 
// 
// Возвращаемое значение:
//   Ссылка на ТСД.
//
Функция НайтиУзел(SN)
	
	Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
	|	ДатаМобайл_СписокТСД.Ссылка
	|ИЗ
	|	ПланОбмена.ДатаМобайл_СписокТСД КАК ДатаМобайл_СписокТСД
	|ГДЕ
	|	ДатаМобайл_СписокТСД.Код = &Код");
	Запрос.УстановитьПараметр("Код", SN);
	Рез = Запрос.Выполнить().Выбрать();
	
	Если Рез.Следующий() Тогда
		Возврат Рез.Ссылка;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции	

//Запись нового ТСД.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// 
// Возвращаемое значение:
//   Ссылка на ТСД.
//
Функция NewTSD(SN, UserName)
	
	НовыйТСД = ПланыОбмена.ДатаМобайл_СписокТСД.СоздатьУзел();
	НовыйТСД.Код = SN;
	НовыйТСД.Наименование = SN;
	НовыйТСД.Записать();
	
	Если ЗначениеЗаполнено(НовыйТСД.Ссылка) Тогда
		ДатаМобайл_ОбщийМодуль.ЗаписьЗначенийУзлаОбменаТСД(НовыйТСД.Ссылка, "ТекущийПользователь", UserName);
	КонецЕсли;
	
	Возврат НовыйТСД.Ссылка;
	
КонецФункции

//Получение данных атрибутов ТСД.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// 
// Возвращаемое значение:
//   Структура данных атрибутов.
//
Функция ПолучитьАтрибуты(УзелПО) Экспорт
	
	СтруктураАтрибутов = Новый Структура;
	СтруктураАтрибутов.Вставить("ИмяАтрибута1", 	"");
	СтруктураАтрибутов.Вставить("ИмяАтрибута2", 	"");
	СтруктураАтрибутов.Вставить("ИмяАтрибута3", 	"");
	СтруктураАтрибутов.Вставить("ИмяАтрибута4", 	"");
	СтруктураАтрибутов.Вставить("ИмяАтрибута5", 	"");
	СтруктураАтрибутов.Вставить("ИмяАтрибута6", 	"");
	СтруктураАтрибутов.Вставить("ИмяАтрибута7", 	"");
	СтруктураАтрибутов.Вставить("ИмяАтрибута8", 	"");
	СтруктураАтрибутов.Вставить("ИмяАтрибута9", 	"");
	СтруктураАтрибутов.Вставить("ИмяАтрибута10", 	"");
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ДатаМобайл_ЗначенияУзлаОбменаТСД.ТипЗначения КАК ТипЗначения,
	|	ДатаМобайл_ЗначенияУзлаОбменаТСД.Значение КАК Значение
	|ИЗ
	|	РегистрСведений.ДатаМобайл_ЗначенияУзлаОбменаТСД КАК ДатаМобайл_ЗначенияУзлаОбменаТСД
	|ГДЕ
	|	ДатаМобайл_ЗначенияУзлаОбменаТСД.ТСД = &ТСД
	|	И ДатаМобайл_ЗначенияУзлаОбменаТСД.ТипЗначения ПОДОБНО ""ИмяАтрибута%""");
	
	Запрос.УстановитьПараметр("ТСД", УзелПО);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если Выборка.ТипЗначения = "ИмяАтрибута1" Тогда
			СтруктураАтрибутов.ИмяАтрибута1 = Выборка.Значение;
		ИначеЕсли Выборка.ТипЗначения = "ИмяАтрибута2" Тогда
			СтруктураАтрибутов.ИмяАтрибута2 = Выборка.Значение;
		ИначеЕсли Выборка.ТипЗначения = "ИмяАтрибута3" Тогда
			СтруктураАтрибутов.ИмяАтрибута3 = Выборка.Значение;
		ИначеЕсли Выборка.ТипЗначения = "ИмяАтрибута4" Тогда
			СтруктураАтрибутов.ИмяАтрибута4 = Выборка.Значение;
		ИначеЕсли Выборка.ТипЗначения = "ИмяАтрибута5" Тогда
			СтруктураАтрибутов.ИмяАтрибута5 = Выборка.Значение;
		ИначеЕсли Выборка.ТипЗначения = "ИмяАтрибута6" Тогда
			СтруктураАтрибутов.ИмяАтрибута6 = Выборка.Значение;
		ИначеЕсли Выборка.ТипЗначения = "ИмяАтрибута7" Тогда
			СтруктураАтрибутов.ИмяАтрибута7 = Выборка.Значение;
		ИначеЕсли Выборка.ТипЗначения = "ИмяАтрибута8" Тогда
			СтруктураАтрибутов.ИмяАтрибута8 = Выборка.Значение;
		ИначеЕсли Выборка.ТипЗначения = "ИмяАтрибута9" Тогда
			СтруктураАтрибутов.ИмяАтрибута9 = Выборка.Значение;
		ИначеЕсли Выборка.ТипЗначения = "ИмяАтрибута10" Тогда
			СтруктураАтрибутов.ИмяАтрибута10 = Выборка.Значение;	
		КонецЕсли;		
	КонецЦикла;
	
	Возврат СтруктураАтрибутов;	
	
КонецФункции

//Установка значения из строки.
//
// Параметры: 
// НоменклатураОбъект - СправочникОбъект.Номенклатура - Номенклатура.
// ИмяРеквизита - Строка - Имя реквизита.
// НовоеЗначениеРеквизитаСтрокой - Строка - Новое значение реквизита строкой.
// ТекстОшибки - Строка - Описание ошибки (по умолчанию - пустая строка).
// 
// Возвращаемое значение:
//   Структура данных атрибутов.
//
Процедура УстановитьЗначениеИЗСтроки(НоменклатураОбъект, ИмяРеквизита, НовоеЗначениеРеквизитаСтрокой, ТекстОшибки = "") Экспорт
	
	Если ИмяРеквизита = "Код" Тогда
		ТипРеквизита = Новый ОписаниеТипов("Строка");
	Иначе	
		ТипРеквизита = Метаданные.Справочники.Номенклатура.Реквизиты[ИмяРеквизита].Тип;	
	КонецЕсли; 
	
	Если ТипРеквизита = Новый ОписаниеТипов("Строка") Или ТипРеквизита.СодержитТип(Тип("Строка")) Тогда
		НоменклатураОбъект[ИмяРеквизита] = НовоеЗначениеРеквизитаСтрокой;
	ИначеЕсли ТипРеквизита = Новый ОписаниеТипов("Булево") Или ТипРеквизита.СодержитТип(Тип("Булево")) Тогда
		Если НовоеЗначениеРеквизитаСтрокой = "Да" Или НовоеЗначениеРеквизитаСтрокой = "Нет" Тогда
			НоменклатураОбъект[ИмяРеквизита] = Булево(НовоеЗначениеРеквизитаСтрокой);
		Иначе
			ТекстОшибки = ТекстОшибки + "Не удалось установить значение для реквизита '" + ИмяРеквизита + "' - возможны только строки Да или Нет" + Символы.ПС;
		КонецЕсли;
	ИначеЕсли ТипРеквизита = Новый ОписаниеТипов("Число") Или ТипРеквизита.СодержитТип(Тип("Число")) Тогда
		Попытка
			НоменклатураОбъект[ИмяРеквизита] = Число(СтрЗаменить(СтрЗаменить(НовоеЗначениеРеквизитаСтрокой, " ", ""), " ", ""));
		Исключение
			ТекстОшибки = ТекстОшибки + "Не удалось установить значение для реквизита '" + ИмяРеквизита + "' - неизвестный формат числа" + Символы.ПС;
		КонецПопытки;
	ИначеЕсли ТипРеквизита = Новый ОписаниеТипов("Дата") Или ТипРеквизита.СодержитТип(Тип("Дата")) Тогда
		Попытка
			НоменклатураОбъект[ИмяРеквизита] = Дата(НовоеЗначениеРеквизитаСтрокой);
		Исключение
			ТекстОшибки = ТекстОшибки + "Не удалось установить значение для реквизита '" + ИмяРеквизита + "' - неизвестный формат даты" + Символы.ПС;
		КонецПопытки;
	Иначе
		
		// Типы Справочник и перечисление, варианты с составнымы типами или определяемым типом не рассматриваем
		МетаданныеРеквизита = Метаданные.НайтиПоТипу(ТипЗнч(НоменклатураОбъект[ИмяРеквизита]));
		Если МетаданныеРеквизита <> Неопределено Тогда
			
			ПолноеИмя = МетаданныеРеквизита.ПолноеИмя();
			Если Лев(ПолноеИмя, 13) = "Перечисление." Тогда
				Попытка
					НоменклатураОбъект[ИмяРеквизита] = ПредопределенноеЗначение(ПолноеИмя + "." + НовоеЗначениеРеквизитаСтрокой);
				Исключение
					ТекстОшибки = ТекстОшибки + "Не удалось установить значение для реквизита '" + ИмяРеквизита + "' - неизвестное значение перечисления" + Символы.ПС;
				КонецПопытки;
			ИначеЕсли Лев(ПолноеИмя, 11) = "Справочник." Тогда
				
				ЕстьОшибка = Ложь;
				Попытка
					ИмяСправочника = Прав(ПолноеИмя, СтрДлина(ПолноеИмя) - 11);
					Ссылка = Справочники[ИмяСправочника].НайтиПоНаименованию(НовоеЗначениеРеквизитаСтрокой, Истина);
					Если ЗначениеЗаполнено(Ссылка) Тогда
						НоменклатураОбъект[ИмяРеквизита] = Ссылка;
					Иначе
						ЕстьОшибка = Истина;
					КонецЕсли;
				Исключение
					ЕстьОшибка = Истина;
				КонецПопытки;
				
				Если ЕстьОшибка Тогда
					ТекстОшибки = ТекстОшибки + "Не удалось установить значение для реквизита '" + ИмяРеквизита + "' - справочник не найден" + Символы.ПС;
				КонецЕсли;
				
			Иначе
				ТекстОшибки = ТекстОшибки + "Не удалось установить значение для реквизита '" + ИмяРеквизита + "' - неизвестный тип реквизита" + Символы.ПС;
			КонецЕсли;
		Иначе
			ТекстОшибки = ТекстОшибки + "Не удалось установить значение для реквизита '" + ИмяРеквизита + "' - неизвестный тип реквизита" + Символы.ПС;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

//Получение доп. реквизита атрибута.
//
// Параметры: 
// Номенклатура - СправочникСсылка.Номенклатура - Номенклатура.
// НаименованиеСвойства - Строка - Наименование свойства.
// 
// Возвращаемое значение:
//   Строка со значением.
// 
Функция ПолучитьДополнительныйРеквизитАтрибута(Номенклатура, НаименованиеСвойства)
	
	Запрос = Новый Запрос();
	Запрос.Текст = "ВЫБРАТЬ 
	
	|ВЫБОР 
	|	КОГДА 
	|		ВЫРАЗИТЬ(ЕСТЬNULL(СправочникНоменклатураДополнительныеРеквизиты.Значение.Наименование,"""") КАК СТРОКА (100)) = """" 
	|	ТОГДА 
	|		СправочникНоменклатураДополнительныеРеквизиты.Значение 
	|	ИНАЧЕ
	|   	ВЫРАЗИТЬ(СправочникНоменклатураДополнительныеРеквизиты.Значение.Наименование КАК СТРОКА (100)) 
	|КОНЕЦ КАК Значение
	|ИЗ
	|Справочник.Номенклатура.ДополнительныеРеквизиты КАК СправочникНоменклатураДополнительныеРеквизиты
	|ГДЕ 
	|СправочникНоменклатураДополнительныеРеквизиты.Ссылка = &Номенклатура
	|И СправочникНоменклатураДополнительныеРеквизиты.Свойство.Заголовок = &НаименованиеСвойства";
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("НаименованиеСвойства", СтрЗаменить(НаименованиеСвойства, "ДР_", ""));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат ЧистаяСтрока(Выборка.Значение);
	Иначе
		Возврат "";
	КонецЕсли;	
	
КонецФункции

#КонецОбласти

#Область Штрихкодирование

Функция ПолучитьГУИДПоШтрихкоду(Barcode)
	
	Штрихкод16 = ДатаМобайл_ОбщийМодуль.ПреобразоватьДесятичноеЧислоВШестнадцатиричнуюСистемуСчисления(Barcode);
	
	Если СтрДлина(Штрихкод16) < 32 Тогда
		
		Пока СтрДлина(Штрихкод16) < 32 Цикл
			Штрихкод16 = Строка("0") + Штрихкод16;
		КонецЦикла;
		
	КонецЕсли;
	
	ГУИД = Сред(Штрихкод16, 1,  8)
	+ "-" + Сред(Штрихкод16, 9,  4)
	+ "-" + Сред(Штрихкод16, 13, 4)
	+ "-" + Сред(Штрихкод16, 17, 4)
	+ "-" + Сред(Штрихкод16, 21, 12);
	
	Возврат ГУИД;
	
КонецФункции	

//Преобразование ссылки в числовой код.
//
// Параметры: 
// Ссылка - Ссылка - Ссылка на объект метаданных. 
// 
// Возвращаемое значение:
//   Число, содержащее преобразованное значение GIUD ссылки.
//
Функция ЧисловойКодПоСсылке(Ссылка)
	
	ШестнадчатиричноеЧисло = СтрЗаменить(Строка(Ссылка.УникальныйИдентификатор()), "-", "");
	Возврат ПреобразоватьИзШестнадцатиричнойСистемыСчисленияВДесятичноеЧисло(ШестнадчатиричноеЧисло);
	
КонецФункции

//Преобразование из шестнадцатиричной системы исчисления в десятичное число.
//
// Параметры: 
// Значение - Строка - Значение в шестнадцатиричной системе исчисления. 
// 
// Возвращаемое значение:
//   Число, содержащее значение в десятичной системе исчисления.
//
Функция ПреобразоватьИзШестнадцатиричнойСистемыСчисленияВДесятичноеЧисло(Знач Значение)
	
	Значение = НРег(Значение);
	ДлинаСтроки = СтрДлина(Значение);
	
	Результат = 0;
	Для НомерСимвола = 1 По ДлинаСтроки Цикл
		Результат = Результат * 16 + Найти("0123456789abcdef", Сред(Значение, НомерСимвола, 1)) - 1;
	КонецЦикла;
	
	Возврат Формат(Результат, "ЧГ=0");
	
КонецФункции

Функция КонтрольныйСимволEAN(ШтрихКод, Тип)
	
	Четн   = 0;
	Нечетн = 0;
	
	КоличествоИтераций = ?(Тип = 13 Или Тип = 14, 6, 4);
	
	Для Индекс = 1 По КоличествоИтераций Цикл
		Если (Тип = 8) И (Индекс = КоличествоИтераций) Тогда
		Иначе
			Четн = Четн + Сред(ШтрихКод, 2 * Индекс, 1);
		КонецЕсли;
		Нечетн = Нечетн + Сред(ШтрихКод, 2 * Индекс - 1, 1);
	КонецЦикла;
	
	Если Тип = 14 Тогда
		Нечетн = Нечетн + Сред(ШтрихКод, 13, 1);
		Нечетн = Нечетн * 3;
	ИначеЕсли Тип = 13 Тогда
		Четн = Четн * 3;
	Иначе
		Нечетн = Нечетн * 3;
	КонецЕсли;
	
	КонтЦифра = 10 - (Четн + Нечетн) % 10;
	
	Возврат ?(КонтЦифра = 10, "0", Строка(КонтЦифра));
	
КонецФункции // КонтрольныйСимволEAN()

#КонецОбласти

#Область Документы

//Создание документа ТСД.
//
// Параметры: 
// SN - Строка - Идентификатор устройства.
// UserName - Строка - Имя пользователя.
// DocOutID - Строка - Id документа ТСД.
// TemplateID - Строка - Id шаблона.
// 
// Возвращаемое значение:
//   Ссылка на созданный документ ТСД.
//
Функция СоздатьДокумент(SN, UserName, DocOutID, TemplateID) 
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);  
	КонецЕсли;
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ДатаМобайл_ШаблоныДокументов.Ссылка КАК ШаблонСсылка
	|ИЗ
	|	Справочник.ДатаМобайл_ШаблоныДокументов КАК ДатаМобайл_ШаблоныДокументов
	|ГДЕ
	|	ДатаМобайл_ШаблоныДокументов.Код = &ИД");
	Запрос.УстановитьПараметр("ИД", TemplateID);
	Рез = Запрос.Выполнить().Выбрать();
	Если Рез.Следующий() Тогда
		Док = Справочники.ДатаМобайл_ДокументыТСД.СоздатьЭлемент();
		Док.УстановитьНовыйКод();
		Док.Шаблон = Рез.ШаблонСсылка;
		Док.ДатаСоздания = ТекущаяДата();
		Док.ДатаНачалаСбора = ТекущаяДата();
		
		Если Не (Док.Шаблон.ГрупповаяРабота) Тогда
			Док.ТСД = УзелПО;
		КонецЕсли;
		
		Док.Дата = ТекущаяДата();
		Док.Номер = "DMO-" + Формат(Док.код, "ЧДЦ=2; ЧРД=.; ЧН=0; ЧГ=0");
		Док.Комментарий = DocOutID;
		Док.Записать();
		
		Возврат Док.Ссылка;
	Иначе	
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

//Заполнение объекта шаблона.
//
// Параметры: 
// ОбъектШаблона - Структура - Структура объекта шаблона.
// ШаблонСсылка - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон.
// AppVersion - Строка - Версия ПО.
// 
Процедура ЗаполнитьОбъектШаблона(ОбъектШаблона, ШаблонСсылка, AppVersion)
	
	Модуль_СтроковыеФункцииКлиентСервер = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("СтроковыеФункцииКлиентСервер");
	
	ВерсияПО31ИлиВыше = Ложь;
	ВерсияПО32ИлиВыше = Ложь;
	
	Попытка
		AppVersion = СтрЗаменить(AppVersion, ".", "");
		ВерсияПОЧислом = Число(Лев(AppVersion, 2));
		Если ВерсияПОЧислом = 31 Или ВерсияПОЧислом > 31 Тогда
			ВерсияПО31ИлиВыше = Истина;		
		КонецЕсли;
		
		Если ВерсияПОЧислом >= 32 Тогда
			ВерсияПО32ИлиВыше = Истина;		
		КонецЕсли;
	Исключение	
	КонецПопытки;
	
	Запрос = Новый Запрос(	
	"ВЫБРАТЬ 	
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка, ЗНАЧЕНИЕ(Справочник.ДатаМобайл_ШаблоныДокументов.ПустаяСсылка)) КАК ШаблонСсылка,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.Код, 0) КАК id,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.Наименование, """") КАК name,
	|	ИСТИНА КАК is_use_all_barcodes,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПометкаУдаления, ЛОЖЬ) КАК is_deleted,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.РазрешеноСозданиеНаТСД, ЛОЖЬ) КАК is_allow_create_on_device,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ОбновлятьПриКаждомОткрытии, ЛОЖЬ) КАК is_load_rows_on_open_doc,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ОбновлятьТоварыСДокументом, ЛОЖЬ) КАК is_load_arts_with_doc,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ЗапретитьРучноеИзменениеКлиента, ЛОЖЬ) КАК is_disable_manual_change_client,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ЗапретитьИзменениеКлиентаКардРидером, ЛОЖЬ) КАК is_disable_reader_change_client,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.КардРидер_Трек1, ЛОЖЬ) КАК is_reader_track_1_use,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.КардРидер_Трек2, ЛОЖЬ) КАК is_reader_track_2_use,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.КардРидер_Трек3, ЛОЖЬ) КАК is_reader_track_3_use,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ГенерацияПаклистаНаСервере, 0) КАК pack_list_generate_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ШтрихкодыТолькоПоШаблонам, ЛОЖЬ) КАК is_use_barcode_templates,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПриемкаПоПодбору, ЛОЖЬ) КАК is_use_select_log_as_insert_task,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПриПриемкеЗапрашиватьТовар, ЛОЖЬ) КАК is_scan_art_again,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.РазрешитьВыгрузкуНеполногоДокумента, 0) КАК unload_incorrect_doc_action,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.РазрешитьВыгрузкуНеполногоДокументаВариант, 0) КАК unload_incorrect_doc_option,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПоштучноеПеремещение, 0) КАК is_from_select_to_insert_art_by_art,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПриСканированииНовогоТовара, 0) КАК new_art_action,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ГрупповаяРабота, ЛОЖЬ) КАК is_multi_doc,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ГрупповаяРаботаЗвуковоеОповещение, ЛОЖЬ) КАК is_play_multi_doc_sound,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ГрупповаяРаботаИнтервалОпроса, 0) КАК multi_doc_timeout,		
	|	ЛОЖЬ КАК is_use_online_arts_catalog, 
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПроверкаОСГ, Ложь) КАК is_check_remaining_expiration_date,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.КаталогТоваров, 0) КАК online_arts_catalog,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ОповеститьОНовомДокументе, ЛОЖЬ) КАК is_notify_getting_doc,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ВводТовараБезСканирования, ЛОЖЬ) КАК is_manual_apply_art,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ВводЯчейкиБезСканирования, ЛОЖЬ) КАК is_manual_apply_cell,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.УдалитьОстатокЗаданияПослеВводаСтроки, ЛОЖЬ) КАК is_delete_left_task_qty,
	|   1 = 1,
	|	2 = 2, 
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ДополнительныеФормыОнлайнОбновлениеСправочника, ЛОЖЬ) КАК is_update_forms_from_server,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.РазрешитьПропускатьВводУпаковочногоЛиста, ЛОЖЬ) КАК is_can_skip_pack,	
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ВыгружатьВыполненныйНаТСДДокументАвтоматически, ЛОЖЬ) КАК is_unload_completed_doc,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ВыгружатьВыполненныйНаТСДДочернийДокументАвтоматически, ЛОЖЬ) КАК is_unload_completed_child_doc,	 
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.МаркировкаКоличествоЕдиницВУпаковкеПриАгрегации, 0) КАК required_pack_qty,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ЗагружатьСписокСерийССервера, ЛОЖЬ) КАК is_get_sn_list_from_server,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользоватьВторойСклад, ЛОЖЬ) КАК is_use_second_warehouse,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПроверкаУпаковокПоЗаданию, ЛОЖЬ) КАК is_check_unit_task,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ЗагрузкаСтрокПодбораСДокументами, ЛОЖЬ) КАК is_load_doc_logs,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ТипБизнесПроцесса, 0) КАК process_id,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.Описание, """") КАК description,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.РежимСозданияДокументов, 0) КАК create_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ОбязательноеЗаполнениеСклада, ЛОЖЬ) КАК is_warehouse_required,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ОбязательноеЗаполнениеКонтрагента, ЛОЖЬ) КАК is_client_required,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПроверкаВложенностиУпаковок, 0) КАК selective_check_pack_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ЗапретИзменениеСклада, ЛОЖЬ) КАК is_disable_manual_change_warehouse
	|	ПОМЕСТИТЬ ОбщиеНастройки
	|ИЗ
	|	Справочник.ДатаМобайл_ШаблоныДокументов КАК ДатаМобайл_ШаблоныДокументов
	|ГДЕ
	|	ДатаМобайл_ШаблоныДокументов.Ссылка = &ШаблонСсылка
	|;
	|  	ВЫБРАТЬ 
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользоватьПодбор, ЛОЖЬ) КАК is_use_operation,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПриСканированииТовараПодбор, 0) КАК art_scan_action,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПриПревышенииЗаданияПодбор, 0) КАК task_exceed_action,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПриПревышенииЛимитаПодбор, 0) КАК limit_exceed_action,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользованиеЯчеекПодбор, 0) КАК use_cell_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользованиеУпаковочныхЛистовПодбор, 0) КАК use_pack_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.УчитыватьЯчеекВЗаданииПодбор, ЛОЖЬ) КАК is_check_cell_by_task,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.УчитыватьСерийниковВЗаданииПодбор, ЛОЖЬ) КАК is_check_sn_by_task,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.РучнойВводКоличестваПодбор, ЛОЖЬ) КАК is_manual_quantity,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПодтверждатьЭнтеромПодбор, ЛОЖЬ) КАК is_enter_to_commit,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ОтсылатьГотовуюЗаписьНаСерверПодбор, ЛОЖЬ) КАК is_send_row_to_server,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПечатьЭтикеткиПриПодборе, 0) КАК print_label_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользованиеСерийниковПодбор, 0) КАК use_sn_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ВыгрузкаЯчеекПодбор, 0) КАК enter_cell_type,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ЗагружатьСписокЯчеекССервераПодбор, ЛОЖЬ) КАК is_get_cells_from_server,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.УникальныеСерийныеНомераПодбор, ЛОЖЬ) КАК is_use_unique_sn,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ОбработкаЯчейкиЦеликомПодбор, ЛОЖЬ) КАК is_handle_whole_cell,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользоватьФотофиксацию, ЛОЖЬ) КАК is_use_photo_fixation,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.СерНомНеПустойПодбор, ЛОЖЬ) КАК is_require_enter_sn,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПодборПроверкаУпаковочныхЛистовПоЗаданию, ЛОЖЬ) КАК is_check_pack_by_task,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПроверкаВводаУпаковочногоЛистаПодбор, ЛОЖЬ) КАК is_verify_pack_on_server,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.РежимКомплектации, 0) КАК use_kit_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ГруппировкаСерийПодбор, 0) КАК group_sn_type,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ГруппировкаЯчеекПодбор, 0) КАК group_cell_type
	|	ПОМЕСТИТЬ Подбор
	|ИЗ
	|	Справочник.ДатаМобайл_ШаблоныДокументов КАК ДатаМобайл_ШаблоныДокументов
	|ГДЕ
	|	ДатаМобайл_ШаблоныДокументов.Ссылка = &ШаблонСсылка
	|;
	|  	ВЫБРАТЬ 
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользоватьПриемку, ЛОЖЬ) КАК is_use_operation,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПриСканированииТовараПриемка, 0) КАК art_scan_action,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПриПревышенииЗаданияПриемка, 0) КАК task_exceed_action,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПриПревышенииЛимитаПриемка, 0) КАК limit_exceed_action,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользованиеЯчеекПриемка, 0) КАК use_cell_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользованиеУпаковочныхЛистовПриемка, 0) КАК use_pack_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.УчитыватьЯчеекВЗаданииПриемка, ЛОЖЬ) КАК is_check_cell_by_task,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.УчитыватьСерийниковВЗаданииПриемка, ЛОЖЬ) КАК is_check_sn_by_task,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.РучнойВводКоличестваПриемка, ЛОЖЬ) КАК is_manual_quantity,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПодтверждатьЭнтеромПриемка, ЛОЖЬ) КАК is_enter_to_commit,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ОтсылатьГотовуюЗаписьНаСерверПриемка, ЛОЖЬ) КАК is_send_row_to_server,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПечатьЭтикеткиПриПриемке, 0) КАК print_label_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользованиеСерийниковПриемка, 0) КАК use_sn_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ВыгрузкаЯчеекПриемка, 0) КАК enter_cell_type,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ЗагружатьСписокЯчеекССервераПриемка, ЛОЖЬ) КАК is_get_cells_from_server,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.УникальныеСерийныеНомераПриемка, ЛОЖЬ) КАК is_use_unique_sn,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ОбработкаЯчейкиЦеликомПриемка, ЛОЖЬ) КАК is_handle_whole_cell,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользоватьФотофиксацию, ЛОЖЬ) КАК is_use_photo_fixation,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.СерНомНеПустойПриемка, ЛОЖЬ) КАК is_require_enter_sn,
	|	ЛОЖЬ КАК is_check_pack_by_task,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ПроверкаВводаУпаковочногоЛистаПриемка, ЛОЖЬ) КАК is_verify_pack_on_server,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.РежимКомплектации, 0) КАК use_kit_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ГруппировкаСерийПриемка, 0) КАК group_sn_type,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ГруппировкаЯчеекПриемка, 0) КАК group_cell_type
	|	ПОМЕСТИТЬ Приемка
	|ИЗ
	|	Справочник.ДатаМобайл_ШаблоныДокументов КАК ДатаМобайл_ШаблоныДокументов
	|ГДЕ
	|	ДатаМобайл_ШаблоныДокументов.Ссылка = &ШаблонСсылка
	|;
	|  	ВЫБРАТЬ 
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ЕГАИС, ЛОЖЬ) КАК is_egais_doc,
	|	ЛОЖЬ КАК is_use_bottling_date,
	|	0 КАК enter_data_matrix_mode,
	|	0 КАК enter_pdf417_barcode_mode,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.СопоставлениеЕГАИС, ЛОЖЬ) КАК is_compare,
	|	ЛОЖЬ КАК is_use_blank_a,
	|	ЛОЖЬ КАК is_use_blank_b,
	|	ЛОЖЬ КАК is_check_mark_on_server,
	|	ЛОЖЬ КАК is_get_bottling_date_from_server,
	|	1 КАК version
	|	ПОМЕСТИТЬ ЕГАИС
	|ИЗ
	|	Справочник.ДатаМобайл_ШаблоныДокументов КАК ДатаМобайл_ШаблоныДокументов
	|ГДЕ
	|	ДатаМобайл_ШаблоныДокументов.Ссылка = &ШаблонСсылка
	|;
	|  	ВЫБРАТЬ 
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользоватьМаркировку, ЛОЖЬ) КАК is_marking_doc,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.МаркировкаСканироватьEAN, 0) КАК ean_scan_type,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.МаркировкаEANсоответствуетGTIN, ЛОЖЬ) КАК is_ean_equals_gtin,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.МаркировкаИгнорироватьНесоответствиеТовараПоЕАNиКМ, ЛОЖЬ) КАК is_ignore_art_mismatch_by_ean_km,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.МаркировкаДополнительныйПоискПоКМ, ЛОЖЬ) КАК is_search_by_km,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.МаркировкаЗапретитьПодборНемаркируемыхТоваров, ЛОЖЬ) КАК is_only_mark_art,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.МаркировкаВводМаркируемогоТовараБезКМ, 0) КАК without_km_enter_type,	
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.МаркировкаПроверкаВладельцаКМ, ЛОЖЬ) КАК check_km_owner_action,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.МаркировкаПроверкаСтатусаКМ, ЛОЖЬ) КАК check_km_status_action,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИсточникСерии, 0) КАК sn_source,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.МаркировкаМетодПроверкиКМ, 0) КАК check_ki_source,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.МаркировкаРежимОСУ, 0) КАК use_osu_mode
	|	ПОМЕСТИТЬ Маркировка
	|ИЗ
	|	Справочник.ДатаМобайл_ШаблоныДокументов КАК ДатаМобайл_ШаблоныДокументов
	|ГДЕ
	|	ДатаМобайл_ШаблоныДокументов.Ссылка = &ШаблонСсылка
	|;
	|  	ВЫБРАТЬ 
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИзбраннаяОперация, 0) КАК operation,
	|	ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИзбранныеФункции, """") КАК ИзбранныеФункции
	|	ПОМЕСТИТЬ ИзбранныеДействия
	|ИЗ
	|	Справочник.ДатаМобайл_ШаблоныДокументов КАК ДатаМобайл_ШаблоныДокументов
	|ГДЕ
	|	ДатаМобайл_ШаблоныДокументов.Ссылка = &ШаблонСсылка
	|");
	
	Если ВерсияПО31ИлиВыше Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "1 = 1", "ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользоватьДопФормы, ЛОЖЬ) КАК is_use_additional_forms,
		|ВЫБОР
		|	КОГДА ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользоватьДопФормы, ЛОЖЬ) = ИСТИНА
		|		ТОГДА 1
		|	ИНАЧЕ 0
		|	КОНЕЦ КАК additional_forms_for_art_mode");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "1 = 1", "ВЫБОР
		|	КОГДА ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ИспользоватьДопФормы, ЛОЖЬ) = ИСТИНА
		|		ТОГДА ИСТИНА
		|	ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ КАК is_use_additional_forms");
	КонецЕсли; 
	
	Если ВерсияПО32ИлиВыше Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "2 = 2", "ЕСТЬNULL(ДатаМобайл_ШаблоныДокументов.Ссылка.ДополнительныеФормыГрупповойВвод, ЛОЖЬ) КАК is_group_selection_forms");
	КонецЕсли;
		
	Запрос.УстановитьПараметр("ШаблонСсылка", ШаблонСсылка);
	
	РезультатПакета = Запрос.ВыполнитьПакетСПромежуточнымиДанными();
	
	ПервыйЗапрос = РезультатПакета[0].Выгрузить();
	
	Для каждого Элемент Из ПервыйЗапрос Цикл
		ЗаполнитьЗначенияСвойств(ОбъектШаблона, Элемент);
	КонецЦикла;
	
	Если ШаблонСсылка.ИспользованиеСерийниковПодбор <> 0 Или ШаблонСсылка.ИспользованиеСерийниковПриемка <> 0 Тогда
		ОбъектШаблона.Вставить("is_multi_sn_logic", Истина);
	КонецЕсли;
		
	//unique_barcode_mode принимает значения 
	//(0. Выключено, 1. Для всех ШК, 2. Только для весовых ШК) 
	//используем только 0 и 1	
	Если ШаблонСсылка.УникальныеШтрихкодыНоменклатурыВДокументе Тогда
		ОбъектШаблона.Вставить("unique_barcode_mode", 1);
	КонецЕсли;
	
	//search_barcode_priority принимает значения
	//(0. Сначала товары, 1. Сначала задание, могут затем еще другие появиться)
	//используем только 0 и 1
	Если ШаблонСсылка.ПервичныйПоискПоШКвЗадании Тогда
		ОбъектШаблона.Вставить("search_barcode_priority", 1);
	КонецЕсли;
	
	ВторойЗапрос = РезультатПакета[1].Выгрузить();
	Для каждого Элемент Из ВторойЗапрос Цикл
		ЗаполнитьЗначенияСвойств(ОбъектШаблона.select, Элемент);
	КонецЦикла;	
	
	ТретийЗапрос = РезультатПакета[2].Выгрузить();
	Для каждого Элемент Из ТретийЗапрос Цикл
		ЗаполнитьЗначенияСвойств(ОбъектШаблона.insert, Элемент);
		
		Попытка
			Если Не ШаблонСсылка.ЗагружатьСписокЯчеекССервераПриемка И (ШаблонСсылка.ПриемкаПоПодбору И Не ШаблонСсылка.ПриПриемкеЗапрашиватьТовар И ШаблонСсылка.ВыгрузкаЯчеекПриемка = 1) Тогда
				ОбъектШаблона.insert.enter_cell_type = 0;
			КонецЕсли;
		Исключение
		КонецПопытки;
	КонецЦикла;	
	
	ЧетвертыйЗапрос = РезультатПакета[3].Выгрузить();
	Для каждого Элемент Из ЧетвертыйЗапрос Цикл
		ЗаполнитьЗначенияСвойств(ОбъектШаблона.egais, Элемент);
	КонецЦикла;	
	
	ПятыйЗапрос = РезультатПакета[4].Выгрузить();
	Для каждого Элемент Из ПятыйЗапрос Цикл
		ЗаполнитьЗначенияСвойств(ОбъектШаблона.marking, Элемент);
	КонецЦикла;
	
	ШестойЗапрос = РезультатПакета[5].Выгрузить();
	Для каждого Элемент Из ШестойЗапрос Цикл
		Если Элемент.ИзбранныеФункции <> "" Тогда
			МассивФункций = ДатаМобайл_ОбщийМодуль.РазложитьСтрокуВМассивЧисловыхПодстрокДМ(Элемент.ИзбранныеФункции);
			ОбъектШаблона.favorite.Вставить("actions", МассивФункций);
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(ОбъектШаблона.favorite, Элемент);
	КонецЦикла;
	
	Если ШаблонСсылка.МаркировкаПроверкаСтатусаКМ Тогда
		МассивРазрешенныхСтатусовКМ = ДатаМобайл_ОбщийМодуль.РазложитьСтрокуВМассивЧисловыхПодстрокДМ(ШаблонСсылка.МаркировкаРазрешенныеСтатусыКМ);
		ОбъектШаблона.marking.Вставить("allowed_statuses", МассивРазрешенныхСтатусовКМ);
	КонецЕсли; 		
	
	СтрокаРолей = "";
	ПолучитьРолиПоШаблону(ШаблонСсылка, СтрокаРолей);
	
	Если СтрокаРолей <> "" Тогда
		МассивРолей = Модуль_СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(СтрокаРолей, ",");;
		ОбъектШаблона.Вставить("roles", МассивРолей);		
	КонецЕсли; 
	
КонецПроцедуры

//Получение структуры строки документа.
//
// Параметры:     
// ИмяТаблицы - Строка - "Insert"/"Select".
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// СтрокаДокумента - Структура - Структура данных строки документа.
// UserName - Строка - Имя пользователя.
// ВызовИзWriteDoc - Булево - Вызов из WriteDoc
// 
// Возвращаемое значение:
//   Структура данных строки.
//
Функция ПолучитьСтруктуруСтрокиДокумента(ИмяТаблицы, УзелПО, СсылкаНаДок, СтрокаДокумента, UserName, ВызовИзWriteDoc = Ложь)
	
	Шаблон = СсылкаНаДок.Шаблон;
	ИспользоватьМаркировку 	= Шаблон.ИспользоватьМаркировку;
	ИспользоватьЕГАИС 		= Шаблон.ЕГАИС;
	ЗаписыватьПолныйКМ 		= Шаблон.МаркировкаЗаписыватьПолныйКМ;
		
	СтруктураСтроки = Новый Структура;
	СтруктураСтроки.Вставить("ДокументТСД", 	 	СсылкаНаДок);
	СтруктураСтроки.Вставить("ИмяТаблицы", 			ИмяТаблицы);	
	СтруктураСтроки.Вставить("ИдентификаторСтроки", Число(СтрокаДокумента.row_id));
	СтруктураСтроки.Вставить("Штрихкод",			СтрокаДокумента.barcode.value);
	Попытка СтруктураСтроки.Вставить("ИдентификаторЕдИзм",	СтрокаДокумента.barcode.unit_id); Исключение СтруктураСтроки.Вставить("ИдентификаторЕдИзм", ""); КонецПопытки;
	СтруктураСтроки.Вставить("Уникальность",		Новый УникальныйИдентификатор());	
	СтруктураСтроки.Вставить("Ячейка", 				СтрокаДокумента.cell.barcode);
	Если ИспользоватьЕГАИС Тогда
		СтруктураСтроки.Вставить("КодТовара", 			СтрокаДокумента.egais_art.id);
		СтруктураСтроки.Вставить("НазваниеТовара",		СтрокаДокумента.egais_art.name);
	Иначе	 
		СтруктураСтроки.Вставить("КодТовара", 			СтрокаДокумента.art.id);
		СтруктураСтроки.Вставить("НазваниеТовара",		СтрокаДокумента.art.name);
	КонецЕсли;
	СтруктураСтроки.Вставить("Количество",   		Число(СтрокаДокумента.qty));
	СтруктураСтроки.Вставить("Пользователь", 		UserName);
	СтруктураСтроки.Вставить("ТСД", 		 		УзелПО);
	
	// Zolla правка (только текущая дата)
	СтруктураСтроки.Вставить("Дата", 		 	ТекущаяДата());
	
	Попытка СтруктураСтроки.Вставить("КоличествоВУпаковке", СтрокаДокумента.qty_in_pack); Исключение СтруктураСтроки.Вставить("КоличествоВУпаковке", 0); КонецПопытки;
	
	Если СтруктураСтроки.Количество > 0 Тогда 
		СтруктураСтроки.Вставить("КоличествоМест", 1);
	ИначеЕсли СтруктураСтроки.Количество < 0 Тогда 
		СтруктураСтроки.Вставить("КоличествоМест", -1);
	Иначе
		СтруктураСтроки.Вставить("КоличествоМест", 0);
	КонецЕсли;	
	
	ТекущаяЯчейкаСсылка = ДатаМобайл_ОбщийМодуль.ПолучитьЯчейкуПоКодуИлиШтрихкоду(СтрокаДокумента.cell.barcode, СсылкаНаДок);
	СтруктураСтроки.Вставить("ЯчейкаСсылка", ТекущаяЯчейкаСсылка);
	СтруктураСтроки.Вставить("Номенклатура", Справочники.Номенклатура.ПустаяСсылка());
	СтруктураСтроки.Вставить("ХарактеристикаНоменклатуры", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
	СтруктураСтроки.Вставить("НоваяЦена", Число(СтрокаДокумента.changed_price));
	
	Попытка
		Если Лев(СтрокаДокумента.art.id, 3) = "8U-" Тогда
			СтруктураСтроки.Номенклатура = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(СтрокаДокумента.art.id, 4, 36));
			ИДХК = Сред(СтрокаДокумента.art.id, 40, 36);
			Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
				СтруктураСтроки.ХарактеристикаНоменклатуры = XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК);
			КонецЕсли;	
		КонецЕсли;	
		
		Если Не ЗначениеЗаполнено(СокрЛП(СтруктураСтроки.НазваниеТовара)) Тогда
			ВключатьАртикул = УзелПО.ДобавлятьАртикулВНаименование;
			
			СтруктураСтроки.НазваниеТовара = ?(ВключатьАртикул,СтруктураСтроки.Номенклатура.Артикул + " ","")
			+ СтруктураСтроки.Номенклатура.Наименование + " " 
			+ СтруктураСтроки.ХарактеристикаНоменклатуры.Наименование; 
		КонецЕсли;
		
	Исключение	
	КонецПопытки;
	СтруктураСтроки.Вставить("ЕдиницаИзмерения", Справочники.УпаковкиЕдиницыИзмерения.ПустаяСсылка());
	СтруктураСтроки.Вставить("КоэффициентЕдиницы", 1);
	СтруктураСтроки.Вставить("СерияСсылка", Справочники.СерииНоменклатуры.ПустаяСсылка());
	СтруктураСтроки.Вставить("СерийныйНомер", ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.sn,Ложь));
	ЭтоКодМаркировки = Ложь;
	
	//Переменные Params
	СтруктураParams = Новый Структура;
	СтруктураParams.Вставить("KM_GTIN",       ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.gtin));
	СтруктураParams.Вставить("KM_SN",	      ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.sn));
	СтруктураParams.Вставить("KM_Barcode", 	  ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.mark));
	СтруктураParams.Вставить("KM_RawBarcode", ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.raw_barcode));		
	СтруктураParams.Вставить("KM_DecodedMrc", ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.decoded_mrc));
	СтруктураParams.Вставить("KM_RawMrc",	  ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.raw_mrc));	
	СтруктураParams.Вставить("KM_TNVED",	  ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.tnvd));
	СтруктураParams.Вставить("GS1",			  ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.gs1_barcode));
	СтруктураParams.Вставить("packAttrs",	  СтрЗаменить(СтрокаДокумента.pack_attributes, "\\", ""));
	
	//МАРКИРОВКА
	Если ИспользоватьМаркировку Тогда
						
		СтруктураСтроки.Вставить("ЦРПТМарка", СтруктураParams.KM_Barcode);
		Если СтруктураСтроки.ЦРПТМарка = "" Тогда
			СтруктураСтроки.ЦРПТМарка = СтруктураParams.KM_RawBarcode;	
		КонецЕсли;	       
		
		СтруктураСтроки.Вставить("ЦРПТМарка_Длина", СтрДлина(СтруктураСтроки.ЦРПТМарка));	
		СтруктураСтроки.Вставить("Короб", ЧистаяСтрока(СтрокаДокумента.box_pack));
		Если ЗначениеЗаполнено(СтруктураParams.KM_SN) И Шаблон.ИсточникСерии = 1 Тогда
			ЭтоКодМаркировки = Истина;
			СтруктураСтроки.Вставить("СерийныйНомер", СтруктураParams.KM_SN);
		КонецЕсли;	
		СтруктураСтроки.Вставить("KM_GTIN", 	  СтруктураParams.KM_GTIN);
		СтруктураСтроки.Вставить("KM_RawMrc", 	  СтруктураParams.KM_RawMrc);
		СтруктураСтроки.Вставить("KM_DecodedMrc", СтруктураParams.KM_DecodedMrc);
		СтруктураСтроки.Вставить("GS1", 		  СтруктураParams.GS1);
		СтруктураСтроки.Вставить("KM_TNVED", 	  СтруктураParams.KM_TNVED);
		
		Если ЗначениеЗаполнено(СтруктураСтроки.Номенклатура) Тогда
			ПараметрыТовара = Новый Структура("Номенклатура, Характеристика", СтруктураСтроки.Номенклатура, СтруктураСтроки.ХарактеристикаНоменклатуры);
		Иначе
			ПараметрыТовара = Неопределено;
		КонецЕсли;
				
		Если ЗначениеЗаполнено(СтруктураСтроки.ЦРПТМарка) И (Не ВызовИзWriteDoc Или Шаблон.ИспользованиеУпаковочныхЛистовПодбор = 4 Или Не ДатаМобайл_Маркировка.ТребуетсяСпецОбработка(СсылкаНаДок)) Тогда
			Если Шаблон.ИспользованиеУпаковочныхЛистовПодбор = 4 Тогда //короба в палеты
				СтруктураСтроки.Вставить("КМСсылка", ДатаМобайл_Маркировка.ПолучитьСправочникСсылкаУпаковка(СтруктураСтроки.ЦРПТМарка, Шаблон.МаркировкаСоздаватьСправочникКМЕслиНеНайден, ПараметрыТовара));	
			Иначе //обычные документы маркировки
				СтруктураСтроки.Вставить("КМСсылка", ДатаМобайл_Маркировка.ПолучитьСправочникСсылкаМарка(СтруктураСтроки.ЦРПТМарка, СтруктураСтроки.ЦРПТМарка_Длина, СтруктураСтроки.KM_RawMrc, СтруктураСтроки.KM_TNVED, Шаблон.МаркировкаСоздаватьСправочникКМЕслиНеНайден, ПараметрыТовара, Шаблон));
			КонецЕсли;
		Иначе
			СтруктураСтроки.Вставить("КМСсылка", Справочники.ШтрихкодыУпаковокТоваров.ПустаяСсылка());	
		КонецЕсли;
				
		//Получим данные по номенклатуре и характеристике из упаковки (если это формирование палеты)
		Если Не ЗначениеЗаполнено(СтруктураСтроки.Номенклатура) И ЗначениеЗаполнено(СтруктураСтроки.КМСсылка) Тогда		
			СтруктураСтроки.Вставить("Номенклатура", СтруктураСтроки.КМСсылка.Номенклатура);
			СтруктураСтроки.Вставить("ХарактеристикаНоменклатуры", СтруктураСтроки.КМСсылка.Характеристика);
			ПараметрыТовара = Новый Структура("Номенклатура, Характеристика", СтруктураСтроки.Номенклатура, СтруктураСтроки.ХарактеристикаНоменклатуры);
		КонецЕсли;						
		
		ТекущийКороб = СтрокаДокумента.box_pack;
		ТекущийКороб = ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(ТекущийКороб);
		Если СтрДлина(ТекущийКороб) = 20 И Лев(ТекущийКороб, 2) = "00" Тогда		
			ТекущийКороб = "(00)" +  Сред(ТекущийКороб, 3, 18);
		ИначеЕсли СтрДлина(ТекущийКороб) = 18 Тогда		
			ТекущийКороб = "(00)" +  Сред(ТекущийКороб, 1, 18);		
		КонецЕсли;
			
		ТекущийУпаковочныйЛист = СтрокаДокумента.pack;		
		ТекущийУпаковочныйЛист = ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(ТекущийУпаковочныйЛист);
		Если СтрДлина(ТекущийУпаковочныйЛист) = 20 И Лев(ТекущийУпаковочныйЛист, 2) = "00" Тогда		
			ТекущийУпаковочныйЛист = "(00)" +  Сред(ТекущийУпаковочныйЛист, 3, 18);
		ИначеЕсли СтрДлина(ТекущийУпаковочныйЛист) = 18 Тогда		
			ТекущийУпаковочныйЛист = "(00)" +  Сред(ТекущийУпаковочныйЛист, 1, 18);	
		КонецЕсли;
		
		//Если это не агрегация, то паковочный лист может быть пустым, используем Тогда короб
		Если ТекущийУпаковочныйЛист = "" И ТекущийКороб <> "" Тогда
			ТекущийУпаковочныйЛист = ТекущийКороб;
			ТекущийКороб = "";	
		КонецЕсли;
		
		Если ТекущийКороб <> "" Тогда
			СтруктураСтроки.Вставить("КоробСсылка", ДатаМобайл_Маркировка.ПолучитьСправочникСсылкаУпаковка(ТекущийКороб, Шаблон.МаркировкаСоздаватьСправочникКМЕслиНеНайден, ПараметрыТовара));
		Иначе
			СтруктураСтроки.Вставить("КоробСсылка", Справочники.ШтрихкодыУпаковокТоваров.ПустаяСсылка());
		КонецЕсли;
		СтруктураСтроки.Вставить("Короб", ТекущийКороб);
				
		Если ТекущийУпаковочныйЛист <> "" Тогда
			СтруктураСтроки.Вставить("УпаковочныйЛистСсылка", ДатаМобайл_Маркировка.ПолучитьСправочникСсылкаУпаковка(ТекущийУпаковочныйЛист, Шаблон.МаркировкаСоздаватьСправочникКМЕслиНеНайден, ПараметрыТовара));
		Иначе
			СтруктураСтроки.Вставить("УпаковочныйЛистСсылка", Справочники.ШтрихкодыУпаковокТоваров.ПустаяСсылка());
		КонецЕсли;
		СтруктураСтроки.Вставить("УпаковочныйЛист", ТекущийУпаковочныйЛист);		
		
		СтруктураСтроки.Вставить("УпаковочныйЛистАтрибуты", СтруктураParams.packAttrs);
		
		//Не сохранять криптохвосты в GS1
		Если ЗаписыватьПолныйКМ Тогда
			Если СтруктураParams.GS1 = "" Тогда
				ПолныйКодМаркировки = СтруктураParams.KM_RawBarcode; 
			Иначе
				ПолныйКодМаркировки = СтруктураParams.GS1;
			КонецЕсли;
			СтруктураСтроки.Вставить("ПолныйКодМаркировки", ПолныйКодМаркировки);
		Иначе
			//Не сохранять криптохвосты в GS1
			Если (СтруктураСтроки.ЦРПТМарка_Длина = 31 //Обувь и прочее
				Или СтруктураСтроки.ЦРПТМарка_Длина = 25 //Блок табака
				Или СтруктураСтроки.ЦРПТМарка_Длина = 21 //Пачка табака
				Или СтруктураСтроки.ЦРПТМарка_Длина = 38 //Фото
				Или СтруктураСтроки.ЦРПТМарка_Длина = 24 Или СтруктураСтроки.ЦРПТМарка_Длина = 32) //Молочка
				Тогда
				СтруктураСтроки.GS1	= "";
			КонецЕсли;
		КонецЕсли;
		
		Если СтруктураСтроки.Штрихкод = "" Тогда	
			СтруктураСтроки.Штрихкод = УдалитьЛидирующиеНули(СтруктураParams.KM_GTIN);	
		КонецЕсли;	
		
	Иначе
		
		ТекущийУпаковочныйЛист = СтрокаДокумента.pack;	
		Если ТекущийУпаковочныйЛист = "0" Тогда
			ТекущийУпаковочныйЛист = "";
		КонецЕсли;	
		СтруктураСтроки.Вставить("УпаковочныйЛист", ТекущийУпаковочныйЛист);
		СтруктураСтроки.Вставить("Короб", СтрокаДокумента.box_pack);
		
		СтруктураСтроки.Вставить("УпаковочныйЛистАтрибуты", СтруктураParams.packAttrs);
		
	КонецЕсли;
		
	УстановитьЕдиницу(СтруктураСтроки);
		
	//ЕГАИС
	Если ИспользоватьЕГАИС Тогда
		
		СтруктураСтроки.Вставить("КодТовара", СтрокаДокумента.egais_art.id);
		
		Если ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда
			ИмяСправочникаНоменклатурыЕГАИС = "астНоменклатураЕГАИС";
			
		ИначеЕсли ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
			ИмяСправочникаНоменклатурыЕГАИС = "алкКлассификаторАлкогольнойПродукцииЕГАИС";
			
		Иначе
			ИмяСправочникаНоменклатурыЕГАИС = "КлассификаторАлкогольнойПродукцииЕГАИС";
		КонецЕсли;		
		
		СтруктураСтроки.Вставить("НоменклатураЕГАИС", Справочники[ИмяСправочникаНоменклатурыЕГАИС].ПустаяСсылка());	
		
		Попытка
			СтруктураСтроки.НоменклатураЕГАИС = Справочники[ИмяСправочникаНоменклатурыЕГАИС].ПолучитьСсылку(Новый УникальныйИдентификатор(Сред(СтрокаДокумента.egais_art.id, 4, 36)));
		Исключение
			СтруктураСтроки.НоменклатураЕГАИС = Справочники[ИмяСправочникаНоменклатурыЕГАИС].НайтиПоКоду(СокрЛП(СтрокаДокумента.egais.alcocode));
		КонецПопытки;
				
		СтруктураСтроки.Вставить("PDF", СтрокаДокумента.egais.alcocode);		
		Если СтрокаДокумента.egais.date_bottling <> "" И СтрокаДокумента.egais.date_bottling <> "1/1/00 12:00:00 AM" И СтрокаДокумента.egais.date_bottling <> "01.01.00 12:00:00 AM" И СтрокаДокумента.egais.date_bottling <> "010100" Тогда    			
			ДатаРозливаГод = Строка(Строка("20") + Строка(Сред(СтрокаДокумента.egais.date_bottling, 5, 2)));
			ДатаРозливаМесяц = Сред(СтрокаДокумента.egais.date_bottling, 3, 2);
			ДатаРозливаДень = Лев(СтрокаДокумента.egais.date_bottling, 2);
			ДатаРозлива = Дата(Число(ДатаРозливаГод), Число(ДатаРозливаМесяц), Число(ДатаРозливаДень));
			СтруктураСтроки.Вставить("ЕгаисДатаРозлива", ДатаРозлива);
		КонецЕсли; 		
		СтруктураСтроки.Вставить("ЕгаисМарка", "");
		СтруктураСтроки.Вставить("ЕгаисПолныйКод", ЧистаяСтрока(СтрокаДокумента.egais.mark));
		
		Если ЗначениеЗаполнено(СтруктураСтроки.ЕгаисПолныйКод) Тогда
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
			|	ШтрихкодыУпаковокТоваров.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
			|ГДЕ 
			|	НЕ ШтрихкодыУпаковокТоваров.ПометкаУдаления
			|	И ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода = &ЗначениеШтрихкодаДляЗапроса";
			Запрос.УстановитьПараметр("ЗначениеШтрихкодаДляЗапроса", СтруктураСтроки.ЕгаисПолныйКод);
			
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			
			Если Выборка.Следующий() Тогда
				СтруктураСтроки.Вставить("КМСсылка", Выборка.Ссылка);	 
			Иначе
				СтруктураСтроки.Вставить("КМСсылка", Справочники.ШтрихкодыУпаковокТоваров.ПустаяСсылка());
			КонецЕсли;
		Иначе
			СтруктураСтроки.Вставить("КМСсылка", Справочники.ШтрихкодыУпаковокТоваров.ПустаяСсылка());
		КонецЕсли;	
		
		Если ЗначениеЗаполнено(СтруктураСтроки.УпаковочныйЛист) 
			Или ЗначениеЗаполнено(СтруктураСтроки.Короб) Тогда
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
			|	ШтрихкодыУпаковокТоваров.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
			|ГДЕ 
			|	НЕ ШтрихкодыУпаковокТоваров.ПометкаУдаления
			|	И ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода ПОДОБНО &ЗначениеШтрихкодаДляЗапроса";
			Если ЗначениеЗаполнено(СтруктураСтроки.УпаковочныйЛист) Тогда
				Запрос.УстановитьПараметр("ЗначениеШтрихкодаДляЗапроса", СтруктураСтроки.УпаковочныйЛист);
			Иначе
				Запрос.УстановитьПараметр("ЗначениеШтрихкодаДляЗапроса", СтруктураСтроки.Короб);
			КонецЕсли;	
			Результат = Запрос.Выполнить();
			Выборка = Результат.Выбрать();
			Пока Выборка.Следующий() Цикл
				СтруктураСтроки.Вставить("УпаковочныйЛистСсылка", Выборка.Ссылка);	 
			КонецЦикла;
		Иначе
			СтруктураСтроки.Вставить("УпаковочныйЛистСсылка", Справочники.ШтрихкодыУпаковокТоваров.ПустаяСсылка());
		КонецЕсли;
		
		//Определение данных номенклатуры по марке если нет сопоставления
		Если Не ДатаМобайл_ОбщийМодуль.ЕстьАСТ() И ЗначениеЗаполнено(СтруктураСтроки.ЕгаисПолныйКод) И Не Шаблон.СопоставлениеЕГАИС Тогда			
			ДатаМобайл_ОбщийМодуль.ПолучитьНоменклатуруПоМарке(СтруктураСтроки);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(СтруктураСтроки.Номенклатура) И ЗначениеЗаполнено(СтруктураСтроки.НоменклатураЕГАИС) Тогда
			СтруктураСтроки.Номенклатура = ДатаМобайл_ОбщийМодуль.ПолучитьНоменклатуруПоЕГАИС(СтруктураСтроки.НоменклатураЕГАИС);
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(СтруктураСтроки.НоменклатураЕГАИС) И ЗначениеЗаполнено(СтруктураСтроки.Номенклатура) Тогда
			СтруктураСтроки.НоменклатураЕГАИС = ДатаМобайл_ОбщийМодуль.ПолучитьЕГАИСПоНоменклатуре(СтруктураСтроки.Номенклатура);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(СтрокаДокумента.box_pack) И Не ЗначениеЗаполнено(СтрокаДокумента.pack) Тогда
			СтруктураСтроки.УпаковочныйЛист = СтрокаДокумента.box_pack;
			СтруктураСтроки.Короб = "";
		КонецЕсли;		
		
		//Сопоставление
		Если Шаблон.СопоставлениеЕГАИС Тогда
			
			Если СтруктураСтроки.НоменклатураЕГАИС.Пустая() Тогда
			ИначеЕсли СтруктураСтроки.Номенклатура.Пустая() Тогда
			Иначе		
				
				ЗапросСопоставления = Новый Запрос;
				ЗапросСопоставления.УстановитьПараметр("Номенклатура", СтруктураСтроки.Номенклатура);
				ЗапросСопоставления.УстановитьПараметр("ЕГАИС_Номенклатура", СтруктураСтроки.НоменклатураЕГАИС);
				
				ЗапросСопоставления.Текст = "ВЫБРАТЬ
				|	ИСТИНА КАК Сопоставлен
				|ИЗ
				|	РегистрСведений.СоответствиеНоменклатурыЕГАИС КАК ЕГАИС_СоответствиеНоменклатуры
				|ГДЕ
				|	ЕГАИС_СоответствиеНоменклатуры.АлкогольнаяПродукция = &ЕГАИС_Номенклатура
				|	И ЕГАИС_СоответствиеНоменклатуры.Номенклатура = &Номенклатура";
								
				Если ЗапросСопоставления.Выполнить().Пустой() Тогда
					
					МенеджерЗаписиЕГАИС = РегистрыСведений.СоответствиеНоменклатурыЕГАИС.СоздатьМенеджерЗаписи();
					МенеджерЗаписиЕГАИС.АлкогольнаяПродукция = СтруктураСтроки.НоменклатураЕГАИС;
					МенеджерЗаписиЕГАИС.Номенклатура = СтруктураСтроки.Номенклатура;
					МенеджерЗаписиЕГАИС.Записать();													
					
				КонецЕсли;	
			КонецЕсли;
			
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(СокрЛП(СтруктураСтроки.НазваниеТовара)) Тогда
			ВключатьАртикул = УзелПО.ДобавлятьАртикулВНаименование;
			
			СтруктураСтроки.НазваниеТовара = ?(ВключатьАртикул, СтруктураСтроки.НоменклатураЕГАИС.Артикул + " ", "")
			+ СтруктураСтроки.НоменклатураЕГАИС.Наименование; 
		КонецЕсли;
				
	КонецЕсли;
	
	//СЕРИИ
	Попытка ОпределитьСериюВСтрокеДокумента(Шаблон, СтруктураСтроки, ЭтоКодМаркировки, УзелПО); Исключение ОпределитьСериюВСтрокеДокументаМаркировка(СтруктураСтроки, Шаблон) КонецПопытки;
	
	// Атрибуты строки
	ПолучитьАтрибутыСтрокиИзПО(СтруктураСтроки, СтрокаДокумента);
	
	Возврат СтруктураСтроки;
	
КонецФункции

//Проверка записи.
//
// Параметры:     
// ИмяТаблицы - Строка - "Insert"/"Select".
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// СтрокаДокумента - Структура - Структура данных строки документа.
// Объект - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
//
// Возвращаемое значение:
//   Булево.
//
Функция ПроверитьЗаписи(ИмяТаблицы, УзелПО, СсылкаНаДок, СтрокаДокумента, Объект = Неопределено)
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	ЗначенияРеквизитовСсылкаНаДок = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок,"Шаблон");
	Шаблон = ЗначенияРеквизитовСсылкаНаДок.Шаблон;
	
	ЗначенияРеквизитовШаблон = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ГрупповаяРабота,ИспользованиеУпаковочныхЛистовПодбор,
	|БыстроеСканирование,ИспользоватьМаркировку,МаркировкаСоздаватьСправочникКМЕслиНеНайден,ИспользоватьДопФормы");
	Шаблон_ГрупповаяРабота = ЗначенияРеквизитовШаблон.ГрупповаяРабота;
	Шаблон_ИспользованиеУпаковочныхЛистовПодбор = ЗначенияРеквизитовШаблон.ИспользованиеУпаковочныхЛистовПодбор;
	Шаблон_БыстроеСканирование = ЗначенияРеквизитовШаблон.БыстроеСканирование;
	Шаблон_ИспользоватьМаркировку = ЗначенияРеквизитовШаблон.ИспользоватьМаркировку;
	Шаблон_МаркировкаСоздаватьСправочникКМЕслиНеНайден = ЗначенияРеквизитовШаблон.МаркировкаСоздаватьСправочникКМЕслиНеНайден;
	Шаблон_ДопРеквизиты = ЗначенияРеквизитовШаблон.ИспользоватьДопФормы; 
	
	ЗапросСтрок = Новый Запрос;
	ЗапросСтрок.УстановитьПараметр("ТСД", УзелПО);
	ЗапросСтрок.УстановитьПараметр("ДокументТСД", СсылкаНаДок);
	ЗапросСтрок.УстановитьПараметр("ИдентификаторСтроки", Число(СтрокаДокумента.row_id));
	ЗапросСтрок.УстановитьПараметр("ИмяТаблицы", ИмяТаблицы);
	
	ЗапросСтрок.Текст = "ВЫБРАТЬ
	|	ИСТИНА КАК Выгружен
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_СтрокиДокументов
	|ГДЕ
	|	ДатаМобайл_СтрокиДокументов.ТСД = &ТСД
	|	И ДатаМобайл_СтрокиДокументов.Ссылка = &ДокументТСД
	|	И ДатаМобайл_СтрокиДокументов.ИдентификаторСтроки = &ИдентификаторСтроки
	|	И ДатаМобайл_СтрокиДокументов.Количество > 0
	|	И НЕ ДатаМобайл_СтрокиДокументов.ПризнакПовторнойВыгрузки
	|	
	|ОБЪЕДИНИТЬ
	|	
	|ВЫБРАТЬ
	|	ИСТИНА КАК Выгружен
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ДатаМобайл_СтрокиДокументов
	|ГДЕ
	|	ДатаМобайл_СтрокиДокументов.ТСД = &ТСД
	|	И ДатаМобайл_СтрокиДокументов.ДокументТСД = &ДокументТСД
	|	И ДатаМобайл_СтрокиДокументов.ИдентификаторСтроки = &ИдентификаторСтроки
	|	И ДатаМобайл_СтрокиДокументов.ИмяТаблицы = &ИмяТаблицы
	|	И ДатаМобайл_СтрокиДокументов.Количество > 0
	|	И НЕ ДатаМобайл_СтрокиДокументов.ПризнакПовторнойВыгрузки
	|";
	
	Если Число(СтрокаДокумента.qty) < 0 Тогда
		ЗапросСтрок.Текст = СтрЗаменить(ЗапросСтрок.Текст, "Количество > 0", "Количество < 0");
	КонецЕсли;
	
	Если ИмяТаблицы = "Insert" Тогда
		ЗапросСтрок.Текст = СтрЗаменить(ЗапросСтрок.Текст, "Подбор", "Приемка");
	КонецЕсли;		
	
	Если Не ЗапросСтрок.Выполнить().Пустой() Тогда
		// ОБНОВЛЕНИЕ ЗНАЧЕНИЙ ДОП.РЕКВИЗИТОВ
		Если Шаблон_ДопРеквизиты И (Не СтрокаДокумента.attributes = "" И Не СтрокаДокумента.attributes = "[]") Тогда
			СтруктураСтроки = Новый Структура;
			СтруктураСтроки.Вставить("ДокументТСД", СсылкаНаДок);
			СтруктураСтроки.Вставить("Номенклатура", Справочники.Номенклатура.ПустаяСсылка());
			СтруктураСтроки.Вставить("ХарактеристикаНоменклатуры", Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
			
			Если Лев(СтрокаДокумента.art.id, 3) = "8U-" Тогда
				СтруктураСтроки.Вставить("Номенклатура" , XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(СтрокаДокумента.art.id, 4, 36)));
				ИДХК = Сред(СтрокаДокумента.art.id, 40, 36);
				
				Если ИДХК <> "00000000-0000-0000-0000-000000000000" Тогда
					СтруктураСтроки.Вставить("ХарактеристикаНоменклатуры", XMLЗначение(Тип("СправочникСсылка.ХарактеристикиНоменклатуры"), ИДХК));
				КонецЕсли;	
			КонецЕсли;
			
			ПолучитьАтрибутыСтрокиИзПО(СтруктураСтроки, СтрокаДокумента);
			
			//ЗАПИСЬ В РЕГИСТР ЗНАЧЕНИЙ ДОП ФОРМ
			ЗаписьЗначенийДопФормВРегистр(СтруктураСтроки);
		КонецЕсли;		
		
		//ОБНОВЛЕНИЕ ЗНАЧЕНИЙ ВВОДИМЫХ ПОСЛЕ ЗАПИСИ СТРОКИ
		Если Число(СтрокаДокумента.changed_price) > 0 
			Или (СтрокаДокумента.pack <> "" И Шаблон_ИспользованиеУпаковочныхЛистовПодбор = 2) Тогда
			
			Если Шаблон_ГрупповаяРабота Или Шаблон_БыстроеСканирование Тогда
				
				НаборЗаписей = РегистрыСведений.ДатаМобайл_СтрокиГрупповыхДокументов.СоздатьНаборЗаписей();
				НаборЗаписей.Отбор.ТСД.Установить(УзелПО);
				НаборЗаписей.Отбор.ДокументТСД.Установить(СсылкаНаДок);
				НаборЗаписей.Отбор.ДляОбмена.Установить(Ложь);
				НаборЗаписей.Отбор.ИдентификаторСтроки.Установить(Число(СтрокаДокумента.row_id));
				
				НаборЗаписей.Прочитать();
				
				Для каждого СтрокаЗаписи Из НаборЗаписей Цикл 
					СтрокаЗаписи.НоваяЦена = Число(СтрокаДокумента.changed_price);
					УстановитьУпаковочныйЛист(СтрокаЗаписи,СтрокаДокумента,Шаблон_ИспользоватьМаркировку,Шаблон_МаркировкаСоздаватьСправочникКМЕслиНеНайден);
				КонецЦикла;
				НаборЗаписей.Записать();
				
			Иначе
				Если Объект <> Неопределено Тогда
					СтруктураПоиска = Новый Структура("ИдентификаторСтроки,ТСД", Число(СтрокаДокумента.row_id), УзелПО);
					Если ИмяТаблицы = "Insert" Тогда
						СтрокиПодбора = Объект.СобранныеДанныеПриемка.НайтиСтроки(СтруктураПоиска);
					Иначе	
						СтрокиПодбора = Объект.СобранныеДанныеПодбор.НайтиСтроки(СтруктураПоиска);
					КонецЕсли;	
					Если СтрокиПодбора.Количество() > 0 Тогда
						Для каждого СтрокаПодбора Из СтрокиПодбора Цикл
							СтрокаПодбора.НоваяЦена = Число(СтрокаДокумента.changed_price);
							УстановитьУпаковочныйЛист(СтрокаПодбора, СтрокаДокумента, Шаблон_ИспользоватьМаркировку, Шаблон_МаркировкаСоздаватьСправочникКМЕслиНеНайден);
						КонецЦикла;
													
						Объект.Записать(); 
						
						//УДАЛЕНИЕ РЕГИСТРАЦИИ ДАННОГО ДОКУМЕНТА НА ДАННОМ УЗЛЕ 
						ДатаМобайл_ОбщийМодуль.УдалитьРегистрациюОбъекта(Объект, Ложь);						
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;	
		КонецЕсли;
		
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции	

//Установка упаковочного листа.
//
// Параметры:     
// СтруктураСтроки - Структура - Структура данных строки.
// СтрокаДокумента - Структура - Структура данных строки документа.
// ИспользоватьМаркировку - Булево - Использование маркировки.
// МаркировкаСоздаватьСправочникКМЕслиНеНайден - Булево - Создавать КМ, если ссылка на КМ не найдена.
//
Процедура УстановитьУпаковочныйЛист(СтруктураСтроки, СтрокаДокумента, ИспользоватьМаркировку, МаркировкаСоздаватьСправочникКМЕслиНеНайден)
	
	//Переменные Params
	СтруктураParams = Новый Структура;
	СтруктураParams.Вставить("KM_GTIN", 	  ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.gtin));
	СтруктураParams.Вставить("KM_SN", 		  ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.sn));
	СтруктураParams.Вставить("KM_Barcode",    ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.mark));
	СтруктураParams.Вставить("KM_RawBarcode", ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.raw_barcode));		
	СтруктураParams.Вставить("KM_DecodedMrc", ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.decoded_mrc));
	СтруктураParams.Вставить("KM_RawMrc", 	  ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.raw_mrc));	
	СтруктураParams.Вставить("KM_TNVED", 	  ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.tnvd));
	СтруктураParams.Вставить("GS1",			  ДатаМобайл_Маркировка.ОбработатьЭкранированиеСтроки(СтрокаДокумента.marking.ean));
	СтруктураParams.Вставить("packAttrs",     СтрЗаменить(СтрокаДокумента.pack_attributes, "\\", ""));
		
	ТекущийУпаковочныйЛист = СтрокаДокумента.pack;		
	ТекущиеУпаковочныйЛистАтрибуты = СтруктураParams.packAttrs;
		
	Если ИспользоватьМаркировку Тогда 		
		Если ЗначениеЗаполнено(СтруктураСтроки.Номенклатура) Тогда
			ПараметрыТовара = Новый Структура("Номенклатура, Характеристика", СтруктураСтроки.Номенклатура, СтруктураСтроки.ХарактеристикаНоменклатуры);
		Иначе
			ПараметрыТовара = Неопределено;
		КонецЕсли;
				
		ТекущийУпаковочныйЛист = СтрЗаменить(ТекущийУпаковочныйЛист, "[", "(");
		ТекущийУпаковочныйЛист = СтрЗаменить(ТекущийУпаковочныйЛист, "]", ")");
		
		Если СтрДлина(ТекущийУпаковочныйЛист) = 20 И Лев(ТекущийУпаковочныйЛист, 2) = "00" Тогда		
			ТекущийУпаковочныйЛист = "(00)" +  Сред(ТекущийУпаковочныйЛист, 3, 18);
		КонецЕсли;	
		
		СтруктураСтроки.УпаковочныйЛист = ТекущийУпаковочныйЛист;
		Если ТекущийУпаковочныйЛист <> "" Тогда
			СтруктураСтроки.УпаковочныйЛистСсылка = ДатаМобайл_Маркировка.ПолучитьСправочникСсылкаУпаковка(ТекущийУпаковочныйЛист, МаркировкаСоздаватьСправочникКМЕслиНеНайден, ПараметрыТовара);
		КонецЕсли;
		
		СтруктураСтроки.УпаковочныйЛистАтрибуты = ТекущиеУпаковочныйЛистАтрибуты;
	Иначе
		СтруктураСтроки.УпаковочныйЛист = ТекущийУпаковочныйЛист;
		СтруктураСтроки.УпаковочныйЛистАтрибуты = ТекущиеУпаковочныйЛистАтрибуты;		
	КонецЕсли;
		
КонецПроцедуры

//Проверка превышения группового задания.
//
// Параметры:     
// ИмяТаблицы - Строка - "Insert"/"Select".
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// СтрокаДокумента - Структура - Структура данных строки документа.
// СтруктураСтроки - Структура - Структура данных строки.
//
// Возвращаемое значение:
//   Булево.
//
Функция ПроверитьПревышениеГрупповогоЗадания(ИмяТаблицы, УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки)
	
	Шаблон = СсылкаНаДок.Шаблон;
	Коэффициент = ?(СтруктураСтроки.ЕдиницаИзмерения.Числитель = 0, 1,СтруктураСтроки.ЕдиницаИзмерения.Числитель) / ?(СтруктураСтроки.ЕдиницаИзмерения.Знаменатель = 0, 1, СтруктураСтроки.ЕдиницаИзмерения.Знаменатель);
	
	ВидДокумента = Шаблон.ВидДокумента;
	ИмяТабличнойЧастиПодбор = Шаблон.ИмяТабличнойЧастиПодбор;
	ИмяТабличнойЧастиПриемка = Шаблон.ИмяТабличнойЧастиПриемка;	
	МножествоДокументовКакЗадание = Шаблон.РаспределениеТоваров = 1;
	
	Если ВидДокумента = "ЗаданиеНаПеревозку" Тогда	
		ВидДокумента = "ЗаказКлиента";
		ИмяТабличнойЧастиПодбор = "Товары";
		ИмяТабличнойЧастиПриемка = "Товары";	
	КонецЕсли;
	
	ЗапросПревышения = Новый Запрос;
	ЗапросПревышения.Текст = "ВЫБРАТЬ
	|	ЕСТЬNULL(СУММА(ЕСТЬNULL(ТаблицаТоваровВДокументе.Количество,0)),0) КАК КоличествоЗадание,
	|	0 КАК КоличествоПодбор
	|ПОМЕСТИТЬ ВременныеДанные
	|ИЗ
	|	Документ.ПриходныйОрдерНаТовары.Товары КАК ТаблицаТоваровВДокументе
	|ГДЕ
	|	ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент 
	|	И ТаблицаТоваровВДокументе.Номенклатура = &Номенклатура
	|	И ТаблицаТоваровВДокументе.Характеристика = &Характеристика
	|
	|ОБЪЕДИНИТЬ
	|	ВЫБРАТЬ
	|	0,
	|   ЕСТЬNULL(СУММА(ЕСТЬNULL(ТаблицаТоваровВРегистре.Количество* ВЫБОР
	|			КОГДА ЕСТЬNULL(ТаблицаТоваровВРегистре.КоэффициентЕдиницы, 1) = 0
	|				ТОГДА 1
	|			ИНАЧЕ ЕСТЬNULL(ТаблицаТоваровВРегистре.КоэффициентЕдиницы, 1)
	|		КОНЕЦ,0)),0)	 
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ТаблицаТоваровВРегистре
	|ГДЕ
	|	ТаблицаТоваровВРегистре.ДокументТСД = &ДокументТСД
	|	И ТаблицаТоваровВРегистре.Номенклатура = &Номенклатура
	|	И ТаблицаТоваровВРегистре.ХарактеристикаНоменклатуры = &Характеристика
	|	И ТаблицаТоваровВРегистре.ИмяТаблицы = &ИмяТаблицы
	|	И НЕ ТаблицаТоваровВРегистре.ДляОбмена
	|;
	|ВЫБРАТЬ 
	|ЕСТЬNULL(СУММА(ЕСТЬNULL(ВременныеДанные.КоличествоЗадание,0)),0) КАК КоличествоЗадание,
	|ЕСТЬNULL(СУММА(ЕСТЬNULL(ВременныеДанные.КоличествоПодбор,0)),0)  КАК КоличествоПодбор
	|
	|ИЗ ВременныеДанные КАК ВременныеДанные";
	
	ЗапросПревышения.УстановитьПараметр("ДокументТСД", СсылкаНаДок);
	ЗапросПревышения.УстановитьПараметр("ИмяТаблицы", ИмяТаблицы);
	ЗапросПревышения.Текст = СтрЗаменить(ЗапросПревышения.Текст, ".ПриходныйОрдерНаТовары.", "." + ВидДокумента + ".");
	Если ИмяТаблицы = "Select" Тогда
		ЗапросПревышения.Текст = СтрЗаменить(ЗапросПревышения.Текст, ".Товары КАК ", "." + ИмяТабличнойЧастиПодбор + " КАК ");
	Иначе
		ЗапросПревышения.Текст = СтрЗаменить(ЗапросПревышения.Текст, ".Товары КАК ", "." + ИмяТабличнойЧастиПриемка + " КАК ");
	КонецЕсли;
	
	Если Шаблон.ЕГАИС Тогда
		Если ДатаМобайл_ОбщийМодуль.ЕстьАСТ() Тогда
			ЗапросПревышения.Текст = СтрЗаменить(ЗапросПревышения.Текст, "ТаблицаТоваровВДокументе.Номенклатура", "ТаблицаТоваровВДокументе.НоменклатураЕГАИС");
			
		ИначеЕсли ДатаМобайл_ОбщийМодуль.ЕстьКТ2000() Тогда
			ЗапросПревышения.Текст = СтрЗаменить(ЗапросПревышения.Текст, "ТаблицаТоваровВДокументе.Номенклатура", "ТаблицаТоваровВДокументе.АлкогольнаяПродукция");
			ЗапросПревышения.Текст = СтрЗаменить(ЗапросПревышения.Текст, "ТаблицаТоваровВРегистре.Номенклатура", "ТаблицаТоваровВРегистре.НоменклатураЕГАИС");
		Иначе
			ЗапросПревышения.Текст = СтрЗаменить(ЗапросПревышения.Текст, "ТаблицаТоваровВДокументе.Номенклатура", "ТаблицаТоваровВДокументе.АлкогольнаяПродукция");
		КонецЕсли;			
		ЗапросПревышения.Текст = СтрЗаменить(ЗапросПревышения.Текст, "И ТаблицаТоваровВДокументе.Характеристика = &Характеристика", "");
		ЗапросПревышения.Текст = СтрЗаменить(ЗапросПревышения.Текст, "И ТаблицаТоваровВРегистре.ХарактеристикаНоменклатуры = &Характеристика", "");
		ЗапросПревышения.УстановитьПараметр("Номенклатура", СтруктураСтроки.НоменклатураЕГАИС);
	Иначе
		ЗапросПревышения.УстановитьПараметр("Номенклатура", СтруктураСтроки.Номенклатура);
		ЗапросПревышения.УстановитьПараметр("Характеристика", СтруктураСтроки.ХарактеристикаНоменклатуры);
	КонецЕсли;	
	
	Если МножествоДокументовКакЗадание Тогда
		ЗапросПревышения.Текст = СтрЗаменить(ЗапросПревышения.Текст, "ТаблицаТоваровВДокументе.Ссылка = &ИсходныйДокумент", "ТаблицаТоваровВДокументе.Ссылка В (&ИсходныйДокумент)");
		ЗапросПревышения.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.Задания.ВыгрузитьКолонку("Задание"));
	Иначе
		ЗапросПревышения.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);
	КонецЕсли;
	
	ВыборкаПревышения = ЗапросПревышения.Выполнить().Выбрать();
	Пока ВыборкаПревышения.Следующий() Цикл
		Если ВыборкаПревышения.КоличествоПодбор + СтруктураСтроки.Количество * Коэффициент > ВыборкаПревышения.КоличествоЗадание Тогда
			Возврат Истина;
		КонецЕсли;
		Прервать;
	КонецЦикла;	
	
	Возврат Ложь;
	
КонецФункции	

//Проверка уникальности штрихкода группового задания.
//
// Параметры:     
// ИмяТаблицы - Строка - "Insert"/"Select".
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// СтрокаДокумента - Структура - Структура данных строки документа.
// СтруктураСтроки - Структура - Структура данных строки.
//
// Возвращаемое значение:
//   Булево.
//
Функция ПроверитьУникальностьШКГрупповогоЗадания(ИмяТаблицы, УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки)
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	ВидДокумента = Шаблон.ВидДокумента;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ТаблицаТоваровВРегистре.Штрихкод КАК Штрихкод,
	|	СУММА(ТаблицаТоваровВРегистре.Количество) КАК Количество
	|ПОМЕСТИТЬ ВТ_Группировка
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ТаблицаТоваровВРегистре
	|ГДЕ
	|	ТаблицаТоваровВРегистре.Штрихкод = &Штрихкод
	|	И ТаблицаТоваровВРегистре.ДокументТСД = &ДокументТСД
	|	И ТаблицаТоваровВРегистре.Номенклатура = &Номенклатура
	|	И ТаблицаТоваровВРегистре.ХарактеристикаНоменклатуры = &Характеристика
	|	И ТаблицаТоваровВРегистре.ИмяТаблицы = &ИмяТаблицы
	|	И НЕ ТаблицаТоваровВРегистре.ДляОбмена
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаТоваровВРегистре.Штрихкод
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Группировка.Штрихкод КАК Штрихкод
	|ИЗ
	|	ВТ_Группировка КАК ВТ_Группировка
	|ГДЕ
	|	ВТ_Группировка.Количество > 0";
	
	Запрос.УстановитьПараметр("Штрихкод", 				СтруктураСтроки.Штрихкод);
	Запрос.УстановитьПараметр("ДокументТСД", 			СсылкаНаДок);
	Запрос.УстановитьПараметр("ИмяТаблицы", 			ИмяТаблицы); 
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ПриходныйОрдерНаТовары.", "." + ВидДокумента + ".");	 
	
	Запрос.УстановитьПараметр("Номенклатура", 		СтруктураСтроки.Номенклатура);
	Запрос.УстановитьПараметр("Характеристика",	СтруктураСтроки.ХарактеристикаНоменклатуры);	
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Истина;
	КонецЕсли;	
	
	Возврат Ложь;
	
КонецФункции	

//Получение ролей по шаблону.
//
// Параметры:     
// ШаблонСсылка - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон.
// СтрокаРолей - Строка - Строка ролей.
// 
Процедура ПолучитьРолиПоШаблону(ШаблонСсылка, СтрокаРолей)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДатаМобайл_РолиШаблоны.Ссылка.Наименование КАК НаименованиеРоли,
	|	ДатаМобайл_РолиШаблоны.Ссылка КАК Роль
	|ИЗ
	|	Справочник.ДатаМобайл_Роли.Шаблоны КАК ДатаМобайл_РолиШаблоны
	|ГДЕ
	|	ДатаМобайл_РолиШаблоны.Шаблон = &Шаблон
	|	И НЕ ДатаМобайл_РолиШаблоны.Ссылка.ПометкаУдаления";
	
	Запрос.УстановитьПараметр("Шаблон", ШаблонСсылка);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		СтрокаРолей = СтрокаРолей + XMLСтрока(Выборка.Роль) + ",";
	КонецЦикла;
	
	СтрокаРолей = ?(Прав(СтрокаРолей, 1) = ",", Лев(СтрокаРолей, СтрДлина(СтрокаРолей) - 1), СтрокаРолей);
	
КонецПроцедуры

#КонецОбласти

#Область Серии

//Получение признака учета серии.
//
// Параметры:     
// ВидНоменклатуры - СправочникСсылка.ВидНоменклатуры - ВидНоменклатуры.
// Склад - СправочникСсылка.Склады - Склад.
//
// Возвращаемое значение:
//   Булево.
//
Функция ПолучитьПризнакУчетаСерий(ВидНоменклатуры, Склад)
	
	Если Не ЗначениеЗаполнено(Склад) Тогда
		Возврат ВидНоменклатуры.ИспользоватьСерии;	
	Иначе
		Попытка
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ
			|	ВидыНоменклатурыПолитикиУчетаСерий.ПолитикаУчетаСерий КАК ПолитикаУчетаСерий
			|ИЗ
			|	Справочник.ВидыНоменклатуры.ПолитикиУчетаСерий КАК ВидыНоменклатурыПолитикиУчетаСерий
			|ГДЕ
			|	ВидыНоменклатурыПолитикиУчетаСерий.Склад = &Склад
			|	И ВидыНоменклатурыПолитикиУчетаСерий.Ссылка = &ВидНоменклатуры";
			
			Запрос.УстановитьПараметр("Склад", Склад);
			Запрос.УстановитьПараметр("ВидНоменклатуры", ВидНоменклатуры);
						
			Выборка = Запрос.Выполнить().Выбрать();
			Если Выборка.Следующий() Тогда
				Если Выборка.ПолитикаУчетаСерий = Справочники.ПолитикиУчетаСерий.СерииНеИспользуются Тогда
					Возврат Ложь;
				Иначе
					Возврат ВидНоменклатуры.ИспользоватьСерии;
				КонецЕсли;	
			Иначе
				Возврат ВидНоменклатуры.ИспользоватьСерии;
			КонецЕсли;	
		Исключение
			Возврат ВидНоменклатуры.ИспользоватьСерии;	
		КонецПопытки;
	КонецЕсли;
	
	Возврат ВидНоменклатуры.ИспользоватьСерии;
	
КонецФункции

Процедура ОпределитьСериюВСтрокеДокумента(Шаблон, СтруктураСтроки, ЭтоКодМаркировки, УзелПО)
	
	ИмяТаблицы  = СтруктураСтроки.ИмяТаблицы;
	ТоварПоиска = СтруктураСтроки.Номенклатура;	
	СтрокаСерии = СокрЛП(СтруктураСтроки.СерийныйНомер);
		
	Если Не СтрНачинаетсяС(СтрокаСерии, "[") Тогда //обычная строка и ее не разобрать, ПрочитатьJSON при таком варианте падает ошибка, не попадая в исключение на некоторых платформах 
		ОпределитьСериюВСтрокеДокументаМаркировка(СтруктураСтроки, Шаблон);
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(СтрокаСерии) Тогда
		
		//ДАННЫЕ ДЛЯ ПОИСКА СЕРИИ		
		
		ДатаПроизводства11 = Дата(1,1,1);
		ДатаОкончанияСрокаГодности17 = Дата(1,1,1);
		НомерСерии = "";
		НомерВЕТИС = "";
		Попытка ПроизводительВЕТИС = Справочники.ПредприятияВЕТИС.ПустаяСсылка(); Исключение ПроизводительВЕТИС = ""; КонецПопытки;
		
		РазобратьСтрокуСерииПоSNTypes(СтрокаСерии, ДатаПроизводства11, ДатаОкончанияСрокаГодности17, НомерСерии, НомерВЕТИС, ПроизводительВЕТИС, ТоварПоиска, УзелПО.СерииРассчитыватьГоденДо);				
		
		//ПОИСК СЕРИИ	
		Если Не ТоварПоиска.ВладелецСерий.Пустая() Тогда
			ВидНоменклатурыПоиск = ТоварПоиска.ВладелецСерий;
		Иначе
			ВидНоменклатурыПоиск = ТоварПоиска.ВидНоменклатуры;
		КонецЕсли;
		
		ЗапросСерий = Новый Запрос;                 
		ЗапросСерий.Текст =  "ВЫБРАТЬ
		|	СерииНоменклатуры.Ссылка КАК Серия
		| ИЗ
		|	Справочник.СерииНоменклатуры КАК СерииНоменклатуры
		| ГДЕ
		|	(СерииНоменклатуры.Номер = &Номер И СерииНоменклатуры.ИдентификаторПартииВЕТИС = &НомерВЕТИС И СерииНоменклатуры.ПроизводительВЕТИС = &ПроизводительВЕТИС И СерииНоменклатуры.ДатаПроизводства = &ДатаПроизводства И СерииНоменклатуры.ГоденДо = &ГоденДо)
		|	И СерииНоменклатуры.ВидНоменклатуры = &ВидНоменклатурыПоиск
		|	И НЕ СерииНоменклатуры.ПометкаУдаления";
		
		ЗапросСерий.УстановитьПараметр("ГоденДо", ДатаОкончанияСрокаГодности17);
		ЗапросСерий.УстановитьПараметр("Номер", НомерСерии);
		ЗапросСерий.УстановитьПараметр("ДатаПроизводства", ДатаПроизводства11);
		ЗапросСерий.УстановитьПараметр("НомерВЕТИС", НомерВЕТИС);
		ЗапросСерий.УстановитьПараметр("ПроизводительВЕТИС", ПроизводительВЕТИС);
		ЗапросСерий.УстановитьПараметр("ВидНоменклатурыПоиск", ВидНоменклатурыПоиск); 
		
		МетаданныеСерииНоменклатуры = Справочники.СерииНоменклатуры.ПустаяСсылка().Метаданные();
		
		Если МетаданныеСерииНоменклатуры.Реквизиты.Найти("ДатаПроизводства") = Неопределено Тогда
			ЗапросСерий.Текст = СтрЗаменить(ЗапросСерий.Текст, "И СерииНоменклатуры.ДатаПроизводства = &ДатаПроизводства", "");	 
		КонецЕсли;
		
		Если МетаданныеСерииНоменклатуры.Реквизиты.Найти("ИдентификаторПартииВЕТИС") = Неопределено Тогда 
			ЗапросСерий.Текст = СтрЗаменить(ЗапросСерий.Текст, "И СерииНоменклатуры.ИдентификаторПартииВЕТИС = &НомерВЕТИС", "");	 
		КонецЕсли;	 
		
		Если МетаданныеСерииНоменклатуры.Реквизиты.Найти("ПроизводительВЕТИС") = Неопределено Тогда 
			ЗапросСерий.Текст = СтрЗаменить(ЗапросСерий.Текст, "И СерииНоменклатуры.ПроизводительВЕТИС = &ПроизводительВЕТИС", "");	 
		КонецЕсли;
		
		РезультатСерий = ЗапросСерий.Выполнить();
		Если РезультатСерий.Пустой() Тогда
			
			//СОЗДАНИЕ СЕРИИ
			Если Шаблон.СоздаватьСерииЕслиНеНайдены Тогда				
				НоваяСерия = Справочники.СерииНоменклатуры.СоздатьЭлемент();
				НоваяСерия.ВидНоменклатуры = ВидНоменклатурыПоиск;
				
				НоваяСерия.Номер = НомерСерии;
				Попытка НоваяСерия.ДатаПроизводства = ДатаПроизводства11; Исключение КонецПопытки;
				НоваяСерия.ГоденДо = ДатаОкончанияСрокаГодности17;
				Попытка НоваяСерия.ИдентификаторПартииВЕТИС = НомерВЕТИС; Исключение КонецПопытки;
				Попытка НоваяСерия.ПроизводительВЕТИС = ПроизводительВЕТИС; Исключение КонецПопытки;
				
				НоваяСерия.Записать();
				СтруктураСтроки.СерияСсылка = НоваяСерия.Ссылка;
			КонецЕсли;
			
		Иначе 
			ВыборкаСерий = РезультатСерий.Выгрузить();
			Для каждого Стр Из ВыборкаСерий Цикл
				СтруктураСтроки.СерияСсылка = Стр.Серия;
				Прервать;
			КонецЦикла; 
		КонецЕсли;	
				
		//СЕРИИ МАРКИРОВКА
		ОпределитьСериюВСтрокеДокументаМаркировка(СтруктураСтроки, Шаблон);
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ОпределитьСериюВСтрокеДокументаМаркировка(СтруктураСтроки, Шаблон)
	
	//СЕРИИ МАРКИРОВКА
	Если Шаблон.ИспользоватьМаркировку И Шаблон.ИсточникСерии = 2 Тогда
		
		Если Не ЗначениеЗаполнено(СтруктураСтроки.КМСсылка) Тогда
			ПараметрыТовара = Новый Структура("Номенклатура, Характеристика", СтруктураСтроки.Номенклатура, СтруктураСтроки.ХарактеристикаНоменклатуры);
			СтруктураСтроки.Вставить("КМСсылка", ДатаМобайл_Маркировка.ПолучитьСправочникСсылкаМарка(СтруктураСтроки.ЦРПТМарка, СтруктураСтроки.ЦРПТМарка_Длина, СтруктураСтроки.KM_RawMrc, СтруктураСтроки.KM_TNVED, Шаблон.МаркировкаСоздаватьСправочникКМЕслиНеНайден, ПараметрыТовара, Шаблон));	
		КонецЕсли;
		
		КМСсылка = СтруктураСтроки.КМСсылка;
		
		Если ЗначениеЗаполнено(СтруктураСтроки.СерияСсылка) И ЗначениеЗаполнено(КМСсылка) Тогда		
			Если Не ЗначениеЗаполнено(КМСсылка.Серия) Тогда
				КМОбъект = КМСсылка.ПолучитьОбъект();
				КМОбъект.Серия = СтруктураСтроки.СерияСсылка;
				КМОбъект.Записать();
			КонецЕсли;	
		ИначеЕсли Не ЗначениеЗаполнено(СтруктураСтроки.СерияСсылка) И ЗначениеЗаполнено(КМСсылка) Тогда	
			Если ЗначениеЗаполнено(КМСсылка.Серия) Тогда
				СтруктураСтроки.СерияСсылка = КМСсылка.Серия;
			КонецЕсли;	
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура РазобратьСтрокуСерииПоSNTypes(СтрокаСерии, ДатаПроизводства11, ДатаОкончанияСрокаГодности17, НомерСерии, НомерВЕТИС, ПроизводительВЕТИС, лТовар, РасчитатьГоденДо)
	
	Если Не ЗначениеЗаполнено(лТовар) Тогда
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(лТовар.ВидНоменклатуры.ВладелецСерий) Тогда
		ТекущийВладелецСерий = лТовар.ВидНоменклатуры.ВладелецСерий;
	Иначе
		ТекущийВладелецСерий = лТовар.ВидНоменклатуры;
	КонецЕсли;						
			
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(СтрокаСерии);
	МассивТекущейСерии = ПрочитатьJSON(ЧтениеJSON);
	ЧтениеJSON.Закрыть();
	
	ПорядковыйНомерМассива = 0;
	
	Попытка
		Если ТекущийВладелецСерий.ИспользоватьНомерСерии Тогда //(10)
			ПорядковыйНомерМассива = ПорядковыйНомерМассива + 1;
			НомерСерии = МассивТекущейСерии[ПорядковыйНомерМассива - 1];		
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	Попытка
		Если ТекущийВладелецСерий.ИспользоватьДатуПроизводстваСерии Тогда  //(11)
			ПорядковыйНомерМассива = ПорядковыйНомерМассива + 1;
			ДатаПроизводства11 = МассивТекущейСерии[ПорядковыйНомерМассива - 1];    //07.05.21	
			ДатаПроизводства11 = СтрЗаменить(ДатаПроизводства11, ".", "");				
			ДатаПроизводства11 = РасшифроватьМаскуВвода("dd.mm.yy", ДатаПроизводства11);
		КонецЕсли; 	
	Исключение
	КонецПопытки;
	
	Попытка
		Если ТекущийВладелецСерий.ИспользоватьСрокГодностиСерии Тогда	//(17)
			Если РасчитатьГоденДо И ЗначениеЗаполнено(ДатаПроизводства11) И ЗначениеЗаполнено(лТовар.СрокГодности) Тогда // расчет по настройке
				ДатаОкончанияСрокаГодности17 = РассчитатьГоденДоСерии(лТовар, ДатаПроизводства11);				
			Иначе				
				ПорядковыйНомерМассива = ПорядковыйНомерМассива + 1;
				ДатаОкончанияСрокаГодности17 = МассивТекущейСерии[ПорядковыйНомерМассива - 1];	 //07.05.21
				ДатаОкончанияСрокаГодности17 = СтрЗаменить(ДатаОкончанияСрокаГодности17, ".", "");				
				ДатаОкончанияСрокаГодности17 = РасшифроватьМаскуВвода("dd.mm.yy", ДатаОкончанияСрокаГодности17);
			КонецЕсли;
		КонецЕсли;
	Исключение
	КонецПопытки;	
	
	Попытка
		Если ТекущийВладелецСерий.ИспользоватьИдентификаторПартииВЕТИССерии Тогда //(99)
			ПорядковыйНомерМассива = ПорядковыйНомерМассива + 1;
			НомерВЕТИС = МассивТекущейСерии[ПорядковыйНомерМассива - 1];		
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	Попытка
		Если ТекущийВладелецСерий.ИспользоватьПроизводителяВЕТИССерии Тогда // (100)
			ПорядковыйНомерМассива = ПорядковыйНомерМассива + 1;
			ПроизводительВЕТИССтрока = МассивТекущейСерии[ПорядковыйНомерМассива - 1];
			ПроизводительВЕТИС = Справочники.ПредприятияВЕТИС.НайтиПоНаименованию(ПроизводительВЕТИССтрока);
		КонецЕсли;
	Исключение
	КонецПопытки;
	
КонецПроцедуры

Функция ПолучитьДопускОСГ(Номенклатура, Партнер = Неопределено)
	
	ДопускОСГ = Неопределено;
	
	Попытка 
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		|	1 КАК Приоритет,
		|	ДатаМобайл_ДопускиОСГ_Ном.Допуск КАК Допуск
		|ПОМЕСТИТЬ ТаблицаДопуски	
		|ИЗ
		|	РегистрСведений.ДатаМобайл_ДопускиОСГ КАК ДатаМобайл_ДопускиОСГ_Ном
		|ГДЕ
		|	ДатаМобайл_ДопускиОСГ_Ном.НоменклатураВидНоменклатуры = &Номенклатура 
		|	И ДатаМобайл_ДопускиОСГ_Ном.Партнер = &Партнер
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	2 КАК Приоритет,
		|	ДатаМобайл_ДопускиОСГ_Вид.Допуск КАК Допуск
		|ИЗ
		|	РегистрСведений.ДатаМобайл_ДопускиОСГ КАК ДатаМобайл_ДопускиОСГ_Вид
		|ГДЕ
		|	ДатаМобайл_ДопускиОСГ_Вид.НоменклатураВидНоменклатуры = &Родитель
		|	И ДатаМобайл_ДопускиОСГ_Вид.Партнер = &Партнер
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	3 КАК Приоритет,
		|	ДатаМобайл_ДопускиОСГ_Вид.Допуск КАК Допуск
		|ИЗ
		|	РегистрСведений.ДатаМобайл_ДопускиОСГ КАК ДатаМобайл_ДопускиОСГ_Вид
		|ГДЕ
		|	ДатаМобайл_ДопускиОСГ_Вид.НоменклатураВидНоменклатуры = &ВидНоменклатуры
		|	И ДатаМобайл_ДопускиОСГ_Вид.Партнер = &Партнер
		|;
		|ВЫБРАТЬ ПЕРВЫЕ 1
		|	ТаблицаДопуски.Допуск КАК Допуск
		|ИЗ
		|	ТаблицаДопуски КАК ТаблицаДопуски
		|УПОРЯДОЧИТЬ ПО 
		|	ТаблицаДопуски.Приоритет ВОЗР";
		
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		Запрос.УстановитьПараметр("Родитель", Номенклатура.Родитель);
		Запрос.УстановитьПараметр("ВидНоменклатуры", Номенклатура.ВидНоменклатуры);
		
		Если Партнер = Неопределено Тогда //допуск для товара
			Запрос.УстановитьПараметр("Партнер", Справочники.Партнеры.ПустаяСсылка());	
		ИначеЕсли ЗначениеЗаполнено(Партнер) Тогда //допуск для документа
			Запрос.УстановитьПараметр("Партнер", Партнер);
		Иначе
			Запрос.УстановитьПараметр("Партнер", Неопределено);
		КонецЕсли;	
		
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			ДопускОСГ = Выборка.Допуск;
		КонецЕсли;	
	Исключение
	КонецПопытки;
	
	Возврат ДопускОСГ;
		
КонецФункции	

//Получение значений серии.
//
// Параметры:     
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - ТСД.
// лТовар - СправочникСсылка.Номенклатура - Товар.
// лСерия - СправочникСсылка.СерииНоменклатуры - Серия номенклатуры.
// Insert - Булево - Это "Insert".
//
// Возвращаемое значение:
//   Строка со значением серии.
//
Функция ПолучитьЗначениеСерии(УзелПО, лТовар, лСерия, Insert = Ложь)
	
	ЗначениеСерии = ПолучитьЗначенияSNTypesСерии(лТовар, лСерия, УзелПО.СерииРассчитыватьГоденДо);		
	Возврат ЗначениеСерии;
	
КонецФункции

Функция СформироватьМаскуВвода(Маска, ДатаСерии) 
	
	Серия = "";
	
	Попытка 
		НоваяМаска = СтрЗаменить(Маска, "m", "M");	
		Серия = Формат(ДатаСерии, "ДФ=" + НоваяМаска);	
	Исключение 	
	КонецПопытки;
	
	Возврат Серия;
	
КонецФункции

//Получение значений типов серий.
//
// Параметры:     
// лТовар - СправочникСсылка.Номенклатура - Товар.
// лСерия - СправочникСсылка.СерииНоменклатуры - Серия номенклатуры.
// РасчитыватьГоденДо - Булево.
//
// Возвращаемое значение:
//   JSON с массивом значений типов серий.
//
Функция ПолучитьЗначенияSNTypesСерии(лТовар, лСерия, РасчитыватьГоденДо)
	
	МассивТекущейСерии = Новый Массив;
	
	Если ЗначениеЗаполнено(лТовар) И ЗначениеЗаполнено(лСерия) Тогда
		
		Если ЗначениеЗаполнено(лТовар.ВидНоменклатуры.ВладелецСерий) Тогда
			ТекущийВладелецСерий = лТовар.ВидНоменклатуры.ВладелецСерий;
		Иначе
			ТекущийВладелецСерий = лТовар.ВидНоменклатуры;
		КонецЕсли;						
		
		Попытка
			Если ТекущийВладелецСерий.ИспользоватьНомерСерии Тогда //(10)
				МассивТекущейСерии.Добавить(СокрЛП(лСерия.Номер));
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			Если ТекущийВладелецСерий.ИспользоватьДатуПроизводстваСерии Тогда  //(11)
				МассивТекущейСерии.Добавить(Формат(лСерия.ДатаПроизводства, "ДФ=dd.MM.yy"));
			КонецЕсли; 	
		Исключение
		КонецПопытки;
		
		Попытка
			Если ТекущийВладелецСерий.ИспользоватьСрокГодностиСерии Тогда	//(17)							
				Если РасчитыватьГоденДо Тогда // расчет по настройке
					//Если расссчитывается, то в задание не передаем.
				Иначе
					МассивТекущейСерии.Добавить(Формат(лСерия.ГоденДо, "ДФ=dd.MM.yy"));
				КонецЕсли;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			Если ТекущийВладелецСерий.ИспользоватьИдентификаторПартииВЕТИССерии Тогда //(99)
				МассивТекущейСерии.Добавить(СокрЛП(лСерия.ИдентификаторПартииВЕТИС));
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Попытка
			Если ТекущийВладелецСерий.ИспользоватьПроизводителяВЕТИССерии Тогда // (100)
				МассивТекущейСерии.Добавить(СокрЛП(лСерия.ПроизводительВЕТИС.Наименование));
			КонецЕсли;
		Исключение
		КонецПопытки;
		
	КонецЕсли;
	
	СтрокаJSON = "";
	
	НастройкиСериализации = Новый НастройкиСериализацииJSON;
	НастройкиСериализации.ФорматСериализацииДаты = ФорматДатыJSON.JavaScript;
	ПараметрыJSON = Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет, " ", Истина);
	
	Запись = Новый ЗаписьJSON;
	Запись.ПроверятьСтруктуру = Истина;
	Запись.УстановитьСтроку(ПараметрыJSON);
	
	ЗаписатьJSON(Запись, МассивТекущейСерии, НастройкиСериализации);
	СтрокаJSON = Запись.Закрыть();
	
	Возврат СтрокаJSON;
	
КонецФункции

//Получение массива серий.
//
// Параметры:
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// ТекущийСклад - СправочникСсылка.СтруктурныеЕдиницы - Текущий склад.
// лТовар - СправочникСсылка.Номенклатура - Товар.
// лХарактеристикаНоменклатуры - СправочникСсылка.ХарактеристикиНоменклатуры - Характеристика номенклатуры.
// ТекущаяЯчейка - СправочникСсылка.Ячейки - Текущая ячейка.
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон.
//
// Возвращаемое значение:
//   Массив серий.
//
Функция ПолучитьМассивСерий(УзелПО, СсылкаНаДок, лТовар, лХарактеристикаНоменклатуры, ТекущаяЯчейка, Шаблон);
	
	МассивСерий = Новый Массив;

	Если ЗначениеЗаполнено(ТекущаяЯчейка) Тогда
		
		ЗапросСерийПоЯчейке = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
		|  ТоварыВЯчейкахОстатки.Серия КАК Серия
		|ИЗ
		|  РегистрНакопления.ТоварыВЯчейках.Остатки(
		|        ,
		|        Номенклатура = &Номенклатура 
		|        И Характеристика = &Характеристика
		|        И Ячейка = &Ячейка) КАК ТоварыВЯчейкахОстатки
		|ГДЕ
		|  ТоварыВЯчейкахОстатки.Серия <> ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
		|УПОРЯДОЧИТЬ ПО
		|  ТоварыВЯчейкахОстатки.Серия.ГоденДо ВОЗР,
		|  ТоварыВЯчейкахОстатки.Серия.Номер ВОЗР");
		
		ЗапросСерийПоЯчейке.УстановитьПараметр("Номенклатура", лТовар);
		ЗапросСерийПоЯчейке.УстановитьПараметр("Характеристика", лХарактеристикаНоменклатуры);
		ЗапросСерийПоЯчейке.УстановитьПараметр("Ячейка", ТекущаяЯчейка);
		
		Возврат ЗапросСерийПоЯчейке.Выполнить().Выгрузить().ВыгрузитьКолонку("Серия");
		
	Иначе    
				
		ЗапросСерийПоСкладам = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
		|  ТоварыНаСкладах.Серия КАК Серия
		|ИЗ
		|  РегистрНакопления.ТоварыНаСкладах.Остатки(
		|      ,
		|      (&ВсеСклады
		|        ИЛИ Склад В (&Склады))
		|          И (&ВсеПомещения
		|            ИЛИ Помещение В (&Помещения))
		|          И Номенклатура = &Номенклатура
		|          И Характеристика = &Характеристика) КАК ТоварыНаСкладах
		|ГДЕ
		|  ТоварыНаСкладах.Серия <> ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
		|УПОРЯДОЧИТЬ ПО
		|  ТоварыНаСкладах.Серия.ГоденДо ВОЗР,
		|  ТоварыНаСкладах.Серия.Номер ВОЗР");
		
		ЗапросСерийПоСкладам.УстановитьПараметр("Номенклатура", лТовар);
		ЗапросСерийПоСкладам.УстановитьПараметр("Характеристика", лХарактеристикаНоменклатуры);
		ЗапросСерийПоСкладам.УстановитьПараметр("Ячейка", ТекущаяЯчейка);
		
		СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
		Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
			СписокСкладов.Очистить();
			СписокСкладов.Добавить(СсылкаНаДок.Склад);			
		КонецЕсли;
		ЗапросСерийПоСкладам.УстановитьПараметр("Склады", СписокСкладов);
		ЗапросСерийПоСкладам.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
		
		СписокПомещений=УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
		Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
			СписокПомещений.Очистить();
			СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
		КонецЕсли;
		ЗапросСерийПоСкладам.УстановитьПараметр("Помещения", СписокПомещений);
		ЗапросСерийПоСкладам.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
		
		
		Возврат ЗапросСерийПоСкладам.Выполнить().Выгрузить().ВыгрузитьКолонку("Серия");
		
	КонецЕсли;
	
КонецФункции

Функция РасшифроватьМаскуВвода(Маска, Серия)
	
	НоваяМаска = СтрЗаменить(Маска, ".", "");	
	
	//Считаем год
	гПозиция = Найти(НоваяМаска, "y"); //Позиция года в серии
	гДлина = СтрЧислоВхождений(НоваяМаска, "y");
	//Считаем месяц
	мПозиция = Найти(НоваяМаска, "m"); //Позиция года в серии
	мДлина = СтрЧислоВхождений(НоваяМаска, "m");
	//Считаем день
	дПозиция = Найти(НоваяМаска, "d"); //Позиция года в серии
	дДлина = СтрЧислоВхождений(НоваяМаска, "d");
	
	Год = Сред(Серия, гПозиция, гДлина);
	Месяц = Сред(Серия, мПозиция, мДлина);
	День = Сред(Серия, дПозиция, дДлина);
	Если СтрДлина(Год) = 2 Тогда
		Год = "20" + Год;
	КонецЕсли;
	
	ДатаСерии = Дата(Число(Год), Число(Месяц), Число(День));
	
	Возврат ДатаСерии;
	
КонецФункции

Процедура РазобратьТэгиGS1(СтрокаСерии, ДатаПроизводства11, ДатаОкончанияСрокаГодности17, НомерСерии)
	
	СтрокиGS1 = СтрЗаменить(СтрокаСерии, "[", Символы.ПС);
	
	Для i = 1 По 4 Цикл		
		ТекущийТэг = СтрПолучитьСтроку(СтрокиGS1, i);
		Если ТекущийТэг = "" Тогда
			Продолжить;
		КонецЕсли;	
		
		// РАЗБОР GS1 ТЭГОВ 
		Если СтрНайти(ТекущийТэг, "11]") > 0 Тогда // Тэг 11 (Дата производства)		
			Тэг11 = Сред(ТекущийТэг, 4);  	
			Год11 =  "20" + Лев(Тэг11, 2);
			День11 = Прав(Тэг11, 2);
			Месяц11 = Прав(Лев(Тэг11, 4), 2);
			ДатаПроизв = Год11 + Месяц11 + День11;
			ДатаПроизводства11 = Дата(ДатаПроизв);
		ИначеЕсли СтрНайти(ТекущийТэг, "17]") > 0 Или СтрНайти(ТекущийТэг, "15]") > 0 Тогда // Тэг 17 (Дата окончания срока годности) или Тэг 15 (Дата окончания использования) 			
			Тэг17 = Сред(ТекущийТэг, 4);  	
			Год17 =  "20" + Лев(Тэг17, 2);
			День17 = Прав(Тэг17, 2);
			Месяц17 = Прав(Лев(Тэг17, 4), 2);
			ДатаОСГ = Год17 + Месяц17 + День17;
			ДатаОкончанияСрокаГодности17 = Дата(ДатаОСГ);
		ИначеЕсли СтрНайти(ТекущийТэг, "21]") > 0 Тогда // Тэг 21 (серийный номер)
			СерийныйНомер21 = Сред(ТекущийТэг, 4);
			НомерСерии = СерийныйНомер21
		ИначеЕсли СтрНайти(ТекущийТэг, "10]") > 0 Тогда // Тэг 10 (партия)
			Партия10 = Сред(ТекущийТэг, 4);
			НомерСерии = Партия10;
		КонецЕсли;			
	КонецЦикла;
	
КонецПроцедуры	

//Серия не подходит.
//
// Параметры:     
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// СтрокаДокумента - Структура - Структура данных строки документа.
// ШаблонПроверкиСерии - Строка - Шаблон проверки серии.
//
// Возвращаемое значение:
//   Булево.
//
Функция СерияНеПодходит(УзелПО, СсылкаНаДок, СтрокаДокумента, ШаблонПроверкиСерии)
	
	ВведеннаяСерия = СтрокаДокумента.sn;
	Номенклатура = Справочники.Номенклатура.ПустаяСсылка();  
	Попытка Номенклатура = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(СтрокаДокумента.art.id, 4, 36)); Исключение КонецПопытки;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	|	ДатаМобайл_ПроверкаСерий.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ПроверкаСерий.ШаблонСерии КАК ШаблонСерии,
	|	ИСТИНА КАК ЕстьШаблон
	|ПОМЕСТИТЬ ШаблонПроверки
	|ИЗ
	|	РегистрСведений.ДатаМобайл_ПроверкаСерий КАК ДатаМобайл_ПроверкаСерий
	|ГДЕ
	|	ДатаМобайл_ПроверкаСерий.Номенклатура = &Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ШаблонПроверки.Номенклатура КАК Номенклатура,
	|	ШаблонПроверки.ШаблонСерии КАК ШаблонСерии,
	|	ШаблонПроверки.ЕстьШаблон КАК ЕстьШаблон,
	|	ВЫБОР
	|		КОГДА &ВведеннаяСерия ПОДОБНО ШаблонПроверки.ШаблонСерии
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ШаблонПодходит
	|ИЗ
	|	ШаблонПроверки КАК ШаблонПроверки";
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Запрос.УстановитьПараметр("ВведеннаяСерия", ВведеннаяСерия);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		ШаблонПроверкиСерии = Выборка.ШаблонСерии;
		Если Выборка.ШаблонПодходит Тогда 
			Возврат Ложь; //корректная серия по шаблону
		Иначе	
			Возврат Истина; //серия не подходит по шаблону
		КонецЕсли;
	Иначе 
		Возврат Ложь; //Не задан шаблон
	КонецЕсли;	
	
КонецФункции	

Функция ПроверитьПревышениеОстатковПоСерии(УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки, СообщениеОПревышении)
	
	Если Не ЗначениеЗаполнено(СтруктураСтроки.СерияСсылка) Тогда		
		СообщениеОПревышении = "" + ?(УзелПО.ДобавлятьАртикулВНаименование, СтруктураСтроки.Номенклатура.Артикул + " ", "")
		+ СтруктураСтроки.Номенклатура + " "
		+ СтруктураСтроки.ХарактеристикаНоменклатуры + " " 
		+ СтруктураСтроки.СерийныйНомер + " " + Символы.ПС
		+ " Серия не найдена! Строка не будет записана!";
		Возврат Истина;
	КонецЕсли;	
	
	//Собрано по серии в незавершенных документах
	ЗапросСобрано = Новый Запрос;
	ЗапросСобрано.Текст = "ВЫБРАТЬ
	|	ЕстьNULL(Сумма(ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Количество*ЕстьNULL(ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ЕдиницаИзмерения.Числитель,1)),0) КАК КоличествоСобрано
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Ссылка.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)
	|	И ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Ссылка.Шаблон.КонтролироватьОстатокПоСериям
	|	И ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Номенклатура = &ТекущийТовар
	|	И ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ХарактеристикаНоменклатуры = &ТекущаяХарактеристика
	|	И ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.СерияСсылка = &ТекущаяСерия
	|	И ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Ссылка.Склад = &ТекущийСклад
	|	И ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ЯчейкаСсылка = &ТекущаяЯчейка
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ЕстьNULL(Сумма(ДатаМобайл_СтрокиГрупповыхДокументов.Количество*ЕстьNULL(ДатаМобайл_СтрокиГрупповыхДокументов.ЕдиницаИзмерения.Числитель,1)),0)
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ДатаМобайл_СтрокиГрупповыхДокументов
	|ГДЕ
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД.Шаблон.КонтролироватьОстатокПоСериям
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура = &ТекущийТовар
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.ХарактеристикаНоменклатуры = &ТекущаяХарактеристика
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.СерияСсылка = &ТекущаяСерия
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД.Склад = &ТекущийСклад
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.ЯчейкаСсылка = &ТекущаяЯчейка";
	
	ЗапросСобрано.УстановитьПараметр("ТекущийТовар", СтруктураСтроки.Номенклатура);
	ЗапросСобрано.УстановитьПараметр("ТекущаяХарактеристика", СтруктураСтроки.ХарактеристикаНоменклатуры);
	ЗапросСобрано.УстановитьПараметр("ТекущаяСерия", СтруктураСтроки.СерияСсылка);
	ЗапросСобрано.УстановитьПараметр("ТекущийСклад", СсылкаНаДок.Склад);
	ЗапросСобрано.УстановитьПараметр("ТекущаяЯчейка", СтруктураСтроки.ЯчейкаСсылка);
	
	КоличествоСобрано = 0;
	ВыборкаСобрано = ЗапросСобрано.Выполнить().Выбрать();
	Пока ВыборкаСобрано.Следующий() Цикл
		КоличествоСобрано = КоличествоСобрано + ВыборкаСобрано.КоличествоСобрано;
	КонецЦикла;	
	
	//Собрано в текущей строке
	КоэффициентУпаковки = ?(СтруктураСтроки.ЕдиницаИзмерения.Числитель = 0, 1, СтруктураСтроки.ЕдиницаИзмерения.Числитель);
	КоличествоСобрано = КоличествоСобрано + СтруктураСтроки.Количество * КоэффициентУпаковки;
			
	//Остатки по серии в базе
	Если Не ЗначениеЗаполнено(СтруктураСтроки.ЯчейкаСсылка) Тогда
		ЗапросОстаток = Новый Запрос;
		ЗапросОстаток.Текст = "ВЫБРАТЬ
		|	ЕСТЬNULL(СУММА(ТоварыНаСкладахОстатки.ВНаличииОстаток), 0) - ЕСТЬNULL(СУММА(ТоварыНаСкладахОстатки.КОтгрузкеОстаток), 0) КАК КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Остатки(
		|			,
		|			Номенклатура = &ТекущийТовар
		|				И Характеристика = &ТекущаяХарактеристика
		|				И Серия = &ТекущаяСерия
		|				И Склад = &ТекущийСклад) КАК ТоварыНаСкладахОстатки";
		
		ЗапросОстаток.УстановитьПараметр("ТекущийСклад", СсылкаНаДок.Склад);		
	Иначе
		ЗапросОстаток = Новый Запрос;
		ЗапросОстаток.Текст = "ВЫБРАТЬ
		|	ЕСТЬNULL(СУММА(ТоварыНаСкладахОстатки.ВНаличииОстаток * ЕСТЬNULL(ТоварыНаСкладахОстатки.Упаковка.Числитель, 1)), 0) - ЕСТЬNULL(СУММА(ТоварыНаСкладахОстатки.КОтборуОстаток * ЕСТЬNULL(ТоварыНаСкладахОстатки.Упаковка.Числитель, 1)), 0) КАК КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.ТоварыВЯчейках.Остатки(
		|			,
		|			Номенклатура = &ТекущийТовар
		|				И Характеристика = &ТекущаяХарактеристика
		|				И Серия = &ТекущаяСерия
		|				И Ячейка = &ТекущаяЯчейка) КАК ТоварыНаСкладахОстатки";
		
		ЗапросОстаток.УстановитьПараметр("ТекущаяЯчейка", СтруктураСтроки.ЯчейкаСсылка);		
	КонецЕсли;	
	
	ЗапросОстаток.УстановитьПараметр("ТекущийТовар", СтруктураСтроки.Номенклатура);
	ЗапросОстаток.УстановитьПараметр("ТекущаяХарактеристика", СтруктураСтроки.ХарактеристикаНоменклатуры);
	ЗапросОстаток.УстановитьПараметр("ТекущаяСерия", СтруктураСтроки.СерияСсылка);
		
	КоличествоОстаток = 0;
	ВыборкаОстаток = ЗапросОстаток.Выполнить().Выбрать();
	Пока ВыборкаОстаток.Следующий() Цикл
		КоличествоОстаток = КоличествоОстаток + ВыборкаОстаток.КоличествоОстаток;
	КонецЦикла;			
		
	Если КоличествоСобрано > КоличествоОстаток Тогда		
		СообщениеОПревышении = "" + ?(УзелПО.ДобавлятьАртикулВНаименование, СтруктураСтроки.Номенклатура.Артикул + " ", "")
		+ СтруктураСтроки.Номенклатура + " "
		+ СтруктураСтроки.ХарактеристикаНоменклатуры + " " 
		+ СтруктураСтроки.СерияСсылка + " " + Символы.ПС
		+ "Остаток: " + КоличествоОстаток + Символы.ПС
		+ "Подобрано: " + КоличествоСобрано + Символы.ПС
		+ "Остаток по серии превышен!" + Символы.ПС
		+ "Строка не будет записана!";
		Возврат Истина;
	КонецЕсли;		
	
	Возврат Ложь;
	
КонецФункции	

Функция РассчитатьГоденДоСерии(лТовар, лДатаПроизводства)
	
	СрокГодности   = лТовар.СрокГодности; 
	СрокГодностиЕд = лТовар.ЕдиницаИзмеренияСрокаГодности;
	ГоденДо17      = Дата(1,1,1);
	
	Если СрокГодностиЕд = Перечисления.ЕдиницыИзмеренияВремени.Секунда Тогда
		ГоденДо17 = лДатаПроизводства + СрокГодности * 1;
	ИначеЕсли СрокГодностиЕд = Перечисления.ЕдиницыИзмеренияВремени.Минута Тогда
		ГоденДо17 = лДатаПроизводства + СрокГодности * 60;
	ИначеЕсли СрокГодностиЕд = Перечисления.ЕдиницыИзмеренияВремени.Час Тогда
		ГоденДо17 = лДатаПроизводства + СрокГодности * 60 * 60;
	ИначеЕсли СрокГодностиЕд = Перечисления.ЕдиницыИзмеренияВремени.День Тогда
		ГоденДо17 = лДатаПроизводства + СрокГодности * 60 * 60 * 12;
	ИначеЕсли СрокГодностиЕд = Перечисления.ЕдиницыИзмеренияВремени.Сутки Тогда
		ГоденДо17 = лДатаПроизводства + СрокГодности * 60 * 60 * 24;
	ИначеЕсли СрокГодностиЕд = Перечисления.ЕдиницыИзмеренияВремени.Месяц Тогда
		ГоденДо17 = ДобавитьМесяц(лДатаПроизводства, СрокГодности * 1);
	ИначеЕсли СрокГодностиЕд = Перечисления.ЕдиницыИзмеренияВремени.Год Тогда
		ГоденДо17 = ДобавитьМесяц(лДатаПроизводства, СрокГодности * 12);
	КонецЕсли; 
	
	Возврат ГоденДо17;
	
КонецФункции

#КонецОбласти

#Область ЕдиницыИзмерения

//Установка единицы.
//
// Параметры:     
// СтрокаТЧ - Структура - Структура данных строки.
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон.
//
Функция УстановитьЕдиницу(СтрокаТЧ)
	
	Если СтрокаТЧ.Штрихкод <> "" Тогда
		
		зпр = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
		|	Штрихкоды.Упаковка КАК ЕИ,
		|	Штрихкоды.Номенклатура,
		|	Штрихкоды.Характеристика
		|ПОМЕСТИТЬ тШтрихкоды
		|ИЗ
		|	РегистрСведений.ШтрихкодыНоменклатуры КАК Штрихкоды
		|ГДЕ
		|	Штрихкоды.Штрихкод В (&МассивШК)
		|	И (&ВсяНоменклатура
		|			ИЛИ Штрихкоды.Номенклатура = &Номенклатура)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	тШтрихкоды.ЕИ,
		|	тШтрихкоды.Номенклатура,
		|	тШтрихкоды.Характеристика
		|ИЗ
		|	тШтрихкоды КАК тШтрихкоды");
		
		Barcode = СтрокаТЧ.Штрихкод;
		МассивШК = Новый Массив;
		МассивШК.Добавить(Barcode);		
		Если СтрДлина(Barcode) = 20 И Лев(Barcode,2) = "00" Тогда					 
			Barcode2 = "(00)" + Сред(Barcode, 3, 18);
			МассивШК.Добавить(Barcode2);
		ИначеЕсли СтрДлина(Barcode) = 22 И Лев(Barcode,2) = "(00)" Тогда					 
			Barcode2 = "00" + Сред(Barcode, 5, 18);	
			МассивШК.Добавить(Barcode2);
		КонецЕсли;
	
		зпр.УстановитьПараметр("МассивШК", МассивШК);
		зпр.УстановитьПараметр("Номенклатура", СтрокаТЧ.Номенклатура);
		зпр.УстановитьПараметр("ВсяНоменклатура", СтрокаТЧ.Номенклатура.Пустая());
		рез = зпр.Выполнить().Выгрузить();
		Если Рез.Количество() > 0 Тогда
			СтрокаТЧ.ЕдиницаИзмерения = Рез[0].ЕИ;
			Если СтрокаТЧ.Номенклатура.Пустая() Тогда
				СтрокаТЧ.Номенклатура = Рез[0].Номенклатура;
			КонецЕсли;	
			Если СтрокаТЧ.ХарактеристикаНоменклатуры.Пустая() Тогда
				СтрокаТЧ.ХарактеристикаНоменклатуры = Рез[0].Характеристика;
			КонецЕсли;	
		КонецЕсли; 
		
	Иначе	 
		
		Попытка
			СтрокаТЧ.ЕдиницаИзмерения = XMLЗначение(Тип("СправочникСсылка.УпаковкиЕдиницыИзмерения"), СтрокаТЧ.ИдентификаторЕдИзм); 
		Исключение
		КонецПопытки;	
				
	КонецЕсли; 
	
	Если ЗначениеЗаполнено(СтрокаТЧ.ЕдиницаИзмерения) Тогда		
		
		Коэффициент = ?(СтрокаТЧ.ЕдиницаИзмерения.Числитель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Числитель) / ?(СтрокаТЧ.ЕдиницаИзмерения.Знаменатель = 0, 1, СтрокаТЧ.ЕдиницаИзмерения.Знаменатель);
		
		Пересчет = Ложь;
		
		//Пересчет единиц мерных товаров, учет которых ведется в штуках
		Попытка
			Если 
				Не Справочники.УпаковкиЕдиницыИзмерения.ЭтоМернаяЕдиница(СтрокаТЧ.Номенклатура.ЕдиницаИзмерения)
				И СтрокаТЧ.Номенклатура.ВесИспользовать 
				И Не СтрокаТЧ.Номенклатура.ВесЕдиницаИзмерения.Пустая()
				И СтрокаТЧ.Номенклатура.ВесЧислитель <> 0 
				И СтрокаТЧ.ТСД.ПересчитыватьКоличество
				И СтрДлина(СтрокаТЧ.Штрихкод) = 5  //только весовые, может не всем подойти, надо закомментировать Тогда
				И СтрокаТЧ.ЕдиницаИзмерения.Пустая() Тогда
				
				Коэффициент = СтрокаТЧ.Номенклатура.ВесЧислитель;
				Пересчет = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		//
		
		Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
		ВесЕдиницаИзмерения = Модуль_ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СтрокаТЧ.Номенклатура, "ВесЕдиницаИзмерения");
		
		Попытка
			Если СтрокаТЧ.ТСД.НеИспользоватьПересчетУпаковок Тогда
				СтрокаТЧ.Количество = СтрокаТЧ.Количество;
			Иначе
				СтрокаТЧ.Количество = ?(Пересчет, СтрокаТЧ.Количество / ВесЕдиницаИзмерения.Числитель / Коэффициент, СтрокаТЧ.Количество/Коэффициент);			
			КонецЕсли;
			СтрокаТЧ.КоэффициентЕдиницы = Коэффициент;
		Исключение
			СтрокаТЧ.Количество = СтрокаТЧ.Количество;
			СтрокаТЧ.КоэффициентЕдиницы = 1;
		КонецПопытки;
		
	КонецЕсли;
	
КонецФункции	

Функция ПолучитьШтрихкодУпаковки(лНоменклатура, лХарактеристика, лУпаковка)
	
	ТекущийШтрихкод = "";
	
	Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
	|	ШтрихкодыНоменклатуры.Штрихкод
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|ГДЕ
	|	ШтрихкодыНоменклатуры.Номенклатура = &лНоменклатура
	|	И ШтрихкодыНоменклатуры.Характеристика = &лХарактеристика
	|	И ШтрихкодыНоменклатуры.Упаковка = &лУпаковка
	|");
	
	Запрос.УстановитьПараметр("лНоменклатура", лНоменклатура);
	Запрос.УстановитьПараметр("лХарактеристика", лХарактеристика);
	Запрос.УстановитьПараметр("лУпаковка", лУпаковка);
	
	Рез = Запрос.Выполнить().Выбрать();
	Если Рез.Следующий() Тогда
		Если ЗначениеЗаполнено(Рез.Штрихкод) Тогда
			ТекущийШтрихкод = Рез.Штрихкод;
		КонецЕсли;	
	КонецЕсли;				
	
	Возврат ТекущийШтрихкод;
	
КонецФункции

//Заполнение объекта упаковки.
//
// Параметры:                               
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// ОбъектШтрихкода - Структура - Структура данных объекта штрихкода.
// ТекущаяУпаковка - СправочникСсылка.ЕдиницыИзмерения - Текущая упаковка.
// 
Процедура ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, ТекущаяУпаковка, ТекущаяНоменклатура, Коэффициент = 1)
	
	НаименованиеБазовойУпаковки = "шт.";
	Если ЗначениеЗаполнено(ТекущаяНоменклатура) Тогда
		Если ЗначениеЗаполнено(ТекущаяНоменклатура.ЕдиницаИзмерения) Тогда
			НаименованиеБазовойУпаковки = Строка(ТекущаяНоменклатура.ЕдиницаИзмерения);
		КонецЕсли;		
	КонецЕсли;	 
	
	Попытка
		Если ЗначениеЗаполнено(ТекущаяУпаковка) Тогда
			ОбъектШтрихкода.unit_id = XMLСтрока(ТекущаяУпаковка);
			ОбъектШтрихкода.unit_name = ТекущаяУпаковка.Наименование;
			Если УзелПО.НеИспользоватьПересчетУпаковок Тогда
				КоэффициентУпаковки = 1;
			ИначеЕсли Коэффициент > 1 Тогда 
				КоэффициентУпаковки = Коэффициент;	 
			Иначе	
				Попытка 
					КоэффициентУпаковки = ТекущаяУпаковка.Числитель / ТекущаяУпаковка.Знаменатель;
					КоэффициентУпаковки = ?(КоэффициентУпаковки = 0, 1, КоэффициентУпаковки);
				Исключение
					КоэффициентУпаковки = ?(ТекущаяУпаковка.Числитель = 0, 1, ТекущаяУпаковка.Числитель);
				Конецпопытки;
			КонецЕсли;
			ОбъектШтрихкода.unit_coef = КоэффициентУпаковки;
		Иначе
			ОбъектШтрихкода.unit_id = "";		 		 				 
			ОбъектШтрихкода.unit_name = НаименованиеБазовойУпаковки;
			ОбъектШтрихкода.unit_coef = Коэффициент;
		КонецЕсли;
	Исключение 
		ОбъектШтрихкода.unit_id = "";
		ОбъектШтрихкода.unit_name = НаименованиеБазовойУпаковки;
		ОбъектШтрихкода.unit_coef = 1;
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область Товары

//Сбор данных товаров.
//
// Параметры:  
// ОбъектШтрихкода - Массив - Массив товаров к выгрузке.
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// СписокХарактеристик - Массив - Массив характеристик.
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон. 
// ПакетнаяВыгрузка - Булево - Признак пакетной выгрузки.
// 
// Возвращаемое значение:
//   JSON с массивом данных о товарах.
//
Функция СобратьТовары(СписокТоваров, УзелПО, СписокХарактеристик = Неопределено, Шаблон = Неопределено, ПакетнаяВыгрузка = Ложь, ВыгружатьТоварыДокументаБезШтрихкодов = Ложь, ИсходныйДокумент = Неопределено) Экспорт
	
	ОбъектСписка = Новый Массив();
	
	РежимКомплектации = 0;
	Если Шаблон <> Неопределено Тогда
		РежимКомплектации = Шаблон.РежимКомплектации;	
	КонецЕсли;
	
	ТипЦен = УзелПО.ТипЦен;
	ВключатьАртикул = УзелПО.ДобавлятьАртикулВНаименование; 
	ВключатьАртикулВШК = УзелПО.ИспользоватьАртикулКакШтрихкодТовара;
	ВсеХарактеристикиПоШтрихкоду = УзелПО.ВыводитьВсеХарактеристикиПоШтрихкоду;
	
	Если ВсеХарактеристикиПоШтрихкоду Тогда
		СписокХарактеристик = Неопределено;
	КонецЕсли;
	
	ЗапросТоваров = Новый Запрос();
	
	ЗапросТоваров.УстановитьПараметр("Товар", СписокТоваров);
	ЗапросТоваров.УстановитьПараметр("ВсеТовары", Ложь);	
	Если СписокТоваров.Количество() = 0 Тогда
		ЗапросТоваров.УстановитьПараметр("ВсеТовары", Истина);
	КонецЕсли;
	
	Если СписокХарактеристик = Неопределено Тогда
		ЗапросТоваров.УстановитьПараметр("ВсеХарактеристики", Истина);
		ЗапросТоваров.УстановитьПараметр("Характеристики", СписокХарактеристик);
	Иначе	
		ЗапросТоваров.УстановитьПараметр("Характеристики", СписокХарактеристик);
		ЗапросТоваров.УстановитьПараметр("ВсеХарактеристики", Ложь);	
		Если СписокТоваров.Количество() = 0 Тогда
			ЗапросТоваров.УстановитьПараметр("ВсеХарактеристики", Истина);
		КонецЕсли;
	КонецЕсли;
	
	ЗапросТоваров.УстановитьПараметр("КаталогиТовара", УзелПО.ДоступныеГруппыТоваров.ВыгрузитьКолонку("Номенклатура"));
	ЗапросТоваров.УстановитьПараметр("ВсеКаталоги", Ложь);	
	Если УзелПО.ДоступныеГруппыТоваров.Количество() = 0 Тогда
		ЗапросТоваров.УстановитьПараметр("ВсеКаталоги", Истина);
	КонецЕсли;
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	ЗапросТоваров.УстановитьПараметр("Склады", СписокСкладов);
	ЗапросТоваров.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	ЗапросТоваров.УстановитьПараметр("Помещения", СписокПомещений);
	ЗапросТоваров.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	ТекстЗапроса = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ 
	//ВЫБОРКА ССЫЛОК ТОВАРОВ И ХАРАКТЕРИСТИК ПО РАЗНЫМ УСЛОВИЯМ ВЕДЕНИЯ ХАРАКТЕРИСТИК 
	|	Номенклатура.Ссылка КАК Номенклатура,
	|	Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
	|ПОМЕСТИТЬ СписокТоваровОбщий
	|ИЗ
	| 	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.Ссылка
	|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ИндивидуальныеДляНоменклатуры)
	|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|			И (ХарактеристикиНоменклатуры.Ссылка В (&Характеристики) ИЛИ &ВсеХарактеристики)
	|ГДЕ
	|	НЕ Номенклатура.ЭтоГруппа
	|	И (Номенклатура.Ссылка В (&Товар) ИЛИ &ВсеТовары)
	|	И (Номенклатура.Ссылка В ИЕРАРХИИ (&КаталогиТовара) ИЛИ &ВсеКаталоги)
	|
	|ОБЪЕДИНИТЬ
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ 
	|	Номенклатура.Ссылка КАК Номенклатура,
	|	Номенклатура.ВесМожноУказыватьВДокументах,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВидНоменклатуры
	|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеДляВидаНоменклатуры)
	|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|			И (ХарактеристикиНоменклатуры.Ссылка В (&Характеристики) ИЛИ &ВсеХарактеристики)
	|ГДЕ
	|	НЕ Номенклатура.ЭтоГруппа
	|	И (Номенклатура.Ссылка В (&Товар)ИЛИ &ВсеТовары)
	|	И (Номенклатура.Ссылка В ИЕРАРХИИ (&КаталогиТовара)ИЛИ &ВсеКаталоги)
	|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL   
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ 
	|	Номенклатура.Ссылка КАК Номенклатура,
	|	Номенклатура.ВесМожноУказыватьВДокументах,
	|	ЕСТЬNULL(ХарактеристикиНоменклатуры.Ссылка, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка)) КАК Характеристика
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|			ПО ХарактеристикиНоменклатуры.Владелец = Номенклатура.ВладелецХарактеристик
	|			И Номенклатура.ИспользованиеХарактеристик = ЗНАЧЕНИЕ(Перечисление.ВариантыИспользованияХарактеристикНоменклатуры.ОбщиеСДругимВидомНоменклатуры)
	|			И НЕ ХарактеристикиНоменклатуры.ПометкаУдаления
	|			И (ХарактеристикиНоменклатуры.Ссылка В (&Характеристики) ИЛИ &ВсеХарактеристики)
	|ГДЕ
	|	НЕ Номенклатура.ЭтоГруппа
	|	И (Номенклатура.Ссылка В (&Товар) ИЛИ &ВсеТовары)
	|	И (Номенклатура.Ссылка В ИЕРАРХИИ (&КаталогиТовара) ИЛИ &ВсеКаталоги)
	|	И НЕ ХарактеристикиНоменклатуры.Ссылка ЕСТЬ NULL	
	|	
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ 
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0)) КАК ВНаличии,
	|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.КОтгрузкеОстаток, 0)) КАК ВРезерве,
	|	СвободныеОстаткиОстатки.Номенклатура КАК Номенклатура,
	|	СвободныеОстаткиОстатки.Характеристика КАК Характеристика
	|ПОМЕСТИТЬ ТоварыСОстатками1С
	|ИЗ
	|	РегистрНакопления.ТоварыНаСкладах.Остатки(
	|				,
	|				(&ВсеСклады ИЛИ Склад В (&Склады)) 
	|				И 1=1
	|				И (Номенклатура.Ссылка В (&Товар) ИЛИ &ВсеТовары)
	|				И (Номенклатура.Ссылка В ИЕРАРХИИ (&КаталогиТовара) ИЛИ &ВсеКаталоги)
	|	) КАК СвободныеОстаткиОстатки
	|
	|СГРУППИРОВАТЬ ПО
	|	СвободныеОстаткиОстатки.Номенклатура,
	|	СвободныеОстаткиОстатки.Характеристика
	|;
	|
	|&ТекстЗапросаРаспределениеЗапасов
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ 
	//ВЫБОРКА ЦЕН И ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ПО ТОВАРАМ
	|	СписокТоваровОбщий.Номенклатура,
	|	СписокТоваровОбщий.Весовой,
	|	СписокТоваровОбщий.Характеристика,
	|	ЛОЖЬ КАК ЭтоНовыйТовар,
	|	ВЫБОР
	|		КОГДА СписокТоваровОбщий.Номенклатура.ПометкаУдаления ИЛИ СписокТоваровОбщий.Характеристика.ПометкаУдаления	             
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Удалить,
	|	ВЫБОР
	|		КОГДА &ВключатьАртикул
	|			ТОГДА ВЫБОР КОГДА СписокТоваровОбщий.Номенклатура.Артикул = """" ТОГДА """" ИНАЧЕ СписокТоваровОбщий.Номенклатура.Артикул + "" "" КОНЕЦ
	|		ИНАЧЕ """"
	|	КОНЕЦ + СписокТоваровОбщий.Номенклатура.Наименование + "" "" + ЕстьNULL(СписокТоваровОбщий.Характеристика.Наименование, """") КАК Наименование,
	|	ЕСТЬNULL(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) / ВЫБОР
	|				КОГДА ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель, 0) = 0
	|					ТОГДА 1
	|				ИНАЧЕ ЦеныНоменклатурыСрезПоследних.Упаковка.Числитель
	|			КОНЕЦ КАК ЧИСЛО(19, 2)), 0) КАК Цена,
	|	ЕСТЬNULL(СписокТоваровОбщий.Номенклатура.ВидНоменклатуры.ИспользоватьСерии, ЛОЖЬ) КАК ИспользоватьСерии,
	|	ЕСТЬNULL(ТоварыСОстатками1С.ВНаличии, 0) КАК ВНаличии,
	|	ЕСТЬNULL(ТоварыСОстатками1С.ВРезерве, 0) КАК ВРезерве		 
	|ПОМЕСТИТЬ СписокТоваров
	|ИЗ
	|	СписокТоваровОбщий КАК СписокТоваровОбщий
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&ТекущаяДата, ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
	|			ПО ЦеныНоменклатурыСрезПоследних.Номенклатура = СписокТоваровОбщий.Номенклатура 
	|				И ЦеныНоменклатурыСрезПоследних.Характеристика = СписокТоваровОбщий.Характеристика 
	|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыСОстатками1С КАК ТоварыСОстатками1С
	|			ПО ТоварыСОстатками1С.Номенклатура = СписокТоваровОбщий.Номенклатура
	|				И ТоварыСОстатками1С.Характеристика = СписокТоваровОбщий.Характеристика
	|		&РаспределениеЗапасов
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ДатаМобайл_НовыеТоварыИзменения.Ссылка,
	|	ЛОЖЬ,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.Пустаяссылка),
	|	ИСТИНА,
	|	ВЫБОР
	|		КОГДА ДатаМобайл_НовыеТоварыИзменения.Ссылка.ПометкаУдаления	             
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ДатаМобайл_НовыеТоварыИзменения.Ссылка.Наименование,
	|	0,
	|  ЛОЖЬ,
	|	0,
	|	0
	|ИЗ
	|	Справочник.ДатаМобайл_НовыеТовары.Изменения КАК ДатаМобайл_НовыеТоварыИзменения
	|ГДЕ
	|	ДатаМобайл_НовыеТоварыИзменения.Узел = &Узел
	|	И (ДатаМобайл_НовыеТоварыИзменения.Ссылка В (&Товар) ИЛИ ДатаМобайл_НовыеТоварыИзменения.Ссылка.Номенклатура В (&Товар) ИЛИ &ВсеТовары)
	|	И НЕ ДатаМобайл_НовыеТоварыИзменения.НомерСообщения ЕСТЬ NULL 
	|
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|  ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	//ВЫБОРКА ШТРИХКОДОВ
	|	ВЫРАЗИТЬ(ШтрихкодыНоменклатуры.Штрихкод КАК СТРОКА(60)) КАК Штрихкод,
	|	ШтрихкодыНоменклатуры.Номенклатура,
	|	ШтрихкодыНоменклатуры.Характеристика,
	|	ЕСТЬNULL(ВЫБОР КОГДА ЕСТЬNULL(ШтрихкодыНоменклатуры.Упаковка.Числитель,1) =0 ТОГДА 1 ИНАЧЕ ЕСТЬNULL(ШтрихкодыНоменклатуры.Упаковка.Числитель,1) КОНЕЦ/ 
	|	         ВЫБОР КОГДА ЕСТЬNULL(ШтрихкодыНоменклатуры.Упаковка.Знаменатель,1) = 0 ТОГДА 1 ИНАЧЕ ЕСТЬNULL(ШтрихкодыНоменклатуры.Упаковка.Знаменатель,1) КОНЕЦ, 1) КАК КФ,
	|	ЕСТЬNULL(ШтрихкодыНоменклатуры.Упаковка.Наименование, ШтрихкодыНоменклатуры.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
	|	ШтрихкодыНоменклатуры.Упаковка КАК СсылкаУпаковки
	|ПОМЕСТИТЬ СписокШтрихкодов
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|ГДЕ
	|	(ШтрихкодыНоменклатуры.Номенклатура В ИЕРАРХИИ  (&Товар) ИЛИ &ВсеТовары)
	|	И (ШтрихкодыНоменклатуры.Номенклатура В ИЕРАРХИИ (&КаталогиТовара) ИЛИ &ВсеКаталоги)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫРАЗИТЬ(ДатаМобайл_НовыеШтрихкоды.ШтрихКод КАК Строка(60)),
	|	ДатаМобайл_НовыеШтрихкоды.Номенклатура,
	|	ДатаМобайл_НовыеШтрихкоды.Характеристика,
	|	ДатаМобайл_НовыеШтрихкоды.Коэффициент,
	|	ДатаМобайл_НовыеШтрихкоды.Наименование,
	|	ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка) КАК УпаковкаСсылка
	|ИЗ
	|	РегистрСведений.ДатаМобайл_НовыеШтрихкоды КАК ДатаМобайл_НовыеШтрихкоды
	|ГДЕ
	|	(ДатаМобайл_НовыеШтрихкоды.Номенклатура В ИЕРАРХИИ (&Товар) ИЛИ &ВсеТовары)
	|	И (ДатаМобайл_НовыеШтрихкоды.Номенклатура В ИЕРАРХИИ (&КаталогиТовара) ИЛИ &ВсеКаталоги)
	|	И ДатаМобайл_НовыеШтрихкоды.Номенклатура ССЫЛКА Справочник.Номенклатура
	|
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ  
	//СОЕДИНЕНИЕ ТАБЛИЦ ТОВАРОВ И ШТРИХКОДОВ
	|	СписокТоваров.Номенклатура,
	|	СписокТоваров.Весовой,
	|	СписокТоваров.Номенклатура.Артикул КАК Артикул,
	|	СписокТоваров.Характеристика,
	|	СписокТоваров.Характеристика.Наименование КАК НаименованиеХарактеристики,
	|	СписокТоваров.Номенклатура.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
	|	СписокТоваров.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры, 
	|	СписокТоваров.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
	|	СписокТоваров.ЭтоНовыйТовар,
	|	СписокТоваров.Удалить,
	|	СписокТоваров.Наименование,
	|	СписокТоваров.Цена,
	|	СписокТоваров.ИспользоватьСерии,
	|	СписокТоваров.ВНаличии,
	|  	СписокТоваров.ВРезерве,
	|	ЕСТЬNULL(СписокШтрихкодов.Штрихкод,"""") КАК Штрихкод,
	|	ЕСТЬNULL(СписокШтрихкодов.КФ, 1) КАК КФ,
	|	ЕСТЬNULL(СписокШтрихкодов.НаименованиеУпаковки,""шт."") КАК  НаименованиеУпаковки,
	|	ЕСТЬNULL(СписокШтрихкодов.СсылкаУпаковки,ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка)) КАК  СсылкаУпаковки
	|ИЗ
	|	СписокТоваров КАК СписокТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ СписокШтрихкодов КАК СписокШтрихкодов
	|			ПО СписокШтрихкодов.Номенклатура = СписокТоваров.Номенклатура 
	|				И СписокШтрихкодов.Характеристика = СписокТоваров.Характеристика 
	|ИТОГИ ПО 
	|   СписокТоваров.Номенклатура, СписокТоваров.Характеристика
	|   
	|;
	| УНИЧТОЖИТЬ  СписокТоваровОбщий
	|;
	| УНИЧТОЖИТЬ  СписокТоваров
	|;
	| УНИЧТОЖИТЬ  СписокШтрихкодов
	|";
	
	СкорректироватьЗапросПоЦенообразованию25(ТекстЗапроса, "СобратьТовары");	 
	СкорректироватьЗапросЕслиЕстьРегистрСведенийРаспределениеЗапасов(ТекстЗапроса, "СобратьТовары", УзелПО.УчитыватьОстаткиПоРегиструРаспределениеЗапасов);
	СкорректироватьЗапросЕслиЕстьРегистрНакопленияСвободныеОстатки(ТекстЗапроса, "СобратьТовары", УзелПО.УчитыватьОстаткиПоРегиструСвободныеОстатки);
	
	ЗапросТоваров.Текст = ТекстЗапроса;
	лТипНеопределеннойДлины = Тип("Строка");
	
	Если ВсеХарактеристикиПоШтрихкоду Тогда		
		ЗапросТоваров.Текст = СтрЗаменить(ЗапросТоваров.Текст, "И СписокШтрихкодов.Характеристика = СписокТоваров.Характеристика", "");
	КонецЕсли;
		
	ЗапросТоваров.УстановитьПараметр("Узел", УзелПО);
	ЗапросТоваров.УстановитьПараметр("ТипЦен", ТипЦен);
	ЗапросТоваров.УстановитьПараметр("ВключатьАртикул", ВключатьАртикул);
	ЗапросТоваров.УстановитьПараметр("ТекущаяДата", ТекущаяДата());     
	
	Тип_Услуга = Перечисления.ТипыНоменклатуры.Услуга;
	Тип_Набор  = Перечисления.ТипыНоменклатуры.Набор;
	
	Товары = ЗапросТоваров.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);	
	
	СтруктураСпискаТоваров = Новый Структура;
	
	Пока Товары.Следующий() Цикл
		СтрХарактеристика = Товары.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		
		Пока СтрХарактеристика.Следующий() Цикл
			
			СтрТовара = СтрХарактеристика.Выбрать();
			Сч = 0;
			
			Пока СтрТовара.Следующий() Цикл
				Если Сч = 0 Тогда
					
					ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art");
					
					ОбъектТовара.id = ?(СтрТовара.ЭтоНовыйТовар, "8n-" + XMLСтрока(СтрТовара.Номенклатура), "8U-" + XMLСтрока(СтрТовара.Номенклатура) + XMLСтрока(СтрТовара.Характеристика));	
					ОбъектТовара.name = Лев(ЧистаяСтрока(СтрТовара.Наименование), 150);	
					ОбъектТовара.price = СтрТовара.Цена;
					
					// Выгрузка дополнительных видов цен
					ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, СтрТовара.Номенклатура, СтрТовара.Характеристика);
					
					СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, СтрТовара, СтрТовара.ИспользоватьСерии, Шаблон, ИсходныйДокумент);    				
					
					Если СтрТовара.Наименование = Null Тогда   
						ОбъектТовара.is_deleted = Истина;
					Иначе	 
						ОбъектТовара.is_deleted = СтрТовара.Удалить;
					КонецЕсли;
					
					ЭтоУслуга = Ложь;
					Попытка 
						Если СтрТовара.ВидНоменклатурыТипНоменклатуры = Тип_Услуга Тогда
							ЭтоУслуга = Истина;
						КонецЕсли;
					Исключение
					КонецПопытки;
					
					ЭтоНабор = Ложь;
					Попытка 
						Если СтрТовара.ВидНоменклатурыТипНоменклатуры = Тип_Набор Тогда
							ЭтоНабор = Истина;
						КонецЕсли;
					Исключение
					КонецПопытки;
					
					Если (ЭтоНабор И РежимКомплектации = 1) Или (ЭтоНабор И Шаблон = Неопределено) Тогда
						ОбъектТовара.type = 1;
						ЗаполнитьОбъектНабора(ОбъектТовара, СтрТовара);
					Иначе
						ОбъектТовара.type = 0;
					КонецЕсли;
					
					Если УзелПО.НеОтображатьОстатки Тогда
						ОбъектТовара.rest = 0;
					ИначеЕсли ЭтоУслуга Тогда
						ОбъектТовара.rest = 999;	
					Иначе
						Итог = (СтрТовара.ВНаличии - СтрТовара.ВРезерве);
						ОбъектТовара.rest = Итог;
					КонецЕсли;
					
					Если ОбъектТовара.name = "" И СтрТовара.ЭтоНовыйТовар Тогда
						ОбъектТовара.name = "УдалитьНовыйТовар";
						ОбъектТовара.is_deleted = Истина;
					КонецЕсли;	
					
					Попытка 
						Если ВключатьАртикулВШК и Не ВыгружатьТоварыДокументаБезШтрихкодов Тогда         
							Если ЗначениеЗаполнено(СтрТовара.Артикул) Тогда
								ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode");								 								 
								ОбъектШтрихкода.value = ЧистаяСтрока(СтрТовара.Артикул);   							 
								ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрТовара.СсылкаУпаковки, СтрТовара.Номенклатура);
								ОбъектТовара.barcodes.Добавить(ОбъектШтрихкода);
							КонецЕсли;	
						КонецЕсли;
					Исключение КонецПопытки;	
					
				КонецЕсли;
				
				Сч = Сч + 1;
				
				Если ТипЗнч(СтрТовара.Номенклатура) = Тип("СправочникСсылка.Номенклатура") Тогда
					Штрихкод = СтрТовара.ШтрихКод;
				КонецЕсли;
				
				Если Не Штрихкод = "" и Не ВыгружатьТоварыДокументаБезШтрихкодов Тогда					
					Попытка 
						ОбъектШтрихкода = ПолучитьСтруктуруОбъектаДляHttp("barcode");
						
						Если СтрДлина(ШтрихКод) = 13 // EAN13
							И Лев(ШтрихКод, 1) = "2" // Внутренний штрихкод
							И Сред(ШтрихКод, 2, 1) = "_" Тогда // Найден префикс весового товара
							Штрихкод =  Сред(ШтрихКод, 3, 5);
							ОбъектШтрихкода.value = ЧистаяСтрока(Штрихкод);
						Иначе	
							ОбъектШтрихкода.value = ЧистаяСтрока(ШтрихКод);
						КонецЕсли;	
						
						ЗаполнитьОбъектУпаковки(УзелПО, ОбъектШтрихкода, СтрТовара.СсылкаУпаковки, СтрТовара.Номенклатура);
						
						ОбъектТовара.barcodes.Добавить(ОбъектШтрихкода);
					Исключение
					КонецПопытки;
				КонецЕсли;			                                                                              
			КонецЦикла;
			
			Если ОбъектТовара.name = "" Или ОбъектТовара.id = "" Тогда
				Продолжить;
			КонецЕсли;
			
			ОбъектСписка.Добавить(ОбъектТовара);
		КонецЦикла;
	КонецЦикла;
	
	Если ПакетнаяВыгрузка Тогда		
		СтруктураОтвета = Новый Структура;
		
		НаборЗаписей = РегистрыСведений.ДатаМобайл_ПорционнаяВыгрузка.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ТСД.Установить(УзелПО);
		//1-товары
		НаборЗаписей.Отбор.ТипОбъекта.Установить(1);
		НаборЗаписей.Прочитать();
		
		Если НаборЗаписей.Количество() Тогда       
			СтруктураОтвета.Вставить("is_finished", Ложь);
		Иначе
			СтруктураОтвета.Вставить("is_finished", Истина);
		КонецЕсли;	   		
		
		СтруктураОтвета.Вставить("data", ОбъектСписка);
		Возврат СтруктураОтвета; 
	Иначе
		Возврат ОбъектСписка;
	КонецЕсли;      
	
КонецФункции

Функция ПолучитьДопускВесовогоТовара(Номенклатура, Партнер = Неопределено)
	
	Если Номенклатура.ВесМожноУказыватьВДокументах Тогда	
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
		|	ДатаМобайл_ДопускиВесовыхТоваров.ПроцентДопуска КАК ПроцентДопуска,
		|	ДатаМобайл_ДопускиВесовыхТоваров.Партнер.Наименование
		|ИЗ
		|	РегистрСведений.ДатаМобайл_ДопускиВесовыхТоваров КАК ДатаМобайл_ДопускиВесовыхТоваров
		|ГДЕ
		|	ДатаМобайл_ДопускиВесовыхТоваров.Номенклатура = &Номенклатура
		|	И ДатаМобайл_ДопускиВесовыхТоваров.Партнер = &Партнер
		|
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ДатаМобайл_ДопускиВесовыхТоваров.ПроцентДопуска КАК ПроцентДопуска,
		|	ДатаМобайл_ДопускиВесовыхТоваров.Партнер.Наименование
		|ИЗ
		|	РегистрСведений.ДатаМобайл_ДопускиВесовыхТоваров КАК ДатаМобайл_ДопускиВесовыхТоваров
		|ГДЕ
		|	ДатаМобайл_ДопускиВесовыхТоваров.Номенклатура = &Номенклатура
		|	И ДатаМобайл_ДопускиВесовыхТоваров.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)
		|УПОРЯДОЧИТЬ ПО 
		|	ДатаМобайл_ДопускиВесовыхТоваров.Партнер.Наименование УБЫВ";
		
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		
		Если Партнер = Неопределено Тогда
			Запрос.УстановитьПараметр("Партнер", Справочники.Партнеры.ПустаяСсылка());
		Иначе	
			Запрос.УстановитьПараметр("Партнер", Партнер);
		КонецЕсли;	
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Следующий() Тогда
			Возврат Выборка.ПроцентДопуска * 0.01;
		Иначе
			Возврат Неопределено;
		КонецЕсли;	
		
	Иначе
		Возврат Неопределено;
	КонецЕсли;	
	
КонецФункции	

Функция ПолучитьОстатки(УзелПО, СсылкаНаДок, ТекущаяНоменклатура, ТекущаяХарактеристика, ТекущаяЯчейка, ТекущаяУпаковка)
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	ЗначенияРеквизитовСсылкаНаДок = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок, "Шаблон,Склад,Помещение");
	
	Шаблон 				   		= ЗначенияРеквизитовСсылкаНаДок.Шаблон;
	ТекущийСклад  				= ЗначенияРеквизитовСсылкаНаДок.Склад;
	ТекущееПомещение  			= ЗначенияРеквизитовСсылкаНаДок.Помещение;
	
	КоличествоОстаток = 0;
	
	Если ЗначениеЗаполнено(ТекущаяЯчейка) Тогда	 
		
		ЗапросОстатковПоЯчейке = Новый Запрос("ВЫБРАТЬ
		|	СУММА(ЕСТЬNULL(ТоварыВЯчейкахОстатки.ВНаличииОстаток, 0)) КАК Остаток,
		|	СУММА(ЕСТЬNULL(ТоварыВЯчейкахОстатки.КОтборуОстаток, 0)) КАК ВРезерве,
		|	ТоварыВЯчейкахОстатки.Упаковка КАК Упаковка
		|ИЗ
		|	РегистрНакопления.ТоварыВЯчейках.Остатки КАК ТоварыВЯчейкахОстатки
		|ГДЕ
		|	ТоварыВЯчейкахОстатки.Номенклатура = &Номенклатура
		|	И ТоварыВЯчейкахОстатки.Характеристика = &Характеристика
		|	И ТоварыВЯчейкахОстатки.Ячейка = &Ячейка
		|	И ТоварыВЯчейкахОстатки.Упаковка = &Упаковка
		|СГРУППИРОВАТЬ ПО 
		|	ТоварыВЯчейкахОстатки.Упаковка");
		
		ЗапросОстатковПоЯчейке.УстановитьПараметр("Номенклатура", ТекущаяНоменклатура);
		ЗапросОстатковПоЯчейке.УстановитьПараметр("Характеристика", ТекущаяХарактеристика);
		ЗапросОстатковПоЯчейке.УстановитьПараметр("Ячейка", ТекущаяЯчейка);
		
		Если Шаблон.ПроверкаУпаковокПоЗаданию И ЗначениеЗаполнено(ТекущаяУпаковка) Тогда
			ЗапросОстатковПоЯчейке.УстановитьПараметр("Упаковка", ТекущаяУпаковка); 		 
		Иначе	 
			ЗапросОстатковПоЯчейке.Текст = СтрЗаменить(ЗапросОстатковПоЯчейке.Текст, "И ТоварыВЯчейкахОстатки.Упаковка = &Упаковка", "И 1=1");			 
		КонецЕсли;
		
		ВыборкаОстатокПоЯчейке = ЗапросОстатковПоЯчейке.Выполнить().Выбрать();
		
		Пока ВыборкаОстатокПоЯчейке.Следующий() Цикл
			КоэффициентУпаковки = ?(ВыборкаОстатокПоЯчейке.Упаковка.Числитель = 0, 1, ВыборкаОстатокПоЯчейке.Упаковка.Числитель) / ?(ВыборкаОстатокПоЯчейке.Упаковка.Знаменатель = 0, 1, ВыборкаОстатокПоЯчейке.Упаковка.Знаменатель);
			КоличествоОстаток = КоличествоОстаток + ВыборкаОстатокПоЯчейке.Остаток * КоэффициентУпаковки - ВыборкаОстатокПоЯчейке.ВРезерве * КоэффициентУпаковки;
		КонецЦикла;
		
	Иначе
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.ВНаличииОстаток, 0)) КАК ВНаличии,
		|	СУММА(ЕСТЬNULL(СвободныеОстаткиОстатки.КОтгрузкеОстаток, 0)) КАК ВРезерве,
		|	СвободныеОстаткиОстатки.Номенклатура КАК Номенклатура,
		|	СвободныеОстаткиОстатки.Характеристика КАК Характеристика
		|ИЗ
		|	РегистрНакопления.ТоварыНаСкладах.Остатки(
		|				,
		|				(&ВсеСклады
		|					ИЛИ Склад В (&Склады))
		|				И 1=1
		|					 И Номенклатура = &Номенклатура И Характеристика = &Характеристика) КАК СвободныеОстаткиОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	СвободныеОстаткиОстатки.Номенклатура,
		|	СвободныеОстаткиОстатки.Характеристика";
			
		Запрос.УстановитьПараметр("Номенклатура", ТекущаяНоменклатура);
		Запрос.УстановитьПараметр("Характеристика", ТекущаяХарактеристика);
		
		СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");	
		Если ЗначениеЗаполнено(ТекущийСклад) Тогда	
			СписокСкладов.Очистить();
			СписокСкладов.Добавить(ТекущийСклад);			
		КонецЕсли;		
		Запрос.УстановитьПараметр("Склады", СписокСкладов);
		Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
		
		СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
		Если ЗначениеЗаполнено(ТекущееПомещение) Тогда	
			СписокПомещений.Очистить();
			СписокПомещений.Добавить(ТекущееПомещение);			
		КонецЕсли;	
		Запрос.УстановитьПараметр("Помещения", СписокПомещений);
		Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
		
		СкорректироватьЗапросЕслиЕстьРегистрНакопленияСвободныеОстатки(Запрос.Текст, "ПолучитьОстатки", УзелПО.УчитыватьОстаткиПоРегиструСвободныеОстатки);
		
		ВыборкаОстаток = Запрос.Выполнить().Выбрать();	
		Пока ВыборкаОстаток.Следующий() Цикл
			КоличествоОстаток = КоличествоОстаток + ВыборкаОстаток.ВНаличии - ВыборкаОстаток.ВРезерве;
		КонецЦикла;
		
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСД.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ДокументыСРезервамиТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД КАК ДатаМобайл_ДокументыТСД
	|ГДЕ	
	|	ДатаМобайл_ДокументыТСД.Ссылка <> &ИсходноеЗадание
	|		И НЕ ДатаМобайл_ДокументыТСД.ПометкаУдаления
	|			И ДатаМобайл_ДокументыТСД.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)
	|				И ДатаМобайл_ДокументыТСД.Шаблон.РезервироватьТовар
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЯчейкаСсылка КАК ЯчейкаСсылка,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество,0)) КАК Количество
	|ПОМЕСТИТЬ ДанныеДокументыСРезервамиТСД
	|ИЗ
	|	ДокументыСРезервамиТСД КАК ДокументыСРезервамиТСД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|		ПО ДокументыСРезервамиТСД.Ссылка = ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЯчейкаСсылка
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры КАК Характеристика,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения КАК Упаковка,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЯчейкаСсылка КАК Ячейка,
	|	СУММА(ЕСТЬNULL(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество * (ВЫБОР
	|							КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель = 0
	|									ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель ЕСТЬ NULL
	|								ТОГДА 1
	|							ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Числитель
	|						КОНЕЦ / ВЫБОР
	|							КОГДА ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель = 0
	|									ИЛИ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель ЕСТЬ NULL
	|								ТОГДА 1
	|							ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения.Знаменатель
	|						КОНЕЦ), 0)) КАК ВРезервеТСД
	|ИЗ
	|	ДанныеДокументыСРезервамиТСД КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура = &Номенклатура
	|		И ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры = &Характеристика
	|			И ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения = &Упаковка
	|			  И ДатаМобайл_ДокументыТСДСобранныеДанные.ЯчейкаСсылка = &Ячейка
	|
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЯчейкаСсылка,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура";
	
	Запрос.УстановитьПараметр("ИсходноеЗадание", СсылкаНаДок);
	Запрос.УстановитьПараметр("Номенклатура", ТекущаяНоменклатура);
	Запрос.УстановитьПараметр("Характеристика", ТекущаяХарактеристика);
	
	Если ЗначениеЗаполнено(ТекущаяЯчейка) Тогда
		Запрос.УстановитьПараметр("Ячейка", ТекущаяЯчейка);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И ДатаМобайл_ДокументыТСДСобранныеДанные.ЯчейкаСсылка = &Ячейка", "И 1=1");
	КонецЕсли;
	
	Если Шаблон.ПроверкаУпаковокПоЗаданию И ЗначениеЗаполнено(ТекущаяУпаковка) Тогда
		Запрос.УстановитьПараметр("Упаковка", ТекущаяУпаковка); 		 
	Иначе	 
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И ДатаМобайл_ДокументыТСДСобранныеДанные.ЕдиницаИзмерения = &Упаковка", "И 1=1");			 
	КонецЕсли;
	
	ВыборкаРезервыТСД = Запрос.Выполнить().Выбрать();	
	Пока ВыборкаРезервыТСД.Следующий() Цикл
		КоличествоОстаток = КоличествоОстаток - ВыборкаРезервыТСД.ВРезервеТСД;
	КонецЦикла;
	
	Возврат КоличествоОстаток;
	
КонецФункции

Функция ПолучитьЗадание(УзелПО, СсылкаНаДок, ТекущаяНоменклатура, ТекущаяХарактеристика, ТекущаяЯчейка, ТекущаяУпаковка, Тип)
	
	КоличествоПоЗаданию = 0;
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	ПроверкаУпаковокПоЗаданию = Шаблон.ПроверкаУпаковокПоЗаданию;
	ВидДокумента = Шаблон.ВидДокумента;
	
	Если Тип = "Select" Тогда
		ИмяТабличнойЧасти = Шаблон.ИмяТабличнойЧастиПодбор;
		УчитыватьЯчеекВЗадании = Шаблон.УчитыватьЯчеекВЗаданииПодбор;
	Иначе 
		ИмяТабличнойЧасти = Шаблон.ИмяТабличнойЧастиПриемка;
		УчитыватьЯчеекВЗадании = Шаблон.УчитыватьЯчеекВЗаданииПриемка;
	КонецЕсли;
	
	ЗапросЗадания = Новый Запрос();
	ЗапросЗадания.Текст = "ВЫБРАТЬ
	|	СУММА(ЕСТЬNULL(ЗАДАНИЕ.Количество, 0)) КАК Количество
	|ИЗ
	|	Документ.ПриобретениеТоваровУслуг.Товары КАК ЗАДАНИЕ
	|ГДЕ
	| Задание.ССылка = &ИсходныйДокумент
	|	И ЗАДАНИЕ.Номенклатура = &Номенклатура
	|	И ЗАДАНИЕ.Характеристика = &ХарактеристикаНоменклатуры";
	
	ЗапросЗадания.Текст = СтрЗаменить(ЗапросЗадания.Текст, "ПриобретениеТоваровУслуг", ВидДокумента);	
	ЗапросЗадания.Текст = СтрЗаменить(ЗапросЗадания.Текст, ".Товары", "." + ИмяТабличнойЧасти);
	
	ЗапросЗадания.УстановитьПараметр("ИсходныйДокумент", СсылкаНаДок.ИсходныйДокумент);				
	ЗапросЗадания.УстановитьПараметр("Номенклатура", ТекущаяНоменклатура);
	ЗапросЗадания.УстановитьПараметр("ХарактеристикаНоменклатуры", ТекущаяХарактеристика);	
	
	МетаданныеДокумента = Метаданные.Документы[ВидДокумента];
	
	Если УчитыватьЯчеекВЗадании И ЗначениеЗаполнено(ТекущаяЯчейка) Тогда			 
		Попытка
			ЕстьЯчейка = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧасти].Реквизиты.Найти("Ячейка") <> Неопределено;
		Исключение
			ЕстьЯчейка = Ложь;
		КонецПопытки;
		
		Если ЕстьЯчейка Тогда	 
			ЗапросЗадания.Текст = ЗапросЗадания.Текст + "
			|	И ЗАДАНИЕ.Ячейка = &Ячейка";
			
			ЗапросЗадания.УстановитьПараметр("Ячейка", ТекущаяЯчейка);	
		КонецЕсли;
	КонецЕсли;
	
	Если ПроверкаУпаковокПоЗаданию И ЗначениеЗаполнено(ТекущаяУпаковка) Тогда		 
		Попытка
			ЕстьУпаковка = МетаданныеДокумента.ТабличныеЧасти[ИмяТабличнойЧасти].Реквизиты.Найти("Упаковка") <> Неопределено;
		Исключение
			ЕстьУпаковка = Ложь;
		КонецПопытки;
		
		Если ЕстьУпаковка Тогда		 
			ЗапросЗадания.Текст = ЗапросЗадания.Текст + "
			|	И ЗАДАНИЕ.Упаковка = &Упаковка";
			
			ЗапросЗадания.УстановитьПараметр("Упаковка", ТекущаяУпаковка);			 
		КонецЕсли;
	КонецЕсли;
	
	ВыборкаЗадания = ЗапросЗадания.Выполнить().Выбрать();	 
	Пока ВыборкаЗадания.Следующий() Цикл
		Попытка КоличествоПоЗаданию = КоличествоПоЗаданию + ВыборкаЗадания.Количество; Исключение КонецПопытки; 		
	КонецЦикла;
	
	Возврат КоличествоПоЗаданию;		
	
КонецФункции

Функция РазрешеноРедактированиеТовара(УзелПО, UserName)
	
	//Добавим разрешение администратору который установлен по-умолчанию 
	Если СокрЛП(UserName) = "Администратор" Или СокрЛП(UserName) = "Administrator" Тогда
		Возврат Истина; 
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =	
	"ВЫБРАТЬ
	|	ДатаМобайл_РолиПрава.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ДатаМобайл_Роли.Права КАК ДатаМобайл_РолиПрава
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_Роли.Пользователи КАК ДатаМобайл_РолиПользователи
	|	ПО ДатаМобайл_РолиПрава.Ссылка = ДатаМобайл_РолиПользователи.Ссылка
	|ГДЕ
	|	НЕ ДатаМобайл_РолиПрава.Ссылка.ПометкаУдаления
	|	И ДатаМобайл_РолиПрава.Пометка
	|	И ДатаМобайл_РолиПользователи.Пользователь = &Пользователь
	|	И ДатаМобайл_РолиПрава.ДляТСД = ""is_allow_edit_arts""";
	
	Запрос.УстановитьПараметр("Узел", УзелПО);
	Запрос.УстановитьПараметр("Пользователь", Справочники.ДатаМобайл_Пользователи.НайтиПоНаименованию(UserName, Ложь));
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда       
		Возврат Ложь;
	Иначе
		Возврат Истина;
	КонецЕсли;
		
КонецФункции

Функция РазрешеноРедактированиеШтрихкода(УзелПО, UserName)
	
	//Добавим разрешение администратору который установлен по-умолчанию 
	Если СокрЛП(UserName) = "Администратор" Или СокрЛП(UserName) = "Administrator" Тогда
		Возврат Истина; 
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =	
	"ВЫБРАТЬ
	|	ДатаМобайл_РолиПрава.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ДатаМобайл_Роли.Права КАК ДатаМобайл_РолиПрава
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ДатаМобайл_Роли.Пользователи КАК ДатаМобайл_РолиПользователи
	|	ПО ДатаМобайл_РолиПрава.Ссылка = ДатаМобайл_РолиПользователи.Ссылка
	|ГДЕ
	|	НЕ ДатаМобайл_РолиПрава.Ссылка.ПометкаУдаления
	|	И ДатаМобайл_РолиПрава.Пометка
	|	И ДатаМобайл_РолиПользователи.Пользователь = &Пользователь
	|	И ДатаМобайл_РолиПрава.ДляТСД = ""is_allow_edit_barcodes""";
	
	Запрос.УстановитьПараметр("Узел", УзелПО);
	Запрос.УстановитьПараметр("Пользователь", Справочники.ДатаМобайл_Пользователи.НайтиПоНаименованию(UserName, Ложь));
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда       
		Возврат Ложь;
	Иначе
		Возврат Истина;
	КонецЕсли;
		
КонецФункции

//Получение цен товаров.
//
// Параметры:  
// Номенклатура - СправочникСсылка.Номенклатура - Номенклатура.
// ХарактеристикаНоменклатуры - СправочникСсылка.ХарактеристикиНоменклатуры - Характеристики номенклатуры.
// ТипЦен - СправочникСсылка.ВидыЦен - Тип цены.
// 
// Возвращаемое значение:
//   Число, значение цены.
//
Функция ПолучитьЦенуТовара(Номенклатура, ХарактеристикаНоменклатуры, ТипЦен, УпаковкаСсылка = Неопределено)
	
	лТекущаяЦена = 0;
	
	Если ЗначениеЗаполнено(УпаковкаСсылка) Тогда
		Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
		|	ЦеныНоменклатурыСрезПоследних.Цена КАК Цена
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
		|			&ТекущаяДата,
		|			ВидЦены = &ТипЦен
		|				И Номенклатура = &Номенклатура
		|				И Характеристика = &ХарактеристикаНоменклатуры) КАК ЦеныНоменклатурыСрезПоследних
		|ГДЕ
		|	ЦеныНоменклатурыСрезПоследних.Упаковка = &Упаковка");
		
		СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "ПолучитьЦенуТовара"); 
		
		Запрос.УстановитьПараметр("Упаковка", УпаковкаСсылка); 		 
		Запрос.УстановитьПараметр("ТипЦен", ТипЦен);
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		Запрос.УстановитьПараметр("ХарактеристикаНоменклатуры", ХарактеристикаНоменклатуры);
		Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());  
		Запрос.УстановитьПараметр("Упаковка", УпаковкаСсылка); 
		
		Рез = Запрос.Выполнить().Выбрать();
		Если Рез.Следующий() Тогда    
			лТекущаяЦена = Рез.Цена;
		КонецЕсли;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(лТекущаяЦена) Тогда		
		Запрос = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
		|	ЦеныНоменклатурыСрезПоследних.Цена КАК Цена
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
		|			&ТекущаяДата,
		|			ВидЦены = &ТипЦен
		|				И Номенклатура = &Номенклатура
		|				И Характеристика = &ХарактеристикаНоменклатуры) КАК ЦеныНоменклатурыСрезПоследних");
		
		СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "ПолучитьЦенуТовара"); 
		
		Запрос.УстановитьПараметр("Упаковка", УпаковкаСсылка); 		 
		Запрос.УстановитьПараметр("ТипЦен", ТипЦен);
		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		Запрос.УстановитьПараметр("ХарактеристикаНоменклатуры", ХарактеристикаНоменклатуры);
		Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());  
		
		Рез = Запрос.Выполнить().Выбрать();
		Если Рез.Следующий() Тогда    
			лТекущаяЦена = Рез.Цена;
		КонецЕсли;
	КонецЕсли;
	
	Возврат лТекущаяЦена;
	
КонецФункции

//Формирование заголовков JSONParams товара.
//
// Параметры:   
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// ОбъектТовара - Структура - Структура объекта товара.
// СсылкаТовар - СправочникСсылка.Номенклатура - Номенклатура.
// СсылкаХарактеристика - СправочникСсылка.ХарактеристикиНоменклатуры - Характеристики номенклатуры.
// DMUseSN - Булево - Использование серийных номеров.
// 
Процедура СформироватьЗаголовкиJSONParamsТовара(УзелПО, ОбъектТовара, СтрокаВыборки, DMUseSN = Ложь, Шаблон = Неопределено, ИсходныйДокумент = Неопределено)
	
	ПроверкаРеквизита = Новый Структура("НоменклатураКороба", "");
	ЗаполнитьЗначенияСвойств(ПроверкаРеквизита, СтрокаВыборки);
	Если Не ЗначениеЗаполнено(ПроверкаРеквизита.НоменклатураКороба) Тогда //В маркировке данные в иерархии упаковки могут отличаться от вложенности, поэтому берем данные упаковки
		Номенклатура = СтрокаВыборки.Номенклатура;
		Характеристика = СтрокаВыборки.Характеристика;
		Весовой = СтрокаВыборки.Весовой; 
		НаименованиеХарактеристики = СтрокаВыборки.НаименованиеХарактеристики; 
		ВидНоменклатуры	= СтрокаВыборки.ВидНоменклатуры;
	Иначе
		Номенклатура = СтрокаВыборки.НоменклатураКороба;
		Характеристика = СтрокаВыборки.ХарактеристикаКороба;  
		Попытка Весовой = СтрокаВыборки.ВесовойКороба; Исключение КонецПопытки;
		НаименованиеХарактеристики = Строка(СтрокаВыборки.ХарактеристикаКороба);
		Попытка ВидНоменклатуры	= СтрокаВыборки.ВидНоменклатурыКороба; Исключение КонецПопытки; 		 
	КонецЕсли;
	
	ОбъектТовара.is_use_sn = DMUseSN; 
	
	Попытка ОбъектТовара.parent_id = ?(XMLСтрока(Характеристика) = "00000000-0000-0000-0000-000000000000", "", "8U-" + XMLСтрока(Номенклатура) + "00000000-0000-0000-0000-000000000000"); Исключение КонецПопытки;
	Попытка ОбъектТовара.measure_type = ?(Весовой, 1, 0); Исключение ОбъектТовара.measure_type = 0; КонецПопытки;			
	Попытка ОбъектТовара.mark_type = ДатаМобайл_Маркировка.ПолучитьТипМаркированнойПродукции(Номенклатура); Исключение ОбъектТовара.mark_type = 0; КонецПопытки;
	
	ЭтоНовыйТовар = Ложь;      
	Если Не ТипЗнч(Номенклатура) = Тип("СправочникСсылка.Номенклатура") Тогда
		ЭтоНовыйТовар = Истина;
	КонецЕсли;
	РассчитатьГоденДо = ?(УзелПО = Неопределено, Истина, УзелПО.СерииРассчитыватьГоденДо);		
	
	Атрибуты = ПолучитьАтрибуты(УзелПО); 				
	СтруктураАтрибутов = Новый Структура;	
	Для сч = 1 По 10 Цикл
		Попытка 
			ИмяАтрибута =  Атрибуты["ИмяАтрибута" + сч];
			Если ЭтоНовыйТовар Тогда
				СтруктураАтрибутов.Вставить("attr_" + сч, "");
			ИначеЕсли ИмяАтрибута = "!!! Ячейки !!!" Или ИмяАтрибута = "!!! Основная ячейка !!!" Или ИмяАтрибута = "!!! Дополнительные ячейки !!!" Тогда
				СтруктураАтрибутов.Вставить("attr_" + сч, ПолучитьСправочныеЯчейкиТовара(УзелПО, Номенклатура, ИмяАтрибута));
			ИначеЕсли ИмяАтрибута = "!!! Характеристики !!!" Тогда
				СтруктураАтрибутов.Вставить("attr_" + сч, ЧистаяСтрока(НаименованиеХарактеристики));
			ИначеЕсли Лев(ИмяАтрибута, 3) = "ДР_" Тогда 
				СтруктураАтрибутов.Вставить("attr_" + сч, ПолучитьДополнительныйРеквизитАтрибута(Номенклатура, ИмяАтрибута));	
			ИначеЕсли ИмяАтрибута <> "" Тогда
				СтруктураАтрибутов.Вставить("attr_" + сч, ЧистаяСтрока(Номенклатура[ИмяАтрибута]));						
			Иначе 
				СтруктураАтрибутов.Вставить("attr_" + сч, "");
			КонецЕсли;
		Исключение
			СтруктураАтрибутов.Вставить("attr_" + сч, "");
		КонецПопытки;	
	КонецЦикла;
	
	ОбъектТовара.attributes = СтруктураАтрибутов;
	
	Попытка
		Если DMUseSN И Не ЭтоНовыйТовар Тогда
			
			Если ЗначениеЗаполнено(ВидНоменклатуры.ВладелецСерий) Тогда  
				ТекущийВладелецСерий = ВидНоменклатуры.ВладелецСерий;
			Иначе
				ТекущийВладелецСерий = ВидНоменклатуры;
			КонецЕсли;	
			
			ЕстьПолитикиУчетаСерийПоСкладу = Истина;
			
			Попытка
				Если ИсходныйДокумент <> Неопределено И ТекущийВладелецСерий.ПолитикиУчетаСерий.Количество() > 0 Тогда				
					ПараметрыОтбора = Новый Структура;
					ПараметрыОтбора.Вставить("Склад", ИсходныйДокумент.Склад);
					НайденныеСтроки = ТекущийВладелецСерий.ПолитикиУчетаСерий.НайтиСтроки(ПараметрыОтбора);
					
					Если НайденныеСтроки.Количество() = 0 Тогда
						ЕстьПолитикиУчетаСерийПоСкладу = Ложь;
						ОбъектТовара.is_use_sn = Ложь;
					ИначеЕсли НайденныеСтроки.Количество() > 0 Тогда
						Если НайденныеСтроки[0].ПолитикаУчетаСерий = Справочники.ПолитикиУчетаСерий.СерииНеИспользуются Тогда
							ЕстьПолитикиУчетаСерийПоСкладу = Ложь;
							ОбъектТовара.is_use_sn = Ложь;
						КонецЕсли;	
					КонецЕсли;				
				КонецЕсли;
			Исключение
			КонецПопытки;
			
			МассивТиповСерийныхНомеров = Новый Массив;
			
			Если ЕстьПолитикиУчетаСерийПоСкладу Тогда
				
				Попытка 
					Если ТекущийВладелецСерий.ИспользоватьНомерСерии Тогда //(10)
						МассивТиповСерийныхНомеров.Добавить("10");
					КонецЕсли;
				Исключение
				КонецПопытки;
				
				Попытка
					Если ТекущийВладелецСерий.ИспользоватьДатуПроизводстваСерии Тогда  //(11)
						МассивТиповСерийныхНомеров.Добавить("11");
					КонецЕсли; 	
				Исключение
				КонецПопытки;
				
				Попытка
					Если ТекущийВладелецСерий.ИспользоватьСрокГодностиСерии Тогда	//(17)
						Если РассчитатьГоденДо Тогда
							// не выгружаем тип серийного номера для даты срока годности
						Иначе
							МассивТиповСерийныхНомеров.Добавить("17");
						КонецЕсли;
					КонецЕсли;
				Исключение
				КонецПопытки;
				
				Попытка 
					Если ТекущийВладелецСерий.ИспользоватьИдентификаторПартииВЕТИССерии Тогда //(99)
						МассивТиповСерийныхНомеров.Добавить("99");
					КонецЕсли;
				Исключение
				КонецПопытки;
				
				Попытка
					Если ТекущийВладелецСерий.ИспользоватьПроизводителяВЕТИССерии Тогда // (100)
						МассивТиповСерийныхНомеров.Добавить("100");
					КонецЕсли;
				Исключение
				КонецПопытки;
					
			КонецЕсли;
			
			ОбъектТовара.Вставить("sn_types", МассивТиповСерийныхНомеров);
			
			Если Шаблон = Неопределено Тогда
				ПроверкаОСГ = Истина;
			Иначе
				ПроверкаОСГ = Шаблон.ПроверкаОСГ;
			КонецЕсли;
			
			Попытка
				ДопускОСГ = ПолучитьДопускОСГ(Номенклатура);
			Исключение
				ДопускОСГ = Неопределено;
			КонецПопытки;
			
			Если ДопускОСГ <> Неопределено И ПроверкаОСГ Тогда
				ОбъектТовара.Вставить("remaining_expiration_date_in_days", ДопускОСГ);
			КонецЕсли;
			
		КонецЕсли;
	Исключение
	КонецПопытки;
	
	Если Не ЭтоНовыйТовар Тогда
		Попытка
			Если Весовой Тогда
				Попытка
					ДопускВесовогоТовара = ПолучитьДопускВесовогоТовара(Номенклатура);
				Исключение
					ДопускВесовогоТовара = Неопределено;
				КонецПопытки;
				
				Если ДопускВесовогоТовара <> Неопределено Тогда
					ОбъектТовара.Вставить("weight_task", ДопускВесовогоТовара);
				КонецЕсли;	
			КонецЕсли;
		Исключение
		КонецПопытки;
		
	КонецЕсли;
	
КонецПроцедуры

//Получение номенклатуры по штрихкоду.
//
// Параметры:  
// лШтрихкод - Штрихкод.
// 
// Возвращаемое значение:
// Номенклатура - СправочникСсылка.Номенклатура - Номенклатура.
//
Функция ПолучитьНоменклатуруПоШтрихкоду(лШтрихкод)
	
	Результат = Справочники.Номенклатура.ПустаяСсылка(); 
	
	Если лШтрихкод = "" Тогда
		Возврат Результат;
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура
	|ИЗ
	|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
	|ГДЕ
	|	ШтрихкодыНоменклатуры.Штрихкод = &Штрихкод");
	Запрос.УстановитьПараметр("Штрихкод", лШтрихкод);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Результат = Выборка.Номенклатура;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура СкорректироватьЗапросЕслиЕстьРегистрСведенийРаспределениеЗапасов(ТекстЗапроса, ИмяФункции, УчитыватьОстаткиПоРегиструРаспределениеЗапасов)
	
	ЕстьРегистрСведенийРаспределениеЗапасов = ?(Метаданные.РегистрыСведений.Найти("РаспределениеЗапасов") <> Неопределено, Истина, Ложь);
	ЭтоРеквизитРезерв = Ложь;
	
	Если ЕстьРегистрСведенийРаспределениеЗапасов Тогда
		ЭтоРеквизитРезерв = Метаданные.РегистрыСведений.РаспределениеЗапасов.Ресурсы.Найти("Резерв") <> Неопределено;
		ЭтоРеквизитЗарезервировано = Метаданные.РегистрыСведений.РаспределениеЗапасов.Ресурсы.Найти("Зарезервировано") <> Неопределено;
		
		Если Не (ЭтоРеквизитРезерв Или ЭтоРеквизитЗарезервировано) Тогда
			ЕстьРегистрСведенийРаспределениеЗапасов = Ложь;	
		КонецЕсли;
	КонецЕсли; 
	
	Если ИмяФункции = "GetArtRest" Тогда
		Если ЕстьРегистрСведенийРаспределениеЗапасов И УчитыватьОстаткиПоРегиструРаспределениеЗапасов Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТекстЗапросаРаспределениеЗапасов", 
			"ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ
			|	0 КАК Поле1,
			|	СУММА(РаспределениеЗапасов.Зарезервировано) КАК Зарезервировано,
			|	0 КАК Поле2
			|ИЗ
			|	РегистрСведений.РаспределениеЗапасов КАК РаспределениеЗапасов
			|ГДЕ
			|	РаспределениеЗапасов.Номенклатура = &Номенклатура
			|	И РаспределениеЗапасов.Характеристика = &ХК
			|	И (&ВсеСклады
			|			ИЛИ РаспределениеЗапасов.Склад В (&Склады))");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТекстЗапросаРаспределениеЗапасов", "");	
		КонецЕсли;
	ИначеЕсли ИмяФункции = "СобратьТовары" Тогда
		Если ЕстьРегистрСведенийРаспределениеЗапасов И УчитыватьОстаткиПоРегиструРаспределениеЗапасов Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТекстЗапросаРаспределениеЗапасов",
			"////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	РаспределениеЗапасов.Номенклатура КАК Номенклатура,
			|	РаспределениеЗапасов.Характеристика КАК Характеристика,
			|	СУММА(РаспределениеЗапасов.Зарезервировано) КАК Зарезервировано
			|ПОМЕСТИТЬ ТоварыВРезерве
			|ИЗ
			|	РегистрСведений.РаспределениеЗапасов КАК РаспределениеЗапасов
			|ГДЕ
			|	РаспределениеЗапасов.Номенклатура В (&Товар) ИЛИ &ВсеТовары
			|	И (&ВсеСклады
			|			ИЛИ РаспределениеЗапасов.Склад В (&Склады))
			|
			|СГРУППИРОВАТЬ ПО
			|	РаспределениеЗапасов.Номенклатура,
			|	РаспределениеЗапасов.Характеристика
			|;
			|");
			
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ЕСТЬNULL(ТоварыСОстатками1С.ВНаличии, 0)", "ЕСТЬNULL(ТоварыСОстатками1С.ВНаличии, 0) - ЕСТЬNULL(ТоварыВРезерве.Зарезервировано, 0)");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&РаспределениеЗапасов",
			"		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыВРезерве КАК ТоварыВРезерве
			|			ПО ТоварыСОстатками1С.Номенклатура = ТоварыВРезерве.Номенклатура
			|				И ТоварыСОстатками1С.Характеристика = ТоварыВРезерве.Характеристика");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТекстЗапросаРаспределениеЗапасов", "");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&РаспределениеЗапасов", "");
		КонецЕсли;			 
	ИначеЕсли ИмяФункции = "GetDocRowsSelectCasual" Тогда
		Если ЕстьРегистрСведенийРаспределениеЗапасов И УчитыватьОстаткиПоРегиструРаспределениеЗапасов Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТекстЗапросаРаспределениеЗапасов",
			"////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	РаспределениеЗапасов.Номенклатура КАК Номенклатура,
			|	РаспределениеЗапасов.Характеристика КАК Характеристика,
			|	СУММА(РаспределениеЗапасов.Зарезервировано) КАК Зарезервировано
			|ПОМЕСТИТЬ ТоварыВРезерве
			|ИЗ
			|	РегистрСведений.РаспределениеЗапасов КАК РаспределениеЗапасов
			|ГДЕ
			|	РаспределениеЗапасов.Номенклатура В
			|			(ВЫБРАТЬ
			|				ТаблицаТоваровВДокументе.Номенклатура КАК Номенклатура
			|			ИЗ
			|				ТаблицаТоваровВДокументе1С КАК ТаблицаТоваровВДокументе)
			|	И (&ВсеСклады
			|			ИЛИ РаспределениеЗапасов.Склад В (&Склады))
			|
			|СГРУППИРОВАТЬ ПО
			|	РаспределениеЗапасов.Номенклатура,
			|	РаспределениеЗапасов.Характеристика
			|;
			|");
			
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0) - ЕСТЬNULL(РезервыТСД.Количество, 0))", "СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0) - ЕСТЬNULL(РезервыТСД.Количество, 0) - ЕСТЬNULL(ТоварыВРезерве.Зарезервировано, 0))");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&РаспределениеЗапасов",
			"		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыВРезерве КАК ТоварыВРезерве
			|		ПО ТаблицаТоваровВДокументе1С.Номенклатура = ТоварыВРезерве.Номенклатура
			|			И ТаблицаТоваровВДокументе1С.Характеристика = ТоварыВРезерве.Характеристика");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТекстЗапросаРаспределениеЗапасов", "");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&РаспределениеЗапасов", "");
		КонецЕсли;
	ИначеЕсли ИмяФункции = "ПолучитьИнфоJSON" Тогда	 
		Если ЕстьРегистрСведенийРаспределениеЗапасов И УчитыватьОстаткиПоРегиструРаспределениеЗапасов Тогда
			ТекстЗапроса = "ВЫБРАТЬ РАЗРЕШЕННЫЕ
			|	РаспределениеЗапасов.Склад КАК Склад,
			|	ЗНАЧЕНИЕ(Справочник.СкладскиеПомещения.) КАК Помещение,
			|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.) КАК Серия,
			|	СУММА(РаспределениеЗапасов.Свободно) КАК КоличествоОстаток
			|ИЗ
			|	РегистрСведений.РаспределениеЗапасов КАК РаспределениеЗапасов
			|ГДЕ
			|	РаспределениеЗапасов.Номенклатура = &ТекущаяНоменклатура
			|	И РаспределениеЗапасов.Характеристика = &ТекущаяХарактеристика
			|	И (&ВсеСклады
			|			ИЛИ РаспределениеЗапасов.Склад В (&Склады))
			|	И НЕ РаспределениеЗапасов.Склад В (&МассивАдресныхСкладов)
			|
			|СГРУППИРОВАТЬ ПО
			|	РаспределениеЗапасов.Номенклатура,
			|	РаспределениеЗапасов.Характеристика,
			|	РаспределениеЗапасов.Склад
			|
			|ИМЕЮЩИЕ
			|	СУММА(РаспределениеЗапасов.Свободно) <> 0
			|ИТОГИ
			|	СУММА(КоличествоОстаток)
			|ПО
			|	Склад,
			|	Помещение,
			|	Серия"
		КонецЕсли;	 
	КонецЕсли; 
	
	Если ЭтоРеквизитРезерв Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "Зарезервировано", "Резерв");	
	КонецЕсли; 
	
КонецПроцедуры

Процедура СкорректироватьЗапросЕслиЕстьРегистрНакопленияСвободныеОстатки(ТекстЗапроса, ИмяФункции, УчитыватьОстаткиПоРегиструСвободныеОстатки, ЕстьРегистрНакопленияСвободныеОстатки = Неопределено)
	
	Если ЕстьРегистрНакопленияСвободныеОстатки = Неопределено Тогда
		ЕстьРегистрНакопленияСвободныеОстатки = ДатаМобайл_ОбщийМодуль.ЕстьРегистрНакопления("СвободныеОстатки");	
	КонецЕсли;	
	
	Если ИмяФункции = "GetArtRest" Тогда
		Если УчитыватьОстаткиПоРегиструСвободныеОстатки И ЕстьРегистрНакопленияСвободныеОстатки Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ТоварыНаСкладах", "СвободныеОстатки");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "КОтгрузкеОстаток", "ВРезервеСоСкладаОстаток");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "1=1", "(&ВсеПомещения ИЛИ Помещение В (&Помещения))");
		КонецЕсли;
	ИначеЕсли ИмяФункции = "GetDocRowsSelectCasual" Тогда
		Если УчитыватьОстаткиПоРегиструСвободныеОстатки И ЕстьРегистрНакопленияСвободныеОстатки Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ТоварыНаСкладах"					, "СвободныеОстатки");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "КОтгрузкеОстаток"					, "ВРезервеСоСкладаОстаток");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "СвободныеОстатки.Серия"			, "ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.)");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "СвободныеОстатки.ВНаличииОстаток"	, "СвободныеОстатки.ВНаличииОстаток - СвободныеОстатки.ВРезервеСоСкладаОстаток"); 
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "1=1", "(&ВсеПомещения ИЛИ Помещение В (&Помещения))");
		КонецЕсли;
	ИначеЕсли ИмяФункции = "GetDocRowsSborka_Select" Или ИмяФункции = "GetDocRowsSborka_Insert" Тогда
		Если УчитыватьОстаткиПоРегиструСвободныеОстатки И ЕстьРегистрНакопленияСвободныеОстатки Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "РегистрНакопления.ТоварыНаСкладах.Остатки", "РегистрНакопления.СвободныеОстатки.Остатки");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "СвободныеОстаткиОстатки.КОтгрузкеОстаток", "СвободныеОстаткиОстатки.ВРезервеСоСкладаОстаток+СвободныеОстаткиОстатки.ВРезервеПодЗаказОстаток");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ИЛИ Помещение В (&Склады)", "");
		КонецЕсли;
	ИначеЕсли ИмяФункции = "ПолучитьИнфоTEXT" Или ИмяФункции = "ПолучитьИнфоJSON" Тогда
		Если УчитыватьОстаткиПоРегиструСвободныеОстатки И ЕстьРегистрНакопленияСвободныеОстатки Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ТоварыНаСкладахОстатки.Помещение"			, "Значение(Справочник.СкладскиеПомещения.)");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ТоварыНаСкладахОстатки.Серия"				, "ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.)");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ТоварыНаСкладах"							, "СвободныеОстатки");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "СвободныеОстаткиОстатки.ВНаличииОстаток"	, "СвободныеОстаткиОстатки.ВНаличииОстаток - СвободныеОстаткиОстатки.ВРезервеСоСкладаОстаток");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "КОтгрузкеОстаток"							, "ВРезервеСоСкладаОстаток");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "1=1"										, "(&ВсеПомещения ИЛИ ТоварыНаСкладахОстатки.Помещение В (&Помещения))");
		КонецЕсли;
	ИначеЕсли ИмяФункции = "СобратьТовары" Или ИмяФункции = "ПолучитьОстатки" Тогда
		Если УчитыватьОстаткиПоРегиструСвободныеОстатки И ЕстьРегистрНакопленияСвободныеОстатки Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ТоварыНаСкладах"							, "СвободныеОстатки");
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "КОтгрузкеОстаток"							, "ВРезервеСоСкладаОстаток"); 
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "1=1", "(&ВсеПомещения ИЛИ Помещение В (&Помещения))");
		КонецЕсли;	
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьХарактеристикиИзХарактеристикаНоменклатурыДляЦенообразования(МассивХарактеристикЦО)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ХарактеристикиНоменклатуры.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ХарактеристикиНоменклатуры КАК ХарактеристикиНоменклатуры
	|ГДЕ
	|	ХарактеристикиНоменклатуры.ХарактеристикаНоменклатурыДляЦенообразования В(&ХарактеристикаНоменклатурыДляЦенообразования)";
	
	Запрос.УстановитьПараметр("ХарактеристикаНоменклатурыДляЦенообразования", МассивХарактеристикЦО);	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
КонецФункции

//Получение дополнительных цен товаров и заполнение объекта доп.цен.
//
// Параметры: 
// ОбъектДопЦены - Структура - Объект дополнительных цен.
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// Номенклатура - СправочникСсылка.Номенклатура - Номенклатура.
// Характеристика - СправочникСсылка.ХарактеристикиНоменклатуры - Характеристики номенклатуры.
// 
// Возвращаемое значение:
//   Число, значение цены.
//
Процедура ЗаполнитьОбъектДопЦен(ОбъектТовара, УзелПО, Номенклатура, Характеристика)
	
	ОбъектДопЦены = ПолучитьСтруктуруОбъектаДляHttp("additional_prices");
				
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	СписокТСД.ТипЦенДоп1 КАК ТипЦенДоп1,
	|	СписокТСД.ТипЦенДоп2 КАК ТипЦенДоп2,
	|	СписокТСД.ТипЦенДоп3 КАК ТипЦенДоп3
	|ПОМЕСТИТЬ втТипыЦен
	|ИЗ
	|   ПланОбмена.ДатаМобайл_СписокТСД КАК СписокТСД
	|ГДЕ
	|   СписокТСД.Ссылка = &ТСД
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ТипЦенДоп1,
	|	ТипЦенДоп2,
	|	ТипЦенДоп3
	|; 
	|/////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЦеныНоменклатурыСрезПоследних.ВидЦены КАК ВидЦены,
	|	ЦеныНоменклатурыСрезПоследних.Цена КАК Цена
	|ПОМЕСТИТЬ втПоследниеЦены
	|ИЗ
	|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
	|			&ТекущаяДата,
	|				Номенклатура = &Номенклатура
	|				И Характеристика = &ХарактеристикаНоменклатуры) КАК ЦеныНоменклатурыСрезПоследних
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ВидЦены
	|; 
	|/////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА НЕ втТипыЦен.ТипЦенДоп1 = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка) ТОГДА ЕстьNULL(втПоследниеЦены1.Цена, 0) ИНАЧЕ 100000001 КОНЕЦ КАК price_1,	
	|	ВЫБОР КОГДА НЕ втТипыЦен.ТипЦенДоп2 = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка) ТОГДА ЕстьNULL(втПоследниеЦены2.Цена, 0) ИНАЧЕ 100000001 КОНЕЦ КАК price_2,
	|	ВЫБОР КОГДА НЕ втТипыЦен.ТипЦенДоп3 = ЗНАЧЕНИЕ(Справочник.ВидыЦен.ПустаяСсылка) ТОГДА ЕстьNULL(втПоследниеЦены3.Цена, 0) ИНАЧЕ 100000001 КОНЕЦ КАК price_3
	|ИЗ
	|   втТипыЦен КАК втТипыЦен
	|	ЛЕВОЕ СОЕДИНЕНИЕ втПоследниеЦены КАК втПоследниеЦены1
	|   	ПО втТипыЦен.ТипЦенДоп1 = втПоследниеЦены1.ВидЦены
	|	ЛЕВОЕ СОЕДИНЕНИЕ втПоследниеЦены КАК втПоследниеЦены2
	|   	ПО втТипыЦен.ТипЦенДоп2 = втПоследниеЦены2.ВидЦены
	|	ЛЕВОЕ СОЕДИНЕНИЕ втПоследниеЦены КАК втПоследниеЦены3
	|   	ПО втТипыЦен.ТипЦенДоп3 = втПоследниеЦены3.ВидЦены
	|");
	
	СкорректироватьЗапросПоЦенообразованию25(Запрос.Текст, "ПолучитьЦенуТовара");

	Запрос.УстановитьПараметр("ТСД"                       , УзелПО);
	Запрос.УстановитьПараметр("Номенклатура"              , Номенклатура);
	Запрос.УстановитьПараметр("ХарактеристикаНоменклатуры", Характеристика);
	Запрос.УстановитьПараметр("ТекущаяДата"               , ТекущаяДата());
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(ОбъектДопЦены, Выборка);
	КонецЕсли;
	
	// удаление пустых
	Для каждого Элемент Из ОбъектДопЦены Цикл
		Если Элемент.Значение = 100000001 Тогда
			ОбъектДопЦены.Удалить(Элемент.Ключ);
		КонецЕсли;
	КонецЦикла;	
	
	Если ОбъектДопЦены.Количество() > 0 Тогда
		ОбъектТовара.Вставить("additional_prices", ОбъектДопЦены);
	КонецЕсли;
	
КонецПроцедуры

//Получение комплектующих по набору.
//
// Параметры: 
// ОбъектТовара - Структура - Структура объекта товара.
// СтрТовара - Результат выборки - данные по товару из запроса
//
Процедура ЗаполнитьОбъектНабора(ОбъектТовара, СтрТовара, Характеристика = Неопределено)
	
	Если Характеристика = Неопределено Тогда
		Характеристика = СтрТовара.Характеристика;	
	КонецЕсли;
		
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ВариантыКомплектацииНоменклатурыТовары.Ссылка.Владелец КАК НоменклатураНабора,
	|	ВариантыКомплектацииНоменклатурыТовары.Ссылка.Характеристика КАК ХарактеристикаНабора,
	|	ВариантыКомплектацииНоменклатурыТовары.Номенклатура КАК Номенклатура,
	|	ВариантыКомплектацииНоменклатурыТовары.Характеристика КАК Характеристика,
	|	ВариантыКомплектацииНоменклатурыТовары.Количество КАК Количество
	|ИЗ
	|	Справочник.ВариантыКомплектацииНоменклатуры.Товары КАК ВариантыКомплектацииНоменклатурыТовары
	|ГДЕ
	|	НЕ ВариантыКомплектацииНоменклатурыТовары.Ссылка.ПометкаУдаления
	|	И НЕ ВариантыКомплектацииНоменклатурыТовары.Ссылка.Владелец.ПометкаУдаления
	|	И ВариантыКомплектацииНоменклатурыТовары.Ссылка.Владелец = &НоменклатураНабора
	|	И ВариантыКомплектацииНоменклатурыТовары.Ссылка.Характеристика = &ХарактеристикаНабора");
	
	Запрос.УстановитьПараметр("НоменклатураНабора", СтрТовара.Номенклатура);
	Запрос.УстановитьПараметр("ХарактеристикаНабора", Характеристика);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ОбъектНабора = ПолучитьСтруктуруОбъектаДляHttp("kit"); 
		
		ОбъектНабора.art_id 	= "8U-" + XMLСтрока(Выборка.Номенклатура) + XMLСтрока(Выборка.Характеристика);// ID номенклатуры 				 		 
		ОбъектНабора.qty 		=  Выборка.Количество;  // Количество
		
		ОбъектТовара.kit_parts.Добавить(ОбъектНабора);
		
	КонецЦикла;
	 	 
КонецПроцедуры

Процедура СкорректироватьЗапросЕслиЕстьРегистрСведенийОписаниеGTINИС(ТекстЗапроса, ИмяФункции)
	
	ЕстьРегистрСведенийОписаниеGTINИС = ?(Метаданные.РегистрыСведений.Найти("ОписаниеGTINИС") <> Неопределено, Истина, Ложь);
	ЭтоРеквизитКоэффициент = Ложь;
	
	Если ЕстьРегистрСведенийОписаниеGTINИС Тогда
		ЭтоРеквизитКоэффициент = Метаданные.РегистрыСведений.ОписаниеGTINИС.Реквизиты.Найти("Коэффициент") <> Неопределено;
	КонецЕсли; 
		
	Если ЭтоРеквизитКоэффициент Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "ОписаниеGTINИС.КоличествоПотребительскихУпаковок", "ОписаниеGTINИС.Коэффициент");	
	КонецЕсли; 
	
КонецПроцедуры

#КонецОбласти

#Область Ячейки

Функция ПолучитьСправочныеЯчейкиТовара(УзелПО, Номенклатура, ИмяАтрибута)
	
	СтрокаЯчеек = "";
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Ячейки.Ячейка.Представление КАК АдресХранения,
	|	ВЫБОР КОГДА Ячейки.ОсновнаяЯчейка ТОГДА 1 ИНАЧЕ 0 КОНЕЦ КАК Приоритет
	|ПОМЕСТИТЬ ЯчейкиСПриоритетом	
	|ИЗ
	|	РегистрСведений.РазмещениеНоменклатурыПоСкладскимЯчейкам КАК Ячейки
	|ГДЕ
	|	Ячейки.Номенклатура=&Номенклатура 
	|	И (&ВсеСклады ИЛИ Ячейки.Склад В (&Склады))
	|	И (&ВсеПомещения ИЛИ Ячейки.Помещение В (&Помещения))
	|	И 1=1
	|;
	|ВЫБРАТЬ
	|	ЯчейкиСПриоритетом.АдресХранения КАК АдресХранения,
	|	ЯчейкиСПриоритетом.Приоритет КАК Приоритет
	|ИЗ
	|	ЯчейкиСПриоритетом КАК ЯчейкиСПриоритетом
	|УПОРЯДОЧИТЬ ПО 
	|	ЯчейкиСПриоритетом.Приоритет УБЫВ,
	|	ЯчейкиСПриоритетом.АдресХранения ВОЗР");
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		
	Если ИмяАтрибута = "!!! Основная ячейка !!!" Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "1=1", "Ячейки.ОсновнаяЯчейка");
	ИначеЕсли ИмяАтрибута = "!!! Дополнительные ячейки !!!" Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "1=1", "НЕ Ячейки.ОсновнаяЯчейка");	
	КонецЕсли;
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
		
	Рез = Запрос.Выполнить().Выбрать();
	Пока Рез.Следующий() Цикл
		Если СтрокаЯчеек = "" Тогда
			СтрокаЯчеек = СтрокаЯчеек + Рез.АдресХранения;
		Иначе	
			СтрокаЯчеек =  СтрокаЯчеек + ", " + Рез.АдресХранения;
		КонецЕсли;	
	КонецЦикла;	
	
	Возврат СтрокаЯчеек;
	
КонецФункции

//Очистка справочного размещения по товару.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// Номенклатура - СправочникСсылка.Номенклатура - Номенклатура.
// ТекстОписания - Строка - Текст описания ошибки. 
// 
// Возвращаемое значение:
// Булево - Результат обработки.
//
Функция ЯчейкиСправочноеРазмещениеПоТоваруОчистить(УзелПО, Номенклатура, ТекстОписания)
	
	ЕстьОшибки = Ложь;
	ТекстОшибки = "";
	
	Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РазмещениеНоменклатуры.Номенклатура КАК Номенклатура,
	|	РазмещениеНоменклатуры.Склад КАК Склад,
	|	РазмещениеНоменклатуры.Помещение КАК Помещение,
	|	РазмещениеНоменклатуры.Ячейка КАК Ячейка
	|ИЗ
	|	РегистрСведений.РазмещениеНоменклатурыПоСкладскимЯчейкам КАК РазмещениеНоменклатуры
	|ГДЕ
	|	РазмещениеНоменклатуры.Номенклатура=&Номенклатура 
	|	И (&ВсеСклады ИЛИ РазмещениеНоменклатуры.Склад В (&Склады))
	|	И (&ВсеПомещения ИЛИ РазмещениеНоменклатуры.Помещение В (&Помещения))");
	
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	Выборка = Запрос.Выполнить().Выбрать();	
	НачатьТранзакцию();
	
	Пока Выборка.Следующий() Цикл
		Рег = РегистрыСведений.РазмещениеНоменклатурыПоСкладскимЯчейкам.СоздатьМенеджерЗаписи();
		Рег.Номенклатура = Выборка.Номенклатура;
		Рег.Склад        = Выборка.Склад;
		Рег.Помещение    = Выборка.Помещение;
		Рег.Ячейка       = Выборка.Ячейка; 
		
		Рег.Прочитать();
		Если Рег.Выбран() Тогда
			Попытка			
				Рег.Удалить();
			Исключение
				ТекстОшибки = ОписаниеОшибки();
				Прервать;
			КонецПопытки;
		КонецЕсли;		
	КонецЦикла;
	
	Если ЕстьОшибки Тогда
		ОтменитьТранзакцию();
		ТекстОписания = "Ошибка очистки справочного размещения для номенклатуры:" + Символы.ПС + ТекстОшибки;
		Возврат Ложь;
	Иначе
		ЗафиксироватьТранзакцию();
		ТекстОписания = "Ячейки справочного размещения для номенклатуры очищены!"; 
		Возврат Истина;
	КонецЕсли;
	
КонецФункции

//Создание справочного размещения по товару.
//
// Параметры: 
// Номенклатура - СправочникСсылка.Номенклатура - Номенклатура.
// Ячейка - СправочникСсылка.Ячейки - Текущая ячейка.
// ТекстОписания - Строка - Текст описания ошибки. 
// 
// Возвращаемое значение:
// Булево - Результат обработки.
// 
Функция ЯчейкиСправочноеРазмещениеПоТоваруСоздать(Номенклатура, Ячейка, ТекстОписания)
	
	Результат = Ложь; 
	
	Рег = РегистрыСведений.РазмещениеНоменклатурыПоСкладскимЯчейкам.СоздатьМенеджерЗаписи();
	Рег.Номенклатура = Номенклатура;
	Рег.Склад        = Ячейка.Владелец;
	Рег.Помещение    = Ячейка.Помещение;
	Рег.Ячейка       = Ячейка; 
	
	Рег.Прочитать();
	Если Рег.Выбран() Тогда		
		Результат = Истина;		
	Иначе 
		Рег.Номенклатура   = Номенклатура;
		Рег.Склад          = Ячейка.Владелец;
		Рег.Помещение      = Ячейка.Помещение;
		Рег.Ячейка         = Ячейка;
		Рег.ОсновнаяЯчейка = Истина;
		
		Попытка	
			Рег.Записать();
			Результат = Истина;
		Исключение
			Попытка // еще раз не основной
				Рег.ОсновнаяЯчейка = Ложь;
				Рег.Записать();
				Результат = Истина;				
			Исключение
				ТекстОписания = ОписаниеОшибки();
				Результат = Ложь;
			КонецПопытки;
		КонецПопытки;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

//Обработка справочного размещения по товару.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// CellBC - Строка - Штрихкод ячейки.
// ArtID - Строка - Id товара. 
// Barcode - Строка - Штрихкод. 
// Ячейка - СправочникСсылка.Ячейки - Текущая ячейка.
// ТекстОписания - Строка - Текст описания ошибки. 
// 
// Возвращаемое значение:
// Булево - Результат обработки.
//
Функция ЯчейкиСправочноеРазмещениеПоТоваруОбработать(УзелПО, CellBC, ArtID, Barcode, Ячейка, ТекстОписания)
	
	Если Лев(ArtID, 3) = "8U-" Тогда
		лТовар = XMLЗначение(Тип("СправочникСсылка.Номенклатура"), Сред(ArtID, 4, 36));
	Иначе   
		лТовар = Справочники.Номенклатура.ПустаяСсылка();
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(лТовар) Тогда
		лТовар = ПолучитьНоменклатуруПоШтрихкоду(Barcode);
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(лТовар) Тогда
		ТекстОписания = "Не найден товар для обработки справочного размещения.";		
		Возврат Ложь;	
	КонецЕсли;
	
	// очистка
	Если СокрЛП(УзелПО.ШтрихкодОчисткиСправочногоРазмещенияЯчеек) = CellBC Тогда
		Рез = ЯчейкиСправочноеРазмещениеПоТоваруОчистить(УзелПО, лТовар, ТекстОписания);
		Возврат Ложь;
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Ячейка) Тогда
		ТекстОписания = "Ячейка по штрихкоду " + CellBC + " не найдена в базе.";		
		Возврат Ложь;	
	КонецЕсли;
	
	// проверка и создание нового размещения
	Рез = ЯчейкиСправочноеРазмещениеПоТоваруСоздать(лТовар, Ячейка, ТекстОписания);
	Возврат Рез;
	
КонецФункции

Функция ПроверитьБлокировкуЯчеек(ТекущаяЯчейка, ОписаниеОшибки, ЭтоПодбор = Ложь)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	БлокировкиСкладскихЯчеек.Ячейка КАК Ячейка,
	|	БлокировкиСкладскихЯчеек.ТипБлокировки КАК ТипБлокировки
	|ИЗ
	|	РегистрСведений.БлокировкиСкладскихЯчеек КАК БлокировкиСкладскихЯчеек
	|ГДЕ
	|	БлокировкиСкладскихЯчеек.Ячейка = &Ячейка
	|	И ВЫБОР
	|			КОГДА &ЭтоПодбор
	|				ТОГДА БлокировкиСкладскихЯчеек.ТипБлокировки <> ЗНАЧЕНИЕ(Перечисление.ТипыБлокировокСкладскихЯчеек.Размещение)
	|			ИНАЧЕ БлокировкиСкладскихЯчеек.ТипБлокировки <> ЗНАЧЕНИЕ(Перечисление.ТипыБлокировокСкладскихЯчеек.Отбор)
	|		КОНЕЦ";
	
	Запрос.УстановитьПараметр("Ячейка"		, ТекущаяЯчейка);
	Запрос.УстановитьПараметр("ЭтоПодбор"	, ЭтоПодбор);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		ОписаниеОшибки = НСтр("ru='Ячейка %Ячейка% заблокирована: тип блокировки ""%ТипБлокировки%""'");
		ОписаниеОшибки = СтрЗаменить(ОписаниеОшибки, "%Ячейка%", Выборка.Ячейка);
		ОписаниеОшибки = СтрЗаменить(ОписаниеОшибки, "%ТипБлокировки%", Выборка.ТипБлокировки);
		
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

#КонецОбласти 

#Область Ценообразование 

Процедура СкорректироватьЗапросПоЦенообразованию25(ТестЗапросаИсх, ИмяФункции)
	
	Если Не ДатаМобайл_ОбщийМодуль.Ценообразование25() Тогда Возврат; КонецЕсли;
	
	ТекстЗапроса = ТестЗапросаИсх;
	
	Если ИмяФункции = "GetCellContent" Или ИмяФункции = "OnArtScan_Select_Insert_Cells" Или ИмяФункции = "OnArtScan_Select_Insert_Casual" 
		Или ИмяФункции = "OnArtScan_Select_EGAIS" Или ИмяФункции = "ПолучитьСодержимоеУпаковки_НашУпаковочныйЛист" 
		Или ИмяФункции = "ПолучитьСодержимоеУпаковки_ТиповойУпаковочныйЛист" Тогда
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, 
		"РегистрСведений.ЦеныНоменклатуры.СрезПоследних", 
		"РегистрСведений.ЦеныНоменклатуры25.СрезПоследних");
		
		Если ИмяФункции = "OnArtScan_Select_Insert_Casual" Тогда
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, 
			"И ДоступныеТовары.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика",
			"			И (ЦеныНоменклатурыСрезПоследних.ХарактеристикаЦО В (ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатурыДляЦенообразования.ПустаяСсылка))
			|				ИЛИ ЦеныНоменклатурыСрезПоследних.ХарактеристикаЦО В
			|					(ВЫБРАТЬ
			|						Хар.ХарактеристикаНоменклатурыДляЦенообразования КАК ХарактеристикаЦО
			|					ИЗ
			|						Справочник.ХарактеристикиНоменклатуры КАК Хар
			|					ГДЕ
			|						Хар.Ссылка В
			|							(ВЫБРАТЬ
			|								ДоступныеТовары.Характеристика КАК Характеристика
			|							ИЗ
			|								ДоступныеТовары КАК ДоступныеТовары)))");
		Иначе
			ТекстЗапроса = СтрЗаменить(ТекстЗапроса, 
			"И ДоступныеТовары.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика", 
			"И ДоступныеТовары.Характеристика.ХарактеристикаНоменклатурыДляЦенообразования = ЦеныНоменклатурыСрезПоследних.ХарактеристикаЦО");	
		КонецЕсли;
		
	ИначеЕсли ИмяФункции = "ПолучитьНоменклатуруУпаковкиМДЛП" Или ИмяФункции = "ПолучитьСодержимоеУпаковки_Маркировка" Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, 
		"РегистрСведений.ЦеныНоменклатуры.СрезПоследних",                         
		"РегистрСведений.ЦеныНоменклатуры25.СрезПоследних");
		
	ИначеЕсли ИмяФункции = "СобратьТовары" Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, 
		"РегистрСведений.ЦеныНоменклатуры.СрезПоследних",                         
		"РегистрСведений.ЦеныНоменклатуры25.СрезПоследних");
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, 
		"И ЦеныНоменклатурыСрезПоследних.Характеристика = СписокТоваровОбщий.Характеристика", 
		"И ЦеныНоменклатурыСрезПоследних.ХарактеристикаЦО = ISNULL(СписокТоваровОбщий.Характеристика.ХарактеристикаНоменклатурыДляЦенообразования, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатурыДляЦенообразования.ПустаяСсылка))");
		
	ИначеЕсли ИмяФункции = "ПолучитьЦенуТовара" Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, 
		"РегистрСведений.ЦеныНоменклатуры.СрезПоследних",                         
		"РегистрСведений.ЦеныНоменклатуры25.СрезПоследних");
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"И Характеристика = &ХарактеристикаНоменклатуры",
		"И (ХарактеристикаЦО = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатурыДляЦенообразования.ПустаяСсылка) ИЛИ ХарактеристикаЦО В (ВЫБРАТЬ ПЕРВЫЕ 1 Хар.ХарактеристикаНоменклатурыДляЦенообразования КАК ХарактеристикаЦО 
		| ИЗ Справочник.ХарактеристикиНоменклатуры КАК Хар ГДЕ Хар.Ссылка = &ХарактеристикаНоменклатуры))");
		
	ИначеЕсли ИмяФункции = "ПолучитьТоварыБезЗадания" Тогда
		ТекстЗапроса = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ЦеныНоменклатурыСрезПоследних.Номенклатура КАК Номенклатура,
		|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) КАК ЧИСЛО(19, 2))) КАК Цена
		|ПОМЕСТИТЬ ТоварыСЦенами
		|ИЗ
		|	РегистрСведений.ЦеныНоменклатуры25.СрезПоследних(
		|			&ТекущаяДата, 
		|			Номенклатура В (ВЫБРАТЬ
		|									НайденныеТовары.Номенклатура КАК Номенклатура
		|								ИЗ 
		|									НайденныеТовары КАК НайденныеТовары)
		|			И (ХарактеристикаЦО = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатурыДляЦенообразования.ПустаяСсылка)
		|			ИЛИ ХарактеристикаЦО В ( 
		|								ВЫБРАТЬ Хар.ХарактеристикаНоменклатурыДляЦенообразования КАК ХарактеристикаЦО 
		| 									ИЗ Справочник.ХарактеристикиНоменклатуры КАК Хар ГДЕ Хар.Ссылка В (ВЫБРАТЬ
		|									НайденныеТовары.Характеристика КАК Характеристика
		|									ИЗ 
		|									НайденныеТовары КАК НайденныеТовары)))
		|			И ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
		|
		|СГРУППИРОВАТЬ ПО
		|	ЦеныНоменклатурыСрезПоследних.Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////";
		
	ИначеЕсли ИмяФункции = "GetDocRowsSelectCasual" Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, 
		".Товары КАК ТаблицаТоваровВДокументе",                         
		".Товары2_5 КАК ТаблицаТоваровВДокументе");
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, 
		"ТаблицаТоваровВДокументе.Характеристика",                         
		"ТаблицаТоваровВДокументе.ХарактеристикаЦО"); 
		
	ИначеЕсли ИмяФункции = "GetDocArts" Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, 
		".Товары КАК Документ1С",                         
		".Товары2_5 КАК Документ1С");
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, 
		"Документ1С.Характеристика",                         
		"Документ1С.ХарактеристикаЦО");
		
	КонецЕсли;
	
	ТестЗапросаИсх = ТекстЗапроса;
	
КонецПроцедуры

#КонецОбласти

#Область ОбщегоНазначения

//Проверка существования ссылки.
//
// Параметры: 
// ЛюбаяСсылка - Ссылка - Ссылка на объект метаданных. 
// 
// Возвращаемое значение:
// Булево - Результат обработки.
// 
Функция СсылкаСуществует(ЛюбаяСсылка)
	
	ТекстЗапроса = "
	|ВЫБРАТЬ
	|    Ссылка
	|ИЗ
	|    [ИмяТаблицы]
	|ГДЕ
	|    Ссылка = &Ссылка
	|";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "[ИмяТаблицы]", ИмяТаблицыПоСсылке(ЛюбаяСсылка));
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("Ссылка", ЛюбаяСсылка);
	
	УстановитьПривилегированныйРежим(Истина);
	
	Возврат Не Запрос.Выполнить().Пустой();
	
КонецФункции

// Получение имени таблицы.
//
// Параметры: 
// Ссылка - Ссылка - Ссылка на объект метаданных. 
// 
// Возвращаемое значение:
// Строка - Имя таблицы.
//
Функция ИмяТаблицыПоСсылке(Ссылка)
	
	Возврат Метаданные.НайтиПоТипу(ТипЗнч(Ссылка)).ПолноеИмя();
	
КонецФункции

// Получение чистой строки.
//
// Параметры: 
// ГрязнаяСтрока - Строка - Строка, которую надо очистить от символов. 
// 
// Возвращаемое значение:
// Строка со значением без символов исключений.
//
Функция ЧистаяСтрока(Знач ГрязнаяСтрока) Экспорт
	
	Если ГрязнаяСтрока = Null Тогда
		ГрязнаяСтрока = "";
		Возврат Грязнаястрока; 
	КонецЕсли;
	
	ГрязнаяСтрока = СтрЗаменить(ГрязнаяСтрока, Символы.ВК, " ");
	ГрязнаяСтрока = СтрЗаменить(ГрязнаяСтрока, Символы.НПП, " "); 
	//ГрязнаяСтрока = СтрЗаменить(ГрязнаяСтрока, Символы.ПС, " ");
	
	ГрязнаяСтрока = СокрЛП(ГрязнаяСтрока);
			
	Возврат Грязнаястрока;
	
КонецФункции

Функция ПолучитьФорматнуюСтрокуЧисла()
	Возврат "ЧДЦ=3; ЧРД=.; ЧН=0; ЧГ=0";
КонецФункции

// Получение даты в формате Timestamp.
//
// Параметры: 
// пДата - Дата - Дата, которую надо преобразовать. 
// НеУчитыватьПояс  - Булево - Учет пояса времени.
//
// Возвращаемое значение:
// Число со значением даты в формате Timestamp.
//
Функция ДатуВTimestamp(пДата = Неопределено, НеУчитыватьПояс = Ложь)
	
	Если НеУчитыватьПояс Тогда
		РезультатДата = пДата;	 
	Иначе
		РезультатДата = УниверсальноеВремя(пДата, ЧасовойПояс());
	КонецЕсли;
	
	Возврат Число(Формат(Число(?(ТипЗнч(РезультатДата) = Тип("Дата"), РезультатДата, ТекущаяДата()) - Дата("19700101")), "ЧН=0; ЧГ=0"));
	
КонецФункции

// Получение даты из формата Timestamp.
//
// Параметры: 
// пДатаТС - Число - Дата, которую надо преобразовать из формата Timestamp. 
//
// Возвращаемое значение:
// Дата.
//
Функция TimestampВДату(пДатаТС)
	
	Попытка
		Возврат Дата("19700101") + ?(ТипЗнч(пДатаТС) = Тип("Строка"), Число(пДатаТС), пДатаТС);
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

// Удаление лидирующих нулей из строки.
//
// Параметры: 
// Строка - Строка - Исходная строка. 
//
// Возвращаемое значение:
// Строка без лидирующих нулей.
//
Функция УдалитьЛидирующиеНули(Строка)
	
	СтрокаБезНулей = Строка;
	Пока Лев(СтрокаБезНулей, 1) = "0" Цикл
		СтрокаБезНулей = Прав(СтрокаБезНулей, СтрДлина(СтрокаБезНулей) - 1);	
	КонецЦикла;	
	
	Возврат СтрокаБезНулей;
	
КонецФункции	

#КонецОбласти

#Область ЕГАИС

// Проверка сопоставления товара Номенклатуры ЕГАИС номенклатуре.
//
// Параметры: 
// НоменклатураЕГАИС - СправочникСсылка.КлассификаторАлкогольнойПродукцииЕГАИС - Номенклатура ЕГАИС. 
//
// Возвращаемое значение:
// Булево.
//
Функция ТоварСопоставленОдинКОдному(НоменклатураЕГАИС)
	
	СопоставленОдинКОдному = Ложь;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ЕГАИС_СоответствиеНоменклатуры.Номенклатура КАК Ссылка
	|ИЗ
	|	РегистрСведений.СоответствиеНоменклатурыЕГАИС КАК ЕГАИС_СоответствиеНоменклатуры
	|ГДЕ
	|	ЕГАИС_СоответствиеНоменклатуры.АлкогольнаяПродукция = &ЕГАИСНоменклатура";
	Запрос.УстановитьПараметр("ЕГАИСНоменклатура", НоменклатураЕГАИС);
	Рез = Запрос.Выполнить().Выбрать();
	Если Рез.Количество() = 1 Тогда
		СопоставленОдинКОдному = Истина;	
	КонецЕсли;
	
	Возврат СопоставленОдинКОдному;
	
КонецФункции

// Получение кода номенклатуры ЕГАИС по PDF417.
//
// Параметры: 
// PDFBarcode - Строка - PDF штрихкод. 
//
// Возвращаемое значение:
// Число со значением кода номенклатуры.
//
Функция КодНоменклатурыЕГАИСПоPDF417(PDFBarcode)
	
	Сч = 0;
	Значение=СокрЛП(PDFBarcode);
	
	Если Сред(Значение, 4, 5) = "00000" Тогда
		Значение = Сред(Значение, 9, 11);
		Сч = 11;
	Иначе
		Значение = Сред(Значение, 8, 12);
		Сч = 12;
	КонецЕсли;
	
	Результат = 0;
	
	Для Поз = 1 По Сч Цикл
		
		Множитель = 1;
		
		Для СчМ = 1 По Сч - Поз Цикл   
			Множитель = Множитель * 36;
		КонецЦикла;
		
		Результат = Результат + (Найти("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ", Сред(Значение, Поз, 1)) - 1) * Множитель;
		
	КонецЦикла;
	
	Возврат Формат(Результат, "ЧЦ=19; ЧВН=; ЧГ=0");
	
КонецФункции

Функция ПолучитьТаблицуУпакованныхМарок(ИдентификаторУпаковки = "", Шаблон)
	
	Запрос = Новый Запрос;	
	
	Запрос.УстановитьПараметр("ИдентификаторУпаковки", ИдентификаторУпаковки);		
	
	Запрос.Текст = "ВЫБРАТЬ
	|	ДанныеУпаковкиУровень1.Штрихкод КАК Штрихкод
	|ПОМЕСТИТЬ ДанныеУпаковкиУровень1
	|ИЗ
	|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ДанныеУпаковкиУровень1
	|ГДЕ
	|	ДанныеУпаковкиУровень1.Ссылка.ЗначениеШтрихкода = &ИдентификаторУпаковки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДанныеУпаковкиУровень2.Штрихкод.ЗначениеШтрихкода КАК Марка,
	|	ДанныеУпаковкиУровень2.Ссылка КАК Короб
	|ПОМЕСТИТЬ ПереченньМарок
	|ИЗ
	|	ДанныеУпаковкиУровень1 КАК ДанныеУпаковкиУровень1
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ДанныеУпаковкиУровень2
	|		ПО ДанныеУпаковкиУровень1.Штрихкод = ДанныеУпаковкиУровень2.Ссылка
	|ГДЕ                                                                     		
	|	(ДанныеУпаковкиУровень1.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МонотоварнаяУпаковка)
	|			ИЛИ ДанныеУпаковкиУровень1.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МультитоварнаяУпаковка))
	|	И ДанныеУпаковкиУровень2.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ДанныеУпаковкиУровень1.Штрихкод.ЗначениеШтрихкода,
	|	ЗНАЧЕНИЕ(Справочник.ШтрихкодыУпаковокТоваров.ПустаяСсылка)
	|ИЗ
	|	ДанныеУпаковкиУровень1 КАК ДанныеУпаковкиУровень1
	|ГДЕ
	|	ДанныеУпаковкиУровень1.Штрихкод.ТипУпаковки = ЗНАЧЕНИЕ(Перечисление.ТипыУпаковок.МаркированныйТовар)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(1) КАК Количество,
	|	ПереченньМарок.Марка,
	|	ПереченньМарок.Короб КАК Короб,
	|	ЕСТЬNULL(ЕГАИС_РегистрМарок.АлкогольнаяПродукция, ЗНАЧЕНИЕ(Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.ПустаяСсылка)) КАК АлкогольнаяПродукция
	|ИЗ
	|	ПереченньМарок КАК ПереченньМарок
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АкцизныеМаркиЕГАИС КАК ЕГАИС_РегистрМарок
	|		ПО (ЕГАИС_РегистрМарок.АкцизнаяМарка.ЗначениеШтрихкода = ПереченньМарок.Марка)
	|СГРУППИРОВАТЬ ПО 
	|	ПереченньМарок.Марка,
	|	ПереченньМарок.Короб,
	|	ЕСТЬNULL(ЕГАИС_РегистрМарок.АлкогольнаяПродукция, ЗНАЧЕНИЕ(Справочник.КлассификаторАлкогольнойПродукцииЕГАИС.ПустаяСсылка))";
	
	Если Шаблон.МаркировкаОнлайнПроверкаВложенностиУпаковок Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ПереченньМарок.Марка,", "");	 
	КонецЕсли;	 
	
	Возврат Запрос.Выполнить().Выгрузить(ОбходРезультатаЗапроса.Прямой);
	
КонецФункции

Функция ПроверитьУникальностьМаркиЕгаисГрупповогоЗадания(ИмяТаблицы, УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки)
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	ЗапросПревышения = Новый Запрос;
	ЗапросПревышения.Текст = "ВЫБРАТЬ
	|   ЕстьNull(СУММА(ЕстьNull(ТаблицаТоваровВРегистре.Количество,0)),0) КАК КоличествоПодбор
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ТаблицаТоваровВРегистре
	|ГДЕ
	|	ТаблицаТоваровВРегистре.ДокументТСД = &ДокументТСД
	|	И ТаблицаТоваровВРегистре.ЕгаисПолныйКод = &ЕгаисПолныйКод
	|	И ТаблицаТоваровВРегистре.ИмяТаблицы = &ИмяТаблицы
	|	И НЕ ТаблицаТоваровВРегистре.ДляОбмена";
	
	ЗапросПревышения.УстановитьПараметр("ДокументТСД", СсылкаНаДок);
	ЗапросПревышения.УстановитьПараметр("ЕгаисПолныйКод", СтрокаДокумента.egais.mark);
	ЗапросПревышения.УстановитьПараметр("ИмяТаблицы", ИмяТаблицы);
	
	ВыборкаПревышения = ЗапросПревышения.Выполнить().Выбрать();
	Пока ВыборкаПревышения.Следующий() Цикл
		Если ВыборкаПревышения.КоличествоПодбор > 0 Тогда
			Возврат Истина;
		КонецЕсли;
		Прервать;
	КонецЦикла;	
	
	Возврат Ложь;
	
КонецФункции

Функция ПроверитьПревышениеЗаданияПоСправкамЕГАИС(ИмяТаблицы, УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки)
	
	ЗначениеВозврата = 0;
	
	ТекущаяСправкаБ = Справочники.астСправкиАиБ_ЕГАИС.ПустаяСсылка();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	астПартииТоваровПоМаркамЕГАИС.СправкаБ КАК ТекущаяСправкаБ,
	|	1 КАК Количество
	|ИЗ
	|	РегистрНакопления.астПартииТоваровПоМаркамЕГАИС.Остатки(,ШтрихкодМарки.Наименование = &DMPDFBarcode) КАК астПартииТоваровПоМаркамЕГАИС
	|";
	
	Запрос.УстановитьПараметр("DMPDFBarcode", СтрокаДокумента.egais.mark);	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда		
		ТекущаяСправкаБ = Выборка.ТекущаяСправкаБ; 	
	КонецЕсли;
	
	СтруктураСтроки.Вставить("ЕгаисСправкаБ", ТекущаяСправкаБ);
		
	Если ТекущаяСправкаБ.Пустая() Тогда
		Если СтрДлина(СтрокаДокумента.egais.mark) = 150 Тогда // нет на остатках новой марки, надо ругаться
			Возврат 3;
		Иначе	
			Возврат 0;
		КонецЕсли;	
	КонецЕсли;
		
	КоличествоПодобранных = 1;
	КоличествоВИсходномДокументе = 0;
	
	//ПОДБОР
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ЕгаисСправкаБ КАК СправкаБ,
	|	Сумма(ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Количество) КАК Количество
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Ссылка = &Ссылка
	|	И ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ЕгаисСправкаБ = &ТекущаяСправкаБ
	|
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ЕгаисСправкаБ";
	
	Запрос.УстановитьПараметр("ТекущаяСправкаБ"		, ТекущаяСправкаБ);
	Запрос.УстановитьПараметр("Ссылка"				, СтруктураСтроки.ДокументТСД);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда		
		КоличествоПодобранных = КоличествоПодобранных + Выборка.Количество;
	КонецЕсли;
			
	//ЗАДАНИЕ		
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	астТоварноТранспортныеНакладныеИзЕГАИСТовары.СправкаБ КАК СправкаБ,
	|	СУММА(астТоварноТранспортныеНакладныеИзЕГАИСТовары.Количество) КАК Количество
	|ИЗ
	|	Документ.астТоварноТранспортныеНакладныеИзЕГАИС.Товары КАК астТоварноТранспортныеНакладныеИзЕГАИСТовары
	|ГДЕ
	|	астТоварноТранспортныеНакладныеИзЕГАИСТовары.Ссылка = &ИсходныйДокумент
	|	И астТоварноТранспортныеНакладныеИзЕГАИСТовары.СправкаБ = &ТекущаяСправкаБ
	|
	|СГРУППИРОВАТЬ ПО
	|	астТоварноТранспортныеНакладныеИзЕГАИСТовары.СправкаБ";
	
	Запрос.УстановитьПараметр("ТекущаяСправкаБ"		, ТекущаяСправкаБ);
	Запрос.УстановитьПараметр("ИсходныйДокумент"	, СсылкаНаДок.ИсходныйДокумент);	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда		
		КоличествоВИсходномДокументе = КоличествоВИсходномДокументе + Выборка.Количество;
	КонецЕсли; 
				
	Если КоличествоВИсходномДокументе = 0 Тогда
		ЗначениеВозврата = 2;
		Возврат ЗначениеВозврата;
	КонецЕсли; 
	
	Если КоличествоВИсходномДокументе < КоличествоПодобранных Тогда
		ЗначениеВозврата = 1;	
	КонецЕсли; 	
			
	Возврат ЗначениеВозврата;
		
КонецФункции	

#КонецОбласти

#Область Маркировка

Функция ПроверитьТребуетсяВыгрузкаМарок(СсылкаНаДок)
	
	ВидДокумента = СсылкаНаДок.Шаблон.ВидДокумента;
	
	Если ВидДокумента = "ПриобретениеТоваровУслуг" 
		Или ВидДокумента = "ПриемкаТоваровИСМП" 
		Или ВидДокумента = "ЗаказНаЭмиссиюКодовМаркировкиСУЗ" Тогда
		
		Возврат Истина;
		
	ИначеЕсли ВидДокумента = "ВозвратТоваровОтКлиента"	Тогда
		
		МаркиУказаныПоставщиком = Ложь;
		
		Если СсылкаНаДок.ИсходныйДокумент.ШтрихкодыУпаковок.Количество() > 0 Тогда
			МаркиУказаныПоставщиком = Истина;
		КонецЕсли;
		
		Если МаркиУказаныПоставщиком Тогда
			Возврат Истина;
		Иначе
			Возврат Ложь;
		КонецЕсли;	
		
	ИначеЕсли ВидДокумента = "УведомлениеОПриемкеМДЛП" Тогда
		ПрямойАкцепт = Ложь;
		Попытка 
			Если СсылкаНаДок.ИсходныйДокумент.СхемаАкцептования = Перечисления.СхемыАкцептованияМДЛП.ПрямойПорядок Тогда
				ПрямойАкцепт = Истина;
			КонецЕсли;
		Исключение
		КонецПопытки;
		
		Если ПрямойАкцепт Тогда
			Возврат Истина;
		Иначе
			Возврат Ложь;
		КонецЕсли;	
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции // ()

// Получение товаров без задания.
//
// Параметры: 
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД. 
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// КМ - Строка - КМ.
// GS1 - Строка - GS1.
// ЗначениеШтрихкода - Строка - Значение штрихкода.
//
// Возвращаемое значение:
// Таблица значений товаров без задания.
//
Функция ПолучитьТоварыБезЗадания(УзелПО, СсылкаНаДок, КМ, GS1, ЗначениеШтрихкода)
	
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	
	ЗначенияРеквизитовСсылкаНаДок = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок,"Шаблон");
	Шаблон = ЗначенияРеквизитовСсылкаНаДок.Шаблон;
	
	ЗначенияРеквизитовШаблон = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Шаблон,"ВидДокумента");
	Шаблон_ВидДокумента = ЗначенияРеквизитовШаблон.ВидДокумента;
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьМДЛП() Тогда
		ЭтоДокументМДЛП = ДатаМобайл_МДЛП.ЭтоДокументМДЛП(Шаблон_ВидДокумента);
		
		Если Не ЭтоДокументМДЛП И СтрДлина(КМ) = 31 Тогда
			Если СтрНачинаетсяС(КМ, "01") И Сред(КМ, 17, 2) = "21" Тогда //скорее всего это ЛС
				ЭтоДокументМДЛП = Истина;	
			КонецЕсли;	
		КонецЕсли;		
	Иначе
		ЭтоДокументМДЛП = Ложь;
	КонецЕсли;	
	
	ЭтоКММассивов = Ложь;	
	
	Если ТипЗнч(КМ) = Тип("Массив") Тогда
		ЭтоКММассивов = Истина;	
	КонецЕсли;	
	
	Запрос = Новый Запрос;
	ТекстЗапросаЦены = "
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЦеныНоменклатурыСрезПоследних.Номенклатура КАК Номенклатура,
	|	МАКСИМУМ(ВЫРАЗИТЬ(ЕСТЬNULL(ЦеныНоменклатурыСрезПоследних.Цена, 0) КАК ЧИСЛО(19, 2))) КАК Цена
	|ПОМЕСТИТЬ ТоварыСЦенами
	|ИЗ
	|	РегистрСведений.ЦеныНоменклатуры.СрезПоследних(
	|			&ТекущаяДата, 
	|			Номенклатура В (ВЫБРАТЬ
	|									НайденныеТовары.Номенклатура КАК Номенклатура
	|								ИЗ 
	|									НайденныеТовары КАК НайденныеТовары)
	|			И Характеристика В (ВЫБРАТЬ
	|									НайденныеТовары.Характеристика КАК Характеристика
	|								ИЗ 
	|									НайденныеТовары КАК НайденныеТовары)
	|			И ВидЦены = &ТипЦен) КАК ЦеныНоменклатурыСрезПоследних
	|
	|СГРУППИРОВАТЬ ПО
	|	ЦеныНоменклатурыСрезПоследних.Номенклатура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////";	
	СкорректироватьЗапросПоЦенообразованию25(ТекстЗапросаЦены, "ПолучитьТоварыБезЗадания");
	
	Если ЭтоДокументМДЛП И Метаданные.НайтиПоПолномуИмени("РегистрСведений.УАС_АналитикаНомеровУпаковок") <> Неопределено Тогда
		Запрос.Текст = "ВЫБРАТЬ
		|	УАС_АналитикаНомеровУпаковок.Номенклатура КАК Номенклатура,
		|	УАС_АналитикаНомеровУпаковок.Характеристика КАК Характеристика,
		|	УАС_АналитикаНомеровУпаковок.Серия КАК Серия,
		|	УАС_АналитикаНомеровУпаковок.НомерУпаковки КАК Марка
		|ПОМЕСТИТЬ Марки
		|ИЗ
		|	РегистрСведений.УАС_АналитикаНомеровУпаковок КАК УАС_АналитикаНомеровУпаковок
		|ГДЕ
		|	УАС_АналитикаНомеровУпаковок.Номенклатура <> Значение(Справочник.Номенклатура.ПустаяСсылка)
		|	И УАС_АналитикаНомеровУпаковок.НомерУпаковки ПОДОБНО &ЗначениеШтрихкодаДляЗапроса СПЕЦСИМВОЛ ""$""
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Марки.Номенклатура КАК Номенклатура,
		|	Марки.Характеристика КАК Характеристика
		|ПОМЕСТИТЬ НайденныеТовары
		|ИЗ
		|	Марки КАК Марки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////";
		
		Запрос.Текст = Запрос.Текст + ТекстЗапросаЦены + "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Марки.Марка КАК Марка,
		|	Марки.Номенклатура КАК Номенклатура,
		|	Марки.Характеристика КАК Характеристика,
		|	ВЫБОР
		|		КОГДА &ВключатьАртикул
		|			ТОГДА ВЫБОР
		|					КОГДА Марки.Номенклатура.Артикул = """"
		|						ТОГДА """"
		|					ИНАЧЕ Марки.Номенклатура.Артикул + "" ""
		|				КОНЕЦ
		|		ИНАЧЕ """"
		|	КОНЕЦ + Марки.Номенклатура.Наименование + "" "" + ЕСТЬNULL(Марки.Характеристика.Наименование, """") КАК НаименованиеТовара,
		|	Марки.Номенклатура.ЕдиницаИзмерения.Наименование КАК НаименованиеУпаковки,
		|	Марки.Номенклатура.ВидНоменклатуры.ИспользоватьСерии КАК ИспользоватьСерии,
		|	1 КАК Коэффициент,
		|	"""" КАК НоменклатураКороба,
		|	"""" КАК ХарактеристикаКороба,
		|	"""" КАК УпаковкаКороба,
		|	"""" КАК КоэффициентУпаковкиКороба,
		|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена
		|ПОМЕСТИТЬ ИтоговыеДанныеУпаковки
		|ИЗ
		|	Марки КАК Марки
		|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
		|		ПО Марки.Номенклатура = ТоварыСЦенами.Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ИтоговыеДанныеУпаковки.Марка КАК ЗначениеШтрихкода,
		|	ИтоговыеДанныеУпаковки.Номенклатура КАК Номенклатура,
		|	ИтоговыеДанныеУпаковки.Характеристика КАК Характеристика,
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
		|	ИтоговыеДанныеУпаковки.Номенклатура.ИспользованиеХарактеристик КАК ИспользованиеХарактеристик, 
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВладелецХарактеристик КАК ВладелецХарактеристик,
		|	ИтоговыеДанныеУпаковки.Номенклатура.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры, 
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
		|	ИтоговыеДанныеУпаковки.Характеристика.Наименование КАК НаименованиеХарактеристики,
		|	ИтоговыеДанныеУпаковки.Характеристика.Владелец КАК НоменклатураХарактеристики,		 
		|	ИтоговыеДанныеУпаковки.НаименованиеТовара КАК НаименованиеТовара,
		|	ИтоговыеДанныеУпаковки.НаименованиеУпаковки КАК НаименованиеУпаковки,
		|	ИтоговыеДанныеУпаковки.ИспользоватьСерии КАК ИспользоватьСерии,
		|	СУММА(ИтоговыеДанныеУпаковки.Коэффициент) КАК Коэффициент,
		|	ИтоговыеДанныеУпаковки.Цена КАК Цена
		|ИЗ
		|	ИтоговыеДанныеУпаковки КАК ИтоговыеДанныеУпаковки
		|
		|СГРУППИРОВАТЬ ПО
		|	ИтоговыеДанныеУпаковки.Марка,
		|	ИтоговыеДанныеУпаковки.Номенклатура, 
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВесМожноУказыватьВДокументах,
		|	ИтоговыеДанныеУпаковки.Номенклатура.ИспользованиеХарактеристик, 
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВладелецХарактеристик,
		|	ИтоговыеДанныеУпаковки.Номенклатура.АлкогольнаяПродукция,
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВидНоменклатуры,
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВидНоменклатуры.ТипНоменклатуры,
		|	ИтоговыеДанныеУпаковки.Характеристика.Наименование,
		|	ИтоговыеДанныеУпаковки.Характеристика.Владелец,
		|	ИтоговыеДанныеУпаковки.Характеристика,
		|	ИтоговыеДанныеУпаковки.НаименованиеТовара,
		|	ИтоговыеДанныеУпаковки.НаименованиеУпаковки,
		|	ИтоговыеДанныеУпаковки.ИспользоватьСерии,
		|	ИтоговыеДанныеУпаковки.Цена
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТоварыСЦенами
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Марки
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НайденныеТовары
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ИтоговыеДанныеУпаковки";		
	Иначе		
		Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ШтрихкодыУпаковокТоваров.Номенклатура КАК Номенклатура,
		|	ШтрихкодыУпаковокТоваров.Характеристика КАК Характеристика,
		|	ШтрихкодыУпаковокТоваров.Серия КАК Серия,
		|	ВЫБОР
		|		КОГДА &ВключатьАртикул
		|			ТОГДА ВЫБОР
		|					КОГДА ШтрихкодыУпаковокТоваров.Номенклатура.Артикул = """"
		|						ТОГДА """"
		|					ИНАЧЕ ШтрихкодыУпаковокТоваров.Номенклатура.Артикул + "" ""
		|				КОНЕЦ
		|		ИНАЧЕ """"
		|	КОНЕЦ + ШтрихкодыУпаковокТоваров.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ШтрихкодыУпаковокТоваров.Характеристика.Наименование, """") КАК НаименованиеТовара,
		|	ЕСТЬNULL(ШтрихкодыУпаковокТоваров.Упаковка.Наименование, ШтрихкодыУпаковокТоваров.Номенклатура.ЕдиницаИзмерения.Наименование) КАК НаименованиеУпаковки,
		|	ШтрихкодыУпаковокТоваров.Номенклатура.ВидНоменклатуры.ИспользоватьСерии КАК ИспользоватьСерии,
		|	ВЫБОР
		|		КОГДА ШтрихкодыУпаковокТоваров.Количество = 0 
		|		ТОГДА
		|			ВЫБОР
		|				КОГДА ЕСТЬNULL(ШтрихкодыУпаковокТоваров.Упаковка.Числитель,0) = 0
		|				ТОГДА 1
		|				ИНАЧЕ ШтрихкодыУпаковокТоваров.Упаковка.Числитель
		|			КОНЕЦ
		|		ИНАЧЕ ШтрихкодыУпаковокТоваров.Количество 
		|	КОНЕЦ КАК Коэффициент,
		|	ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода КАК ЗначениеШтрихкода
		|ПОМЕСТИТЬ МаркиСправочника
		|ИЗ
		|	Справочник.ШтрихкодыУпаковокТоваров КАК ШтрихкодыУпаковокТоваров
		|ГДЕ
		|	ШтрихкодыУпаковокТоваров.Номенклатура <> Значение(Справочник.Номенклатура.ПустаяСсылка)
		|	И ШтрихкодыУпаковокТоваров.ЗначениеШтрихкода ПОДОБНО &ЗначениеШтрихкодаДляЗапроса СПЕЦСИМВОЛ ""$""
		|	И НЕ ШтрихкодыУпаковокТоваров.ПометкаУдаления
		|
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|
		|ВЫБРАТЬ
		|	ПулКодовМаркировкиСУЗ.Номенклатура КАК Номенклатура,
		|	ПулКодовМаркировкиСУЗ.Характеристика КАК Характеристика,
		|	Значение(Справочник.СерииНоменклатуры.ПустаяСсылка) КАК Серия,
		|	ВЫБОР
		|		КОГДА &ВключатьАртикул
		|			ТОГДА ВЫБОР
		|					КОГДА ПулКодовМаркировкиСУЗ.Номенклатура.Артикул = """"
		|						ТОГДА """"
		|					ИНАЧЕ ПулКодовМаркировкиСУЗ.Номенклатура.Артикул + "" ""
		|				КОНЕЦ
		|		ИНАЧЕ """"
		|	КОНЕЦ + ПулКодовМаркировкиСУЗ.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ПулКодовМаркировкиСУЗ.Характеристика.Наименование, """") КАК НаименованиеТовара,
		|	ЕСТЬNULL(РегистрСведенийШтрихкодыНоменклатуры.Упаковка.Наименование,ПулКодовМаркировкиСУЗ.Номенклатура.ЕдиницаИзмерения.Наименование)  КАК НаименованиеУпаковки,
		|	ПулКодовМаркировкиСУЗ.Номенклатура.ВидНоменклатуры.ИспользоватьСерии КАК ИспользоватьСерии,
		|	ВЫБОР 
		|		КОГДА МАКСИМУМ(ЕСТЬNULL(РегистрСведенийШтрихкодыНоменклатуры.Упаковка.Числитель,1))=0 
		|		ТОГДА 1
		|		ИНАЧЕ МАКСИМУМ(ЕСТЬNULL(РегистрСведенийШтрихкодыНоменклатуры.Упаковка.Числитель,1)) 
		|	КОНЕЦ КАК Коэффициент,
		|	ПулКодовМаркировкиСУЗ.КодМаркировки КАК ЗначениеШтрихкода
		|ПОМЕСТИТЬ МаркиПула
		|ИЗ
		|	РегистрСведений.ПулКодовМаркировкиСУЗ КАК ПулКодовМаркировкиСУЗ
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ШтрихкодыНоменклатуры КАК РегистрСведенийШтрихкодыНоменклатуры
		|		ПО ПулКодовМаркировкиСУЗ.GTIN = ""0""+РегистрСведенийШтрихкодыНоменклатуры.Штрихкод ИЛИ ПулКодовМаркировкиСУЗ.GTIN = ""000000""+РегистрСведенийШтрихкодыНоменклатуры.Штрихкод ИЛИ ПулКодовМаркировкиСУЗ.GTIN = РегистрСведенийШтрихкодыНоменклатуры.Штрихкод 
		|ГДЕ
		|	ПулКодовМаркировкиСУЗ.Номенклатура <> Значение(Справочник.Номенклатура.ПустаяСсылка)
		|	И ПулКодовМаркировкиСУЗ.КодМаркировки ПОДОБНО &ЗначениеШтрихкодаДляЗапроса СПЕЦСИМВОЛ ""$""
		|СГРУППИРОВАТЬ ПО
		|	ПулКодовМаркировкиСУЗ.Номенклатура,
		|	ПулКодовМаркировкиСУЗ.Характеристика,
		|	ВЫБОР
		|		КОГДА &ВключатьАртикул
		|			ТОГДА ВЫБОР
		|					КОГДА ПулКодовМаркировкиСУЗ.Номенклатура.Артикул = """"
		|						ТОГДА """"
		|					ИНАЧЕ ПулКодовМаркировкиСУЗ.Номенклатура.Артикул + "" ""
		|				КОНЕЦ
		|		ИНАЧЕ """"
		|	КОНЕЦ + ПулКодовМаркировкиСУЗ.Номенклатура.Наименование + "" "" + ЕСТЬNULL(ПулКодовМаркировкиСУЗ.Характеристика.Наименование, """"),
		|	ЕСТЬNULL(РегистрСведенийШтрихкодыНоменклатуры.Упаковка.Наименование,ПулКодовМаркировкиСУЗ.Номенклатура.ЕдиницаИзмерения.Наименование),  
		|	ПулКодовМаркировкиСУЗ.КодМаркировки	
		|;
		|////////////////////////////////////////////////////////////////////////////////		
		|ВЫБРАТЬ
		|	МаркиСправочника.Номенклатура КАК Номенклатура,
		|	МаркиСправочника.Характеристика КАК Характеристика,
		|	МаркиСправочника.Серия КАК Серия,
		|	МаркиСправочника.НаименованиеТовара КАК НаименованиеТовара,
		|	МаркиСправочника.НаименованиеУпаковки КАК НаименованиеУпаковки,
		|	МаркиСправочника.ИспользоватьСерии КАК ИспользоватьСерии,
		|	МаркиСправочника.Коэффициент КАК Коэффициент,
		|	МаркиСправочника.ЗначениеШтрихкода КАК ЗначениеШтрихкода
		|ПОМЕСТИТЬ Марки
		|ИЗ
		|	МаркиСправочника КАК МаркиСправочника
		|
        |ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ
		|	МаркиПула.Номенклатура КАК Номенклатура,
		|	МаркиПула.Характеристика КАК Характеристика,
		|	МаркиПула.Серия КАК Серия,
		|	МаркиПула.НаименованиеТовара КАК НаименованиеТовара,
		|	МаркиПула.НаименованиеУпаковки КАК НаименованиеУпаковки,
		|	МаркиПула.ИспользоватьСерии КАК ИспользоватьСерии,
		|	МаркиПула.Коэффициент КАК Коэффициент,
		|	МаркиПула.ЗначениеШтрихкода КАК ЗначениеШтрихкода
		|ИЗ
		|	МаркиПула КАК МаркиПула
		|ГДЕ
		|	МаркиПула.ЗначениеШтрихкода НЕ В (ВЫБРАТЬ МаркиСправочника.ЗначениеШтрихкода ИЗ МаркиСправочника КАК МаркиСправочника)
		|;
        |////////////////////////////////////////////////////////////////////////////////		
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Марки.Номенклатура КАК Номенклатура,
		|	Марки.Характеристика КАК Характеристика
		|ПОМЕСТИТЬ НайденныеТовары
		|ИЗ
		|	Марки КАК Марки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////";
		
		Запрос.Текст = Запрос.Текст + ТекстЗапросаЦены + "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	Марки.Номенклатура КАК Номенклатура,
		|	Марки.Характеристика КАК Характеристика,
		|	Марки.Серия КАК Серия,
		|	Марки.НаименованиеТовара КАК НаименованиеТовара,
		|	Марки.НаименованиеУпаковки КАК НаименованиеУпаковки,
		|	Марки.ИспользоватьСерии КАК ИспользоватьСерии,
		|	Марки.Коэффициент КАК Коэффициент,
		|	Марки.ЗначениеШтрихкода КАК ЗначениеШтрихкода,
		|	ЕСТЬNULL(ТоварыСЦенами.Цена, 0) КАК Цена
		|ПОМЕСТИТЬ ДанныеВыборки
		|ИЗ
		|	Марки КАК Марки
		|		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыСЦенами КАК ТоварыСЦенами
		|		ПО Марки.Номенклатура = ТоварыСЦенами.Номенклатура
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////";
		Если ЭтоКММассивов Тогда
			Запрос.Текст = Запрос.Текст +
			"
			|ВЫБРАТЬ
			|";
		Иначе
			Запрос.Текст = Запрос.Текст + 
			"
			|ВЫБРАТЬ ПЕРВЫЕ 1
			|";
		КонецЕсли;
		Запрос.Текст = Запрос.Текст + 
		"
		|	ДанныеВыборки.Номенклатура КАК Номенклатура,
		|	ДанныеВыборки.Характеристика КАК Характеристика,
		|	ДанныеВыборки.Серия КАК Серия,
		|	ДанныеВыборки.НаименованиеТовара КАК НаименованиеТовара,
		|	ДанныеВыборки.НаименованиеУпаковки КАК НаименованиеУпаковки,
		|	ДанныеВыборки.ИспользоватьСерии КАК ИспользоватьСерии,
		|	ДанныеВыборки.Коэффициент КАК Коэффициент,
		|	ДанныеВыборки.ЗначениеШтрихкода КАК Марка,
		|	ДанныеВыборки.Цена КАК Цена
		|ПОМЕСТИТЬ ИтоговыеДанныеУпаковки
		|ИЗ 
		|	ДанныеВыборки КАК ДанныеВыборки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ИтоговыеДанныеУпаковки.Марка КАК ЗначениеШтрихкода,
		|	ИтоговыеДанныеУпаковки.Номенклатура КАК Номенклатура,
		|	ИтоговыеДанныеУпаковки.Характеристика КАК Характеристика,
		|	ИтоговыеДанныеУпаковки.Серия КАК Серия,
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВесМожноУказыватьВДокументах КАК Весовой,
		|	ИтоговыеДанныеУпаковки.Номенклатура.АлкогольнаяПродукция КАК АлкогольнаяПродукция,
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВидНоменклатуры.ТипНоменклатуры КАК ВидНоменклатурыТипНоменклатуры,
		|	ИтоговыеДанныеУпаковки.Характеристика.Наименование КАК НаименованиеХарактеристики,
		|	ИтоговыеДанныеУпаковки.Характеристика.Владелец КАК НоменклатураХарактеристики,
		|	ИтоговыеДанныеУпаковки.НаименованиеТовара КАК НаименованиеТовара,
		|	ИтоговыеДанныеУпаковки.НаименованиеУпаковки КАК НаименованиеУпаковки,
		|	ИтоговыеДанныеУпаковки.ИспользоватьСерии КАК ИспользоватьСерии,
		|	СУММА(ИтоговыеДанныеУпаковки.Коэффициент) КАК Коэффициент,
		|	ИтоговыеДанныеУпаковки.Цена КАК Цена
		|ИЗ
		|	ИтоговыеДанныеУпаковки КАК ИтоговыеДанныеУпаковки
		|
		|СГРУППИРОВАТЬ ПО
		|	ИтоговыеДанныеУпаковки.Марка,
		|	ИтоговыеДанныеУпаковки.Номенклатура,
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВесМожноУказыватьВДокументах,
		|	ИтоговыеДанныеУпаковки.Номенклатура.АлкогольнаяПродукция,
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВидНоменклатуры, 
		|	ИтоговыеДанныеУпаковки.Номенклатура.ВидНоменклатуры.ТипНоменклатуры,
		|	ИтоговыеДанныеУпаковки.Характеристика.Наименование,
		|	ИтоговыеДанныеУпаковки.Характеристика.Владелец, 	
		|	ИтоговыеДанныеУпаковки.Характеристика,
		|	ИтоговыеДанныеУпаковки.Серия,
		|	ИтоговыеДанныеУпаковки.НаименованиеТовара,
		|	ИтоговыеДанныеУпаковки.НаименованиеУпаковки,
		|	ИтоговыеДанныеУпаковки.ИспользоватьСерии,
		|	ИтоговыеДанныеУпаковки.Цена
		|
		|УПОРЯДОЧИТЬ ПО
		|	Коэффициент УБЫВ
		|;		
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ТоварыСЦенами
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ Марки
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ НайденныеТовары
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ ДанныеВыборки
		|";		
	КонецЕсли;	
		
	//Пачка табака:
	//GTIN+SN = 21
	//Блок табака:
	//01+GTIN+21+SN = 25
	//Обувь:
	//01+GTIN+21+SN = 31
	//Лекарства:
	//01+GTIN+21+SN = 31
	//Фото:
	//01+GTIN+21+SN = 38
	//Молочка:
	//01+GTIN+21+SN = 24 или 32
	
	Если Не ЭтоКММассивов Тогда
		Если СтрДлина(КМ) = 20 Тогда
			Если ЭтоДокументМДЛП Тогда
				ЗначениеШтрихкода = Сред(КМ, 3, 18);
			Иначе	
				ЗначениеШтрихкода = "(00)" + Сред(КМ, 3, 18);
			КонецЕсли;
		ИначеЕсли СтрДлина(КМ) = 22 Тогда
			Если ЭтоДокументМДЛП Тогда
				ЗначениеШтрихкода = Сред(КМ, 5, 18);
			Иначе	
				ЗначениеШтрихкода = "(00)" + Сред(КМ, 5, 18);
			КонецЕсли;	
		ИначеЕсли СтрДлина(КМ) = 21 Тогда
			ЗначениеШтрихкода = КМ;
		ИначеЕсли СтрДлина(КМ) = 25 Тогда
			ЗначениеШтрихкода = "(01)" + Сред(КМ, 3, 14) + "(21)" + Сред(КМ, 19, 7);
		ИначеЕсли СтрДлина(КМ) = 24 Тогда
			ЗначениеШтрихкода = "(01)" + Сред(КМ, 3, 14) + "(21)" + Сред(КМ, 19, 6);
		ИначеЕсли СтрДлина(КМ) = 38 Тогда
			ЗначениеШтрихкода = "(01)" + Сред(КМ, 3, 14) + "(21)" + Сред(КМ, 19, 20);	
		ИначеЕсли СтрДлина(КМ) = 31 Тогда
			Если ЭтоДокументМДЛП Тогда
				ЗначениеШтрихкода = Сред(КМ, 3, 14) +  Сред(КМ, 19, 13);
			Иначе	
				ЗначениеШтрихкода = "(01)" + Сред(КМ, 3, 14) + "(21)" + Сред(КМ, 19, 13);
			КонецЕсли;
		ИначеЕсли СтрДлина(КМ) = 32 Тогда
			ЗначениеШтрихкода = "(01)" + Сред(КМ, 3, 14) + "(21)" + Сред(КМ, 19, 14);	
		Иначе
			//упаковки
			
			Если ЗначениеЗаполнено(GS1) Тогда
				GS1 = СтрЗаменить(GS1,"[","(");
				GS1 = СтрЗаменить(GS1,"]",")");
			Иначе
				GS1 = КМ;
			КонецЕсли;
			
			ЗначениеШтрихкода = GS1;
		КонецЕсли;
		
		//Символы _ и % присутствуют в алфавите маркировки, поэтому требуется экранирование через спецсимвол, символ $ не присутствует в алфавите маркировки
		ЗначениеШтрихкодаДляЗапроса = "" + ЗначениеШтрихкода;
		ЗначениеШтрихкодаДляЗапроса = СтрЗаменить(ЗначениеШтрихкодаДляЗапроса, "_", "$_");
		ЗначениеШтрихкодаДляЗапроса = СтрЗаменить(ЗначениеШтрихкодаДляЗапроса, "%", "$%");
		ЗначениеШтрихкодаДляЗапроса = ЗначениеШтрихкодаДляЗапроса + "%";
		
		Запрос.УстановитьПараметр("ЗначениеШтрихкодаДляЗапроса", ЗначениеШтрихкодаДляЗапроса);
	Иначе		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ПОДОБНО &ЗначениеШтрихкодаДляЗапроса СПЕЦСИМВОЛ ""$""", "В (&ЗначениеШтрихкодаДляЗапроса)"); 
		Запрос.УстановитьПараметр("ЗначениеШтрихкодаДляЗапроса", КМ);
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ИсходноеЗадание", СсылкаНаДок);
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());
	
	Запрос.УстановитьПараметр("ВключатьАртикул", УзелПО.ДобавлятьАртикулВНаименование);
	Запрос.УстановитьПараметр("ТипЦен", УзелПО.ТипЦен);
	
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;	
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	СписокПомещений = УзелПО.Помещения.ВыгрузитьКолонку("Помещение");
	Если ЗначениеЗаполнено(СсылкаНаДок.Помещение) Тогда	
		СписокПомещений.Очистить();
		СписокПомещений.Добавить(СсылкаНаДок.Помещение);			
	КонецЕсли;
	Запрос.УстановитьПараметр("Помещения", СписокПомещений);
	Запрос.УстановитьПараметр("ВсеПомещения", СписокПомещений.Количество() = 0);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

// Проверка при сканировании упаковки в документе.
//
// Параметры:
//
// СтруктураСтроки - Структура - Структура строки.
// ДокументТСД - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД. 
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон. 
//
// Возвращаемое значение:
// Булево.
//
Функция БылоСканированиеУпаковкиВСоставеДругойВЭтомДокументе(СтруктураСтроки = Неопределено, ДокументТСД = Неопределено, Шаблон = Неопределено)
	
	Если СтруктураСтроки = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьМДЛП() Тогда
		ЭтоДокументМДЛП = ДатаМобайл_МДЛП.ЭтоДокументМДЛП(Шаблон.ВидДокумента);
	Иначе
		ЭтоДокументМДЛП = Ложь;
	КонецЕсли;                                     
	
	Если Не ЭтоДокументМДЛП Тогда
	
		//1. Проверка Кода маркировки/Акцизной марки:
		
		Если ЗначениеЗаполнено(СтруктураСтроки.КМСсылка) Тогда	 
			
			//1.1. Есть ли данный Код маркировки/Акцизная марка непосредственно в документе ТСД (регистре строк групп. доков):
			
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
			|	СобранныеДанныеПодбор.КМСсылка КАК КМСсылка
			|ИЗ
			|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК СобранныеДанныеПодбор
			|ГДЕ
			|	СобранныеДанныеПодбор.Ссылка = &ДокументТСД
			|	И СобранныеДанныеПодбор.КМСсылка = &КМСсылка
			|
			|СГРУППИРОВАТЬ ПО
			|	СобранныеДанныеПодбор.КМСсылка
			|
			|ИМЕЮЩИЕ
			|	СУММА(СобранныеДанныеПодбор.Количество) > 0
			|
			|ОБЪЕДИНИТЬ
			|
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	РегистрСобранныеДанныеПодбор.КМСсылка
			|ИЗ
			|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК РегистрСобранныеДанныеПодбор
			|ГДЕ
			|	РегистрСобранныеДанныеПодбор.ДокументТСД = &ДокументТСД
			|	И РегистрСобранныеДанныеПодбор.КМСсылка = &КМСсылка 
			|
			|СГРУППИРОВАТЬ ПО
			|	РегистрСобранныеДанныеПодбор.КМСсылка
			|
			|ИМЕЮЩИЕ
			|	СУММА(РегистрСобранныеДанныеПодбор.Количество) > 0
			|";
			Запрос.УстановитьПараметр("КМСсылка", СтруктураСтроки.КМСсылка);			
			Запрос.УстановитьПараметр("ДокументТСД", ДокументТСД);	
			
			Результат = Запрос.Выполнить();
			Если Не Результат.Пустой() Тогда
				Возврат Истина;	 
			КонецЕсли;	 
			
			//1.2. Есть ли данный Код маркировки/Акцизная марка в составе коробов, которые есть в доке ТСД или регистре строк групп. документов:
			
			Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
			Запрос.Текст =     
			//Получаем уже отсканированные короба:	
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
			|	СобранныеДанныеПодбор.УпаковочныйЛистСсылка КАК Упаковка 
			|ПОМЕСТИТЬ УжеОтсканированы
			|ИЗ
			|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК СобранныеДанныеПодбор
			|ГДЕ
			|	СобранныеДанныеПодбор.Ссылка = &ДокументТСД
			|   И НЕ СобранныеДанныеПодбор.УпаковочныйЛистСсылка = ЗНАЧЕНИЕ(Справочник.ШтрихкодыУпаковокТоваров.ПустаяСсылка)
			|
			|СГРУППИРОВАТЬ ПО
			|	СобранныеДанныеПодбор.УпаковочныйЛистСсылка
			|
			|ИМЕЮЩИЕ
			|	СУММА(СобранныеДанныеПодбор.Количество) > 0
			|
			|ОБЪЕДИНИТЬ
			|
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	РегистрСобранныеДанныеПодбор.УпаковочныйЛистСсылка
			|ИЗ
			|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК РегистрСобранныеДанныеПодбор
			|ГДЕ
			|	РегистрСобранныеДанныеПодбор.ДокументТСД = &ДокументТСД
			|   И НЕ РегистрСобранныеДанныеПодбор.УпаковочныйЛистСсылка = ЗНАЧЕНИЕ(Справочник.ШтрихкодыУпаковокТоваров.ПустаяСсылка)
			|
			|СГРУППИРОВАТЬ ПО
			|	РегистрСобранныеДанныеПодбор.УпаковочныйЛистСсылка
			|
			|ИМЕЮЩИЕ
			|	СУММА(РегистрСобранныеДанныеПодбор.Количество) > 0
			|;
			|/////////////////////////////////////////////////////////////////////////////////////// 
			//Выбираем Коды маркировки/Акцизные марки, которые есть внутри коробов:
			|ВЫБРАТЬ
			|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Штрихкод
			|ИЗ
			|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
			|ГДЕ
			|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка В (ВЫБРАТЬ УжеОтсканированы.Упаковка ИЗ УжеОтсканированы КАК УжеОтсканированы)
			|	И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод = &КМСсылка"; 
			
			Результат = Запрос.Выполнить();
			Если Не Результат.Пустой() Тогда
				Возврат Истина;	 
			КонецЕсли;	  
			
			//1.3. Есть ли данный Код маркировки/Акцизная марка в составе паллет, которые есть в доке ТСД или регистре строк групп. документов:
			
			Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
			|	УжеОтсканированы.Упаковка КАК Паллета 
			|ПОМЕСТИТЬ УжеОтсканированыПаллеты
			|ИЗ
			|	УжеОтсканированы КАК УжеОтсканированы
			|;
			|/////////////////////////////////////////////////////////////////////////////////////// 
			|ВЫБРАТЬ
			|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Короб
			|ПОМЕСТИТЬ УжеОтсканированыКороба
			|ИЗ
			|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
			|ГДЕ
			|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка В (ВЫБРАТЬ УжеОтсканированыПаллеты.Паллета ИЗ УжеОтсканированыПаллеты КАК УжеОтсканированыПаллеты)  
			|;
			|/////////////////////////////////////////////////////////////////////////////////////// 
			|ВЫБРАТЬ
			|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Штрихкод
			|ИЗ
			|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
			|ГДЕ
			|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка В (ВЫБРАТЬ УжеОтсканированыКороба.Короб ИЗ УжеОтсканированыКороба КАК УжеОтсканированыКороба)
			|	И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод = &КМСсылка";
			
			Результат = Запрос.Выполнить();
			Если Не Результат.Пустой() Тогда
				Возврат Истина;	 
			КонецЕсли;	  
			
		Иначе 	
			
			//2. Проверка Упаковки (Короба/Паллеты):
				
			Если ЗначениеЗаполнено(СтруктураСтроки.УпаковочныйЛистСсылка) Тогда
				
				//2.1. Если данная упаковка уже есть в документе ТСД или регистре:
				
				Запрос = Новый Запрос; 
				Запрос.Текст = 
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
				|	СобранныеДанныеПодбор.УпаковочныйЛистСсылка КАК Упаковка
				|ИЗ
				|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК СобранныеДанныеПодбор
				|ГДЕ
				|	СобранныеДанныеПодбор.Ссылка = &ДокументТСД
				|	И СобранныеДанныеПодбор.УпаковочныйЛистСсылка = &УпаковочныйЛистСсылка
				|	И СобранныеДанныеПодбор.Номенклатура = &Номенклатура
				|	И СобранныеДанныеПодбор.ХарактеристикаНоменклатуры = &ХарактеристикаНоменклатуры
				|
				|СГРУППИРОВАТЬ ПО
				|	СобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|
				|ИМЕЮЩИЕ
				|	СУММА(СобранныеДанныеПодбор.Количество) > 0
				|
				|ОБЪЕДИНИТЬ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	РегистрСобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|ИЗ
				|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК РегистрСобранныеДанныеПодбор
				|ГДЕ
				|	РегистрСобранныеДанныеПодбор.ДокументТСД = &ДокументТСД
				|	И РегистрСобранныеДанныеПодбор.КМСсылка = &УпаковочныйЛистСсылка
				|	И РегистрСобранныеДанныеПодбор.Номенклатура = &Номенклатура
				|	И РегистрСобранныеДанныеПодбор.ХарактеристикаНоменклатуры = &ХарактеристикаНоменклатуры
				|
				|СГРУППИРОВАТЬ ПО
				|	РегистрСобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|
				|ИМЕЮЩИЕ
				|	СУММА(РегистрСобранныеДанныеПодбор.Количество) > 0
				|";
				
				Запрос.УстановитьПараметр("УпаковочныйЛистСсылка", СтруктураСтроки.УпаковочныйЛистСсылка);
				Запрос.УстановитьПараметр("Номенклатура", СтруктураСтроки.Номенклатура);
				Запрос.УстановитьПараметр("ХарактеристикаНоменклатуры", СтруктураСтроки.ХарактеристикаНоменклатуры);
				
				Запрос.УстановитьПараметр("ДокументТСД", ДокументТСД);	
				
				Результат = Запрос.Выполнить();
				Если Не Результат.Пустой() Тогда
					Возврат Истина;	 
				КонецЕсли;
				
				//2.2. Если в паллету входит короб, который уже есть в документе ТСД или регистре:
				
				Запрос.Текст =    
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
				|	СобранныеДанныеПодбор.УпаковочныйЛистСсылка КАК Короб
				|ПОМЕСТИТЬ УжеОтсканированыКороба
				|ИЗ
				|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК СобранныеДанныеПодбор
				|ГДЕ
				|	СобранныеДанныеПодбор.Ссылка = &ДокументТСД
				|	И СобранныеДанныеПодбор.Номенклатура = &Номенклатура
				|	И СобранныеДанныеПодбор.ХарактеристикаНоменклатуры = &ХарактеристикаНоменклатуры
				|
				|СГРУППИРОВАТЬ ПО
				|	СобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|
				|ИМЕЮЩИЕ
				|	СУММА(СобранныеДанныеПодбор.Количество) > 0
				|
				|ОБЪЕДИНИТЬ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	РегистрСобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|ИЗ
				|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК РегистрСобранныеДанныеПодбор
				|ГДЕ
				|	РегистрСобранныеДанныеПодбор.ДокументТСД = &ДокументТСД
				|	И РегистрСобранныеДанныеПодбор.Номенклатура = &Номенклатура
				|	И РегистрСобранныеДанныеПодбор.ХарактеристикаНоменклатуры = &ХарактеристикаНоменклатуры
				|
				|СГРУППИРОВАТЬ ПО
				|	РегистрСобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|
				|ИМЕЮЩИЕ
				|	СУММА(РегистрСобранныеДанныеПодбор.Количество) > 0
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Короб
				|ИЗ
				|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
				|ГДЕ
				|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод В
				|			(ВЫБРАТЬ
				|				УжеОтсканированыКороба.Короб
				|			ИЗ
				|				УжеОтсканированыКороба КАК УжеОтсканированыКороба)
				|	И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка = &УпаковочныйЛистСсылка";
				
				Результат = Запрос.Выполнить();
				Если Не Результат.Пустой() Тогда
					Выборка = Результат.Выбрать();
					Пока Выборка.Следующий() Цикл
						Если Выборка.Короб.ВложенныеШтрихкоды.Количество() Тогда
							Возврат Истина;
						КонецЕсли;	
					КонецЦикла;
				КонецЕсли;				
				
				//2.3. Если данная упаковка (короб) входит в состав паллеты:
				
				Запрос.Текст =    
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
				|	СобранныеДанныеПодбор.УпаковочныйЛистСсылка КАК Паллета
				|ПОМЕСТИТЬ УжеОтсканированыПаллеты
				|ИЗ
				|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК СобранныеДанныеПодбор
				|ГДЕ
				|	СобранныеДанныеПодбор.Ссылка = &ДокументТСД
				|	И СобранныеДанныеПодбор.Номенклатура = &Номенклатура
				|	И СобранныеДанныеПодбор.ХарактеристикаНоменклатуры = &ХарактеристикаНоменклатуры 
				|
				|СГРУППИРОВАТЬ ПО
				|	СобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|
				|ИМЕЮЩИЕ
				|	СУММА(СобранныеДанныеПодбор.Количество) > 0
				|
				|ОБЪЕДИНИТЬ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	РегистрСобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|ИЗ
				|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК РегистрСобранныеДанныеПодбор
				|ГДЕ
				|	РегистрСобранныеДанныеПодбор.ДокументТСД = &ДокументТСД
				|	И РегистрСобранныеДанныеПодбор.Номенклатура = &Номенклатура
				|	И РегистрСобранныеДанныеПодбор.ХарактеристикаНоменклатуры = &ХарактеристикаНоменклатуры
				|
				|СГРУППИРОВАТЬ ПО
				|	РегистрСобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|
				|ИМЕЮЩИЕ
				|	СУММА(РегистрСобранныеДанныеПодбор.Количество) > 0
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Короб
				|ИЗ
				|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
				|ГДЕ
				|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка В
				|			(ВЫБРАТЬ
				|				УжеОтсканированыПаллеты.Паллета
				|			ИЗ
				|				УжеОтсканированыПаллеты КАК УжеОтсканированыПаллеты)
				|	И ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод = &УпаковочныйЛистСсылка";
				
				Результат = Запрос.Выполнить();
				Если Не Результат.Пустой() Тогда
					Выборка = Результат.Выбрать();
					Пока Выборка.Следующий() Цикл
						Если Выборка.Короб.ВложенныеШтрихкоды.Количество() Тогда
							Возврат Истина;
						КонецЕсли;	
					КонецЦикла;
				КонецЕсли;	
				
				//2.4. Если КМ данной упаковки уже есть в документе ТСД или регистре:
				
				Запрос.Текст =   
				
				"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
				|	СобранныеДанныеПодбор.КМСсылка КАК КМСсылка,
				|	СобранныеДанныеПодбор.УпаковочныйЛистСсылка КАК УпаковочныйЛистСсылка
				|ПОМЕСТИТЬ УжеОтсканированы
				|ИЗ
				|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК СобранныеДанныеПодбор
				|ГДЕ
				|	СобранныеДанныеПодбор.Ссылка = &ДокументТСД
				|	И СобранныеДанныеПодбор.Номенклатура = &Номенклатура
				|	И СобранныеДанныеПодбор.ХарактеристикаНоменклатуры = &ХарактеристикаНоменклатуры
				|
				|СГРУППИРОВАТЬ ПО
				|	СобранныеДанныеПодбор.КМСсылка,
				|	СобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|
				|ИМЕЮЩИЕ
				|	СУММА(СобранныеДанныеПодбор.Количество) > 0
				|
				|ОБЪЕДИНИТЬ
				|
				|ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	РегистрСобранныеДанныеПодбор.КМСсылка,
				|	РегистрСобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|ИЗ
				|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК РегистрСобранныеДанныеПодбор
				|ГДЕ
				|	РегистрСобранныеДанныеПодбор.ДокументТСД = &ДокументТСД
				|	И РегистрСобранныеДанныеПодбор.Номенклатура = &Номенклатура
				|	И РегистрСобранныеДанныеПодбор.ХарактеристикаНоменклатуры = &ХарактеристикаНоменклатуры
				|
				|СГРУППИРОВАТЬ ПО
				|	РегистрСобранныеДанныеПодбор.КМСсылка,
				|	РегистрСобранныеДанныеПодбор.УпаковочныйЛистСсылка
				|
				|ИМЕЮЩИЕ
				|	СУММА(РегистрСобранныеДанныеПодбор.Количество) > 0
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК Короб_ИЛИ_КМ
				|ПОМЕСТИТЬ Данные_Короба_ИЛИ_КМ
				|ИЗ
				|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
				|ГДЕ
				|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка = &УпаковочныйЛистСсылка
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод КАК КМ
				|ПОМЕСТИТЬ Данные_КМ_ИзКоробов
				|ИЗ
				|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
				|ГДЕ
				|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка В
				|			(ВЫБРАТЬ
				|				Данные_Короба_ИЛИ_КМ.Короб_ИЛИ_КМ
				|			ИЗ
				|				Данные_Короба_ИЛИ_КМ КАК Данные_Короба_ИЛИ_КМ)
				|;
				|
				|////////////////////////////////////////////////////////////////////////////////
				|ВЫБРАТЬ
				|	Данные_Короба_ИЛИ_КМ.Короб_ИЛИ_КМ КАК Короб_ИЛИ_КМ
				|ИЗ
				|	Данные_Короба_ИЛИ_КМ КАК Данные_Короба_ИЛИ_КМ
				|ГДЕ
				|	Данные_Короба_ИЛИ_КМ.Короб_ИЛИ_КМ В
				|			(ВЫБРАТЬ
				|				УжеОтсканированы.КМСсылка
				|			ИЗ
				|				УжеОтсканированы КАК УжеОтсканированы)
				|
				|ОБЪЕДИНИТЬ
				|
				|ВЫБРАТЬ
				|	Данные_КМ_ИзКоробов.КМ
				|ИЗ
				|	Данные_КМ_ИзКоробов КАК Данные_КМ_ИзКоробов
				|ГДЕ
				|	Данные_КМ_ИзКоробов.КМ В
				|			(ВЫБРАТЬ
				|				УжеОтсканированы.КМСсылка
				|			ИЗ
				|				УжеОтсканированы КАК УжеОтсканированы)";
				
				Результат = Запрос.Выполнить();
				Если Не Результат.Пустой() Тогда
					Возврат Истина;	 
				КонецЕсли;	
				
			КонецЕсли;				
			
		КонецЕсли;  
		
	Иначе	

		Если БылоСканированиеУпаковкиВСоставеДругойВЭтомДокументеМДЛП(СтруктураСтроки, ДокументТСД, Шаблон) Тогда
			Возврат Истина;	
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Функция БылоСканированиеУпаковкиВСоставеДругойВЭтомДокументеМДЛП(СтруктураСтроки, ДокументТСД, Шаблон)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА ПОДСТРОКА(ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист, 1, 4) = ""(00)""
	|			ТОГДА ПОДСТРОКА(ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист, 5, 18)
	|		ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист
	|	КОНЕЦ КАК УпаковочныйЛист,
	|	СУММА(ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Количество) КАК Количество
	|ПОМЕСТИТЬ ВТ_УпаковкиМДЛП
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Ссылка = &Ссылка
	|	И ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист <> """"
	|
	|СГРУППИРОВАТЬ ПО
	|	ВЫБОР
	|		КОГДА ПОДСТРОКА(ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист, 1, 4) = ""(00)""
	|			ТОГДА ПОДСТРОКА(ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист, 5, 18)
	|		ИНАЧЕ ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист
	|	КОНЕЦ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_УпаковкиМДЛП.УпаковочныйЛист КАК УпаковочныйЛист
	|ПОМЕСТИТЬ ВТ_УпаковкиИзПодбора
	|ИЗ
	|	ВТ_УпаковкиМДЛП КАК ВТ_УпаковкиМДЛП
	|ГДЕ
	|	ВТ_УпаковкиМДЛП.Количество > 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	УпаковкиМДЛП.НомерУпаковки КАК НомерУпаковки
	|ИЗ
	|	РегистрСведений.УпаковкиМДЛП КАК УпаковкиМДЛП
	|ГДЕ
	|	УпаковкиМДЛП.НомерУпаковки = &НомерУпаковки
	|	И УпаковкиМДЛП.НомерГрупповойУпаковки В
	|			(ВЫБРАТЬ
	|				ВТ_УпаковкиИзПодбора.УпаковочныйЛист КАК УпаковочныйЛист
	|			ИЗ
	|				ВТ_УпаковкиИзПодбора КАК ВТ_УпаковкиИзПодбора)";
	
	ЦРПТМарка = ДатаМобайл_МДЛП.УбратьИзМаркиУпрСимволы(СтруктураСтроки.ЦРПТМарка);
	
	Запрос.УстановитьПараметр("НомерУпаковки", ЦРПТМарка);
	Запрос.УстановитьПараметр("Ссылка", ДокументТСД);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Функция УпаковочныйЛистУжеИмеетВложенность(СтруктураСтроки = Неопределено, ДокументТСД = Неопределено, Шаблон = Неопределено)
	
	Если СтруктураСтроки = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ДатаМобайл_ОбщийМодуль.ЕстьМДЛП() Тогда
		ЭтоДокументМДЛП = ДатаМобайл_МДЛП.ЭтоДокументМДЛП(Шаблон.ВидДокумента);
	Иначе
		ЭтоДокументМДЛП = Ложь;
	КонецЕсли;	
		
	//Проверить что сканируем короб или палету, а ранее отсканированы КМ из этой упаковки
	Если СтруктураСтроки.УпаковочныйЛист <> "" Тогда
		
		УпаковочныйЛистСсылка = ДатаМобайл_Маркировка.ПолучитьСправочникСсылкаУпаковка(СтруктураСтроки.УпаковочныйЛист);
		Если УпаковочныйЛистСсылка<>Неопределено Тогда
			
			Если УпаковочныйЛистСсылка.ВложенныеШтрихкоды.Количество() > 0 Тогда
				Возврат Истина;
			КонецЕсли;	
			
		КонецЕсли;			
	КонецЕсли;
		
	Возврат Ложь;
	
КонецФункции

Функция КодМаркировкиУжеАгрегирован(СтруктураСтроки = Неопределено, ДокументТСД = Неопределено, Шаблон = Неопределено)
	
	Если СтруктураСтроки = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;	
	
	//Проверить что агрегируем КМ который еще не агрегирован
	Если ЗначениеЗаполнено(СтруктураСтроки.КМСсылка) Или ЗначениеЗаполнено(СтруктураСтроки.КоробСсылка) Тогда
		
		Запрос = Новый Запрос;
		//Получим данные упаковок где хранится марка по базе 1с
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
		|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка КАК Короб
		|ИЗ
		|	Справочник.ШтрихкодыУпаковокТоваров.ВложенныеШтрихкоды КАК ШтрихкодыУпаковокТоваровВложенныеШтрихкоды
		|ГДЕ
		|	ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод = &КМСсылка ИЛИ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Штрихкод = &КоробСсылка
		|	И НЕ ШтрихкодыУпаковокТоваровВложенныеШтрихкоды.Ссылка ЕСТЬ NULL";
		
		Запрос.УстановитьПараметр("КМСсылка", СтруктураСтроки.КМСсылка);
		Запрос.УстановитьПараметр("КоробСсылка", СтруктураСтроки.КоробСсылка);
		
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда	
			Возврат Истина;		
		КонецЕсли;
				
	КонецЕсли;
		
	Возврат Ложь;
	
КонецФункции

// Проверка уникальности кода маркировки группового задания.
//
// Параметры:
//
// ИмяТаблицы - Строка - "Insert"/"Select".
// УзелПО - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
// СсылкаНаДок - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД.
// СтрокаДокумента - Структура - Структура строки документа. 
// СтруктураСтроки - Структура - Структура строки. 
//
// Возвращаемое значение:
// Булево.
//   
Функция ПроверитьУникальностьКодаМаркировкиГрупповогоЗадания(ИмяТаблицы, УзелПО, СсылкаНаДок, СтрокаДокумента, СтруктураСтроки)
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	ЗапросПревышения = Новый Запрос;
	ЗапросПревышения.Текст = "ВЫБРАТЬ
	|   ТаблицаТоваровВРегистре.Количество КАК КоличествоПодбор,
	|	ТаблицаТоваровВРегистре.ТСД,
	|	ТаблицаТоваровВРегистре.ИдентификаторСтроки
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ТаблицаТоваровВРегистре
	|ГДЕ
	|	ТаблицаТоваровВРегистре.ДокументТСД = &ДокументТСД
	|	И ТаблицаТоваровВРегистре.ИмяТаблицы = &ИмяТаблицы
	|	И НЕ ТаблицаТоваровВРегистре.ДляОбмена
	|	И ТаблицаТоваровВРегистре.ЦРПТМарка = &ЦРПТМарка
	|	И НЕ (ТаблицаТоваровВРегистре.ИдентификаторСтроки = &ИдентификаторСтроки И ТаблицаТоваровВРегистре.ТСД = &ТСД)";
	
	ЗапросПревышения.УстановитьПараметр("ДокументТСД", СсылкаНаДок);
	ЗапросПревышения.УстановитьПараметр("ИмяТаблицы", ИмяТаблицы); 
	ЗапросПревышения.УстановитьПараметр("ЦРПТМарка", СтруктураСтроки.ЦРПТМарка);
	
	//проверим вероятно запись это не дубль, а повторная передача от ТСД для получения подтверждения, например при обрыве связи
	//тогда строка должна прийти с того же ТСД и с таким же идентификатором, тогда это не дубль и ругаться не надо
	ЗапросПревышения.УстановитьПараметр("ИдентификаторСтроки", СтруктураСтроки.ИдентификаторСтроки);
	ЗапросПревышения.УстановитьПараметр("ТСД", СтруктураСтроки.ТСД);
	
	ВыборкаПревышения = ЗапросПревышения.Выполнить().Выбрать();
	КоличествоПодбор = 0;
	Пока ВыборкаПревышения.Следующий() Цикл  
		КоличествоПодбор = КоличествоПодбор + ВыборкаПревышения.КоличествоПодбор;
	КонецЦикла;
	
	Если КоличествоПодбор > 0 Тогда 
		Возврат Истина;
	КонецЕсли;

	
	Возврат Ложь;
	
КонецФункции

// Проверка при сканировании упаковки в документе.
//
// Параметры:
//
// УпаковочныйЛист - Строка - Номер упак. листа/короба.
// ДокументТСД - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД. 
//
// Возвращаемое значение:
// Булево.
//
Функция БылоСканированиеУпаковкиВЭтомДокументе(УпаковочныйЛист, ДокументТСД = Неопределено)
	
	РезультатФункции = Ложь;
	
	Если УпаковочныйЛист = "" Тогда
		Возврат РезультатФункции;
	КонецЕсли;    
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	СобранныеДанныеПодбор.Ссылка КАК ДокТСД,
	|	СобранныеДанныеПодбор.Количество КАК Количество
	|ПОМЕСТИТЬ ИтоговыеДанные
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК СобранныеДанныеПодбор
	|ГДЕ
	|	СобранныеДанныеПодбор.Ссылка = &ДокументТСД
	|	И (СобранныеДанныеПодбор.УпаковочныйЛист = &УпаковочныйЛист
	|	ИЛИ СобранныеДанныеПодбор.Короб = &УпаковочныйЛист)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РегистрСобранныеДанныеПодбор.ДокументТСД,
	|	РегистрСобранныеДанныеПодбор.Количество
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК РегистрСобранныеДанныеПодбор
	|ГДЕ
	|	РегистрСобранныеДанныеПодбор.ДокументТСД = &ДокументТСД
	|	И (РегистрСобранныеДанныеПодбор.УпаковочныйЛист = &УпаковочныйЛист
	|	ИЛИ РегистрСобранныеДанныеПодбор.Короб = &УпаковочныйЛист)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ИтоговыеДанные.ДокТСД КАК ДокТСД,
	|	СУММА(ИтоговыеДанные.Количество) КАК Количество
	|ИЗ
	|	ИтоговыеДанные КАК ИтоговыеДанные
	|
	|СГРУППИРОВАТЬ ПО
	|	ИтоговыеДанные.ДокТСД
	|ИМЕЮЩИЕ СУММА(ИтоговыеДанные.Количество) <> 0";
	
	Запрос.УстановитьПараметр("УпаковочныйЛист", УпаковочныйЛист);			
	Запрос.УстановитьПараметр("ДокументТСД"    , ДокументТСД);	
	
	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда
		РезультатФункции = Истина;	 
	КонецЕсли;  
	
	Возврат РезультатФункции;
			
КонецФункции

#КонецОбласти

#КонецОбласти

#Область КТ2000
Функция GetDocArts_КТ2000(SN, UserName, DocOutID, НомерПакета = "")
	
	ОбъектСписка = Новый Массив();
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);	
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);
	КонецЕсли;  
	
	Если Не НомерПакета = "" Тогда
		ПакетнаяВыгрузка = Истина; 
		НомерПакета = Число(НомерПакета);
	Иначе
		ПакетнаяВыгрузка = Ложь;
	КонецЕсли;
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));	
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");	
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецПопытки;
	
	Если СсылкаНаДок.ПолучитьОбъект() = Неопределено Тогда		
		СтруктураОтвета.Вставить("Описание", "Не найден документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;	
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	Если Не ПакетнаяВыгрузка Или (ПакетнаяВыгрузка И НомерПакета = 1) Тогда
		
		Если Шаблон.ЕГАИС Тогда
			//Пиво в ЕГАИС документах		
			Если Шаблон.ВидДокумента = "РеализацияТоваровУслуг" Или Шаблон.ВидДокумента = "ПеремещениеТоваров" Или Шаблон.ВидДокумента = "СписаниеНедостачТоваров" Или Шаблон.ВидДокумента = "ОрдерНаОтражениеНедостачТоваров" 
				Или Шаблон.ВидДокумента = "ДатаМобайл_ЗаявкаНаСклад" Или Шаблон.ВидДокумента = "ДатаМобайл_УпаковочныйЛист" Тогда		
				Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
				|	Документ1С.Номенклатура КАК Ссылка
				|ИЗ
				|	Документ.ОтборРазмещениеТоваров.ТоварыОтбор КАК Документ1С
				|ГДЕ
				|	Документ1С.Ссылка = &Ссылка
				|	И Документ1С.Номенклатура.алкВидПродукции В (&СписокМарок)");			
				Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыОтбор КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
				
			Иначе	
				Запрос = Новый Запрос("ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
				|		СоответствиеНоменклатурыЕГАИС.Номенклатура КАК Ссылка
				|	ИЗ
				|		Документ.алкТоварноТранспортнаяНакладнаяЕГАИС.Товары КАК Документ1С
				|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.алкСоответствияАлкогольнойПродукцииЕГАИСИНоменклатуры КАК СоответствиеНоменклатурыЕГАИС
				|		ПО  СоответствиеНоменклатурыЕГАИС.АлкогольнаяПродукция = Документ1С.АлкогольнаяПродукция
				|	ГДЕ
				|		Документ1С.Ссылка = &Ссылка
				|		И Документ1С.АлкогольнаяПродукция.ВидПродукции В (&СписокМарок)
				|		И НЕ СоответствиеНоменклатурыЕГАИС.Номенклатура ЕСТЬ NULL");
				Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");		
			КонецЕсли;
			
			Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок.ИсходныйДокумент);
			СписокМарок = ДатаМобайл_ОбщийМодуль.СформироватьСписокНепроверяемыхМарокЕГАИС();	
			Запрос.УстановитьПараметр("СписокМарок", СписокМарок);
			Запрос.Текст = СтрЗаменить(Запрос.Текст, ".алкТоварноТранспортнаяНакладнаяЕГАИС.", "." + Шаблон.ВидДокумента + ".");
			Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ОтборРазмещениеТоваров.", "." + Шаблон.ВидДокумента + ".");
			
			МассивКВыгрузке = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
			
			Если ПакетнаяВыгрузка Тогда  
				
				МассивКВыгрузкеУникальные = Новый Массив;
				Для каждого Строка Из МассивКВыгрузке Цикл
					Если МассивКВыгрузкеУникальные.Найти(Строка) = Неопределено Тогда
						МассивКВыгрузкеУникальные.Добавить(Строка); 					
					КонецЕсли; 
				КонецЦикла; 
				
				МассивКВыгрузке_Пакет = Новый Массив;  
				
				//выберем 1000:
				Счетчик = 1;
				
				//зарегистрируем для выгрузки:
				Для каждого ЭлементМассива Из МассивКВыгрузкеУникальные Цикл 
					
					Если Счетчик <= 1000 Тогда
						МассивКВыгрузке_Пакет.Добавить(ЭлементМассива);
						ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, ЭлементМассива);
					Иначе
						ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, ЭлементМассива);
					КонецЕсли;										
					
					Счетчик = Счетчик + 1;
					
				КонецЦикла;    
				
				ПланыОбмена.ВыбратьИзменения(УзелПО, НомерПакета, МассивКВыгрузке_Пакет);	
				Если МассивКВыгрузке_Пакет.Количество() > 0 Тогда
					ОбъектСписка = СобратьТовары(МассивКВыгрузке_Пакет, УзелПО, , Шаблон, Истина);
				Иначе	
					СтруктураОтвета = Новый Структура;
					СтруктураОтвета.Вставить("is_finished", Истина);		
					СтруктураОтвета.Вставить("data", ОбъектСписка);  				
					Возврат ПодготовитьОтветJSON(СтруктураОтвета); 		 
				КонецЕсли; 
				
			Иначе			
				
				Если МассивКВыгрузке.Количество() > 0 Тогда
					ОбъектСписка = СобратьТовары(МассивКВыгрузке, УзелПО, Запрос.Выполнить().Выгрузить(), Шаблон);
				Иначе
					СтруктураОтвета = Новый Структура;
					СтруктураОтвета.Вставить("is_finished", Истина);		
					СтруктураОтвета.Вставить("data", ОбъектСписка);  				
					Возврат ПодготовитьОтветJSON(СтруктураОтвета); 	
				КонецЕсли;
				
			КонецЕсли;	
			
		Иначе
			Запрос = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	Документ1С.Номенклатура КАК Ссылка,
			|	Документ1С.Характеристика
			|ИЗ
			|	Документ.ОтборРазмещениеТоваров.ТоварыОтбор КАК Документ1С
			|ГДЕ
			|	Документ1С.Ссылка = &Ссылка
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|
			|ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	Документ1С.Номенклатура,
			|	Документ1С.Характеристика
			|ИЗ
			|	Документ.ОтборРазмещениеТоваров.ТоварыРазмещение КАК Документ1С
			|ГДЕ
			|	Документ1С.Ссылка = &Ссылка");
			Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок.ИсходныйДокумент);
			
			Если Шаблон.ЕГАИС И Шаблон.ВидДокумента <> "ВскрытиеТарыЕГАИС" И Шаблон.ВидДокумента <> "УдалитьВскрытиеТарыЕГАИС" И Шаблон.ВидДокумента <> "ВозвратТоваровОтПокупателя" Тогда
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "Документ1С.Номенклатура КАК Ссылка,", "Документ1С.АлкогольнаяПродукция КАК Ссылка,");	
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "Документ1С.Номенклатура,", "Документ1С.АлкогольнаяПродукция,");	
				Запрос.Текст = СтрЗаменить(Запрос.Текст, "Документ1С.Характеристика", "ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика");	
			КонецЕсли;
			
			Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ОтборРазмещениеТоваров.", "." + Шаблон.ВидДокумента + ".");
			
			Если Не Шаблон.ИмяТабличнойЧастиПодбор = "" Тогда
				Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыОтбор КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
			Иначе
				Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыОтбор КАК ", "." + Шаблон.ИмяТабличнойЧастиПриемка + " КАК ");
			КонецЕсли;
			
			Если Не Шаблон.ИмяТабличнойЧастиПриемка = "" Тогда
				Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыРазмещение КАК ", "." + Шаблон.ИмяТабличнойЧастиПриемка + " КАК ");
			Иначе
				Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ТоварыРазмещение КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
			КонецЕсли;	
			МассивКВыгрузке = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка"); 
			МассивХарактеристикКВыгрузке = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Характеристика");
			
			Если ПакетнаяВыгрузка Тогда
				
				МассивКВыгрузкеУникальные = Новый Массив;
				Для каждого Строка Из МассивКВыгрузке Цикл
					Если МассивКВыгрузкеУникальные.Найти(Строка) = Неопределено Тогда
						МассивКВыгрузкеУникальные.Добавить(Строка); 					
					КонецЕсли; 
				КонецЦикла; 
				
				МассивКВыгрузке_Пакет = Новый Массив;
				МассивХарактеристик_Пакет = Новый Массив;
				МассивДанныхКВыгрузке_Пакет = Новый Массив;
				//выберем 10:
				Счетчик = 1;  
				
				//зарегистрируем для выгрузки номенклатуру и характеристики:
				Для каждого ЭлементМассива Из МассивКВыгрузкеУникальные Цикл 
					
					МассивКВыгрузке_Пакет.Добавить(ЭлементМассива); 
					МассивДанныхКВыгрузке_Пакет.Добавить(ЭлементМассива);
					ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, ЭлементМассива);			
					
					Счетчик = Счетчик + 1;
					
				КонецЦикла;  
				
				Если Не МассивХарактеристикКВыгрузке = Неопределено Тогда 			
					
					Если Счетчик < 10 Тогда
						Для каждого ЭлементМассива Из МассивХарактеристикКВыгрузке Цикл 
							
							Если ЗначениеЗаполнено(ЭлементМассива) Тогда
								Если Счетчик < 10 Тогда
									МассивХарактеристик_Пакет.Добавить(ЭлементМассива);
									МассивДанныхКВыгрузке_Пакет.Добавить(ЭлементМассива);
									ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, ЭлементМассива);
								Иначе
									ПланыОбмена.ЗарегистрироватьИзменения(УзелПО, ЭлементМассива);
								КонецЕсли;
							КонецЕсли;	
							
							Счетчик = Счетчик + 1;
						КонецЦикла;
					КонецЕсли;
					
				Иначе	
					
					МассивХарактеристик_Пакет = Неопределено;
					
				КонецЕсли;	 
				
				ПланыОбмена.ВыбратьИзменения(УзелПО, НомерПакета, МассивДанныхКВыгрузке_Пакет);
				
				Если МассивКВыгрузке_Пакет.Количество() > 0 Тогда
					ОбъектСписка = СобратьТовары(МассивКВыгрузке_Пакет, УзелПО, МассивХарактеристик_Пакет, Шаблон, Истина);	
				Иначе
					СтруктураОтвета = Новый Структура;
					СтруктураОтвета.Вставить("is_finished", Истина);		
					СтруктураОтвета.Вставить("data", ОбъектСписка);  				
					Возврат ПодготовитьОтветJSON(СтруктураОтвета); 	
				КонецЕсли;	
							
			Иначе
				
				Если МассивКВыгрузке.Количество() > 0 Тогда
					ОбъектСписка = СобратьТовары(МассивКВыгрузке, УзелПО, МассивХарактеристикКВыгрузке, Шаблон);
				КонецЕсли;  
				
			КонецЕсли;																			
		КонецЕсли;
		
	Иначе
								
		//1. удаляем данные предыдущего пакета:  	
		ПланыОбмена.УдалитьРегистрациюИзменений(УзелПО, НомерПакета - 1); 	
		//2. регистрируем данные нового пакета:
			
		//берем первую 10 и передаем массив: 
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 10
		|	НоменклатураИзменения.Ссылка КАК Номенклатура
		|ИЗ
		|	Справочник.Номенклатура.Изменения КАК НоменклатураИзменения
		|ГДЕ
		|	НоменклатураИзменения.Узел = &Узел
		|	И ISNULL(НоменклатураИзменения.НомерСообщения, ИСТИНА) = ИСТИНА";
		Запрос.УстановитьПараметр("Узел", УзелПО);
		Запрос.УстановитьПараметр("НомерСообщения", 0);
		РезультатЗапроса = Запрос.Выполнить();
		Если Не РезультатЗапроса.Пустой() Тогда
			
			МассивКВыгрузке = РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("Номенклатура");	
			ПланыОбмена.ВыбратьИзменения(УзелПО, НомерПакета, МассивКВыгрузке);
			
			Запрос.Текст = 
			"ВЫБРАТЬ
			|	ХарактеристикиНоменклатурыИзменения.Ссылка КАК ХарактеристикаНоменклатуры
			|ИЗ
			|	Справочник.ХарактеристикиНоменклатуры.Изменения КАК ХарактеристикиНоменклатурыИзменения
			|ГДЕ
			|	ХарактеристикиНоменклатурыИзменения.Узел = &Узел
			|	И ЕСТЬNULL(ХарактеристикиНоменклатурыИзменения.НомерСообщения, ИСТИНА) = ИСТИНА
			|	И ХарактеристикиНоменклатурыИзменения.Ссылка.Владелец В(&МассивКВыгрузке)";
			Запрос.УстановитьПараметр("Узел", УзелПО);
			Запрос.УстановитьПараметр("НомерСообщения", 0);
			Запрос.УстановитьПараметр("МассивКВыгрузке", МассивКВыгрузке);
			РезультатЗапроса = Запрос.Выполнить();
			Если Не РезультатЗапроса.Пустой() Тогда      					
				МассивХарактеристик = РезультатЗапроса.Выгрузить().ВыгрузитьКолонку("ХарактеристикаНоменклатуры");	
				ПланыОбмена.ВыбратьИзменения(УзелПО, НомерПакета, МассивХарактеристик);
			Иначе
				МассивХарактеристик = Неопределено;
			КонецЕсли;  
			
			ОбъектСписка = СобратьТовары(МассивКВыгрузке, УзелПО, МассивХарактеристик, Шаблон, Истина);
			
		КонецЕсли;  	
		
	КонецЕсли;	
				
	Возврат ПодготовитьОтветJSON(ОбъектСписка);
	
КонецФункции
Функция OnArtEgaisScan_КТ2000(SN, UserName, ArtID, Barcode, PDFBarcode, DocOutID, Cell) 
	
	СтруктураОтвета = Новый Структура;
	
	ОбъектТовараЕГАИС = ПолучитьСтруктуруОбъектаДляHttp("egais_art");
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName);   
	КонецЕсли;
	
	Если Не (СтрДлина(PDFBarcode) = 68 Или СтрДлина(PDFBarcode) = 150) Тогда  // формат марки	
		СтруктураОтвета.Вставить("Описание", "Некорректный формат марки. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецЕсли;
	
	Попытка		
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));			
	Исключение		
		СтруктураОтвета.Вставить("Описание", "Не удалось найти документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецПопытки;
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	Если стрДлина(PDFBarcode) = 68 Тогда
		Алкокод = КодНоменклатурыЕГАИСПоPDF417(PDFBarcode);
		
		ЗапросЕГАИС = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
		|	ЕГАИС_Номенклатура.Ссылка,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Наименование, """") КАК name,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Производитель.Наименование, """") КАК manufacturer,
		|	"""" КАК importer,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Объем, 0) КАК capacity,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.Крепость, 0) КАК percent_alco,
		|	ЕСТЬNULL(ЕГАИС_Номенклатура.ВидПродукции.Наименование, """") КАК type_alco
		|ИЗ
		|	Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС КАК ЕГАИС_Номенклатура
		|ГДЕ
		|	ЕГАИС_Номенклатура.Код = &Код
		|	И НЕ ЕГАИС_Номенклатура.ПометкаУдаления");
		ЗапросЕГАИС.УстановитьПараметр("Код", Алкокод);
		
		ВыборкаЕГАИС = ЗапросЕГАИС.Выполнить().Выбрать();
		Пока ВыборкаЕГАИС.Следующий() Цикл			
			OnArtEgaisScan_ЗаполнитьОбъектТовара(ВыборкаЕГАИС, ОбъектТовараЕГАИС);
			ОбъектТовараЕГАИС.box_coef = 6; //количество единиц в коробе
		КонецЦикла;		
	ИначеЕсли стрДлина(PDFBarcode) = 150 Тогда        // новые марки
		//во входящей ттн упаковки смотрим в самом доке
		ЭтоВходящаяТТН = Ложь;
		Если Шаблон.ВидДокумента = "алкТоварноТранспортнаяНакладнаяЕГАИС" Тогда
			Если СсылкаНаДок.ИсходныйДокумент.ВидДокумента = Перечисления.алкВидыДокументовЕГАИС.Входящий Тогда
				ЭтоВходящаяТТН = Истина;
			КонецЕсли;
		КонецЕсли;
		
		Если ЭтоВходящаяТТН Тогда			
			ЗапросЕГАИС = Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	ЕстьNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция,ЗНАЧЕНИЕ(Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.ПустаяСсылка)) КАК Ссылка,
			|	ЕстьNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция.Код, """")  КАК Алкокод,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция.Наименование, """") КАК name,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция.Производитель.Наименование, """") КАК manufacturer,
			|	"""" КАК importer,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция.Объем, 0) КАК capacity,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция.Крепость, 0) КАК percent_alco,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция.ВидПродукции.Наименование, """") КАК type_alco			
			|ИЗ
			|	Документ.алкТоварноТранспортнаяНакладнаяЕГАИС.АкцизныеМарки КАК ЕГАИС_Марки
			|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.алкТоварноТранспортнаяНакладнаяЕГАИС.Товары КАК ЕГАИС_Номенклатура
			|		ПО ЕГАИС_Марки.КлючСвязи = ЕГАИС_Номенклатура.КлючСвязи
			|		И ЕГАИС_Марки.Ссылка = ЕГАИС_Номенклатура.Ссылка
			|ГДЕ
			|   ЕГАИС_Марки.Ссылка = &СсылкаНаТТН И ЕГАИС_Номенклатура.Ссылка = &СсылкаНаТТН 
			|   И ЕГАИС_Марки.КодАкцизнойМарки = &Код
			|   И НЕ ЕГАИС_Номенклатура.АлкогольнаяПродукция ЕСТЬ NULL");
			
			ЗапросЕГАИС.УстановитьПараметр("Код", PDFBarcode);
			ЗапросЕГАИС.УстановитьПараметр("СсылкаНаТТН", СсылкаНаДок.ИсходныйДокумент);			
		Иначе			
			ЗапросЕГАИС = Новый Запрос("ВЫБРАТЬ ПЕРВЫЕ 1
			|	ЕГАИС_Номенклатура.АлкогольнаяПродукция.Ссылка КАК Ссылка,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция.Наименование, """") КАК name,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция.Производитель.Наименование, """") КАК manufacturer,
			|	"""" КАК importer,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция.Объем, 0) КАК capacity,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция.Крепость, 0) КАК percent_alco,
			|	ЕСТЬNULL(ЕГАИС_Номенклатура.АлкогольнаяПродукция.ВидПродукции.Наименование, """") КАК type_alco
			|ИЗ
			|	РегистрСведений.алкХранилищеАкцизныхМарок КАК ЕГАИС_Номенклатура
			|ГДЕ
			|	ЕГАИС_Номенклатура.Марка = &Код
			|	И НЕ ЕГАИС_Номенклатура.АлкогольнаяПродукция.ПометкаУдаления");
			ЗапросЕГАИС.УстановитьПараметр("Код", PDFBarcode);
		КонецЕсли;
		
		ВыборкаЕГАИС = ЗапросЕГАИС.Выполнить().Выбрать();
		Пока ВыборкаЕГАИС.Следующий() Цикл
			OnArtEgaisScan_ЗаполнитьОбъектТовара(ВыборкаЕГАИС, ОбъектТовараЕГАИС);
			ОбъектТовараЕГАИС.box_coef = 6; //количество единиц в коробе
		КонецЦикла;
	КонецЕсли;
	
	Возврат ПодготовитьОтветJSON(ОбъектТовараЕГАИС);	
	
КонецФункции
Функция OnEgaisPalletScan_КТ2000(SN, UserName, Barcode, DocOutID, Cell)
	
	ОбъектСписка = Новый Массив;
	СтруктураОтвета = Новый Структура;
	
	УзелПО = НайтиУзел(SN);
	Если УзелПО = Неопределено Тогда
		УзелПО = NewTSD(SN, UserName); 
	КонецЕсли;	
	
	Попытка
		СсылкаНаДок = XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДокументыТСД"), Сред(DocOutID, 5));
	Исключение	
		СтруктураОтвета.Вставить("Описание", "Не нашли документ. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);	
	КонецПопытки;
	
	Шаблон = СсылкаНаДок.Шаблон;
	
	//во входящей ттн упаковки смотрим в самом доке
	ЭтоВходящаяТТН = Ложь;
	Если Шаблон.ВидДокумента = "алкТоварноТранспортнаяНакладнаяЕГАИС" Тогда
		Если СсылкаНаДок.ИсходныйДокумент.ВидДокумента = Перечисления.алкВидыДокументовЕГАИС.Входящий Тогда
			ЭтоВходящаяТТН = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если ЭтоВходящаяТТН Тогда
		//марки входящей ТТН в задании
		Возврат ПодготовитьОтветJSON(ОбъектСписка);
	Иначе		
		ТЗМарок = ПолучитьТаблицуУпакованныхМарок_КТ2000(Barcode);
	КонецЕсли;
	
	Для каждого СтрокаДока Из ТЗМарок Цикл
		СтруктураТекущейСтроки = Новый Структура;
		
		qty = 1; 
		СтруктураТекущейСтроки.Вставить("qty", qty);
		
		ОбъектЕГАИС = ПолучитьСтруктуруОбъектаДляHttp("egais");
		ОбъектЕГАИС.mark = СтрокаДока.Марка;	
		СтруктураТекущейСтроки.Вставить("egais", ОбъектЕГАИС);
		
		Если ЗначениеЗаполнено(ОбъектЕГАИС.mark) Тогда				
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		КонецЕсли;
	КонецЦикла;	
	
	Возврат ПодготовитьОтветJSON(ОбъектСписка);	
	
КонецФункции 
Функция ПолучитьТаблицуУпакованныхМарок_КТ2000(ИдентификаторУпаковки = "", Период = Неопределено, ЭтоВыборочнаяПроверка = Ложь) Экспорт
	
	ТЗМарок = Новый Массив;
	ТЗУпаковок = Новый Массив;
	
	Если ИдентификаторУпаковки = "" Тогда
		Возврат ТЗМарок;
	Иначе
		ТЗУпаковок.Добавить(ИдентификаторУпаковки);
	КонецЕсли;	
	
	ЭтоКороб = ПроверитьУпаковочныйлистЭтоКороб_КТ2000(ИдентификаторУпаковки);
	
	//Получим упаковки палеты
	Если Не ЭтоКороб Тогда	
		ЗапросУпаковок = Новый Запрос;
		ЗапросУпаковок.УстановитьПараметр("Период", ?(ЗначениеЗаполнено(Период), Период, Неопределено));
		ЗапросУпаковок.УстановитьПараметр("Упаковка", ИдентификаторУпаковки);
		ЗапросУпаковок.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
		|	алкХранилищеУпаковокСрезПоследних.Регистратор,
		|	алкХранилищеУпаковокСрезПоследних.Упаковка
		|ПОМЕСТИТЬ ДанныеУпаковки	
		|ИЗ
		|	РегистрСведений.алкХранилищеУпаковок.СрезПоследних(&Период, Упаковка = &Упаковка) КАК алкХранилищеУпаковокСрезПоследних
		|ГДЕ
		|	алкХранилищеУпаковокСрезПоследних.ИерархияУпаковки = """"
		|;
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	алкХранилищеУпаковокСрезПоследних.Регистратор,
		|	алкХранилищеУпаковокСрезПоследних.Упаковка
		|ИЗ
		|	РегистрСведений.алкХранилищеУпаковок.СрезПоследних(&Период, ИерархияУпаковки = &Упаковка) КАК алкХранилищеУпаковокСрезПоследних
		|	ЛЕВОЕ СОЕДИНЕНИЕ ДанныеУпаковки КАК ДанныеУпаковки
		|	ПО ДанныеУпаковки.Регистратор = алкХранилищеУпаковокСрезПоследних.Регистратор
		|ГДЕ
		|	алкХранилищеУпаковокСрезПоследних.Упаковка <> """"
		|	И НЕ ДанныеУпаковки.Регистратор ЕСТЬ NULL И НЕ ДанныеУпаковки.Регистратор ЕСТЬ NULL"; 
		
		Выборка = ЗапросУпаковок.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			ТЗУпаковок.Добавить(Выборка.Упаковка);	
		КонецЦикла;	
	КонецЕсли;	
	
	ТЗМарок = Новый ТаблицаЗначений();
	ТЗМарок.Колонки.Добавить("Период");	
	ТЗМарок.Колонки.Добавить("Регистратор");
	ТЗМарок.Колонки.Добавить("Марка");	
	ТЗМарок.Колонки.Добавить("СправкаБ");
	ТЗМарок.Колонки.Добавить("АлкогольнаяПродукция");
	ТЗМарок.Колонки.Добавить("Организация");
	ТЗМарок.Колонки.Добавить("ПунктРазгрузки");
	ТЗМарок.Колонки.Добавить("ОтметкаВыбытия");
	ТЗМарок.Колонки.Добавить("Упаковка");
	ТЗМарок.Колонки.Добавить("ЭтоУпаковка");
	ТЗМарок.Колонки.Добавить("Наименование");
	
	Если ЭтоВыборочнаяПроверка Тогда
		ТЗМарок.Колонки.Добавить("Количество");	
	КонецЕсли;
	
	//Получим список марок	
	Для каждого Упаковка Из ТЗУпаковок Цикл		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Период", ?(ЗначениеЗаполнено(Период), Период, Неопределено));
		Запрос.УстановитьПараметр("Упаковка", Упаковка);
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
		|	алкХранилищеУпаковокСрезПоследних.Регистратор,
		|	алкХранилищеУпаковокСрезПоследних.Упаковка	
		|ИЗ
		|	РегистрСведений.алкХранилищеУпаковок.СрезПоследних(&Период, Упаковка = &Упаковка) КАК алкХранилищеУпаковокСрезПоследних";
		
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Регистратор = Выборка.Регистратор;
		Иначе
			Возврат ТЗМарок;
		КонецЕсли;		
		
		Запрос = Новый Запрос;
		Запрос.УстановитьПараметр("Период", ?(ЗначениеЗаполнено(Период), Период, Неопределено));
		Запрос.УстановитьПараметр("Упаковка", Упаковка);
		Запрос.УстановитьПараметр("Регистратор", Регистратор);	
		Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	алкХранилищеАкцизныхМарокСрезПоследних.Период,
		|	алкХранилищеАкцизныхМарокСрезПоследних.Регистратор,
		|	алкХранилищеАкцизныхМарокСрезПоследних.Марка КАК Марка,
		|	алкХранилищеАкцизныхМарокСрезПоследних.СправкаБ,
		|	алкХранилищеАкцизныхМарокСрезПоследних.АлкогольнаяПродукция,
		|	алкХранилищеАкцизныхМарокСрезПоследних.Организация,
		|	алкХранилищеАкцизныхМарокСрезПоследних.ПунктРазгрузки,
		|	алкХранилищеАкцизныхМарокСрезПоследних.ОтметкаВыбытия,
		|	алкХранилищеАкцизныхМарокСрезПоследних.Упаковка,
		|	алкХранилищеАкцизныхМарокСрезПоследних.Упаковка КАК Наименование
		|ИЗ
		|	РегистрСведений.алкХранилищеАкцизныхМарок.СрезПоследних(&Период, Упаковка = &Упаковка И Регистратор = &Регистратор) КАК алкХранилищеАкцизныхМарокСрезПоследних
		|ГДЕ
		|	алкХранилищеАкцизныхМарокСрезПоследних.ОтметкаВыбытия = ЛОЖЬ"; 
		
		Выборка = Запрос.Выполнить().Выбрать();
		Пока Выборка.Следующий() Цикл
			НоваяСтрока = ТЗМарок.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока,Выборка);
			
			Если ЭтоВыборочнаяПроверка Тогда
				НоваяСтрока.Количество = 1;
			КонецЕсли;			
		КонецЦикла;		
	КонецЦикла;
	
	Если ТЗМарок.Количество() > 0 Тогда
	Иначе
		Если ЭтоКороб Тогда
			//Информация об упаковках в регистре марок
			Запрос = Новый Запрос;
			Запрос.УстановитьПараметр("Период", ?(ЗначениеЗаполнено(Период), Период, Неопределено));
			Запрос.УстановитьПараметр("Упаковка", ИдентификаторУпаковки);
			
			Запрос.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	алкХранилищеАкцизныхМарокСрезПоследних.Период,
			|	алкХранилищеАкцизныхМарокСрезПоследних.Регистратор,
			|	алкХранилищеАкцизныхМарокСрезПоследних.Марка КАК Марка,
			|	алкХранилищеАкцизныхМарокСрезПоследних.СправкаБ,
			|	алкХранилищеАкцизныхМарокСрезПоследних.АлкогольнаяПродукция,
			|	алкХранилищеАкцизныхМарокСрезПоследних.Организация,
			|	алкХранилищеАкцизныхМарокСрезПоследних.ПунктРазгрузки,
			|	алкХранилищеАкцизныхМарокСрезПоследних.ОтметкаВыбытия,
			|	алкХранилищеАкцизныхМарокСрезПоследних.Упаковка,
			|	алкХранилищеАкцизныхМарокСрезПоследних.Упаковка КАК Наименование
			|ИЗ
			|	РегистрСведений.алкХранилищеАкцизныхМарок.СрезПоследних(&Период, Упаковка = &Упаковка) КАК алкХранилищеАкцизныхМарокСрезПоследних
			|ГДЕ
			|	алкХранилищеАкцизныхМарокСрезПоследних.ОтметкаВыбытия = ЛОЖЬ"; 
			
			ТЗМарок = Запрос.Выполнить().Выгрузить();
		КонецЕсли;	
	КонецЕсли;	
	
	Возврат ТЗМарок;
	
КонецФункции
Функция ПроверитьУпаковочныйлистЭтоКороб_КТ2000(УпаковочныйЛист, Период = Неопределено) Экспорт
	
	Если ПустаяСтрока(УпаковочныйЛист) Тогда
		Возврат Истина;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Упаковка", УпаковочныйЛист);
	Запрос.УстановитьПараметр("Период", ?(ЗначениеЗаполнено(Период), Период, Неопределено));
	Запрос.Текст = "ВЫБРАТЬ
	|	алкХранилищеУпаковокСрезПоследних.Упаковка,
	|	алкХранилищеУпаковокСрезПоследних.ИерархияУпаковки
	|ИЗ
	|	РегистрСведений.алкХранилищеУпаковок.СрезПоследних(&Период, ИерархияУпаковки = &Упаковка) КАК алкХранилищеУпаковокСрезПоследних";
	
	Результат = Запрос.Выполнить().Выбрать();
	Если Результат.Следующий() Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции
Процедура GetDocRowsSelectEGAIS_КТ2000(УзелПО, Шаблон, ОбъектСписка, СсылкаНаДок)
	
	ВидДокумента = Шаблон.ВидДокумента;
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ТаблицаТоваровВДокументе.АлкогольнаяПродукция КАК Номенклатура,
	|	ТаблицаТоваровВДокументе.Количество КАК Количество,
	|	ТаблицаТоваровВДокументе.НомерСтроки КАК НомерСтроки,
	|	ТаблицаТоваровВДокументе.КлючСвязи КАК ИдентификаторСтроки
	|ПОМЕСТИТЬ ЗапросСЛимитами 
	|ИЗ
	|	Документ.алкТоварноТранспортнаяНакладнаяЕГАИС.Товары КАК ТаблицаТоваровВДокументе
	|ГДЕ
	|	ТаблицаТоваровВДокументе.Ссылка = &ИсходноеЗадание
	|	И НЕ ТаблицаТоваровВДокументе.АлкогольнаяПродукция.ВидПродукции В (&СписокМарок)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|///////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
	|	СУММА(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество) КАК Количество
	|ПОМЕСТИТЬ РезервыТСД
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка <> &Ссылка
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.Шаблон.РезервироватьТовар
	|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура
	|;
	|///////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ЗапросСЛимитами.Номенклатура,
	|	ЗапросСЛимитами.Количество КАК Количество,
	|   СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0) - ЕСТЬNULL(РезервыТСД.Количество, 0)) КАК Лимит,
	|	ЗапросСЛимитами.НомерСтроки КАК НомерСтроки,
	|	ЗапросСЛимитами.ИдентификаторСтроки КАК ИдентификаторСтроки
	|ИЗ
	|	ЗапросСЛимитами КАК ЗапросСЛимитами
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
	|				,
	|				&ВсеСклады
	|					ИЛИ Склад В (&Склады)) КАК ТоварыНаСкладахОстатки
	|		ПО ЗапросСЛимитами.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РезервыТСД КАК РезервыТСД
	|		ПО ЗапросСЛимитами.Номенклатура = РезервыТСД.Номенклатура
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗапросСЛимитами.Номенклатура,
	|	ЗапросСЛимитами.Количество,
	|	ЗапросСЛимитами.НомерСтроки,
	|	ЗапросСЛимитами.ИдентификаторСтроки
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки"); 	
	
	СписокМарок = ДатаМобайл_ОбщийМодуль.СформироватьСписокНепроверяемыхМарокЕГАИС();
	Запрос.УстановитьПараметр("СписокМарок", СписокМарок);		
	
	Если ВидДокумента <> "алкТоварноТранспортнаяНакладнаяЕГАИС" Тогда 
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.КлючСвязи", "0");
	КонецЕсли;	
	
	Если ВидДокумента = "ДатаМобайл_УпаковочныйЛист" Тогда 
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.АлкогольнаяПродукция", "ТаблицаТоваровВДокументе.ЕГАИС_Номенклатура");
	ИначеЕсли ВидДокумента = "алкАктФиксацииШтрихкодовНаБалансеОрганизацииЕГАИС" Тогда 
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ТаблицаТоваровВДокументе.Количество", "0");
	ИначеЕсли ВидДокумента = "РеализацияТоваровУслуг" Или ВидДокумента = "ЗаказПокупателя" Или ВидДокумента = "РасходныйОрдерНаТовары" Или ВидДокумента = "ЧекККМ" Тогда 
		Запрос.Текст = "ВЫБРАТЬ
		|	МАКСИМУМ(ЕСТЬNULL(СоответствиеНоменклатурыЕГАИС.АлкогольнаяПродукция,ЗНАЧЕНИЕ(Справочник.алкКлассификаторАлкогольнойПродукцииЕГАИС.ПустаяССылка))) КАК Номенклатура,
		|	ТаблицаТоваровВДокументе.Количество КАК Количество,
		|	ТаблицаТоваровВДокументе.НомерСтроки КАК НомерСтроки,
		|	0 КАК ИдентификаторСтроки
		|ПОМЕСТИТЬ ЗапросСЛимитами
		|ИЗ
		|	Документ.РеализацияТоваровУслуг.Товары КАК ТаблицаТоваровВДокументе
		|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.алкСоответствияАлкогольнойПродукцииЕГАИСИНоменклатуры КАК СоответствиеНоменклатурыЕГАИС
		|		ПО СоответствиеНоменклатурыЕГАИС.Номенклатура = ТаблицаТоваровВДокументе.Номенклатура
		|ГДЕ
		|	ТаблицаТоваровВДокументе.Ссылка = &ИсходноеЗадание
		|СГРУППИРОВАТЬ ПО
		|	ТаблицаТоваровВДокументе.Номенклатура,
		|	ТаблицаТоваровВДокументе.Количество,
		|	ТаблицаТоваровВДокументе.НомерСтроки,
		|	0
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура
		|;
		|///////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура КАК Номенклатура,
		|	СУММА(ДатаМобайл_ДокументыТСДСобранныеДанные.Количество) КАК Количество
		|ПОМЕСТИТЬ РезервыТСД
		|ИЗ
		|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанные
		|ГДЕ
		|	ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка <> &Ссылка
		|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.Шаблон.РезервироватьТовар
		|	И ДатаМобайл_ДокументыТСДСобранныеДанные.Ссылка.ДатаЗавершения = ДАТАВРЕМЯ(1, 1, 1)
		|	
		|СГРУППИРОВАТЬ ПО
		|	ДатаМобайл_ДокументыТСДСобранныеДанные.Номенклатура
		|
		|ИНДЕКСИРОВАТЬ ПО
		|	Номенклатура
		|;
		|///////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ЗапросСЛимитами.Номенклатура,
		|	ЗапросСЛимитами.Количество КАК Количество,
		|   СУММА(ЕСТЬNULL(ТоварыНаСкладахОстатки.ВНаличииОстаток, 0) - ЕСТЬNULL(РезервыТСД.Количество, 0)) КАК Лимит,
		|	ЗапросСЛимитами.НомерСтроки КАК НомерСтроки,
		|	ЗапросСЛимитами.ИдентификаторСтроки КАК ИдентификаторСтроки
		|ИЗ
		|	ЗапросСЛимитами КАК ЗапросСЛимитами
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыНаСкладах.Остатки(
		|				,
		|				&ВсеСклады
		|					ИЛИ Склад В (&Склады)) КАК ТоварыНаСкладахОстатки
		|		ПО ЗапросСЛимитами.Номенклатура = ТоварыНаСкладахОстатки.Номенклатура
		|		ЛЕВОЕ СОЕДИНЕНИЕ РезервыТСД КАК РезервыТСД
		|		ПО ЗапросСЛимитами.Номенклатура = РезервыТСД.Номенклатура
		|
		|СГРУППИРОВАТЬ ПО
		|	ЗапросСЛимитами.Номенклатура,
		|	ЗапросСЛимитами.Количество,
		|	ЗапросСЛимитами.НомерСтроки,
		|	ЗапросСЛимитами.ИдентификаторСтроки
		|
		|УПОРЯДОЧИТЬ ПО
		|	НомерСтроки";		
	КонецЕсли;	
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаНаДок);
	Запрос.УстановитьПараметр("ИсходноеЗадание", СсылкаНаДок.ИсходныйДокумент);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".алкТоварноТранспортнаяНакладнаяЕГАИС.", "." + ВидДокумента + ".");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".ПриходныйОрдерНаТовары.", "." + ВидДокумента + ".");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".РеализацияТоваровУслуг.", "." + ВидДокумента + ".");
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".Товары КАК ", "." + Шаблон.ИмяТабличнойЧастиПодбор + " КАК ");
	СписокСкладов = УзелПО.Склады.ВыгрузитьКолонку("Склад");
	
	Если ЗначениеЗаполнено(СсылкаНаДок.Склад) Тогда	
		СписокСкладов.Очистить();
		СписокСкладов.Добавить(СсылкаНаДок.Склад);			
	КонецЕсли;	
	Запрос.УстановитьПараметр("Склады", СписокСкладов);
	Запрос.УстановитьПараметр("ВсеСклады", СписокСкладов.Количество() = 0);
	
	МетаданныеИсходныйДокумент = СсылкаНаДок.ИсходныйДокумент.Метаданные();
	
	Попытка
		ЕстьТЧМарок = МетаданныеИсходныйДокумент.ТабличныеЧасти.Найти("АкцизныеМарки") <> Неопределено;
		ЕстьРеквизитИдентификаторСтроки = МетаданныеИсходныйДокумент.ТабличныеЧасти[Шаблон.ИмяТабличнойЧастиПодбор].Реквизиты.Найти("КлючСвязи") <> Неопределено;
	Исключение
		ЕстьТЧМарок = Ложь;
		ЕстьРеквизитИдентификаторСтроки = Ложь;
	КонецПопытки;
	
	Рез = Запрос.Выполнить().Выгрузить();
	
	Для каждого СтрокаДока Из Рез Цикл
		ТекущийИдентификаторСтроки = СтрокаДока.ИдентификаторСтроки;
		
		СтруктураТекущейСтроки = Новый Структура;		
		ОбъектТовара = Неопределено;
		ОбъектТовараЕГАИС = Неопределено;
		
		СписокМарок = ДатаМобайл_ОбщийМодуль.СформироватьСписокНепроверяемыхМарокЕГАИС();  
		Если СписокМарок.НайтиПоЗначению(СтрокаДока.Номенклатура.ВидПродукции) <> Неопределено Тогда
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
			лТекущаяНоменклатура = ДатаМобайл_ОбщийМодуль.ПолучитьНоменклатуруПоЕГАИС(СтрокаДока.Номенклатура);
			ОбъектТовара.id = "8U-" + XMLСтрока(лТекущаяНоменклатура) + XMLСтрока(Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
			СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
		Иначе	
			ОбъектТовара = ПолучитьСтруктуруОбъектаДляHttp("art","id");
			ОбъектТовара.id = "8e-" + XMLСтрока(СтрокаДока.Номенклатура);
			СтруктураТекущейСтроки.Вставить("art", ОбъектТовара);
			
			ОбъектТовараЕГАИС = ПолучитьСтруктуруОбъектаДляHttp("egais_art","id");
			ОбъектТовараЕГАИС.id = "8e-" + XMLСтрока(СтрокаДока.Номенклатура);
			СтруктураТекущейСтроки.Вставить("egais_art", ОбъектТовараЕГАИС);		
		КонецЕсли;	
		
		limit_qty = 0;		
		Если УзелПО.НеОтображатьОстатки Тогда
			limit_qty = 0;
		Иначе		
			Попытка
				Итог = СтрокаДока.Лимит;
				limit_qty = Итог;
			Исключение
				limit_qty = 0;
			КонецПопытки;
		КонецЕсли;	
		
		price = 0;
		
		//Марки формат 3.0
		Если ВидДокумента = "ТТНВходящаяЕГАИС" Или ВидДокумента = "астТоварноТранспортныеНакладныеИзЕГАИС" Или ВидДокумента = "алкТоварноТранспортнаяНакладнаяЕГАИС" Тогда
			КоличествоБезМарок = СтрокаДока.Количество;
			
			ЗапросМарок = Новый Запрос;
			ЗапросМарок.Текст = "ВЫБРАТЬ
			|	ЕГАИС_ТТНДанныеМарок.КодАкцизнойМарки КАК Марка,
			|	ЕГАИС_ТТНДанныеМарок.НомерКоробки КАК Короб,
			|	ЕстьNULL(ЕГАИС_ТТНДанныеУпаковок.ИерархияУпаковки,"""") КАК Палета
			|ИЗ
			|	Документ.алкТоварноТранспортнаяНакладнаяЕГАИС.АкцизныеМарки КАК ЕГАИС_ТТНДанныеМарок
			|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.алкТоварноТранспортнаяНакладнаяЕГАИС.Упаковки КАК ЕГАИС_ТТНДанныеУпаковок
			|	ПО ЕГАИС_ТТНДанныеМарок.Ссылка = ЕГАИС_ТТНДанныеУпаковок.Ссылка
			|	И ЕГАИС_ТТНДанныеМарок.НомерКоробки = ЕГАИС_ТТНДанныеУпаковок.Упаковка
			|ГДЕ
			|   ЕГАИС_ТТНДанныеМарок.Ссылка = &СсылкаТТН
			|	И ЕГАИС_ТТНДанныеМарок.КлючСвязи = &ТекущийИдентификаторСтроки";
			
			ЗапросМарок.Текст = СтрЗаменить(ЗапросМарок.Текст, ".алкТоварноТранспортнаяНакладнаяЕГАИС.", "." + ВидДокумента + ".");
			ЗапросМарок.УстановитьПараметр("СсылкаТТН", СсылкаНаДок.ИсходныйДокумент);
			ЗапросМарок.УстановитьПараметр("ТекущийИдентификаторСтроки", ТекущийИдентификаторСтроки);
			
			РезМарок = ЗапросМарок.Выполнить().Выгрузить();
			Для каждого СтрокаМарок Из РезМарок Цикл				
				Если КоличествоБезМарок > 0 Тогда					
					СтруктураТекущейСтрокиМарки = Новый Структура;
					
					Если ОбъектТовара <> Неопределено Тогда
						СтруктураТекущейСтрокиМарки.Вставить("art", ОбъектТовара);		
					КонецЕсли;
					
					Если ОбъектТовараЕГАИС <> Неопределено Тогда		
						СтруктураТекущейСтрокиМарки.Вставить("egais_art", ОбъектТовараЕГАИС);	
					КонецЕсли;
					
					qty = 1;
					
					СтруктураТекущейСтроки.Вставить("price", price);
					СтруктураТекущейСтрокиМарки.Вставить("limit_qty", limit_qty);
					СтруктураТекущейСтрокиМарки.Вставить("qty", qty);
					СтруктураТекущейСтрокиМарки.Вставить("unit_qty", qty);
					
					ОбъектЕГАИС = ПолучитьСтруктуруОбъектаДляHttp("egais");
					ОбъектЕГАИС.mark = СтрокаМарок.Марка;	
					
					Если ЗначениеЗаполнено(ОбъектЕГАИС.mark) Тогда				
						СтруктураТекущейСтрокиМарки.Вставить("egais", ОбъектЕГАИС);
					КонецЕсли;
					
					Если ЗначениеЗаполнено(СтрокаМарок.Короб) Тогда
						СтруктураТекущейСтрокиМарки.Вставить("box_pack", СтрокаМарок.Короб);
					КонецЕсли; 
					Если ЗначениеЗаполнено(СтрокаМарок.Палета) Тогда
						СтруктураТекущейСтрокиМарки.Вставить("pack", СтрокаМарок.Палета);
					КонецЕсли; 
					
					ОбъектСписка.Добавить(СтруктураТекущейСтрокиМарки); 
					
					КоличествоБезМарок = КоличествоБезМарок - 1;
				Иначе
					Продолжить;
				КонецЕсли; 
				
			КонецЦикла;
		КонецЕсли; 		
		
		Если ВидДокумента = "ТТНВходящаяЕГАИС" Или ВидДокумента = "астТоварноТранспортныеНакладныеИзЕГАИС" Или ВидДокумента = "алкТоварноТранспортнаяНакладнаяЕГАИС" Тогда	 
			Если КоличествоБезМарок > 0 Тогда
				qty = КоличествоБезМарок;
				
				СтруктураТекущейСтроки.Вставить("price", price);
				СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
				СтруктураТекущейСтроки.Вставить("qty", qty);
				СтруктураТекущейСтроки.Вставить("unit_qty", qty);
				
				ОбъектСписка.Добавить(СтруктураТекущейСтроки);
			КонецЕсли;	
		Иначе
			qty = СтрокаДока.Количество;
			
			СтруктураТекущейСтроки.Вставить("price", price);
			СтруктураТекущейСтроки.Вставить("limit_qty", limit_qty);
			СтруктураТекущейСтроки.Вставить("qty", qty);
			СтруктураТекущейСтроки.Вставить("unit_qty", qty);
			
			ОбъектСписка.Добавить(СтруктураТекущейСтроки);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры
#КонецОбласти

#Область ФункцииHTTPОтвета

// Получение структуры объекта.
//
// Параметры:
// ТекущийОбъект - Строка - наименование объекта.
// ТекущийТип - Строка - наименование типа.
// 
// Возвращаемое значение:
//   Структура.
//   
Функция ПолучитьСтруктуруОбъектаДляHttp(ТекущийОбъект, ТекущийТип = "")	
	
	Если ТекущийОбъект = "art" Тогда
		
		Если ТекущийТип = "scan" Тогда
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("id",   			"");
			СтруктураОбъекта.Вставить("name", 			""); 
			СтруктураОбъекта.Вставить("price", 			0);
			СтруктураОбъекта.Вставить("is_use_sn",    	Ложь);
			СтруктураОбъекта.Вставить("measure_type", 	0);
			СтруктураОбъекта.Вставить("mark_type",    	0);	
			СтруктураОбъекта.Вставить("attributes", 	Новый Структура);  				 	
			СтруктураОбъекта.Вставить("parent_id", 		""); 
			СтруктураОбъекта.Вставить("type", 			0);
			СтруктураОбъекта.Вставить("kit_parts", 		Новый Массив);
			
			Возврат СтруктураОбъекта;
			
		ИначеЕсли ТекущийТип = "id" Тогда
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("id",   			"");
			СтруктураОбъекта.Вставить("parent_id", 		"");
			
			Возврат СтруктураОбъекта;
			
		ИначеЕсли ТекущийТип = "id_name" Тогда
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("id",   			"");
			СтруктураОбъекта.Вставить("name", 			""); 
			СтруктураОбъекта.Вставить("parent_id", 		"");
			
			Возврат СтруктураОбъекта;
			
		Иначе
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("id",   			"");
			СтруктураОбъекта.Вставить("name", 			""); 
			СтруктураОбъекта.Вставить("price", 			0);
			СтруктураОбъекта.Вставить("is_use_sn",    	Ложь);
			СтруктураОбъекта.Вставить("measure_type", 	0);
			СтруктураОбъекта.Вставить("mark_type",    	0);	
			СтруктураОбъекта.Вставить("attributes", 	Новый Структура);  				 	
			СтруктураОбъекта.Вставить("is_deleted",   	Ложь);
			СтруктураОбъекта.Вставить("rest",         	0);
			СтруктураОбъекта.Вставить("barcodes", 		Новый Массив);
			СтруктураОбъекта.Вставить("parent_id", 		"");
			СтруктураОбъекта.Вставить("type", 			0);
			СтруктураОбъекта.Вставить("kit_parts", 		Новый Массив);
			 
			Возврат СтруктураОбъекта;
			
		КонецЕсли;
		
	ИначеЕсли ТекущийОбъект = "barcode" Тогда
		
		Если ТекущийТип = "scan" Тогда
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("unit_name",   "");
			СтруктураОбъекта.Вставить("unit_id",     "");
			СтруктураОбъекта.Вставить("unit_coef",   1);		 	
			СтруктураОбъекта.Вставить("use_sn_mode", 2);
			
			Возврат СтруктураОбъекта;
			
		ИначеЕсли ТекущийТип = "value" Тогда
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("value",       "");
			
			Возврат СтруктураОбъекта;
			
		ИначеЕсли ТекущийТип = "unit_value" Тогда
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("value",       "");
			СтруктураОбъекта.Вставить("unit_name",   "");
			СтруктураОбъекта.Вставить("unit_id",     "");
			СтруктураОбъекта.Вставить("unit_coef",   1);
			СтруктураОбъекта.Вставить("use_sn_mode", 2);
			СтруктураОбъекта.Вставить("is_deleted",  Ложь);
			
			Возврат СтруктураОбъекта;
			
		Иначе
			
			СтруктураОбъекта = Новый Структура;
			СтруктураОбъекта.Вставить("value",       "");             
			СтруктураОбъекта.Вставить("unit_name",   ""); 
			СтруктураОбъекта.Вставить("unit_id",     "");
			СтруктураОбъекта.Вставить("unit_coef",   1);
			СтруктураОбъекта.Вставить("use_sn_mode", 2);
			СтруктураОбъекта.Вставить("is_deleted",  Ложь);		  			 	
			
			Возврат СтруктураОбъекта;
			
		КонецЕсли
		
	ИначеЕсли ТекущийОбъект = "cell" Тогда
		
		Если ТекущийТип = "barcode" Тогда
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("barcode", "");
			
			Возврат СтруктураОбъекта;
			
		Иначе
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("name",    "");             
			СтруктураОбъекта.Вставить("barcode", "");
			
			Возврат СтруктураОбъекта;
			
		КонецЕсли
		
	ИначеЕсли ТекущийОбъект = "barcode_template" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("type_id",         "");
		СтруктураОбъекта.Вставить("length",          "");
		СтруктураОбъекта.Вставить("barcode_type_id", "");
		СтруктураОбъекта.Вставить("prefix",          "");
		
		Возврат СтруктураОбъекта;
		
		
	ИначеЕсли ТекущийОбъект = "user" Тогда
		
		Если ТекущийТип = "role" Тогда
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("id",      			"");
			СтруктураОбъекта.Вставить("name",      			"");
			
			СтруктураОбъекта.Вставить("permissions",  Новый Структура);
			
			Возврат СтруктураОбъекта;
			
		Иначе
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("id",      			"");
			СтруктураОбъекта.Вставить("login",            	"");             
			СтруктураОбъекта.Вставить("username", 	    	"");         
			СтруктураОбъекта.Вставить("password", 			"");		 
			СтруктураОбъекта.Вставить("is_admin", 			Ложь);		 
			СтруктураОбъекта.Вставить("is_can_edit_arts", 	Ложь);			
			
			Возврат СтруктураОбъекта;		
		КонецЕсли;
		
	ИначеЕсли ТекущийОбъект = "client" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("id",      ""); 
		СтруктураОбъекта.Вставить("name",    "");                     
		СтруктураОбъекта.Вставить("barcode", "");	
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "unit" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("id",   "");             
		СтруктураОбъекта.Вставить("name", "");
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "warehouse" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("id",   "");             
		СтруктураОбъекта.Вставить("name", "");
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "template" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("id", "");
		СтруктураОбъекта.Вставить("is_deleted", Ложь);
		СтруктураОбъекта.Вставить("name", "");
		СтруктураОбъекта.Вставить("is_allow_create_on_device", Ложь);
		СтруктураОбъекта.Вставить("is_load_arts_with_doc", Ложь);
		СтруктураОбъекта.Вставить("is_load_rows_on_open_doc", Ложь);
		СтруктураОбъекта.Вставить("is_disable_manual_change_client", Ложь);
		СтруктураОбъекта.Вставить("is_disable_reader_change_client", Ложь);
		СтруктураОбъекта.Вставить("is_reader_track_1_use", Ложь);
		СтруктураОбъекта.Вставить("is_reader_track_2_use", Ложь);
		СтруктураОбъекта.Вставить("is_reader_track_3_use", Ложь);
		СтруктураОбъекта.Вставить("pack_list_generate_mode", 0);
		СтруктураОбъекта.Вставить("is_use_barcode_templates", Ложь);
		СтруктураОбъекта.Вставить("is_use_select_log_as_insert_task", Ложь);
		СтруктураОбъекта.Вставить("unload_incorrect_doc_action", 0);
		СтруктураОбъекта.Вставить("unload_incorrect_doc_option", 0);
		СтруктураОбъекта.Вставить("is_scan_art_again", Ложь);
		СтруктураОбъекта.Вставить("is_use_all_barcodes", Истина);
		СтруктураОбъекта.Вставить("is_unload_completed_child_doc", Ложь);
		СтруктураОбъекта.Вставить("is_unload_completed_doc", Ложь);
		СтруктураОбъекта.Вставить("required_pack_qty", 0);
		СтруктураОбъекта.Вставить("is_multi_sn_logic", Ложь);
		СтруктураОбъекта.Вставить("dest_template_id",   );
		СтруктураОбъекта.Вставить("is_notify_getting_doc", Ложь);                      	
		СтруктураОбъекта.Вставить("is_manual_apply_cell", Ложь);
		СтруктураОбъекта.Вставить("is_manual_apply_art", Ложь);
		СтруктураОбъекта.Вставить("is_use_additional_forms", Ложь);
		СтруктураОбъекта.Вставить("is_update_forms_from_server", Ложь);
		СтруктураОбъекта.Вставить("is_can_skip_pack", Ложь);
		СтруктураОбъекта.Вставить("is_get_sn_list_from_server", Ложь);
		СтруктураОбъекта.Вставить("is_delete_left_task_qty", Ложь);
		СтруктураОбъекта.Вставить("new_art_action", 0);
		СтруктураОбъекта.Вставить("is_multi_doc", Ложь);	
		СтруктураОбъекта.Вставить("is_from_select_to_insert_art_by_art", Ложь);
		СтруктураОбъекта.Вставить("unique_barcode_mode", 0);
		СтруктураОбъекта.Вставить("multi_doc_timeout", 0);
		СтруктураОбъекта.Вставить("is_play_multi_doc_sound", Ложь);
		СтруктураОбъекта.Вставить("is_use_online_arts_catalog", Ложь); 
		СтруктураОбъекта.Вставить("is_unload_completed_doc", Ложь);
		СтруктураОбъекта.Вставить("is_unload_completed_child_doc", Ложь);
		СтруктураОбъекта.Вставить("is_use_second_warehouse", Ложь);
		СтруктураОбъекта.Вставить("is_get_sn_list_from_server", Ложь);
		СтруктураОбъекта.Вставить("is_multi_sn_logic", Ложь);
		СтруктураОбъекта.Вставить("search_barcode_priority", 0);
		СтруктураОбъекта.Вставить("process_id", 0);		 
		СтруктураОбъекта.Вставить("description", "");
		СтруктураОбъекта.Вставить("additional_forms_for_art_mode", 0);
		СтруктураОбъекта.Вставить("is_check_unit_task", Ложь);
		СтруктураОбъекта.Вставить("is_load_doc_logs", Ложь);	
		СтруктураОбъекта.Вставить("online_arts_catalog", 0);
		СтруктураОбъекта.Вставить("create_mode", 0);
		СтруктураОбъекта.Вставить("is_warehouse_required", Ложь);
		СтруктураОбъекта.Вставить("is_client_required", Ложь);
		СтруктураОбъекта.Вставить("selective_check_pack_mode", 0);
		СтруктураОбъекта.Вставить("is_disable_manual_change_warehouse", Ложь);
		СтруктураОбъекта.Вставить("is_check_unit_task", Ложь);
		СтруктураОбъекта.Вставить("is_group_selection_forms", Истина);
		СтруктураОбъекта.Вставить("is_check_remaining_expiration_date", Ложь);
		
		СтруктураПодбор = Новый Структура;
		
		СтруктураПодбор.Вставить("is_use_operation", Ложь);
		СтруктураПодбор.Вставить("art_scan_action", 1);
		СтруктураПодбор.Вставить("task_exceed_action", 0);
		СтруктураПодбор.Вставить("limit_exceed_action", 0);
		СтруктураПодбор.Вставить("use_cell_mode", 0);
		СтруктураПодбор.Вставить("use_sn_mode", 0);
		СтруктураПодбор.Вставить("use_pack_mode", 0);
		СтруктураПодбор.Вставить("is_check_cell_by_task", Ложь);
		СтруктураПодбор.Вставить("is_check_sn_by_task", Ложь);
		СтруктураПодбор.Вставить("is_manual_quantity", Ложь);
		СтруктураПодбор.Вставить("is_enter_to_commit", Ложь);          		
		СтруктураПодбор.Вставить("is_send_row_to_server", Ложь);
		СтруктураПодбор.Вставить("print_label_mode", 0);
		СтруктураПодбор.Вставить("enter_cell_type", 0);
		СтруктураПодбор.Вставить("is_get_cells_from_server", Ложь);
		СтруктураПодбор.Вставить("is_use_unique_sn", Ложь);
		СтруктураПодбор.Вставить("is_use_photo_fixation", Ложь);
		СтруктураПодбор.Вставить("use_tare_mode", 0);
		СтруктураПодбор.Вставить("is_handle_whole_tare", Ложь);
		СтруктураПодбор.Вставить("is_handle_whole_cell", Ложь);
		СтруктураПодбор.Вставить("is_require_enter_sn", Ложь);
		СтруктураПодбор.Вставить("sn_data_type", 0);
		СтруктураПодбор.Вставить("is_check_pack_by_task", Ложь);
		СтруктураПодбор.Вставить("is_verify_pack_on_server", Ложь);
		СтруктураПодбор.Вставить("use_kit_mode", 0);
		СтруктураПодбор.Вставить("group_cell_type", 0);
		СтруктураПодбор.Вставить("group_sn_type", 0);
		
		СтруктураПриемка = Новый Структура;
		
		СтруктураПриемка.Вставить("is_use_operation", Ложь);
		СтруктураПриемка.Вставить("art_scan_action", 1);
		СтруктураПриемка.Вставить("task_exceed_action", 0);
		СтруктураПриемка.Вставить("limit_exceed_action", 0);
		СтруктураПриемка.Вставить("use_cell_mode", 0);
		СтруктураПриемка.Вставить("use_sn_mode", 0);
		СтруктураПриемка.Вставить("use_pack_mode", 0);
		СтруктураПриемка.Вставить("is_check_cell_by_task", Ложь);
		СтруктураПриемка.Вставить("is_check_sn_by_task", Ложь);
		СтруктураПриемка.Вставить("is_manual_quantity", Ложь);
		СтруктураПриемка.Вставить("is_enter_to_commit", Ложь);          		
		СтруктураПриемка.Вставить("is_send_row_to_server", Ложь);
		СтруктураПриемка.Вставить("print_label_mode", 0);
		СтруктураПриемка.Вставить("enter_cell_type", 0);
		СтруктураПриемка.Вставить("is_get_cells_from_server", Ложь);
		СтруктураПриемка.Вставить("is_use_unique_sn", Ложь);
		СтруктураПриемка.Вставить("is_use_photo_fixation", Ложь);
		СтруктураПриемка.Вставить("use_tare_mode", 0);
		СтруктураПриемка.Вставить("is_handle_whole_tare", Ложь);
		СтруктураПриемка.Вставить("is_handle_whole_cell", Ложь);
		СтруктураПриемка.Вставить("is_require_enter_sn", Ложь);
		СтруктураПриемка.Вставить("sn_data_type", 0);
		СтруктураПриемка.Вставить("is_check_pack_by_task", Ложь);
		СтруктураПриемка.Вставить("is_verify_pack_on_server", Ложь);
		СтруктураПриемка.Вставить("use_kit_mode", 0);
		СтруктураПриемка.Вставить("group_cell_type", 0);
		СтруктураПриемка.Вставить("group_sn_type", 0);
				
		СтруктураЕГАИС = Новый Структура;
		
		СтруктураЕГАИС.Вставить("is_egais_doc", Ложь);
		СтруктураЕГАИС.Вставить("enter_data_matrix_mode", 0);
		СтруктураЕГАИС.Вставить("is_use_bottling_date", Ложь);
		СтруктураЕГАИС.Вставить("is_compare", Ложь);
		СтруктураЕГАИС.Вставить("enter_pdf417_barcode_mode", 0);
		СтруктураЕГАИС.Вставить("is_check_mark_on_server", Ложь);
		СтруктураЕГАИС.Вставить("version", 0);
		СтруктураЕГАИС.Вставить("is_use_blank_a", Ложь);
		СтруктураЕГАИС.Вставить("is_use_blank_b", Ложь);
		СтруктураЕГАИС.Вставить("is_get_bottling_date_from_server", Ложь);
		
		СтруктураМаркировка = Новый Структура;
		
		СтруктураМаркировка.Вставить("is_marking_doc", Ложь);
		СтруктураМаркировка.Вставить("check_task_mode", 0);
		СтруктураМаркировка.Вставить("is_ean_equals_gtin", Ложь);
		СтруктураМаркировка.Вставить("is_ignore_art_mismatch_by_ean_km", Ложь);
		СтруктураМаркировка.Вставить("ean_scan_type", 0);
		СтруктураМаркировка.Вставить("is_search_by_km", Ложь);
		СтруктураМаркировка.Вставить("is_only_mark_art", Ложь);
		СтруктураМаркировка.Вставить("without_km_enter_type", 0);
		СтруктураМаркировка.Вставить("check_km_owner_action", 0);
		СтруктураМаркировка.Вставить("check_km_status_action", 0);
		СтруктураМаркировка.Вставить("is_use_sn", false);
		СтруктураМаркировка.Вставить("is_allow_qty", Ложь);
		СтруктураМаркировка.Вставить("sn_source", 0);
		СтруктураМаркировка.Вставить("check_ki_source", 0);
		СтруктураМаркировка.Вставить("use_osu_mode", 0);
		
		СтруктураИзбранныеДействия = Новый Структура;
		
		СтруктураИзбранныеДействия.Вставить("operation", 0);
		
		СтруктураОбъекта.Вставить("select",  	СтруктураПодбор);			
		СтруктураОбъекта.Вставить("insert",  	СтруктураПриемка);
		СтруктураОбъекта.Вставить("egais",   	СтруктураЕГАИС);
		СтруктураОбъекта.Вставить("marking", 	СтруктураМаркировка);
		СтруктураОбъекта.Вставить("favorite", 	СтруктураИзбранныеДействия);
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "doc" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("id",  		    "");             
		СтруктураОбъекта.Вставить("number",        	"");
		СтруктураОбъекта.Вставить("date", 	        "");
		СтруктураОбъекта.Вставить("comment",	    "");
		СтруктураОбъекта.Вставить("barcode", 	    "");
		СтруктураОбъекта.Вставить("is_deleted",    	Ложь);
		СтруктураОбъекта.Вставить("is_loaded",     	Ложь);
		СтруктураОбъекта.Вставить("is_parent",     	Ложь);		
		СтруктураОбъекта.Вставить("is_finished",   	Ложь);
		СтруктураОбъекта.Вставить("parent_doc_id", 	"");
		СтруктураОбъекта.Вставить("priority",     	0);
		СтруктураОбъекта.Вставить("inn",           	"");		
		СтруктураОбъекта.Вставить("date_timestamp", 0);
		СтруктураОбъекта.Вставить("attributes",     Новый Массив);
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "image" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("id",     "");            
		СтруктураОбъекта.Вставить("art_id", "");       
		СтруктураОбъекта.Вставить("data",   1);		  
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "egais_art" Тогда
		
		Если ТекущийТип = "id" Тогда
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("id", 					"");
			
			Возврат СтруктураОбъекта;
			
		Иначе
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("id", 					"");
			СтруктураОбъекта.Вставить("name", 				 	"");            
			СтруктураОбъекта.Вставить("alcocode", 			 	"");
			СтруктураОбъекта.Вставить("percent_alco", 		 	0);
			СтруктураОбъекта.Вставить("type_alco", 			 	0);			  	
			СтруктураОбъекта.Вставить("capacity", 			 	0);		  			 	
			СтруктураОбъекта.Вставить("importer", 			 	"");
			СтруктураОбъекта.Вставить("manufacturer", 		 	"");
			СтруктураОбъекта.Вставить("is_compared",     	    Ложь);
			СтруктураОбъекта.Вставить("box_coef", 			 	0);	
			
			Возврат СтруктураОбъекта;
			
		КонецЕсли;
		
	ИначеЕсли ТекущийОбъект = "egais_art_mark" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("art_id", ""); 
		СтруктураОбъекта.Вставить("mark",   "");		  	
		СтруктураОбъекта.Вставить("box",    "");
		СтруктураОбъекта.Вставить("pallet", "");
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "egais" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("mark",          "");		 	
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "art_mark" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("art_id", "");
		СтруктураОбъекта.Вставить("mark",   "");
		СтруктураОбъекта.Вставить("box",    "");         	  			  
		СтруктураОбъекта.Вставить("pallet", "");
		СтруктураОбъекта.Вставить("coef",   1);	
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "marking" Тогда
		
		Если ТекущийТип = "logs" Тогда
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("mark", 			"");
			СтруктураОбъекта.Вставить("gtin", 			"");
			СтруктураОбъекта.Вставить("raw_mrc", 		"");
			СтруктураОбъекта.Вставить("decoded_mrc", 	"");
			СтруктураОбъекта.Вставить("tnvd", 			"");
			
			Возврат СтруктураОбъекта;
			
		Иначе
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("mark", 		"");
			
			Возврат СтруктураОбъекта;
			
		КонецЕсли;
		
	ИначеЕсли ТекущийОбъект = "doc_form" Тогда
		
		Если ТекущийТип = "doc" Тогда
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("id"              , "");             
			СтруктураОбъекта.Вставить("doc_id"          , ""); 
			СтруктураОбъекта.Вставить("attribute_number", 0);
			СтруктураОбъекта.Вставить("is_check_by_task", Ложь);	
			СтруктураОбъекта.Вставить("enter_mode"      , 0);
			СтруктураОбъекта.Вставить("is_required"     , Ложь);		  
			СтруктураОбъекта.Вставить("form_type"       , 0);	
			СтруктураОбъекта.Вставить("operation_type"  , 0);
			
			Возврат СтруктураОбъекта;
			
		Иначе
			
			СтруктураОбъекта = Новый Структура;
			
			СтруктураОбъекта.Вставить("id"              , "");                   
			СтруктураОбъекта.Вставить("template_id"     , "");
			СтруктураОбъекта.Вставить("attribute_number", 0);
			СтруктураОбъекта.Вставить("is_check_by_task", Ложь);	
			СтруктураОбъекта.Вставить("enter_mode"      , 0);
			СтруктураОбъекта.Вставить("is_required"     , Ложь);		  
			СтруктураОбъекта.Вставить("form_type"       , 0);			 	
			СтруктураОбъекта.Вставить("operation_type"  , 0);
			
			Возврат СтруктураОбъекта;
			
		КонецЕсли;
		
	ИначеЕсли ТекущийОбъект = "step" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("id",          "");             
		СтруктураОбъекта.Вставить("name",        "");         
		СтруктураОбъекта.Вставить("type",        0);		  	
		СтруктураОбъекта.Вставить("parent_id",   "");
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "form_content" Тогда
		
		СтруктураОбъекта = Новый Структура;
		
		СтруктураОбъекта.Вставить("id",      "");             
		СтруктураОбъекта.Вставить("name",    "");         
		СтруктураОбъекта.Вставить("form_id", 1);		  	
		СтруктураОбъекта.Вставить("barcode", "");
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "attribute" Тогда
		
		СтруктураОбъекта = Новый Структура;
		СтруктураОбъекта.Вставить("number",      0);             
		СтруктураОбъекта.Вставить("form_id",    "");         
		СтруктураОбъекта.Вставить("value",      "");		  	
		СтруктураОбъекта.Вставить("value_name", "");
		
		Возврат СтруктураОбъекта; 
		
	ИначеЕсли ТекущийОбъект = "additional_prices" Тогда
		
		СтруктураОбъекта = Новый Структура;
		СтруктураОбъекта.Вставить("price_1", 0);             
		СтруктураОбъекта.Вставить("price_2", 0);         
		СтруктураОбъекта.Вставить("price_3", 0);		  	
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "prices_names" Тогда
		
		СтруктураОбъекта = Новый Структура;
		СтруктураОбъекта.Вставить("price_1", "");             
		СтруктураОбъекта.Вставить("price_2", "");         
		СтруктураОбъекта.Вставить("price_3", "");		  	
		
		Возврат СтруктураОбъекта;
		
	ИначеЕсли ТекущийОбъект = "kit" Тогда
		 
		 СтруктураОбъекта = Новый Структура;
		 СтруктураОбъекта.Вставить("art_id",    "");             
         СтруктураОбъекта.Вставить("qty", 		0);
		 
		 Возврат СтруктураОбъекта;	
		
	КонецЕсли;
	
КонецФункции

// Подготовка ответа в формате JSON.
//
// Параметры:
// СтруктураДанных - Структура - данные для ответа на ПО.
// СтруктураОписанияОшибки - Структура - информация об ошибке. 
// ContentType - Строка - служебный параметр.
// 
// Возвращаемое значение:
//   Структура.
// 
Функция ПодготовитьОтветJSON(СтруктураДанных = Неопределено, СтруктураОписанияОшибки = Неопределено, ContentType = Неопределено)
		
	Ответ = Новый Структура;
	
	Если СтруктураДанных <> Неопределено Тогда 
		Ответ.Вставить("Result", СтруктураДанных);
	КонецЕсли;
	
	Если СтруктураОписанияОшибки <> Неопределено Тогда 
		Ответ.Вставить("description", СтруктураОписанияОшибки.Описание);
	КонецЕсли;
	
	Если ContentType <> Неопределено Тогда 
		Ответ.Вставить("ContentType", ContentType);
	КонецЕсли;
	
	Возврат Ответ;
	
КонецФункции

#КонецОбласти

#Область ДопФормы_Атрибуты

// Получение параметров задания по шаблону.
//
// Параметры:
//
// ДокТСД - ПланОбменаСсылка.ДатаМобайл_СписокТСД - Ссылка на ТСД.
//
// Возвращаемое значение:
// Структура параметров задания.
//  
Функция ПолучитьПараметрыЗаданияПоШаблону(ДокТСД)
	
	Результат = Новый Структура("Документ,ИмяДокумента,ИмяТабЧастиПодбор,ИмяТабЧастиПриемка");
	
	Шаблон = ДокТСД.Шаблон; 
	
	Если Не Шаблон.ВидДокументаНового = "" Тогда
		Результат.Вставить("Документ"           , ДокТСД.НовыйДокумент);
		Результат.Вставить("ИмяДокумента"       , Шаблон.ВидДокументаНового);
		Результат.Вставить("ИмяТабЧастиПодбор"  , Шаблон.ИмяТабличнойЧастиНовойПодбор);
		Результат.Вставить("ИмяТабЧастиПриемка" , Шаблон.ИмяТабличнойЧастиНовойПриемка);
		Результат.Вставить("ИмяДокументаИсх"    , Шаблон.ВидДокумента);
		Результат.Вставить("ДокументИсх"        , ДокТСД.ИсходныйДокумент);
	Иначе
		Результат.Вставить("Документ"           , ДокТСД.ИсходныйДокумент);
		Результат.Вставить("ИмяДокумента"       , Шаблон.ВидДокумента);
		Результат.Вставить("ИмяТабЧастиПодбор"  , Шаблон.ИмяТабличнойЧастиПодбор);
		Результат.Вставить("ИмяТабЧастиПриемка" , Шаблон.ИмяТабличнойЧастиПриемка);
	КонецЕсли; 
	
	Возврат Результат;
	
КонецФункции

// Получение атрибутов шапки документа.
//
// Параметры:
//
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон.
//
// Возвращаемое значение:
// Структура атрибутов шапки документа.
// 
Функция ПолучитьАтрибутыШапкиДок(Шаблон)
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	СвязиДопФорм.Порядок КАК Порядок,
	|	СвязиДопФорм.ДополнительнаяФорма.Наименование КАК ИмяДопФормы
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СвязиДополнительныхФормИШаблонов КАК СвязиДопФорм
	|ГДЕ
	|	СвязиДопФорм.Шаблон = &Шаблон
	|	И СвязиДопФорм.РеквизитИзШапки = &ИзШапки
	|
	|УПОРЯДОЧИТЬ ПО
	|	Порядок");
	
	Запрос.УстановитьПараметр("Шаблон", Шаблон);
	Запрос.УстановитьПараметр("ИзШапки", 1);
	Выборка = Запрос.Выполнить().Выбрать();
	
	СтруктураАтрибутов = Новый Структура;
	Пока Выборка.Следующий() Цикл
		СтруктураАтрибутов.Вставить("ИмяАтрибута" + Выборка.Порядок, СокрЛП(Выборка.ИмяДопФормы));	
	КонецЦикла;	
	
	// дополнить недостающими
	Для сч = 1 По 10 Цикл
		Если СтруктураАтрибутов.Свойство("ИмяАтрибута" + сч) Тогда Продолжить; КонецЕсли;
		СтруктураАтрибутов.Вставить("ИмяАтрибута" + сч, "");
	КонецЦикла;		
	
	Возврат СтруктураАтрибутов;	
	
КонецФункции 

// Получение атрибута шапки документа.
//
// Параметры:
//
// ДокТСД - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД. 
// ИмяАтрибута - Строка - Имя атрибута.
//
// Возвращаемое значение:
// Структура атрибута шапки документа.
// 
Функция ПолучитьАтрибутШапки(ДокТСД, ИмяАтрибута)
	
	Результат = Новый Структура("form_id,value,value_name");
	
	// проверка на заполнение
	Если Не ЗначениеЗаполнено(ДокТСД) Тогда Возврат Результат; КонецЕсли;
	Если Не ЗначениеЗаполнено(ИмяАтрибута) Тогда Возврат Результат; КонецЕсли;
	
	ПараметрыЗадания = ПолучитьПараметрыЗаданияПоШаблону(ДокТСД);
	
	ДокЗадания   = ПараметрыЗадания.Документ;
	
	Если ПараметрыЗадания.Свойство("ДокументИсх") Тогда
		ДокЗадания = ПараметрыЗадания.ДокументИсх;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ДокЗадания) Тогда Возврат Результат; КонецЕсли;
	
	// получение имени реквизита шапки документа
	ИмяРеквизита = "";
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА (ВЫРАЗИТЬ(СвязиДопФорм.Шаблон.ВидДокументаНового КАК СТРОКА(100))) = """"
	|			ТОГДА СвязиДопФорм.ЗаполняемыйРеквизит
	|		ИНАЧЕ СвязиДопФорм.ВыгружаемыйРеквизит
	|	КОНЕЦ КАК ЗаполняемыйРеквизит,
	|	СвязиДопФорм.ДополнительнаяФорма КАК ДопФорма
	|ИЗ
	|	Справочник.ДатаМобайл_ШаблоныДокументов КАК Шаблоны
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДатаМобайл_СвязиДополнительныхФормИШаблонов КАК СвязиДопФорм
	|	ПО Шаблоны.Ссылка = СвязиДопФорм.Шаблон
	|ГДЕ
	|	Шаблоны.Ссылка = &Шаблон
	|	И Шаблоны.ИспользоватьДопФормы
	|	И СвязиДопФорм.РеквизитИзШапки = 1
	|	И СвязиДопФорм.РежимВвода = 0
	|	И СвязиДопФорм.ДополнительнаяФорма.Наименование = &Наименование");
	Запрос.УстановитьПараметр("Наименование", ИмяАтрибута);
	Запрос.УстановитьПараметр("Шаблон", ДокТСД.Шаблон);
	
	Выборка = Запрос.Выполнить().Выбрать();	
	Если Не Выборка.Следующий() Тогда Возврат Результат; КонецЕсли;
	
	ИмяРеквизита = СокрЛП(Выборка.ЗаполняемыйРеквизит);	
	Результат.Вставить("form_id", XMLСтрока(Выборка.ДопФорма));		
	
	Если Не ЗначениеЗаполнено(ИмяРеквизита) Тогда Возврат Результат; КонецЕсли;
	
	// получение значения реквизита
	ИмяДокумента = ПараметрыЗадания.ИмяДокумента; 
	
	Если ПараметрыЗадания.Свойство("ИмяДокументаИсх") Тогда
		ИмяДокумента = ПараметрыЗадания.ИмяДокументаИсх;
	КонецЕсли;
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	Док.Номер КАК ЗначениеРеквизита
	|ИЗ
	|	Документ.ЗаказКлиента КАК Док
	|ГДЕ
	|	Док.Ссылка = &Ссылка");
	Запрос.УстановитьПараметр("Ссылка", ДокЗадания);
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "Номер", ИмяРеквизита);
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ЗаказКлиента", ИмяДокумента);
	
	Попытка
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Следующий() Тогда
			ЗначениеРеквизита = Выборка.ЗначениеРеквизита;
			ПолучитьАтрибутыЗначенияРеквизита(Результат, ЗначениеРеквизита);
		КонецЕсли;
	Исключение
		Возврат Результат;
	КонецПопытки; 	
	
	Возврат Результат;
	
КонецФункции

// Получение номера атрибута для доп. формы.
//
// Параметры:
//
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон. 
// ДополнительнаяФорма - СправочникСсылка.ДатаМобайл_ДополнительныеФормы - Доп. форма.
// ИзШапки - Число - Из шапки.
//
// Возвращаемое значение:
// Число со значением номера атрибута.
// 
Функция ПолучитьНомерАтрибутаДляДопФормы(Шаблон, ДополнительнаяФорма, ИзШапки)
	
	Результат = 0;
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	СвязиДопФорм.Порядок КАК Порядок
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СвязиДополнительныхФормИШаблонов КАК СвязиДопФорм
	|ГДЕ
	|	СвязиДопФорм.Шаблон = &Шаблон
	|	И СвязиДопФорм.ДополнительнаяФорма = &ДопФорма
	|	И СвязиДопФорм.РеквизитИзШапки = &ИзШапки
	|
	|УПОРЯДОЧИТЬ ПО
	|	Порядок");
	
	Запрос.УстановитьПараметр("Шаблон", Шаблон);
	Запрос.УстановитьПараметр("ИзШапки", ИзШапки);
	Запрос.УстановитьПараметр("ДопФорма", ДополнительнаяФорма); 
	Запрос.УстановитьПараметр("ВсеФормы", ?(ИзШапки = 1 Или ИзШапки = 0, Ложь, Истина));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Если Выборка.Порядок > 10 Тогда
			Результат = 0;
		Иначе
			Результат = Выборка.Порядок;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Получение атрибутов строки документа.
//
// Параметры:
//
// ДокТСД - СправочникСсылка.ДатаМобайл_ДокументыТСД - Документ ТСД. 
// СтрокаТЧ - ВыборкаИзРезультатаЗапроса - Строка выборки.
// Подбор - Булево - Подбор.
// СтруктураПоиска - Структура - Структура поиска.
//
// Возвращаемое значение:
// Массив атрибутов строки документа.
// 
Функция ПолучитьАтрибутыСтрокиДокумента(ДокТСД, СтрокаТЧ, Подбор = Истина, СтруктураПоиска = Неопределено)
	
	СписокАтрибутов = Новый Массив;
	
	ПараметрыЗадания = ПолучитьПараметрыЗаданияПоШаблону(ДокТСД);
	ДокЗадания   = ПараметрыЗадания.Документ;
	
	Если ПараметрыЗадания.Свойство("ДокументИсх") Тогда
		ДокЗадания = ПараметрыЗадания.ДокументИсх;
	КонецЕсли; 
	
	Если Не ЗначениеЗаполнено(ДокЗадания) Тогда Возврат СписокАтрибутов; КонецЕсли;
	
	Если Подбор Тогда
		ИмяТабЧасти = ПараметрыЗадания.ИмяТабЧастиПодбор;
	Иначе
		ИмяТабЧасти = ПараметрыЗадания.ИмяТабЧастиПриемка;
	КонецЕсли;	
	
	// есть ли доп формы для данного шаблона
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ВЫБОР
	|		КОГДА (ВЫРАЗИТЬ(ДопФормы.Шаблон.ВидДокументаНового КАК СТРОКА(100))) = """"
	|			ТОГДА ДопФормы.ЗаполняемыйРеквизит
	|		ИНАЧЕ ДопФормы.ВыгружаемыйРеквизит
	|	КОНЕЦ КАК ЗаполняемыйРеквизит,
	|	ДопФормы.ДополнительнаяФорма КАК ДопФорма
	|ИЗ 
	|	Справочник.ДатаМобайл_ШаблоныДокументов КАК Шаблоны
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ДатаМобайл_СвязиДополнительныхФормИШаблонов КАК ДопФормы 
	|	ПО Шаблоны.Ссылка = ДопФормы.Шаблон
	|ГДЕ
	|	Шаблоны.Ссылка = &Шаблон
	|	И Шаблоны.ИспользоватьДопФормы
	|	И ДопФормы.РеквизитИзШапки = 0
	|	И НЕ ДопФормы.РежимВвода = 1
	|	И ДопФормы.ПодборРазмещение = &ПодборРазмещение
	|
	|УПОРЯДОЧИТЬ ПО
	|	ДопФормы.Порядок");
	Запрос.УстановитьПараметр("Шаблон"          , ДокТСД.Шаблон);
	Запрос.УстановитьПараметр("ПодборРазмещение", ?(Подбор, 0, 1));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда Возврат СписокАтрибутов; КонецЕсли;
	
	// получим строку документа
	СтруктураПоискаВТЧ = ПолучитьСтруктуруПоискаСтрокиДокумента(СтрокаТЧ, СтруктураПоиска);
	
	Попытка 
		ИндексСтр = СтрокаТЧ.НомерСтроки - 1;
		НужнаяСтрока = ДокЗадания[ИмяТабЧасти][ИндексСтр];
	Исключение 
		НайдСтроки = ДокЗадания[ИмяТабЧасти].НайтиСтроки(СтруктураПоискаВТЧ);
		Если НайдСтроки.Количество() = 0 Тогда Возврат СписокАтрибутов; КонецЕсли;
		
		НужнаяСтрока = НайдСтроки[0];
	КонецПопытки; 	
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		НомерАтрибута = ПолучитьНомерАтрибутаДляДопФормы(ДокТСД.Шаблон, Выборка.ДопФорма, 0);
		Если НомерАтрибута = 0 Тогда Продолжить; КонецЕсли;
		
		ОбъектАтрибуты = ПолучитьСтруктуруОбъектаДляHttp("attribute");
		ОбъектАтрибуты.Вставить("number", НомерАтрибута);
		ОбъектАтрибуты.Вставить("form_id", XMLСтрока(Выборка.ДопФорма));
		
		// значение реквизита строки
		ИмяРеквизита = Выборка.ЗаполняемыйРеквизит;
		ЗначениеРеквизита = НужнаяСтрока[ИмяРеквизита];		
		ПолучитьАтрибутыЗначенияРеквизита(ОбъектАтрибуты, ЗначениеРеквизита);		
		
		СписокАтрибутов.Добавить(ОбъектАтрибуты);
	КонецЦикла;
	
	Возврат СписокАтрибутов;
	
КонецФункции

// Получение атрибутов значения реквизита.
//
// Параметры:
//
// ОбъектАтрибуты - Структура - Структура данных атрибутов объекта. 
// ЗначениеРеквизита - Любой - Значение реквизита.
//
// Возвращаемое значение:
// Структура атрибутов значения реквизита.
//  
Процедура ПолучитьАтрибутыЗначенияРеквизита(ОбъектАтрибуты, ЗначениеРеквизита)
	
	Если ТипЗнч(ЗначениеРеквизита) = Тип("Строка") Тогда
		ОбъектАтрибуты.Вставить("value", СокрЛП(ЗначениеРеквизита));
		ОбъектАтрибуты.Вставить("value_name", ОбъектАтрибуты.value);
		
	ИначеЕсли ТипЗнч(ЗначениеРеквизита) = Тип("Число") Тогда
		ОбъектАтрибуты.Вставить("value", Формат(ЗначениеРеквизита, "ЧРД=.; ЧГ=0"));
		ОбъектАтрибуты.Вставить("value_name", ОбъектАтрибуты.value);
		
	ИначеЕсли ТипЗнч(ЗначениеРеквизита) = Тип("Дата") Тогда
		ОбъектАтрибуты.Вставить("value", Формат(ЗначениеРеквизита, "ДФ=dd.MM.yyyy"));
		ОбъектАтрибуты.Вставить("value_name", ОбъектАтрибуты.value);
		
	ИначеЕсли ТипЗнч(ЗначениеРеквизита) = Тип("Булево") Тогда 
		ОбъектАтрибуты.Вставить("value", Формат(ЗначениеРеквизита, "БЛ=false; БИ=true"));
		ОбъектАтрибуты.Вставить("value_name", Формат(ЗначениеРеквизита, "БЛ=Нет; БИ=Да"));
		
	Иначе
		Если ЗначениеЗаполнено(ЗначениеРеквизита) Тогда
			ОбъектАтрибуты.Вставить("value", XMLСтрока(ЗначениеРеквизита));
			
			ИмяМета = ЗначениеРеквизита.Метаданные().Имя;				
			Если Не Метаданные.Перечисления.Найти(ИмяМета) = Неопределено И ТипЗнч(ЗначениеРеквизита) = Тип("ПеречислениеСсылка." + ИмяМета) Тогда
				ОбъектАтрибуты.Вставить("value_name", Строка(ЗначениеРеквизита)); 
			Иначе
				Попытка
					ОбъектАтрибуты.Вставить("value_name", СокрЛП(ЗначениеРеквизита.Наименование));
				Исключение КонецПопытки;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Получение структуры поиска строки документа.
//
// Параметры:
//
// СтрокаТЧ - ВыборкаИзРезультатаЗапроса - Строка выборки. 
// СтруктураПоиска - Структура - Структура поиска.
//
// Возвращаемое значение:
// Структура поиска.
// 
Функция ПолучитьСтруктуруПоискаСтрокиДокумента(СтрокаТЧ, СтруктураПоиска)
	
	Результат = Новый Структура;
	
	Если СтруктураПоиска = Неопределено Тогда
		Попытка Результат.Вставить("Номенклатура", СтрокаТЧ.Номенклатура); Исключение КонецПопытки;
		Попытка Результат.Вставить("Характеристика", СтрокаТЧ.Характеристика); Исключение КонецПопытки;
		Попытка Результат.Вставить("Серия", СтрокаТЧ.Серия); Исключение КонецПопытки;
		Попытка Результат.Вставить("Ячейка", СтрокаТЧ.Ячейка); Исключение КонецПопытки;
		Попытка Результат.Вставить("Упаковка", СтрокаТЧ.Упаковка); Исключение КонецПопытки;		
	Иначе
		Результат = СтруктураПоиска;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Получение атрибутов для групповых строк.
//
// Параметры:
//
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон. 
// ДопФорма - СправочникСсылка.ДатаМобайл_ДополнительныеФормы - Доп. форма.
// ДопФормаЗначение - Строка -Значение доп. формы.
//
// Возвращаемое значение:
// Структура атрибутов для групповых строк.
//
Функция ПолучитьАтрибутыДляГрупповыхСтрок(Шаблон, ДопФорма, ДопФормаЗначение)	
	
	НомерАтрибута = ПолучитьНомерАтрибутаДляДопФормы(Шаблон, ДопФорма, 0);
	Если НомерАтрибута = 0 Тогда 
		Возврат Неопределено; 
	КонецЕсли;		
	
	ОбъектАтрибуты = ПолучитьСтруктуруОбъектаДляHttp("attribute");
	ОбъектАтрибуты.Вставить("number" , НомерАтрибута);
	ОбъектАтрибуты.Вставить("form_id", XMLСтрока(ДопФорма));
	ОбъектАтрибуты.Вставить("value"  , СокрЛП(ДопФормаЗначение));
	
	Если ДопФорма.ТипДанных = "Текст" Или ДопФорма.ТипДанных = "Число" Или ДопФорма.ТипДанных = "Дата" Тогда
		ОбъектАтрибуты.Вставить("value_name", ОбъектАтрибуты.value);
		
	ИначеЕсли ДопФорма.ТипДанных = "Булево" Тогда
		ОбъектАтрибуты.Вставить("value_name", ?(Не СтрНайти("истина,true,да", НРег(ОбъектАтрибуты.value)) = 0, "Да", "Нет"));
	Иначе 
		ЗначениеПодстановки = "";
		
		Попытка
			Если Не Метаданные.Справочники.Найти(ДопФорма.ТипДанных) = Неопределено Тогда
				ЗначениеПодстановки = СокрЛП(Справочники[ДопФорма.ТипДанных].ПолучитьСсылку(Новый УникальныйИдентификатор(ДопФормаЗначение)).Наименование);
			ИначеЕсли Не Метаданные.ПланыВидовХарактеристик.Найти(ДопФорма.ТипДанных) = Неопределено Тогда
				ЗначениеПодстановки = СокрЛП(ПланыВидовХарактеристик[ДопФорма.ТипДанных].ПолучитьСсылку(Новый УникальныйИдентификатор(ДопФормаЗначение)).Наименование);	
			ИначеЕсли Не Метаданные.Перечисления.Найти(ДопФорма.ТипДанных) = Неопределено Тогда
				ЗначениеПодстановки = Строка(Перечисления[ДопФорма.ТипДанных][СокрЛП(ДопФормаЗначение)]);
			КонецЕсли;
		Исключение КонецПопытки;
		
		ОбъектАтрибуты.Вставить("value_name", ЗначениеПодстановки);			
	КонецЕсли;		
	
	Возврат ОбъектАтрибуты;	
	
КонецФункции	

// Получение таблицы доп. форм.
//
// Параметры:
//
// Шаблон - СправочникСсылка.ДатаМобайл_ШаблоныДокументов - Шаблон. 
// ПодборРазмещение - Число - Это подбор/размещение.
//
// Возвращаемое значение:
// Таблица значений доп. форм.
// 
Функция ПолучитьТаблицуДопФорм(Шаблон, ПодборРазмещение = 0)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СвязиДопФормИШаблонов.ЗаполняемыйРеквизит КАК ЗаполняемыйРеквизит,
	|	СвязиДопФормИШаблонов.ДополнительнаяФорма КАК ДополнительнаяФорма
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СвязиДополнительныхФормИШаблонов КАК СвязиДопФормИШаблонов
	|ГДЕ
	|	СвязиДопФормИШаблонов.Шаблон = &Шаблон
	|	И НЕ ЕСТЬNULL(СвязиДопФормИШаблонов.ЗаполняемыйРеквизит, """") = """"
	|	И СвязиДопФормИШаблонов.РеквизитИзШапки = 0
	|	И СвязиДопФормИШаблонов.ПодборРазмещение = &ПодборРазмещение
	|	И СвязиДопФормИШаблонов.ИспользоватьВПоискеСтрок";
	
	Запрос.УстановитьПараметр("Шаблон", Шаблон);
	Запрос.УстановитьПараметр("ПодборРазмещение", ПодборРазмещение);
	
	ТаблицаДопФорм = Запрос.Выполнить().Выгрузить();
	
	Возврат ТаблицаДопФорм;
	
КонецФункции

// Формирование дополнения запроса атрибутов строк.
//
// Параметры:
//
// ТаблицаДопФорм - ТаблицаЗначений - Таблица доп. форм. 
// ИмяТаблицыДанных - Строка - Имя таблицы данных.
// Алиас - Булево - Алиас. 
// Приставка - Булево - Приставка.
//
// Возвращаемое значение:
// Строка результата.
// 
Функция СформироватьДополнениеЗапросаАтрибутыСтрок(ТаблицаДопФорм, ИмяТаблицыДанных, Алиас = Истина, Приставка = Ложь, МетаданныеДокументаТабличнаяЧастьПодбор)
	
	Результат = "";	
	СтрокаНеограниченнойДлины = Ложь;
	
	Для НомПП = 0 По ТаблицаДопФорм.Количество() - 1 Цикл
		ИмяРеквизита = ТаблицаДопФорм[НомПП].ЗаполняемыйРеквизит;
		Запятая = ",";
		
		Если НомПП = ТаблицаДопФорм.Количество() - 1 Тогда
			Запятая = "";
		КонецЕсли;
				
		РеквизитДокумента = МетаданныеДокументаТабличнаяЧастьПодбор.Реквизиты.Найти(ИмяРеквизита);
		
		Если РеквизитДокумента <> Неопределено И РеквизитДокумента.Тип = Новый ОписаниеТипов("Строка", , , , Новый КвалификаторыСтроки(0)) Тогда
			СтрокаНеограниченнойДлины = Истина;	
		КонецЕсли;
		
		Если СтрокаНеограниченнойДлины Тогда
			Результат = Результат + "
			|	" + "ВЫРАЗИТЬ(" + ИмяТаблицыДанных + "." + ?(Приставка, "ДФ_", "") + ИмяРеквизита + " КАК Строка(500))" + ?(Алиас, " КАК " + "ДФ_" + ИмяРеквизита, "") + Запятая;	
		Иначе
			Результат = Результат + "
			|	" + ИмяТаблицыДанных + "." + ?(Приставка, "ДФ_", "") + ИмяРеквизита + ?(Алиас, " КАК " + "ДФ_" + ИмяРеквизита, "") + Запятая;
		КонецЕсли;
	КонецЦикла; 
	
	Если Результат = "" Тогда
		Результат = "NULL" + ?(Алиас, " КАК ДФ_Атрибут", "");
	КонецЕсли;
	
	Возврат Результат;	
	
КонецФункции

// Получение атрибутов строки из ПО.
//
// Параметры:
//
// СтруктураСтроки - Структура - Структура строки. 
// СтрокаДокумента - Структура - Строка документа.
//
Процедура ПолучитьАтрибутыСтрокиИзПО(СтруктураСтроки, СтрокаДокумента)
	
	МассивАтрибутов = Новый Массив;
	
	Попытка
		Для каждого ОбъектАтрибут Из СтрокаДокумента.attributes Цикл
			СтруктураАтрибут = Новый Структура();
			
			СтруктураАтрибут.Вставить("Документ"           , СтруктураСтроки.ДокументТСД);
			СтруктураАтрибут.Вставить("Номенклатура"       , СтруктураСтроки.Номенклатура);
			СтруктураАтрибут.Вставить("Характеристика"     , СтруктураСтроки.ХарактеристикаНоменклатуры);
			СтруктураАтрибут.Вставить("ДополнительнаяФорма", XMLЗначение(Тип("СправочникСсылка.ДатаМобайл_ДополнительныеФормы"), СокрЛП(ОбъектАтрибут.form_id)));
			СтруктураАтрибут.Вставить("ИдентификаторСтроки", Число(СокрЛП(СтрокаДокумента.row_id)));
			СтруктураАтрибут.Вставить("Значение"           , ОбъектАтрибут.value);
			
			МассивАтрибутов.Добавить(СтруктураАтрибут);
		КонецЦикла; 
	Исключение КонецПопытки;
	
	СтруктураСтроки.Вставить("Атрибуты", МассивАтрибутов);
	
КонецПроцедуры 

// Запись значений доп. форм в регистр.
//
// Параметры:
//
// СтруктураСтроки - Структура - Структура строки. 
//
Процедура ЗаписьЗначенийДопФормВРегистр(СтруктураСтроки)
	
	Если Не СтруктураСтроки.Свойство("Атрибуты") Тогда Возврат; КонецЕсли;
	
	Для каждого атр Из СтруктураСтроки.Атрибуты Цикл
		Рег = РегистрыСведений.ДатаМобайл_ЗначенияДополнительныхФорм.СоздатьМенеджерЗаписи();
		Рег.Документ            = атр.Документ;
		Рег.Номенклатура        = атр.Номенклатура;
		Рег.Характеристика      = атр.Характеристика;
		Рег.ИдентификаторСтроки = атр.ИдентификаторСтроки;
		Рег.ДополнительнаяФорма = атр.ДополнительнаяФорма;
		
		Рег.Прочитать();
		
		Если Не Рег.Выбран() Тогда
			Рег.Документ            = атр.Документ;
			Рег.Номенклатура        = атр.Номенклатура;
			Рег.Характеристика      = атр.Характеристика;
			Рег.ИдентификаторСтроки = атр.ИдентификаторСтроки;
			Рег.ДополнительнаяФорма = атр.ДополнительнаяФорма;
			Рег.Значение            = атр.Значение;
			
			Попытка
				Рег.Записать();
			Исключение КонецПопытки;
		КонецЕсли;				
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область Zolla

Функция ДМ_ПолучитьКодКороба(ДокОтбора, ТиповоййШК)
	
	Результат = ТиповоййШК;
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	ОтборРазмещениеТоваров.КР_Короб КАК УпакЛист,
	|	ЕСТЬNULL(УпаковочныйЛист.КР_Штрихкод, """") КАК Код
	|ИЗ
	|	Документ.ОтборРазмещениеТоваров КАК ОтборРазмещениеТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.УпаковочныйЛист КАК УпаковочныйЛист
	|		ПО ОтборРазмещениеТоваров.КР_Короб = УпаковочныйЛист.Ссылка
	|ГДЕ
	|	ОтборРазмещениеТоваров.Ссылка = &Ссылка
	|	И НЕ ОтборРазмещениеТоваров.КР_Короб = ЗНАЧЕНИЕ(Документ.УпаковочныйЛист.ПустаяСсылка)");
	Запрос.УстановитьПараметр("Ссылка", ДокОтбора);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Результат = Выборка.Код; 
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции 

Функция ДМ_ПолучитьСсылкуТиповогоУЛ(Pack)

	Результат = Документы.УпаковочныйЛист.ПустаяСсылка();
	
	НомерУЛ = СокрЛП(СтрЗаменить(Pack, "UPL", ""));
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	УпаковочныйЛист.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.ДатаМобайл_УпаковочныйЛист КАК ДатаМобайл_УпаковочныйЛист
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.УпаковочныйЛист КАК УпаковочныйЛист
	|		ПО ДатаМобайл_УпаковочныйЛист.ТиповойУпаковочныйЛист = УпаковочныйЛист.Ссылка
	|ГДЕ
	|	ДатаМобайл_УпаковочныйЛист.Номер = &НомерУЛ";
	
	Запрос.УстановитьПараметр("НомерУЛ", НомерУЛ);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Результат = Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции 

Функция ДМ_ЗаполнениеДокументовШаблона(ДокументТСД, УпакЛистСсылка, ТЗСобранныеДанныеПодбор) Экспорт
	
	ТекстОшибки = "";
	
	Модуль_НоменклатураСервер = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("НоменклатураСервер");
	Модуль_ОбработкаТабличнойЧастиСервер = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбработкаТабличнойЧастиСервер");
	Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
	Модуль_СкладыСервер = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("СкладыСервер"); 
	Модуль_КР_РаботаСТСД = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("КР_РаботаСТСД");
	
	СтрокаGUID = XMLСтрока(УпакЛистСсылка);
	УпакЛистОбъект = УпакЛистСсылка.ПолучитьОбъект();
	УпакЛистОбъект.КР_Штрихкод = Модуль_КР_РаботаСТСД.ПреобразоватьGUID_78(СтрокаGUID);
	
	Если ТЗСобранныеДанныеПодбор.Количество() = 0 Тогда
		ТекстОшибки = "Нет данных подбора.";
		
	Иначе		
		// ОТБОР
		СсылкаДок = Документы.ОтборРазмещениеТоваров.ПолучитьСсылку(Новый УникальныйИдентификатор(СтрокаGUID));
		ОтборОбъект = СсылкаДок.ПолучитьОбъект();
		
		Если ОтборОбъект = Неопределено Тогда
			ОтборОбъект = Документы.ОтборРазмещениеТоваров.СоздатьДокумент();
			ОтборОбъект.УстановитьСсылкуНового(СсылкаДок); 
			ОтборОбъект.УстановитьНовыйНомер();
			ОтборОбъект.Дата 		     = ТекущаяДата(); 
		Иначе
			ОтборОбъект.ПометкаУдаления  = Ложь;
			ОтборОбъект.Комментарий      = "Обновлен " + ТекущаяДата();
		КонецЕсли;
		
		ОтборОбъект.ВидОперации          = Перечисления.ВидыОперацийОтбораРазмещенияТоваров.Отбор;
		ОтборОбъект.Распоряжение         = УпакЛистОбъект.КР_ДокументОснование;
		ОтборОбъект.Склад                = УпакЛистОбъект.СкладУпаковки;
		ОтборОбъект.Статус       		 = Перечисления.СтатусыОтборовРазмещенийТоваров.ВыполненоБезОшибок; // Подготовлено;
		ОтборОбъект.КР_Короб             = УпакЛистСсылка;
		ОтборОбъект.КР_ИспользоватьКороб = Истина;  
		
		ОтборОбъект.ТоварыОтбор.Очистить();
		
		ИспользоватьСкладскиеПомещения = Модуль_СкладыСервер.ИспользоватьСкладскиеПомещения(ОтборОбъект.Склад, ОтборОбъект.Дата);
		
		Если ИспользоватьСкладскиеПомещения Тогда
			ДМ_УстановитьПомещениеПоУмолчанию(ОтборОбъект);
			ОтборОбъект.ЗонаОтгрузки = Справочники.СкладскиеЯчейки.ЗонаОтгрузкиПоУмолчанию(ОтборОбъект.Склад, ОтборОбъект.Помещение);
		КонецЕсли; 
		
		Если Не ЗначениеЗаполнено(ОтборОбъект.ЗонаОтгрузки) Тогда
			ОтборОбъект.ЗонаОтгрузки = Справочники.СкладскиеЯчейки.ЗонаОтгрузкиПоУмолчанию(ОтборОбъект.Склад, ОтборОбъект.Помещение);
		КонецЕсли;
		
		ПараметрыУказанияСерий = Новый ФиксированнаяСтруктура(Модуль_НоменклатураСервер.ПараметрыУказанияСерий(ОтборОбъект, Документы.ОтборРазмещениеТоваров));
		
		Действия = Новый Структура;
		Действия.Вставить("ПроверитьСериюРассчитатьСтатус",
		Новый Структура("Склад, ПараметрыУказанияСерий", ОтборОбъект.Склад, ПараметрыУказанияСерий.Отбор));
		Действия.Вставить("ЗаполнитьВесУпаковки",Новый Структура("Номенклатура, Упаковка", "ВесУпаковки"));
		Действия.Вставить("ЗаполнитьОбъемУпаковки",Новый Структура("Номенклатура, Упаковка", "ОбъемУпаковки"));
		
		Для каждого СтрокаПодбора Из ТЗСобранныеДанныеПодбор Цикл
			Если СтрокаПодбора.Количество = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			КоэффициентУпаковки = 1;
			
			Если ЗначениеЗаполнено(СтрокаПодбора.ЕдиницаИзмерения) Тогда
				КоэффициентУпаковки = СтрокаПодбора.ЕдиницаИзмерения.Числитель / ?(СтрокаПодбора.ЕдиницаИзмерения.Знаменатель = 0, 1, СтрокаПодбора.ЕдиницаИзмерения.Знаменатель);
			КонецЕсли;
			
			СтрокаТЧ = ОтборОбъект.ТоварыОтбор.Добавить();
			СтрокаТЧ.Номенклатура       		= СтрокаПодбора.Номенклатура;
			СтрокаТЧ.Характеристика     		= СтрокаПодбора.ХарактеристикаНоменклатуры;
			СтрокаТЧ.Упаковка           		= СтрокаПодбора.ЕдиницаИзмерения;		
			СтрокаТЧ.Серия             			= СтрокаПодбора.СерияСсылка;
			СтрокаТЧ.Ячейка             		= СтрокаПодбора.ЯчейкаСсылка;
			СтрокаТЧ.КоличествоУпаковок 		= СтрокаПодбора.Количество;
			СтрокаТЧ.Количество         		= СтрокаПодбора.Количество * КоэффициентУпаковки;
			СтрокаТЧ.КоличествоУпаковокОтобрано = СтрокаТЧ.КоличествоУпаковок;
			СтрокаТЧ.КоличествоОтобрано         = СтрокаТЧ.Количество;
			
			Модуль_ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(СтрокаТЧ, Действия, Неопределено);
			
			ОтборОбъект.ВесОтбор	= ОтборОбъект.ВесОтбор + СтрокаТЧ.ВесУпаковки * СтрокаТЧ.КоличествоУпаковокОтобрано;
			ОтборОбъект.ОбъемОтбор	= ОтборОбъект.ОбъемОтбор + СтрокаТЧ.ОбъемУпаковки * СтрокаТЧ.КоличествоУпаковокОтобрано;
		КонецЦикла;
		
		Попытка
			ОтборОбъект.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);
		Исключение 
			Попытка
				ОтборОбъект.ОбменДанными.Загрузка = Истина;
				ОтборОбъект.Записать(РежимЗаписиДокумента.Запись);
			Исключение
				ТекстОшибки = ТекстОшибки + ?(ТекстОшибки = "", "", Символы.ПС) + ОписаниеОшибки();
				Возврат ТекстОшибки;
			КонецПопытки;
		КонецПопытки;
		
		
		// ДОКУМЕНТ ТСД
		Если ЗначениеЗаполнено(ОтборОбъект.Ссылка) Тогда
			ДокТСДОбъект = ДокументТСД.ПолучитьОбъект();
			
			НайдДоки = ДокТСДОбъект.ДМ_НовыеДокументы.НайтиСтроки(Новый Структура("НовыйДокумент", ОтборОбъект.Ссылка));
			
			Если НайдДоки.Количество() = 0 Тогда
				СтрокаДок = ДокТСДОбъект.ДМ_НовыеДокументы.Добавить();
				СтрокаДок.НовыйДокумент = ОтборОбъект.Ссылка;
				
				Попытка
					ДокТСДОбъект.Записать();
				Исключение
					ТекстОшибки = ТекстОшибки + ?(ТекстОшибки = "", "", Символы.ПС) + ОписаниеОшибки();
				КонецПопытки;
			КонецЕсли;
		КонецЕсли;
		
		
		// УПАК. ЛИСТ
		УпакЛистОбъект.Товары.Очистить();
		
		ПараметрыУказанияСерий = Новый ФиксированнаяСтруктура(Модуль_НоменклатураСервер.ПараметрыУказанияСерий(УпакЛистОбъект, Документы.УпаковочныйЛист));
		
		Действия = Новый Структура;
		Действия.Вставить("ПроверитьСериюРассчитатьСтатус",
		Новый Структура("Склад, ПараметрыУказанияСерий", УпакЛистОбъект.СкладУпаковки, ПараметрыУказанияСерий));
		
		Для каждого СтрокаПодбора Из ТЗСобранныеДанныеПодбор Цикл
			Если СтрокаПодбора.Количество = 0 Тогда
				Продолжить;
			КонецЕсли;
			
			КоэффициентУпаковки = 1;
			
			Если ЗначениеЗаполнено(СтрокаПодбора.ЕдиницаИзмерения) Тогда
				КоэффициентУпаковки = СтрокаПодбора.ЕдиницаИзмерения.Числитель / ?(СтрокаПодбора.ЕдиницаИзмерения.Знаменатель = 0, 1, СтрокаПодбора.ЕдиницаИзмерения.Знаменатель);
			КонецЕсли;
			
			СтрокаТЧ = УпакЛистОбъект.Товары.Добавить();
			СтрокаТЧ.Номенклатура       = СтрокаПодбора.Номенклатура;
			СтрокаТЧ.Характеристика     = СтрокаПодбора.ХарактеристикаНоменклатуры;
			СтрокаТЧ.Упаковка           = СтрокаПодбора.ЕдиницаИзмерения;
			СтрокаТЧ.КоличествоУпаковок = СтрокаПодбора.Количество;
			СтрокаТЧ.Количество         = СтрокаПодбора.Количество * КоэффициентУпаковки;
			СтрокаТЧ.Серия              = СтрокаПодбора.СерияСсылка;
			
			Модуль_ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(СтрокаТЧ, Действия, Неопределено);
		КонецЦикла;
		
		// Для реквизита Код документа Упаковочный лист необходимо установить значение, 
		// соответствующее значению реквизита Номер созданного документа Отбор (размещение) товаров 
		// + значение года создания этого документа.
		УпакЛистОбъект.Код = СокрЛП(ОтборОбъект.Номер) + " " + Формат(ОтборОбъект.Дата, "ДФ=yyyy");
		
		Попытка
			УпакЛистОбъект.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);
		Исключение 
			Попытка
				УпакЛистОбъект.Записать(РежимЗаписиДокумента.Запись);
			Исключение
				ТекстОшибки = ТекстОшибки + ?(ТекстОшибки = "", "", Символы.ПС) + ОписаниеОшибки();
			КонецПопытки;
		КонецПопытки;
	КонецЕсли;
		
	Возврат ТекстОшибки;
	
КонецФункции

Функция ДМ_ПолучитьПараметрыПечатиУЛ(УпакЛистСсылка) 
	
	Результат = Новый Структура("Штрихкод, СкладОтправитель, СкладПолучатель, Код, Дата, КоличествоМест"); 
	
	Запрос = Новый Запрос("ВЫБРАТЬ
	|	УЛ_Шапка.КР_Штрихкод КАК Штрихкод,
	|	УЛ_Шапка.Код КАК Код,
	|	УЛ_Шапка.Дата КАК Дата,
	|	СУММА(УЛ_Товары.КоличествоУпаковок) КАК КоличествоМест,
	|	ЕСТЬNULL(ЗаказНаПеремещение.СкладОтправитель, ЗаказКлиента.Склад) КАК СкладОтправитель,
	|	ЕСТЬNULL(ЗаказНаПеремещение.СкладПолучатель, ЗаказКлиента.Партнер) КАК СкладПолучатель
	|ИЗ
	|	Документ.УпаковочныйЛист КАК УЛ_Шапка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.УпаковочныйЛист.Товары КАК УЛ_Товары
	|		ПО УЛ_Шапка.Ссылка = УЛ_Товары.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента КАК ЗаказКлиента
	|		ПО УЛ_Шапка.КР_ДокументОснование = ЗаказКлиента.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказНаПеремещение КАК ЗаказНаПеремещение
	|		ПО УЛ_Шапка.КР_ДокументОснование = ЗаказНаПеремещение.Ссылка
	|ГДЕ
	|	УЛ_Шапка.Ссылка = &Ссылка
	|	И УЛ_Товары.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	УЛ_Шапка.Код,
	|	УЛ_Шапка.Дата,
	|	УЛ_Шапка.КР_Штрихкод,
	|	ЕСТЬNULL(ЗаказНаПеремещение.СкладОтправитель, ЗаказКлиента.Склад),
	|	ЕСТЬNULL(ЗаказНаПеремещение.СкладПолучатель, ЗаказКлиента.Партнер)"); 
	
	Запрос.УстановитьПараметр("Ссылка", УпакЛистСсылка);
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(Результат, Выборка);
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ДМ_SendPackToPrint(УзелПО, UserName, СсылкаНаДок, Pack)
	
	СтруктураОтвета = Новый Структура;
	
	УпакЛистСсылка = ДМ_ПолучитьСсылкуТиповогоУЛ(Pack);
	
	Если Не ЗначениеЗаполнено(УпакЛистСсылка) Тогда
		СтруктураОтвета.Вставить("Описание", "Не найден упаковочный лист. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	Если УзелПО.ОнлайнСвязьСПринтсервером Тогда	
		АдресПринтсервера = УзелПО.АдресПринтсервера;
		ПортПринтсервера = УзелПО.ПортПринтсервера;
		Если АдресПринтсервера = "" Или ПортПринтсервера = 0 Тогда	
			СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указаны настройки онлайн связи с принтсервером. ");	
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;	
	Иначе	
		КаталогСохранения = УзелПО.КаталогВыгрузкиФайлаПечати;
		Если КаталогСохранения = "" Тогда		
			СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указан каталог сохранения файлов печати. ");		
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецЕсли;
	КонецЕсли;
	
	СтруктураПоиска = Новый Структура("ТипОперации", "Печать упаковочного листа");
	
	СтрокиРеквизитов = УзелПО.Печать.НайтиСтроки(СтруктураПоиска);
	
	Если СтрокиРеквизитов.Количество() = 0 Тогда		
		СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указан шаблон печати упаковочного листа. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);		
	КонецЕсли;	
	
	#Область Строки_Подбор
	ЗапросДанныхПодбор = Новый Запрос();
	ЗапросДанныхПодбор.Текст = "ВЫБРАТЬ
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ИдентификаторСтроки,
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Номенклатура,
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ХарактеристикаНоменклатуры,
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.НазваниеТовара,
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ЕдиницаИзмерения,
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ЯчейкаСсылка,
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.СерийныйНомер,
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.СерияСсылка КАК СерияСсылка,
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.ШтрихКод,
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист,
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Количество
	|ИЗ
	|	Справочник.ДатаМобайл_ДокументыТСД.СобранныеДанныеПодбор КАК ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор
	|ГДЕ
	|	ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.Ссылка = &СсылкаНаДок
	|	И ДатаМобайл_ДокументыТСДСобранныеДанныеПодбор.УпаковочныйЛист = &ТекущийУпакЛист	
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ИдентификаторСтроки,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Номенклатура,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ХарактеристикаНоменклатуры,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.НазваниеТовара,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ЕдиницаИзмерения,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ЯчейкаСсылка,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.СерийныйНомер,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.СерияСсылка,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Штрихкод,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист,
	|	ДатаМобайл_СтрокиГрупповыхДокументов.Количество
	|ИЗ
	|	РегистрСведений.ДатаМобайл_СтрокиГрупповыхДокументов КАК ДатаМобайл_СтрокиГрупповыхДокументов
	|ГДЕ
	|	ДатаМобайл_СтрокиГрупповыхДокументов.ДокументТСД = &СсылкаНаДок
	|	И НЕ ДатаМобайл_СтрокиГрупповыхДокументов.ДляОбмена
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.УпаковочныйЛист = &ТекущийУпакЛист
	|	И ДатаМобайл_СтрокиГрупповыхДокументов.ИмяТаблицы = &ИмяТаблицы";	
	
	ЗапросДанныхПодбор.УстановитьПараметр("СсылкаНаДок", СсылкаНаДок);		
	ЗапросДанныхПодбор.УстановитьПараметр("ИмяТаблицы", "Select");
	
	Если СсылкаНаДок.Шаблон.ИспользоватьМаркировку Тогда
		ТекущийУпаковочныйЛист = Pack;
		ТекущийУпаковочныйЛист = СтрЗаменить(ТекущийУпаковочныйЛист, "[", "(");
		ТекущийУпаковочныйЛист = СтрЗаменить(ТекущийУпаковочныйЛист, "]", ")");
		
		Если СтрДлина(ТекущийУпаковочныйЛист) = 20 И Лев(ТекущийУпаковочныйЛист,2) = "00" Тогда		
			ТекущийУпаковочныйЛист = "(00)" +  Сред(ТекущийУпаковочныйЛист, 3, 18);
		КонецЕсли;	
		
		ЗапросДанныхПодбор.УстановитьПараметр("ТекущийУпакЛист", ТекущийУпаковочныйЛист);
	Иначе   
		ТекущийУпаковочныйЛист = Pack; 
		ЗапросДанныхПодбор.УстановитьПараметр("ТекущийУпакЛист", ТекущийУпаковочныйЛист);		
	КонецЕсли;
	
	ТЗСобранныеДанныеПодбор = ЗапросДанныхПодбор.Выполнить().Выгрузить();
	ТЗСобранныеДанныеПодбор.Колонки.Добавить("КоличествоСтрок", Новый ОписаниеТипов("Число"));
	
	Для каждого СтрокаПодбора Из ТЗСобранныеДанныеПодбор Цикл
		Если СтрокаПодбора.Количество > 0 Тогда
			СтрокаПодбора.КоличествоСтрок = 1;
		ИначеЕсли СтрокаПодбора.Количество < 0 Тогда
			СтрокаПодбора.КоличествоСтрок = -1;
		КонецЕсли;			
	КонецЦикла;	 
	
	ТЗСобранныеДанныеПодбор.Свернуть("Номенклатура,ХарактеристикаНоменклатуры,НазваниеТовара,ЕдиницаИзмерения,ЯчейкаСсылка,СерийныйНомер,СерияСсылка,ШтрихКод,УпаковочныйЛист","Количество,КоличествоСтрок");
	#КонецОбласти
	
	// Zolla ++
	ОписаниеОшибки = ДМ_ЗаполнениеДокументовШаблона(СсылкаНаДок, УпакЛистСсылка, ТЗСобранныеДанныеПодбор);
	
	Если Не ОписаниеОшибки = "" Тогда
		СтруктураОтвета.Вставить("Описание", ОписаниеОшибки);			
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	СтруктураПараметровПечати = ДМ_ПолучитьПараметрыПечатиУЛ(УпакЛистСсылка);
	// Zolla --
	
	СтруктураПоиска = Новый Структура("ТипОперации", "Печать упаковочного листа");
	
	СтрокиРеквизитов = УзелПО.Печать.НайтиСтроки(СтруктураПоиска);
	Если СтрокиРеквизитов.Количество() = 0 Тогда		
		СтруктураОтвета.Вставить("Описание", "В обработке АРМ для терминала не указан шаблон печати упак. листа. ");		
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;		
	
	#Область Печать_УЛ
	ЗаписьXML = Новый ЗаписьXML;
	
	Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
		ИмяФайла = ПолучитьНовоеИмяФайла();	
		Попытка
			ЗаписьXML.ОткрытьФайл(КаталогСохранения + ИмяФайла + ".xml", "UTF-8");
		Исключение			
			СтруктураОтвета.Вставить("Описание", "Не удалось сохранить файл печати в каталоге: " + КаталогСохранения + " по причине: " + ОписаниеОшибки());			
			Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
		КонецПопытки;
	Иначе
		ЗаписьXML.УстановитьСтроку("UTF-8");
	КонецЕсли;
	
	ЗаписьXML.ЗаписатьОбъявлениеXML();		
	ЗаписьXML.ЗаписатьНачалоЭлемента("PrintData");
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("PrinterName");
	ЗаписьXML.ЗаписатьТекст(СтрокиРеквизитов[0].ИмяПринтера);
	ЗаписьXML.ЗаписатьКонецЭлемента();		
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("TemplateName");
	ЗаписьXML.ЗаписатьТекст(СтрокиРеквизитов[0].ИмяШаблона);
	ЗаписьXML.ЗаписатьКонецЭлемента();		
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Count");
	ЗаписьXML.ЗаписатьТекст(Строка(СтрокиРеквизитов[0].КоличествоКопий));
	ЗаписьXML.ЗаписатьКонецЭлемента();		
	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Head");
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("WarehouseSender");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтруктураПараметровПечати.СкладОтправитель));
	ЗаписьXML.ЗаписатьКонецЭлемента(); // WarehouseSender
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("WarehouseRecipient");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтруктураПараметровПечати.СкладПолучатель));
	ЗаписьXML.ЗаписатьКонецЭлемента(); // WarehouseRecipient	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Date");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтруктураПараметровПечати.Дата));
	ЗаписьXML.ЗаписатьКонецЭлемента(); // Date	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Code");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтруктураПараметровПечати.Код));
	ЗаписьXML.ЗаписатьКонецЭлемента(); // Code  
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Barcode");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтруктураПараметровПечати.Штрихкод));
	ЗаписьXML.ЗаписатьКонецЭлемента(); // Barcode 
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("NumberItems");
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(СтруктураПараметровПечати.КоличествоМест));
	ЗаписьXML.ЗаписатьКонецЭлемента(); // NumberItems
	
	ЗаписьXML.ЗаписатьКонецЭлемента(); // Head
	
	
	Год        = Строка(Формат(Год(ТекущаяДата()), "ЧГ="));
	Месяц      = Строка(Месяц(ТекущаяДата()));
	День       = Строка(День(ТекущаяДата()));
	ДатаСтрока = Год + Строка(Месяц) + Строка(День);
	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Footer");	
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("Date");	
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(ДатаСтрока));
	ЗаписьXML.ЗаписатьКонецЭлемента(); // Date
	
	ЗаписьXML.ЗаписатьНачалоЭлемента("User");	
	ЗаписьXML.ЗаписатьТекст(ЧистаяСтрока(UserName));
	ЗаписьXML.ЗаписатьКонецЭлемента(); // User 
	
	ЗаписьXML.ЗаписатьКонецЭлемента(); // Footer
	
	ЗаписьXML.ЗаписатьКонецЭлемента(); // PrintData
	
	ОписаниеОшибки = "";
	
	Если Не УзелПО.ОнлайнСвязьСПринтсервером Тогда
		ЗаписьXML.Закрыть();
	Иначе
		СтрокаДляЗапроса = ЗаписьXML.Закрыть();
		ОтправитьДанныеНаПринтсервер(УзелПО, СтрокаДляЗапроса, ОписаниеОшибки);
	КонецЕсли;		
	#КонецОбласти
	
	Если ОписаниеОшибки <> "" Тогда
		СтруктураОтвета.Вставить("Описание", ОписаниеОшибки);			
		Возврат ПодготовитьОтветJSON(, СтруктураОтвета);
	КонецЕсли;
	
	СтруктураОтвета.Вставить("is_success", Истина);
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

Функция ДМ_OnNewPack(УзелПО, UserName, Шаблон, СсылкаНаДок) 
	
	СтруктураОтвета = Новый Структура;
	
	ДокументУпаковочногоЛиста = Документы.ДатаМобайл_УпаковочныйЛист.СоздатьДокумент();
	ДокументУпаковочногоЛиста.Дата = ТекущаяДата();
	
	Если ЗначениеЗаполнено(СсылкаНаДок.ИсходныйДокумент) Тогда
		ДокументУпаковочногоЛиста.Основание = СсылкаНаДок.ИсходныйДокумент;
	Иначе
		ДокументУпаковочногоЛиста.Основание = СсылкаНаДок;
	КонецЕсли;
	
	ДокументУпаковочногоЛиста.Ответственный = Справочники.Пользователи.НайтиПоНаименованию(UserName, Ложь);
	ДокументУпаковочногоЛиста.ТСД = УзелПО;
	ДокументУпаковочногоЛиста.Записать();
	
	Если Шаблон.ИспользоватьТиповыеУпаковочныеЛисты Тогда
		ДокументУпаковочногоЛистаТиповой = Документы.УпаковочныйЛист.СоздатьДокумент();	
		ДокументУпаковочногоЛистаТиповой.Дата = ТекущаяДата();
		ДокументУпаковочногоЛистаТиповой.Вид = Перечисления.ВидыУпаковочныхЛистов.Исходящий;
		ДокументУпаковочногоЛистаТиповой.Код = ДокументУпаковочногоЛиста.Номер;
		Попытка ДокументУпаковочногоЛистаТиповой.Упаковал = ДокументУпаковочногоЛиста.Ответственный; Исключение КонецПопытки;			 
		Попытка ДокументУпаковочногоЛистаТиповой.СкладУпаковки = СсылкаНаДок.Склад; Исключение КонецПопытки;
		
		Если ЗначениеЗаполнено(СсылкаНаДок.ИсходныйДокумент) Тогда
			Если СсылкаНаДок.Шаблон.ВидДокумента = "РасходныйОрдерНаТовары" Тогда  
				Модуль_ОбщегоНазначения = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ОбщегоНазначения");
				Модуль_ПрефиксацияОбъектовКлиентСервер = ДатаМобайл_ОбщийМодуль.ОбщийМодуль("ПрефиксацияОбъектовКлиентСервер");
				РеквизитыОрдера = Модуль_ОбщегоНазначения.ЗначенияРеквизитовОбъекта(СсылкаНаДок.ИсходныйДокумент, "Получатель, Номер");
				Основание = НСтр("ru = '%Получатель% / Ордер %Номер%'");
				Основание = СтрЗаменить(Основание,"%Получатель%",РеквизитыОрдера.Получатель);
				Основание = СтрЗаменить(Основание,"%Номер%",Модуль_ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(РеквизитыОрдера.Номер));	
				ДокументУпаковочногоЛистаТиповой.Основание = Основание;
			Иначе
				ДокументУпаковочногоЛистаТиповой.Основание = СсылкаНаДок.ИсходныйДокумент;
			КонецЕсли; 
			
			ДокументУпаковочногоЛистаТиповой.КР_ДокументОснование = СсылкаНаДок.ИсходныйДокумент; // адаптация Zolla
		КонецЕсли;			
		
		ДокументУпаковочногоЛистаТиповой.Записать();	
		
		Попытка
			ДокументУпаковочногоЛиста.ТиповойУпаковочныйЛист = ДокументУпаковочногоЛистаТиповой.Ссылка;
			ДокументУпаковочногоЛиста.Записать();
		Исключение 
		КонецПопытки;
	КонецЕсли;	
	
	Рез = "UPL" + ДокументУпаковочногоЛиста.Номер; 
	
	СтруктураОтвета.Вставить("data", Рез);
	Возврат ПодготовитьОтветJSON(СтруктураОтвета);
	
КонецФункции

Процедура ДМ_УстановитьПомещениеПоУмолчанию(ОбъектДокументаОтбора)

	Склад = ОбъектДокументаОтбора.Склад;  
	ВидОперации = ОбъектДокументаОтбора.ВидОперации;
	
	ЭтоОтбор = (ВидОперации = Перечисления.ВидыОперацийОтбораРазмещенияТоваров.Отбор);
	ЭтоРазмещение = (ВидОперации = Перечисления.ВидыОперацийОтбораРазмещенияТоваров.Размещение);
	
	АдресныйСкладБезордернойОтгрузки = Склад.КР_АдресныйСкладБезордернойОтгрузки;
	ИспользоватьРазмещениеКакПриходныйОрдер = Склад.КР_ИспользоватьРазмещениеКакПриходныйОрдер;	
	
	Если Не ((АдресныйСкладБезордернойОтгрузки И ЭтоОтбор)
		Или  (ИспользоватьРазмещениеКакПриходныйОрдер И ЭтоРазмещение)) Тогда 
		Возврат;
	КонецЕсли;	

	ОбъектДокументаОтбора.Помещение = Справочники.СкладскиеПомещения.КР_СкладскоеПомещениеСкладМагазина(ОбъектДокументаОтбора.Склад);
	
КонецПроцедуры 

#КонецОбласти