
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда
	
#Область ПрограммныйИнтерфейс

// Заполняет регистр вспомогательной информации по изменениям оперативных регистров расчетов.
// 
// Параметры:
// 	МенеджерВТ - МенеджерВременныхТаблиц - Менеджер, содержащий таблицу с изменениями.
// 	ЭтоРасчетыСКлиентами - Булево - это расчеты с клиентами.
Процедура ЗаполнитьВспомогательнуюИнформацию(МенеджерВТ, ЭтоРасчетыСКлиентами = Истина) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫБОР КОГДА Изменения.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|						И Изменения.РасчетныйДокумент <> ЗНАЧЕНИЕ(Документ.ПервичныйДокумент.ПустаяСсылка)
	|		ТОГДА Изменения.РасчетныйДокумент
	|		ИНАЧЕ Изменения.Документ
	|	КОНЕЦ                                           КАК РасчетныйДокумент,
	|	НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Изменения.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1) ИЛИ Изменения.Сторно
	|							ТОГДА Изменения.ДатаРегистратора
	|						ИНАЧЕ Изменения.ДатаПлатежа
	|					КОНЕЦ , ДЕНЬ)      КАК ДатаПлановогоПогашения
	|ПОМЕСТИТЬ ИзмененияВспомогательнойИнформации
	|ИЗ
	|	&РасчетыИзменения КАК Изменения
	|ГДЕ
	|	Изменения.Сумма <> 0 ИЛИ Изменения.КОтгрузке <> 0 ИЛИ Изменения.КОплате <> 0
	|;
	|ВЫБРАТЬ
	|	Изменения.РасчетныйДокумент                                            КАК РасчетныйДокумент,
	|	Изменения.ДатаПлановогоПогашения                                       КАК ДатаПлановогоПогашения,
	|	МИНИМУМ(ЕСТЬNULL(Расчеты.Регистратор, Неопределено))                    КАК ДокументРегистратор,
	|	МАКСИМУМ(ЕСТЬNULL(Расчеты.СвязанныйДокумент, Неопределено))             КАК СвязанныйДокумент,
	|	МИНИМУМ(ЕСТЬNULL(Расчеты.ПорядокОперации, Неопределено))                КАК ПорядокОперации,
	|	МИНИМУМ(ЕСТЬNULL(Расчеты.ПорядокЗачетаПоДатеПлатежа, Неопределено))     КАК ПорядокЗачета,
	|	МИНИМУМ(ЕСТЬNULL(Расчеты.ВалютаДокумента, Неопределено))                КАК ВалютаДокумента,
	|	МАКСИМУМ(ЕСТЬNULL(Расчеты.СтатьяДвиженияДенежныхСредств, Неопределено)) КАК СтатьяДвиженияДенежныхСредств
	|ИЗ
	|	ИзмененияВспомогательнойИнформации КАК Изменения
	|		ЛЕВОЕ СОЕДИНЕНИЕ &Расчеты КАК Расчеты
	|			ПО Изменения.РасчетныйДокумент = Расчеты.Регистратор
	|				И Изменения.ДатаПлановогоПогашения = НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1) ИЛИ Расчеты.Сторно
	|																		ТОГДА Расчеты.ДатаРегистратора
	|																	ИНАЧЕ Расчеты.ДатаПлатежа
	|																КОНЕЦ , ДЕНЬ)
	|				И (Расчеты.Сумма <> 0 ИЛИ Расчеты.КОтгрузке <> 0 ИЛИ Расчеты.КОплате <> 0)
	|ГДЕ
	|	ТИПЗНАЧЕНИЯ(Изменения.РасчетныйДокумент) <> ТИП(Документ.ПервичныйДокумент)
	|СГРУППИРОВАТЬ ПО
	|	Изменения.РасчетныйДокумент,
	|	Изменения.ДатаПлановогоПогашения
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	Изменения.РасчетныйДокумент                                            КАК РасчетныйДокумент,
	|	Изменения.ДатаПлановогоПогашения                                       КАК ДатаПлановогоПогашения,
	|	МИНИМУМ(ЕСТЬNULL(Расчеты.Регистратор, Неопределено))                    КАК ДокументРегистратор,
	|	МАКСИМУМ(ЕСТЬNULL(Расчеты.СвязанныйДокумент, Неопределено))             КАК СвязанныйДокумент,
	|	МИНИМУМ(ЕСТЬNULL(Расчеты.ПорядокОперации, Неопределено))                КАК ПорядокОперации,
	|	МИНИМУМ(ЕСТЬNULL(Расчеты.ПорядокЗачетаПоДатеПлатежа, Неопределено))     КАК ПорядокЗачета,
	|	МИНИМУМ(ЕСТЬNULL(Расчеты.ВалютаДокумента, Неопределено))                КАК ВалютаДокумента,
	|	МАКСИМУМ(ЕСТЬNULL(Расчеты.СтатьяДвиженияДенежныхСредств, Неопределено)) КАК СтатьяДвиженияДенежныхСредств
	|ИЗ
	|	ИзмененияВспомогательнойИнформации КАК Изменения
	|		ЛЕВОЕ СОЕДИНЕНИЕ &Расчеты КАК Расчеты
	|			ПО Изменения.РасчетныйДокумент = Расчеты.РасчетныйДокумент
	|				И Изменения.ДатаПлановогоПогашения = НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1) ИЛИ Расчеты.Сторно
	|																		ТОГДА Расчеты.ДатаРегистратора
	|																	ИНАЧЕ Расчеты.ДатаПлатежа
	|																КОНЕЦ , ДЕНЬ)
	|				И (Расчеты.Сумма <> 0 ИЛИ Расчеты.КОтгрузке <> 0 ИЛИ Расчеты.КОплате <> 0)
	|ГДЕ
	|	ТИПЗНАЧЕНИЯ(Изменения.РасчетныйДокумент) = ТИП(Документ.ПервичныйДокумент)
	|СГРУППИРОВАТЬ ПО
	|	Изменения.РасчетныйДокумент,
	|	Изменения.ДатаПлановогоПогашения
	|;
	|УНИЧТОЖИТЬ ИзмененияВспомогательнойИнформации";
	Если ЭтоРасчетыСКлиентами Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"&РасчетыИзменения","РасчетыСКлиентамиИзменения");
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"&Расчеты","РегистрНакопления.РасчетыСКлиентами");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"&РасчетыИзменения","РасчетыСПоставщикамиИзменения");
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"&Расчеты","РегистрНакопления.РасчетыСПоставщиками");
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"КОтгрузке","КПоступлению");
	КонецЕсли;
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		НаборЗаписей = СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.РасчетныйДокумент.Установить(Выборка.РасчетныйДокумент);
		НаборЗаписей.Отбор.ДатаПлановогоПогашения.Установить(Выборка.ДатаПлановогоПогашения);
		Если Выборка.ДокументРегистратор <> Неопределено Тогда
			ЗаполнитьЗначенияСвойств(НаборЗаписей.Добавить(), Выборка);
		КонецЕсли;
		НаборЗаписей.Записать();
	КонецЦикла;
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ОбновлениеИнформационнойБазы

// см. ОбновлениеИнформационнойБазыБСП.ПриДобавленииОбработчиковОбновления
Процедура ПриДобавленииОбработчиковОбновления(Обработчики) Экспорт

	Обработчик = Обработчики.Добавить();
	Обработчик.Версия = "11.5.6.83";
	Обработчик.Процедура = ИмяОбработчика();
	Обработчик.РежимВыполнения = "Отложенно";
	Обработчик.Идентификатор = Новый УникальныйИдентификатор("2e98001a-a454-4fe8-9a82-e3750d616798");
	Обработчик.Многопоточный = Истина;
	Обработчик.ПроцедураЗаполненияДанныхОбновления = "РегистрыСведений.ВспомогательнаяИнформацияВзаиморасчетов.ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию";
	Обработчик.ПроцедураПроверки = "РегистрыСведений.ВспомогательнаяИнформацияВзаиморасчетов.ДанныеОбновленыНаНовуюВерсию";
	Обработчик.Комментарий = НСтр("ru = 'Первоначальное заполнение регистра вспомогательной информации расчетов.'");
	
	Читаемые = Новый Массив;
	Читаемые.Добавить(Метаданные.РегистрыНакопления.РасчетыСКлиентами.ПолноеИмя());
	Читаемые.Добавить(Метаданные.РегистрыНакопления.РасчетыСПоставщиками.ПолноеИмя());
	Обработчик.ЧитаемыеОбъекты = СтрСоединить(Читаемые, ",");
	
	Изменяемые = Новый Массив;
	Изменяемые.Добавить(Метаданные.РегистрыСведений.ВспомогательнаяИнформацияВзаиморасчетов.ПолноеИмя());
	Обработчик.ИзменяемыеОбъекты = СтрСоединить(Изменяемые, ",");
	
	Обработчик.ПриоритетыВыполнения = ОбновлениеИнформационнойБазы.ПриоритетыВыполненияОбработчика();

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "РегистрыНакопления.РасчетыСКлиентами.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

	НоваяСтрока = Обработчик.ПриоритетыВыполнения.Добавить();
	НоваяСтрока.Процедура = "РегистрыНакопления.РасчетыСПоставщиками.ОбработатьДанныеДляПереходаНаНовуюВерсию";
	НоваяСтрока.Порядок = "После";

КонецПроцедуры

Функция ИмяОбработчика()
	Возврат "РегистрыСведений.ВспомогательнаяИнформацияВзаиморасчетов.ОбработатьДанныеДляПереходаНаНовуюВерсию";
КонецФункции

Функция ДанныеОбновленыНаНовуюВерсию(МетаданныеИОтбор = Неопределено) Экспорт
	
	Возврат НЕ ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки(Неопределено, "РегистрСведений.ВспомогательнаяИнформацияВзаиморасчетов");
	
КонецФункции
	
// Обработчик обновления
// 
// Параметры:
// 	Параметры - см. ОбновлениеИнформационнойБазы.ОсновныеПараметрыОтметкиКОбработке
//
Процедура ЗарегистрироватьДанныеКОбработкеДляПереходаНаНовуюВерсию(Параметры = Неопределено) Экспорт
	
	ПолноеИмяРегистра = СоздатьНаборЗаписей().Метаданные().ПолноеИмя();
	
	ПараметрыВыборки = Параметры.ПараметрыВыборки;
	ПараметрыВыборки.ПолныеИменаРегистров = ПолноеИмяРегистра;
	ПараметрыВыборки.СпособВыборки = ОбновлениеИнформационнойБазы.СпособВыборкиИзмеренияНезависимогоРегистраСведений();
	
	ДополнительныеПараметры = ОбновлениеИнформационнойБазы.ДополнительныеПараметрыОтметкиОбработки();
	ДополнительныеПараметры.Вставить("ЭтоНезависимыйРегистрСведений", Истина);
	ДополнительныеПараметры.Вставить("ПолноеИмяРегистра", ПолноеИмяРегистра);
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1) ИЛИ Расчеты.Сторно
	|			ТОГДА Расчеты.ДатаРегистратора
	|		ИНАЧЕ Расчеты.ДатаПлатежа
	|	КОНЕЦ , ДЕНЬ)                  КАК ДатаПлановогоПогашения,
	|	ВЫБОР КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|							И Расчеты.РасчетныйДокумент <> ЗНАЧЕНИЕ(Документ.ПервичныйДокумент.ПустаяСсылка)
	|				ТОГДА Расчеты.РасчетныйДокумент
	|		ИНАЧЕ Расчеты.Регистратор
	|	КОНЕЦ                                           КАК РасчетныйДокумент
	|ПОМЕСТИТЬ ВтРасчеты
	|ИЗ
	|	РегистрНакопления.РасчетыСКлиентами КАК Расчеты
	|ГДЕ
	|	Расчеты.Активность
	|	И (Расчеты.Сумма <> 0 ИЛИ Расчеты.КОтгрузке <> 0 ИЛИ Расчеты.КОплате <> 0)
	|	И НЕ Расчеты.Регистратор ССЫЛКА Документ.КорректировкаРегистров
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1) ИЛИ Расчеты.Сторно
	|			ТОГДА Расчеты.ДатаРегистратора
	|		ИНАЧЕ Расчеты.ДатаПлатежа
	|	КОНЕЦ , ДЕНЬ)        КАК ДатаПлановогоПогашения,
	|	ВЫБОР КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|							И Расчеты.РасчетныйДокумент <> ЗНАЧЕНИЕ(Документ.ПервичныйДокумент.ПустаяСсылка)
	|				ТОГДА Расчеты.РасчетныйДокумент
	|		ИНАЧЕ Расчеты.Регистратор
	|	КОНЕЦ                                           КАК РасчетныйДокумент
	|ИЗ
	|	РегистрНакопления.РасчетыСПоставщиками КАК Расчеты
	|ГДЕ
	|	Расчеты.Активность
	|	И (Расчеты.Сумма <> 0 ИЛИ Расчеты.КПоступлению <> 0 ИЛИ Расчеты.КОплате <> 0)
	|	И НЕ Расчеты.Регистратор ССЫЛКА Документ.КорректировкаРегистров
	|;
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Расчеты.ДатаПлановогоПогашения               КАК ДатаПлановогоПогашения
	|ИЗ ВтРасчеты КАК Расчеты
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ВспомогательнаяИнформацияВзаиморасчетов КАК ВспомогательнаяИнформация
	|			ПО ВспомогательнаяИнформация.ДатаПлановогоПогашения = Расчеты.ДатаПлановогоПогашения
	|				И ВспомогательнаяИнформация.РасчетныйДокумент = Расчеты.РасчетныйДокумент
	|ГДЕ
	|	ВспомогательнаяИнформация.ДокументРегистратор ЕСТЬ NULL";
	
	ОбновлениеИнформационнойБазы.ОтметитьКОбработке(Параметры, Запрос.Выполнить().Выгрузить(), ДополнительныеПараметры);
	
КонецПроцедуры

Процедура ОбработатьДанныеДляПереходаНаНовуюВерсию(Параметры) Экспорт
	
	Если ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки(Неопределено, Метаданные.РегистрыНакопления.РасчетыСКлиентами)
		ИЛИ ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки(Неопределено, Метаданные.РегистрыНакопления.РасчетыСПоставщиками) Тогда
		Параметры.ОбработкаЗавершена = ОбновлениеЗависимыхДанныхЗавершено();
		Возврат;
	КонецЕсли;
	
	МетаданныеРегистра = СоздатьНаборЗаписей().Метаданные();
	ПолноеИмяРегистра = МетаданныеРегистра.ПолноеИмя();
	ОбновляемыеДанные = ОбновлениеИнформационнойБазы.ДанныеДляОбновленияВМногопоточномОбработчике(Параметры);
	
	Если ОбновляемыеДанные.Количество() = 0 Тогда
		Параметры.ОбработкаЗавершена = ОбновлениеИнформационнойБазы.ОбработкаДанныхЗавершена(Параметры.Очередь, ПолноеИмяРегистра);
		Возврат;
	КонецЕсли;
	
	ОбновляемыеДанные.Свернуть("ДатаПлановогоПогашения");
	
	#Область ТекстЗапросаВременнойТаблицы
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	Т.ДатаПлановогоПогашения КАК ДатаПлановогоПогашения
	|ПОМЕСТИТЬ втОбновляемыеДанные
	|ИЗ
	|	&ОбновляемыеДанные КАК Т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент                       КАК РасчетныйДокумент,
	|	Расчеты.ДатаПлановогоПогашения                  КАК ДатаПлановогоПогашения,
	|	МИНИМУМ(Расчеты.ДокументРегистратор)            КАК ДокументРегистратор,
	|	МАКСИМУМ(Расчеты.СвязанныйДокумент)             КАК СвязанныйДокумент,
	|	МИНИМУМ(Расчеты.ПорядокОперации)                КАК ПорядокОперации,
	|	МИНИМУМ(Расчеты.ПорядокЗачета)                  КАК ПорядокЗачета,
	|	МИНИМУМ(Расчеты.ВалютаДокумента)                КАК ВалютаДокумента,
	|	МАКСИМУМ(Расчеты.СтатьяДвиженияДенежныхСредств) КАК СтатьяДвиженияДенежныхСредств
	|ПОМЕСТИТЬ втДанные
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВЫБОР КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|							И Расчеты.РасчетныйДокумент <> ЗНАЧЕНИЕ(Документ.ПервичныйДокумент.ПустаяСсылка)
	|				ТОГДА Расчеты.РасчетныйДокумент
	|			ИНАЧЕ Расчеты.Регистратор
	|		КОНЕЦ                                           КАК РасчетныйДокумент,
	|		НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1) ИЛИ Расчеты.Сторно
	|							ТОГДА Расчеты.ДатаРегистратора
	|						ИНАЧЕ Расчеты.ДатаПлатежа
	|					КОНЕЦ , ДЕНЬ)                       КАК ДатаПлановогоПогашения,
	|		Расчеты.Регистратор                             КАК ДокументРегистратор,
	|		Расчеты.СвязанныйДокумент                       КАК СвязанныйДокумент,
	|		Расчеты.ПорядокОперации                         КАК ПорядокОперации,
	|		Расчеты.ПорядокЗачетаПоДатеПлатежа              КАК ПорядокЗачета,
	|		Расчеты.ВалютаДокумента                         КАК ВалютаДокумента,
	|		Расчеты.СтатьяДвиженияДенежныхСредств           КАК СтатьяДвиженияДенежныхСредств
	|	ИЗ
	|		РегистрНакопления.РасчетыСКлиентами КАК Расчеты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втОбновляемыеДанные КАК ОбновляемыеДанные
	|		ПО НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1) ИЛИ Расчеты.Сторно
	|								ТОГДА Расчеты.ДатаРегистратора
	|							ИНАЧЕ Расчеты.ДатаПлатежа
	|						КОНЕЦ, ДЕНЬ) = ОбновляемыеДанные.ДатаПлановогоПогашения
	|	ГДЕ
	|		Расчеты.Активность
	|		И (Расчеты.Сумма <> 0 ИЛИ Расчеты.КОтгрузке <> 0 ИЛИ Расчеты.КОплате <> 0)
	|		И НЕ Расчеты.Регистратор ССЫЛКА Документ.КорректировкаРегистров
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ВЫБОР КОГДА Расчеты.РасчетныйДокумент ССЫЛКА Документ.ПервичныйДокумент
	|							И Расчеты.РасчетныйДокумент <> ЗНАЧЕНИЕ(Документ.ПервичныйДокумент.ПустаяСсылка)
	|				ТОГДА Расчеты.РасчетныйДокумент
	|			ИНАЧЕ Расчеты.Регистратор
	|		КОНЕЦ                                           КАК РасчетныйДокумент,
	|		НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1) ИЛИ Расчеты.Сторно
	|								ТОГДА Расчеты.ДатаРегистратора
	|							ИНАЧЕ Расчеты.ДатаПлатежа
	|					КОНЕЦ , ДЕНЬ)                       КАК ДатаПлановогоПогашения,
	|		Расчеты.Регистратор                             КАК ДокументРегистратор,
	|		Расчеты.СвязанныйДокумент                       КАК СвязанныйДокумент,
	|		Расчеты.ПорядокОперации                         КАК ПорядокОперации,
	|		Расчеты.ПорядокЗачетаПоДатеПлатежа              КАК ПорядокЗачета,
	|		Расчеты.ВалютаДокумента                         КАК ВалютаДокумента,
	|		Расчеты.СтатьяДвиженияДенежныхСредств           КАК СтатьяДвиженияДенежныхСредств
	|	ИЗ
	|		РегистрНакопления.РасчетыСПоставщиками КАК Расчеты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втОбновляемыеДанные КАК ОбновляемыеДанные
	|		ПО НАЧАЛОПЕРИОДА(ВЫБОР КОГДА Расчеты.ДатаПлатежа = ДАТАВРЕМЯ(1,1,1) ИЛИ Расчеты.Сторно
	|								ТОГДА Расчеты.ДатаРегистратора
	|							ИНАЧЕ Расчеты.ДатаПлатежа
	|						КОНЕЦ, ДЕНЬ) = ОбновляемыеДанные.ДатаПлановогоПогашения
	|	ГДЕ
	|		Расчеты.Активность
	|		И (Расчеты.Сумма <> 0 ИЛИ Расчеты.КПоступлению <> 0 ИЛИ Расчеты.КОплате <> 0)
	|		И НЕ Расчеты.Регистратор ССЫЛКА Документ.КорректировкаРегистров
	|) КАК Расчеты
	|СГРУППИРОВАТЬ ПО
	|	Расчеты.РасчетныйДокумент,
	|	Расчеты.ДатаПлановогоПогашения";
	#КонецОбласти
	
	МенеджерВТ = Новый МенеджерВременныхТаблиц;
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.МенеджерВременныхТаблиц = МенеджерВТ;
	Запрос.УстановитьПараметр("ОбновляемыеДанные", ОбновляемыеДанные);
	Запрос.Выполнить();
	
	ЗапросДанных = Новый Запрос;
	ЗапросДанных.МенеджерВременныхТаблиц = МенеджерВТ;
	ЗапросДанных.Текст = "
	|ВЫБРАТЬ
	|	Расчеты.РасчетныйДокумент             КАК РасчетныйДокумент,
	|	Расчеты.ДатаПлановогоПогашения        КАК ДатаПлановогоПогашения,
	|	Расчеты.ДокументРегистратор           КАК ДокументРегистратор,
	|	Расчеты.СвязанныйДокумент             КАК СвязанныйДокумент,
	|	Расчеты.ПорядокОперации               КАК ПорядокОперации,
	|	Расчеты.ПорядокЗачета                 КАК ПорядокЗачета,
	|	Расчеты.ВалютаДокумента               КАК ВалютаДокумента,
	|	Расчеты.СтатьяДвиженияДенежныхСредств КАК СтатьяДвиженияДенежныхСредств
	|ИЗ
	|	втДанные КАК Расчеты
	|ГДЕ
	|	Расчеты.ДатаПлановогоПогашения = &ДатаПлановогоПогашения";
	
	ДополнительныеПараметры = ОбновлениеИнформационнойБазы.ДополнительныеПараметрыОтметкиОбработки();
	ДополнительныеПараметры.Вставить("ЭтоНезависимыйРегистрСведений", Истина);
	ДополнительныеПараметры.Вставить("ПолноеИмяРегистра", ПолноеИмяРегистра);
	Для Каждого ПорцияДанных Из ОбновляемыеДанные Цикл
	
		НачатьТранзакцию();
		
		Попытка
		
			Блокировка = Новый БлокировкаДанных;
			ЭлементБлокировки = Блокировка.Добавить(ПолноеИмяРегистра);
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;

			ЭлементБлокировки.УстановитьЗначение("ДатаПлановогоПогашения", ПорцияДанных.ДатаПлановогоПогашения);
			Блокировка.Заблокировать();
			
			ЗапросДанных.УстановитьПараметр("ДатаПлановогоПогашения", ПорцияДанных.ДатаПлановогоПогашения);
			Результат = ЗапросДанных.Выполнить();
			Данные = Результат.Выгрузить();
			
			НаборЗаписей = РегистрыСведений[МетаданныеРегистра.Имя].СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.ДатаПлановогоПогашения.Установить(ПорцияДанных.ДатаПлановогоПогашения);
			НаборЗаписей.Загрузить(Данные);
			
			Если НаборЗаписей.Модифицированность() Тогда
				ОбновлениеИнформационнойБазы.ЗаписатьНаборЗаписей(НаборЗаписей);
			Иначе
				ОбновлениеИнформационнойБазы.ОтметитьВыполнениеОбработки(НаборЗаписей);
			КонецЕсли;
			
			ЗафиксироватьТранзакцию();
			
		Исключение
		
			ОтменитьТранзакцию();
			
			Шаблон = НСтр("ru = 'Не удалось записать данные в регистр %1 , по причине: %2'");
			ТекстСообщения = СтрШаблон(Шаблон,
				ПолноеИмяРегистра,
				ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			
			ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Ошибка,
				МетаданныеРегистра,
				,
				ТекстСообщения);
		
		КонецПопытки;
		
	КонецЦикла;
	
	Параметры.ОбработкаЗавершена = Не ОбновлениеИнформационнойБазы.ЕстьДанныеДляОбработки(Параметры.Очередь, ПолноеИмяРегистра);
	
	Если Параметры.ОбработкаЗавершена Тогда
		ОперативныеВзаиморасчетыСервер.ПослеОбновленияРегистровВзаиморасчетов();
	КонецЕсли;
	
КонецПроцедуры

Функция ОбновлениеЗависимыхДанныхЗавершено()
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("РежимВыполнения", Перечисления.РежимыВыполненияОбработчиков.Отложенно);
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	ОбработчикиОбновления.ИмяОбработчика КАК ИмяОбработчика,
		|	ОбработчикиОбновления.Статус КАК Статус
		|ИЗ
		|	РегистрСведений.ОбработчикиОбновления КАК ОбработчикиОбновления
		|ГДЕ
		|	ОбработчикиОбновления.ИмяОбработчика В (
		|		""&РасчетыСКлиентами"",
		|		""&РасчетыСПоставщиками"")
		|	И ОбработчикиОбновления.Статус В (
		|		ЗНАЧЕНИЕ(Перечисление.СтатусыОбработчиковОбновления.Ошибка))
		|
		|СГРУППИРОВАТЬ ПО
		|	ОбработчикиОбновления.Статус,
		|	ОбработчикиОбновления.ИмяОбработчика";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&РасчетыСКлиентами", "РегистрыНакопления.РасчетыСКлиентами.ОбработатьДанныеДляПереходаНаНовуюВерсию");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&РасчетыСПоставщиками", "РегистрыНакопления.РасчетыСПоставщиками.ОбработатьДанныеДляПереходаНаНовуюВерсию");
	Запрос.Текст = ТекстЗапроса;

	СтатусыОбработчиков = Запрос.Выполнить().Выгрузить();
	
	Для Каждого Обработчик Из СтатусыОбработчиков Цикл
		
		ТекстСообщения = НСтр("ru = 'Обновление зависимых данных завершено с ошибкой.
		|Не выполнен обработчик обновления'") + " """ + Обработчик.ИмяОбработчика + """";
		
		ВызватьИсключение ТекстСообщения;
		
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#КонецЕсли
