// 23.08.2023 Марченко С.Н., КРОК, JIRA№A2105505-1153

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	ТекстСообщения = Неопределено;
	ПроверитьОтправитьДокументВСБИС(ПараметрКоманды, ТекстСообщения);  
	ОбщегоНазначенияКлиент.СообщитьПользователю(ТекстСообщения);

	// Обновляем состояние 
	// 	если это форма объекта
	Если ОбщегоНазначенияКлиентСервер.ЕстьРеквизитИлиСвойствоОбъекта(ЭтотОбъект, "Объект") Тогда 
		Форма = ПараметрыВыполненияКоманды.Источник;  
		Форма.Прочитать();    
	КонецЕсли;	
	//
	
КонецПроцедуры  

&НаСервере
Функция ПроверитьОтправитьДокументВСБИС(ДокументСсылка, ТекстСообщения)
	
	УстановитьПривилегированныйРежим(Истина);
	
	МенеджерОбъекта = РегистрыСведений.КР_ИсходящиеДокументыСБИС;
	
	// Получаем массив не выгруженных ПКО, РКО
	МассивСсылок = ДокументСсылка.КассовыеОрдера.Выгрузить( , "Документ").ВыгрузитьКолонку(0);
	НеВыгруженныеДокументы = Неопределено;
	Если Не МенеджерОбъекта.ЕстьНеВыгруженныеДокументыВСбис(МассивСсылок, НеВыгруженныеДокументы) Тогда 
		ТекстСообщения = НСтр("ru = 'Отправка связанных ПКО, РКО документа %1 в СБИС не требуется'");
		ТекстСообщения = СтрШаблон(ТекстСообщения, ДокументСсылка);
		Возврат Истина; 
	КонецЕсли;	
	
	// Обходим каждый не выгруженный и выгружаем, предварительно обновив "слепок" 
	ШаблонОшибкиОтправки = НСтр("ru = 'Ошибка отправки связанного документа %1 в СБИС:
		|%2'");
	Для Каждого КассовыйОрдер Из НеВыгруженныеДокументы Цикл 
		
		Если ДатыЗапретаИзменения.ИзменениеЗапрещено(
				КассовыйОрдер.Метаданные().ПолноеИмя(), КассовыйОрдер, ТекстСообщения) Тогда
			Возврат Ложь;
		КонецЕсли;
		
		Если Не МенеджерОбъекта.ЗаписатьСостояниеИсходящегоДокументаСБИС(КассовыйОрдер, ТекстСообщения)
			Или Не МенеджерОбъекта.ПроверитьОтправитьДокументВСБИС(КассовыйОрдер, ТекстСообщения) Тогда   
			ТекстСообщения = СтрШаблон(ШаблонОшибкиОтправки, КассовыйОрдер, ТекстСообщения);
			Возврат Ложь;
		КонецЕсли;
		
	КонецЦикла;	
	
	ТекстСообщения = НСтр("ru = 'Связанные документы отправлены в СБИС'");
	Возврат Истина;
	
КонецФункции
